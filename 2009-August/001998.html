<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Windstille-commit] r3001 - in trunk/windstille/src: app display	font gui hud input screen scripting tile
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/windstille-commit/2009-August/index.html" >
   <LINK REL="made" HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r3001%20-%20in%20trunk/windstille/src%3A%20app%20display%0A%09font%20gui%20hud%20input%20screen%20scripting%20tile&In-Reply-To=%3C200908212144.n7LLimoX013593%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001997.html">
   <LINK REL="Next"  HREF="001999.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Windstille-commit] r3001 - in trunk/windstille/src: app display	font gui hud input screen scripting tile</H1>
    <B>grumbel at BerliOS</B> 
    <A HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r3001%20-%20in%20trunk/windstille/src%3A%20app%20display%0A%09font%20gui%20hud%20input%20screen%20scripting%20tile&In-Reply-To=%3C200908212144.n7LLimoX013593%40sheep.berlios.de%3E"
       TITLE="[Windstille-commit] r3001 - in trunk/windstille/src: app display	font gui hud input screen scripting tile">grumbel at mail.berlios.de
       </A><BR>
    <I>Fri Aug 21 23:44:48 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001997.html">[Windstille-commit] r3000 - in trunk/windstille/src: app armature	display editor screen sprite2d sprite3d
</A></li>
        <LI>Next message: <A HREF="001999.html">[Windstille-commit] r3002 - in trunk/windstille:	data/particlesystems src/particles
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1998">[ date ]</a>
              <a href="thread.html#1998">[ thread ]</a>
              <a href="subject.html#1998">[ subject ]</a>
              <a href="author.html#1998">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: grumbel
Date: 2009-08-21 23:44:41 +0200 (Fri, 21 Aug 2009)
New Revision: 3001

Modified:
   trunk/windstille/src/app/console.cpp
   trunk/windstille/src/app/menu_manager.cpp
   trunk/windstille/src/app/windstille_main.cpp
   trunk/windstille/src/app/windstille_main.hpp
   trunk/windstille/src/display/drawing_context.cpp
   trunk/windstille/src/display/text_area.cpp
   trunk/windstille/src/font/fonts.cpp
   trunk/windstille/src/font/fonts.hpp
   trunk/windstille/src/font/ttf_font.cpp
   trunk/windstille/src/font/ttf_font.hpp
   trunk/windstille/src/gui/button.cpp
   trunk/windstille/src/gui/group_component.cpp
   trunk/windstille/src/gui/label.cpp
   trunk/windstille/src/gui/list_view.cpp
   trunk/windstille/src/gui/menu.cpp
   trunk/windstille/src/gui/menu_component.cpp
   trunk/windstille/src/gui/tab_component.cpp
   trunk/windstille/src/hud/controller_help_window.cpp
   trunk/windstille/src/hud/conversation.cpp
   trunk/windstille/src/hud/dialog_manager.cpp
   trunk/windstille/src/hud/inventory.cpp
   trunk/windstille/src/hud/pda.cpp
   trunk/windstille/src/hud/speech_manager.cpp
   trunk/windstille/src/input/input_configurator.cpp
   trunk/windstille/src/input/input_manager.cpp
   trunk/windstille/src/input/input_manager.hpp
   trunk/windstille/src/screen/game_session.cpp
   trunk/windstille/src/screen/screen_manager.cpp
   trunk/windstille/src/screen/sprite3dview.cpp
   trunk/windstille/src/screen/view.cpp
   trunk/windstille/src/scripting/interface.cpp
   trunk/windstille/src/tile/tile_factory.cpp
   trunk/windstille/src/tile/tile_factory.hpp
Log:
Converted the remaining managers to RAII

Modified: trunk/windstille/src/app/console.cpp
===================================================================
--- trunk/windstille/src/app/console.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/app/console.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -151,9 +151,9 @@
   int y = y_pos;
 
   if (active)
-    y -= Fonts::ttffont-&gt;get_height() + 2;
+    y -= Fonts::current()-&gt;ttffont-&gt;get_height() + 2;
 
-  int num_lines = 600 / (Fonts::ttffont-&gt;get_height() + 2);
+  int num_lines = 600 / (Fonts::current()-&gt;ttffont-&gt;get_height() + 2);
 
   if (console.is_active())
     Display::fill_rect(Rect(0,0, Display::get_width(), 600),
@@ -167,9 +167,9 @@
           if (buffer[i].display_time &gt; 4.0f &amp;&amp; !console.is_active())
             alpha = 1.0f - (buffer[i].display_time - 4.0f);
 
-          Fonts::ttffont-&gt;draw(Vector2f(x_pos, y), buffer[i].message, Color(0.88f, 0.88f, 1.0f, alpha));
+          Fonts::current()-&gt;ttffont-&gt;draw(Vector2f(x_pos, y), buffer[i].message, Color(0.88f, 0.88f, 1.0f, alpha));
         }
-      y -= Fonts::ttffont-&gt;get_height() + 2;
+      y -= Fonts::current()-&gt;ttffont-&gt;get_height() + 2;
     }
 
   if (active)
@@ -183,7 +183,7 @@
             str += &quot;_&quot;;
         }
 
-      Fonts::ttffont-&gt;draw(Vector2f(x_pos, y_pos), &quot;&gt; &quot; + str, Color(1.0f, 1.0f, 1.0f));
+      Fonts::current()-&gt;ttffont-&gt;draw(Vector2f(x_pos, y_pos), &quot;&gt; &quot; + str, Color(1.0f, 1.0f, 1.0f));
     }
 }
 
@@ -197,7 +197,7 @@
 
   if (active)
     {
-      InputEventLst events = InputManager::get_controller().get_events();
+      InputEventLst events = InputManager::current()-&gt;get_controller().get_events();
   
       for (InputEventLst::iterator i = events.begin(); i != events.end(); ++i)
         {
@@ -538,7 +538,7 @@
 Console::activate()
 {
   // Get rid of all input events so that we don't double press
-  InputManager::clear();
+  InputManager::current()-&gt;clear();
   impl-&gt;active = true;
 
   SDL_EnableKeyRepeat(SDL_DEFAULT_REPEAT_DELAY, SDL_DEFAULT_REPEAT_INTERVAL);

Modified: trunk/windstille/src/app/menu_manager.cpp
===================================================================
--- trunk/windstille/src/app/menu_manager.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/app/menu_manager.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -127,7 +127,7 @@
                                menu.get_root()));
 
     std::auto_ptr&lt;gui::TextView&gt; text(new gui::TextView(text_group-&gt;get_child_rect(), text_group.get()));
-    text-&gt;set_font(Fonts::vera12);
+    text-&gt;set_font(Fonts::current()-&gt;vera12.get());
     text-&gt;set_text(&quot;Windstille &quot; WINDSTILLE_VERSION &quot; - Copyright (C) 2009 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;\n&quot;
                    &quot;\n&quot;
                    &quot;This program is free software: you can redistribute it and/or modify &quot;
@@ -258,7 +258,7 @@
   std::auto_ptr&lt;TextView&gt; text(new TextView(group-&gt;get_child_rect(), 
                                             group.get()));
 
-  text-&gt;set_font(Fonts::vera12);
+  text-&gt;set_font(Fonts::current()-&gt;vera12.get());
   text-&gt;set_text(&quot;This is a tech-demo of Windstille. Its not meant &quot;
                  &quot;to be playable in any way except a bit of walking around. &quot;
                  &quot;It provides nothing to accomplish, just a few scenarios to &quot;
@@ -324,7 +324,7 @@
 
   std::auto_ptr&lt;TextView&gt; text(new TextView(group-&gt;get_child_rect(), group.get()));
 
-  text-&gt;set_font(Fonts::vera12);
+  text-&gt;set_font(Fonts::current()-&gt;vera12.get());
   text-&gt;set_text(&quot;Programming\n&quot;
                  &quot;===========\n&quot;
                  &quot;\n&quot;

Modified: trunk/windstille/src/app/windstille_main.cpp
===================================================================
--- trunk/windstille/src/app/windstille_main.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/app/windstille_main.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -83,17 +83,17 @@
     config.parse_args(argc, argv);
 
     {
-      m_window.reset(new OpenGLWindow());
-        
-      TTFFont::init(); 
-      Fonts::init(); 
-
+      OpenGLWindow      window;
+      TTFFontManager    ttffont_manager;
+      Fonts             fonts;
       SoundManager      sound_manager;
       TextureManager    texture_manager;
       SurfaceManager    surface_manager;
       SpriteManager     sprite_manager;
       sprite3d::Manager sprite3d_manager;
       ScriptManager     script_manager;
+      InputManager      input_manager;
+      TileFactory       tile_factory(&quot;tiles.scm&quot;);
 
       init_modules();
     
@@ -101,10 +101,9 @@
 
       config.save();
     
-      deinit_modules();
       PHYSFS_deinit();
     }
-  } 
+  }
   catch (std::exception&amp; err)
   {
     std::cout &lt;&lt; &quot;std::exception: &quot; &lt;&lt; err.what() &lt;&lt; std::endl;
@@ -186,7 +185,6 @@
   SoundManager::current()-&gt;enable_sound(config.get_bool(&quot;sound&quot;));
   SoundManager::current()-&gt;enable_music(config.get_bool(&quot;music&quot;));
 
-
   ScriptManager::current()-&gt;run_script_file(&quot;scripts/windstille.nut&quot;, true);
 
   { // Fill controller_description with data
@@ -229,32 +227,18 @@
     controller_description.add_ball(&quot;mouse-motion-y&quot;, MOUSE_MOTION_Y);
   }
     
-  {
-    InputManager::init();
-      
+  {     
     if (config.get&lt;std::string&gt;(&quot;primary-controller-file&quot;).is_set())
-      InputManager::load(config.get&lt;std::string&gt;(&quot;primary-controller-file&quot;).get());
+      InputManager::current()-&gt;load(config.get&lt;std::string&gt;(&quot;primary-controller-file&quot;).get());
     else
-      InputManager::load(&quot;controller/keyboard.scm&quot;);
+      InputManager::current()-&gt;load(&quot;controller/keyboard.scm&quot;);
 
     if (config.get&lt;std::string&gt;(&quot;secondary-controller-file&quot;).is_set())
-      InputManager::load(config.get&lt;std::string&gt;(&quot;secondary-controller-file&quot;).get());
+      InputManager::current()-&gt;load(config.get&lt;std::string&gt;(&quot;secondary-controller-file&quot;).get());
   }
-
-  if (debug) std::cout &lt;&lt; &quot;Initialising TileFactory&quot; &lt;&lt; std::endl;
-  TileFactory::init();
 }
 
 void
-WindstilleMain::deinit_modules()
-{
-  TileFactory::deinit();
-  InputManager::deinit();
-  Fonts::deinit();
-  TTFFont::deinit();
-}
-
-void
 WindstilleMain::init_sdl()
 {
 #ifdef DEBUG

Modified: trunk/windstille/src/app/windstille_main.hpp
===================================================================
--- trunk/windstille/src/app/windstille_main.hpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/app/windstille_main.hpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -51,8 +51,6 @@
 
 #include &quot;screen/screen.hpp&quot;
 
-class OpenGLWindow;
-
 class WindstilleMain
 { 
 private:
@@ -72,9 +70,6 @@
   void init_physfs(const char* argv0);
   void init_modules();
   void deinit_modules();
-
-private:
-  boost::scoped_ptr&lt;OpenGLWindow&gt; m_window;
 };
 
 #endif

Modified: trunk/windstille/src/display/drawing_context.cpp
===================================================================
--- trunk/windstille/src/display/drawing_context.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/display/drawing_context.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -126,7 +126,7 @@
   void draw(const Texture&amp; /*tmp_texture*/) {
     glPushMatrix();
     glMultMatrixf(modelview.matrix);
-    Fonts::ttffont-&gt;draw(pos, text);
+    Fonts::current()-&gt;ttffont-&gt;draw(pos, text);
     glPopMatrix();
   }
 };

Modified: trunk/windstille/src/display/text_area.cpp
===================================================================
--- trunk/windstille/src/display/text_area.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/display/text_area.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -56,7 +56,7 @@
 TextArea::TextArea(const Rectf&amp; rect, bool letter_by_letter)
   : impl(new TextAreaImpl)
 {
-  impl-&gt;font = Fonts::vera20;
+  impl-&gt;font = Fonts::current()-&gt;vera20.get();
   impl-&gt;rect    = rect;
   // FIXME: freetype might provide info for vspacing, not sure
   impl-&gt;v_space = 2;

Modified: trunk/windstille/src/font/fonts.cpp
===================================================================
--- trunk/windstille/src/font/fonts.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/font/fonts.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -16,28 +16,25 @@
 **  along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
 */
 
+#include &lt;assert.h&gt;
+
 #include &quot;app/globals.hpp&quot;
 #include &quot;border_font_effect.hpp&quot;
 #include &quot;fonts.hpp&quot;
 
-TTFFont* Fonts::ttffont = 0;
-TTFFont* Fonts::vera12  = 0;
-TTFFont* Fonts::vera20  = 0;
+Fonts* Fonts::s_current = 0;
 
-void
-Fonts::init()
+Fonts::Fonts()
+  : ttffont(new TTFFont(&quot;fonts/VeraMono.ttf&quot;, 14, BorderFontEffect(1, true))),
+    vera12(new TTFFont(&quot;fonts/Vera.ttf&quot;,     12, BorderFontEffect(2, true))),
+    vera20(new TTFFont(&quot;fonts/Vera.ttf&quot;,     20, BorderFontEffect(2, true)))
 {
-  ttffont = new TTFFont(&quot;fonts/VeraMono.ttf&quot;, 14, BorderFontEffect(1, true));
-  vera12  = new TTFFont(&quot;fonts/Vera.ttf&quot;,     12, BorderFontEffect(2, true));
-  vera20  = new TTFFont(&quot;fonts/Vera.ttf&quot;,     20, BorderFontEffect(2, true));
+  assert(!s_current);
+  s_current = this;
 }
 
-void
-Fonts::deinit()
+Fonts::~Fonts()
 {
-  delete ttffont;
-  delete vera12;
-  delete vera20;
 }
 
 /* EOF */

Modified: trunk/windstille/src/font/fonts.hpp
===================================================================
--- trunk/windstille/src/font/fonts.hpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/font/fonts.hpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -19,16 +19,25 @@
 #ifndef HEADER_WINDSTILLE_FONT_FONTS_HPP
 #define HEADER_WINDSTILLE_FONT_FONTS_HPP
 
+#include &lt;boost/scoped_ptr.hpp&gt;
+
 #include &quot;ttf_font.hpp&quot;
 
-class Fonts {
+class Fonts 
+{
+private:
+  static Fonts* s_current;
 public:
-  static TTFFont* ttffont;
-  static TTFFont* vera12;
-  static TTFFont* vera20;
+  static Fonts* current() { return s_current; }
 
-  static void init();
-  static void deinit();
+public:
+  boost::scoped_ptr&lt;TTFFont&gt; ttffont;
+  boost::scoped_ptr&lt;TTFFont&gt; vera12;
+  boost::scoped_ptr&lt;TTFFont&gt; vera20;
+
+public:
+  Fonts();
+  ~Fonts();
 };
 
 #endif

Modified: trunk/windstille/src/font/ttf_font.cpp
===================================================================
--- trunk/windstille/src/font/ttf_font.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/font/ttf_font.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -248,4 +248,14 @@
   FT_Done_FreeType( TTFFontImpl::library );
 }
 
+TTFFontManager::TTFFontManager()
+{
+  TTFFont::init();
+}
+
+TTFFontManager::~TTFFontManager()
+{
+  TTFFont::deinit();
+}
+
 /* EOF */

Modified: trunk/windstille/src/font/ttf_font.hpp
===================================================================
--- trunk/windstille/src/font/ttf_font.hpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/font/ttf_font.hpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -82,6 +82,13 @@
   std::auto_ptr&lt;TTFFontImpl&gt; impl;
 };
 
+class TTFFontManager
+{
+public:
+  TTFFontManager();
+  ~TTFFontManager();
+};
+
 #endif
 
 /* EOF */

Modified: trunk/windstille/src/gui/button.cpp
===================================================================
--- trunk/windstille/src/gui/button.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/gui/button.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -45,11 +45,11 @@
 {
   Display::fill_rect(rect, Color(0.0f, 0.0f, 0.0f, 0.5f));
   Display::draw_rect(rect, Color(1.0f, 1.0f, 1.0f, 0.5f));
-  Fonts::vera20-&gt;draw_center(Vector2f(rect.left + rect.get_width()/2, rect.top + rect.get_height()/2),
-                             label,
-                             is_active()
-                             ? Color(1.0f, 1.0f, 1.0f, 1.0f) 
-                             : Color(1.0f, 1.0f, 1.0f, 0.5f));
+  Fonts::current()-&gt;vera20-&gt;draw_center(Vector2f(rect.left + rect.get_width()/2, rect.top + rect.get_height()/2),
+                                        label,
+                                        is_active()
+                                        ? Color(1.0f, 1.0f, 1.0f, 1.0f) 
+                                        : Color(1.0f, 1.0f, 1.0f, 0.5f));
 }
 
 void

Modified: trunk/windstille/src/gui/group_component.cpp
===================================================================
--- trunk/windstille/src/gui/group_component.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/gui/group_component.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -43,7 +43,7 @@
 
   if (!title.empty())
     {
-      TTFFont* font = Fonts::vera20;
+      TTFFont* font = Fonts::current()-&gt;vera20.get();
       font-&gt;draw_center(Vector2f(rect.left + rect.get_width()/2, rect.top + font-&gt;get_height() + 5), 
                         title, Color(1.0f, 1.0f, 1.0f));
 
@@ -79,7 +79,7 @@
   int padding = 6;
 
   return Rectf(rect.left   + padding,
-               rect.top    + padding + (title.empty() ? 0 : Fonts::vera20-&gt;get_height() + 18),
+               rect.top    + padding + (title.empty() ? 0 : Fonts::current()-&gt;vera20-&gt;get_height() + 18),
                rect.right  - padding,
                rect.bottom - padding);
 }

Modified: trunk/windstille/src/gui/label.cpp
===================================================================
--- trunk/windstille/src/gui/label.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/gui/label.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -36,9 +36,9 @@
 {
   //Display::fill_rect(rect, Color(0.0f, 0.0f, 0.0f, 0.5f));
   //Display::draw_rect(rect, Color(1.0f, 1.0f, 1.0f, 0.5f));
-  Fonts::vera12-&gt;draw(Vector2f(rect.left + 5/*+ rect.get_width()/2*/, rect.top + rect.get_height()/2 + 3),
-                      label,
-                      Color(1.0f, 1.0f, 1.0f, 1.0f));
+  Fonts::current()-&gt;vera12-&gt;draw(Vector2f(rect.left + 5/*+ rect.get_width()/2*/, rect.top + rect.get_height()/2 + 3),
+                                 label,
+                                 Color(1.0f, 1.0f, 1.0f, 1.0f));
 }
 
 void

Modified: trunk/windstille/src/gui/list_view.cpp
===================================================================
--- trunk/windstille/src/gui/list_view.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/gui/list_view.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -36,7 +36,7 @@
 void
 ListView::draw()
 {
-  TTFFont* font = Fonts::vera20;
+  TTFFont* font = Fonts::current()-&gt;vera20.get();
 
   float x = rect.left;
   float y = rect.top + font-&gt;get_height();

Modified: trunk/windstille/src/gui/menu.cpp
===================================================================
--- trunk/windstille/src/gui/menu.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/gui/menu.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -39,7 +39,7 @@
 
   group.reset(new GroupComponent(rect, name, parent));
   menu.reset(new MenuComponent(group-&gt;get_child_rect(), allow_cancel, group.get()));
-  menu-&gt;set_font(Fonts::vera20);
+  menu-&gt;set_font(Fonts::current()-&gt;vera20.get());
 }
 
 Menu::~Menu()
@@ -100,7 +100,7 @@
                     (rect.top + rect.bottom) / 2.0f);
 
     Sizef size(menu-&gt;get_prefered_width(), 
-               menu-&gt;get_prefered_height() + (group-&gt;has_title()?Fonts::vera20-&gt;get_height() + 18:0.0f));
+               menu-&gt;get_prefered_height() + (group-&gt;has_title() ? Fonts::current()-&gt;vera20-&gt;get_height() + 18 : 0.0f));
 
     group-&gt;set_screen_rect(Rectf(Vector2f(center.x - size.width/2.0f,
                                           center.y - size.height/2.0f),

Modified: trunk/windstille/src/gui/menu_component.cpp
===================================================================
--- trunk/windstille/src/gui/menu_component.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/gui/menu_component.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -31,7 +31,7 @@
 MenuComponent::MenuComponent(const Rectf&amp; rect, bool allow_cancel_, Component* parent)
   : Component(rect, parent),
     current_item(0),
-    font(Fonts::vera20),
+    font(Fonts::current()-&gt;vera20.get()),
     allow_cancel(allow_cancel_),
     scroll_mode(false),
     scroll_offset(0),

Modified: trunk/windstille/src/gui/tab_component.cpp
===================================================================
--- trunk/windstille/src/gui/tab_component.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/gui/tab_component.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -50,7 +50,7 @@
     {
       Rectf tab_rect(Vector2f(rect.left + tab_width * i + 10,
                             rect.top),
-                     Sizef(tab_width - 20, Fonts::vera20-&gt;get_height() + 6));
+                     Sizef(tab_width - 20, Fonts::current()-&gt;vera20-&gt;get_height() + 6));
 
       if (i == current_tab)
         Display::fill_rounded_rect(tab_rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 0.5f));
@@ -59,12 +59,12 @@
 
       Display::draw_rounded_rect(tab_rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 0.5f));
 
-      Fonts::vera20-&gt;draw_center(Vector2f(rect.left + tab_width * i + tab_width/2,
-                                        rect.top + Fonts::vera20-&gt;get_height()),
-                                 tabs[i].label,
-                                 tabs[current_tab].component-&gt;is_active()
-                                 ? Color(1.0f, 1.0f, 1.0f, 0.5f) 
-                                 : Color(1.0f, 1.0f, 1.0f, 1.0f));
+      Fonts::current()-&gt;vera20-&gt;draw_center(Vector2f(rect.left + tab_width * i + tab_width/2,
+                                                     rect.top + Fonts::current()-&gt;vera20-&gt;get_height()),
+                                            tabs[i].label,
+                                            tabs[current_tab].component-&gt;is_active()
+                                            ? Color(1.0f, 1.0f, 1.0f, 0.5f) 
+                                            : Color(1.0f, 1.0f, 1.0f, 1.0f));
     }
 
   tabs[current_tab].component-&gt;draw();
@@ -138,7 +138,7 @@
 
   int padding = 6;
   component-&gt;set_screen_rect(Rectf(rect.left + padding,
-                                   rect.top  + padding + Fonts::vera20-&gt;get_height() + 10,
+                                   rect.top  + padding + Fonts::current()-&gt;vera20-&gt;get_height() + 10,
                                    rect.right  - padding,
                                    rect.bottom - padding
                                    ));

Modified: trunk/windstille/src/hud/controller_help_window.cpp
===================================================================
--- trunk/windstille/src/hud/controller_help_window.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/hud/controller_help_window.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -86,7 +86,7 @@
 void
 ControllerHelpWindow::draw()
 {
-  const Controller&amp; controller = InputManager::get_controller();
+  const Controller&amp; controller = InputManager::current()-&gt;get_controller();
 
   Vector2f pos(Display::get_width()  - 350 - 16, 
                Display::get_height() - 200 - 16);

Modified: trunk/windstille/src/hud/conversation.cpp
===================================================================
--- trunk/windstille/src/hud/conversation.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/hud/conversation.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -82,8 +82,8 @@
 
       Vector2f textpos = pos + Vector2f(0, 16.0f);
       // FIXME: Doesn't handle multi line text
-      Sizef size(Fonts::vera20-&gt;get_width(choices[i].topic) + 40.0f,
-                 Fonts::vera20-&gt;get_height() + 25.0f);
+      Sizef size(Fonts::current()-&gt;vera20-&gt;get_width(choices[i].topic) + 40.0f,
+                 Fonts::current()-&gt;vera20-&gt;get_height() + 25.0f);
       Rectf  rect(textpos + distance * offset - Vector2f(size.width/2, size.height - 15), size);
 
       if (i == selection)
@@ -93,18 +93,18 @@
           Display::fill_arc(pos, 42.0f, start, end, Color(1.0f, 1.0f, 1.0f, 0.5f), 24);
           Display::fill_rounded_rect(rect, 5.0f, Color(0.5f, 0.5f, 0.5f, 0.75f));
 
-          Fonts::vera20-&gt;draw_center(Vector2f(textpos.x + distance * offset.x,
-                                            textpos.y + distance * offset.y), 
-                                     choices[i].topic, Color(1.0f, 1.0f, 0.0f));
-
-          Fonts::vera20-&gt;draw_center(Vector2f(400.0f, Display::get_height() - 32.0f),
-                                     choices[i].text, Color(1.0f, 1.0f, 1.0f));
+          Fonts::current()-&gt;vera20-&gt;draw_center(Vector2f(textpos.x + distance * offset.x,
+                                                         textpos.y + distance * offset.y), 
+                                                choices[i].topic, Color(1.0f, 1.0f, 0.0f));
+          
+          Fonts::current()-&gt;vera20-&gt;draw_center(Vector2f(400.0f, Display::get_height() - 32.0f),
+                                                choices[i].text, Color(1.0f, 1.0f, 1.0f));
           Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 0.0f));
         }
       else
         {
           Display::fill_rounded_rect(rect, 5.0f, Color(0.25f, 0.25f, 0.25f, 0.75f));
-          Fonts::vera20-&gt;draw_center(Vector2f(textpos.x + distance * offset.x,
+          Fonts::current()-&gt;vera20-&gt;draw_center(Vector2f(textpos.x + distance * offset.x,
                                             textpos.y + distance * offset.y),
                                      choices[i].topic, Color(0.8f, 0.8f, 0.8f));
           Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f));

Modified: trunk/windstille/src/hud/dialog_manager.cpp
===================================================================
--- trunk/windstille/src/hud/dialog_manager.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/hud/dialog_manager.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -179,9 +179,9 @@
 
   Size dialog_size(dialog_width, dialog_height);
 
-  text_area.reset(new TextArea(Rect(Point(text_rect.left, text_rect.top + Fonts::vera20-&gt;get_height()),
+  text_area.reset(new TextArea(Rect(Point(text_rect.left, text_rect.top + Fonts::current()-&gt;vera20-&gt;get_height()),
                                     Size(text_width, 200)), true));
-  text_area-&gt;set_font(Fonts::vera20);
+  text_area-&gt;set_font(Fonts::current()-&gt;vera20.get());
   text_area-&gt;set_text(text);
 }
 

Modified: trunk/windstille/src/hud/inventory.cpp
===================================================================
--- trunk/windstille/src/hud/inventory.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/hud/inventory.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -102,7 +102,7 @@
       if (i == 0 &amp;&amp; moving == 0)
         {
           slothighlight.draw(draw_pos);
-          Fonts::vera20-&gt;draw_center(Vector2f(draw_pos.x, draw_pos.y - 64), item.name);
+          Fonts::current()-&gt;vera20-&gt;draw_center(Vector2f(draw_pos.x, draw_pos.y - 64), item.name);
         }
       else
         {

Modified: trunk/windstille/src/hud/pda.cpp
===================================================================
--- trunk/windstille/src/hud/pda.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/hud/pda.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -48,8 +48,8 @@
   text_area.reset(new TextArea(Rectf(pos + Vector2f(40.0f, 50.0f) + Vector2f(0.0f, 56.0f),
                                      Sizef(315.0f, 380.0f)).grow(-12.0f), false));
 
-  ui_area-&gt;set_font(Fonts::vera12);
-  text_area-&gt;set_font(Fonts::vera12);
+  ui_area-&gt;set_font(Fonts::current()-&gt;vera12.get());
+  text_area-&gt;set_font(Fonts::current()-&gt;vera12.get());
 }
 
 PDA::~PDA()

Modified: trunk/windstille/src/hud/speech_manager.cpp
===================================================================
--- trunk/windstille/src/hud/speech_manager.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/hud/speech_manager.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -62,7 +62,7 @@
   // that we get an empty gap between succesive text on the screen,
   // which is needed to make text look more like natural speech.
   if (seconds_passed &lt; (seconds_till_done - .1f))
-    Fonts::vera20-&gt;draw_center(pos, text, color);
+    Fonts::current()-&gt;vera20-&gt;draw_center(pos, text, color);
 }
 
 void

Modified: trunk/windstille/src/input/input_configurator.cpp
===================================================================
--- trunk/windstille/src/input/input_configurator.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/input/input_configurator.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -40,7 +40,7 @@
 
   area.set_text(out.str());
 
-  area.set_font(Fonts::ttffont);
+  area.set_font(Fonts::current()-&gt;ttffont.get());
 
   add_configure_item(ConfigureItem::CONFIGURE_BUTTON, INVENTORY_BUTTON);
   add_configure_item(ConfigureItem::CONFIGURE_BUTTON, AIM_BUTTON);

Modified: trunk/windstille/src/input/input_manager.cpp
===================================================================
--- trunk/windstille/src/input/input_manager.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/input/input_manager.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -16,6 +16,7 @@
 **  along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
 */
 
+#include &lt;assert.h&gt;
 #include &lt;iostream&gt;
 #include &lt;assert.h&gt;
 #include &lt;stdexcept&gt;
@@ -26,18 +27,17 @@
 #include &quot;input_manager_impl.hpp&quot;
 #include &quot;input_manager.hpp&quot;
 
-InputManagerImpl* InputManager::impl = 0;
+InputManager* InputManager::s_current = 0;
 
-void
-InputManager::init()
+InputManager::InputManager()
+  : impl(new InputManagerSDL())
 {
-  impl = new InputManagerSDL();
+  assert(!s_current);
+  s_current = this;
 }
 
-void 
-InputManager::deinit()
+InputManager::~InputManager()
 {
-  delete impl;
 }
 
 void

Modified: trunk/windstille/src/input/input_manager.hpp
===================================================================
--- trunk/windstille/src/input/input_manager.hpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/input/input_manager.hpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -21,6 +21,8 @@
 
 #include &lt;string&gt;
 #include &lt;vector&gt;
+#include &lt;boost/scoped_ptr.hpp&gt;
+
 #include &quot;controller.hpp&quot;
 #include &quot;input_event.hpp&quot;
 
@@ -30,21 +32,24 @@
 class InputManager
 {
 private:
-  static InputManagerImpl* impl;
+  static InputManager* s_current;
+public:
+  static InputManager* current() { return s_current; }
 
 public:
-  /** Init the InputManager */
-  static void init();
-  static void deinit();
+  InputManager();
+  ~InputManager();
 
   /** Load configuration file \a filename */
-  static void load(const std::string&amp; filename);
+  void load(const std::string&amp; filename);
 
-  static void update(float delta);
-  static const Controller&amp; get_controller();
-  static void clear();
+  void update(float delta);
+  const Controller&amp; get_controller();
+  void clear();
 
 private:
+  boost::scoped_ptr&lt;InputManagerImpl&gt; impl;
+
   InputManager(const InputManager&amp;);
   InputManager&amp; operator=(const InputManager&amp;);
 };

Modified: trunk/windstille/src/screen/game_session.cpp
===================================================================
--- trunk/windstille/src/screen/game_session.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/screen/game_session.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -174,8 +174,8 @@
   if (pause)
     {
       if ((SDL_GetTicks() / 1000) % 2)
-        Fonts::vera20-&gt;draw(Vector2f(Display::get_width()/2.0f, Display::get_height()/2.0f), 
-                            &quot;Pause&quot;);
+        Fonts::current()-&gt;vera20-&gt;draw(Vector2f(Display::get_width()/2.0f, Display::get_height()/2.0f), 
+                                       &quot;Pause&quot;);
     }
 }
 

Modified: trunk/windstille/src/screen/screen_manager.cpp
===================================================================
--- trunk/windstille/src/screen/screen_manager.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/screen/screen_manager.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -82,17 +82,17 @@
 
     while (delta &gt; step)
     {
-      InputManager::update(delta);
+      InputManager::current()-&gt;update(delta);
 
       console.update(step);
       if (!console.is_active())
       {
         if (!overlay_screens.empty())
-          overlay_screens.back()-&gt;update(step, InputManager::get_controller());
+          overlay_screens.back()-&gt;update(step, InputManager::current()-&gt;get_controller());
         else if (!screens.empty())
-          screens.back()-&gt;update(step, InputManager::get_controller());
+          screens.back()-&gt;update(step, InputManager::current()-&gt;get_controller());
       }
-      InputManager::clear();
+      InputManager::current()-&gt;clear();
   
       delta -= step;
     }
@@ -331,7 +331,7 @@
   
   std::ostringstream out;
   out &lt;&lt; &quot;FPS: &quot; &lt;&lt; last_fps;
-  Fonts::ttffont-&gt;draw(Vector2f(Display::get_width() - 100, 30), out.str());
+  Fonts::current()-&gt;ttffont-&gt;draw(Vector2f(Display::get_width() - 100, 30), out.str());
 }
 
 void

Modified: trunk/windstille/src/screen/sprite3dview.cpp
===================================================================
--- trunk/windstille/src/screen/sprite3dview.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/screen/sprite3dview.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -80,16 +80,16 @@
   sc.render();
   
   float x = 10.0f;
-  float y =  Fonts::vera12-&gt;get_height() + 5.0f;
-  int line_height = Fonts::vera12-&gt;get_height()+5;
+  float y =  Fonts::current()-&gt;vera12-&gt;get_height() + 5.0f;
+  int line_height = Fonts::current()-&gt;vera12-&gt;get_height()+5;
 
   for(int i = 0; i &lt; int(actions.size()); ++i)
     {
       if (i == current_action)
-        Fonts::vera12-&gt;draw(Vector2f(x, y),
+        Fonts::current()-&gt;vera12-&gt;draw(Vector2f(x, y),
                             actions[i], Color(1.0f, 1.0f, 1.0f));
       else
-        Fonts::vera12-&gt;draw(Vector2f(x, y),
+        Fonts::current()-&gt;vera12-&gt;draw(Vector2f(x, y),
                             actions[i], Color(0.7f, 0.7f, 0.7f));
 
 
@@ -97,7 +97,7 @@
       if (y &gt; 580.0f)
         {
           x += 200.0f;
-          y =  Fonts::vera12-&gt;get_height() + 5.0f;
+          y =  Fonts::current()-&gt;vera12-&gt;get_height() + 5.0f;
         }
     }
 }

Modified: trunk/windstille/src/screen/view.cpp
===================================================================
--- trunk/windstille/src/screen/view.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/screen/view.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -72,7 +72,7 @@
   if (keystate[SDLK_KP_MINUS])
     zoom *= 1.0f - delta;
 
-  const Controller&amp; controller = InputManager::get_controller();
+  const Controller&amp; controller = InputManager::current()-&gt;get_controller();
 
   if (controller.get_button_state(DEBUG_BUTTON))
     {

Modified: trunk/windstille/src/scripting/interface.cpp
===================================================================
--- trunk/windstille/src/scripting/interface.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/scripting/interface.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -128,9 +128,9 @@
   boost::shared_ptr&lt;SquirrelThread&gt; ptr = ScriptManager::current()-&gt;get_thread(vm);
 
   if (ptr.get())
-    {
-      ptr-&gt;set_wakeup_event(ScriptManager::TIME, time);
-    }
+  {
+    ptr-&gt;set_wakeup_event(ScriptManager::TIME, time);
+  }
 }
 
 void wait_for_dialog(HSQUIRRELVM vm)
@@ -138,9 +138,9 @@
   boost::shared_ptr&lt;SquirrelThread&gt; ptr = ScriptManager::current()-&gt;get_thread(vm);
 
   if (ptr.get())
-    {
-      ptr-&gt;set_wakeup_event(ScriptManager::DIALOG_CLOSED);
-    }
+  {
+    ptr-&gt;set_wakeup_event(ScriptManager::DIALOG_CLOSED);
+  }
 }
 
 void wait_for_camera(HSQUIRRELVM vm)
@@ -148,9 +148,9 @@
   boost::shared_ptr&lt;SquirrelThread&gt; ptr = ScriptManager::current()-&gt;get_thread(vm);
 
   if (ptr.get())
-    {
-      ptr-&gt;set_wakeup_event(ScriptManager::CAMERA_DONE);
-    }
+  {
+    ptr-&gt;set_wakeup_event(ScriptManager::CAMERA_DONE);
+  }
 }
 
 void wait_for_fade(HSQUIRRELVM vm)
@@ -158,9 +158,9 @@
   boost::shared_ptr&lt;SquirrelThread&gt; ptr = ScriptManager::current()-&gt;get_thread(vm);
 
   if (ptr.get())
-    {
-      ptr-&gt;set_wakeup_event(ScriptManager::FADE_DONE);
-    }
+  {
+    ptr-&gt;set_wakeup_event(ScriptManager::FADE_DONE);
+  }
 }
 
 int speech_show(const std::string&amp; text, float x, float y, float r, float g, float b)
@@ -222,10 +222,10 @@
   const std::vector&lt;boost::shared_ptr&lt; ::GameObject &gt; &gt;&amp; objects = Sector::current()-&gt;get_objects();
   
   for(std::vector&lt;boost::shared_ptr&lt; ::GameObject &gt; &gt;::const_iterator i = objects.begin(); i != objects.end(); ++i)
-    {
-      if (!(*i)-&gt;get_name().empty())
-        console &lt;&lt; (*i)-&gt;get_name() &lt;&lt; std::endl;
-    }
+  {
+    if (!(*i)-&gt;get_name().empty())
+      console &lt;&lt; (*i)-&gt;get_name() &lt;&lt; std::endl;
+  }
 }
 
 float get_game_speed()
@@ -264,9 +264,9 @@
   boost::shared_ptr&lt;SquirrelThread&gt; ptr = ScriptManager::current()-&gt;get_thread(vm);
 
   if (ptr.get())
-    {
-      ptr-&gt;set_wakeup_event(ScriptManager::CONVERSATION_CLOSED);
-    }
+  {
+    ptr-&gt;set_wakeup_event(ScriptManager::CONVERSATION_CLOSED);
+  }
 }
 
 SQInteger display(HSQUIRRELVM v)
@@ -304,12 +304,12 @@
 
 void set_console_font(const std::string&amp; font, int size)
 {
-  TTFFont* oldfont = Fonts::ttffont;
-
-  try {
-    Fonts::ttffont = new TTFFont(&quot;fonts/&quot; + font, size);
-    delete oldfont;
-  } catch(std::exception&amp; err) {
+  try 
+  {
+    Fonts::current()-&gt;ttffont.reset(new TTFFont(&quot;fonts/&quot; + font, size));
+  }
+  catch(std::exception&amp; err) 
+  {
     console &lt;&lt; err.what() &lt;&lt; std::endl;
   }
 }
@@ -362,26 +362,26 @@
 SQInteger spawn_object(HSQUIRRELVM v)
 {
   if (Sector::current())
-    {
-      const char* objname = 0;
-      sq_getstring(v, -2, &amp;objname);
+  {
+    const char* objname = 0;
+    sq_getstring(v, -2, &amp;objname);
 
-      // Newly created objects are deleted in ~SExprFileReader() and ~Lisp()
-      std::vector&lt;lisp::Lisp*&gt; entries;
-      entries.push_back(new lisp::Lisp(lisp::Lisp::TYPE_SYMBOL, objname));
-      table_to_lisp(v, -1, entries);
+    // Newly created objects are deleted in ~SExprFileReader() and ~Lisp()
+    std::vector&lt;lisp::Lisp*&gt; entries;
+    entries.push_back(new lisp::Lisp(lisp::Lisp::TYPE_SYMBOL, objname));
+    table_to_lisp(v, -1, entries);
 
-      try 
-        {
-          SExprFileReader reader(new lisp::Lisp(entries), true);
-          Sector::current()-&gt;add_object(reader);
-        }
-      catch (std::exception&amp; e) 
-        {
-          std::cerr &lt;&lt; &quot;Error parsing object in spawn_object: &quot; &lt;&lt; e.what()
-                    &lt;&lt; &quot;\n&quot;;
-        }
+    try 
+    {
+      SExprFileReader reader(new lisp::Lisp(entries), true);
+      Sector::current()-&gt;add_object(reader);
     }
+    catch (std::exception&amp; e) 
+    {
+      std::cerr &lt;&lt; &quot;Error parsing object in spawn_object: &quot; &lt;&lt; e.what()
+                &lt;&lt; &quot;\n&quot;;
+    }
+  }
   return 0;
 }
 
@@ -394,11 +394,11 @@
 SQInteger spawn_function(HSQUIRRELVM v)
 {
   if (ScriptManager::current())
-    {
-      boost::shared_ptr&lt;SquirrelThread&gt; thread = ScriptManager::current()-&gt;create_script(v, false);
-      thread-&gt;load(v, -1);
-      sq_pop(v, 1);
-    }
+  {
+    boost::shared_ptr&lt;SquirrelThread&gt; thread = ScriptManager::current()-&gt;create_script(v, false);
+    thread-&gt;load(v, -1);
+    sq_pop(v, 1);
+  }
   return 0;
 }
 
@@ -409,13 +409,13 @@
   table_to_lisp(v, -1, entries);
 
   for(std::vector&lt;lisp::Lisp*&gt;::iterator i = entries.begin(); i != entries.end(); ++i)
-    {
-      console &lt;&lt; (i - entries.begin()) &lt;&lt; &quot;: &quot;;
-      std::stringstream str;
-      (*i)-&gt;print(str);
-      console &lt;&lt; str.str();
-      console &lt;&lt; std::endl;
-    }
+  {
+    console &lt;&lt; (i - entries.begin()) &lt;&lt; &quot;: &quot;;
+    std::stringstream str;
+    (*i)-&gt;print(str);
+    console &lt;&lt; str.str();
+    console &lt;&lt; std::endl;
+  }
    
   return 0;
 }

Modified: trunk/windstille/src/tile/tile_factory.cpp
===================================================================
--- trunk/windstille/src/tile/tile_factory.cpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/tile/tile_factory.cpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -22,6 +22,7 @@
 #include &lt;sstream&gt;
 #include &lt;iostream&gt;
 #include &lt;memory&gt;
+
 #include &quot;app/globals.hpp&quot;
 #include &quot;tile.hpp&quot;
 #include &quot;tile_packer.hpp&quot;
@@ -35,8 +36,6 @@
 
 TileFactory* TileFactory::current_ = 0;
 
-std::string TileFactory::tile_def_file = &quot;tiles.scm&quot;;
-
 /** Check if the given region of the given image is fully transparent */
 bool surface_empty(const SoftwareSurface&amp; image, int sx, int sy, int w, int h)
 { 
@@ -54,8 +53,11 @@
   return true;
 }
 
-TileFactory::TileFactory (const std::string&amp; filename)
+TileFactory::TileFactory(const std::string&amp; filename)
 {
+  assert(!current_);
+  current_ = this;
+
   packers.push_back(new TilePacker(1024, 1024));
   packers.push_back(new TilePacker(1024, 1024));
   color_packer     = 0;
@@ -176,18 +178,4 @@
     }
 }
 
-void
-TileFactory::init()
-{
-  assert(current_ == 0);
-  current_ = new TileFactory(tile_def_file);
-}
-
-/** Destroy the default TileFactor */
-void
-TileFactory::deinit()
-{
-  delete current_;
-}
-
 /* EOF */

Modified: trunk/windstille/src/tile/tile_factory.hpp
===================================================================
--- trunk/windstille/src/tile/tile_factory.hpp	2009-08-21 21:11:40 UTC (rev 3000)
+++ trunk/windstille/src/tile/tile_factory.hpp	2009-08-21 21:44:41 UTC (rev 3001)
@@ -43,8 +43,6 @@
   std::vector&lt;TileDescription*&gt; descriptions;
   
 public:
-  static std::string tile_def_file;
-
   typedef Tiles::iterator iterator;
   
   iterator begin() { return tiles.begin(); }
@@ -53,7 +51,7 @@
   /** Create a TileFactory from a given tile definition file */
   TileFactory(const std::string&amp; filename);
   ~TileFactory();
-
+  
   /**
    * Create a new tile, or loads&amp;create it if it is not already
    * available
@@ -65,12 +63,6 @@
    */
   void pack(int id, int colmap, const SoftwareSurface&amp; image, const Rect&amp; rect);
 
-  /** Create the default TileFactor*/
-  static void init();
-
-  /** Destroy the default TileFactor*/
-  static void deinit();
-
   /** Access the default TileFactor*/
   static TileFactory* current() { return current_; }
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001997.html">[Windstille-commit] r3000 - in trunk/windstille/src: app armature	display editor screen sprite2d sprite3d
</A></li>
	<LI>Next message: <A HREF="001999.html">[Windstille-commit] r3002 - in trunk/windstille:	data/particlesystems src/particles
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1998">[ date ]</a>
              <a href="thread.html#1998">[ thread ]</a>
              <a href="subject.html#1998">[ subject ]</a>
              <a href="author.html#1998">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/windstille-commit">More information about the Windstille-commit
mailing list</a><br>
</body></html>
