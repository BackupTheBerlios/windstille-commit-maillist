From grumbel at mail.berlios.de  Tue Sep  1 12:31:08 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 1 Sep 2009 12:31:08 +0200
Subject: [Windstille-commit] r3164 - trunk/windstille/src/particles
Message-ID: <200909011031.n81AV8Jn002346@sheep.berlios.de>

Author: grumbel
Date: 2009-09-01 12:31:07 +0200 (Tue, 01 Sep 2009)
New Revision: 3164

Modified:
   trunk/windstille/src/particles/particle_system.cpp
   trunk/windstille/src/particles/particle_system.hpp
   trunk/windstille/src/particles/spark_drawer.cpp
   trunk/windstille/src/particles/surface_drawer.cpp
Log:
Handle position properly

Modified: trunk/windstille/src/particles/particle_system.cpp
===================================================================
--- trunk/windstille/src/particles/particle_system.cpp	2009-08-31 20:48:39 UTC (rev 3163)
+++ trunk/windstille/src/particles/particle_system.cpp	2009-09-01 10:31:07 UTC (rev 3164)
@@ -332,6 +332,13 @@
 }
 
 void
+ParticleSystem::set_pos(const Vector2f& pos)
+{
+  x_pos = pos.x;
+  y_pos = pos.y; 
+}
+
+void
 ParticleSystem::set_pos(float x, float y)
 {
   x_pos = x;

Modified: trunk/windstille/src/particles/particle_system.hpp
===================================================================
--- trunk/windstille/src/particles/particle_system.hpp	2009-08-31 20:48:39 UTC (rev 3163)
+++ trunk/windstille/src/particles/particle_system.hpp	2009-09-01 10:31:07 UTC (rev 3164)
@@ -127,6 +127,9 @@
   /** The position of the particle system in world coordinates */
   void set_pos(float x, float y);
 
+  /** The position of the particle system in world coordinates */
+  void set_pos(const Vector2f& pos);
+
   /** The position from which the particles spawn, x,y are in world
       coordinates, this is relative to the position you can set via
       set_pos() */

Modified: trunk/windstille/src/particles/spark_drawer.cpp
===================================================================
--- trunk/windstille/src/particles/spark_drawer.cpp	2009-08-31 20:48:39 UTC (rev 3163)
+++ trunk/windstille/src/particles/spark_drawer.cpp	2009-09-01 10:31:07 UTC (rev 3164)
@@ -33,7 +33,8 @@
 void
 SparkDrawer::draw(DrawingContext& dc, ParticleSystem& psys) 
 {
-  VertexArrayDrawable* buffer = new VertexArrayDrawable(Vector2f(0, 0), psys.get_z_pos(),
+  VertexArrayDrawable* buffer = new VertexArrayDrawable(Vector2f(psys.get_x_pos(), psys.get_y_pos()),
+                                                        psys.get_z_pos(),
                                                         dc.get_modelview());
   if (width == 1.0f)
     {
@@ -84,7 +85,8 @@
 void
 SparkDrawer::draw(const ParticleSystem& psys) const
 {
-  VertexArrayDrawable* buffer = new VertexArrayDrawable(Vector2f(0, 0), psys.get_z_pos(),
+  VertexArrayDrawable* buffer = new VertexArrayDrawable(Vector2f(psys.get_x_pos(), psys.get_y_pos()), 
+                                                        psys.get_z_pos(),
                                                         Matrix::identity());
   if (width == 1.0f)
     {

Modified: trunk/windstille/src/particles/surface_drawer.cpp
===================================================================
--- trunk/windstille/src/particles/surface_drawer.cpp	2009-08-31 20:48:39 UTC (rev 3163)
+++ trunk/windstille/src/particles/surface_drawer.cpp	2009-09-01 10:31:07 UTC (rev 3164)
@@ -105,7 +105,7 @@
 {          
   VertexArrayDrawable* buffer 
     = new VertexArrayDrawable(Vector2f(psys.get_x_pos(), psys.get_y_pos()), psys.get_z_pos(),
-                                    dc.get_modelview());
+                              dc.get_modelview());
 
   buffer->set_mode(GL_QUADS);
   buffer->set_texture(surface.get_texture());



From grumbel at mail.berlios.de  Tue Sep  1 12:32:01 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 1 Sep 2009 12:32:01 +0200
Subject: [Windstille-commit] r3165 - in trunk/windstille:
	data/sectors/trainstation src/engine src/objects
Message-ID: <200909011032.n81AW1LG003214@sheep.berlios.de>

Author: grumbel
Date: 2009-09-01 12:31:59 +0200 (Tue, 01 Sep 2009)
New Revision: 3165

Added:
   trunk/windstille/src/objects/particle_systems.cpp
   trunk/windstille/src/objects/particle_systems.hpp
Modified:
   trunk/windstille/data/sectors/trainstation/trainstation.wst
   trunk/windstille/src/engine/sector.cpp
Log:
Added ParticleSystems GameObject

Modified: trunk/windstille/data/sectors/trainstation/trainstation.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/trainstation.wst	2009-09-01 10:31:07 UTC (rev 3164)
+++ trunk/windstille/data/sectors/trainstation/trainstation.wst	2009-09-01 10:31:59 UTC (rev 3165)
@@ -684,6 +684,21 @@
           (angle 0)
           (hflip #f)
           (vflip #f))))
+  (particle-systems     
+      (name "particlesystems/water.particles")
+      (pos -100 300))
+  (particle-systems     
+      (name "particlesystems/fire.particles")
+      (pos -200 550))
+  (particle-systems     
+      (name "particlesystems/fire.particles")
+      (pos -100 550))
+  (particle-systems     
+      (name "particlesystems/fire.particles")
+      (pos -50 550))
+  (particle-systems     
+      (name "particlesystems/water.particles")
+      (pos -100 300))
     (layer
       (name "StairWall")
       (visible #t)
@@ -3386,6 +3401,7 @@
       (name "Trainstation")
       (visible #t)
       (locked #t)
-      (objects))))
+      (objects))
+))
 
 ;; EOF ;;

Modified: trunk/windstille/src/engine/sector.cpp
===================================================================
--- trunk/windstille/src/engine/sector.cpp	2009-09-01 10:31:07 UTC (rev 3164)
+++ trunk/windstille/src/engine/sector.cpp	2009-09-01 10:31:59 UTC (rev 3165)
@@ -23,18 +23,24 @@
 #include "collision/collision_engine.hpp"
 #include "engine/squirrel_thread.hpp"
 #include "navigation/navigation_graph.hpp"
+#include "scenegraph/navigation_graph_drawable.hpp"
+#include "scenegraph/scene_graph.hpp"
+#include "sound/sound_manager.hpp"
+#include "tile/tile_map.hpp"
+
 #include "objects/background_gradient.hpp"
 #include "objects/box.hpp"
 #include "objects/character.hpp"
 #include "objects/decal.hpp"
-#include "objects/layer.hpp"
+#include "objects/doll.hpp"
 #include "objects/elevator.hpp"
 #include "objects/hedgehog.hpp"
 #include "objects/laser_pointer.hpp"
+#include "objects/layer.hpp"
 #include "objects/liquid.hpp"
 #include "objects/nightvision.hpp"
+#include "objects/particle_systems.hpp"
 #include "objects/player.hpp"
-#include "objects/doll.hpp"
 #include "objects/scriptable_object.hpp"
 #include "objects/shockwave.hpp"
 #include "objects/spider_mine.hpp"
@@ -42,10 +48,6 @@
 #include "objects/test_object.hpp"
 #include "objects/trigger.hpp"
 #include "objects/vrdummy.hpp"
-#include "scenegraph/scene_graph.hpp"
-#include "scenegraph/navigation_graph_drawable.hpp"
-#include "sound/sound_manager.hpp"
-#include "tile/tile_map.hpp"
 
 Sector::Sector(const Pathname& arg_filename)
   : collision_engine(new CollisionEngine()),
@@ -246,7 +248,11 @@
   else if (reader.get_name() == "liquid")
   {
     obj = new Liquid(reader);
-  } 
+  }
+  else if (reader.get_name() == "particle-systems")
+  {
+    obj = new ParticleSystems(reader);
+  }
   else 
   {
     std::cout << "Skipping unknown Object: " << reader.get_name() << "\n";

Added: trunk/windstille/src/objects/particle_systems.cpp
===================================================================
--- trunk/windstille/src/objects/particle_systems.cpp	2009-09-01 10:31:07 UTC (rev 3164)
+++ trunk/windstille/src/objects/particle_systems.cpp	2009-09-01 10:31:59 UTC (rev 3165)
@@ -0,0 +1,77 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "objects/particle_systems.hpp"
+
+#include <sstream>
+#include <stdexcept>
+
+#include "engine/sector.hpp"
+#include "particles/particle_system.hpp"
+#include "scenegraph/scene_graph.hpp"
+#include "scenegraph/particle_system_drawable.hpp"
+
+ParticleSystems::ParticleSystems(const FileReader& reader)
+  : m_systems(),
+    m_drawables()
+{
+  std::string filename;
+  Vector2f    pos;
+  reader.get("name", filename);
+  reader.get("pos",  pos);
+
+  { // Load the ParticleSystems
+    FileReader root_reader = FileReader::parse(Pathname(filename));
+    if(root_reader.get_name() != "particle-systems") 
+    {
+      std::ostringstream msg;
+      msg << "'" << filename << "' is not a particle-system file";
+      throw std::runtime_error(msg.str());
+    }
+
+    std::vector<FileReader> sections = root_reader.get_sections();
+    for(std::vector<FileReader>::iterator i = sections.begin(); i != sections.end(); ++i)
+    { 
+      if (i->get_name() == "particle-system")
+      {
+        boost::shared_ptr<ParticleSystem> particle_system(new ParticleSystem(*i));
+        particle_system->set_pos(pos);
+        m_systems.push_back(particle_system);
+      }
+    }
+  }
+
+  for(Systems::iterator i = m_systems.begin(); i != m_systems.end(); ++i)
+  {
+    boost::shared_ptr<ParticleSystemDrawable> drawable(new ParticleSystemDrawable(**i));
+
+    m_drawables.push_back(drawable);
+    Sector::current()->get_scene_graph().add_drawable(drawable);
+  }
+}
+
+void
+ParticleSystems::update(float delta)
+{
+  for(Systems::iterator i = m_systems.begin(); i != m_systems.end(); ++i)
+  {
+    (*i)->update(delta);
+  }
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/objects/particle_systems.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/objects/particle_systems.hpp
===================================================================
--- trunk/windstille/src/objects/particle_systems.hpp	2009-09-01 10:31:07 UTC (rev 3164)
+++ trunk/windstille/src/objects/particle_systems.hpp	2009-09-01 10:31:59 UTC (rev 3165)
@@ -0,0 +1,52 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_OBJECTS_PARTICLE_SYSTEMS_HPP
+#define HEADER_WINDSTILLE_OBJECTS_PARTICLE_SYSTEMS_HPP
+
+#include <vector>
+#include <boost/shared_ptr.hpp>
+
+#include "engine/game_object.hpp"
+
+class ParticleSystem;
+class ParticleSystemDrawable;
+class FileReader;
+
+class ParticleSystems : public GameObject
+{
+private:
+  typedef std::vector<boost::shared_ptr<ParticleSystem> > Systems;
+  typedef std::vector<boost::shared_ptr<ParticleSystemDrawable> > Drawables;
+
+  Systems   m_systems;
+  Drawables m_drawables;
+
+public:
+  ParticleSystems(const FileReader& reader);
+
+  void update (float delta);
+
+private:
+  ParticleSystems(const ParticleSystems&);
+  ParticleSystems& operator=(const ParticleSystems&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/objects/particle_systems.hpp
___________________________________________________________________
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Tue Sep  1 12:41:12 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 1 Sep 2009 12:41:12 +0200
Subject: [Windstille-commit] r3166 - trunk/windstille/src/particles
Message-ID: <200909011041.n81AfCst011879@sheep.berlios.de>

Author: grumbel
Date: 2009-09-01 12:41:10 +0200 (Tue, 01 Sep 2009)
New Revision: 3166

Modified:
   trunk/windstille/src/particles/spark_drawer.cpp
   trunk/windstille/src/particles/surface_drawer.cpp
Log:
Fixed memory leak

Modified: trunk/windstille/src/particles/spark_drawer.cpp
===================================================================
--- trunk/windstille/src/particles/spark_drawer.cpp	2009-09-01 10:31:59 UTC (rev 3165)
+++ trunk/windstille/src/particles/spark_drawer.cpp	2009-09-01 10:41:10 UTC (rev 3166)
@@ -85,9 +85,9 @@
 void
 SparkDrawer::draw(const ParticleSystem& psys) const
 {
-  VertexArrayDrawable* buffer = new VertexArrayDrawable(Vector2f(psys.get_x_pos(), psys.get_y_pos()), 
-                                                        psys.get_z_pos(),
-                                                        Matrix::identity());
+  boost::shared_ptr<VertexArrayDrawable> buffer(new VertexArrayDrawable(Vector2f(psys.get_x_pos(), psys.get_y_pos()), 
+                                                                        psys.get_z_pos(),
+                                                                        Matrix::identity()));
   if (width == 1.0f)
     {
       buffer->set_mode(GL_LINES);

Modified: trunk/windstille/src/particles/surface_drawer.cpp
===================================================================
--- trunk/windstille/src/particles/surface_drawer.cpp	2009-09-01 10:31:59 UTC (rev 3165)
+++ trunk/windstille/src/particles/surface_drawer.cpp	2009-09-01 10:41:10 UTC (rev 3166)
@@ -102,7 +102,7 @@
 
 void
 SurfaceDrawer::draw(DrawingContext& dc, ParticleSystem& psys) 
-{          
+{
   VertexArrayDrawable* buffer 
     = new VertexArrayDrawable(Vector2f(psys.get_x_pos(), psys.get_y_pos()), psys.get_z_pos(),
                               dc.get_modelview());
@@ -162,9 +162,9 @@
 void
 SurfaceDrawer::draw(const ParticleSystem& psys) const
 {
-  VertexArrayDrawable* buffer 
-    = new VertexArrayDrawable(Vector2f(psys.get_x_pos(), psys.get_y_pos()), psys.get_z_pos(),
-                              Matrix::identity());
+  boost::shared_ptr<VertexArrayDrawable> buffer(new VertexArrayDrawable(Vector2f(psys.get_x_pos(), psys.get_y_pos()),
+                                                                        psys.get_z_pos(),
+                                                                        Matrix::identity()));
 
   buffer->set_mode(GL_QUADS);
   buffer->set_texture(surface.get_texture());



From grumbel at mail.berlios.de  Tue Sep  1 12:54:55 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 1 Sep 2009 12:54:55 +0200
Subject: [Windstille-commit] r3167 - in trunk/windstille/src: editor
	particles scenegraph
Message-ID: <200909011054.n81AstFs027459@sheep.berlios.de>

Author: grumbel
Date: 2009-09-01 12:54:52 +0200 (Tue, 01 Sep 2009)
New Revision: 3167

Modified:
   trunk/windstille/src/editor/particle_system_object_model.cpp
   trunk/windstille/src/particles/drawer.hpp
   trunk/windstille/src/particles/particle_system.cpp
   trunk/windstille/src/particles/particle_system.hpp
   trunk/windstille/src/particles/spark_drawer.cpp
   trunk/windstille/src/particles/spark_drawer.hpp
   trunk/windstille/src/particles/surface_drawer.cpp
   trunk/windstille/src/particles/surface_drawer.hpp
   trunk/windstille/src/scenegraph/drawable.hpp
Log:
Recycle the VertexArrayDrawable instead of reallocating on each draw

Modified: trunk/windstille/src/editor/particle_system_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/particle_system_object_model.cpp	2009-09-01 10:41:10 UTC (rev 3166)
+++ trunk/windstille/src/editor/particle_system_object_model.cpp	2009-09-01 10:54:52 UTC (rev 3167)
@@ -30,10 +30,8 @@
 }
 
 void
-ParticleSystemObjectModel::draw(SceneContext& sc)
+ParticleSystemObjectModel::draw(SceneContext& /*sc*/)
 {
-  for(ParticleSystems::iterator i = systems.begin(); i != systems.end(); ++i)
-    (*i)->draw(sc);
 }
 
 void

Modified: trunk/windstille/src/particles/drawer.hpp
===================================================================
--- trunk/windstille/src/particles/drawer.hpp	2009-09-01 10:41:10 UTC (rev 3166)
+++ trunk/windstille/src/particles/drawer.hpp	2009-09-01 10:54:52 UTC (rev 3167)
@@ -27,7 +27,6 @@
 {
 public:
   virtual ~Drawer() {}
-  virtual void draw(DrawingContext& sc, ParticleSystem& psys) =0;
   virtual void draw(const ParticleSystem& psys) const =0;
 };
 

Modified: trunk/windstille/src/particles/particle_system.cpp
===================================================================
--- trunk/windstille/src/particles/particle_system.cpp	2009-09-01 10:41:10 UTC (rev 3166)
+++ trunk/windstille/src/particles/particle_system.cpp	2009-09-01 10:54:52 UTC (rev 3167)
@@ -226,20 +226,7 @@
 ParticleSystem::set_drawer(Drawer* drawer_)
 {
   drawer.reset(drawer_);
-}
-  
-void
-ParticleSystem::draw(SceneContext& sc)
-{
-  if (drawer.get())
-    {
-      drawer->draw(sc.get_layer(layer), *this);
-    }
-  else
-    {
-      std::cout << "ParticleSystem: No drawer set" << std::endl;
-    }
-}
+} 
 
 void
 ParticleSystem::draw() const

Modified: trunk/windstille/src/particles/particle_system.hpp
===================================================================
--- trunk/windstille/src/particles/particle_system.hpp	2009-09-01 10:41:10 UTC (rev 3166)
+++ trunk/windstille/src/particles/particle_system.hpp	2009-09-01 10:54:52 UTC (rev 3167)
@@ -104,7 +104,6 @@
   void set_drawer(Drawer*);
 
   /** Draws the particle system to the screen */
-  void draw(SceneContext& sc);
   void draw() const;
 
   /** Update the particle system \a delta seconds */

Modified: trunk/windstille/src/particles/spark_drawer.cpp
===================================================================
--- trunk/windstille/src/particles/spark_drawer.cpp	2009-09-01 10:41:10 UTC (rev 3166)
+++ trunk/windstille/src/particles/spark_drawer.cpp	2009-09-01 10:54:52 UTC (rev 3167)
@@ -24,70 +24,21 @@
 
 SparkDrawer::SparkDrawer(FileReader& props)
   : color(1.0f, 1.0f, 1.0f),
-    width(1.0f)    
+    width(1.0f),
+    buffer()
 {
   props.get("color", color);
   props.get("width", width);
-}
 
-void
-SparkDrawer::draw(DrawingContext& dc, ParticleSystem& psys) 
-{
-  VertexArrayDrawable* buffer = new VertexArrayDrawable(Vector2f(psys.get_x_pos(), psys.get_y_pos()),
-                                                        psys.get_z_pos(),
-                                                        dc.get_modelview());
-  if (width == 1.0f)
-    {
-      buffer->set_mode(GL_LINES);
-      buffer->set_blend_func(GL_SRC_ALPHA, GL_ONE);
-      for(ParticleSystem::Particles::iterator i = psys.begin(); i != psys.end(); ++i)
-        {
-          buffer->color(Color(color.r, color.g, color.b, color.a - (color.a * psys.get_progress(i->t))));
-          buffer->vertex(i->x + i->v_x/10.0f, i->y + i->v_y/10.0f); 
-
-          buffer->color(Color(0, 0, 0, 0));
-          buffer->vertex(i->x, i->y);
-        }
-    }
-  else
-    {
-      buffer->set_mode(GL_QUADS);
-      buffer->set_blend_func(GL_SRC_ALPHA, GL_ONE);
-      for(ParticleSystem::Particles::iterator i = psys.begin(); i != psys.end(); ++i)
-        {
-          const float len = sqrtf(i->v_x * i->v_x  +  i->v_y * i->v_y);
-
-          const float o_x = i->v_y/len * width;
-          const float o_y = i->v_x/len * width;
-
-          const float x1 = i->x;
-          const float y1 = i->y;
-          const float x2 = i->x + i->v_x/10.0f;
-          const float y2 = i->y + i->v_y/10.0f;
-
-          buffer->color(Color(0, 0, 0, 0));
-          buffer->vertex(x1 + o_x, y1 - o_y);
-
-          buffer->color(Color(0, 0, 0, 0));
-          buffer->vertex(x1 - o_x, y1 + o_y);
-
-          buffer->color(Color(color.r, color.g, color.b, color.a - (color.a * psys.get_progress(i->t))));
-          buffer->vertex(x2 - o_x, y2 + o_y); 
-
-          buffer->color(Color(color.r, color.g, color.b, color.a - (color.a * psys.get_progress(i->t))));
-          buffer->vertex(x2 + o_x, y2 - o_y); 
-        }
-    }
-
-  dc.draw(buffer);
+  buffer.reset(new VertexArrayDrawable(Vector2f(), 0.0f, Matrix::identity())); 
 }
 
 void
 SparkDrawer::draw(const ParticleSystem& psys) const
 {
-  boost::shared_ptr<VertexArrayDrawable> buffer(new VertexArrayDrawable(Vector2f(psys.get_x_pos(), psys.get_y_pos()), 
-                                                                        psys.get_z_pos(),
-                                                                        Matrix::identity()));
+  buffer->clear();
+  buffer->set_pos(Vector2f(psys.get_x_pos(), psys.get_y_pos()));
+
   if (width == 1.0f)
     {
       buffer->set_mode(GL_LINES);

Modified: trunk/windstille/src/particles/spark_drawer.hpp
===================================================================
--- trunk/windstille/src/particles/spark_drawer.hpp	2009-09-01 10:41:10 UTC (rev 3166)
+++ trunk/windstille/src/particles/spark_drawer.hpp	2009-09-01 10:54:52 UTC (rev 3167)
@@ -23,17 +23,18 @@
 
 class SceneContext;
 class ParticleSystem;
+class VertexArrayDrawable;
 
 class SparkDrawer : public Drawer
 {
 private:
   Color color;
   float width;
+  boost::shared_ptr<VertexArrayDrawable> buffer;
 
 public:
   SparkDrawer(FileReader& props);
 
-  void draw(DrawingContext& dc, ParticleSystem& psys);
   void draw(const ParticleSystem& psys) const;
 };
 

Modified: trunk/windstille/src/particles/surface_drawer.cpp
===================================================================
--- trunk/windstille/src/particles/surface_drawer.cpp	2009-09-01 10:41:10 UTC (rev 3166)
+++ trunk/windstille/src/particles/surface_drawer.cpp	2009-09-01 10:54:52 UTC (rev 3167)
@@ -63,11 +63,12 @@
     return GL_ONE;
   }
 }
-
+
 SurfaceDrawer::SurfaceDrawer(FileReader& props)
   : surface(),
     blendfunc_src(),
-    blendfunc_dest()
+    blendfunc_dest(),
+    buffer()
 {
   std::string blendfunc_src_str = "src_alpha";
   std::string blendfunc_dst_str = "one_minus_src_alpha";
@@ -81,6 +82,10 @@
 
   blendfunc_src  = string2blendfunc(blendfunc_src_str);
   blendfunc_dest = string2blendfunc(blendfunc_dst_str);
+
+  // FIXME: Bad idea, as the psys isn't fully loaded as this point 
+  buffer.reset(new VertexArrayDrawable(Vector2f(), 0.0f,
+                                       Matrix::identity()));
 }
 
 SurfaceDrawer::~SurfaceDrawer() 
@@ -101,70 +106,10 @@
 }
 
 void
-SurfaceDrawer::draw(DrawingContext& dc, ParticleSystem& psys) 
-{
-  VertexArrayDrawable* buffer 
-    = new VertexArrayDrawable(Vector2f(psys.get_x_pos(), psys.get_y_pos()), psys.get_z_pos(),
-                              dc.get_modelview());
-
-  buffer->set_mode(GL_QUADS);
-  buffer->set_texture(surface.get_texture());
-  buffer->set_blend_func(blendfunc_src, blendfunc_dest);
-
-  for(ParticleSystem::Particles::iterator i = psys.begin(); i != psys.end(); ++i)
-    {
-      if (i->t != -1.0f)
-        {
-          float p = 1.0f - psys.get_progress(i->t);
-          Color color(psys.get_color_start().r * p + psys.get_color_stop().r * (1.0f - p),
-                      psys.get_color_start().g * p + psys.get_color_stop().g * (1.0f - p),
-                      psys.get_color_start().b * p + psys.get_color_stop().b * (1.0f - p),
-                      psys.get_color_start().a * p + psys.get_color_stop().a * (1.0f - p));
-
-          // scale
-          float scale  = psys.get_size_start() + 
-            psys.get_progress(i->t) * (psys.get_size_stop() - psys.get_size_start());
-          
-          float width  = surface.get_width()  * scale;
-          float height = surface.get_height() * scale;
-              
-          // rotate
-          float x_rot = width/2;
-          float y_rot = height/2; 
-
-          if (i->angle != 0)
-            {
-              float s = sinf(math::pi * i->angle/180.0f);
-              float c = cosf(math::pi * i->angle/180.0f);
-              x_rot = (width/2) * c - (height/2) * s;
-              y_rot = (width/2) * s + (height/2) * c;
-            }
-
-          buffer->add_texcoords(surface.get_uv());
-
-          buffer->color(color);
-          buffer->vertex(i->x - x_rot, i->y - y_rot);
-
-          buffer->color(color);
-          buffer->vertex(i->x + y_rot, i->y - x_rot);
-
-          buffer->color(color);
-          buffer->vertex(i->x + x_rot, i->y + y_rot);
-
-          buffer->color(color);
-          buffer->vertex(i->x - y_rot, i->y + x_rot);
-        }
-    }
-
-  dc.draw(buffer);
-}
-
-void
 SurfaceDrawer::draw(const ParticleSystem& psys) const
 {
-  boost::shared_ptr<VertexArrayDrawable> buffer(new VertexArrayDrawable(Vector2f(psys.get_x_pos(), psys.get_y_pos()),
-                                                                        psys.get_z_pos(),
-                                                                        Matrix::identity()));
+  buffer->clear();
+  buffer->set_pos(Vector2f(psys.get_x_pos(), psys.get_y_pos()));
 
   buffer->set_mode(GL_QUADS);
   buffer->set_texture(surface.get_texture());

Modified: trunk/windstille/src/particles/surface_drawer.hpp
===================================================================
--- trunk/windstille/src/particles/surface_drawer.hpp	2009-09-01 10:41:10 UTC (rev 3166)
+++ trunk/windstille/src/particles/surface_drawer.hpp	2009-09-01 10:54:52 UTC (rev 3167)
@@ -22,12 +22,15 @@
 #include "display/surface.hpp"
 #include "particles/drawer.hpp"
 
+class VertexArrayDrawable;
+
 class SurfaceDrawer : public Drawer
 {
 private:
   Surface surface;
   GLenum blendfunc_src;
   GLenum blendfunc_dest;
+  boost::shared_ptr<VertexArrayDrawable> buffer;
   
 public:
   SurfaceDrawer(FileReader& props);
@@ -37,7 +40,6 @@
   void set_texture(Surface surface);
   void set_blendfuncs(GLenum blendfunc_src, GLenum blendfunc_dst);
 
-  void draw(DrawingContext& sc, ParticleSystem& psys);
   void draw(const ParticleSystem& psys) const;
 };
 

Modified: trunk/windstille/src/scenegraph/drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/drawable.hpp	2009-09-01 10:41:10 UTC (rev 3166)
+++ trunk/windstille/src/scenegraph/drawable.hpp	2009-09-01 10:54:52 UTC (rev 3167)
@@ -75,6 +75,8 @@
   void set_render_mask(unsigned int mask) { render_mask = mask; }
   unsigned int get_render_mask() const { return render_mask; }
 
+  void set_pos(const Vector2f& pos_) { pos = pos_; }
+
 private:
   Drawable (const Drawable&);
   Drawable& operator= (const Drawable&);



From grumbel at mail.berlios.de  Tue Sep  1 13:00:27 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 1 Sep 2009 13:00:27 +0200
Subject: [Windstille-commit] r3168 - trunk/windstille/data/particlesystems
Message-ID: <200909011100.n81B0Rsu002864@sheep.berlios.de>

Author: grumbel
Date: 2009-09-01 13:00:26 +0200 (Tue, 01 Sep 2009)
New Revision: 3168

Modified:
   trunk/windstille/data/particlesystems/fire.particles
   trunk/windstille/data/particlesystems/water.particles
Log:
Use color layer instead of highlight one

Modified: trunk/windstille/data/particlesystems/fire.particles
===================================================================
--- trunk/windstille/data/particlesystems/fire.particles	2009-09-01 10:54:52 UTC (rev 3167)
+++ trunk/windstille/data/particlesystems/fire.particles	2009-09-01 11:00:26 UTC (rev 3168)
@@ -6,7 +6,7 @@
   (drawer (spark-drawer (color 1.0 0.5 0.5)))
   (z-pos 900)
   (pos 0 32)
-  (layer "highlight")
+  (layer "color")
   (velocity 400 650)
   (cone -115 -65)
   (gravity 0  1)
@@ -48,7 +48,7 @@
   (pos 0 0)
   (count 75)
   (z-pos 1000)
-  (layer "highlight")
+  (layer "color")
   (velocity 200 300)
   (cone -95 -85)
   (gravity 0 -0.05)

Modified: trunk/windstille/data/particlesystems/water.particles
===================================================================
--- trunk/windstille/data/particlesystems/water.particles	2009-09-01 10:54:52 UTC (rev 3167)
+++ trunk/windstille/data/particlesystems/water.particles	2009-09-01 11:00:26 UTC (rev 3168)
@@ -6,7 +6,7 @@
   (z-pos 900)
   (count 1000)
   (pos 0 -200)
-  (layer "highlight")
+  (layer "color")
   (velocity 100 200)
   (cone -10 -170)
   (gravity 0  .5)
@@ -17,7 +17,7 @@
    (z-pos 900)
    (count 1000)
    (pos 0 -200)
-   (layer "highlight")
+   (layer "color")
    (velocity 100 200)
    (cone -50 -130)
    (gravity 0  .5)



From grumbel at mail.berlios.de  Tue Sep  1 13:01:22 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 1 Sep 2009 13:01:22 +0200
Subject: [Windstille-commit] r3169 - trunk/windstille/data/controller
Message-ID: <200909011101.n81B1MYN004225@sheep.berlios.de>

Author: grumbel
Date: 2009-09-01 13:01:19 +0200 (Tue, 01 Sep 2009)
New Revision: 3169

Modified:
   trunk/windstille/data/controller/dvorak.scm
Log:
Added debug button

Modified: trunk/windstille/data/controller/dvorak.scm
===================================================================
--- trunk/windstille/data/controller/dvorak.scm	2009-09-01 11:00:26 UTC (rev 3168)
+++ trunk/windstille/data/controller/dvorak.scm	2009-09-01 11:01:19 UTC (rev 3169)
@@ -22,6 +22,7 @@
 
  (select-button     (keyboard-button (key "p")))
  (start-button      (keyboard-button (key "u")))
+ (debug-button      (keyboard-button (key "d")))
 
  ;; don't bind those, since they only make sense on analog gamepads
  ;; with an additional dpad, on digital devices x-axs and y-axis



From grumbel at mail.berlios.de  Tue Sep  1 13:04:50 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 1 Sep 2009 13:04:50 +0200
Subject: [Windstille-commit] r3170 - trunk/windstille
Message-ID: <200909011104.n81B4oZU008154@sheep.berlios.de>

Author: grumbel
Date: 2009-09-01 13:04:49 +0200 (Tue, 01 Sep 2009)
New Revision: 3170

Modified:
   trunk/windstille/INSTALL
   trunk/windstille/TODO
Log:
TODO updates

Modified: trunk/windstille/INSTALL
===================================================================
--- trunk/windstille/INSTALL	2009-09-01 11:01:19 UTC (rev 3169)
+++ trunk/windstille/INSTALL	2009-09-01 11:04:49 UTC (rev 3170)
@@ -48,8 +48,9 @@
 
 and run it from inside its source directory with:
 
- % ./windstille
+ % build/windstille -d data/
 
+
 Installation
 ============
 

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2009-09-01 11:01:19 UTC (rev 3169)
+++ trunk/windstille/TODO	2009-09-01 11:04:49 UTC (rev 3170)
@@ -10,6 +10,38 @@
 in the context of the whole game or if a potential performance
 enhanchment, actually enhanchmes anything at all.
 
+Overview
+========
+
+* use control layer for NavGraph draving and other debug stuff
+
+* use SceneGraph in objects that already use VertexArray
+  (BackgroundGradient, Swarm)
+
+* need multiple render path:
+
+  * MatrixG450: seems a lost cause, way to slow and only 16bit
+  * Geforce2MX: doesn't have Framebuffer object and shader
+  * Geforce???: has Framebuffer object and shader
+
+* use SceneGraph in the editor 
+
+* add z/layer ordering to NavGraph
+
+* add trigger to NavGraph
+
+* add Grid snapping to the Editor
+
+* build a more complete scenario
+
+* tweak graphics (lightmaps are to big, stuff doesn't tile properly, etc.)
+
+* implement jumping: 
+
+  * calculate an arc from the current pos to the next ledge or landing spot
+
+  * let character travel that arc
+
 Animation
 =========
 
@@ -50,6 +82,8 @@
 Display
 =======
 
+* Display::aspect_size is ugly, turning it into a Display::set_size() wouldn't help much
+
 * OpenGLState class is really slow (rewrite it to not use std::map, also remove the impl allocation)
 
 * Display::push/pop_cliprect() doesn't handle different aspect-ratios properly
@@ -275,10 +309,6 @@
   1-bit alpha, which could be used to bucket sort drawing requests and
   reduce texture switches (in case those ever start posing a problem)
 
-* Display::aspect_size is ugly, turn that into a Display::set_size();
-
-* move particle system into library
-
 * replace lisp::Writer with custom FileWriter (used in config)
 
 * make FileReader work more like lisp::Writer, i.e. less
@@ -455,8 +485,6 @@
 * create a test sector that as open sky, currently most test levels
   are indoor
 
-* fix the particle system in newformat2.wst, speed/lifetime is wrong
-
 * implement light switches in apartment
 
   Currently the light switch-off sequence is done in the use script,
@@ -931,7 +959,6 @@
   - BabyXML
   - Sprite2D
   - Sprite3D
-  - ParticleSystem
   - Dialog/Conversation
 
 * Screens might fit better into app/ then screen/



From grumbel at mail.berlios.de  Tue Sep  1 17:29:16 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 1 Sep 2009 17:29:16 +0200
Subject: [Windstille-commit] r3171 - trunk/windstille/src/display
Message-ID: <200909011529.n81FTGFI019941@sheep.berlios.de>

Author: grumbel
Date: 2009-09-01 17:29:16 +0200 (Tue, 01 Sep 2009)
New Revision: 3171

Modified:
   trunk/windstille/src/display/compositor.cpp
   trunk/windstille/src/display/opengl_window.cpp
Log:
Autodetect framebuffer_object extension and use the proper render path

Modified: trunk/windstille/src/display/compositor.cpp
===================================================================
--- trunk/windstille/src/display/compositor.cpp	2009-09-01 11:04:49 UTC (rev 3170)
+++ trunk/windstille/src/display/compositor.cpp	2009-09-01 15:29:16 UTC (rev 3171)
@@ -55,12 +55,21 @@
   Size m_size;
 
   CompositorImpl(const Size& size)
-    : //framebuffers(0),
-      framebuffers(new Framebuffers(size)),
+    : framebuffers(0),
       lightmap(size.width  / LIGHTMAP_DIV,
                size.height / LIGHTMAP_DIV),
       m_size(size)
-  {}
+  {
+      if (GLEW_EXT_framebuffer_object) 
+      {
+        framebuffers.reset(new Framebuffers(size));
+        std::cout  << "Display:: framebuffer_object extension is supported" << std::endl;
+      }
+      else
+      {
+        std::cout  << "Display:: framebuffer_object extension is not supported" << std::endl;
+      }
+  }
 };
 
 Compositor::Compositor(const Size& size)

Modified: trunk/windstille/src/display/opengl_window.cpp
===================================================================
--- trunk/windstille/src/display/opengl_window.cpp	2009-09-01 11:04:49 UTC (rev 3170)
+++ trunk/windstille/src/display/opengl_window.cpp	2009-09-01 15:29:16 UTC (rev 3171)
@@ -61,13 +61,6 @@
         throw std::runtime_error(msg.str());
       }
 
-      if (!GLEW_EXT_framebuffer_object) 
-      {
-        std::ostringstream msg;
-        msg << "Display:: Framebuffer opengl extension not supported";
-        throw std::runtime_error(msg.str());
-      }
-
       glViewport(0, 0, m_window->w, m_window->h);
       glMatrixMode(GL_PROJECTION);
       glLoadIdentity();



From grumbel at mail.berlios.de  Tue Sep  1 18:20:19 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 1 Sep 2009 18:20:19 +0200
Subject: [Windstille-commit] r3172 - trunk/windstille/src/display
Message-ID: <200909011620.n81GKJkQ024835@sheep.berlios.de>

Author: grumbel
Date: 2009-09-01 18:20:19 +0200 (Tue, 01 Sep 2009)
New Revision: 3172

Modified:
   trunk/windstille/src/display/compositor.cpp
   trunk/windstille/src/display/opengl_window.cpp
Log:
Print some debugging info

Modified: trunk/windstille/src/display/compositor.cpp
===================================================================
--- trunk/windstille/src/display/compositor.cpp	2009-09-01 15:29:16 UTC (rev 3171)
+++ trunk/windstille/src/display/compositor.cpp	2009-09-01 16:20:19 UTC (rev 3172)
@@ -62,8 +62,8 @@
   {
       if (GLEW_EXT_framebuffer_object) 
       {
+        std::cout  << "Display:: framebuffer_object extension is supported" << std::endl;
         framebuffers.reset(new Framebuffers(size));
-        std::cout  << "Display:: framebuffer_object extension is supported" << std::endl;
       }
       else
       {

Modified: trunk/windstille/src/display/opengl_window.cpp
===================================================================
--- trunk/windstille/src/display/opengl_window.cpp	2009-09-01 15:29:16 UTC (rev 3171)
+++ trunk/windstille/src/display/opengl_window.cpp	2009-09-01 16:20:19 UTC (rev 3172)
@@ -27,7 +27,7 @@
 #include "app/config.hpp"
 
 OpenGLWindow::OpenGLWindow()
- : m_window(0)
+  : m_window(0)
 {
   SDL_GL_SetAttribute(SDL_GL_SWAP_CONTROL, 1); // vsync
   SDL_GL_SetAttribute(SDL_GL_DOUBLEBUFFER, 1); 
@@ -36,10 +36,10 @@
   SDL_GL_SetAttribute(SDL_GL_BLUE_SIZE,  5);
 
   if (config.get_int("anti-aliasing"))
-    {
-      SDL_GL_SetAttribute( SDL_GL_MULTISAMPLEBUFFERS, 1 ); // boolean value, either it's enabled or not
-      SDL_GL_SetAttribute( SDL_GL_MULTISAMPLESAMPLES, config.get_int("anti-aliasing") ); // 0, 2, or 4 for number of samples
-    }
+  {
+    SDL_GL_SetAttribute( SDL_GL_MULTISAMPLEBUFFERS, 1 ); // boolean value, either it's enabled or not
+    SDL_GL_SetAttribute( SDL_GL_MULTISAMPLESAMPLES, config.get_int("anti-aliasing") ); // 0, 2, or 4 for number of samples
+  }
   
   SDL_WM_SetCaption("Windstille", "Windstille");
   SDL_WM_SetIcon(IMG_Load(Pathname("icon.png").get_sys_path().c_str()), NULL);
@@ -48,18 +48,21 @@
                               0, SDL_OPENGL | (config.get_bool("fullscreen") ? SDL_FULLSCREEN : 0));
 
   if (!m_window)
+  {
+    throw std::runtime_error("Display:: Couldn't create window");
+  }
+  else
+  {
+    GLenum err = glewInit();
+    if (err != GLEW_OK) 
     {
-      throw std::runtime_error("Display:: Couldn't create window");
+      std::ostringstream msg;
+      msg << "Display:: Couldn't initialize glew: " << glewGetString(err);
+      throw std::runtime_error(msg.str());
     }
-  else
+    else
     {
-      GLenum err = glewInit();
-      if (err != GLEW_OK) 
-      {
-        std::ostringstream msg;
-        msg << "Display:: Couldn't initialize glew: " << glewGetString(err);
-        throw std::runtime_error(msg.str());
-      }
+      std::cout << "glewInit() successfull" << std::endl;
 
       glViewport(0, 0, m_window->w, m_window->h);
       glMatrixMode(GL_PROJECTION);
@@ -86,6 +89,7 @@
 
       OpenGLState::init();
     }
+  }
 }
 
 OpenGLWindow::~OpenGLWindow()



From grumbel at mail.berlios.de  Tue Sep  1 20:10:34 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 1 Sep 2009 20:10:34 +0200
Subject: [Windstille-commit] r3173 - in trunk/windstille/src: display
	particles scenegraph
Message-ID: <200909011810.n81IAY2L026439@sheep.berlios.de>

Author: grumbel
Date: 2009-09-01 20:10:33 +0200 (Tue, 01 Sep 2009)
New Revision: 3173

Modified:
   trunk/windstille/src/display/compositor.cpp
   trunk/windstille/src/display/drawing_context.cpp
   trunk/windstille/src/particles/deform_drawer.cpp
   trunk/windstille/src/particles/spark_drawer.cpp
   trunk/windstille/src/particles/surface_drawer.cpp
   trunk/windstille/src/scenegraph/control_drawable.hpp
   trunk/windstille/src/scenegraph/drawable.hpp
   trunk/windstille/src/scenegraph/fill_screen_drawable.hpp
   trunk/windstille/src/scenegraph/fill_screen_pattern_drawable.hpp
   trunk/windstille/src/scenegraph/navigation_graph_drawable.hpp
   trunk/windstille/src/scenegraph/particle_system_drawable.cpp
   trunk/windstille/src/scenegraph/particle_system_drawable.hpp
   trunk/windstille/src/scenegraph/scene_graph.cpp
   trunk/windstille/src/scenegraph/scene_graph.hpp
   trunk/windstille/src/scenegraph/shockwave_drawable.hpp
   trunk/windstille/src/scenegraph/sprite3d_drawable.hpp
   trunk/windstille/src/scenegraph/surface_drawable.hpp
   trunk/windstille/src/scenegraph/surface_quad_drawable.hpp
   trunk/windstille/src/scenegraph/text_drawable.hpp
   trunk/windstille/src/scenegraph/vertex_array_drawable.cpp
   trunk/windstille/src/scenegraph/vertex_array_drawable.hpp
Log:
Removed prepare() logic from Drawable, functionality will be implemented another way

Modified: trunk/windstille/src/display/compositor.cpp
===================================================================
--- trunk/windstille/src/display/compositor.cpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/display/compositor.cpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -39,12 +39,10 @@
   struct Framebuffers 
   {
     Framebuffer screen;
-    Framebuffer tmp;
     Framebuffer lightmap;   
 
     Framebuffers(const Size& size) 
       : screen  (GL_TEXTURE_RECTANGLE_ARB, size.width, size.height),
-        tmp     (GL_TEXTURE_RECTANGLE_ARB, size.width, size.height),
         lightmap(GL_TEXTURE_RECTANGLE_ARB, size.width / LIGHTMAP_DIV, size.height / LIGHTMAP_DIV)
     {
     }
@@ -136,7 +134,7 @@
     {
       glPushMatrix();
       glMultMatrixf(gc_state.get_matrix().matrix);
-      sg->draw(Texture(), SceneContext::LIGHTMAP);
+      sg->draw(SceneContext::LIGHTMAP);
       glPopMatrix();
     }
 
@@ -156,7 +154,7 @@
     {
       glPushMatrix();
       glMultMatrixf(gc_state.get_matrix().matrix);
-      sg->draw(Texture(), SceneContext::COLORMAP);
+      sg->draw(SceneContext::COLORMAP);
       glPopMatrix();
     }
 
@@ -179,7 +177,7 @@
     {
       glPushMatrix();
       glMultMatrixf(gc_state.get_matrix().matrix);
-      sg->draw(Texture(), SceneContext::HIGHLIGHTMAP);
+      sg->draw(SceneContext::HIGHLIGHTMAP);
       glPopMatrix();
     }
 
@@ -202,10 +200,7 @@
              static_cast<float>(impl->framebuffers->screen.get_width()),
              static_cast<float>(impl->framebuffers->screen.get_height()));
 
-    if (sc.get_render_mask() & SceneContext::BLURMAP)
-      state.bind_texture(impl->framebuffers->screen.get_texture(), 0);
-    else
-      state.bind_texture(impl->framebuffers->tmp.get_texture(), 0);
+    state.bind_texture(impl->framebuffers->screen.get_texture(), 0);
 
     state.activate();
 
@@ -260,7 +255,7 @@
       glTranslatef(0.0f, static_cast<float>(impl->m_size.height) - static_cast<float>(impl->m_size.height/LIGHTMAP_DIV), 0.0f);
       glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f);
       glMultMatrixf(gc_state.get_matrix().matrix);
-      sg->draw(Texture(), SceneContext::LIGHTMAP);
+      sg->draw(SceneContext::LIGHTMAP);
       glPopMatrix();
     }
 
@@ -291,7 +286,7 @@
     {
       glPushMatrix();
       glMultMatrixf(gc_state.get_matrix().matrix);
-      sg->draw(Texture(), SceneContext::COLORMAP);
+      sg->draw(SceneContext::COLORMAP);
       glPopMatrix();
     }
   }
@@ -334,7 +329,7 @@
     {
       glPushMatrix();
       glMultMatrixf(gc_state.get_matrix().matrix);
-      sg->draw(Texture(), SceneContext::HIGHLIGHTMAP);
+      sg->draw(SceneContext::HIGHLIGHTMAP);
       glPopMatrix();
     }
   }
@@ -365,19 +360,15 @@
 void
 Compositor::eval(Drawable* request)
 {
-  if (impl->framebuffers && request->needs_prepare())
-    {
-      Display::push_framebuffer(impl->framebuffers->tmp);
-      request->prepare(impl->framebuffers->screen.get_texture());
-      Display::pop_framebuffer();
-      
+  if (impl->framebuffers)
+    {    
       Display::push_framebuffer(impl->framebuffers->screen);
-      request->draw(impl->framebuffers->tmp.get_texture());
+      request->draw();
       Display::pop_framebuffer();
     }
   else
     {
-      request->draw(Texture());
+      request->draw();
     }
 }
 

Modified: trunk/windstille/src/display/drawing_context.cpp
===================================================================
--- trunk/windstille/src/display/drawing_context.cpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/display/drawing_context.cpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -102,14 +102,14 @@
                      const DrawingParameters& params, float z_pos)
 {
   draw(new SurfaceQuadDrawable(surface, pos, quad, params, z_pos,
-                                     modelview_stack.back()));
+                               modelview_stack.back()));
 }
 
 void
 DrawingContext::draw(const Surface surface, const SurfaceDrawingParameters& params, float z_pos)
 {
   draw(new SurfaceDrawable(surface, params, z_pos,
-                                 modelview_stack.back()));
+                           modelview_stack.back()));
 }
 
 void

Modified: trunk/windstille/src/particles/deform_drawer.cpp
===================================================================
--- trunk/windstille/src/particles/deform_drawer.cpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/particles/deform_drawer.cpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -43,8 +43,9 @@
   
   virtual ~DeformDrawerRequest() {}
   
-  void draw(const Texture& tmp_texture) 
+  void draw()
   {
+#if 0
     Display::push_framebuffer(framebuffer);
     glClear(GL_COLOR_BUFFER_BIT);
     draw_particles();
@@ -78,6 +79,7 @@
 
       glUseProgramObjectARB(0);
     }
+#endif
   }
 
   void draw_particles()

Modified: trunk/windstille/src/particles/spark_drawer.cpp
===================================================================
--- trunk/windstille/src/particles/spark_drawer.cpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/particles/spark_drawer.cpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -82,7 +82,7 @@
         }
     }
 
-  buffer->draw(Texture());
+  buffer->draw();
 }
 
 /* EOF */

Modified: trunk/windstille/src/particles/surface_drawer.cpp
===================================================================
--- trunk/windstille/src/particles/surface_drawer.cpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/particles/surface_drawer.cpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -160,7 +160,7 @@
         }
     }
 
-  buffer->draw(Texture());
+  buffer->draw();
 }
 
 /* EOF */

Modified: trunk/windstille/src/scenegraph/control_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/control_drawable.hpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/control_drawable.hpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -35,7 +35,7 @@
 
   virtual ~ControlDrawable() {}
 
-  void draw(const Texture& /*tmp_texture*/)
+  void draw()
   {
     glPushMatrix();
 

Modified: trunk/windstille/src/scenegraph/drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/drawable.hpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/drawable.hpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -44,27 +44,9 @@
   /**
    * The draw() method does the important work in Drawable,
    * ie. it is the place where you can access the screen with raw
-   * OpenGL methods. The \a tmp_texture provides a texture of the
-   * current framebuffer, you have to copy the \a screen_texture to it
-   * to contain usefull content
+   * OpenGL methods. 
    */
-  virtual void draw(const Texture& tmp_texture) = 0;
-
-  /**
-   * This method is called before draw() to allow the Drawable
-   * to copy content from \a screen_texture, which is the current
-   * framebuffer to a temporary buffer which can then be used in
-   * draw() for deformation effects
-   */
-  virtual void prepare(const Texture& screen_texture) {
-      (void) screen_texture;
-  }
-
-  /**
-   * Override this and let it return true if you need to prepare()
-   * function call
-   */
-  virtual bool needs_prepare() { return false; }
+  virtual void draw() = 0;
   
   /** Returns the position at which the request should be drawn */
   float get_z_pos() const { return z_pos; }

Modified: trunk/windstille/src/scenegraph/fill_screen_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/fill_screen_drawable.hpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/fill_screen_drawable.hpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -31,7 +31,8 @@
   }
   virtual ~FillScreenDrawable() {}
 
-  void draw(const Texture& /*tmp_texture*/) {
+  void draw()
+  {
     OpenGLState state;
     // FIXME: move clear color to opengl_state
     state.activate();

Modified: trunk/windstille/src/scenegraph/fill_screen_pattern_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/fill_screen_pattern_drawable.hpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/fill_screen_pattern_drawable.hpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -42,7 +42,7 @@
     m_offset = offset;
   }
 
-  void draw(const Texture& /*tmp_texture*/) 
+  void draw() 
   {
     OpenGLState state;
     state.enable(GL_BLEND);

Modified: trunk/windstille/src/scenegraph/navigation_graph_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/navigation_graph_drawable.hpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/navigation_graph_drawable.hpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -35,7 +35,7 @@
       m_navgraph(navgraph)
   {}
 
-  void draw(const Texture& /*tmp_texture*/)
+  void draw()
   {
     //Display::fill_rect(Rectf(-100, -100, 100, 1000), Color(1.0f, 0.0f, 0.0f));
 

Modified: trunk/windstille/src/scenegraph/particle_system_drawable.cpp
===================================================================
--- trunk/windstille/src/scenegraph/particle_system_drawable.cpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/particle_system_drawable.cpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -28,7 +28,7 @@
 }
 
 void
-ParticleSystemDrawable::draw(const Texture& /*tmp_texture*/)
+ParticleSystemDrawable::draw()
 {
   m_particle_system.draw();
 }

Modified: trunk/windstille/src/scenegraph/particle_system_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/particle_system_drawable.hpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/particle_system_drawable.hpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -31,7 +31,7 @@
 public:
   ParticleSystemDrawable(const ParticleSystem& particle_system);
 
-  void draw(const Texture& tmp_texture);
+  void draw();
 
 private:
   ParticleSystemDrawable(const ParticleSystemDrawable&);

Modified: trunk/windstille/src/scenegraph/scene_graph.cpp
===================================================================
--- trunk/windstille/src/scenegraph/scene_graph.cpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/scene_graph.cpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -38,12 +38,12 @@
 }
 
 void
-SceneGraph::draw(const Texture& tmp_texture, unsigned int mask)
+SceneGraph::draw(unsigned int mask)
 {
   for(Drawables::iterator i = m_drawables.begin(); i != m_drawables.end(); ++i)
   {
     if ((*i)->get_render_mask() & mask)
-      (*i)->draw(tmp_texture);
+      (*i)->draw();
   }
 }
 

Modified: trunk/windstille/src/scenegraph/scene_graph.hpp
===================================================================
--- trunk/windstille/src/scenegraph/scene_graph.hpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/scene_graph.hpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -37,7 +37,7 @@
   void add_drawable(boost::shared_ptr<Drawable> drawable);
   void remove_drawable(boost::shared_ptr<Drawable> drawable);
 
-  void draw(const Texture& tmp_texture, unsigned int mask);
+  void draw(unsigned int mask);
 
 private:
   SceneGraph(const SceneGraph&);

Modified: trunk/windstille/src/scenegraph/shockwave_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/shockwave_drawable.hpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/shockwave_drawable.hpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -44,11 +44,7 @@
   {
   }
 
-  bool  needs_prepare()
-  {
-    return true; 
-  }
-    
+#if 0
   void prepare(const Texture& screen_texture)
   {
     // FIXME: Clear stuff is only for debugging
@@ -123,9 +119,11 @@
 
     glPopMatrix();
   }
+#endif
 
-  void draw(const Texture& tmp_texture)
+  void draw()
   {
+#if 0
     glPushMatrix();
     glMultMatrixf(modelview.matrix);
     glTranslatef(pos.x, pos.y, 0);
@@ -170,6 +168,7 @@
         glUseProgramObjectARB(0);
       }
     glPopMatrix();
+#endif
   }
 
   void draw_disc(int count)

Modified: trunk/windstille/src/scenegraph/sprite3d_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/sprite3d_drawable.hpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/sprite3d_drawable.hpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -36,7 +36,7 @@
       m_scale(1.0f)
   {}
 
-  void draw(const Texture& /*tmp_texture*/)
+  void draw()
   {
     Matrix matrix = modelview;
     matrix = matrix.translate(pos.x, pos.y, z_pos);

Modified: trunk/windstille/src/scenegraph/surface_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/surface_drawable.hpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/surface_drawable.hpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -43,7 +43,7 @@
   Surface get_surface() const { return surface; }
   SurfaceDrawingParameters& get_params() { return params; }
 
-  void draw(const Texture& /*tmp_texture*/) 
+  void draw()
   {
     glPushMatrix();
     glMultMatrixf(modelview.matrix);

Modified: trunk/windstille/src/scenegraph/surface_quad_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/surface_quad_drawable.hpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/surface_quad_drawable.hpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -41,7 +41,7 @@
   {
   }
 
-  void draw(const Texture& /*tmp_texture*/) 
+  void draw() 
   {
     OpenGLState state;
     state.enable(GL_BLEND);

Modified: trunk/windstille/src/scenegraph/text_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/text_drawable.hpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/text_drawable.hpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -30,7 +30,7 @@
   {}
   virtual ~TextDrawable() {}
 
-  void draw(const Texture& /*tmp_texture*/) {
+  void draw() {
     glPushMatrix();
     glMultMatrixf(modelview.matrix);
     Fonts::current()->ttffont->draw(pos, text);

Modified: trunk/windstille/src/scenegraph/vertex_array_drawable.cpp
===================================================================
--- trunk/windstille/src/scenegraph/vertex_array_drawable.cpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/vertex_array_drawable.cpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -47,7 +47,7 @@
 }
 
 void
-VertexArrayDrawable::draw(const Texture& /*tmp_texture*/)
+VertexArrayDrawable::draw()
 {
   draw(0, num_vertices());
 }

Modified: trunk/windstille/src/scenegraph/vertex_array_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/vertex_array_drawable.hpp	2009-09-01 16:20:19 UTC (rev 3172)
+++ trunk/windstille/src/scenegraph/vertex_array_drawable.hpp	2009-09-01 18:10:33 UTC (rev 3173)
@@ -41,7 +41,7 @@
 public:
   VertexArrayDrawable(const Vector2f& pos_, float z_pos_, const Matrix& modelview_);
 
-  void draw(const Texture& tmp_texture);
+  void draw();
   void draw(int start, int end);
 
   void vertex(float x, float y, float z = 0.0f);



From grumbel at mail.berlios.de  Wed Sep  2 00:19:02 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 2 Sep 2009 00:19:02 +0200
Subject: [Windstille-commit] r3174 - trunk/windstille/src/util
Message-ID: <200909012219.n81MJ2Bp029069@sheep.berlios.de>

Author: grumbel
Date: 2009-09-02 00:19:01 +0200 (Wed, 02 Sep 2009)
New Revision: 3174

Added:
   trunk/windstille/src/util/directory.cpp
   trunk/windstille/src/util/directory.hpp
Log:
Added Directory class

Added: trunk/windstille/src/util/directory.cpp
===================================================================
--- trunk/windstille/src/util/directory.cpp	2009-09-01 18:10:33 UTC (rev 3173)
+++ trunk/windstille/src/util/directory.cpp	2009-09-01 22:19:01 UTC (rev 3174)
@@ -0,0 +1,97 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "util/directory.hpp"
+
+#include <boost/filesystem.hpp>
+
+#include "util/util.hpp"
+#include "util/pathname.hpp"
+
+Directory::List
+Directory::read(const Pathname& pathname)
+{
+  std::vector<Pathname> entries;
+  
+  for (boost::filesystem::directory_iterator it(pathname.get_sys_path());
+       it != boost::filesystem::directory_iterator();
+       ++it)
+  {
+    // FIXME: Would make sense to try to keep the Pathname::type
+    // intact, instead of converting everything to system path
+    entries.push_back(Pathname(it->path().string(), Pathname::kSysPath));
+  }
+
+  return entries;
+}
+
+Directory::List
+Directory::read(const Pathname& pathname, const std::string& suffix)
+{
+  std::vector<Pathname> entries;
+  
+  for (boost::filesystem::directory_iterator it(pathname.get_sys_path());
+       it != boost::filesystem::directory_iterator();
+       ++it)
+  {
+    // FIXME: Would make sense to try to keep the Pathname::type
+    // intact, instead of converting everything to system path
+    const std::string& filename = it->path().string();
+    if (has_suffix(filename, suffix))
+    {
+      entries.push_back(Pathname(filename, Pathname::kSysPath));
+    }
+  }
+
+  return entries;  
+}
+
+#ifdef __TEST__
+#include <iostream>
+
+int main(int argc, char** argv)
+{
+  if (argc == 2)
+  {
+    Pathname directory_name(argv[1], Pathname::kSysPath);
+    std::cout << "Directory: " << directory_name << std::endl;
+    const Directory::List& directory = Directory::read(directory_name);
+    for(Directory::List::const_iterator p = directory.begin(); p != directory.end(); ++p)
+    {
+      std::cout << "  Entry: " << *p << std::endl;
+    }
+  }
+  else if (argc == 3)
+  {
+    Pathname directory_name(argv[1], Pathname::kSysPath);
+    std::cout << "Directory: " << directory_name << std::endl;
+    const Directory::List& directory = Directory::read(directory_name, argv[2]);
+    for(Directory::List::const_iterator p = directory.begin(); p != directory.end(); ++p)
+    {
+      std::cout << "  Entry: " << *p << std::endl;
+    }
+  }
+  else
+  {
+    std::cout << "Usage: " << argv[0] << " DIRECTORY [PATTERN]" << std::endl;
+  }
+}
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/util/directory.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/util/directory.hpp
===================================================================
--- trunk/windstille/src/util/directory.hpp	2009-09-01 18:10:33 UTC (rev 3173)
+++ trunk/windstille/src/util/directory.hpp	2009-09-01 22:19:01 UTC (rev 3174)
@@ -0,0 +1,49 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_UTIL_DIRECTORY_HPP
+#define HEADER_WINDSTILLE_UTIL_DIRECTORY_HPP
+
+#include <vector>
+#include <string>
+
+class Pathname;
+
+class Directory
+{
+public:
+  typedef std::vector<Pathname> List;
+
+  /** Read the given directory and return the file entries */
+  static List read(const Pathname& pathname);
+
+  /**
+   *  Read the given directory and return the file entries, only
+   *  entries having the suffix \a suffix will be included in the
+   *  result 
+   */
+  static List read(const Pathname& pathname, const std::string& suffix);
+
+private:
+  Directory(const Directory&);
+  Directory& operator=(const Directory&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/util/directory.hpp
___________________________________________________________________
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Wed Sep  2 00:23:50 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 2 Sep 2009 00:23:50 +0200
Subject: [Windstille-commit] r3175 - trunk/windstille/src/app
Message-ID: <200909012223.n81MNoig029396@sheep.berlios.de>

Author: grumbel
Date: 2009-09-02 00:23:49 +0200 (Wed, 02 Sep 2009)
New Revision: 3175

Modified:
   trunk/windstille/src/app/menu_manager.cpp
Log:
Added new sectors to the select menu

Modified: trunk/windstille/src/app/menu_manager.cpp
===================================================================
--- trunk/windstille/src/app/menu_manager.cpp	2009-09-01 22:19:01 UTC (rev 3174)
+++ trunk/windstille/src/app/menu_manager.cpp	2009-09-01 22:23:49 UTC (rev 3175)
@@ -37,6 +37,7 @@
 #include "screen/screen_manager.hpp"
 #include "screen/sprite3dview.hpp"
 #include "sound/sound_manager.hpp"
+#include "util/directory.hpp"
 #ifdef HAVE_CWIID
 #  include "input/wiimote.hpp"
 #endif
@@ -205,7 +206,7 @@
 {
   gui::Menu menu("Select Scenario", create_centered_rect(500, 340));
 
-  std::vector<Pathname> scenarios;
+  std::vector<Pathname> scenarios = Directory::read(Pathname("sectors/trainstation/"), ".wst");
   scenarios.push_back(Pathname("sectors/apartment/apartment.wst"));
   scenarios.push_back(Pathname("sectors/bluestone/bluestone.wst"));
   scenarios.push_back(Pathname("sectors/forest/forest.wst"));



From grumbel at mail.berlios.de  Wed Sep  2 00:53:19 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 2 Sep 2009 00:53:19 +0200
Subject: [Windstille-commit] r3176 - trunk/windstille/src/display
Message-ID: <200909012253.n81MrJ4D021154@sheep.berlios.de>

Author: grumbel
Date: 2009-09-02 00:53:18 +0200 (Wed, 02 Sep 2009)
New Revision: 3176

Modified:
   trunk/windstille/src/display/compositor.cpp
   trunk/windstille/src/display/compositor.hpp
   trunk/windstille/src/display/drawing_context.cpp
Log:
Fixed bug in Compositor that caused ambient-light to stop functioning

Modified: trunk/windstille/src/display/compositor.cpp
===================================================================
--- trunk/windstille/src/display/compositor.cpp	2009-09-01 22:23:49 UTC (rev 3175)
+++ trunk/windstille/src/display/compositor.cpp	2009-09-01 22:53:18 UTC (rev 3176)
@@ -120,9 +120,10 @@
       
   if (sc.get_render_mask() & SceneContext::LIGHTMAPSCREEN)
   {
-    // Render the lightmap to the framebuffers->lightmap
+    // Render the lightmap to framebuffers->lightmap
     Display::push_framebuffer(impl->framebuffers->lightmap);
-      
+
+    glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
     glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
 
     glPushMatrix();
@@ -145,8 +146,9 @@
 
   if (sc.get_render_mask() & SceneContext::COLORMAP)
   {
-    // Render the colormap to the framebuffers->screen
+    // Render the colormap to framebuffers->screen
     Display::push_framebuffer(impl->framebuffers->screen);
+    glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
     glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
     sc.color().render(*this);
 
@@ -277,7 +279,7 @@
   if (sc.get_render_mask() & SceneContext::COLORMAP)
   {
     // Render the colormap to the framebuffers->screen
-    glClearColor(0.0f, 0.0f, 0.0f, 0.0f);
+    glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
     glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
 
     sc.color().render(*this);
@@ -357,19 +359,4 @@
   }
 }
 
-void
-Compositor::eval(Drawable* request)
-{
-  if (impl->framebuffers)
-    {    
-      Display::push_framebuffer(impl->framebuffers->screen);
-      request->draw();
-      Display::pop_framebuffer();
-    }
-  else
-    {
-      request->draw();
-    }
-}
-
 /* EOF */

Modified: trunk/windstille/src/display/compositor.hpp
===================================================================
--- trunk/windstille/src/display/compositor.hpp	2009-09-01 22:23:49 UTC (rev 3175)
+++ trunk/windstille/src/display/compositor.hpp	2009-09-01 22:53:18 UTC (rev 3176)
@@ -35,7 +35,6 @@
   ~Compositor();
 
   void render(SceneContext& sc, SceneGraph* sg, const GraphicContextState& state);
-  void eval(Drawable* request);
 
 private:
   void render_with_framebuffers(SceneContext& sc, SceneGraph* sg,

Modified: trunk/windstille/src/display/drawing_context.cpp
===================================================================
--- trunk/windstille/src/display/drawing_context.cpp	2009-09-01 22:23:49 UTC (rev 3175)
+++ trunk/windstille/src/display/drawing_context.cpp	2009-09-01 22:53:18 UTC (rev 3176)
@@ -28,6 +28,7 @@
 #include "display/surface_drawing_parameters.hpp"
 #include "font/fonts.hpp"
 #include "math/vector3.hpp"
+#include "math/line.hpp"
 #include "sprite2d/sprite.hpp"
 
 #include "scenegraph/control_drawable.hpp"
@@ -59,13 +60,13 @@
 }
 
 void
-DrawingContext::render(Compositor& comp)
+DrawingContext::render(Compositor& /*comp*/)
 {
   std::stable_sort(drawingrequests.begin(), drawingrequests.end(), DrawablesSorter());
   
   for(Drawables::iterator i = drawingrequests.begin(); i != drawingrequests.end(); ++i)
     {
-      comp.eval(*i);
+      (*i)->draw();
     }
 }
 



From grumbel at mail.berlios.de  Wed Sep  2 00:53:58 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 2 Sep 2009 00:53:58 +0200
Subject: [Windstille-commit] r3177 - trunk/windstille/src/display
Message-ID: <200909012253.n81MrwqY022135@sheep.berlios.de>

Author: grumbel
Date: 2009-09-02 00:53:57 +0200 (Wed, 02 Sep 2009)
New Revision: 3177

Added:
   trunk/windstille/src/display/color.cpp
Modified:
   trunk/windstille/src/display/color.hpp
Log:
Added operator<<()

Added: trunk/windstille/src/display/color.cpp
===================================================================
--- trunk/windstille/src/display/color.cpp	2009-09-01 22:53:18 UTC (rev 3176)
+++ trunk/windstille/src/display/color.cpp	2009-09-01 22:53:57 UTC (rev 3177)
@@ -0,0 +1,33 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "display/color.hpp"
+
+#include <ostream>
+
+std::ostream& operator<<(std::ostream& out, const Color& color)
+{
+  return out << "Color("
+             << color.r << ", "
+             << color.g << ", "
+             << color.b << ", "
+             << color.a
+             << ")";
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/display/color.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/display/color.hpp
===================================================================
--- trunk/windstille/src/display/color.hpp	2009-09-01 22:53:18 UTC (rev 3176)
+++ trunk/windstille/src/display/color.hpp	2009-09-01 22:53:57 UTC (rev 3177)
@@ -19,6 +19,8 @@
 #ifndef HEADER_WINDSTILLE_DISPLAY_COLOR_HPP
 #define HEADER_WINDSTILLE_DISPLAY_COLOR_HPP
 
+#include <iosfwd>
+
 class Color
 {
 public:
@@ -32,6 +34,8 @@
   float r, g, b, a;
 };
 
+std::ostream& operator<<(std::ostream& out, const Color& color);
+
 #endif
 
 /* EOF */



From grumbel at mail.berlios.de  Wed Sep  2 00:54:44 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 2 Sep 2009 00:54:44 +0200
Subject: [Windstille-commit] r3178 - trunk/windstille/src/scenegraph
Message-ID: <200909012254.n81MsiWB022755@sheep.berlios.de>

Author: grumbel
Date: 2009-09-02 00:54:44 +0200 (Wed, 02 Sep 2009)
New Revision: 3178

Modified:
   trunk/windstille/src/scenegraph/fill_screen_drawable.hpp
Log:
Cleanup

Modified: trunk/windstille/src/scenegraph/fill_screen_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/fill_screen_drawable.hpp	2009-09-01 22:53:57 UTC (rev 3177)
+++ trunk/windstille/src/scenegraph/fill_screen_drawable.hpp	2009-09-01 22:54:44 UTC (rev 3178)
@@ -33,9 +33,6 @@
 
   void draw()
   {
-    OpenGLState state;
-    // FIXME: move clear color to opengl_state
-    state.activate();
     glClearColor(color.r, color.g, color.b, color.a);
     glClear(GL_COLOR_BUFFER_BIT);
   }



From grumbel at mail.berlios.de  Wed Sep  2 00:55:00 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 2 Sep 2009 00:55:00 +0200
Subject: [Windstille-commit] r3179 - in trunk/windstille/src: armature
	display engine gui hud navigation screen
Message-ID: <200909012255.n81Mt0Du023001@sheep.berlios.de>

Author: grumbel
Date: 2009-09-02 00:54:57 +0200 (Wed, 02 Sep 2009)
New Revision: 3179

Modified:
   trunk/windstille/src/armature/armature.cpp
   trunk/windstille/src/display/display.cpp
   trunk/windstille/src/display/display.hpp
   trunk/windstille/src/engine/sector.cpp
   trunk/windstille/src/gui/grid_component.cpp
   trunk/windstille/src/gui/slider.cpp
   trunk/windstille/src/hud/controller_help_window.cpp
   trunk/windstille/src/navigation/edge_position.cpp
   trunk/windstille/src/navigation/navigation_graph.cpp
   trunk/windstille/src/screen/geometry_test.cpp
   trunk/windstille/src/screen/navigation_test.cpp
   trunk/windstille/src/screen/navigation_test.hpp
Log:
include cleanup

Modified: trunk/windstille/src/armature/armature.cpp
===================================================================
--- trunk/windstille/src/armature/armature.cpp	2009-09-01 22:54:44 UTC (rev 3178)
+++ trunk/windstille/src/armature/armature.cpp	2009-09-01 22:54:57 UTC (rev 3179)
@@ -23,6 +23,7 @@
 
 #include "display/opengl_state.hpp"
 #include "display/display.hpp"
+#include "display/color.hpp"
 #include "armature/pose.hpp"
 
 Armature::Armature(FileReader& reader)

Modified: trunk/windstille/src/display/display.cpp
===================================================================
--- trunk/windstille/src/display/display.cpp	2009-09-01 22:54:44 UTC (rev 3178)
+++ trunk/windstille/src/display/display.cpp	2009-09-01 22:54:57 UTC (rev 3179)
@@ -23,6 +23,9 @@
 #include <errno.h>
 #include <fstream>
 
+#include "display/color.hpp"
+#include "math/quad.hpp"
+#include "math/line.hpp"
 #include "display/opengl_state.hpp"
 
 Size              Display::aspect_size;

Modified: trunk/windstille/src/display/display.hpp
===================================================================
--- trunk/windstille/src/display/display.hpp	2009-09-01 22:54:44 UTC (rev 3178)
+++ trunk/windstille/src/display/display.hpp	2009-09-01 22:54:57 UTC (rev 3179)
@@ -21,13 +21,15 @@
 
 #include <vector>
 
-#include "math/quad.hpp"
-#include "math/line.hpp"
 #include "math/size.hpp"
-#include "display/color.hpp"
 #include "display/framebuffer.hpp"
 
 class Pathname;
+class Color;
+class Quad;
+class Vector2f;
+class Rectf;
+class Line;
 
 class Display
 {

Modified: trunk/windstille/src/engine/sector.cpp
===================================================================
--- trunk/windstille/src/engine/sector.cpp	2009-09-01 22:54:44 UTC (rev 3178)
+++ trunk/windstille/src/engine/sector.cpp	2009-09-01 22:54:57 UTC (rev 3179)
@@ -303,8 +303,6 @@
       if ((*i)->is_active())
         (*i)->draw(sc);
     }
-
-  //sc.color().draw(new SceneGraphDrawable(*scene_graph, sc.color().get_modelview()));
 }
 
 void Sector::commit_adds()

Modified: trunk/windstille/src/gui/grid_component.cpp
===================================================================
--- trunk/windstille/src/gui/grid_component.cpp	2009-09-01 22:54:44 UTC (rev 3178)
+++ trunk/windstille/src/gui/grid_component.cpp	2009-09-01 22:54:57 UTC (rev 3179)
@@ -17,6 +17,7 @@
 */
 
 #include "display/display.hpp"
+#include "display/color.hpp"
 #include "input/controller.hpp"
 #include "gui/grid_component.hpp"
 

Modified: trunk/windstille/src/gui/slider.cpp
===================================================================
--- trunk/windstille/src/gui/slider.cpp	2009-09-01 22:54:44 UTC (rev 3178)
+++ trunk/windstille/src/gui/slider.cpp	2009-09-01 22:54:57 UTC (rev 3179)
@@ -18,6 +18,7 @@
 
 #include "input/controller.hpp"
 #include "display/display.hpp"
+#include "display/color.hpp"
 #include "gui/slider.hpp"
 
 namespace gui {

Modified: trunk/windstille/src/hud/controller_help_window.cpp
===================================================================
--- trunk/windstille/src/hud/controller_help_window.cpp	2009-09-01 22:54:44 UTC (rev 3178)
+++ trunk/windstille/src/hud/controller_help_window.cpp	2009-09-01 22:54:57 UTC (rev 3179)
@@ -17,7 +17,9 @@
 */
 
 #include "input/input_manager_sdl.hpp"
+#include "math/rect.hpp"
 #include "display/display.hpp"
+#include "display/color.hpp"
 #include "hud/controller_help_window.hpp"
 
 ControllerHelpWindow::ControllerHelpWindow()

Modified: trunk/windstille/src/navigation/edge_position.cpp
===================================================================
--- trunk/windstille/src/navigation/edge_position.cpp	2009-09-01 22:54:44 UTC (rev 3178)
+++ trunk/windstille/src/navigation/edge_position.cpp	2009-09-01 22:54:57 UTC (rev 3179)
@@ -16,6 +16,10 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
+#include "navigation/edge_position.hpp"
+
+#include <math.h>
+
 #include "navigation/edge.hpp"
 #include "navigation/node.hpp"
 #include "display/display.hpp"

Modified: trunk/windstille/src/navigation/navigation_graph.cpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.cpp	2009-09-01 22:54:44 UTC (rev 3178)
+++ trunk/windstille/src/navigation/navigation_graph.cpp	2009-09-01 22:54:57 UTC (rev 3179)
@@ -19,6 +19,8 @@
 #include <iomanip>
 
 #include "display/display.hpp"
+#include "display/color.hpp"
+#include "math/rect.hpp"
 #include "navigation/edge.hpp"
 #include "navigation/node.hpp"
 #include "util/file_reader.hpp"

Modified: trunk/windstille/src/screen/geometry_test.cpp
===================================================================
--- trunk/windstille/src/screen/geometry_test.cpp	2009-09-01 22:54:44 UTC (rev 3178)
+++ trunk/windstille/src/screen/geometry_test.cpp	2009-09-01 22:54:57 UTC (rev 3179)
@@ -16,13 +16,15 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
+#include "screen/geometry_test.hpp"
+
 #include <GL/glew.h>
 
-#include "screen/geometry_test.hpp"
 #include "app/console.hpp"
-#include "input/controller.hpp"
 #include "app/menu_manager.hpp"
+#include "display/color.hpp"
 #include "display/display.hpp"
+#include "input/controller.hpp"
 
 GeometryTest::GeometryTest()
   : line1(Vector2f(300, 300),

Modified: trunk/windstille/src/screen/navigation_test.cpp
===================================================================
--- trunk/windstille/src/screen/navigation_test.cpp	2009-09-01 22:54:44 UTC (rev 3178)
+++ trunk/windstille/src/screen/navigation_test.cpp	2009-09-01 22:54:57 UTC (rev 3179)
@@ -16,15 +16,17 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
+#include "screen/navigation_test.hpp"
+
 #include <GL/glew.h>
 
-#include "util/sexpr_file_reader.hpp"
+#include "app/menu_manager.hpp"
+#include "display/color.hpp"
+#include "display/display.hpp"
 #include "input/controller.hpp"
-#include "display/display.hpp"
-#include "app/menu_manager.hpp"
+#include "navigation/edge.hpp"
 #include "navigation/node.hpp"
-#include "navigation/edge.hpp"
-#include "screen/navigation_test.hpp"
+#include "util/sexpr_file_reader.hpp"
 
 NavigationTest::NavigationTest()
   : cursor(400, 300),

Modified: trunk/windstille/src/screen/navigation_test.hpp
===================================================================
--- trunk/windstille/src/screen/navigation_test.hpp	2009-09-01 22:54:44 UTC (rev 3178)
+++ trunk/windstille/src/screen/navigation_test.hpp	2009-09-01 22:54:57 UTC (rev 3179)
@@ -21,6 +21,7 @@
 
 #include <boost/scoped_ptr.hpp>
 
+#include "math/vector2f.hpp"
 #include "navigation/navigation_graph.hpp"
 #include "screen/screen.hpp"
 



From grumbel at mail.berlios.de  Wed Sep  2 02:37:11 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 2 Sep 2009 02:37:11 +0200
Subject: [Windstille-commit] r3180 - trunk/windstille/src/math
Message-ID: <200909020037.n820bBjt027193@sheep.berlios.de>

Author: grumbel
Date: 2009-09-02 02:37:11 +0200 (Wed, 02 Sep 2009)
New Revision: 3180

Added:
   trunk/windstille/src/math/easing.cpp
   trunk/windstille/src/math/easing.hpp
Log:
Added a collection of easing functions

Added: trunk/windstille/src/math/easing.cpp
===================================================================
--- trunk/windstille/src/math/easing.cpp	2009-09-01 22:54:57 UTC (rev 3179)
+++ trunk/windstille/src/math/easing.cpp	2009-09-02 00:37:11 UTC (rev 3180)
@@ -0,0 +1,33 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "math/easing.hpp"
+
+#ifdef __TEST__
+#include <iostream>
+
+int main()
+{
+  std::cout << "Easing Test" << std::endl;
+
+  return 0;
+}
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/math/easing.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/math/easing.hpp
===================================================================
--- trunk/windstille/src/math/easing.hpp	2009-09-01 22:54:57 UTC (rev 3179)
+++ trunk/windstille/src/math/easing.hpp	2009-09-02 00:37:11 UTC (rev 3180)
@@ -0,0 +1,345 @@
+/*
+**  Copyright ? 2001 Robert Penner
+**  All rights reserved.
+**  
+**  Redistribution and use in source and binary forms, with or without
+**  modification, are permitted provided that the following conditions
+**  are met:
+**  
+**  * Redistributions of source code must retain the above copyright
+**    notice, this list of conditions and the following disclaimer.
+**  
+**  * Redistributions in binary form must reproduce the above
+**    copyright notice, this list of conditions and the following
+**    disclaimer in the documentation and/or other materials provided
+**    with the distribution.
+**
+**  * Neither the name of the author nor the names of contributors may
+**    be used to endorse or promote products derived from this
+**    software without specific prior written permission.
+**
+**  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND
+**  CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES,
+**  INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+**  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
+**  DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS
+**  BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
+**  EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+**  TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+**  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
+**  ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
+**  TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF
+**  THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+**  SUCH DAMAGE.
+*/
+
+//  Based on http://www.robertpenner.com/easing/
+//  Ported to C++ by Ingo Ruhnke <grumbel at gmx.de>
+
+#ifndef HEADER_WINDSTILLE_MATH_EASING_HPP
+#define HEADER_WINDSTILLE_MATH_EASING_HPP
+
+#include <math.h>
+
+#include "math/math.hpp"
+
+namespace math {
+namespace easing {
+
+namespace back {
+
+inline float easeIn (float t, float b, float c, float d, float s = 1.70158f)
+{
+  t/=d;
+  return c*t*t*((s+1.0f)*t - s) + b;
+}
+
+inline float easeOut (float t, float b, float c, float d, float s = 1.70158f)
+{
+  t=t/d-1;
+  return c*(t*t*((s+1)*t + s) + 1) + b;
+}
+
+inline float easeInOut (float t, float b, float c, float d, float s = 1.70158f)
+{
+  t/=d/2;
+  s*=1.525f;
+  if (t < 1) return c/2*(t*t*((s+1)*t - s)) + b;
+  s*=1.525f;
+  t-=2;
+  return c/2*(t*t*((s+1)*t + s) + 2) + b;
+}
+
+} // namespace back
+
+namespace bounce {
+
+inline float easeOut (float t, float b, float c, float d) 
+{
+  if ((t/=d) < (1/2.75f)) {
+    return c*(7.5625f*t*t) + b;
+  } else if (t < (2/2.75f)) {
+    t-=1.5f/2.75f;
+    return c*(7.5625f*t*t + .75f) + b;
+  } else if (t < (2.5f/2.75f)) {
+    t-=(2.25f/2.75f);
+    return c*(7.5625f*t*t + .9375f) + b;
+  } else {
+      t-=(2.625f/2.75f);
+      return c*(7.5625f*t*t + .984375f) + b;
+  }
+}
+
+inline float easeIn (float t, float b, float c, float d) 
+{
+  return c - easeOut (d-t, 0, c, d) + b;
+}
+
+inline float easeInOut (float t, float b, float c, float d) 
+{
+  if (t < d/2) return easeIn (t*2, 0, c, d) * .5f + b;
+  else return easeOut (t*2-d, 0, c, d) * .5f + c*.5f + b;
+}
+
+} // namespace bounce
+
+namespace circ {
+
+inline float easeIn (float t, float b, float c, float d) 
+{
+  t/=d;
+  return -c * (sqrtf(1 - t*t) - 1) + b;
+}
+
+inline float easeOut (float t, float b, float c, float d) 
+{
+  t=t/d-1;
+  return c * sqrtf(1 - t*t) + b;
+}
+
+inline float easeInOut (float t, float b, float c, float d) 
+{
+  t/=d/2;
+  if (t < 1) return -c/2 * (sqrtf(1 - t*t) - 1) + b;
+  t-=2;
+  return c/2 * (sqrtf(1 - t*t) + 1) + b;
+}
+
+} // namespace circ {
+
+namespace cubic {
+
+inline float easeIn (float t, float b, float c, float d) 
+{
+  t/=d;
+  return c*t*t*t + b;
+}
+
+inline float easeOut (float t, float b, float c, float d) 
+{
+  t=t/d-1;
+  return c*(t*t*t + 1) + b;
+}
+
+inline float easeInOut (float t, float b, float c, float d) 
+{
+  t/=d/2;
+  if (t < 1) return c/2*t*t*t + b;
+  t-=2;
+  return c/2*(t*t*t + 2) + b;
+}
+
+} // namespace cubic
+
+namespace elastic {
+
+inline float easeIn (float t, float b, float c, float d, float a, float p) 
+{
+  if (t==0) return b; 
+  t/=d;
+  if (t==1) return b+c;
+  if (!p) p=d*0.3f;
+
+  float s;
+
+  if (!a || a < fabsf(c))
+  {
+    a=c; s=p/4; 
+  }
+  else 
+  {
+    s = p/(2*math::pi) * asinf (c/a);
+  }
+
+  t-=1;
+  return -(a*powf(2,10*t) * sinf( (t*d-s)*(2*math::pi)/p)) + b;
+}
+
+inline float easeOut (float t, float b, float c, float d, float a, float p) 
+{
+  if (t==0) return b;  
+  t/=d;
+  if (t==1) return b+c;  if (!p) p=d*.3f;
+  float s;
+  if (!a || a < fabsf(c)) { a=c; s=p/4; }
+  else s = p/(2*math::pi) * asinf (c/a);
+  return (a*powf(2,-10*t) * sinf( (t*d-s)*(2*math::pi)/p ) + c + b);
+}
+
+inline float easeInOut (float t, float b, float c, float d, float a, float p) 
+{
+  if (t==0) return b;  if ((t/=d/2)==2) return b+c;  if (!p) p=d*(.3f*1.5f);
+  float s;
+  if (!a || a < fabsf(c)) { a=c; s=p/4; }
+  else s = p/(2*math::pi) * asinf(c/a);
+  t-=1;
+  if (t < 1) return -.5f*(a*powf(2,10*t) * sinf( (t*d-s)*(2*math::pi)/p )) + b;
+  t-=1;
+  return a*powf(2,-10*t) * sinf( (t*d-s)*(2*math::pi)/p )*.5f + c + b;
+}
+
+} // namespace elastic
+
+namespace expo {
+ 
+inline float easeIn (float t, float b, float c, float d)
+{
+  return (t==0) ? b : c * powf(2, 10 * (t/d - 1)) + b;
+}
+
+inline float easeOut (float t, float b, float c, float d)
+{
+  return (t==d) ? b+c : c * (-powf(2, -10 * t/d) + 1) + b;
+}
+
+inline float easeInOut (float t, float b, float c, float d)
+{
+  if (t==0) return b;
+  if (t==d) return b+c;
+  if ((t/=d/2) < 1) return c/2 * powf(2, 10 * (t - 1)) + b;
+  return c/2 * (-powf(2, -10 * --t) + 2) + b;
+}
+
+} // namespace expo
+
+namespace linear {
+
+inline float easeNone (float t, float b, float c, float d) 
+{
+  return c*t/d + b;
+}
+
+inline float easeIn (float t, float b, float c, float d) 
+{
+  return c*t/d + b;
+}
+
+inline float easeOut (float t, float b, float c, float d) 
+{
+  return c*t/d + b;
+}
+
+inline float easeInOut (float t, float b, float c, float d) 
+{
+  return c*t/d + b;
+}
+
+} // namespace linear
+
+namespace quad {
+
+inline float easeIn (float t, float b, float c, float d) 
+{
+  t/=d;
+  return c*t*t + b;
+}
+
+inline float easeOut (float t, float b, float c, float d) 
+{
+  t/=d;
+  return -c *t*(t-2) + b;
+}
+
+inline float easeInOut (float t, float b, float c, float d) 
+{
+  t/=d/2;
+  if (t < 1) return c/2*t*t + b;
+  --t;
+  return -c/2 * (t*(t-2) - 1) + b;
+}
+
+} // namespace quad
+
+namespace quart {
+
+inline float easeIn (float t, float b, float c, float d) 
+{
+  t /= d;
+  return c*t*t*t*t + b;
+}
+
+inline float easeOut (float t, float b, float c, float d) 
+{
+  t = t/d-1;
+  return -c * (t*t*t*t - 1) + b;
+}
+
+inline float easeInOut (float t, float b, float c, float d)
+{
+  t /= d/2;
+  if (t < 1) return c/2*t*t*t*t + b;
+  t -= 2;
+  return -c/2 * (t*t*t*t - 2) + b;
+}
+
+} // namespace quart
+
+namespace quint {
+
+inline float easeIn (float t, float b, float c, float d)
+{
+  t /= d;
+  return c*t*t*t*t*t + b;
+}
+
+inline float easeOut (float t, float b, float c, float d)
+{
+  t = t/d-1;
+  return c*(t*t*t*t*t + 1) + b;
+}
+
+inline float easeInOut (float t, float b, float c, float d)
+{
+  t /= d/2;
+  if (t < 1) return c/2*t*t*t*t*t + b;
+  t -= 2;
+  return c/2*(t*t*t*t*t + 2) + b;
+}
+
+} // namespace quint
+
+namespace sine {
+
+inline float easeIn (float t, float b, float c, float d) 
+{
+  return -c * cosf(t/d * (math::pi/2)) + c + b;
+}
+
+inline float easeOut (float t, float b, float c, float d) 
+{
+  return c * sinf(t/d * (math::pi/2)) + b;
+}
+
+inline float easeInOut (float t, float b, float c, float d) 
+{
+  return -c/2 * (cosf(math::pi*t/d) - 1) + b;
+}
+
+} // namespace sine
+
+} // namespace easing
+} // namespace math
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/math/easing.hpp
___________________________________________________________________
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Wed Sep  2 03:06:04 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 2 Sep 2009 03:06:04 +0200
Subject: [Windstille-commit] r3181 - trunk/windstille/src/math
Message-ID: <200909020106.n821643x001028@sheep.berlios.de>

Author: grumbel
Date: 2009-09-02 03:06:03 +0200 (Wed, 02 Sep 2009)
New Revision: 3181

Modified:
   trunk/windstille/src/math/easing.cpp
   trunk/windstille/src/math/easing.hpp
Log:
Minor cleanup

Modified: trunk/windstille/src/math/easing.cpp
===================================================================
--- trunk/windstille/src/math/easing.cpp	2009-09-02 00:37:11 UTC (rev 3180)
+++ trunk/windstille/src/math/easing.cpp	2009-09-02 01:06:03 UTC (rev 3181)
@@ -23,7 +23,10 @@
 
 int main()
 {
-  std::cout << "Easing Test" << std::endl;
+  for(float i = 0.0f; i < 1.0f; i += 0.01f)
+  {
+    std::cout << math::easing::circ::ease_in_out(i, 1.0f, 1.0f, 1.0f) << std::endl;
+  }
 
   return 0;
 }

Modified: trunk/windstille/src/math/easing.hpp
===================================================================
--- trunk/windstille/src/math/easing.hpp	2009-09-02 00:37:11 UTC (rev 3180)
+++ trunk/windstille/src/math/easing.hpp	2009-09-02 01:06:03 UTC (rev 3181)
@@ -48,21 +48,21 @@
 
 namespace back {
 
-inline float easeIn (float t, float b, float c, float d, float s = 1.70158f)
+inline float ease_in (float t, float b, float c, float d, float s = 1.70158f)
 {
-  t/=d;
+  t /= d;
   return c*t*t*((s+1.0f)*t - s) + b;
 }
 
-inline float easeOut (float t, float b, float c, float d, float s = 1.70158f)
+inline float ease_out (float t, float b, float c, float d, float s = 1.70158f)
 {
   t=t/d-1;
   return c*(t*t*((s+1)*t + s) + 1) + b;
 }
 
-inline float easeInOut (float t, float b, float c, float d, float s = 1.70158f)
+inline float ease_in_out (float t, float b, float c, float d, float s = 1.70158f)
 {
-  t/=d/2;
+  t /= d/2;
   s*=1.525f;
   if (t < 1) return c/2*(t*t*((s+1)*t - s)) + b;
   s*=1.525f;
@@ -74,52 +74,66 @@
 
 namespace bounce {
 
-inline float easeOut (float t, float b, float c, float d) 
+inline float ease_out (float t, float b, float c, float d) 
 {
-  if ((t/=d) < (1/2.75f)) {
+  t  /=  d;
+  if (t < (1/2.75f)) 
+  {
     return c*(7.5625f*t*t) + b;
-  } else if (t < (2/2.75f)) {
+  }
+  else if (t < (2/2.75f)) 
+  {
     t-=1.5f/2.75f;
     return c*(7.5625f*t*t + .75f) + b;
-  } else if (t < (2.5f/2.75f)) {
+  }
+  else if (t < (2.5f/2.75f)) 
+  {
     t-=(2.25f/2.75f);
     return c*(7.5625f*t*t + .9375f) + b;
-  } else {
-      t-=(2.625f/2.75f);
-      return c*(7.5625f*t*t + .984375f) + b;
+  } 
+  else 
+  {
+    t-=(2.625f/2.75f);
+    return c*(7.5625f*t*t + .984375f) + b;
   }
 }
 
-inline float easeIn (float t, float b, float c, float d) 
+inline float ease_in (float t, float b, float c, float d) 
 {
-  return c - easeOut (d-t, 0, c, d) + b;
+  return c - ease_out (d-t, 0, c, d) + b;
 }
 
-inline float easeInOut (float t, float b, float c, float d) 
+inline float ease_in_out (float t, float b, float c, float d) 
 {
-  if (t < d/2) return easeIn (t*2, 0, c, d) * .5f + b;
-  else return easeOut (t*2-d, 0, c, d) * .5f + c*.5f + b;
+  if (t < d/2) 
+  {
+    return ease_in (t*2, 0, c, d) * .5f + b;
+  }
+  else
+  {
+    return ease_out (t*2-d, 0, c, d) * .5f + c*.5f + b;
+  }
 }
 
 } // namespace bounce
 
 namespace circ {
 
-inline float easeIn (float t, float b, float c, float d) 
+inline float ease_in (float t, float b, float c, float d) 
 {
-  t/=d;
+  t  /=  d;
   return -c * (sqrtf(1 - t*t) - 1) + b;
 }
 
-inline float easeOut (float t, float b, float c, float d) 
+inline float ease_out (float t, float b, float c, float d) 
 {
   t=t/d-1;
   return c * sqrtf(1 - t*t) + b;
 }
 
-inline float easeInOut (float t, float b, float c, float d) 
+inline float ease_in_out (float t, float b, float c, float d) 
 {
-  t/=d/2;
+  t /= d/2;
   if (t < 1) return -c/2 * (sqrtf(1 - t*t) - 1) + b;
   t-=2;
   return c/2 * (sqrtf(1 - t*t) + 1) + b;
@@ -129,21 +143,21 @@
 
 namespace cubic {
 
-inline float easeIn (float t, float b, float c, float d) 
+inline float ease_in (float t, float b, float c, float d) 
 {
-  t/=d;
+  t /= d;
   return c*t*t*t + b;
 }
 
-inline float easeOut (float t, float b, float c, float d) 
+inline float ease_out (float t, float b, float c, float d) 
 {
   t=t/d-1;
   return c*(t*t*t + 1) + b;
 }
 
-inline float easeInOut (float t, float b, float c, float d) 
+inline float ease_in_out (float t, float b, float c, float d) 
 {
-  t/=d/2;
+  t /= d/2;
   if (t < 1) return c/2*t*t*t + b;
   t-=2;
   return c/2*(t*t*t + 2) + b;
@@ -153,10 +167,10 @@
 
 namespace elastic {
 
-inline float easeIn (float t, float b, float c, float d, float a, float p) 
+inline float ease_in (float t, float b, float c, float d, float a, float p) 
 {
   if (t==0) return b; 
-  t/=d;
+  t /= d;
   if (t==1) return b+c;
   if (!p) p=d*0.3f;
 
@@ -175,10 +189,10 @@
   return -(a*powf(2,10*t) * sinf( (t*d-s)*(2*math::pi)/p)) + b;
 }
 
-inline float easeOut (float t, float b, float c, float d, float a, float p) 
+inline float ease_out (float t, float b, float c, float d, float a, float p) 
 {
   if (t==0) return b;  
-  t/=d;
+  t /= d;
   if (t==1) return b+c;  if (!p) p=d*.3f;
   float s;
   if (!a || a < fabsf(c)) { a=c; s=p/4; }
@@ -186,9 +200,10 @@
   return (a*powf(2,-10*t) * sinf( (t*d-s)*(2*math::pi)/p ) + c + b);
 }
 
-inline float easeInOut (float t, float b, float c, float d, float a, float p) 
+inline float ease_in_out (float t, float b, float c, float d, float a, float p) 
 {
-  if (t==0) return b;  if ((t/=d/2)==2) return b+c;  if (!p) p=d*(.3f*1.5f);
+  t/=d/2;
+  if (t==0) return b;  if (t==2) return b+c;  if (!p) p=d*(.3f*1.5f);
   float s;
   if (!a || a < fabsf(c)) { a=c; s=p/4; }
   else s = p/(2*math::pi) * asinf(c/a);
@@ -202,21 +217,22 @@
 
 namespace expo {
  
-inline float easeIn (float t, float b, float c, float d)
+inline float ease_in (float t, float b, float c, float d)
 {
   return (t==0) ? b : c * powf(2, 10 * (t/d - 1)) + b;
 }
 
-inline float easeOut (float t, float b, float c, float d)
+inline float ease_out (float t, float b, float c, float d)
 {
   return (t==d) ? b+c : c * (-powf(2, -10 * t/d) + 1) + b;
 }
 
-inline float easeInOut (float t, float b, float c, float d)
+inline float ease_in_out (float t, float b, float c, float d)
 {
   if (t==0) return b;
   if (t==d) return b+c;
-  if ((t/=d/2) < 1) return c/2 * powf(2, 10 * (t - 1)) + b;
+  t /= d/2;
+  if (t < 1) return c/2 * powf(2, 10 * (t - 1)) + b;
   return c/2 * (-powf(2, -10 * --t) + 2) + b;
 }
 
@@ -229,17 +245,17 @@
   return c*t/d + b;
 }
 
-inline float easeIn (float t, float b, float c, float d) 
+inline float ease_in (float t, float b, float c, float d) 
 {
   return c*t/d + b;
 }
 
-inline float easeOut (float t, float b, float c, float d) 
+inline float ease_out (float t, float b, float c, float d) 
 {
   return c*t/d + b;
 }
 
-inline float easeInOut (float t, float b, float c, float d) 
+inline float ease_in_out (float t, float b, float c, float d) 
 {
   return c*t/d + b;
 }
@@ -248,19 +264,19 @@
 
 namespace quad {
 
-inline float easeIn (float t, float b, float c, float d) 
+inline float ease_in (float t, float b, float c, float d) 
 {
   t/=d;
   return c*t*t + b;
 }
 
-inline float easeOut (float t, float b, float c, float d) 
+inline float ease_out (float t, float b, float c, float d) 
 {
   t/=d;
   return -c *t*(t-2) + b;
 }
 
-inline float easeInOut (float t, float b, float c, float d) 
+inline float ease_in_out (float t, float b, float c, float d) 
 {
   t/=d/2;
   if (t < 1) return c/2*t*t + b;
@@ -272,19 +288,19 @@
 
 namespace quart {
 
-inline float easeIn (float t, float b, float c, float d) 
+inline float ease_in (float t, float b, float c, float d) 
 {
   t /= d;
   return c*t*t*t*t + b;
 }
 
-inline float easeOut (float t, float b, float c, float d) 
+inline float ease_out (float t, float b, float c, float d) 
 {
   t = t/d-1;
   return -c * (t*t*t*t - 1) + b;
 }
 
-inline float easeInOut (float t, float b, float c, float d)
+inline float ease_in_out (float t, float b, float c, float d)
 {
   t /= d/2;
   if (t < 1) return c/2*t*t*t*t + b;
@@ -296,19 +312,19 @@
 
 namespace quint {
 
-inline float easeIn (float t, float b, float c, float d)
+inline float ease_in (float t, float b, float c, float d)
 {
   t /= d;
   return c*t*t*t*t*t + b;
 }
 
-inline float easeOut (float t, float b, float c, float d)
+inline float ease_out (float t, float b, float c, float d)
 {
   t = t/d-1;
   return c*(t*t*t*t*t + 1) + b;
 }
 
-inline float easeInOut (float t, float b, float c, float d)
+inline float ease_in_out (float t, float b, float c, float d)
 {
   t /= d/2;
   if (t < 1) return c/2*t*t*t*t*t + b;
@@ -320,17 +336,17 @@
 
 namespace sine {
 
-inline float easeIn (float t, float b, float c, float d) 
+inline float ease_in (float t, float b, float c, float d) 
 {
   return -c * cosf(t/d * (math::pi/2)) + c + b;
 }
 
-inline float easeOut (float t, float b, float c, float d) 
+inline float ease_out (float t, float b, float c, float d) 
 {
   return c * sinf(t/d * (math::pi/2)) + b;
 }
 
-inline float easeInOut (float t, float b, float c, float d) 
+inline float ease_in_out (float t, float b, float c, float d) 
 {
   return -c/2 * (cosf(math::pi*t/d) - 1) + b;
 }



From grumbel at mail.berlios.de  Wed Sep  2 16:31:54 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 2 Sep 2009 16:31:54 +0200
Subject: [Windstille-commit] r3182 - trunk/windstille/src/math
Message-ID: <200909021431.n82EVsU5004631@sheep.berlios.de>

Author: grumbel
Date: 2009-09-02 16:31:54 +0200 (Wed, 02 Sep 2009)
New Revision: 3182

Modified:
   trunk/windstille/src/math/easing.hpp
Log:
Some cleanup

Modified: trunk/windstille/src/math/easing.hpp
===================================================================
--- trunk/windstille/src/math/easing.hpp	2009-09-02 01:06:03 UTC (rev 3181)
+++ trunk/windstille/src/math/easing.hpp	2009-09-02 14:31:54 UTC (rev 3182)
@@ -48,33 +48,41 @@
 
 namespace back {
 
-inline float ease_in (float t, float b, float c, float d, float s = 1.70158f)
+inline float ease_in(float t, float b, float c, float d, float s = 1.70158f)
 {
-  t /= d;
-  return c*t*t*((s+1.0f)*t - s) + b;
+  t = (t / d);
+  return c*t*t*((s + 1.0f) * t - s) + b;
 }
 
-inline float ease_out (float t, float b, float c, float d, float s = 1.70158f)
+inline float ease_out(float t, float b, float c, float d, float s = 1.70158f)
 {
-  t=t/d-1;
-  return c*(t*t*((s+1)*t + s) + 1) + b;
+  t = (t / d) - 1;
+  return c*(t*t*((s + 1.0f) * t + s) + 1) + b;
 }
 
-inline float ease_in_out (float t, float b, float c, float d, float s = 1.70158f)
+inline float ease_in_out(float t, float b, float c, float d, float s = 1.70158f)
 {
-  t /= d/2;
-  s*=1.525f;
-  if (t < 1) return c/2*(t*t*((s+1)*t - s)) + b;
-  s*=1.525f;
-  t-=2;
-  return c/2*(t*t*((s+1)*t + s) + 2) + b;
+  t = (t / d) / 2;
+
+  s *= 1.525f;
+
+  if (t < 1)
+  {
+    return c/2*(t*t*((s+1)*t - s)) + b;
+  }
+  else
+  {
+    s *= 1.525f;
+    t -= 2;
+    return c/2*(t*t*((s+1)*t + s) + 2) + b;
+  }
 }
 
 } // namespace back
 
 namespace bounce {
 
-inline float ease_out (float t, float b, float c, float d) 
+inline float ease_out(float t, float b, float c, float d) 
 {
   t  /=  d;
   if (t < (1/2.75f)) 
@@ -98,20 +106,20 @@
   }
 }
 
-inline float ease_in (float t, float b, float c, float d) 
+inline float ease_in(float t, float b, float c, float d) 
 {
-  return c - ease_out (d-t, 0, c, d) + b;
+  return c - ease_out(d-t, 0, c, d) + b;
 }
 
-inline float ease_in_out (float t, float b, float c, float d) 
+inline float ease_in_out(float t, float b, float c, float d) 
 {
   if (t < d/2) 
   {
-    return ease_in (t*2, 0, c, d) * .5f + b;
+    return ease_in(t*2, 0, c, d) * .5f + b;
   }
   else
   {
-    return ease_out (t*2-d, 0, c, d) * .5f + c*.5f + b;
+    return ease_out(t*2-d, 0, c, d) * .5f + c*.5f + b;
   }
 }
 
@@ -119,121 +127,228 @@
 
 namespace circ {
 
-inline float ease_in (float t, float b, float c, float d) 
+inline float ease_in(float t, float b, float c, float d) 
 {
   t  /=  d;
   return -c * (sqrtf(1 - t*t) - 1) + b;
 }
 
-inline float ease_out (float t, float b, float c, float d) 
+inline float ease_out(float t, float b, float c, float d) 
 {
-  t=t/d-1;
+  t = t / d - 1;
   return c * sqrtf(1 - t*t) + b;
 }
 
-inline float ease_in_out (float t, float b, float c, float d) 
+inline float ease_in_out(float t, float b, float c, float d) 
 {
   t /= d/2;
-  if (t < 1) return -c/2 * (sqrtf(1 - t*t) - 1) + b;
-  t-=2;
-  return c/2 * (sqrtf(1 - t*t) + 1) + b;
+  if (t < 1) 
+  {
+    return -c/2 * (sqrtf(1 - t*t) - 1) + b;
+  }
+  else
+  {
+    t-=2;
+    return c/2 * (sqrtf(1 - t*t) + 1) + b;
+  }
 }
 
 } // namespace circ {
 
 namespace cubic {
 
-inline float ease_in (float t, float b, float c, float d) 
+inline float ease_in(float t, float b, float c, float d) 
 {
   t /= d;
   return c*t*t*t + b;
 }
 
-inline float ease_out (float t, float b, float c, float d) 
+inline float ease_out(float t, float b, float c, float d) 
 {
   t=t/d-1;
   return c*(t*t*t + 1) + b;
 }
 
-inline float ease_in_out (float t, float b, float c, float d) 
+inline float ease_in_out(float t, float b, float c, float d) 
 {
   t /= d/2;
-  if (t < 1) return c/2*t*t*t + b;
-  t-=2;
-  return c/2*(t*t*t + 2) + b;
+  if (t < 1) 
+  {
+    return c/2*t*t*t + b;
+  }
+  else
+  {
+    t-=2;
+    return c/2*(t*t*t + 2) + b;
+  }
 }
 
 } // namespace cubic
 
 namespace elastic {
 
-inline float ease_in (float t, float b, float c, float d, float a, float p) 
+inline float ease_in(float t, float b, float c, float d, float a, float p) 
 {
-  if (t==0) return b; 
-  t /= d;
-  if (t==1) return b+c;
-  if (!p) p=d*0.3f;
-
-  float s;
-
-  if (!a || a < fabsf(c))
+  if (t==0) 
   {
-    a=c; s=p/4; 
+    return b; 
   }
-  else 
+  else
   {
-    s = p/(2*math::pi) * asinf (c/a);
+    t /= d;
+
+    if (t == 1)
+    {
+      return b+c;
+    }
+    else
+    {
+      if (!p) 
+        p = d * 0.3f;
+
+      float s;
+
+      if (!a || a < fabsf(c))
+      {
+        a=c; s=p/4; 
+      }
+      else 
+      {
+        s = p/(2*math::pi) * asinf (c/a);
+      }
+
+      t-=1;
+
+      return -(a*powf(2,10*t) * sinf( (t*d-s)*(2*math::pi)/p)) + b;
+    }
   }
-
-  t-=1;
-  return -(a*powf(2,10*t) * sinf( (t*d-s)*(2*math::pi)/p)) + b;
 }
 
-inline float ease_out (float t, float b, float c, float d, float a, float p) 
+inline float ease_out(float t, float b, float c, float d, float a, float p) 
 {
-  if (t==0) return b;  
-  t /= d;
-  if (t==1) return b+c;  if (!p) p=d*.3f;
-  float s;
-  if (!a || a < fabsf(c)) { a=c; s=p/4; }
-  else s = p/(2*math::pi) * asinf (c/a);
-  return (a*powf(2,-10*t) * sinf( (t*d-s)*(2*math::pi)/p ) + c + b);
+  if (t==0) 
+  {
+    return b;  
+  }
+  else
+  {   
+    t /= d;
+    if (t==1)
+    {
+      return b+c; 
+    }
+    else
+    {
+      if (!p)
+        p=d*.3f;
+
+      float s;
+      if (!a || a < fabsf(c)) 
+      {
+        a=c; 
+        s=p/4; 
+      }
+      else 
+      {
+        s = p/(2*math::pi) * asinf (c/a);
+      }
+    
+      return (a*powf(2,-10*t) * sinf( (t*d-s)*(2*math::pi)/p ) + c + b);
+    }
+  }
 }
 
-inline float ease_in_out (float t, float b, float c, float d, float a, float p) 
+inline float ease_in_out(float t, float b, float c, float d, float a, float p) 
 {
   t/=d/2;
-  if (t==0) return b;  if (t==2) return b+c;  if (!p) p=d*(.3f*1.5f);
-  float s;
-  if (!a || a < fabsf(c)) { a=c; s=p/4; }
-  else s = p/(2*math::pi) * asinf(c/a);
-  t-=1;
-  if (t < 1) return -.5f*(a*powf(2,10*t) * sinf( (t*d-s)*(2*math::pi)/p )) + b;
-  t-=1;
-  return a*powf(2,-10*t) * sinf( (t*d-s)*(2*math::pi)/p )*.5f + c + b;
+  if (t==0) 
+  {
+    return b;  
+  }
+  else if (t==2) 
+  {
+    return b+c;  
+  }
+  else
+  {
+    if (!p)
+      p = d * (0.3f * 1.5f);
+
+    float s;
+    if (!a || a < fabsf(c)) 
+    {
+      a=c; s=p/4; 
+    }
+    else
+    {
+      s = p/(2*math::pi) * asinf(c/a);
+    }
+
+    t-=1;
+
+    if (t < 1) 
+    {
+      return -.5f*(a*powf(2,10*t) * sinf( (t*d-s)*(2*math::pi)/p )) + b;
+    }
+    else
+    {
+      t-=1;
+      return a*powf(2,-10*t) * sinf( (t*d-s)*(2*math::pi)/p )*.5f + c + b;
+    }
+  }
 }
 
 } // namespace elastic
 
 namespace expo {
  
-inline float ease_in (float t, float b, float c, float d)
+inline float ease_in(float t, float b, float c, float d)
 {
-  return (t==0) ? b : c * powf(2, 10 * (t/d - 1)) + b;
+  if (t == 0) 
+  {
+    return b;
+  }
+  else
+  {
+    return c * powf(2, 10 * (t/d - 1)) + b;
+  }
 }
 
-inline float ease_out (float t, float b, float c, float d)
+inline float ease_out(float t, float b, float c, float d)
 {
-  return (t==d) ? b+c : c * (-powf(2, -10 * t/d) + 1) + b;
+  if (t == d)
+  {
+    return b + c;
+  }
+  else
+  {
+    return c * (-powf(2, -10 * t/d) + 1) + b;
+  }
 }
 
-inline float ease_in_out (float t, float b, float c, float d)
+inline float ease_in_out(float t, float b, float c, float d)
 {
-  if (t==0) return b;
-  if (t==d) return b+c;
-  t /= d/2;
-  if (t < 1) return c/2 * powf(2, 10 * (t - 1)) + b;
-  return c/2 * (-powf(2, -10 * --t) + 2) + b;
+  if (t == 0)
+  {
+    return b;
+  }
+  else if (t == d) 
+  {
+    return b+c;
+  }
+  else
+  {
+    t /= d/2;
+    if (t < 1) 
+    {
+      return c/2 * powf(2, 10 * (t - 1)) + b;
+    }
+    else
+    {
+      --t;
+      return c/2 * (-powf(2, -10 * t) + 2) + b;
+    }
+  }
 }
 
 } // namespace expo
@@ -245,17 +360,17 @@
   return c*t/d + b;
 }
 
-inline float ease_in (float t, float b, float c, float d) 
+inline float ease_in(float t, float b, float c, float d) 
 {
   return c*t/d + b;
 }
 
-inline float ease_out (float t, float b, float c, float d) 
+inline float ease_out(float t, float b, float c, float d) 
 {
   return c*t/d + b;
 }
 
-inline float ease_in_out (float t, float b, float c, float d) 
+inline float ease_in_out(float t, float b, float c, float d) 
 {
   return c*t/d + b;
 }
@@ -264,89 +379,107 @@
 
 namespace quad {
 
-inline float ease_in (float t, float b, float c, float d) 
+inline float ease_in(float t, float b, float c, float d) 
 {
-  t/=d;
+  t /= d;
   return c*t*t + b;
 }
 
-inline float ease_out (float t, float b, float c, float d) 
+inline float ease_out(float t, float b, float c, float d) 
 {
-  t/=d;
+  t /= d;
   return -c *t*(t-2) + b;
 }
 
-inline float ease_in_out (float t, float b, float c, float d) 
+inline float ease_in_out(float t, float b, float c, float d) 
 {
-  t/=d/2;
-  if (t < 1) return c/2*t*t + b;
-  --t;
-  return -c/2 * (t*(t-2) - 1) + b;
+  t = t / d / 2;
+  if (t < 1)
+  {
+    return c/2*t*t + b;
+  }
+  else
+  {
+    --t;
+    return -c/2 * (t*(t-2) - 1) + b;
+  }
 }
 
 } // namespace quad
 
 namespace quart {
 
-inline float ease_in (float t, float b, float c, float d) 
+inline float ease_in(float t, float b, float c, float d) 
 {
   t /= d;
   return c*t*t*t*t + b;
 }
 
-inline float ease_out (float t, float b, float c, float d) 
+inline float ease_out(float t, float b, float c, float d) 
 {
   t = t/d-1;
   return -c * (t*t*t*t - 1) + b;
 }
 
-inline float ease_in_out (float t, float b, float c, float d)
+inline float ease_in_out(float t, float b, float c, float d)
 {
   t /= d/2;
-  if (t < 1) return c/2*t*t*t*t + b;
-  t -= 2;
-  return -c/2 * (t*t*t*t - 2) + b;
+  if (t < 1) 
+  {
+    return c/2*t*t*t*t + b;
+  }
+  else
+  {
+    t -= 2;
+    return -c/2 * (t*t*t*t - 2) + b;
+  }
 }
 
 } // namespace quart
 
 namespace quint {
 
-inline float ease_in (float t, float b, float c, float d)
+inline float ease_in(float t, float b, float c, float d)
 {
   t /= d;
   return c*t*t*t*t*t + b;
 }
 
-inline float ease_out (float t, float b, float c, float d)
+inline float ease_out(float t, float b, float c, float d)
 {
   t = t/d-1;
   return c*(t*t*t*t*t + 1) + b;
 }
 
-inline float ease_in_out (float t, float b, float c, float d)
+inline float ease_in_out(float t, float b, float c, float d)
 {
   t /= d/2;
-  if (t < 1) return c/2*t*t*t*t*t + b;
-  t -= 2;
-  return c/2*(t*t*t*t*t + 2) + b;
+  if (t < 1) 
+  {
+    return c/2*t*t*t*t*t + b;
+  }
+  else
+  {
+    t -= 2;
+    return c/2*(t*t*t*t*t + 2) + b;
+  }
 }
 
 } // namespace quint
 
 namespace sine {
 
-inline float ease_in (float t, float b, float c, float d) 
+inline float ease_in(float t, float b, float c, float d) 
 {
   return -c * cosf(t/d * (math::pi/2)) + c + b;
 }
 
-inline float ease_out (float t, float b, float c, float d) 
+inline float ease_out(float t, float b, float c, float d) 
 {
   return c * sinf(t/d * (math::pi/2)) + b;
 }
 
-inline float ease_in_out (float t, float b, float c, float d) 
+inline float ease_in_out(float t, float b, float c, float d) 
 {
   return -c/2 * (cosf(math::pi*t/d) - 1) + b;
 }



From grumbel at mail.berlios.de  Thu Sep  3 00:36:25 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 3 Sep 2009 00:36:25 +0200
Subject: [Windstille-commit] r3183 - in trunk/windstille/src: display screen
Message-ID: <200909022236.n82MaPXo025345@sheep.berlios.de>

Author: grumbel
Date: 2009-09-03 00:36:23 +0200 (Thu, 03 Sep 2009)
New Revision: 3183

Modified:
   trunk/windstille/src/display/compositor.cpp
   trunk/windstille/src/screen/game_session.cpp
Log:
Added toggle for CONTROLMAP

Modified: trunk/windstille/src/display/compositor.cpp
===================================================================
--- trunk/windstille/src/display/compositor.cpp	2009-09-02 14:31:54 UTC (rev 3182)
+++ trunk/windstille/src/display/compositor.cpp	2009-09-02 22:36:23 UTC (rev 3183)
@@ -144,55 +144,59 @@
     Display::pop_framebuffer();
   }
 
-  if (sc.get_render_mask() & SceneContext::COLORMAP)
-  {
-    // Render the colormap to framebuffers->screen
+  { // Render the main screen
     Display::push_framebuffer(impl->framebuffers->screen);
-    glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
-    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
-    sc.color().render(*this);
 
-    if (sg)
+    if (sc.get_render_mask() & SceneContext::COLORMAP)
     {
-      glPushMatrix();
-      glMultMatrixf(gc_state.get_matrix().matrix);
-      sg->draw(SceneContext::COLORMAP);
-      glPopMatrix();
+      // Render the colormap to framebuffers->screen
+      glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
+      glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
+      sc.color().render(*this);
+
+      if (sg)
+      {
+        glPushMatrix();
+        glMultMatrixf(gc_state.get_matrix().matrix);
+        sg->draw(SceneContext::COLORMAP);
+        glPopMatrix();
+      }
     }
 
-    Display::pop_framebuffer();
-  }
+    if (sc.get_render_mask() & SceneContext::LIGHTMAP)
+    { // Renders the lightmap to the screen
+      render_lightmap(sc, sg);
+    }
 
-  if (sc.get_render_mask() & SceneContext::LIGHTMAP)
-  { // Renders the lightmap to the screen
-    Display::push_framebuffer(impl->framebuffers->screen);
-    render_lightmap(sc, sg);
-    Display::pop_framebuffer();
-  }
+    if (sc.get_render_mask() & SceneContext::HIGHLIGHTMAP)
+    {
+      sc.highlight().render(*this);
 
-  if (sc.get_render_mask() & SceneContext::HIGHLIGHTMAP)
-  {
-    Display::push_framebuffer(impl->framebuffers->screen);
-    sc.highlight().render(*this);
+      if (sg)
+      {
+        glPushMatrix();
+        glMultMatrixf(gc_state.get_matrix().matrix);
+        sg->draw(SceneContext::HIGHLIGHTMAP);
+        glPopMatrix();
+      }
+    }
 
-    if (sg)
+    if (sc.get_render_mask() & SceneContext::CONTROLMAP)
     {
-      glPushMatrix();
-      glMultMatrixf(gc_state.get_matrix().matrix);
-      sg->draw(SceneContext::HIGHLIGHTMAP);
-      glPopMatrix();
+      sc.control().render(*this);
+
+      if (sg)
+      {
+        glPushMatrix();
+        glMultMatrixf(gc_state.get_matrix().matrix);
+        sg->draw(SceneContext::CONTROLMAP);
+        glPopMatrix();
+      }
     }
 
     Display::pop_framebuffer();
   }
 
-  if (sc.get_render_mask() & SceneContext::CONTROLMAP)
-  {
-    Display::push_framebuffer(impl->framebuffers->screen);
-    sc.control().render(*this);
-    Display::pop_framebuffer();
-  }
-
   if (1) 
   {
     // Render the screen framebuffer to the actual screen 

Modified: trunk/windstille/src/screen/game_session.cpp
===================================================================
--- trunk/windstille/src/screen/game_session.cpp	2009-09-02 14:31:54 UTC (rev 3182)
+++ trunk/windstille/src/screen/game_session.cpp	2009-09-02 22:36:23 UTC (rev 3183)
@@ -381,17 +381,17 @@
                   sc.set_render_mask(sc.get_render_mask() ^ SceneContext::HIGHLIGHTMAP);
                   ConsoleLog << "Toggled HIGHLIGHTMAP: " << ((sc.get_render_mask() & SceneContext::HIGHLIGHTMAP) > 0) << std::endl;
                   break;      
+
+                case SDLK_4:
+                  sc.set_render_mask(sc.get_render_mask() ^ SceneContext::CONTROLMAP);
+                  ConsoleLog << "Toggled CONTROLMAP: " << ((sc.get_render_mask() & SceneContext::CONTROLMAP) > 0) << std::endl;
+                  break;
   
-                case SDLK_4:
+                case SDLK_5:
                   sc.set_render_mask(sc.get_render_mask() ^ SceneContext::LIGHTMAPSCREEN);
                   ConsoleLog << "Toggled LIGHTMAP: " << ((sc.get_render_mask() & SceneContext::LIGHTMAPSCREEN) > 0) << std::endl;
                   break;
 
-                case SDLK_5:
-                  sc.set_render_mask(sc.get_render_mask() ^ SceneContext::BLURMAP);
-                  ConsoleLog << "Toggled blurmap: " << ((sc.get_render_mask() & SceneContext::BLURMAP) > 0) << std::endl;
-                  break;
-
                 case SDLK_c:
                   if (debug) {
                     collision_debug = !collision_debug;



From grumbel at mail.berlios.de  Thu Sep  3 00:36:30 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 3 Sep 2009 00:36:30 +0200
Subject: [Windstille-commit] r3184 - trunk/windstille/src/scenegraph
Message-ID: <200909022236.n82MaUFJ025426@sheep.berlios.de>

Author: grumbel
Date: 2009-09-03 00:36:30 +0200 (Thu, 03 Sep 2009)
New Revision: 3184

Modified:
   trunk/windstille/src/scenegraph/navigation_graph_drawable.hpp
Log:
Added toggle for CONTROLMAP

Modified: trunk/windstille/src/scenegraph/navigation_graph_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/navigation_graph_drawable.hpp	2009-09-02 22:36:23 UTC (rev 3183)
+++ trunk/windstille/src/scenegraph/navigation_graph_drawable.hpp	2009-09-02 22:36:30 UTC (rev 3184)
@@ -20,6 +20,7 @@
 #define HEADER_WINDSTILLE_SCENEGRAPH_NAVIGATION_GRAPH_DRAWABLE_HPP
 
 #include "display/display.hpp"
+#include "display/scene_context.hpp"
 #include "scenegraph/drawable.hpp"
 
 class NavigationGraph;
@@ -33,12 +34,12 @@
   NavigationGraphDrawable(NavigationGraph* navgraph)
     : Drawable(Vector2f(), 1000.0f, Matrix::identity()),
       m_navgraph(navgraph)
-  {}
+  {
+    set_render_mask(SceneContext::CONTROLMAP);
+  }
 
   void draw()
   {
-    //Display::fill_rect(Rectf(-100, -100, 100, 1000), Color(1.0f, 0.0f, 0.0f));
-
     glLineWidth(4.0f);
     m_navgraph->draw();
     glLineWidth(1.0f);



From grumbel at mail.berlios.de  Thu Sep  3 00:37:16 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 3 Sep 2009 00:37:16 +0200
Subject: [Windstille-commit] r3185 - trunk/windstille/src/display
Message-ID: <200909022237.n82MbGgr026036@sheep.berlios.de>

Author: grumbel
Date: 2009-09-03 00:37:04 +0200 (Thu, 03 Sep 2009)
New Revision: 3185

Modified:
   trunk/windstille/src/display/scene_context.cpp
   trunk/windstille/src/display/scene_context.hpp
Log:
Removed unused code

Modified: trunk/windstille/src/display/scene_context.cpp
===================================================================
--- trunk/windstille/src/display/scene_context.cpp	2009-09-02 22:36:30 UTC (rev 3184)
+++ trunk/windstille/src/display/scene_context.cpp	2009-09-02 22:37:04 UTC (rev 3185)
@@ -207,24 +207,4 @@
   return impl->render_mask;
 }
 
-DrawingContext&
-SceneContext::get_layer(unsigned int type)
-{
-  switch(type)
-    {
-    case COLORMAP:
-      return impl->color;
-
-    case LIGHTMAP:
-      return impl->light;
-
-    case HIGHLIGHTMAP:
-      return impl->highlight;
-
-    default:
-      assert(!"SceneContext::get_layer(): Unknown type");
-      return impl->color; // never reached, but makes compiler happy
-    }
-}
-
 /* EOF */

Modified: trunk/windstille/src/display/scene_context.hpp
===================================================================
--- trunk/windstille/src/display/scene_context.hpp	2009-09-02 22:36:30 UTC (rev 3184)
+++ trunk/windstille/src/display/scene_context.hpp	2009-09-02 22:37:04 UTC (rev 3185)
@@ -89,9 +89,7 @@
       debugging. */
   void set_render_mask(unsigned int mask);
   unsigned int get_render_mask();
-
-  DrawingContext& get_layer(unsigned int t);
-
+  
 private:
   boost::scoped_ptr<SceneContextImpl> impl;
 



From grumbel at mail.berlios.de  Thu Sep  3 01:57:07 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 3 Sep 2009 01:57:07 +0200
Subject: [Windstille-commit] r3186 - in trunk/windstille/src: objects
	scenegraph
Message-ID: <200909022357.n82Nv7P2010756@sheep.berlios.de>

Author: grumbel
Date: 2009-09-03 01:57:06 +0200 (Thu, 03 Sep 2009)
New Revision: 3186

Added:
   trunk/windstille/src/scenegraph/gradient_drawable.cpp
   trunk/windstille/src/scenegraph/gradient_drawable.hpp
Modified:
   trunk/windstille/src/objects/background_gradient.cpp
   trunk/windstille/src/objects/background_gradient.hpp
Log:
Turned BackgroundGradient to use new GradientDrawable

Modified: trunk/windstille/src/objects/background_gradient.cpp
===================================================================
--- trunk/windstille/src/objects/background_gradient.cpp	2009-09-02 22:37:04 UTC (rev 3185)
+++ trunk/windstille/src/objects/background_gradient.cpp	2009-09-02 23:57:06 UTC (rev 3186)
@@ -18,15 +18,19 @@
 
 #include "objects/background_gradient.hpp"
 
+#include "engine/sector.hpp"
+#include "scenegraph/scene_graph.hpp"
 #include "scenegraph/vertex_array_drawable.hpp"
-#include "display/display.hpp"
+#include "scenegraph/gradient_drawable.hpp"
 
 BackgroundGradient::BackgroundGradient(FileReader& props)
-  : colors(),
-    z_pos(0.0f)
+  : drawable()
 {
-  props.get("z-pos",  z_pos);
+  std::vector<float> colors;
+
+  //props.get("z-pos",  z_pos);
   props.get("colors", colors);
+
   if (colors.size() % (3 + 4 + 4 + 2) != 0)
     {
       std::cout << "BackgroundGradient: specified color gradient is invalid" << std::endl;
@@ -43,6 +47,9 @@
        */
       colors.clear();
     }
+
+  drawable.reset(new GradientDrawable(colors));
+  Sector::current()->get_scene_graph().add_drawable(drawable);
 }
 
 BackgroundGradient::~BackgroundGradient()
@@ -55,60 +62,8 @@
 }
 
 void
-BackgroundGradient::draw(SceneContext& sc)
+BackgroundGradient::draw(SceneContext& /*sc*/)
 {
-  if (colors.empty())
-    return ;
-
-  // Reset modelview so we can draw in screen space
-  sc.color().push_modelview();
-  sc.color().set_modelview(Matrix::identity());
-  
-  Color topcolor(0.0f, 0.0f, 0.5f);
-  Color bottomcolor(0.5f, 0.5f, 1.0f);
-
-  Rectf rect(0.0f, 0.0f, 
-             static_cast<float>(Display::get_width()), static_cast<float>(Display::get_height()));
-  VertexArrayDrawable* array = new VertexArrayDrawable(Vector2f(0, 0), z_pos, 
-                                                                   sc.color().get_modelview());
-
-  array->set_mode(GL_QUAD_STRIP);
-  array->set_blend_func(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
-
-  for(int i = 0; i < int(colors.size()); i += (3 + 4 + 4 + 2))
-    {
-      const float& start    = colors[i + 0];
-      const float& midpoint = colors[i + 1];
-      const float& end      = colors[i + 2];
-      const Color color1(colors[i + 3], colors[i + 4], colors[i + 5], colors[i + 6]);
-      const Color color2(colors[i + 7], colors[i + 8], colors[i + 9], colors[i + 10]);
-      const Color midcolor((color1.r + color2.r)/2,
-                     (color1.g + color2.g)/2,
-                     (color1.b + color2.b)/2,
-                     (color1.a + color2.a)/2);
-
-      array->color(color1);
-      array->vertex(rect.left, rect.top + start * rect.get_height());
-
-      array->color(color1);
-      array->vertex(rect.right, rect.top + start * rect.get_height());
-
-      array->color(midcolor);
-      array->vertex(rect.left, rect.top + midpoint * rect.get_height());
-
-      array->color(midcolor);
-      array->vertex(rect.right, rect.top + midpoint * rect.get_height());
-
-      array->color(color2);
-      array->vertex(rect.left, rect.top + end * rect.get_height());
-
-      array->color(color2);
-      array->vertex(rect.right, rect.top + end * rect.get_height());  
-    }
-
-  sc.color().draw(array);  
-
-  sc.color().pop_modelview();
 }
 
 /* EOF */

Modified: trunk/windstille/src/objects/background_gradient.hpp
===================================================================
--- trunk/windstille/src/objects/background_gradient.hpp	2009-09-02 22:37:04 UTC (rev 3185)
+++ trunk/windstille/src/objects/background_gradient.hpp	2009-09-02 23:57:06 UTC (rev 3186)
@@ -21,12 +21,13 @@
 
 #include "engine/game_object.hpp"
 
-/** */
+class GradientDrawable;
+
 class BackgroundGradient : public GameObject
 {
 private:
-  std::vector<float> colors;
-  float z_pos; 
+  boost::shared_ptr<GradientDrawable> drawable;
+
 public:
   BackgroundGradient(FileReader& props);
   ~BackgroundGradient();

Added: trunk/windstille/src/scenegraph/gradient_drawable.cpp
===================================================================
--- trunk/windstille/src/scenegraph/gradient_drawable.cpp	2009-09-02 22:37:04 UTC (rev 3185)
+++ trunk/windstille/src/scenegraph/gradient_drawable.cpp	2009-09-02 23:57:06 UTC (rev 3186)
@@ -0,0 +1,80 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "scenegraph/gradient_drawable.hpp"
+
+#include <GL/gl.h>
+
+#include "display/display.hpp"
+
+GradientDrawable::GradientDrawable(const std::vector<float>& colors)
+  : Drawable(Vector2f(0, 0), -1000),
+    array(new VertexArrayDrawable(Vector2f(0, 0), -1000, Matrix::identity()))
+{
+  if (!colors.empty())
+  {
+    Rectf rect(0.0f, 0.0f, 
+               static_cast<float>(Display::get_width()), 
+               static_cast<float>(Display::get_height()));
+
+    array->set_mode(GL_QUAD_STRIP);
+    array->set_blend_func(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
+
+    for(int i = 0; i < int(colors.size()); i += (3 + 4 + 4 + 2))
+    {
+      const float& start    = colors[i + 0];
+      const float& midpoint = colors[i + 1];
+      const float& end      = colors[i + 2];
+      const Color color1(colors[i + 3], colors[i + 4], colors[i + 5], colors[i + 6]);
+      const Color color2(colors[i + 7], colors[i + 8], colors[i + 9], colors[i + 10]);
+      const Color midcolor((color1.r + color2.r)/2,
+                           (color1.g + color2.g)/2,
+                           (color1.b + color2.b)/2,
+                           (color1.a + color2.a)/2);
+
+      array->color(color1);
+      array->vertex(rect.left, rect.top + start * rect.get_height());
+
+      array->color(color1);
+      array->vertex(rect.right, rect.top + start * rect.get_height());
+
+      array->color(midcolor);
+      array->vertex(rect.left, rect.top + midpoint * rect.get_height());
+
+      array->color(midcolor);
+      array->vertex(rect.right, rect.top + midpoint * rect.get_height());
+
+      array->color(color2);
+      array->vertex(rect.left, rect.top + end * rect.get_height());
+
+      array->color(color2);
+      array->vertex(rect.right, rect.top + end * rect.get_height());  
+    }
+  }
+}
+
+void
+GradientDrawable::draw()
+{
+  glPushMatrix();
+  glLoadIdentity();
+  array->draw();
+  glPopMatrix();
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/scenegraph/gradient_drawable.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/scenegraph/gradient_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/gradient_drawable.hpp	2009-09-02 22:37:04 UTC (rev 3185)
+++ trunk/windstille/src/scenegraph/gradient_drawable.hpp	2009-09-02 23:57:06 UTC (rev 3186)
@@ -0,0 +1,44 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_SCENEGRAPH_GRADIENT_DRAWABLE_HPP
+#define HEADER_WINDSTILLE_SCENEGRAPH_GRADIENT_DRAWABLE_HPP
+
+#include <vector>
+#include <boost/scoped_ptr.hpp>
+
+#include "scenegraph/vertex_array_drawable.hpp"
+
+class GradientDrawable : public Drawable
+{
+private:
+  boost::scoped_ptr<VertexArrayDrawable> array;
+
+public:
+  GradientDrawable(const std::vector<float>& colors);
+  
+  void draw();
+
+private:
+  GradientDrawable(const GradientDrawable&);
+  GradientDrawable& operator=(const GradientDrawable&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/scenegraph/gradient_drawable.hpp
___________________________________________________________________
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Thu Sep  3 02:02:26 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 3 Sep 2009 02:02:26 +0200
Subject: [Windstille-commit] r3187 - trunk/windstille
Message-ID: <200909030002.n8302Q0r011067@sheep.berlios.de>

Author: grumbel
Date: 2009-09-03 02:02:24 +0200 (Thu, 03 Sep 2009)
New Revision: 3187

Modified:
   trunk/windstille/SConscript
Log:
Added new test case and added -Wunused-parameter

Modified: trunk/windstille/SConscript
===================================================================
--- trunk/windstille/SConscript	2009-09-02 23:57:06 UTC (rev 3186)
+++ trunk/windstille/SConscript	2009-09-03 00:02:24 UTC (rev 3187)
@@ -38,6 +38,7 @@
                      "-Wshadow",
                      "-Wcast-qual",
                      "-Winit-self", # only works with >= -O1
+                     "-Wunused-parameter",
                      # "-Winline",
                      # "-Wfloat-equal",
                      # "-Wunreachable-code",
@@ -334,6 +335,8 @@
         env.Program("test_response_curve", ["src/util/response_curve.cpp"])
         env.Program("test_random", ["src/math/random.cpp"])
         env.Program("test_pathname", ["src/util/pathname.cpp"], LIBS=['boost_filesystem-mt'])
+        env.Program("test_directory", ["src/util/directory.cpp"], LIBS=['boost_filesystem-mt', self.util_lib])
+        env.Program("test_easing", ["src/math/easing.cpp"])
 
     def build_windstille_data(self):
         data_env = self.env.Clone()



From grumbel at mail.berlios.de  Thu Sep  3 02:09:47 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 3 Sep 2009 02:09:47 +0200
Subject: [Windstille-commit] r3188 - in trunk/windstille/src: engine objects
Message-ID: <200909030009.n8309l6k012430@sheep.berlios.de>

Author: grumbel
Date: 2009-09-03 02:09:46 +0200 (Thu, 03 Sep 2009)
New Revision: 3188

Modified:
   trunk/windstille/src/engine/game_object.hpp
   trunk/windstille/src/objects/background_gradient.cpp
   trunk/windstille/src/objects/background_gradient.hpp
Log:
Minor cleanup

Modified: trunk/windstille/src/engine/game_object.hpp
===================================================================
--- trunk/windstille/src/engine/game_object.hpp	2009-09-03 00:02:24 UTC (rev 3187)
+++ trunk/windstille/src/engine/game_object.hpp	2009-09-03 00:09:46 UTC (rev 3188)
@@ -94,7 +94,7 @@
   /**
    * The object should draw itself when this function is called
    */
-  virtual void draw (SceneContext& /*sc*/) {}
+  virtual void draw (SceneContext& sc) {}
 
   /**
    * This function is called from time to time to give the object a chance to
@@ -102,9 +102,9 @@
    * update call in seconds. It is possible that there are multiple objects
    * between 2 draw() calls or multiple draw() calls between 2 updates
    */
-  virtual void update (float delta) = 0;
+  virtual void update (float delta) {}
     
-  virtual void set_parent(GameObject* /*parent*/) {}
+  virtual void set_parent(GameObject* parent) {}
 
 private:
   GameObject (const GameObject&);

Modified: trunk/windstille/src/objects/background_gradient.cpp
===================================================================
--- trunk/windstille/src/objects/background_gradient.cpp	2009-09-03 00:02:24 UTC (rev 3187)
+++ trunk/windstille/src/objects/background_gradient.cpp	2009-09-03 00:09:46 UTC (rev 3188)
@@ -55,15 +55,5 @@
 BackgroundGradient::~BackgroundGradient()
 {  
 }
-  
-void
-BackgroundGradient::update(float /*delta*/)
-{
-}
 
-void
-BackgroundGradient::draw(SceneContext& /*sc*/)
-{
-}
-
 /* EOF */

Modified: trunk/windstille/src/objects/background_gradient.hpp
===================================================================
--- trunk/windstille/src/objects/background_gradient.hpp	2009-09-03 00:02:24 UTC (rev 3187)
+++ trunk/windstille/src/objects/background_gradient.hpp	2009-09-03 00:09:46 UTC (rev 3188)
@@ -31,9 +31,6 @@
 public:
   BackgroundGradient(FileReader& props);
   ~BackgroundGradient();
-  
-  void update (float delta);
-  void draw (SceneContext& gc);
     
 private:
   BackgroundGradient (const BackgroundGradient&);



From grumbel at mail.berlios.de  Thu Sep  3 02:16:42 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 3 Sep 2009 02:16:42 +0200
Subject: [Windstille-commit] r3189 - trunk/windstille
Message-ID: <200909030016.n830GgtZ014713@sheep.berlios.de>

Author: grumbel
Date: 2009-09-03 02:16:41 +0200 (Thu, 03 Sep 2009)
New Revision: 3189

Modified:
   trunk/windstille/SConscript
Log:
Fixed typo

Modified: trunk/windstille/SConscript
===================================================================
--- trunk/windstille/SConscript	2009-09-03 00:09:46 UTC (rev 3188)
+++ trunk/windstille/SConscript	2009-09-03 00:16:41 UTC (rev 3189)
@@ -38,7 +38,7 @@
                      "-Wshadow",
                      "-Wcast-qual",
                      "-Winit-self", # only works with >= -O1
-                     "-Wunused-parameter",
+                     "-Wno-unused-parameter",
                      # "-Winline",
                      # "-Wfloat-equal",
                      # "-Wunreachable-code",



From grumbel at mail.berlios.de  Thu Sep  3 15:36:58 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 3 Sep 2009 15:36:58 +0200
Subject: [Windstille-commit] r3190 - in trunk/windstille/src: display editor
	screen
Message-ID: <200909031336.n83Dawt3007812@sheep.berlios.de>

Author: grumbel
Date: 2009-09-03 15:36:57 +0200 (Thu, 03 Sep 2009)
New Revision: 3190

Modified:
   trunk/windstille/src/display/compositor.cpp
   trunk/windstille/src/display/compositor.hpp
   trunk/windstille/src/display/opengl_window.hpp
   trunk/windstille/src/display/scene_context.cpp
   trunk/windstille/src/display/scene_context.hpp
   trunk/windstille/src/editor/windstille_widget.cpp
   trunk/windstille/src/screen/game_session.cpp
   trunk/windstille/src/screen/particle_viewer.cpp
   trunk/windstille/src/screen/sprite3dview.cpp
Log:
Fixed issue with lightmap being incorrectly rendered when window size is different then viewport size

Modified: trunk/windstille/src/display/compositor.cpp
===================================================================
--- trunk/windstille/src/display/compositor.cpp	2009-09-03 00:16:41 UTC (rev 3189)
+++ trunk/windstille/src/display/compositor.cpp	2009-09-03 13:36:57 UTC (rev 3190)
@@ -32,7 +32,6 @@
 
 // The lightmap has a resolution of screen.w/LIGHTMAP, screen.h/LIGHTMAP
 #define LIGHTMAP_DIV 4
-#define BLURMAP_DIV  1
 
 struct CompositorImpl
 {
@@ -41,27 +40,29 @@
     Framebuffer screen;
     Framebuffer lightmap;   
 
-    Framebuffers(const Size& size) 
-      : screen  (GL_TEXTURE_RECTANGLE_ARB, size.width, size.height),
-        lightmap(GL_TEXTURE_RECTANGLE_ARB, size.width / LIGHTMAP_DIV, size.height / LIGHTMAP_DIV)
+    Framebuffers(const Size& window) 
+      : screen  (GL_TEXTURE_RECTANGLE_ARB, window.width, window.height),
+        lightmap(GL_TEXTURE_RECTANGLE_ARB, window.width / LIGHTMAP_DIV, window.height / LIGHTMAP_DIV)
     {
     }
   };
-  
+
+  Size m_window;
+  Size m_viewport; 
   boost::scoped_ptr<Framebuffers> framebuffers;
   Surface lightmap;
-  Size m_size;
 
-  CompositorImpl(const Size& size)
-    : framebuffers(0),
-      lightmap(size.width  / LIGHTMAP_DIV,
-               size.height / LIGHTMAP_DIV),
-      m_size(size)
+  CompositorImpl(const Size& window, const Size& viewport)
+    : m_window(window),
+      m_viewport(viewport),
+      framebuffers(0),
+      lightmap(m_window.width  / LIGHTMAP_DIV,
+               m_window.height / LIGHTMAP_DIV)
   {
       if (GLEW_EXT_framebuffer_object) 
       {
         std::cout  << "Display:: framebuffer_object extension is supported" << std::endl;
-        framebuffers.reset(new Framebuffers(size));
+        framebuffers.reset(new Framebuffers(m_window));
       }
       else
       {
@@ -70,8 +71,8 @@
   }
 };
 
-Compositor::Compositor(const Size& size)
-  : impl(new CompositorImpl(size))
+Compositor::Compositor(const Size& window, const Size& viewport)
+  : impl(new CompositorImpl(window, viewport))
 {
 }
 
@@ -95,20 +96,19 @@
   state.activate();
 
   glBegin(GL_QUADS);
+  {
+    glTexCoord2f(uv.left, uv.bottom);
+    glVertex2i(0, 0);
 
-  glTexCoord2f(uv.left, uv.bottom);
-  glVertex2f(0, 0);
+    glTexCoord2f(uv.right, uv.bottom);
+    glVertex2i(impl->m_viewport.width, 0);
 
-  glTexCoord2f(uv.right, uv.bottom);
-  glVertex2f(static_cast<float>(impl->framebuffers->lightmap.get_width() * LIGHTMAP_DIV), 0.0f);
+    glTexCoord2f(uv.right, uv.top);
+    glVertex2i(impl->m_viewport.width, impl->m_viewport.height);
 
-  glTexCoord2f(uv.right, uv.top);
-  glVertex2f(static_cast<float>(impl->framebuffers->lightmap.get_width()  * LIGHTMAP_DIV),
-             static_cast<float>(impl->framebuffers->lightmap.get_height() * LIGHTMAP_DIV));
-
-  glTexCoord2f(uv.left, uv.top);
-  glVertex2f(0.0f, static_cast<float>(impl->framebuffers->lightmap.get_height() * LIGHTMAP_DIV));
-
+    glTexCoord2f(uv.left, uv.top);
+    glVertex2i(0, impl->m_viewport.height);
+  }
   glEnd();
 }
 
@@ -127,8 +127,8 @@
     glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
 
     glPushMatrix();
-    glTranslatef(0.0f, static_cast<float>(impl->m_size.height - (impl->m_size.height / LIGHTMAP_DIV)), 0.0f);
-    glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f);
+    glTranslatef(0.0f, static_cast<float>(impl->m_viewport.height - (impl->m_viewport.height / LIGHTMAP_DIV)), 0.0f);
+    glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV);
     sc.light().render(*this);
 
     if (sg)
@@ -140,7 +140,7 @@
     }
 
     glPopMatrix();
-
+    
     Display::pop_framebuffer();
   }
 
@@ -216,13 +216,13 @@
     glVertex2f(0, 0);
 
     glTexCoord2f(uv.right, uv.bottom);
-    glVertex2f(static_cast<float>(impl->m_size.width), 0);
+    glVertex2f(static_cast<float>(impl->m_viewport.width), 0);
 
     glTexCoord2f(uv.right, uv.top);
-    glVertex2f(static_cast<float>(impl->m_size.width), static_cast<float>(impl->m_size.height));
+    glVertex2f(static_cast<float>(impl->m_viewport.width), static_cast<float>(impl->m_viewport.height));
 
     glTexCoord2f(uv.left, uv.top);
-    glVertex2f(0.0f, static_cast<float>(impl->m_size.height));
+    glVertex2f(0.0f, static_cast<float>(impl->m_viewport.height));
 
     glEnd();
   }
@@ -238,10 +238,10 @@
 Compositor::render_without_framebuffers(SceneContext& sc, SceneGraph* sg, const GraphicContextState& gc_state)
 {
   // Resize Lightmap, only needed in the editor, FIXME: move this into a 'set_size()' call
-  if (impl->lightmap.get_width()  != impl->m_size.width /LIGHTMAP_DIV ||
-      impl->lightmap.get_height() != impl->m_size.height/LIGHTMAP_DIV)
+  if (impl->lightmap.get_width()  != impl->m_window.width /LIGHTMAP_DIV ||
+      impl->lightmap.get_height() != impl->m_window.height/LIGHTMAP_DIV)
   {
-    impl->lightmap = Surface(impl->m_size.width / LIGHTMAP_DIV, impl->m_size.height / LIGHTMAP_DIV);
+    impl->lightmap = Surface(impl->m_window.width / LIGHTMAP_DIV, impl->m_window.height / LIGHTMAP_DIV);
   }
 
   if (sc.get_render_mask() & SceneContext::LIGHTMAPSCREEN)
@@ -250,7 +250,7 @@
     glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
 
     glPushMatrix();
-    glTranslatef(0.0f, static_cast<float>(impl->m_size.height) - static_cast<float>(impl->m_size.height/LIGHTMAP_DIV), 0.0f);
+    glTranslatef(0.0f, static_cast<float>(impl->m_viewport.height) - static_cast<float>(impl->m_viewport.height/LIGHTMAP_DIV), 0.0f);
     glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f);
     sc.light().render(*this);
     glPopMatrix();
@@ -258,7 +258,7 @@
     if (sg)
     {
       glPushMatrix();
-      glTranslatef(0.0f, static_cast<float>(impl->m_size.height) - static_cast<float>(impl->m_size.height/LIGHTMAP_DIV), 0.0f);
+      glTranslatef(0.0f, static_cast<float>(impl->m_viewport.height) - static_cast<float>(impl->m_viewport.height/LIGHTMAP_DIV), 0.0f);
       glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f);
       glMultMatrixf(gc_state.get_matrix().matrix);
       sg->draw(SceneContext::LIGHTMAP);
@@ -274,7 +274,7 @@
 
       glCopyTexSubImage2D(GL_TEXTURE_2D, 0,
                           0, 0, 
-                          0, 0, //impl->m_size.height - impl->lightmap.get_height(),
+                          0, 0, //impl->m_window.height - impl->lightmap.get_height(),
                           static_cast<GLsizei>(impl->lightmap.get_width()), 
                           static_cast<GLsizei>(impl->lightmap.get_height()));
     }

Modified: trunk/windstille/src/display/compositor.hpp
===================================================================
--- trunk/windstille/src/display/compositor.hpp	2009-09-03 00:16:41 UTC (rev 3189)
+++ trunk/windstille/src/display/compositor.hpp	2009-09-03 13:36:57 UTC (rev 3190)
@@ -31,7 +31,7 @@
 class Compositor
 {
 public:
-  Compositor(const Size& size);
+  Compositor(const Size& window, const Size& viewport);
   ~Compositor();
 
   void render(SceneContext& sc, SceneGraph* sg, const GraphicContextState& state);

Modified: trunk/windstille/src/display/opengl_window.hpp
===================================================================
--- trunk/windstille/src/display/opengl_window.hpp	2009-09-03 00:16:41 UTC (rev 3189)
+++ trunk/windstille/src/display/opengl_window.hpp	2009-09-03 13:36:57 UTC (rev 3190)
@@ -22,6 +22,7 @@
 #include <SDL.h>
 
 #include "util/currenton.hpp"
+#include "math/size.hpp"
 
 class OpenGLWindow : public Currenton<OpenGLWindow>
 {
@@ -32,8 +33,9 @@
   OpenGLWindow();
   ~OpenGLWindow();
 
-  int get_width()  const { return m_window->w; }
-  int get_height() const { return m_window->h; }
+  int  get_width()  const { return m_window->w; }
+  int  get_height() const { return m_window->h; }
+  Size get_size()   const { return Size(m_window->w, m_window->h); }
 
   void set_fullscreen(bool fullscreen);
   void set_gamma(float r, float g, float b);

Modified: trunk/windstille/src/display/scene_context.cpp
===================================================================
--- trunk/windstille/src/display/scene_context.cpp	2009-09-03 00:16:41 UTC (rev 3189)
+++ trunk/windstille/src/display/scene_context.cpp	2009-09-03 13:36:57 UTC (rev 3190)
@@ -43,8 +43,7 @@
                   SceneContext::LIGHTMAP | 
                   SceneContext::HIGHLIGHTMAP | 
                   SceneContext::CONTROLMAP | 
-                  SceneContext::LIGHTMAPSCREEN |
-                  SceneContext::BLURMAP)
+                  SceneContext::LIGHTMAPSCREEN)
   {
   }
 

Modified: trunk/windstille/src/display/scene_context.hpp
===================================================================
--- trunk/windstille/src/display/scene_context.hpp	2009-09-03 00:16:41 UTC (rev 3189)
+++ trunk/windstille/src/display/scene_context.hpp	2009-09-03 13:36:57 UTC (rev 3190)
@@ -81,8 +81,7 @@
     LIGHTMAP       = 1<<1,
     HIGHLIGHTMAP   = 1<<2,
     CONTROLMAP     = 1<<3,
-    LIGHTMAPSCREEN = 1<<4,
-    BLURMAP        = 1<<5
+    LIGHTMAPSCREEN = 1<<4
   };
 
   /** The render mask allows to switch of some layers and effects for

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-03 00:16:41 UTC (rev 3189)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-03 13:36:57 UTC (rev 3190)
@@ -174,7 +174,8 @@
       if (!sc.get())
         {
           sc.reset(new SceneContext());
-          compositor.reset(new Compositor(Size(get_width(), get_height())));
+          compositor.reset(new Compositor(Size(get_width(), get_height()),
+                                          Size(get_width(), get_height())));
           sc->set_render_mask(sc->get_render_mask() & ~SceneContext::LIGHTMAP);
         }
       
@@ -209,7 +210,8 @@
     {
       if (compositor.get())
       {
-        compositor.reset(new Compositor(Size(ev->width, ev->height)));
+        compositor.reset(new Compositor(Size(ev->width, ev->height),
+                                        Size(ev->width, ev->height)));
       }
 
       glViewport(0, 0, get_width(), get_height());

Modified: trunk/windstille/src/screen/game_session.cpp
===================================================================
--- trunk/windstille/src/screen/game_session.cpp	2009-09-03 00:16:41 UTC (rev 3189)
+++ trunk/windstille/src/screen/game_session.cpp	2009-09-03 13:36:57 UTC (rev 3190)
@@ -21,6 +21,7 @@
 #include "app/menu_manager.hpp"
 #include "display/display.hpp"
 #include "display/compositor.hpp"
+#include "display/opengl_window.hpp"
 #include "engine/script_manager.hpp"
 #include "engine/sector.hpp"
 #include "font/fonts.hpp"
@@ -76,7 +77,7 @@
   Screen* current_gui;
 
   GameSessionImpl() 
-    : compositor(Size(Display::get_width(), Display::get_height())),
+    : compositor(OpenGLWindow::current()->get_size(), Display::get_size()),
       sc(),
       fadeout_value(),
       fade_time(),

Modified: trunk/windstille/src/screen/particle_viewer.cpp
===================================================================
--- trunk/windstille/src/screen/particle_viewer.cpp	2009-09-03 00:16:41 UTC (rev 3189)
+++ trunk/windstille/src/screen/particle_viewer.cpp	2009-09-03 13:36:57 UTC (rev 3190)
@@ -23,6 +23,7 @@
 
 #include "app/menu_manager.hpp"
 #include "display/display.hpp"
+#include "display/opengl_window.hpp"
 #include "display/graphic_context_state.hpp"
 #include "scenegraph/particle_system_drawable.hpp"
 #include "scenegraph/fill_screen_pattern_drawable.hpp"
@@ -31,7 +32,7 @@
 #include "util/sexpr_file_reader.hpp"
 
 ParticleViewer::ParticleViewer()
-  : compositor(Display::get_size()),
+  : compositor(OpenGLWindow::current()->get_size(), Display::get_size()),
     sc(),
     sg(),
     systems(),

Modified: trunk/windstille/src/screen/sprite3dview.cpp
===================================================================
--- trunk/windstille/src/screen/sprite3dview.cpp	2009-09-03 00:16:41 UTC (rev 3189)
+++ trunk/windstille/src/screen/sprite3dview.cpp	2009-09-03 13:36:57 UTC (rev 3190)
@@ -23,9 +23,10 @@
 #include "font/fonts.hpp"
 #include "input/controller.hpp"
 #include "display/graphic_context_state.hpp"
+#include "display/opengl_window.hpp"
 
 Sprite3DView::Sprite3DView()
-  : compositor(Display::get_size()),
+  : compositor(OpenGLWindow::current()->get_size(), Display::get_size()),
     sc(),
     sprite(),
     actions(),



From grumbel at mail.berlios.de  Thu Sep  3 17:14:05 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 3 Sep 2009 17:14:05 +0200
Subject: [Windstille-commit] r3191 - trunk/windstille/src/display
Message-ID: <200909031514.n83FE5lv020128@sheep.berlios.de>

Author: grumbel
Date: 2009-09-03 17:14:04 +0200 (Thu, 03 Sep 2009)
New Revision: 3191

Modified:
   trunk/windstille/src/display/compositor.cpp
   trunk/windstille/src/display/surface.cpp
Log:
Replaced GL_TEXTURE_RECTANGLE_ARB with GL_TEXTURE_2D and fixed a few more bugs in the compositor

Modified: trunk/windstille/src/display/compositor.cpp
===================================================================
--- trunk/windstille/src/display/compositor.cpp	2009-09-03 13:36:57 UTC (rev 3190)
+++ trunk/windstille/src/display/compositor.cpp	2009-09-03 15:14:04 UTC (rev 3191)
@@ -41,8 +41,8 @@
     Framebuffer lightmap;   
 
     Framebuffers(const Size& window) 
-      : screen  (GL_TEXTURE_RECTANGLE_ARB, window.width, window.height),
-        lightmap(GL_TEXTURE_RECTANGLE_ARB, window.width / LIGHTMAP_DIV, window.height / LIGHTMAP_DIV)
+      : screen  (GL_TEXTURE_2D, window.width, window.height),
+        lightmap(GL_TEXTURE_2D, window.width / LIGHTMAP_DIV, window.height / LIGHTMAP_DIV)
     {
     }
   };
@@ -83,30 +83,26 @@
 void
 Compositor::render_lightmap(SceneContext& /*sc*/, SceneGraph* /*sg*/)
 {
-  Rectf uv(0, 0,
-           static_cast<float>(impl->framebuffers->lightmap.get_width()), 
-           static_cast<float>(impl->framebuffers->lightmap.get_height()));
-
   OpenGLState state;
 
   state.bind_texture(impl->framebuffers->lightmap.get_texture());
       
   state.enable(GL_BLEND);
-  state.set_blend_func(GL_DST_COLOR, GL_ZERO); // multiple the lightmap with the screen
+  state.set_blend_func(GL_DST_COLOR, GL_ZERO); // multiply the lightmap with the screen
   state.activate();
 
   glBegin(GL_QUADS);
   {
-    glTexCoord2f(uv.left, uv.bottom);
+    glTexCoord2i(0, 1);
     glVertex2i(0, 0);
 
-    glTexCoord2f(uv.right, uv.bottom);
+    glTexCoord2i(1, 1);
     glVertex2i(impl->m_viewport.width, 0);
 
-    glTexCoord2f(uv.right, uv.top);
+    glTexCoord2i(1, 0);
     glVertex2i(impl->m_viewport.width, impl->m_viewport.height);
 
-    glTexCoord2f(uv.left, uv.top);
+    glTexCoord2i(0, 0);
     glVertex2i(0, impl->m_viewport.height);
   }
   glEnd();
@@ -202,28 +198,27 @@
     // Render the screen framebuffer to the actual screen 
     OpenGLState state;
 
-    Rectf uv(0, 0, 
-             static_cast<float>(impl->framebuffers->screen.get_width()),
-             static_cast<float>(impl->framebuffers->screen.get_height()));
+    //static_cast<float>(impl->framebuffers->screen.get_width()),
+    //static_cast<float>(impl->framebuffers->screen.get_height()));
 
     state.bind_texture(impl->framebuffers->screen.get_texture(), 0);
 
     state.activate();
 
     glBegin(GL_QUADS);
+    {
+      glTexCoord2i(0, 1);
+      glVertex2i(0, 0);
 
-    glTexCoord2f(uv.left, uv.bottom);
-    glVertex2f(0, 0);
+      glTexCoord2i(1, 1);
+      glVertex2i(impl->m_viewport.width, 0);
 
-    glTexCoord2f(uv.right, uv.bottom);
-    glVertex2f(static_cast<float>(impl->m_viewport.width), 0);
+      glTexCoord2i(1, 0);
+      glVertex2i(impl->m_viewport.width, impl->m_viewport.height);
 
-    glTexCoord2f(uv.right, uv.top);
-    glVertex2f(static_cast<float>(impl->m_viewport.width), static_cast<float>(impl->m_viewport.height));
-
-    glTexCoord2f(uv.left, uv.top);
-    glVertex2f(0.0f, static_cast<float>(impl->m_viewport.height));
-
+      glTexCoord2i(0, 0);
+      glVertex2i(0.0f, impl->m_viewport.height);
+    }
     glEnd();
   }
 
@@ -238,6 +233,7 @@
 Compositor::render_without_framebuffers(SceneContext& sc, SceneGraph* sg, const GraphicContextState& gc_state)
 {
   // Resize Lightmap, only needed in the editor, FIXME: move this into a 'set_size()' call
+  if (0)
   if (impl->lightmap.get_width()  != impl->m_window.width /LIGHTMAP_DIV ||
       impl->lightmap.get_height() != impl->m_window.height/LIGHTMAP_DIV)
   {
@@ -247,10 +243,11 @@
   if (sc.get_render_mask() & SceneContext::LIGHTMAPSCREEN)
   {
     // Render the lightmap to the framebuffers->lightmap
+    glClearColor(1.0f, 0.0f, 0.0f, 1.0f);
     glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
 
     glPushMatrix();
-    glTranslatef(0.0f, static_cast<float>(impl->m_viewport.height) - static_cast<float>(impl->m_viewport.height/LIGHTMAP_DIV), 0.0f);
+    //glTranslatef(0.0f, static_cast<float>(impl->m_viewport.height) - static_cast<float>(impl->m_window.height/LIGHTMAP_DIV), 0.0f);
     glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f);
     sc.light().render(*this);
     glPopMatrix();
@@ -258,7 +255,7 @@
     if (sg)
     {
       glPushMatrix();
-      glTranslatef(0.0f, static_cast<float>(impl->m_viewport.height) - static_cast<float>(impl->m_viewport.height/LIGHTMAP_DIV), 0.0f);
+      //glTranslatef(0.0f, static_cast<float>(impl->m_viewport.height) - static_cast<float>(impl->m_window.height/LIGHTMAP_DIV), 0.0f);
       glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f);
       glMultMatrixf(gc_state.get_matrix().matrix);
       sg->draw(SceneContext::LIGHTMAP);
@@ -272,9 +269,11 @@
       state.bind_texture(impl->lightmap.get_texture());
       state.activate();
 
-      glCopyTexSubImage2D(GL_TEXTURE_2D, 0,
-                          0, 0, 
-                          0, 0, //impl->m_window.height - impl->lightmap.get_height(),
+      glCopyTexSubImage2D(GL_TEXTURE_2D, 
+                          0, // level
+                          0, 0, // xoffset, yoffset
+                          0, 
+                          impl->m_window.height - static_cast<GLsizei>(impl->lightmap.get_height()),
                           static_cast<GLsizei>(impl->lightmap.get_width()), 
                           static_cast<GLsizei>(impl->lightmap.get_height()));
     }
@@ -301,8 +300,6 @@
   { // Renders the lightmap to the screen     
     OpenGLState state;
 
-    Rectf uv = impl->lightmap.get_uv();
-
     state.bind_texture(impl->lightmap.get_texture());
 
     state.enable(GL_BLEND);
@@ -311,18 +308,17 @@
 
     glBegin(GL_QUADS);
 
-    glTexCoord2f(uv.left, uv.bottom);
-    glVertex2f(0, 0);
+    glTexCoord2i(0, 1);
+    glVertex2i(0, 0);
 
-    glTexCoord2f(uv.right, uv.bottom);
-    glVertex2f(impl->lightmap.get_width() * LIGHTMAP_DIV, 0);
+    glTexCoord2i(1, 1);
+    glVertex2i(impl->m_viewport.width, 0);
 
-    glTexCoord2f(uv.right, uv.top);
-    glVertex2f(impl->lightmap.get_width()  * LIGHTMAP_DIV,
-               impl->lightmap.get_height() * LIGHTMAP_DIV);
+    glTexCoord2i(1, 0);
+    glVertex2i(impl->m_viewport.width, impl->m_viewport.height);
 
-    glTexCoord2f(uv.left, uv.top);
-    glVertex2f(0, impl->lightmap.get_height() * LIGHTMAP_DIV);
+    glTexCoord2i(0, 0);
+    glVertex2i(0, impl->m_viewport.height);
 
     glEnd();
   }
@@ -341,7 +337,17 @@
   }
 
   if (sc.get_render_mask() & SceneContext::CONTROLMAP)
+  {
     sc.control().render(*this);
+
+    if (sg)
+    {
+      glPushMatrix();
+      glMultMatrixf(gc_state.get_matrix().matrix);
+      sg->draw(SceneContext::CONTROLMAP);
+      glPopMatrix();
+    }
+  }
   
   // Clear all DrawingContexts
   sc.color().clear();

Modified: trunk/windstille/src/display/surface.cpp
===================================================================
--- trunk/windstille/src/display/surface.cpp	2009-09-03 13:36:57 UTC (rev 3190)
+++ trunk/windstille/src/display/surface.cpp	2009-09-03 15:14:04 UTC (rev 3191)
@@ -65,8 +65,7 @@
 {
   impl->size  = Size(width, height);
 
-  // FIXME: rounding to power of two shouldn't be needed in OpenGL2.0 or later
-  impl->texture = Texture(GL_TEXTURE_2D, math::round_to_power_of_two(width), math::round_to_power_of_two(height));
+  impl->texture = Texture(GL_TEXTURE_2D, width, height);
   impl->uv      = Rectf(0.0f, 0.0f,
                         impl->size.width  / static_cast<float>(impl->texture.get_width()),
                         impl->size.height / static_cast<float>(impl->texture.get_height()));



From grumbel at mail.berlios.de  Thu Sep  3 18:01:57 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 3 Sep 2009 18:01:57 +0200
Subject: [Windstille-commit] r3192 - trunk/windstille/src/display
Message-ID: <200909031601.n83G1vuu027873@sheep.berlios.de>

Author: grumbel
Date: 2009-09-03 18:01:56 +0200 (Thu, 03 Sep 2009)
New Revision: 3192

Added:
   trunk/windstille/src/display/basic_compositor_impl.cpp
   trunk/windstille/src/display/basic_compositor_impl.hpp
   trunk/windstille/src/display/compositor_impl.hpp
   trunk/windstille/src/display/framebuffer_compositor_impl.cpp
   trunk/windstille/src/display/framebuffer_compositor_impl.hpp
Modified:
   trunk/windstille/src/display/compositor.cpp
   trunk/windstille/src/display/compositor.hpp
   trunk/windstille/src/display/drawing_context.cpp
   trunk/windstille/src/display/drawing_context.hpp
Log:
Splitted Compositor render paths into two classes

Added: trunk/windstille/src/display/basic_compositor_impl.cpp
===================================================================
--- trunk/windstille/src/display/basic_compositor_impl.cpp	2009-09-03 15:14:04 UTC (rev 3191)
+++ trunk/windstille/src/display/basic_compositor_impl.cpp	2009-09-03 16:01:56 UTC (rev 3192)
@@ -0,0 +1,164 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "display/basic_compositor_impl.hpp"
+
+#include <GL/glew.h>
+#include <GL/gl.h>
+
+#include "display/graphic_context_state.hpp"
+#include "display/opengl_state.hpp"
+#include "display/scene_context.hpp"
+#include "scenegraph/scene_graph.hpp"
+
+static const int LIGHTMAP_DIV = 4;
+
+BasicCompositorImpl::BasicCompositorImpl(const Size& window, const Size& viewport)
+  : CompositorImpl(window, viewport),
+    m_lightmap(m_window.width  / LIGHTMAP_DIV,
+               m_window.height / LIGHTMAP_DIV)
+{
+}
+
+void
+BasicCompositorImpl::render(SceneContext& sc, SceneGraph* sg, const GraphicContextState& gc_state)
+{
+  // Resize Lightmap, only needed in the editor, FIXME: move this into a 'set_size()' call
+  if (m_lightmap.get_width()  != m_window.width /LIGHTMAP_DIV ||
+      m_lightmap.get_height() != m_window.height/LIGHTMAP_DIV)
+  {
+    m_lightmap = Surface(m_window.width / LIGHTMAP_DIV, m_window.height / LIGHTMAP_DIV);
+  }
+
+  if (sc.get_render_mask() & SceneContext::LIGHTMAPSCREEN)
+  {
+    // Render the lightmap to the framebuffers->lightmap
+    glClearColor(1.0f, 0.0f, 0.0f, 1.0f);
+    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
+
+    glPushMatrix();
+    //glTranslatef(0.0f, static_cast<float>(m_viewport.height) - static_cast<float>(m_window.height/LIGHTMAP_DIV), 0.0f);
+    glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f);
+    sc.light().render();
+    glPopMatrix();
+
+    if (sg)
+    {
+      glPushMatrix();
+      //glTranslatef(0.0f, static_cast<float>(m_viewport.height) - static_cast<float>(m_window.height/LIGHTMAP_DIV), 0.0f);
+      glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f);
+      glMultMatrixf(gc_state.get_matrix().matrix);
+      sg->draw(SceneContext::LIGHTMAP);
+      glPopMatrix();
+    }
+
+    { // Copy lightmap to a texture
+      OpenGLState state;
+        
+      // Weird y-pos is needed since OpenGL is upside down when it comes to y-coordinate
+      state.bind_texture(m_lightmap.get_texture());
+      state.activate();
+
+      glCopyTexSubImage2D(GL_TEXTURE_2D, 
+                          0, // level
+                          0, 0, // xoffset, yoffset
+                          0, 
+                          m_window.height - static_cast<GLsizei>(m_lightmap.get_height()),
+                          static_cast<GLsizei>(m_lightmap.get_width()), 
+                          static_cast<GLsizei>(m_lightmap.get_height()));
+    }
+  }
+
+  if (sc.get_render_mask() & SceneContext::COLORMAP)
+  {
+    // Render the colormap to the framebuffers->screen
+    glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
+    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
+
+    sc.color().render();
+
+    if (sg)
+    {
+      glPushMatrix();
+      glMultMatrixf(gc_state.get_matrix().matrix);
+      sg->draw(SceneContext::COLORMAP);
+      glPopMatrix();
+    }
+  }
+
+  if (sc.get_render_mask() & SceneContext::LIGHTMAP)
+  { // Renders the lightmap to the screen     
+    OpenGLState state;
+
+    state.bind_texture(m_lightmap.get_texture());
+
+    state.enable(GL_BLEND);
+    state.set_blend_func(GL_DST_COLOR, GL_ZERO);
+    state.activate();
+
+    glBegin(GL_QUADS);
+
+    glTexCoord2i(0, 1);
+    glVertex2i(0, 0);
+
+    glTexCoord2i(1, 1);
+    glVertex2i(m_viewport.width, 0);
+
+    glTexCoord2i(1, 0);
+    glVertex2i(m_viewport.width, m_viewport.height);
+
+    glTexCoord2i(0, 0);
+    glVertex2i(0, m_viewport.height);
+
+    glEnd();
+  }
+
+  if (sc.get_render_mask() & SceneContext::HIGHLIGHTMAP)
+  {
+    sc.highlight().render();
+
+    if (sg)
+    {
+      glPushMatrix();
+      glMultMatrixf(gc_state.get_matrix().matrix);
+      sg->draw(SceneContext::HIGHLIGHTMAP);
+      glPopMatrix();
+    }
+  }
+
+  if (sc.get_render_mask() & SceneContext::CONTROLMAP)
+  {
+    sc.control().render();
+
+    if (sg)
+    {
+      glPushMatrix();
+      glMultMatrixf(gc_state.get_matrix().matrix);
+      sg->draw(SceneContext::CONTROLMAP);
+      glPopMatrix();
+    }
+  }
+  
+  // Clear all DrawingContexts
+  sc.color().clear();
+  sc.light().clear();
+  sc.highlight().clear();
+  sc.control().clear(); 
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/display/basic_compositor_impl.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/display/basic_compositor_impl.hpp
===================================================================
--- trunk/windstille/src/display/basic_compositor_impl.hpp	2009-09-03 15:14:04 UTC (rev 3191)
+++ trunk/windstille/src/display/basic_compositor_impl.hpp	2009-09-03 16:01:56 UTC (rev 3192)
@@ -0,0 +1,42 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_BASIC_COMPOSITOR_IMPL_HPP
+#define HEADER_BASIC_COMPOSITOR_IMPL_HPP
+
+#include "display/compositor_impl.hpp"
+#include "display/surface.hpp"
+
+class BasicCompositorImpl : public CompositorImpl
+{
+private:
+  Surface m_lightmap;
+
+public:
+  BasicCompositorImpl(const Size& window, const Size& viewport);
+
+  void render(SceneContext& sc, SceneGraph* sg, const GraphicContextState& gc_state);
+  
+private:
+  BasicCompositorImpl(const BasicCompositorImpl&);
+  BasicCompositorImpl& operator=(const BasicCompositorImpl&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/display/basic_compositor_impl.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/display/compositor.cpp
===================================================================
--- trunk/windstille/src/display/compositor.cpp	2009-09-03 15:14:04 UTC (rev 3191)
+++ trunk/windstille/src/display/compositor.cpp	2009-09-03 16:01:56 UTC (rev 3192)
@@ -20,353 +20,32 @@
 
 #include <GL/glew.h>
 
-#include "display/display.hpp"
-#include "scenegraph/drawable.hpp"
-#include "display/graphic_context_state.hpp"
-#include "display/framebuffer.hpp"
-#include "display/opengl_state.hpp"
-#include "display/scene_context.hpp"
-#include "display/surface.hpp"
-#include "math/rect.hpp"
-#include "scenegraph/scene_graph.hpp"
-
-// The lightmap has a resolution of screen.w/LIGHTMAP, screen.h/LIGHTMAP
-#define LIGHTMAP_DIV 4
-
-struct CompositorImpl
-{
-  struct Framebuffers 
-  {
-    Framebuffer screen;
-    Framebuffer lightmap;   
-
-    Framebuffers(const Size& window) 
-      : screen  (GL_TEXTURE_2D, window.width, window.height),
-        lightmap(GL_TEXTURE_2D, window.width / LIGHTMAP_DIV, window.height / LIGHTMAP_DIV)
-    {
-    }
-  };
-
-  Size m_window;
-  Size m_viewport; 
-  boost::scoped_ptr<Framebuffers> framebuffers;
-  Surface lightmap;
-
-  CompositorImpl(const Size& window, const Size& viewport)
-    : m_window(window),
-      m_viewport(viewport),
-      framebuffers(0),
-      lightmap(m_window.width  / LIGHTMAP_DIV,
-               m_window.height / LIGHTMAP_DIV)
-  {
-      if (GLEW_EXT_framebuffer_object) 
-      {
-        std::cout  << "Display:: framebuffer_object extension is supported" << std::endl;
-        framebuffers.reset(new Framebuffers(m_window));
-      }
-      else
-      {
-        std::cout  << "Display:: framebuffer_object extension is not supported" << std::endl;
-      }
-  }
-};
+#include "display/framebuffer_compositor_impl.hpp"
+#include "display/basic_compositor_impl.hpp"
 
 Compositor::Compositor(const Size& window, const Size& viewport)
-  : impl(new CompositorImpl(window, viewport))
+  : impl()
 {
-}
-
-Compositor::~Compositor()
-{
-}
-
-void
-Compositor::render_lightmap(SceneContext& /*sc*/, SceneGraph* /*sg*/)
-{
-  OpenGLState state;
-
-  state.bind_texture(impl->framebuffers->lightmap.get_texture());
-      
-  state.enable(GL_BLEND);
-  state.set_blend_func(GL_DST_COLOR, GL_ZERO); // multiply the lightmap with the screen
-  state.activate();
-
-  glBegin(GL_QUADS);
+  if (GLEW_EXT_framebuffer_object)
   {
-    glTexCoord2i(0, 1);
-    glVertex2i(0, 0);
-
-    glTexCoord2i(1, 1);
-    glVertex2i(impl->m_viewport.width, 0);
-
-    glTexCoord2i(1, 0);
-    glVertex2i(impl->m_viewport.width, impl->m_viewport.height);
-
-    glTexCoord2i(0, 0);
-    glVertex2i(0, impl->m_viewport.height);
+    std::cout  << "Display:: framebuffer_object extension is supported" << std::endl;
+    impl.reset(new FramebufferCompositorImpl(window, viewport));
   }
-  glEnd();
-}
-
-void
-Compositor::render_with_framebuffers(SceneContext& sc, SceneGraph* sg,
-                                     const GraphicContextState& gc_state)
-{
-  glClear(GL_DEPTH_BUFFER_BIT);
-      
-  if (sc.get_render_mask() & SceneContext::LIGHTMAPSCREEN)
+  else
   {
-    // Render the lightmap to framebuffers->lightmap
-    Display::push_framebuffer(impl->framebuffers->lightmap);
-
-    glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
-    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
-
-    glPushMatrix();
-    glTranslatef(0.0f, static_cast<float>(impl->m_viewport.height - (impl->m_viewport.height / LIGHTMAP_DIV)), 0.0f);
-    glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV);
-    sc.light().render(*this);
-
-    if (sg)
-    {
-      glPushMatrix();
-      glMultMatrixf(gc_state.get_matrix().matrix);
-      sg->draw(SceneContext::LIGHTMAP);
-      glPopMatrix();
-    }
-
-    glPopMatrix();
-    
-    Display::pop_framebuffer();
+    std::cout  << "Display:: framebuffer_object extension is not supported" << std::endl;   
+    impl.reset(new BasicCompositorImpl(window, viewport));
   }
-
-  { // Render the main screen
-    Display::push_framebuffer(impl->framebuffers->screen);
-
-    if (sc.get_render_mask() & SceneContext::COLORMAP)
-    {
-      // Render the colormap to framebuffers->screen
-      glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
-      glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
-      sc.color().render(*this);
-
-      if (sg)
-      {
-        glPushMatrix();
-        glMultMatrixf(gc_state.get_matrix().matrix);
-        sg->draw(SceneContext::COLORMAP);
-        glPopMatrix();
-      }
-    }
-
-    if (sc.get_render_mask() & SceneContext::LIGHTMAP)
-    { // Renders the lightmap to the screen
-      render_lightmap(sc, sg);
-    }
-
-    if (sc.get_render_mask() & SceneContext::HIGHLIGHTMAP)
-    {
-      sc.highlight().render(*this);
-
-      if (sg)
-      {
-        glPushMatrix();
-        glMultMatrixf(gc_state.get_matrix().matrix);
-        sg->draw(SceneContext::HIGHLIGHTMAP);
-        glPopMatrix();
-      }
-    }
-
-    if (sc.get_render_mask() & SceneContext::CONTROLMAP)
-    {
-      sc.control().render(*this);
-
-      if (sg)
-      {
-        glPushMatrix();
-        glMultMatrixf(gc_state.get_matrix().matrix);
-        sg->draw(SceneContext::CONTROLMAP);
-        glPopMatrix();
-      }
-    }
-
-    Display::pop_framebuffer();
-  }
-
-  if (1) 
-  {
-    // Render the screen framebuffer to the actual screen 
-    OpenGLState state;
-
-    //static_cast<float>(impl->framebuffers->screen.get_width()),
-    //static_cast<float>(impl->framebuffers->screen.get_height()));
-
-    state.bind_texture(impl->framebuffers->screen.get_texture(), 0);
-
-    state.activate();
-
-    glBegin(GL_QUADS);
-    {
-      glTexCoord2i(0, 1);
-      glVertex2i(0, 0);
-
-      glTexCoord2i(1, 1);
-      glVertex2i(impl->m_viewport.width, 0);
-
-      glTexCoord2i(1, 0);
-      glVertex2i(impl->m_viewport.width, impl->m_viewport.height);
-
-      glTexCoord2i(0, 0);
-      glVertex2i(0.0f, impl->m_viewport.height);
-    }
-    glEnd();
-  }
-
-  // Clear all DrawingContexts
-  sc.color().clear();
-  sc.light().clear();
-  sc.highlight().clear();
-  sc.control().clear();
 }
 
-void
-Compositor::render_without_framebuffers(SceneContext& sc, SceneGraph* sg, const GraphicContextState& gc_state)
+Compositor::~Compositor()
 {
-  // Resize Lightmap, only needed in the editor, FIXME: move this into a 'set_size()' call
-  if (0)
-  if (impl->lightmap.get_width()  != impl->m_window.width /LIGHTMAP_DIV ||
-      impl->lightmap.get_height() != impl->m_window.height/LIGHTMAP_DIV)
-  {
-    impl->lightmap = Surface(impl->m_window.width / LIGHTMAP_DIV, impl->m_window.height / LIGHTMAP_DIV);
-  }
-
-  if (sc.get_render_mask() & SceneContext::LIGHTMAPSCREEN)
-  {
-    // Render the lightmap to the framebuffers->lightmap
-    glClearColor(1.0f, 0.0f, 0.0f, 1.0f);
-    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
-
-    glPushMatrix();
-    //glTranslatef(0.0f, static_cast<float>(impl->m_viewport.height) - static_cast<float>(impl->m_window.height/LIGHTMAP_DIV), 0.0f);
-    glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f);
-    sc.light().render(*this);
-    glPopMatrix();
-
-    if (sg)
-    {
-      glPushMatrix();
-      //glTranslatef(0.0f, static_cast<float>(impl->m_viewport.height) - static_cast<float>(impl->m_window.height/LIGHTMAP_DIV), 0.0f);
-      glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f);
-      glMultMatrixf(gc_state.get_matrix().matrix);
-      sg->draw(SceneContext::LIGHTMAP);
-      glPopMatrix();
-    }
-
-    { // Copy lightmap to a texture
-      OpenGLState state;
-        
-      // Weird y-pos is needed since OpenGL is upside down when it comes to y-coordinate
-      state.bind_texture(impl->lightmap.get_texture());
-      state.activate();
-
-      glCopyTexSubImage2D(GL_TEXTURE_2D, 
-                          0, // level
-                          0, 0, // xoffset, yoffset
-                          0, 
-                          impl->m_window.height - static_cast<GLsizei>(impl->lightmap.get_height()),
-                          static_cast<GLsizei>(impl->lightmap.get_width()), 
-                          static_cast<GLsizei>(impl->lightmap.get_height()));
-    }
-  }
-
-  if (sc.get_render_mask() & SceneContext::COLORMAP)
-  {
-    // Render the colormap to the framebuffers->screen
-    glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
-    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
-
-    sc.color().render(*this);
-
-    if (sg)
-    {
-      glPushMatrix();
-      glMultMatrixf(gc_state.get_matrix().matrix);
-      sg->draw(SceneContext::COLORMAP);
-      glPopMatrix();
-    }
-  }
-
-  if (sc.get_render_mask() & SceneContext::LIGHTMAP)
-  { // Renders the lightmap to the screen     
-    OpenGLState state;
-
-    state.bind_texture(impl->lightmap.get_texture());
-
-    state.enable(GL_BLEND);
-    state.set_blend_func(GL_DST_COLOR, GL_ZERO);
-    state.activate();
-
-    glBegin(GL_QUADS);
-
-    glTexCoord2i(0, 1);
-    glVertex2i(0, 0);
-
-    glTexCoord2i(1, 1);
-    glVertex2i(impl->m_viewport.width, 0);
-
-    glTexCoord2i(1, 0);
-    glVertex2i(impl->m_viewport.width, impl->m_viewport.height);
-
-    glTexCoord2i(0, 0);
-    glVertex2i(0, impl->m_viewport.height);
-
-    glEnd();
-  }
-
-  if (sc.get_render_mask() & SceneContext::HIGHLIGHTMAP)
-  {
-    sc.highlight().render(*this);
-
-    if (sg)
-    {
-      glPushMatrix();
-      glMultMatrixf(gc_state.get_matrix().matrix);
-      sg->draw(SceneContext::HIGHLIGHTMAP);
-      glPopMatrix();
-    }
-  }
-
-  if (sc.get_render_mask() & SceneContext::CONTROLMAP)
-  {
-    sc.control().render(*this);
-
-    if (sg)
-    {
-      glPushMatrix();
-      glMultMatrixf(gc_state.get_matrix().matrix);
-      sg->draw(SceneContext::CONTROLMAP);
-      glPopMatrix();
-    }
-  }
-  
-  // Clear all DrawingContexts
-  sc.color().clear();
-  sc.light().clear();
-  sc.highlight().clear();
-  sc.control().clear(); 
 }
 
 void
 Compositor::render(SceneContext& sc, SceneGraph* sg, const GraphicContextState& state)
 {
-  if (impl->framebuffers)
-  {
-    render_with_framebuffers(sc, sg, state);
-  }
-  else
-  {
-    render_without_framebuffers(sc, sg, state);
-  }
+  impl->render(sc, sg, state);
 }
 
 /* EOF */

Modified: trunk/windstille/src/display/compositor.hpp
===================================================================
--- trunk/windstille/src/display/compositor.hpp	2009-09-03 15:14:04 UTC (rev 3191)
+++ trunk/windstille/src/display/compositor.hpp	2009-09-03 16:01:56 UTC (rev 3192)
@@ -22,7 +22,6 @@
 #include <boost/scoped_ptr.hpp>
 
 class CompositorImpl;
-class Drawable;
 class GraphicContextState;
 class SceneContext;
 class SceneGraph;
@@ -37,18 +36,6 @@
   void render(SceneContext& sc, SceneGraph* sg, const GraphicContextState& state);
 
 private:
-  void render_with_framebuffers(SceneContext& sc, SceneGraph* sg,
-                                const GraphicContextState& state);
-  void render_without_framebuffers(SceneContext& sc, SceneGraph* sg, 
-                                   const GraphicContextState& state);
-
-  void render_lightmap(SceneContext& sc, SceneGraph* sg);
-
-private:
-  Compositor(const Compositor&);
-  Compositor& operator=(const Compositor&);
-
-private:
   boost::scoped_ptr<CompositorImpl> impl;
 };
 

Added: trunk/windstille/src/display/compositor_impl.hpp
===================================================================
--- trunk/windstille/src/display/compositor_impl.hpp	2009-09-03 15:14:04 UTC (rev 3191)
+++ trunk/windstille/src/display/compositor_impl.hpp	2009-09-03 16:01:56 UTC (rev 3192)
@@ -0,0 +1,48 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_DISPLAY_COMPOSITOR_IMPL_HPP
+#define HEADER_WINDSTILLE_DISPLAY_COMPOSITOR_IMPL_HPP
+
+#include "math/size.hpp"
+
+class SceneContext;
+class SceneGraph;
+class GraphicContextState;
+
+class CompositorImpl
+{
+protected:
+  Size m_window;
+  Size m_viewport; 
+
+public:
+  CompositorImpl(const Size& window, const Size& viewport)
+    : m_window(window),
+      m_viewport(viewport)
+  {}
+
+  virtual ~CompositorImpl()
+  {}
+
+  virtual void render(SceneContext& sc, SceneGraph* sg, const GraphicContextState& state) =0;
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/display/compositor_impl.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/display/drawing_context.cpp
===================================================================
--- trunk/windstille/src/display/drawing_context.cpp	2009-09-03 15:14:04 UTC (rev 3191)
+++ trunk/windstille/src/display/drawing_context.cpp	2009-09-03 16:01:56 UTC (rev 3192)
@@ -60,7 +60,7 @@
 }
 
 void
-DrawingContext::render(Compositor& /*comp*/)
+DrawingContext::render()
 {
   std::stable_sort(drawingrequests.begin(), drawingrequests.end(), DrawablesSorter());
   

Modified: trunk/windstille/src/display/drawing_context.hpp
===================================================================
--- trunk/windstille/src/display/drawing_context.hpp	2009-09-03 15:14:04 UTC (rev 3191)
+++ trunk/windstille/src/display/drawing_context.hpp	2009-09-03 16:01:56 UTC (rev 3192)
@@ -53,7 +53,7 @@
   ~DrawingContext();
 
   /** Draws everything in the drawing context to the screen */
-  void render(Compositor& sc);
+  void render();
 
   /** Empties the drawing context */
   void clear();

Added: trunk/windstille/src/display/framebuffer_compositor_impl.cpp
===================================================================
--- trunk/windstille/src/display/framebuffer_compositor_impl.cpp	2009-09-03 15:14:04 UTC (rev 3191)
+++ trunk/windstille/src/display/framebuffer_compositor_impl.cpp	2009-09-03 16:01:56 UTC (rev 3192)
@@ -0,0 +1,184 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "display/framebuffer_compositor_impl.hpp"
+
+#include "display/display.hpp"
+#include "display/graphic_context_state.hpp"
+#include "display/opengl_state.hpp"
+#include "display/scene_context.hpp"
+#include "scenegraph/scene_graph.hpp"
+
+static const int LIGHTMAP_DIV = 4;
+
+FramebufferCompositorImpl::FramebufferCompositorImpl(const Size& window, const Size& viewport)
+  : CompositorImpl(window, viewport),
+    m_screen  (GL_TEXTURE_2D, window.width, window.height),
+    m_lightmap(GL_TEXTURE_2D, window.width / LIGHTMAP_DIV, window.height / LIGHTMAP_DIV)
+{
+}
+
+void
+FramebufferCompositorImpl::render_lightmap(SceneContext& /*sc*/, SceneGraph* /*sg*/)
+{
+  OpenGLState state;
+
+  state.bind_texture(m_lightmap.get_texture());
+      
+  state.enable(GL_BLEND);
+  state.set_blend_func(GL_DST_COLOR, GL_ZERO); // multiply the lightmap with the screen
+  state.activate();
+
+  glBegin(GL_QUADS);
+  {
+    glTexCoord2i(0, 1);
+    glVertex2i(0, 0);
+
+    glTexCoord2i(1, 1);
+    glVertex2i(m_viewport.width, 0);
+
+    glTexCoord2i(1, 0);
+    glVertex2i(m_viewport.width, m_viewport.height);
+
+    glTexCoord2i(0, 0);
+    glVertex2i(0, m_viewport.height);
+  }
+  glEnd();
+}
+
+void
+FramebufferCompositorImpl::render(SceneContext& sc, SceneGraph* sg, const GraphicContextState& gc_state)
+{
+  glClear(GL_DEPTH_BUFFER_BIT);
+      
+  if (sc.get_render_mask() & SceneContext::LIGHTMAPSCREEN)
+  {
+    // Render the lightmap to framebuffers->lightmap
+    Display::push_framebuffer(m_lightmap);
+
+    glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
+    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
+
+    glPushMatrix();
+    glTranslatef(0.0f, static_cast<float>(m_viewport.height - (m_viewport.height / LIGHTMAP_DIV)), 0.0f);
+    glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV);
+    sc.light().render();
+
+    if (sg)
+    {
+      glPushMatrix();
+      glMultMatrixf(gc_state.get_matrix().matrix);
+      sg->draw(SceneContext::LIGHTMAP);
+      glPopMatrix();
+    }
+
+    glPopMatrix();
+    
+    Display::pop_framebuffer();
+  }
+
+  { // Render the main screen
+    Display::push_framebuffer(m_screen);
+
+    if (sc.get_render_mask() & SceneContext::COLORMAP)
+    {
+      // Render the colormap to framebuffers->screen
+      glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
+      glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
+      sc.color().render();
+
+      if (sg)
+      {
+        glPushMatrix();
+        glMultMatrixf(gc_state.get_matrix().matrix);
+        sg->draw(SceneContext::COLORMAP);
+        glPopMatrix();
+      }
+    }
+
+    if (sc.get_render_mask() & SceneContext::LIGHTMAP)
+    { // Renders the lightmap to the screen
+      render_lightmap(sc, sg);
+    }
+
+    if (sc.get_render_mask() & SceneContext::HIGHLIGHTMAP)
+    {
+      sc.highlight().render();
+
+      if (sg)
+      {
+        glPushMatrix();
+        glMultMatrixf(gc_state.get_matrix().matrix);
+        sg->draw(SceneContext::HIGHLIGHTMAP);
+        glPopMatrix();
+      }
+    }
+
+    if (sc.get_render_mask() & SceneContext::CONTROLMAP)
+    {
+      sc.control().render();
+
+      if (sg)
+      {
+        glPushMatrix();
+        glMultMatrixf(gc_state.get_matrix().matrix);
+        sg->draw(SceneContext::CONTROLMAP);
+        glPopMatrix();
+      }
+    }
+
+    Display::pop_framebuffer();
+  }
+
+  if (1) 
+  {
+    // Render the screen framebuffer to the actual screen 
+    OpenGLState state;
+
+    //static_cast<float>(m_screen.get_width()),
+    //static_cast<float>(m_screen.get_height()));
+
+    state.bind_texture(m_screen.get_texture(), 0);
+
+    state.activate();
+
+    glBegin(GL_QUADS);
+    {
+      glTexCoord2i(0, 1);
+      glVertex2i(0, 0);
+
+      glTexCoord2i(1, 1);
+      glVertex2i(m_viewport.width, 0);
+
+      glTexCoord2i(1, 0);
+      glVertex2i(m_viewport.width, m_viewport.height);
+
+      glTexCoord2i(0, 0);
+      glVertex2i(0.0f, m_viewport.height);
+    }
+    glEnd();
+  }
+
+  // Clear all DrawingContexts
+  sc.color().clear();
+  sc.light().clear();
+  sc.highlight().clear();
+  sc.control().clear();
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/display/framebuffer_compositor_impl.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/display/framebuffer_compositor_impl.hpp
===================================================================
--- trunk/windstille/src/display/framebuffer_compositor_impl.hpp	2009-09-03 15:14:04 UTC (rev 3191)
+++ trunk/windstille/src/display/framebuffer_compositor_impl.hpp	2009-09-03 16:01:56 UTC (rev 3192)
@@ -0,0 +1,46 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_DISPLAY_FRAMEBUFFER_COMPOSITOR_IMPL_HPP
+#define HEADER_WINDSTILLE_DISPLAY_FRAMEBUFFER_COMPOSITOR_IMPL_HPP
+
+#include "display/framebuffer.hpp"
+#include "display/compositor_impl.hpp"
+
+class FramebufferCompositorImpl : public CompositorImpl
+{
+private:
+  Framebuffer m_screen;
+  Framebuffer m_lightmap;   
+
+public:
+  FramebufferCompositorImpl(const Size& window, const Size& viewport);
+
+  void render(SceneContext& sc, SceneGraph* sg, const GraphicContextState& state);
+
+private:
+  void render_lightmap(SceneContext& /*sc*/, SceneGraph* /*sg*/);
+
+private:
+  FramebufferCompositorImpl(const FramebufferCompositorImpl&);
+  FramebufferCompositorImpl& operator=(const FramebufferCompositorImpl&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/display/framebuffer_compositor_impl.hpp
___________________________________________________________________
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Thu Sep  3 18:11:58 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 3 Sep 2009 18:11:58 +0200
Subject: [Windstille-commit] r3193 - trunk/windstille/src/display
Message-ID: <200909031611.n83GBwo2031629@sheep.berlios.de>

Author: grumbel
Date: 2009-09-03 18:11:58 +0200 (Thu, 03 Sep 2009)
New Revision: 3193

Modified:
   trunk/windstille/src/display/basic_compositor_impl.cpp
   trunk/windstille/src/display/framebuffer_compositor_impl.cpp
Log:
Minor cleanup

Modified: trunk/windstille/src/display/basic_compositor_impl.cpp
===================================================================
--- trunk/windstille/src/display/basic_compositor_impl.cpp	2009-09-03 16:01:56 UTC (rev 3192)
+++ trunk/windstille/src/display/basic_compositor_impl.cpp	2009-09-03 16:11:58 UTC (rev 3193)
@@ -52,7 +52,6 @@
     glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
 
     glPushMatrix();
-    //glTranslatef(0.0f, static_cast<float>(m_viewport.height) - static_cast<float>(m_window.height/LIGHTMAP_DIV), 0.0f);
     glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f);
     sc.light().render();
     glPopMatrix();
@@ -60,7 +59,6 @@
     if (sg)
     {
       glPushMatrix();
-      //glTranslatef(0.0f, static_cast<float>(m_viewport.height) - static_cast<float>(m_window.height/LIGHTMAP_DIV), 0.0f);
       glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f);
       glMultMatrixf(gc_state.get_matrix().matrix);
       sg->draw(SceneContext::LIGHTMAP);
@@ -70,15 +68,14 @@
     { // Copy lightmap to a texture
       OpenGLState state;
         
-      // Weird y-pos is needed since OpenGL is upside down when it comes to y-coordinate
       state.bind_texture(m_lightmap.get_texture());
       state.activate();
 
       glCopyTexSubImage2D(GL_TEXTURE_2D, 
-                          0, // level
+                          0,    // mipmap level
                           0, 0, // xoffset, yoffset
-                          0, 
-                          m_window.height - static_cast<GLsizei>(m_lightmap.get_height()),
+                          0, // x
+                          m_window.height - static_cast<GLsizei>(m_lightmap.get_height()), // y (OpenGL is upside down)
                           static_cast<GLsizei>(m_lightmap.get_width()), 
                           static_cast<GLsizei>(m_lightmap.get_height()));
     }

Modified: trunk/windstille/src/display/framebuffer_compositor_impl.cpp
===================================================================
--- trunk/windstille/src/display/framebuffer_compositor_impl.cpp	2009-09-03 16:01:56 UTC (rev 3192)
+++ trunk/windstille/src/display/framebuffer_compositor_impl.cpp	2009-09-03 16:11:58 UTC (rev 3193)
@@ -64,8 +64,6 @@
 void
 FramebufferCompositorImpl::render(SceneContext& sc, SceneGraph* sg, const GraphicContextState& gc_state)
 {
-  glClear(GL_DEPTH_BUFFER_BIT);
-      
   if (sc.get_render_mask() & SceneContext::LIGHTMAPSCREEN)
   {
     // Render the lightmap to framebuffers->lightmap
@@ -77,6 +75,7 @@
     glPushMatrix();
     glTranslatef(0.0f, static_cast<float>(m_viewport.height - (m_viewport.height / LIGHTMAP_DIV)), 0.0f);
     glScalef(1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV, 1.0f / LIGHTMAP_DIV);
+
     sc.light().render();
 
     if (sg)
@@ -100,6 +99,7 @@
       // Render the colormap to framebuffers->screen
       glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
       glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
+
       sc.color().render();
 
       if (sg)
@@ -150,9 +150,6 @@
     // Render the screen framebuffer to the actual screen 
     OpenGLState state;
 
-    //static_cast<float>(m_screen.get_width()),
-    //static_cast<float>(m_screen.get_height()));
-
     state.bind_texture(m_screen.get_texture(), 0);
 
     state.activate();



From grumbel at mail.berlios.de  Thu Sep  3 21:45:59 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 3 Sep 2009 21:45:59 +0200
Subject: [Windstille-commit] r3194 - trunk/windstille/src/editor
Message-ID: <200909031945.n83JjxDT003583@sheep.berlios.de>

Author: grumbel
Date: 2009-09-03 21:45:58 +0200 (Thu, 03 Sep 2009)
New Revision: 3194

Modified:
   trunk/windstille/src/editor/sector_model.cpp
Log:
Output a warning on unknown objects

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-03 16:11:58 UTC (rev 3193)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-03 19:45:58 UTC (rev 3194)
@@ -361,30 +361,28 @@
   reader.get("locked",  locked);
   reader.get("objects", objects_reader);
 
-  //std::cout << "loading layer: " << reader.get_name() << " " << name << " " << visible << " " << locked << std::endl;
-
   LayerHandle layer = LayerHandle(new Layer());
 
   const std::vector<FileReader>& objects_sections = objects_reader.get_sections();
   for(std::vector<FileReader>::const_iterator j = objects_sections.begin(); j != objects_sections.end(); ++j)
-    {
-      ObjectModelHandle obj = ObjectModelFactory::create(*j);
+  {
+    ObjectModelHandle obj = ObjectModelFactory::create(*j);
 
-      layer->add(obj);
+    layer->add(obj);
 
-      std::string id_str;
-      if (j->read("id", id_str))
-        {
-          id_table[id_str] = obj;
-        }
+    std::string id_str;
+    if (j->read("id", id_str))
+    {
+      id_table[id_str] = obj;
+    }
 
-      std::string parent_str;
-      if (j->read("parent", parent_str))
-        {
-          if (!parent_str.empty())
-            parent_table[obj] = parent_str;
-        }
+    std::string parent_str;
+    if (j->read("parent", parent_str))
+    {
+      if (!parent_str.empty())
+        parent_table[obj] = parent_str;
     }
+  }
 
   // Append the layer to the tree
   Gtk::ListStore::iterator it = layer_tree->append();
@@ -405,48 +403,55 @@
 
   std::ifstream stream(filename.c_str());
   if (!stream)
-    {
-      throw std::runtime_error("File not found " + filename);
-    }
+  {
+    throw std::runtime_error("File not found " + filename);
+  }
   else
+  {
+    std::map<std::string, ObjectModelHandle> id_table;
+    std::map<ObjectModelHandle, std::string> parent_table;
+
+    FileReader reader = FileReader::parse(stream, filename);
+    if (reader.get_name() == "windstille-sector")
     {
-      std::map<std::string, ObjectModelHandle> id_table;
-      std::map<ObjectModelHandle, std::string> parent_table;
+      ambient_color = Color(0,0,0,1);
+      reader.get("ambient-color", ambient_color);
 
-      FileReader reader = FileReader::parse(stream, filename);
-      if (reader.get_name() == "windstille-sector")
-        {
-          ambient_color = Color(0,0,0,1);
-          reader.get("ambient-color", ambient_color);
+      FileReader navigation_section;
+      reader.get("navigation", navigation_section);
+      nav_graph->load(navigation_section);
 
-          FileReader navigation_section;
-          reader.get("navigation", navigation_section);
-          nav_graph->load(navigation_section);
+      FileReader layers_section;
+      reader.get("objects", layers_section);
 
-          FileReader layers_section;
-          reader.get("objects", layers_section);
-
-          const std::vector<FileReader>& sections = layers_section.get_sections();
-          for(std::vector<FileReader>::const_iterator i = sections.begin(); i != sections.end(); ++i)
-            {
-              load_layer(*i, id_table, parent_table);
-            }
+      const std::vector<FileReader>& sections = layers_section.get_sections();
+      for(std::vector<FileReader>::const_iterator i = sections.begin(); i != sections.end(); ++i)
+      {
+        if (i->get_name() == "layer")
+        {
+          load_layer(*i, id_table, parent_table);
+        }
+        else
+        {
+          std::cout << "SectorModel::load: ignoring unknown type '" << i->get_name() << "'" << std::endl;
+        }
+      }
           
-          // Set the parents properly
-          for(std::map<ObjectModelHandle, std::string>::iterator i = parent_table.begin(); i != parent_table.end(); ++i)
-            {
-              std::map<std::string, ObjectModelHandle>::iterator j = id_table.find(i->second);
-              if (j == id_table.end())
-                {
-                  std::cout << "Error: Couldn't resolve 'id': " << i->second << std::endl;
-                }
-              else
-                {
-                  i->first->set_parent(j->second, false);
-                }
-            }
+      // Set the parents properly
+      for(std::map<ObjectModelHandle, std::string>::iterator i = parent_table.begin(); i != parent_table.end(); ++i)
+      {
+        std::map<std::string, ObjectModelHandle>::iterator j = id_table.find(i->second);
+        if (j == id_table.end())
+        {
+          std::cout << "Error: Couldn't resolve 'id': " << i->second << std::endl;
         }
+        else
+        {
+          i->first->set_parent(j->second, false);
+        }
+      }
     }
+  }
 }
 
 void



From grumbel at mail.berlios.de  Fri Sep  4 14:59:08 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 4 Sep 2009 14:59:08 +0200
Subject: [Windstille-commit] r3195 - in trunk/windstille/src: editor
	scenegraph
Message-ID: <200909041259.n84Cx8GR006978@sheep.berlios.de>

Author: grumbel
Date: 2009-09-04 14:59:05 +0200 (Fri, 04 Sep 2009)
New Revision: 3195

Modified:
   trunk/windstille/src/editor/decal_object_model.cpp
   trunk/windstille/src/editor/decal_object_model.hpp
   trunk/windstille/src/editor/layer.cpp
   trunk/windstille/src/editor/layer.hpp
   trunk/windstille/src/editor/object_model.hpp
   trunk/windstille/src/editor/object_model_factory.hpp
   trunk/windstille/src/editor/particle_system_object_model.hpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sprite_object_model.hpp
   trunk/windstille/src/editor/windstille_widget.cpp
   trunk/windstille/src/scenegraph/scene_graph.cpp
   trunk/windstille/src/scenegraph/surface_quad_drawable.hpp
Log:
Use SceneGraph in the editor, breaks some stuff

Modified: trunk/windstille/src/editor/decal_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.cpp	2009-09-03 19:45:58 UTC (rev 3194)
+++ trunk/windstille/src/editor/decal_object_model.cpp	2009-09-04 12:59:05 UTC (rev 3195)
@@ -22,9 +22,13 @@
 #include "display/surface.hpp"
 #include "display/drawing_parameters.hpp"
 #include "display/surface_drawing_parameters.hpp"
+#include "display/surface_drawing_parameters.hpp"
 #include "display/scene_context.hpp"
 #include "editor/decal_scale_control_point.hpp"
 #include "editor/decal_rotate_control_point.hpp"
+#include "scenegraph/surface_quad_drawable.hpp"
+#include "scenegraph/scene_graph.hpp"
+#include "editor/sector_model.hpp"
 
 #include "editor/decal_object_model.hpp"
 
@@ -44,7 +48,8 @@
     scale(1.0f, 1.0f),
     angle(0.0f),
     hflip(false),
-    vflip(false)
+    vflip(false),
+    m_drawable()
 {
   int map_type = 0;
   reader.get("path", path);
@@ -69,7 +74,8 @@
     scale(1.0f, 1.0f),
     angle(0.0f),
     hflip(false),
-    vflip(false)
+    vflip(false),
+    m_drawable()
 {
 }
 
@@ -81,6 +87,7 @@
 DecalObjectModel::set_angle(float angle_)
 {
   angle = angle_;
+  sync();
 }
 
 void
@@ -91,6 +98,7 @@
   // Disallow negative scale
   scale.x = fabsf(scale.x);
   scale.y = fabsf(scale.y);
+  sync();
 }
 
 void
@@ -109,30 +117,33 @@
 void
 DecalObjectModel::draw(SceneContext& sc)
 {
-  ObjectModel::draw(sc);
+  if (0)
+  {
+    ObjectModel::draw(sc);
 
-  Vector2f wo_pos = get_world_pos();
-  Vector2f center_offset(-surface.get_width()/2,
-                         -surface.get_height()/2);
+    Vector2f wo_pos = get_world_pos();
+    Vector2f center_offset(-surface.get_width()/2,
+                           -surface.get_height()/2);
 
-  DrawingContext* dc = 0; 
-  SurfaceDrawingParameters params;
-  switch(type)
+    DrawingContext* dc = 0; 
+    SurfaceDrawingParameters params;
+    switch(type)
     {
       case COLORMAP:     dc = &sc.color(); break;
       case LIGHTMAP:     dc = &sc.light();     params.set_blend_func(GL_SRC_ALPHA, GL_ONE); break;
       case HIGHLIGHTMAP: dc = &sc.highlight(); params.set_blend_func(GL_SRC_ALPHA, GL_ONE); break;
     }
 
-  center_offset.x *= scale.x;
-  center_offset.y *= scale.y;
+    center_offset.x *= scale.x;
+    center_offset.y *= scale.y;
 
-  dc->draw(surface, params
-           .set_pos(wo_pos + center_offset)
-           .set_angle(angle)
-           .set_hflip(hflip)
-           .set_vflip(vflip)
-           .set_scale(scale));
+    dc->draw(surface, params
+             .set_pos(wo_pos + center_offset)
+             .set_angle(angle)
+             .set_hflip(hflip)
+             .set_vflip(vflip)
+             .set_scale(scale));
+  }
 }
 
 Rectf
@@ -241,4 +252,53 @@
   control_points.push_back(ControlPointHandle(new DecalRotateControlPoint(this, angle + 3*math::pi/2, get_world_pos() + quad2.p4)));
 }
 
+void
+DecalObjectModel::add_to_sector(SectorModel& sector)
+{
+  m_drawable.reset(new SurfaceQuadDrawable(surface, Vector2f(), Quad(get_bounding_box()),
+                                           DrawingParameters(), 0.0f,
+                                           Matrix::identity()));
+  sector.get_scene_graph()->add_drawable(m_drawable);
+  std::cout << "DecalObjectModel::add_to_sector(SectorModel& sector)" << std::endl;
+}
+
+void
+DecalObjectModel::remove_from_sector(SectorModel& sector)
+{
+  sector.get_scene_graph()->remove_drawable(m_drawable);
+  std::cout << "DecalObjectModel::remove_from_sector(SectorModel& sector)" << std::endl;
+}
+
+void
+DecalObjectModel::sync()
+{
+  if (m_drawable)
+  {
+    Quad quad(get_bounding_box());
+    quad.rotate(angle);
+    m_drawable->set_quad(quad);
+  }
+}
+
+void
+DecalObjectModel::set_world_pos(const Vector2f& p)
+{
+  ObjectModel::set_world_pos(p);
+  sync();
+}
+
+void
+DecalObjectModel::set_rel_pos(const Vector2f& rel_pos_)
+{
+  ObjectModel::set_rel_pos(rel_pos_);
+  sync();
+}
+
+void
+DecalObjectModel::set_select_mask(const SelectMask& select_mask_)
+{
+  ObjectModel::set_select_mask(select_mask_);
+  sync();
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/decal_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.hpp	2009-09-03 19:45:58 UTC (rev 3194)
+++ trunk/windstille/src/editor/decal_object_model.hpp	2009-09-04 12:59:05 UTC (rev 3195)
@@ -24,6 +24,8 @@
 #include "display/surface.hpp"
 #include "display/software_surface.hpp"
 #include "editor/object_model.hpp"
+
+class SurfaceQuadDrawable;
 
 class DecalObjectModel : public ObjectModel
 {
@@ -46,6 +48,8 @@
   bool hflip;
   bool vflip;
 
+  boost::shared_ptr<SurfaceQuadDrawable> m_drawable;
+
 public:
   DecalObjectModel(const FileReader& reader);
   DecalObjectModel(const std::string& name, const Vector2f& rel_pos, 
@@ -78,6 +82,14 @@
   void reset();
 
   void add_control_points(std::vector<ControlPointHandle>& control_points);
+
+  void add_to_sector(SectorModel& sector);
+  void remove_from_sector(SectorModel& sector);
+  void sync();
+
+  void set_world_pos(const Vector2f& p);
+  void set_rel_pos(const Vector2f& rel_pos_);
+  void set_select_mask(const SelectMask& select_mask_);
 };
 
 #endif

Modified: trunk/windstille/src/editor/layer.cpp
===================================================================
--- trunk/windstille/src/editor/layer.cpp	2009-09-03 19:45:58 UTC (rev 3194)
+++ trunk/windstille/src/editor/layer.cpp	2009-09-04 12:59:05 UTC (rev 3195)
@@ -20,8 +20,9 @@
 
 #include "editor/sector_model.hpp"
 
-Layer::Layer()
-  : objects(),
+Layer::Layer(SectorModel& sector)
+  : m_sector(sector),
+    objects(),
     name(),
     visible(true),
     locked(false)
@@ -42,12 +43,14 @@
 Layer::add(const ObjectModelHandle& object)
 {
   objects.push_back(object);
+  object->add_to_sector(m_sector);
 }
 
 void
 Layer::remove(const ObjectModelHandle& object)
 {
   objects.remove(object);
+  object->remove_from_sector(m_sector);
 }
 
 void

Modified: trunk/windstille/src/editor/layer.hpp
===================================================================
--- trunk/windstille/src/editor/layer.hpp	2009-09-03 19:45:58 UTC (rev 3194)
+++ trunk/windstille/src/editor/layer.hpp	2009-09-04 12:59:05 UTC (rev 3195)
@@ -31,6 +31,7 @@
 private:
   typedef std::list<ObjectModelHandle> Objects;
 
+  SectorModel& m_sector;
   Objects objects;
   std::string name;
   bool visible;
@@ -39,7 +40,7 @@
 public:
   typedef Objects::iterator iterator;
 
-  Layer();
+  Layer(SectorModel& sector);
   ~Layer();
   
   void set_row_ptr(Gtk::TreeModel::Row* row_ptr);

Modified: trunk/windstille/src/editor/object_model.hpp
===================================================================
--- trunk/windstille/src/editor/object_model.hpp	2009-09-03 19:45:58 UTC (rev 3194)
+++ trunk/windstille/src/editor/object_model.hpp	2009-09-04 12:59:05 UTC (rev 3195)
@@ -29,6 +29,7 @@
 class ObjectModel;
 class FileReader;
 class SceneContext;
+class SectorModel;
 typedef boost::shared_ptr<ObjectModel> ObjectModelHandle;
 typedef boost::weak_ptr<ObjectModel>   ObjectModelPtr;
 
@@ -52,15 +53,15 @@
   std::string get_name() const { return name; }
   std::string get_id() const;
 
-  Vector2f get_world_pos() const;
-  void set_world_pos(const Vector2f& p);
+  virtual Vector2f get_world_pos() const;
+  virtual void set_world_pos(const Vector2f& p);
 
-  Vector2f get_rel_pos() const { return rel_pos; }
-  void     set_rel_pos(const Vector2f& rel_pos_);
+  virtual Vector2f get_rel_pos() const { return rel_pos; }
+  virtual void     set_rel_pos(const Vector2f& rel_pos_);
+  
+  virtual SelectMask get_select_mask() const { return select_mask; }
+  virtual void   set_select_mask(const SelectMask& select_mask_) { select_mask = select_mask_; }
 
-  SelectMask get_select_mask() const { return select_mask; }
-  void   set_select_mask(const SelectMask& select_mask_) { select_mask = select_mask_; }
-
   SnapData snap_object(const Rectf& rect) const;
 
   virtual bool get_hflip() const { return false; }
@@ -80,13 +81,19 @@
 
   virtual void draw(SceneContext& sc);
   virtual void update(float /*delta*/) {}
-  virtual Rectf get_bounding_box() const = 0;
+  virtual Rectf get_bounding_box() const =0;
   virtual ObjectModelHandle clone() const =0;
 
   virtual void write(FileWriter& writer) const =0;
   virtual FileWriter& write_member(FileWriter& writer) const;
 
-  virtual void add_control_points(std::vector<ControlPointHandle>& /*control_points*/) {}
+  virtual void add_control_points(std::vector<ControlPointHandle>& control_points) {}
+  
+  /** This lets the object add things to the SceneGraph or do other
+      things needed to make it properly visible in the SectorModel */
+  virtual void add_to_sector(SectorModel& sector)    =0;
+
+  virtual void remove_from_sector(SectorModel& sector) =0;
 };
 
 #endif

Modified: trunk/windstille/src/editor/object_model_factory.hpp
===================================================================
--- trunk/windstille/src/editor/object_model_factory.hpp	2009-09-03 19:45:58 UTC (rev 3194)
+++ trunk/windstille/src/editor/object_model_factory.hpp	2009-09-04 12:59:05 UTC (rev 3195)
@@ -22,6 +22,7 @@
 #include "editor/object_model.hpp"
 
 class FileReader;
+class SectorModel;
 
 class ObjectModelFactory
 {

Modified: trunk/windstille/src/editor/particle_system_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/particle_system_object_model.hpp	2009-09-03 19:45:58 UTC (rev 3194)
+++ trunk/windstille/src/editor/particle_system_object_model.hpp	2009-09-04 12:59:05 UTC (rev 3195)
@@ -41,6 +41,9 @@
 
   void write(FileWriter& writer) const;
 
+  void add_to_sector(SectorModel& sector) {}
+  void remove_from_sector(SectorModel& sector) {}
+
 private:
   ParticleSystemObjectModel(const ParticleSystemObjectModel&);
   ParticleSystemObjectModel& operator=(const ParticleSystemObjectModel&);

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-03 19:45:58 UTC (rev 3194)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-04 12:59:05 UTC (rev 3195)
@@ -46,7 +46,7 @@
 
   Gtk::ListStore::iterator it = layer_tree->append();
 
-  LayerHandle layer(new Layer());
+  LayerHandle layer(new Layer(*this));
   (*it)[LayerManagerColumns::instance().type_icon] = Gdk::Pixbuf::create_from_file("data/editor/type.png");
   (*it)[LayerManagerColumns::instance().name]      = Glib::ustring("Scene");
   (*it)[LayerManagerColumns::instance().visible]   = true;
@@ -92,7 +92,7 @@
   else
     it = layer_tree->insert(layer_tree->get_iter(path));
 
-  LayerHandle layer(new Layer());
+  LayerHandle layer(new Layer(*this));
   (*it)[LayerManagerColumns::instance().type_icon] = Gdk::Pixbuf::create_from_file("data/editor/type.png");
   (*it)[LayerManagerColumns::instance().name]      = name;
   (*it)[LayerManagerColumns::instance().visible]   = true; 
@@ -137,8 +137,22 @@
     { 
       Gtk::ListStore::iterator it = layer_tree->get_iter(path);
       ((LayerHandle)(*it)[LayerManagerColumns::instance().layer])->add(object);
+      object->add_to_sector(*this);
     }
 }
+
+void
+SectorModel::remove(const ObjectModelHandle& object)
+{
+  const Layers& layers = get_layers();
+ 
+  for(Layers::const_reverse_iterator i = layers.rbegin(); i != layers.rend(); ++i)
+    {
+      (*i)->remove(object);
+    }
+
+  object->remove_from_sector(*this);
+}
 
 struct GetLayersFunctor
 {
@@ -185,17 +199,6 @@
     }
 }
 
-void
-SectorModel::remove(const ObjectModelHandle& object)
-{
-  const Layers& layers = get_layers();
- 
-  for(Layers::const_reverse_iterator i = layers.rbegin(); i != layers.rend(); ++i)
-    {
-      (*i)->remove(object);
-    }
-}
-
 LayerHandle
 SectorModel::get_layer(const ObjectModelHandle& object) const
 {
@@ -361,26 +364,33 @@
   reader.get("locked",  locked);
   reader.get("objects", objects_reader);
 
-  LayerHandle layer = LayerHandle(new Layer());
+  LayerHandle layer = LayerHandle(new Layer(*this));
 
   const std::vector<FileReader>& objects_sections = objects_reader.get_sections();
   for(std::vector<FileReader>::const_iterator j = objects_sections.begin(); j != objects_sections.end(); ++j)
   {
-    ObjectModelHandle obj = ObjectModelFactory::create(*j);
+    try 
+    {
+      ObjectModelHandle obj = ObjectModelFactory::create(*j);
 
-    layer->add(obj);
+      layer->add(obj);
 
-    std::string id_str;
-    if (j->read("id", id_str))
-    {
-      id_table[id_str] = obj;
+      std::string id_str;
+      if (j->read("id", id_str))
+      {
+        id_table[id_str] = obj;
+      }
+
+      std::string parent_str;
+      if (j->read("parent", parent_str))
+      {
+        if (!parent_str.empty())
+          parent_table[obj] = parent_str;
+      }
     }
-
-    std::string parent_str;
-    if (j->read("parent", parent_str))
+    catch(std::exception& err)
     {
-      if (!parent_str.empty())
-        parent_table[obj] = parent_str;
+      std::cout << "SectorModel::load_layer: " << err.what() << std::endl;
     }
   }
 

Modified: trunk/windstille/src/editor/sprite_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/sprite_object_model.hpp	2009-09-03 19:45:58 UTC (rev 3194)
+++ trunk/windstille/src/editor/sprite_object_model.hpp	2009-09-04 12:59:05 UTC (rev 3195)
@@ -38,6 +38,9 @@
   Rectf get_bounding_box() const;
   ObjectModelHandle clone() const;
   void write(FileWriter& writer) const;
+
+  void add_to_sector(SectorModel& sector) {}
+  void remove_from_sector(SectorModel& sector) {}
 };
 
 #endif

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-03 19:45:58 UTC (rev 3194)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-04 12:59:05 UTC (rev 3195)
@@ -264,7 +264,6 @@
 void
 WindstilleWidget::draw()
 {
-  //std::cout << "Draw" << std::endl;
   if (sc.get())
     {
       state.push(*sc);

Modified: trunk/windstille/src/scenegraph/scene_graph.cpp
===================================================================
--- trunk/windstille/src/scenegraph/scene_graph.cpp	2009-09-03 19:45:58 UTC (rev 3194)
+++ trunk/windstille/src/scenegraph/scene_graph.cpp	2009-09-04 12:59:05 UTC (rev 3195)
@@ -32,9 +32,11 @@
 }
 
 void
-SceneGraph::remove_drawable(boost::shared_ptr<Drawable> /*drawable*/)
+SceneGraph::remove_drawable(boost::shared_ptr<Drawable> drawable)
 {
-  // FIXME: implement me
+  Drawables::iterator i = std::find(m_drawables.begin(), m_drawables.end(), drawable);
+  if (i != m_drawables.end())
+    m_drawables.erase(i);
 }
 
 void

Modified: trunk/windstille/src/scenegraph/surface_quad_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/surface_quad_drawable.hpp	2009-09-03 19:45:58 UTC (rev 3194)
+++ trunk/windstille/src/scenegraph/surface_quad_drawable.hpp	2009-09-04 12:59:05 UTC (rev 3195)
@@ -21,23 +21,24 @@
 
 #include "math/vector2f.hpp"
 #include "math/quad.hpp"
+#include "display/opengl_state.hpp"
 #include "scenegraph/drawable.hpp"
 
 class SurfaceQuadDrawable : public Drawable
 {
 private:
-  Surface surface;
-  Quad quad;
-  DrawingParameters params;
+  Surface m_surface;
+  Quad m_quad;
+  DrawingParameters m_params;
 
 public:
-  SurfaceQuadDrawable(Surface surface_, const Vector2f& pos_, const Quad& quad_, 
-                            const DrawingParameters& params_, float z_pos_,
-                            const Matrix& modelview_)
+  SurfaceQuadDrawable(Surface surface, const Vector2f& pos_, const Quad& quad, 
+                      const DrawingParameters& params, float z_pos_,
+                      const Matrix& modelview_)
     : Drawable(pos_, z_pos_, modelview_),
-      surface(surface_),
-      quad(quad_),
-      params(params_)
+      m_surface(surface),
+      m_quad(quad),
+      m_params(params)
   {
   }
 
@@ -45,8 +46,8 @@
   {
     OpenGLState state;
     state.enable(GL_BLEND);
-    state.set_blend_func(params.blendfunc_src, params.blendfunc_dst);
-    state.bind_texture(surface.get_texture());
+    state.set_blend_func(m_params.blendfunc_src, m_params.blendfunc_dst);
+    state.bind_texture(m_surface.get_texture());
     state.activate();
 
     glPushMatrix();
@@ -54,22 +55,24 @@
 
     glBegin(GL_QUADS);
     {
-      glTexCoord2f(surface.get_uv().left, surface.get_uv().top);
-      glVertex2f(pos.x + quad.p1.x, pos.y + quad.p1.y);
+      glTexCoord2f(m_surface.get_uv().left, m_surface.get_uv().top);
+      glVertex2f(pos.x + m_quad.p1.x, pos.y + m_quad.p1.y);
     
-      glTexCoord2f(surface.get_uv().right, surface.get_uv().top);
-      glVertex2f(pos.x + quad.p2.x, pos.y + quad.p2.y);
+      glTexCoord2f(m_surface.get_uv().right, m_surface.get_uv().top);
+      glVertex2f(pos.x + m_quad.p2.x, pos.y + m_quad.p2.y);
 
-      glTexCoord2f(surface.get_uv().right, surface.get_uv().bottom);
-      glVertex2f(pos.x + quad.p3.x, pos.y + quad.p3.y);
+      glTexCoord2f(m_surface.get_uv().right, m_surface.get_uv().bottom);
+      glVertex2f(pos.x + m_quad.p3.x, pos.y + m_quad.p3.y);
 
-      glTexCoord2f(surface.get_uv().left, surface.get_uv().bottom);
-      glVertex2f(pos.x + quad.p4.x, pos.y + quad.p4.y);
+      glTexCoord2f(m_surface.get_uv().left, m_surface.get_uv().bottom);
+      glVertex2f(pos.x + m_quad.p4.x, pos.y + m_quad.p4.y);
     }
     glEnd();
 
     glPopMatrix();    
   }
+
+  void set_quad(const Quad& quad) { m_quad = quad; }
 };
 
 #endif



From grumbel at mail.berlios.de  Sun Sep  6 18:58:26 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sun, 6 Sep 2009 18:58:26 +0200
Subject: [Windstille-commit] r3196 - in trunk/windstille/src: editor
	scenegraph
Message-ID: <200909061658.n86GwQxK030428@sheep.berlios.de>

Author: grumbel
Date: 2009-09-06 18:58:23 +0200 (Sun, 06 Sep 2009)
New Revision: 3196

Modified:
   trunk/windstille/src/editor/decal_object_model.cpp
   trunk/windstille/src/editor/layer.cpp
   trunk/windstille/src/editor/layer.hpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
   trunk/windstille/src/scenegraph/scene_graph.cpp
   trunk/windstille/src/scenegraph/scene_graph.hpp
Log:
Rebuild SceneGraph after object or layer order has been changed

Modified: trunk/windstille/src/editor/decal_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.cpp	2009-09-04 12:59:05 UTC (rev 3195)
+++ trunk/windstille/src/editor/decal_object_model.cpp	2009-09-06 16:58:23 UTC (rev 3196)
@@ -259,14 +259,14 @@
                                            DrawingParameters(), 0.0f,
                                            Matrix::identity()));
   sector.get_scene_graph()->add_drawable(m_drawable);
-  std::cout << "DecalObjectModel::add_to_sector(SectorModel& sector)" << std::endl;
+  //std::cout << "DecalObjectModel::add_to_sector(SectorModel& sector)" << std::endl;
 }
 
 void
 DecalObjectModel::remove_from_sector(SectorModel& sector)
 {
   sector.get_scene_graph()->remove_drawable(m_drawable);
-  std::cout << "DecalObjectModel::remove_from_sector(SectorModel& sector)" << std::endl;
+  //std::cout << "DecalObjectModel::remove_from_sector(SectorModel& sector)" << std::endl;
 }
 
 void

Modified: trunk/windstille/src/editor/layer.cpp
===================================================================
--- trunk/windstille/src/editor/layer.cpp	2009-09-04 12:59:05 UTC (rev 3195)
+++ trunk/windstille/src/editor/layer.cpp	2009-09-06 16:58:23 UTC (rev 3196)
@@ -116,6 +116,7 @@
 {
   objects.remove(object);
   objects.push_back(object); 
+  m_sector.rebuild_scene_graph();
 }
 
 void
@@ -123,6 +124,7 @@
 {
   objects.remove(object);
   objects.push_front(object); 
+  m_sector.rebuild_scene_graph();
 }
 
 struct OverlapsWith
@@ -155,6 +157,8 @@
     {
       objects.erase(i);
       objects.insert(++j, object);
+      
+      m_sector.rebuild_scene_graph();
     }
 }
 
@@ -179,6 +183,8 @@
       // position
       objects.erase(--(i.base()));
       objects.insert(--(j.base()), object);
+
+      m_sector.rebuild_scene_graph();
     }
 }
 
@@ -212,11 +218,5 @@
       (*i)->write(writer);
     }
 }
-
-LayerHandle
-Layer::clone() const
-{
-  return LayerHandle();
-}
 
 /* EOF */

Modified: trunk/windstille/src/editor/layer.hpp
===================================================================
--- trunk/windstille/src/editor/layer.hpp	2009-09-04 12:59:05 UTC (rev 3195)
+++ trunk/windstille/src/editor/layer.hpp	2009-09-06 16:58:23 UTC (rev 3196)
@@ -39,6 +39,7 @@
     
 public:
   typedef Objects::iterator iterator;
+  typedef Objects::const_iterator const_iterator;
 
   Layer(SectorModel& sector);
   ~Layer();
@@ -48,6 +49,9 @@
   iterator begin() { return objects.begin(); }
   iterator end()   { return objects.end(); }
 
+  const_iterator begin() const { return objects.begin(); }
+  const_iterator end()   const { return objects.end(); }
+
   void set_name(const std::string& str) { name = str; }
   std::string get_name() const { return name; }
 
@@ -79,8 +83,6 @@
 
   void write(FileWriter& writer) const;
 
-  LayerHandle clone() const;
-  
 private:
   Layer(const Layer&);
   Layer& operator=(const Layer&);

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-04 12:59:05 UTC (rev 3195)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-06 16:58:23 UTC (rev 3196)
@@ -537,6 +537,28 @@
   PropSetFunctor func(v);
   layer_tree->foreach_iter(sigc::mem_fun(func, &PropSetFunctor::set_locked));
 }
+
+void
+SectorModel::rebuild_scene_graph()
+{
+  scene_graph->clear();
+
+  const Layers& layers = get_layers();
+  for(Layers::const_iterator layer = layers.begin(); layer != layers.end(); ++layer)
+  {
+    if (*layer)
+    {
+      for(Layer::const_iterator obj = (*layer)->begin(); obj != (*layer)->end(); ++obj)
+      {
+        if ((*layer)->is_visible())
+        {
+          (*obj)->add_to_sector(*this);
+        }
+      }
+    }
+  }
+  queue_draw();
+}
 
 void
 SectorModel::queue_draw()
@@ -561,15 +583,14 @@
           layer->sync(*iter);
         }
     }
-
-  queue_draw();
+  rebuild_scene_graph();
 }
 
 void
 SectorModel::on_row_deleted(const Gtk::TreeModel::Path& /*path*/)
 {
-  //std::cout << "LayerManager:on_row_deleted" << std::endl;
-  queue_draw();
+  std::cout << "LayerManager:on_row_deleted" << std::endl;
+  rebuild_scene_graph();
 }
 
 void
@@ -581,13 +602,15 @@
 void
 SectorModel::on_row_inserted(const Gtk::TreeModel::Path& /*path*/, const Gtk::TreeModel::iterator& /*iter*/)
 {
-  //std::cout << "LayerManager:on_row_inserted" << std::endl;
+  std::cout << "LayerManager:on_row_inserted" << std::endl;
+  rebuild_scene_graph();
 }
 
 void
 SectorModel::on_rows_reordered(const Gtk::TreeModel::Path& /*path*/, const Gtk::TreeModel::iterator& /*iter*/, int* /*new_order*/)
 {
-  //std::cout << "LayerManager:on_row_reordered" << std::endl;
+  std::cout << "LayerManager:on_row_reordered" << std::endl;
+  rebuild_scene_graph();
 }
 
 /* EOF */

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-04 12:59:05 UTC (rev 3195)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-06 16:58:23 UTC (rev 3196)
@@ -138,6 +138,8 @@
 
   void queue_draw();
 
+  void rebuild_scene_graph();
+
 private:
   SectorModel(const SectorModel&);
   SectorModel& operator=(const SectorModel&);

Modified: trunk/windstille/src/scenegraph/scene_graph.cpp
===================================================================
--- trunk/windstille/src/scenegraph/scene_graph.cpp	2009-09-04 12:59:05 UTC (rev 3195)
+++ trunk/windstille/src/scenegraph/scene_graph.cpp	2009-09-06 16:58:23 UTC (rev 3196)
@@ -40,6 +40,12 @@
 }
 
 void
+SceneGraph::clear()
+{
+  m_drawables.clear();
+}
+
+void
 SceneGraph::draw(unsigned int mask)
 {
   for(Drawables::iterator i = m_drawables.begin(); i != m_drawables.end(); ++i)

Modified: trunk/windstille/src/scenegraph/scene_graph.hpp
===================================================================
--- trunk/windstille/src/scenegraph/scene_graph.hpp	2009-09-04 12:59:05 UTC (rev 3195)
+++ trunk/windstille/src/scenegraph/scene_graph.hpp	2009-09-06 16:58:23 UTC (rev 3196)
@@ -36,6 +36,8 @@
 
   void add_drawable(boost::shared_ptr<Drawable> drawable);
   void remove_drawable(boost::shared_ptr<Drawable> drawable);
+  
+  void clear();
 
   void draw(unsigned int mask);
 



From grumbel at mail.berlios.de  Mon Sep  7 17:45:24 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 7 Sep 2009 17:45:24 +0200
Subject: [Windstille-commit] r3197 - trunk/windstille/src/editor
Message-ID: <200909071545.n87FjOgo016061@sheep.berlios.de>

Author: grumbel
Date: 2009-09-07 17:45:23 +0200 (Mon, 07 Sep 2009)
New Revision: 3197

Modified:
   trunk/windstille/src/editor/decal_object_model.cpp
   trunk/windstille/src/editor/decal_object_model.hpp
   trunk/windstille/src/editor/layer.cpp
   trunk/windstille/src/editor/object_model.hpp
   trunk/windstille/src/editor/particle_system_object_model.hpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
   trunk/windstille/src/editor/sprite_object_model.hpp
Log:
Renamed add_to_sector() to add_to_scenegraph()

Modified: trunk/windstille/src/editor/decal_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.cpp	2009-09-06 16:58:23 UTC (rev 3196)
+++ trunk/windstille/src/editor/decal_object_model.cpp	2009-09-07 15:45:23 UTC (rev 3197)
@@ -253,23 +253,16 @@
 }
 
 void
-DecalObjectModel::add_to_sector(SectorModel& sector)
+DecalObjectModel::add_to_scenegraph(SceneGraph& sg)
 {
   m_drawable.reset(new SurfaceQuadDrawable(surface, Vector2f(), Quad(get_bounding_box()),
                                            DrawingParameters(), 0.0f,
                                            Matrix::identity()));
-  sector.get_scene_graph()->add_drawable(m_drawable);
-  //std::cout << "DecalObjectModel::add_to_sector(SectorModel& sector)" << std::endl;
+  sg.add_drawable(m_drawable);
+  //std::cout << "DecalObjectModel::add_to_scenegraph(SectorModel& sector)" << std::endl;
 }
 
 void
-DecalObjectModel::remove_from_sector(SectorModel& sector)
-{
-  sector.get_scene_graph()->remove_drawable(m_drawable);
-  //std::cout << "DecalObjectModel::remove_from_sector(SectorModel& sector)" << std::endl;
-}
-
-void
 DecalObjectModel::sync()
 {
   if (m_drawable)

Modified: trunk/windstille/src/editor/decal_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.hpp	2009-09-06 16:58:23 UTC (rev 3196)
+++ trunk/windstille/src/editor/decal_object_model.hpp	2009-09-07 15:45:23 UTC (rev 3197)
@@ -83,8 +83,7 @@
 
   void add_control_points(std::vector<ControlPointHandle>& control_points);
 
-  void add_to_sector(SectorModel& sector);
-  void remove_from_sector(SectorModel& sector);
+  void add_to_scenegraph(SceneGraph& sg);
   void sync();
 
   void set_world_pos(const Vector2f& p);

Modified: trunk/windstille/src/editor/layer.cpp
===================================================================
--- trunk/windstille/src/editor/layer.cpp	2009-09-06 16:58:23 UTC (rev 3196)
+++ trunk/windstille/src/editor/layer.cpp	2009-09-07 15:45:23 UTC (rev 3197)
@@ -43,14 +43,14 @@
 Layer::add(const ObjectModelHandle& object)
 {
   objects.push_back(object);
-  object->add_to_sector(m_sector);
+  m_sector.rebuild_scene_graph();
 }
 
 void
 Layer::remove(const ObjectModelHandle& object)
 {
   objects.remove(object);
-  object->remove_from_sector(m_sector);
+  m_sector.rebuild_scene_graph();
 }
 
 void

Modified: trunk/windstille/src/editor/object_model.hpp
===================================================================
--- trunk/windstille/src/editor/object_model.hpp	2009-09-06 16:58:23 UTC (rev 3196)
+++ trunk/windstille/src/editor/object_model.hpp	2009-09-07 15:45:23 UTC (rev 3197)
@@ -30,6 +30,8 @@
 class FileReader;
 class SceneContext;
 class SectorModel;
+class SceneGraph;
+
 typedef boost::shared_ptr<ObjectModel> ObjectModelHandle;
 typedef boost::weak_ptr<ObjectModel>   ObjectModelPtr;
 
@@ -91,9 +93,7 @@
   
   /** This lets the object add things to the SceneGraph or do other
       things needed to make it properly visible in the SectorModel */
-  virtual void add_to_sector(SectorModel& sector)    =0;
-
-  virtual void remove_from_sector(SectorModel& sector) =0;
+  virtual void add_to_scenegraph(SceneGraph& sg) =0;
 };
 
 #endif

Modified: trunk/windstille/src/editor/particle_system_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/particle_system_object_model.hpp	2009-09-06 16:58:23 UTC (rev 3196)
+++ trunk/windstille/src/editor/particle_system_object_model.hpp	2009-09-07 15:45:23 UTC (rev 3197)
@@ -41,8 +41,7 @@
 
   void write(FileWriter& writer) const;
 
-  void add_to_sector(SectorModel& sector) {}
-  void remove_from_sector(SectorModel& sector) {}
+  void add_to_scenegraph(SceneGraph& sg) {}
 
 private:
   ParticleSystemObjectModel(const ParticleSystemObjectModel&);

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-06 16:58:23 UTC (rev 3196)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-07 15:45:23 UTC (rev 3197)
@@ -137,7 +137,7 @@
     { 
       Gtk::ListStore::iterator it = layer_tree->get_iter(path);
       ((LayerHandle)(*it)[LayerManagerColumns::instance().layer])->add(object);
-      object->add_to_sector(*this);
+      rebuild_scene_graph();
     }
 }
 
@@ -150,8 +150,7 @@
     {
       (*i)->remove(object);
     }
-
-  object->remove_from_sector(*this);
+  rebuild_scene_graph();
 }
 
 struct GetLayersFunctor
@@ -541,6 +540,7 @@
 void
 SectorModel::rebuild_scene_graph()
 {
+  // FIXME: should make a queue_rebuild_scene_graph() to limit the number of rebuilds per frame to 1
   scene_graph->clear();
 
   const Layers& layers = get_layers();
@@ -552,7 +552,7 @@
       {
         if ((*layer)->is_visible())
         {
-          (*obj)->add_to_sector(*this);
+          (*obj)->add_to_scenegraph(*scene_graph);
         }
       }
     }

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-06 16:58:23 UTC (rev 3196)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-07 15:45:23 UTC (rev 3197)
@@ -56,7 +56,7 @@
   Gtk::TreeModelColumn<LayerHandle>                layer;
 
 private:
-  LayerManagerColumns() 
+  LayerManagerColumns()
     : type_icon(),
       name(),
       visible(),

Modified: trunk/windstille/src/editor/sprite_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/sprite_object_model.hpp	2009-09-06 16:58:23 UTC (rev 3196)
+++ trunk/windstille/src/editor/sprite_object_model.hpp	2009-09-07 15:45:23 UTC (rev 3197)
@@ -39,8 +39,7 @@
   ObjectModelHandle clone() const;
   void write(FileWriter& writer) const;
 
-  void add_to_sector(SectorModel& sector) {}
-  void remove_from_sector(SectorModel& sector) {}
+  void add_to_scenegraph(SceneGraph& sg) {}
 };
 
 #endif



From grumbel at mail.berlios.de  Mon Sep  7 17:46:38 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 7 Sep 2009 17:46:38 +0200
Subject: [Windstille-commit] r3198 - trunk/windstille
Message-ID: <200909071546.n87Fkcl1016262@sheep.berlios.de>

Author: grumbel
Date: 2009-09-07 17:46:38 +0200 (Mon, 07 Sep 2009)
New Revision: 3198

Modified:
   trunk/windstille/INSTALL
Log:
Some notes on hardware requirements

Modified: trunk/windstille/INSTALL
===================================================================
--- trunk/windstille/INSTALL	2009-09-07 15:45:23 UTC (rev 3197)
+++ trunk/windstille/INSTALL	2009-09-07 15:46:38 UTC (rev 3198)
@@ -1,6 +1,21 @@
 Windstille Compilation
 ======================
 
+Hardware Requirements
+=====================
+
+Minimal requirements are:
+
+ * Geforce2MX
+ * 1GHZ Athlon
+
+The game will not work with a MatroxG450 and hasn't been tested with
+ATI cards.
+
+
+Compilation
+===========
+
 To compile Windstille you need:
 
  * OpenAL



From grumbel at mail.berlios.de  Mon Sep  7 17:47:31 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 7 Sep 2009 17:47:31 +0200
Subject: [Windstille-commit] r3199 - in trunk/windstille: . src/editor
Message-ID: <200909071547.n87FlVNb016414@sheep.berlios.de>

Author: grumbel
Date: 2009-09-07 17:47:31 +0200 (Mon, 07 Sep 2009)
New Revision: 3199

Added:
   trunk/windstille/src/editor/navgraph_edge_object_model.cpp
   trunk/windstille/src/editor/navgraph_edge_object_model.hpp
   trunk/windstille/src/editor/navgraph_node_object_model.cpp
   trunk/windstille/src/editor/navgraph_node_object_model.hpp
Modified:
   trunk/windstille/TODO
Log:
Started with some bigger editor changes

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2009-09-07 15:46:38 UTC (rev 3198)
+++ trunk/windstille/TODO	2009-09-07 15:47:31 UTC (rev 3199)
@@ -10,20 +10,36 @@
 in the context of the whole game or if a potential performance
 enhanchment, actually enhanchmes anything at all.
 
+Editor Restructuring
+====================
+
+* NavigationGraph gets removed (maybe just temporarly, since it could
+  be needed for 'NavGraph snapping')
+
+* NavigationGraph is replaced with normal ObjectModel objects
+  (NavGraphNodeObjectModel, NavGraphEdgeObjectModel)
+
+* NavGraphEdgeObjectModel can be moved around across layers (this is
+  why it needs to be selectable)
+
+* NavGraphNodeObjectModel are somewhat special in that they show up
+  when their connected Edges shows up
+
+* NavGraphInsertTool needs to be rewritten
+
+* NavGraphSelectTool would become obsolote
+
 Overview
 ========
 
-* use control layer for NavGraph draving and other debug stuff
+* do demo sector with burning barrels, snow and steam, to get the
+  feeling of cold, could extend the trainstation to that
 
-* use SceneGraph in objects that already use VertexArray
-  (BackgroundGradient, Swarm)
+* Doll can get stuck in infinitive rolls (Sprite3D::switched_actions()
+  doesn't trigger properly or is missed)
 
-* need multiple render path:
+* use SceneGraph in objects that already use VertexArray (Swarm)
 
-  * MatrixG450: seems a lost cause, way to slow and only 16bit
-  * Geforce2MX: doesn't have Framebuffer object and shader
-  * Geforce???: has Framebuffer object and shader
-
 * use SceneGraph in the editor 
 
 * add z/layer ordering to NavGraph
@@ -53,17 +69,20 @@
   * jogging: 10 km/h
   * run:     20 km/h (1500m run)
   * run:     30 km/h (100m sprint)
+
+* current run animation, jump width, etc. should be meassured in a test level
 
 Pathname/PhysFS
 ===============
 
-* Pathname needs a way to browse directories (wrapper boost::filesystem)
-
 * Sound stuff still uses PhysFS, should be switched to std::ifstream
 
 SceneGraph
 ==========
 
+* Drawable::update(float delta): Do we need it? What exactly should it
+  do? Or should we do it via GameObject::update(float delta) { m_drawable->update(delta); }?
+
 * change the editor to use the SceneGraph instead of the SceneContext API
 
 * new levelformat use a different coordinate system then the old one
@@ -71,6 +90,12 @@
   doing the final conversion
 
 * might have some advantage to place stuff in a QuadTree, when you have a complex level
+
+* SceneGraph could be used to promte certain states to children such
+  as: color, alpha, visibility (would be mainly useful for the editor
+  to hide layers or highlight them)
+
+* SceneGraph could be used to promote rotation and scaling to children
 
 Navigation Graph
 ================
@@ -78,6 +103,14 @@
 * NavigationGraph needs hooks into scripting, so that things can be
   triggered when a character passes over a specific trigger node or
   things like that.
+
+* NavigationGraph Edge Types:
+
+  * ground    - usual stuff, you run on it
+  * wall      - vertical stuff
+  * ladder    - stuff you can climb (maybe different version for climbing: left, right, front)
+  * stairs    - 45 degree, must follow special step spacing
+  * smallwall - boxen and stuff you can jump over or climb on
 
 Display
 =======
@@ -88,8 +121,6 @@
 
 * Display::push/pop_cliprect() doesn't handle different aspect-ratios properly
 
-* lightmap is broken with non-standard aspect-ratio
-
 * implement aspect-ration switching at runtime (menu entry is there,
   just no code) and change default screen ration to that seen in the
   artwork pictures (FIXME: full resolution switch would be more useful
@@ -117,7 +148,31 @@
   * log when a sector is changed
 
   * include a timestemp in the log
+
+* Editor Logging:
+
+  * print Gtk events
 
+Particle System
+===============
+
+* ParticleSystem could be hooked up to scripting
+
+* particle system doesn't take delta into proper account, breaks when
+  doing set_game_speed(0.1) (might be issue with game_speed, not the ParticleSystem)
+
+* add a alpha ease-in to the particle system
+
+* add a switch to turn of blending in the SurfaceDrawer (i.e.
+  currently stuff fades out, but for some things that isn't a good
+  idea)
+
+* add arial particles for effects like snow
+
+* maybe do snow as fullscreen effect by just shifting the UV
+  coordinates (wouldn't work for smoke/fog)
+
+
 Scripting
 =========
 
@@ -126,8 +181,6 @@
 * http://developer.valvesoftware.com/wiki/Scripted_sequence
 * http://developer.valvesoftware.com/wiki/Faceposer
 
-* ParticleSystem could be hooked up to scripting
-
 * add a way to bind keys to script functions for use in debugging
 
   bind("F9", "toggle_this")
@@ -246,6 +299,9 @@
 Input Handling
 ==============
 
+* pressing left and right at the same time and then releasing one of
+  them causes the input to get stuck in the wrong direction
+
 * input in Navigation Graph test uses deadzone, but shouldn't
 
 * remove secondary controller, instead accept multiple --controller
@@ -438,6 +494,9 @@
 printf("OpenGL 2.0 not supported\n");
 exit(1);
 }
+
+* Check if http://developer.nvidia.com/object/np2_mipmapping.html can
+  be used to improve visual quality
 
 Profiling
 =========
@@ -931,24 +990,6 @@
 ============
 
 * write a script that builds cross compile environment with mingw on Ubuntu
-
-* optimize SConscript, currently takes 10.5sec to run, which is
-  ridiculously slow
-  
-  * using variant_dir increases the build time from 9.5 to 10.5 seconds
-
-  * Decider() has no noticable impact on build times
-
-  * Cachedir() has no noticable negative impact on build times
-
-  * reading the SConscript itself takes around 1.5 seconds, can be cut
-    down to 0.8 seconds by removing the browsing of data files
-
-  * build_windstille_editor() takes 7 seconds 
-
-  * build_windstille() takes 3 seconds 
-
-  * building just the external libraries takes just 0.7sec in total
 
 Code Cleanup
 ============
@@ -963,10 +1004,6 @@
 
 * Screens might fit better into app/ then screen/
 
-* unify copyright header and #ifdef guards
-
- for i in */*.hpp; do echo $i; NAME=$(echo $i | sed "s/[\/\.]/_/g;s/^/HEADER_WINDSTILLE_/" | tr [a-z] [A-Z]);  sed  -i "s/^\(#[a-z]*\) *HEADER_WINDSTILLE_.*/\1 $NAME/" $i; done
-
 * find a astyle/bcpp/whatever configuration that matches the current
   coding style, maybe a little script that uses Emacs would do
 

Added: trunk/windstille/src/editor/navgraph_edge_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-07 15:46:38 UTC (rev 3198)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-07 15:47:31 UTC (rev 3199)
@@ -0,0 +1,31 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "editor/navgraph_edge_object_model.hpp"
+
+NavGraphEdgeObjectModel::NavGraphEdgeObjectModel()
+  : ObjectModel("NavGraphEdgeObjectModel", Vector2f())
+{
+}
+
+void
+NavGraphEdgeObjectModel::add_to_scenegraph(SceneGraph& sg)
+{
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/navgraph_edge_object_model.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/navgraph_edge_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-07 15:46:38 UTC (rev 3198)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-07 15:47:31 UTC (rev 3199)
@@ -0,0 +1,39 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_EDITOR_NAVGRAPH_NODE_OBJECT_MODEL_HPP
+#define HEADER_WINDSTILLE_EDITOR_NAVGRAPH_NODE_OBJECT_MODEL_HPP
+
+#include "editor/object_model.hpp"
+
+class NavGraphEdgeObjectModel : public ObjectModel
+{
+private:
+public:
+  NavGraphEdgeObjectModel();
+
+  void add_to_scenegraph(SceneGraph& sg);
+
+private:
+  NavGraphEdgeObjectModel(const NavGraphEdgeObjectModel&);
+  NavGraphEdgeObjectModel& operator=(const NavGraphEdgeObjectModel&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/navgraph_edge_object_model.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/navgraph_node_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-07 15:46:38 UTC (rev 3198)
+++ trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-07 15:47:31 UTC (rev 3199)
@@ -0,0 +1,31 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "editor/navgraph_node_object_model.hpp"
+
+NavGraphNodeObjectModel::NavGraphNodeObjectModel(const Vector2f& pos)
+  : ObjectModel("NavGraphNodeObjectModel", pos)
+{
+}
+
+void
+NavGraphNodeObjectModel::add_to_scenegraph(SceneGraph& sg)
+{
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/navgraph_node_object_model.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/navgraph_node_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-07 15:46:38 UTC (rev 3198)
+++ trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-07 15:47:31 UTC (rev 3199)
@@ -0,0 +1,39 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_EDITOR_NAVGRAPH_NODE_OBJECT_MODEL_HPP
+#define HEADER_WINDSTILLE_EDITOR_NAVGRAPH_NODE_OBJECT_MODEL_HPP
+
+#include "editor/object_model.hpp"
+
+class NavGraphNodeObjectModel : public ObjectModel
+{
+private:
+public:
+  NavGraphNodeObjectModel(const Vector2f& pos);
+
+  void add_to_scenegraph(SceneGraph& sg);
+
+private:
+  NavGraphNodeObjectModel(const NavGraphNodeObjectModel&);
+  NavGraphNodeObjectModel& operator=(const NavGraphNodeObjectModel&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/navgraph_node_object_model.hpp
___________________________________________________________________
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Mon Sep  7 17:48:30 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 7 Sep 2009 17:48:30 +0200
Subject: [Windstille-commit] r3200 - trunk/windstille/data/particlesystems
Message-ID: <200909071548.n87FmUP8016568@sheep.berlios.de>

Author: grumbel
Date: 2009-09-07 17:48:30 +0200 (Mon, 07 Sep 2009)
New Revision: 3200

Added:
   trunk/windstille/data/particlesystems/gasleak.particles
   trunk/windstille/data/particlesystems/smoke.particles
   trunk/windstille/data/particlesystems/snow.particles
Modified:
   trunk/windstille/data/particlesystems/fire.particles
   trunk/windstille/data/particlesystems/water.particles
Log:
Some particle system experiments

Modified: trunk/windstille/data/particlesystems/fire.particles
===================================================================
--- trunk/windstille/data/particlesystems/fire.particles	2009-09-07 15:47:31 UTC (rev 3199)
+++ trunk/windstille/data/particlesystems/fire.particles	2009-09-07 15:48:30 UTC (rev 3200)
@@ -29,19 +29,19 @@
 
 
  ;; Fire Light
-;  (particle-system
-;   (pos 0 0)
-;   (lifetime 1.0)
-;   (count 20)
-;   (layer "light")
-;   (z-pos 1000)
-;   (velocity 200 300)
-;   (cone -95 -85)
-;   (gravity 0 0)
-;   (distribution (line-distribution (x1 -50) (y1 0) (x2 50) (y2 0)))
-;   (drawer (surface-drawer (image "images/particles/fire_light.png")
-;                           (blendfunc-src "src_alpha")
-;                           (blendfunc-dst "one"))))
+  (particle-system
+   (pos 0 0)
+   (lifetime 2.0)
+   (count 10)
+   (layer "light")
+   (z-pos 1000)
+   (velocity 200 300)
+   (cone -95 -85)
+   (gravity 0 0)
+   (distribution (line-distribution (x1 -50) (y1 0) (x2 50) (y2 0)))
+   (drawer (surface-drawer (image "images/particles/fire_light.png")
+                           (blendfunc-src "src_alpha")
+                           (blendfunc-dst "one"))))
  
  ;; Fire itself
  (particle-system

Added: trunk/windstille/data/particlesystems/gasleak.particles
===================================================================
--- trunk/windstille/data/particlesystems/gasleak.particles	2009-09-07 15:47:31 UTC (rev 3199)
+++ trunk/windstille/data/particlesystems/gasleak.particles	2009-09-07 15:48:30 UTC (rev 3200)
@@ -0,0 +1,21 @@
+;; -*- scheme -*-
+
+(particle-systems
+ ;; Fire itself
+ (particle-system
+  (pos 0 0)
+  (count 10)
+  (lifetime 1.0)
+  (z-pos 1000)
+  (layer "color")
+  (velocity 90 100)
+  (cone 45 0)
+  (gravity 0 -1.0)
+  (size 5.0 0.5)
+  (distribution (point-distribution))
+  (drawer (surface-drawer (image "images/particles/smoke.png")
+                          (blendfunc-src "src_alpha")
+                          (blendfunc-dst "one"))))
+)
+
+;; EOF ;;

Added: trunk/windstille/data/particlesystems/smoke.particles
===================================================================
--- trunk/windstille/data/particlesystems/smoke.particles	2009-09-07 15:47:31 UTC (rev 3199)
+++ trunk/windstille/data/particlesystems/smoke.particles	2009-09-07 15:48:30 UTC (rev 3200)
@@ -0,0 +1,31 @@
+;; -*- scheme -*-
+
+(particle-systems
+ (particle-system
+  (pos 0 32)
+  (lifetime 18)
+  (count 40)
+  (z-pos -200)
+  (drawer (surface-drawer (image "images/particles/smoke2.png")
+                          (blendfunc-src "src_alpha")
+                          (blendfunc-dst "one_minus_src_alpha")))
+  (velocity 40 50)
+  (cone 0 10)
+  (gravity 0 0)
+  (size 3.0 5.0)
+  (distribution (line-distribution (x1 -50) (y1 0) (x2 400) (y2 0))))
+
+ (particle-system
+  (pos 0 32)
+  (lifetime 18)
+  (count 40)
+  (z-pos -200)
+  (drawer (surface-drawer (image "images/particles/smoke2.png")
+                          (blendfunc-src "src_alpha")
+                          (blendfunc-dst "one_minus_src_alpha")))
+  (velocity 40 50)
+  (cone 170 180)
+  (gravity 0 0)
+  (size 3.0 5.0)
+  (distribution (line-distribution (x1 -400) (y1 0) (x2 50) (y2 0))))
+ )

Added: trunk/windstille/data/particlesystems/snow.particles
===================================================================
--- trunk/windstille/data/particlesystems/snow.particles	2009-09-07 15:47:31 UTC (rev 3199)
+++ trunk/windstille/data/particlesystems/snow.particles	2009-09-07 15:48:30 UTC (rev 3200)
@@ -0,0 +1,23 @@
+;; -*- scheme -*-
+
+(particle-systems
+
+ ;; Fire itself
+ (particle-system
+  (pos 0 0)
+  (count 100)
+  (z-pos 1000)
+  (layer "color")
+  (lifetime 5.0)
+  (velocity 400 500)
+  (cone 40 50)
+  (gravity 0.0 0.0)
+  (size 1.5 1.0)
+  (distribution (line-distribution (x1 -500) (y1 0) (x2 1500) (y2 0)))
+  (drawer (surface-drawer (image "images/particles/snow.png")
+                          (blendfunc-src "src_alpha")
+                          (blendfunc-dst "one_minus_src_alpha"))))
+
+)
+
+;; EOF ;;

Modified: trunk/windstille/data/particlesystems/water.particles
===================================================================
--- trunk/windstille/data/particlesystems/water.particles	2009-09-07 15:47:31 UTC (rev 3199)
+++ trunk/windstille/data/particlesystems/water.particles	2009-09-07 15:48:30 UTC (rev 3200)
@@ -5,23 +5,25 @@
   (drawer (spark-drawer (color 0.25 0.5 1.0) (width 2.5)))
   (z-pos 900)
   (count 1000)
+ (lifetime 1.5) 
   (pos 0 -200)
   (layer "color")
   (velocity 100 200)
   (cone -10 -170)
   (gravity 0  .5)
-  (distribution (line-distribution (x1 -25)  (y1 0) (x2 25) (y2 0))))
+  (distribution (line-distribution (x1 -50)  (y1 0) (x2 50) (y2 0))))
 
   (particle-system
    (drawer (spark-drawer (color 0.8 0.8 1.0) (width 2.5)))
    (z-pos 900)
    (count 1000)
+   (lifetime 1.5) 
    (pos 0 -200)
    (layer "color")
    (velocity 100 200)
    (cone -50 -130)
    (gravity 0  .5)
-   (distribution (line-distribution (x1 -25)  (y1 0) (x2 25) (y2 0))))
+   (distribution (line-distribution (x1 -50)  (y1 0) (x2 50) (y2 0))))
 )
 
 ;; EOF ;;



From grumbel at mail.berlios.de  Mon Sep  7 21:39:02 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 7 Sep 2009 21:39:02 +0200
Subject: [Windstille-commit] r3201 - trunk/windstille/src/editor
Message-ID: <200909071939.n87Jd2l4031105@sheep.berlios.de>

Author: grumbel
Date: 2009-09-07 21:39:02 +0200 (Mon, 07 Sep 2009)
New Revision: 3201

Modified:
   trunk/windstille/src/editor/decal_object_model.cpp
   trunk/windstille/src/editor/sector_model.cpp
Log:
Fixed some issues with scenegraph order and updates

Modified: trunk/windstille/src/editor/decal_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.cpp	2009-09-07 15:48:30 UTC (rev 3200)
+++ trunk/windstille/src/editor/decal_object_model.cpp	2009-09-07 19:39:02 UTC (rev 3201)
@@ -255,11 +255,15 @@
 void
 DecalObjectModel::add_to_scenegraph(SceneGraph& sg)
 {
-  m_drawable.reset(new SurfaceQuadDrawable(surface, Vector2f(), Quad(get_bounding_box()),
-                                           DrawingParameters(), 0.0f,
-                                           Matrix::identity()));
+  if (!m_drawable)
+  {
+    m_drawable.reset(new SurfaceQuadDrawable(surface, Vector2f(), Quad(get_bounding_box()),
+                                             DrawingParameters(), 0.0f,
+                                             Matrix::identity()));
+    sync();
+  }
+
   sg.add_drawable(m_drawable);
-  //std::cout << "DecalObjectModel::add_to_scenegraph(SectorModel& sector)" << std::endl;
 }
 
 void

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-07 15:48:30 UTC (rev 3200)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-07 19:39:02 UTC (rev 3201)
@@ -544,7 +544,7 @@
   scene_graph->clear();
 
   const Layers& layers = get_layers();
-  for(Layers::const_iterator layer = layers.begin(); layer != layers.end(); ++layer)
+  for(Layers::const_reverse_iterator layer = layers.rbegin(); layer != layers.rend(); ++layer)
   {
     if (*layer)
     {



From grumbel at mail.berlios.de  Mon Sep  7 22:41:43 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 7 Sep 2009 22:41:43 +0200
Subject: [Windstille-commit] r3202 - trunk/windstille/src/editor
Message-ID: <200909072041.n87Kfh3t006471@sheep.berlios.de>

Author: grumbel
Date: 2009-09-07 22:41:42 +0200 (Mon, 07 Sep 2009)
New Revision: 3202

Modified:
   trunk/windstille/src/editor/navgraph_edge_object_model.cpp
   trunk/windstille/src/editor/navgraph_edge_object_model.hpp
   trunk/windstille/src/editor/navgraph_insert_tool.cpp
   trunk/windstille/src/editor/navgraph_node_object_model.cpp
   trunk/windstille/src/editor/navgraph_node_object_model.hpp
   trunk/windstille/src/editor/object_model.cpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
   trunk/windstille/src/editor/windstille_widget.cpp
   trunk/windstille/src/editor/windstille_widget.hpp
Log:
NavGraphNode is now dragable with normal select tool

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-07 19:39:02 UTC (rev 3201)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-07 20:41:42 UTC (rev 3202)
@@ -18,14 +18,46 @@
 
 #include "editor/navgraph_edge_object_model.hpp"
 
-NavGraphEdgeObjectModel::NavGraphEdgeObjectModel()
-  : ObjectModel("NavGraphEdgeObjectModel", Vector2f())
+#include "editor/navgraph_node_object_model.hpp"
+#include "scenegraph/vertex_array_drawable.hpp"
+#include "scenegraph/scene_graph.hpp"
+
+NavGraphEdgeObjectModel::NavGraphEdgeObjectModel(boost::weak_ptr<NavGraphNodeObjectModel> lhs,
+                                                 boost::weak_ptr<NavGraphNodeObjectModel> rhs)
+  : ObjectModel("NavGraphEdgeObjectModel", Vector2f()),
+    m_lhs(lhs),
+    m_rhs(rhs),
+    m_drawable()
 {
 }
 
 void
+NavGraphEdgeObjectModel::update(float delta)
+{
+  if (m_drawable)
+  {
+    boost::shared_ptr<NavGraphNodeObjectModel> lhs = m_lhs.lock();
+    boost::shared_ptr<NavGraphNodeObjectModel> rhs = m_rhs.lock();
+
+    if (lhs && rhs)
+    {
+      m_drawable->clear();
+
+      m_drawable->color(Color(0.0f, 1.0f, 1.0f));
+      m_drawable->vertex(lhs->get_world_pos());
+
+      m_drawable->color(Color(0.0f, 1.0f, 1.0f));
+      m_drawable->vertex(rhs->get_world_pos());
+    }
+  }
+}
+
+void
 NavGraphEdgeObjectModel::add_to_scenegraph(SceneGraph& sg)
 {
+  m_drawable.reset(new VertexArrayDrawable(Vector2f(), 0.0f, Matrix::identity()));
+  update(0.0f);
+  sg.add_drawable(m_drawable);
 }
 
 /* EOF */

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-07 19:39:02 UTC (rev 3201)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-07 20:41:42 UTC (rev 3202)
@@ -16,18 +16,29 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
-#ifndef HEADER_WINDSTILLE_EDITOR_NAVGRAPH_NODE_OBJECT_MODEL_HPP
-#define HEADER_WINDSTILLE_EDITOR_NAVGRAPH_NODE_OBJECT_MODEL_HPP
+#ifndef HEADER_WINDSTILLE_EDITOR_NAVGRAPH_EDGE_OBJECT_MODEL_HPP
+#define HEADER_WINDSTILLE_EDITOR_NAVGRAPH_EDGE_OBJECT_MODEL_HPP
 
+#include <boost/weak_ptr.hpp>
+
 #include "editor/object_model.hpp"
 
+class NavGraphNodeObjectModel;
+class VertexArrayDrawable;
+
 class NavGraphEdgeObjectModel : public ObjectModel
 {
 private:
+  boost::weak_ptr<NavGraphNodeObjectModel> m_lhs;
+  boost::weak_ptr<NavGraphNodeObjectModel> m_rhs;
+  boost::shared_ptr<VertexArrayDrawable> m_drawable;
+  
 public:
-  NavGraphEdgeObjectModel();
+  NavGraphEdgeObjectModel(boost::weak_ptr<NavGraphNodeObjectModel> lhs,
+                          boost::weak_ptr<NavGraphNodeObjectModel> rhs);
 
   void add_to_scenegraph(SceneGraph& sg);
+  void update(float delta);
 
 private:
   NavGraphEdgeObjectModel(const NavGraphEdgeObjectModel&);

Modified: trunk/windstille/src/editor/navgraph_insert_tool.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-07 19:39:02 UTC (rev 3201)
+++ trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-07 20:41:42 UTC (rev 3202)
@@ -16,14 +16,16 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
+#include "editor/navgraph_insert_tool.hpp"
+
 #include "editor/sector_model.hpp"
 #include "navigation/navigation_graph.hpp"
 #include "navigation/node.hpp"
 #include "navigation/edge.hpp"
 #include "editor/windstille_widget.hpp"
 #include "editor/editor_window.hpp"
-
-#include "editor/navgraph_insert_tool.hpp"
+#include "editor/navgraph_node_object_model.hpp"
+#include "editor/object_commands.hpp"
 
 NavgraphInsertTool::NavgraphInsertTool()
   : mouse_pos(),
@@ -36,10 +38,11 @@
 }
 
 void
-NavgraphInsertTool::mouse_down (GdkEventButton* event, WindstilleWidget& wst)
+NavgraphInsertTool::mouse_down(GdkEventButton* event, WindstilleWidget& wst)
 {
   mouse_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
   NavigationGraph& navgraph = *wst.get_sector_model()->get_nav_graph();
+  SectorModel* sector = wst.get_sector_model();
 
   NodeHandle node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
   EdgeHandle edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
@@ -56,7 +59,10 @@
             }
           else
             { // connect last node with newly created node
-              node = navgraph.add_node(mouse_pos);
+              NavGraphNodeObjectModel* obj = new NavGraphNodeObjectModel(mouse_pos, *sector);
+              node = obj->get_node();
+              wst.execute(CommandHandle(new ObjectAddCommand(wst.get_current_layer(), ObjectModelHandle(obj))));
+
               navgraph.add_edge(last_node, node);
               last_node = NodeHandle();
             }
@@ -78,7 +84,10 @@
             }
           else
             {
-              last_node = navgraph.add_node(mouse_pos);
+              NavGraphNodeObjectModel* obj = new NavGraphNodeObjectModel(mouse_pos, *sector);
+              last_node = obj->get_node();
+              wst.execute(CommandHandle(new ObjectAddCommand(wst.get_current_layer(), ObjectModelHandle(obj))));
+              
               mode = EDGE_MODE;
             }
         }

Modified: trunk/windstille/src/editor/navgraph_node_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-07 19:39:02 UTC (rev 3201)
+++ trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-07 20:41:42 UTC (rev 3202)
@@ -18,14 +18,79 @@
 
 #include "editor/navgraph_node_object_model.hpp"
 
-NavGraphNodeObjectModel::NavGraphNodeObjectModel(const Vector2f& pos)
-  : ObjectModel("NavGraphNodeObjectModel", pos)
+#include "editor/sector_model.hpp"
+#include "scenegraph/vertex_array_drawable.hpp"
+#include "scenegraph/scene_graph.hpp"
+#include "navigation/node.hpp"
+
+NavGraphNodeObjectModel::NavGraphNodeObjectModel(const Vector2f& pos, SectorModel& sector)
+  : ObjectModel("NavGraphNodeObjectModel", pos),
+    m_drawable(),
+    m_node()
 {
+  m_node = sector.get_nav_graph()->add_node(pos);
 }
 
 void
 NavGraphNodeObjectModel::add_to_scenegraph(SceneGraph& sg)
 {
+  if (!m_drawable)
+    m_drawable.reset(new VertexArrayDrawable(Vector2f(), 0.0f, Matrix::identity()));
+
+  sync_drawable();
+  sg.add_drawable(m_drawable);
 }
 
+void
+NavGraphNodeObjectModel::sync_drawable()
+{
+  if (m_drawable)
+  {
+    m_drawable->clear();
+
+    m_drawable->color(Color(1.0f, 0.0f, 0.0f));
+    m_drawable->vertex(get_world_pos() + Vector2f(-10.0f, -10.0f));
+
+    m_drawable->color(Color(1.0f, 0.0f, 0.0f));
+    m_drawable->vertex(get_world_pos() + Vector2f(10.0f, -10.0f));
+
+    m_drawable->color(Color(1.0f, 0.0f, 0.0f));
+    m_drawable->vertex(get_world_pos() + Vector2f(10.0f, 10.0f));
+
+    m_drawable->color(Color(1.0f, 0.0f, 0.0f));
+    m_drawable->vertex(get_world_pos() + Vector2f(-10.0f, 10.0f));
+  }
+}
+
+void
+NavGraphNodeObjectModel::set_rel_pos(const Vector2f& rel_pos_)
+{
+  ObjectModel::set_rel_pos(rel_pos_);
+  m_node->set_pos(get_world_pos());
+}
+
+void
+NavGraphNodeObjectModel::on_remove()
+{
+  // remove connected edges
+}
+
+Rectf
+NavGraphNodeObjectModel::get_bounding_box() const
+{
+  return Rectf(get_world_pos() - Vector2f(10.0f, 10.0f),
+               Sizef(20.0f, 20.0f));
+}
+
+ObjectModelHandle 
+NavGraphNodeObjectModel::clone() const
+{
+  return ObjectModelHandle();
+}
+
+void
+NavGraphNodeObjectModel::write(FileWriter& writer) const
+{
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/navgraph_node_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-07 19:39:02 UTC (rev 3201)
+++ trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-07 20:41:42 UTC (rev 3202)
@@ -19,16 +19,34 @@
 #ifndef HEADER_WINDSTILLE_EDITOR_NAVGRAPH_NODE_OBJECT_MODEL_HPP
 #define HEADER_WINDSTILLE_EDITOR_NAVGRAPH_NODE_OBJECT_MODEL_HPP
 
+#include <boost/shared_ptr.hpp>
+
 #include "editor/object_model.hpp"
+#include "navigation/navigation_graph.hpp"
 
+class VertexArrayDrawable;
+
 class NavGraphNodeObjectModel : public ObjectModel
 {
 private:
+  boost::shared_ptr<VertexArrayDrawable> m_drawable;
+  NodeHandle m_node;
+
 public:
-  NavGraphNodeObjectModel(const Vector2f& pos);
+  NavGraphNodeObjectModel(const Vector2f& pos, SectorModel& sector);
 
   void add_to_scenegraph(SceneGraph& sg);
+  void set_rel_pos(const Vector2f& rel_pos_);
+  void sync_drawable();
 
+  void on_remove();
+  
+  NodeHandle get_node() const { return m_node; }
+
+  Rectf get_bounding_box() const;
+  ObjectModelHandle clone() const;
+  void write(FileWriter& writer) const;
+
 private:
   NavGraphNodeObjectModel(const NavGraphNodeObjectModel&);
   NavGraphNodeObjectModel& operator=(const NavGraphNodeObjectModel&);

Modified: trunk/windstille/src/editor/object_model.cpp
===================================================================
--- trunk/windstille/src/editor/object_model.cpp	2009-09-07 19:39:02 UTC (rev 3201)
+++ trunk/windstille/src/editor/object_model.cpp	2009-09-07 20:41:42 UTC (rev 3202)
@@ -131,15 +131,15 @@
 ObjectModel::set_world_pos(const Vector2f& p)
 {
   if (parent_ptr.lock())
-    rel_pos += p - get_world_pos();
+    set_rel_pos(rel_pos + (p - get_world_pos()));
   else
-    rel_pos = p;
+    set_rel_pos(p);
 }
 
 void
 ObjectModel::set_rel_pos(const Vector2f& rel_pos_)
 {
-  // Cut to integer positions
+  // FIXME: Cut to integer positions, might not be the right place to do this
   rel_pos.x = floorf(rel_pos_.x);
   rel_pos.y = floorf(rel_pos_.y);
 }

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-07 19:39:02 UTC (rev 3201)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-07 20:41:42 UTC (rev 3202)
@@ -557,6 +557,7 @@
       }
     }
   }
+
   queue_draw();
 }
 

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-07 19:39:02 UTC (rev 3201)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-07 20:41:42 UTC (rev 3202)
@@ -88,7 +88,6 @@
   void draw(SceneContext& sc, const SelectMask& layers, bool draw_navgraph);
 
   void update(float delta);
-  void update(float delta, const Gtk::TreeRow& row);
 
   void set_all_visible(bool v);
   void set_all_locked(bool v);

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-07 19:39:02 UTC (rev 3201)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-07 20:41:42 UTC (rev 3202)
@@ -132,7 +132,7 @@
 {
   undo_manager->execute(cmd);
   EditorWindow::current()->update_undo_state();
-  queue_draw();
+  sector_model->rebuild_scene_graph();
 }
 
 bool

Modified: trunk/windstille/src/editor/windstille_widget.hpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.hpp	2009-09-07 19:39:02 UTC (rev 3201)
+++ trunk/windstille/src/editor/windstille_widget.hpp	2009-09-07 20:41:42 UTC (rev 3202)
@@ -82,7 +82,7 @@
 
   GraphicContextState& get_state() { return state; }
 
-  void execute(CommandHandle);
+  void execute(CommandHandle cmd);
 
   virtual void on_realize();
   virtual bool on_timeout();



From grumbel at mail.berlios.de  Tue Sep  8 01:15:23 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 8 Sep 2009 01:15:23 +0200
Subject: [Windstille-commit] r3203 - trunk/windstille/src/navigation
Message-ID: <200909072315.n87NFNAC007350@sheep.berlios.de>

Author: grumbel
Date: 2009-09-08 01:15:22 +0200 (Tue, 08 Sep 2009)
New Revision: 3203

Modified:
   trunk/windstille/src/navigation/navigation_graph.hpp
Log:
Added operator== to PointerHandle

Modified: trunk/windstille/src/navigation/navigation_graph.hpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.hpp	2009-09-07 20:41:42 UTC (rev 3202)
+++ trunk/windstille/src/navigation/navigation_graph.hpp	2009-09-07 23:15:22 UTC (rev 3203)
@@ -71,6 +71,10 @@
     return data != 0;
   }
 
+  bool operator==(const PointerHandle<Data>& rhs) const {
+    return data == rhs.data;
+  }
+
   bool operator<(const PointerHandle<Data>& other) const {
     return this->data < other.data;
   }



From grumbel at mail.berlios.de  Tue Sep  8 01:17:46 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 8 Sep 2009 01:17:46 +0200
Subject: [Windstille-commit] r3204 - trunk/windstille/src/editor
Message-ID: <200909072317.n87NHkPm010999@sheep.berlios.de>

Author: grumbel
Date: 2009-09-08 01:17:45 +0200 (Tue, 08 Sep 2009)
New Revision: 3204

Modified:
   trunk/windstille/src/editor/navgraph_edge_object_model.cpp
   trunk/windstille/src/editor/navgraph_edge_object_model.hpp
   trunk/windstille/src/editor/navgraph_insert_tool.cpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
Log:
Basic select and drag&drop works now with both Nodes and Edges

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-07 23:15:22 UTC (rev 3203)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-07 23:17:45 UTC (rev 3204)
@@ -19,16 +19,22 @@
 #include "editor/navgraph_edge_object_model.hpp"
 
 #include "editor/navgraph_node_object_model.hpp"
+#include "editor/sector_model.hpp"
+#include "scenegraph/scene_graph.hpp"
 #include "scenegraph/vertex_array_drawable.hpp"
-#include "scenegraph/scene_graph.hpp"
 
 NavGraphEdgeObjectModel::NavGraphEdgeObjectModel(boost::weak_ptr<NavGraphNodeObjectModel> lhs,
-                                                 boost::weak_ptr<NavGraphNodeObjectModel> rhs)
+                                                 boost::weak_ptr<NavGraphNodeObjectModel> rhs,
+                                                 SectorModel& sector)
   : ObjectModel("NavGraphEdgeObjectModel", Vector2f()),
     m_lhs(lhs),
     m_rhs(rhs),
-    m_drawable()
+    m_drawable(),
+    m_edge()
 {
+  std::cout << "Adding edge" << std::endl;
+  m_edge = sector.get_nav_graph()->add_edge(lhs.lock()->get_node(),
+                                            rhs.lock()->get_node());
 }
 
 void
@@ -42,7 +48,7 @@
     if (lhs && rhs)
     {
       m_drawable->clear();
-
+      m_drawable->set_mode(GL_LINES);
       m_drawable->color(Color(0.0f, 1.0f, 1.0f));
       m_drawable->vertex(lhs->get_world_pos());
 
@@ -60,4 +66,27 @@
   sg.add_drawable(m_drawable);
 }
 
+Rectf
+NavGraphEdgeObjectModel::get_bounding_box() const
+{
+  boost::shared_ptr<NavGraphNodeObjectModel> lhs = m_lhs.lock();
+  boost::shared_ptr<NavGraphNodeObjectModel> rhs = m_rhs.lock();
+
+  Rectf rect(lhs->get_world_pos(),
+             rhs->get_world_pos());
+  rect.normalize();
+  return rect;
+}
+
+ObjectModelHandle
+NavGraphEdgeObjectModel::clone() const
+{
+  return ObjectModelHandle();
+}
+
+void
+NavGraphEdgeObjectModel::write(FileWriter& writer) const
+{
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-07 23:15:22 UTC (rev 3203)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-07 23:17:45 UTC (rev 3204)
@@ -21,6 +21,7 @@
 
 #include <boost/weak_ptr.hpp>
 
+#include "navigation/navigation_graph.hpp"
 #include "editor/object_model.hpp"
 
 class NavGraphNodeObjectModel;
@@ -32,14 +33,22 @@
   boost::weak_ptr<NavGraphNodeObjectModel> m_lhs;
   boost::weak_ptr<NavGraphNodeObjectModel> m_rhs;
   boost::shared_ptr<VertexArrayDrawable> m_drawable;
-  
+  EdgeHandle m_edge;
+
 public:
   NavGraphEdgeObjectModel(boost::weak_ptr<NavGraphNodeObjectModel> lhs,
-                          boost::weak_ptr<NavGraphNodeObjectModel> rhs);
+                          boost::weak_ptr<NavGraphNodeObjectModel> rhs,
+                          SectorModel& sector);
 
   void add_to_scenegraph(SceneGraph& sg);
   void update(float delta);
 
+  Rectf get_bounding_box() const;
+  ObjectModelHandle clone() const;
+  void write(FileWriter& writer) const;
+
+  EdgeHandle get_edge() const { return m_edge; }
+
 private:
   NavGraphEdgeObjectModel(const NavGraphEdgeObjectModel&);
   NavGraphEdgeObjectModel& operator=(const NavGraphEdgeObjectModel&);

Modified: trunk/windstille/src/editor/navgraph_insert_tool.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-07 23:15:22 UTC (rev 3203)
+++ trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-07 23:17:45 UTC (rev 3204)
@@ -25,6 +25,7 @@
 #include "editor/windstille_widget.hpp"
 #include "editor/editor_window.hpp"
 #include "editor/navgraph_node_object_model.hpp"
+#include "editor/navgraph_edge_object_model.hpp"
 #include "editor/object_commands.hpp"
 
 NavgraphInsertTool::NavgraphInsertTool()
@@ -48,51 +49,60 @@
   EdgeHandle edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
 
   switch(mode)
+  {
+    case EDGE_MODE:
     {
-      case EDGE_MODE:
-        {
-          if (node)
-            { // connect last node with existing node
-              navgraph.add_edge(last_node, node);
-              last_node = NodeHandle();
-              connection_node = NodeHandle();
-            }
-          else
-            { // connect last node with newly created node
-              NavGraphNodeObjectModel* obj = new NavGraphNodeObjectModel(mouse_pos, *sector);
-              node = obj->get_node();
-              wst.execute(CommandHandle(new ObjectAddCommand(wst.get_current_layer(), ObjectModelHandle(obj))));
+      if (node)
+      { // connect last node with existing node
+        NavGraphEdgeObjectModel* edge_obj = new NavGraphEdgeObjectModel(sector->find_navgraph_node(last_node),
+                                                                        sector->find_navgraph_node(node),
+                                                                        *sector);
+        wst.execute(CommandHandle(new ObjectAddCommand(wst.get_current_layer(), ObjectModelHandle(edge_obj))));
 
-              navgraph.add_edge(last_node, node);
-              last_node = NodeHandle();
-            }
-          mode = NO_MODE;        
-        }
-        break;
+        last_node = NodeHandle();
+        connection_node = NodeHandle();
+      }
+      else
+      { // connect last node with newly created node
+        // FIXME: Make this a GroupCommand
+        NavGraphNodeObjectModel* obj = new NavGraphNodeObjectModel(mouse_pos, *sector);
+        node = obj->get_node();
+        wst.execute(CommandHandle(new ObjectAddCommand(wst.get_current_layer(), ObjectModelHandle(obj))));
 
-      case NO_MODE:
-        {
-          if (node)
-            {
-              last_node = node;
-              mode = EDGE_MODE;
-            }
-          else if (edge)
-            {
-              navgraph.remove_edge(edge);
-              mode = NO_MODE;
-            }
-          else
-            {
-              NavGraphNodeObjectModel* obj = new NavGraphNodeObjectModel(mouse_pos, *sector);
-              last_node = obj->get_node();
-              wst.execute(CommandHandle(new ObjectAddCommand(wst.get_current_layer(), ObjectModelHandle(obj))));
+        NavGraphEdgeObjectModel* edge_obj = new NavGraphEdgeObjectModel(sector->find_navgraph_node(last_node),
+                                                                        sector->find_navgraph_node(node), 
+                                                                        *sector);
+        wst.execute(CommandHandle(new ObjectAddCommand(wst.get_current_layer(), ObjectModelHandle(edge_obj))));
+
+        last_node = NodeHandle();
+      }
+      mode = NO_MODE;
+    }
+    break;
+
+    case NO_MODE:
+    {
+      if (node)
+      {
+        last_node = node;
+        mode = EDGE_MODE;
+      }
+      else if (edge)
+      {
+        navgraph.remove_edge(edge);
+        mode = NO_MODE;
+      }
+      else
+      {
+        NavGraphNodeObjectModel* obj = new NavGraphNodeObjectModel(mouse_pos, *sector);
+        last_node = obj->get_node();
+        wst.execute(CommandHandle(new ObjectAddCommand(wst.get_current_layer(), ObjectModelHandle(obj))));
               
-              mode = EDGE_MODE;
-            }
-        }
-        break;
+        mode = EDGE_MODE;
+      }
     }
+    break;
+  }
 
   wst.queue_draw();
 }

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-07 23:15:22 UTC (rev 3203)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-07 23:17:45 UTC (rev 3204)
@@ -28,6 +28,8 @@
 #include "navigation/node.hpp"
 #include "editor/editor_window.hpp"
 #include "editor/windstille_widget.hpp"
+#include "editor/navgraph_node_object_model.hpp"
+#include "editor/navgraph_edge_object_model.hpp"
 #include "util/file_reader.hpp"
 #include "display/scene_context.hpp"
 #include "display/surface.hpp"
@@ -614,4 +616,54 @@
   rebuild_scene_graph();
 }
 
+boost::shared_ptr<NavGraphNodeObjectModel>
+SectorModel::find_navgraph_node(NodeHandle node) const
+{
+  const Layers& layers = get_layers();
+  for(Layers::const_reverse_iterator layer = layers.rbegin(); layer != layers.rend(); ++layer)
+  {
+    if (*layer)
+    {
+      for(Layer::const_iterator obj = (*layer)->begin(); obj != (*layer)->end(); ++obj)
+      {
+        boost::shared_ptr<NavGraphNodeObjectModel> test_node = boost::dynamic_pointer_cast<NavGraphNodeObjectModel>(*obj);
+        if (test_node)
+        {
+          if (test_node->get_node() == node)
+          {
+            return test_node;
+          }
+        }
+      }
+    } 
+  }
+  
+  return boost::shared_ptr<NavGraphNodeObjectModel>();
+}
+
+boost::shared_ptr<NavGraphEdgeObjectModel>
+SectorModel::find_navgraph_edge(EdgeHandle edge) const
+{
+  const Layers& layers = get_layers();
+  for(Layers::const_reverse_iterator layer = layers.rbegin(); layer != layers.rend(); ++layer)
+  {
+    if (*layer)
+    {
+      for(Layer::const_iterator obj = (*layer)->begin(); obj != (*layer)->end(); ++obj)
+      {
+        boost::shared_ptr<NavGraphEdgeObjectModel> test_edge = boost::dynamic_pointer_cast<NavGraphEdgeObjectModel>(*obj);
+        if (test_edge)
+        {
+          if (test_edge->get_edge() == edge)
+          {
+            return test_edge;
+          }
+        }
+      }
+    } 
+  }
+  
+  return boost::shared_ptr<NavGraphEdgeObjectModel>(); 
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-07 23:15:22 UTC (rev 3203)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-07 23:17:45 UTC (rev 3204)
@@ -27,11 +27,14 @@
 
 #include "display/color.hpp"
 #include "editor/layer.hpp"
+#include "editor/object_model.hpp"
 #include "editor/selection.hpp"
-#include "editor/object_model.hpp"
 #include "math/vector2f.hpp"
+#include "navigation/navigation_graph.hpp"
 
 class NavigationGraph;
+class NavGraphNodeObjectModel;
+class NavGraphEdgeObjectModel;
 class SceneGraph;
 class SceneContext;
 class LayerManagerColumns;
@@ -135,6 +138,9 @@
   NavigationGraph* get_nav_graph() const { return nav_graph.get(); }
   SceneGraph*      get_scene_graph() const { return scene_graph.get(); }
 
+  boost::shared_ptr<NavGraphNodeObjectModel> find_navgraph_node(NodeHandle node) const;
+  boost::shared_ptr<NavGraphEdgeObjectModel> find_navgraph_edge(EdgeHandle edge) const;
+
   void queue_draw();
 
   void rebuild_scene_graph();



From grumbel at mail.berlios.de  Tue Sep  8 01:28:46 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 8 Sep 2009 01:28:46 +0200
Subject: [Windstille-commit] r3205 - trunk/windstille/src/editor
Message-ID: <200909072328.n87NSkQa001704@sheep.berlios.de>

Author: grumbel
Date: 2009-09-08 01:28:45 +0200 (Tue, 08 Sep 2009)
New Revision: 3205

Removed:
   trunk/windstille/src/editor/navgraph_select_tool.cpp
   trunk/windstille/src/editor/navgraph_select_tool.hpp
Modified:
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/editor_window.hpp
Log:
Removed obsolete NavGraphSelectTool

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-07 23:17:45 UTC (rev 3204)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-07 23:28:45 UTC (rev 3205)
@@ -42,7 +42,6 @@
 #include "editor/zoom_tool.hpp"
 #include "editor/select_tool.hpp"
 #include "editor/navgraph_insert_tool.hpp"
-#include "editor/navgraph_select_tool.hpp"
 #include "editor/sector_model.hpp"
 #include "editor/layer_widget.hpp"
 
@@ -78,7 +77,6 @@
     snap_action(),
     select_tool(new SelectTool()),
     navgraph_insert_tool(new NavgraphInsertTool()),
-    navgraph_select_tool(new NavgraphSelectTool()),
     zoom_tool(new ZoomTool()),
     current_tool(select_tool.get()),
     layer_widget(),
@@ -162,7 +160,6 @@
     "    <menu action='MenuTools'>"
     "      <menuitem action='SelectTool'/>"
     "      <menuitem action='NavgraphInsertTool'/>"
-    "      <menuitem action='NavgraphSelectTool'/>"
     "      <menuitem action='ZoomTool'/>"
     "    </menu>"
     "    <menu action='MenuHelp'>"
@@ -210,7 +207,6 @@
     "  <toolbar  name='ToolBox'>"
     "    <toolitem action='SelectTool'/>"
     "    <toolitem action='NavgraphInsertTool'/>"
-    "    <toolitem action='NavgraphSelectTool'/>"
     "    <toolitem action='ZoomTool'/>"
     "    <separator/>"
     "    <toolitem action='ToggleColorLayer'/>"
@@ -367,13 +363,10 @@
   
   select_tool_action = Gtk::RadioAction::create_with_icon_name(tool_group, "SelectTool", "select_tool", "Select Tool", "Select Tool");
   navgraph_insert_tool_action = Gtk::RadioAction::create_with_icon_name(tool_group, "NavgraphInsertTool", "navgraph_insert_tool",   "Navgraph Insert Tool", "Navgraph Insert Tool");
-  navgraph_select_tool_action = Gtk::RadioAction::create_with_icon_name(tool_group, "NavgraphSelectTool", "navgraph_select_tool",   "Navgraph Select Tool", "Navgraph Select Tool");
   zoom_tool_action = Gtk::RadioAction::create_with_icon_name(tool_group, "ZoomTool", "zoom_tool",   "Zoom Tool", "Zoom Tool");
 
   action_group->add(select_tool_action, sigc::bind(sigc::mem_fun(*this, &EditorWindow::on_tool_select), select_tool_action, select_tool.get()));
   action_group->add(navgraph_insert_tool_action, sigc::bind(sigc::mem_fun(*this, &EditorWindow::on_tool_select), navgraph_insert_tool_action, navgraph_insert_tool.get()));
-
-  action_group->add(navgraph_select_tool_action, sigc::bind(sigc::mem_fun(*this, &EditorWindow::on_tool_select), navgraph_select_tool_action, navgraph_select_tool.get()));
   action_group->add(zoom_tool_action,   sigc::bind(sigc::mem_fun(*this, &EditorWindow::on_tool_select), zoom_tool_action, zoom_tool.get()));
 
   // signal_size_allocate().connect (sigc::mem_fun (*this, &EditorWindow::on_window_size_allocate), false);
@@ -805,8 +798,7 @@
 bool
 EditorWindow::get_draw_navgraph() const
 {
-  if (current_tool == navgraph_insert_tool.get() ||
-      current_tool == navgraph_select_tool.get())
+  if (current_tool == navgraph_insert_tool.get())
     return true;
   else
     return false;

Modified: trunk/windstille/src/editor/editor_window.hpp
===================================================================
--- trunk/windstille/src/editor/editor_window.hpp	2009-09-07 23:17:45 UTC (rev 3204)
+++ trunk/windstille/src/editor/editor_window.hpp	2009-09-07 23:28:45 UTC (rev 3205)
@@ -41,7 +41,6 @@
 class ZoomTool;
 class LayerWidget;
 class NavgraphInsertTool;
-class NavgraphSelectTool;
 
 class EditorWindow : public Gtk::Window,
                      public Currenton<EditorWindow>
@@ -83,7 +82,6 @@
 
   boost::scoped_ptr<SelectTool>   select_tool;
   boost::scoped_ptr<NavgraphInsertTool> navgraph_insert_tool;
-  boost::scoped_ptr<NavgraphSelectTool> navgraph_select_tool;
   boost::scoped_ptr<ZoomTool>     zoom_tool;
   Tool* current_tool;
   LayerWidget* layer_widget;

Deleted: trunk/windstille/src/editor/navgraph_select_tool.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_select_tool.cpp	2009-09-07 23:17:45 UTC (rev 3204)
+++ trunk/windstille/src/editor/navgraph_select_tool.cpp	2009-09-07 23:28:45 UTC (rev 3205)
@@ -1,139 +0,0 @@
-/*
-**  Windstille - A Sci-Fi Action-Adventure Game
-**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
-**
-**  This program is free software: you can redistribute it and/or modify
-**  it under the terms of the GNU General Public License as published by
-**  the Free Software Foundation, either version 3 of the License, or
-**  (at your option) any later version.
-**  
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-**  
-**  You should have received a copy of the GNU General Public License
-**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-*/
-
-#include "editor/sector_model.hpp"
-#include "navigation/navigation_graph.hpp"
-#include "navigation/node.hpp"
-#include "editor/windstille_widget.hpp"
-
-#include "editor/navgraph_select_tool.hpp"
-
-NavgraphSelectTool::NavgraphSelectTool()
-  : click_pos(),
-    rect(),
-    mode(),
-    selection()
-{
-}
-
-NavgraphSelectTool::~NavgraphSelectTool()
-{
-}
-
-void
-NavgraphSelectTool::mouse_down(GdkEventButton* event, WindstilleWidget& wst)
-{
-  click_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
-  NavigationGraph& navgraph = *wst.get_sector_model()->get_nav_graph();
-
-  NodeHandle node = navgraph.find_closest_node(click_pos, 16.0f); // FIXME: Radius should scale with zoom
-  EdgeHandle edge = navgraph.find_closest_edge(click_pos, 16.0f);
-
-  if (node)
-    {
-      mode = DRAG_MODE;
-      selection.clear();
-      selection.insert(node);
-    }
-  else if (edge)
-    {
-      mode = NO_MODE;
-    }
-  else
-    {
-      rect.left   = click_pos.x;
-      rect.top    = click_pos.y;
-      rect.right  = click_pos.x;
-      rect.bottom = click_pos.y;
-      
-      selection.clear();
-      mode = SELECT_MODE;
-    }
-}
-
-void
-NavgraphSelectTool::mouse_move(GdkEventMotion* event, WindstilleWidget& wst)
-{
-  Vector2f pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
-
-  switch(mode)
-    {
-      case DRAG_MODE:
-        {
-          NodeHandle node = *selection.begin();
-          node->set_pos(pos);
-          wst.queue_draw();
-        }
-        break;
-
-      case SELECT_MODE:
-        rect.right  = pos.x;
-        rect.bottom = pos.y;
-        wst.queue_draw();
-        break;
-
-      case NO_MODE:
-        break;
-    }
-}
-
-void
-NavgraphSelectTool::mouse_up(GdkEventButton* event, WindstilleWidget& wst)
-{
-  Vector2f pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
-  NavigationGraph& navgraph = *wst.get_sector_model()->get_nav_graph();
-
-  switch(mode)
-    {
-      case DRAG_MODE:
-        wst.queue_draw();
-        break;
-
-      case SELECT_MODE:
-        {
-          rect.normalize();
-          const std::vector<NodeHandle>& lst = navgraph.find_nodes(rect);
-          selection.insert(lst.begin(), lst.end());
-          std::cout << "NavgraphInsertTool::select: " << selection.size() << std::endl;
-          wst.queue_draw();
-        }
-        break;
-
-      case NO_MODE:
-        break;
-    }
-
-  mode = NO_MODE;
-}
-
-void
-NavgraphSelectTool::draw(SceneContext& sc)
-{
-  if (mode == SELECT_MODE)
-    {
-      sc.control().fill_rect(rect, Color(1.0f, 0.5f, 0.5f, 0.25));
-      sc.control().draw_rect(rect, Color(1.0f, 0.5f, 0.5f)); 
-    }
-
-  for(std::set<NodeHandle>::const_iterator i = selection.begin(); i != selection.end(); ++i)
-    {
-      sc.control().draw_rect(Rectf((*i)->get_pos() - Vector2f(16,16), Sizef(32,32)), Color(1.0f, 1.0f, 1.0f));
-    }
-}
-
-/* EOF */

Deleted: trunk/windstille/src/editor/navgraph_select_tool.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_select_tool.hpp	2009-09-07 23:17:45 UTC (rev 3204)
+++ trunk/windstille/src/editor/navgraph_select_tool.hpp	2009-09-07 23:28:45 UTC (rev 3205)
@@ -1,59 +0,0 @@
-/*
-**  Windstille - A Sci-Fi Action-Adventure Game
-**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
-**
-**  This program is free software: you can redistribute it and/or modify
-**  it under the terms of the GNU General Public License as published by
-**  the Free Software Foundation, either version 3 of the License, or
-**  (at your option) any later version.
-**  
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-**  
-**  You should have received a copy of the GNU General Public License
-**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-*/
-
-#ifndef HEADER_WINDSTILLE_EDITOR_NAVGRAPH_SELECT_TOOL_HPP
-#define HEADER_WINDSTILLE_EDITOR_NAVGRAPH_SELECT_TOOL_HPP
-
-#include <set>
-
-#include "math/rect.hpp"
-#include "editor/tool.hpp"
-#include "navigation/navigation_graph.hpp"
-
-class NavgraphSelectTool : public Tool
-{
-private:
-  Vector2f click_pos;  
-  Rectf    rect;
-
-  enum { 
-    SELECT_MODE, // select multiple nodes at once
-    DRAG_MODE,   // move nodes around
-    NO_MODE      // mode is determined by next click
-  } mode;
-
-  std::set<NodeHandle> selection;
-
-public:
-  NavgraphSelectTool();
-  ~NavgraphSelectTool();
-
-  void mouse_down(GdkEventButton* event, WindstilleWidget& wst);
-  void mouse_move(GdkEventMotion* event, WindstilleWidget& wst);
-  void mouse_up(GdkEventButton* event, WindstilleWidget& wst);
-  
-  void draw(SceneContext& sc);
-
-private:
-  NavgraphSelectTool(const NavgraphSelectTool&);
-  NavgraphSelectTool& operator=(const NavgraphSelectTool&);
-};
-
-#endif
-
-/* EOF */



From grumbel at mail.berlios.de  Wed Sep  9 01:22:19 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 9 Sep 2009 01:22:19 +0200
Subject: [Windstille-commit] r3206 - trunk/windstille/src/editor
Message-ID: <200909082322.n88NMJGc008064@sheep.berlios.de>

Author: grumbel
Date: 2009-09-09 01:22:14 +0200 (Wed, 09 Sep 2009)
New Revision: 3206

Added:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/document.hpp
Modified:
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/editor_window.hpp
   trunk/windstille/src/editor/layer.cpp
   trunk/windstille/src/editor/layer.hpp
   trunk/windstille/src/editor/navgraph_edge_object_model.cpp
   trunk/windstille/src/editor/navgraph_edge_object_model.hpp
   trunk/windstille/src/editor/navgraph_node_object_model.cpp
   trunk/windstille/src/editor/navgraph_node_object_model.hpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
   trunk/windstille/src/editor/windstille_widget.cpp
   trunk/windstille/src/editor/windstille_widget.hpp
Log:
Trying to split of some WindstilleWidget stuff into Document class

Added: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-07 23:28:45 UTC (rev 3205)
+++ trunk/windstille/src/editor/document.cpp	2009-09-08 23:22:14 UTC (rev 3206)
@@ -0,0 +1,44 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "editor/document.hpp"
+
+#include "editor/undo_manager.hpp"
+#include "editor/sector_model.hpp"
+
+Document::Document()
+  : m_undo_manager(new UndoManager()),
+    m_sector_model(new SectorModel())
+{
+}
+
+Document::~Document()
+{
+}
+
+void
+Document::undo()
+{
+}
+
+void
+Document::redo()
+{
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/document.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/document.hpp
===================================================================
--- trunk/windstille/src/editor/document.hpp	2009-09-07 23:28:45 UTC (rev 3205)
+++ trunk/windstille/src/editor/document.hpp	2009-09-08 23:22:14 UTC (rev 3206)
@@ -0,0 +1,50 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_EDITOR_DOCUMENT_HPP
+#define HEADER_WINDSTILLE_EDITOR_DOCUMENT_HPP
+
+#include <boost/scoped_ptr.hpp>
+
+class UndoManager;
+class SectorModel;
+
+class Document // FIXME: name is not so great
+{
+private:
+  boost::scoped_ptr<UndoManager> m_undo_manager;
+  boost::scoped_ptr<SectorModel> m_sector_model;
+
+public:
+  Document();
+  ~Document();
+
+  UndoManager& get_undo_manager() const { return *m_undo_manager; }
+  SectorModel& get_sector_model() const { return *m_sector_model; }
+
+  void undo();
+  void redo();
+
+private:
+  Document(const Document&);
+  Document& operator=(const Document&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/document.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-07 23:28:45 UTC (rev 3205)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-08 23:22:14 UTC (rev 3206)
@@ -795,15 +795,6 @@
     }
 }
 
-bool
-EditorWindow::get_draw_navgraph() const
-{
-  if (current_tool == navgraph_insert_tool.get())
-    return true;
-  else
-    return false;
-}
-
 void
 EditorWindow::on_switch_page(GtkNotebookPage* /*page*/, guint /*page_num*/)
 {

Modified: trunk/windstille/src/editor/editor_window.hpp
===================================================================
--- trunk/windstille/src/editor/editor_window.hpp	2009-09-07 23:28:45 UTC (rev 3205)
+++ trunk/windstille/src/editor/editor_window.hpp	2009-09-08 23:22:14 UTC (rev 3206)
@@ -157,8 +157,6 @@
 
   void add_recent_file(const std::string& filename);
 
-  bool get_draw_navgraph() const;
-
   void print(const std::string& text);
   bool remove_message(guint id);
 

Modified: trunk/windstille/src/editor/layer.cpp
===================================================================
--- trunk/windstille/src/editor/layer.cpp	2009-09-07 23:28:45 UTC (rev 3205)
+++ trunk/windstille/src/editor/layer.cpp	2009-09-08 23:22:14 UTC (rev 3206)
@@ -53,6 +53,14 @@
   m_sector.rebuild_scene_graph();
 }
 
+Layer::iterator
+Layer::erase(iterator it)
+{
+  it = objects.erase(it);
+  m_sector.rebuild_scene_graph();
+  return it;
+}
+
 void
 Layer::draw(SceneContext& sc, const SelectMask& select_mask)
 {

Modified: trunk/windstille/src/editor/layer.hpp
===================================================================
--- trunk/windstille/src/editor/layer.hpp	2009-09-07 23:28:45 UTC (rev 3205)
+++ trunk/windstille/src/editor/layer.hpp	2009-09-08 23:22:14 UTC (rev 3206)
@@ -66,6 +66,7 @@
 
   void add(const ObjectModelHandle& object);
   void remove(const ObjectModelHandle& object);
+  iterator erase(iterator it);
 
   void draw(SceneContext& sc, const SelectMask& layers);
   void update(float delta);

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-07 23:28:45 UTC (rev 3205)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-08 23:22:14 UTC (rev 3206)
@@ -23,8 +23,8 @@
 #include "scenegraph/scene_graph.hpp"
 #include "scenegraph/vertex_array_drawable.hpp"
 
-NavGraphEdgeObjectModel::NavGraphEdgeObjectModel(boost::weak_ptr<NavGraphNodeObjectModel> lhs,
-                                                 boost::weak_ptr<NavGraphNodeObjectModel> rhs,
+NavGraphEdgeObjectModel::NavGraphEdgeObjectModel(boost::shared_ptr<NavGraphNodeObjectModel> lhs,
+                                                 boost::shared_ptr<NavGraphNodeObjectModel> rhs,
                                                  SectorModel& sector)
   : ObjectModel("NavGraphEdgeObjectModel", Vector2f()),
     m_lhs(lhs),
@@ -33,8 +33,8 @@
     m_edge()
 {
   std::cout << "Adding edge" << std::endl;
-  m_edge = sector.get_nav_graph()->add_edge(lhs.lock()->get_node(),
-                                            rhs.lock()->get_node());
+  m_edge = sector.get_nav_graph()->add_edge(m_lhs->get_node(),
+                                            m_rhs->get_node());
 }
 
 void
@@ -42,19 +42,14 @@
 {
   if (m_drawable)
   {
-    boost::shared_ptr<NavGraphNodeObjectModel> lhs = m_lhs.lock();
-    boost::shared_ptr<NavGraphNodeObjectModel> rhs = m_rhs.lock();
-
-    if (lhs && rhs)
-    {
       m_drawable->clear();
       m_drawable->set_mode(GL_LINES);
+
       m_drawable->color(Color(0.0f, 1.0f, 1.0f));
-      m_drawable->vertex(lhs->get_world_pos());
+      m_drawable->vertex(m_lhs->get_world_pos());
 
       m_drawable->color(Color(0.0f, 1.0f, 1.0f));
-      m_drawable->vertex(rhs->get_world_pos());
-    }
+      m_drawable->vertex(m_rhs->get_world_pos());
   }
 }
 
@@ -69,11 +64,8 @@
 Rectf
 NavGraphEdgeObjectModel::get_bounding_box() const
 {
-  boost::shared_ptr<NavGraphNodeObjectModel> lhs = m_lhs.lock();
-  boost::shared_ptr<NavGraphNodeObjectModel> rhs = m_rhs.lock();
-
-  Rectf rect(lhs->get_world_pos(),
-             rhs->get_world_pos());
+  Rectf rect(m_lhs->get_world_pos(),
+             m_rhs->get_world_pos());
   rect.normalize();
   return rect;
 }
@@ -87,6 +79,11 @@
 void
 NavGraphEdgeObjectModel::write(FileWriter& writer) const
 {
+  writer.start_section("navgraph-edge");
+  ObjectModel::write_member(writer);
+  writer.write("lhs-node", m_lhs->get_id());
+  writer.write("rhs-node", m_rhs->get_id());
+  writer.end_section();
 }
 
 /* EOF */

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-07 23:28:45 UTC (rev 3205)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-08 23:22:14 UTC (rev 3206)
@@ -30,14 +30,14 @@
 class NavGraphEdgeObjectModel : public ObjectModel
 {
 private:
-  boost::weak_ptr<NavGraphNodeObjectModel> m_lhs;
-  boost::weak_ptr<NavGraphNodeObjectModel> m_rhs;
+  boost::shared_ptr<NavGraphNodeObjectModel> m_lhs;
+  boost::shared_ptr<NavGraphNodeObjectModel> m_rhs;
   boost::shared_ptr<VertexArrayDrawable> m_drawable;
   EdgeHandle m_edge;
 
 public:
-  NavGraphEdgeObjectModel(boost::weak_ptr<NavGraphNodeObjectModel> lhs,
-                          boost::weak_ptr<NavGraphNodeObjectModel> rhs,
+  NavGraphEdgeObjectModel(boost::shared_ptr<NavGraphNodeObjectModel> lhs,
+                          boost::shared_ptr<NavGraphNodeObjectModel> rhs,
                           SectorModel& sector);
 
   void add_to_scenegraph(SceneGraph& sg);
@@ -49,6 +49,9 @@
 
   EdgeHandle get_edge() const { return m_edge; }
 
+  boost::shared_ptr<NavGraphNodeObjectModel> get_lhs() const { return m_lhs; }
+  boost::shared_ptr<NavGraphNodeObjectModel> get_rhs() const { return m_rhs; }
+
 private:
   NavGraphEdgeObjectModel(const NavGraphEdgeObjectModel&);
   NavGraphEdgeObjectModel& operator=(const NavGraphEdgeObjectModel&);

Modified: trunk/windstille/src/editor/navgraph_node_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-07 23:28:45 UTC (rev 3205)
+++ trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-08 23:22:14 UTC (rev 3206)
@@ -69,12 +69,6 @@
   m_node->set_pos(get_world_pos());
 }
 
-void
-NavGraphNodeObjectModel::on_remove()
-{
-  // remove connected edges
-}
-
 Rectf
 NavGraphNodeObjectModel::get_bounding_box() const
 {
@@ -91,6 +85,10 @@
 void
 NavGraphNodeObjectModel::write(FileWriter& writer) const
 {
+  writer.start_section("navgraph-node");
+  ObjectModel::write_member(writer);
+  //writer.write("vflip",   vflip);
+  writer.end_section();
 }
 
 /* EOF */

Modified: trunk/windstille/src/editor/navgraph_node_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-07 23:28:45 UTC (rev 3205)
+++ trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-08 23:22:14 UTC (rev 3206)
@@ -38,8 +38,6 @@
   void add_to_scenegraph(SceneGraph& sg);
   void set_rel_pos(const Vector2f& rel_pos_);
   void sync_drawable();
-
-  void on_remove();
   
   NodeHandle get_node() const { return m_node; }
 

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-07 23:28:45 UTC (rev 3205)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-08 23:22:14 UTC (rev 3206)
@@ -217,7 +217,7 @@
 }
 
 void
-SectorModel::draw(SceneContext& sc, const SelectMask& layermask, bool draw_navgraph)
+SectorModel::draw(SceneContext& sc, const SelectMask& layermask)
 {
   // Draw Layers
   const Layers& layers = get_layers();
@@ -227,23 +227,6 @@
       if ((*i)->is_visible())
         (*i)->draw(sc, layermask);
     }
-
-  // Draw Navgraph
-  if (draw_navgraph)
-    {
-      for(NavigationGraph::Edges::iterator i = nav_graph->get_edges().begin(); i != nav_graph->get_edges().end(); ++i)
-        {
-          sc.control().draw_line(Line((*i)->get_node1()->get_pos(),
-                                      (*i)->get_node2()->get_pos()),
-                                 Color(1.0f, 0.0f, 0.0f));
-        }
-
-      for(NavigationGraph::Nodes::iterator i = nav_graph->get_nodes().begin(); i != nav_graph->get_nodes().end(); ++i)
-        {
-          sc.control().fill_rect(Rectf((*i)->get_pos() - Vector2f(4,4), Sizef(9, 9)),
-                                 Color(1.0f, 1.0f, 0.0f));
-        }
-    }
 }
 
 void
@@ -433,7 +416,7 @@
       nav_graph->load(navigation_section);
 
       FileReader layers_section;
-      reader.get("objects", layers_section);
+      reader.get("layers", layers_section);
 
       const std::vector<FileReader>& sections = layers_section.get_sections();
       for(std::vector<FileReader>::const_iterator i = sections.begin(); i != sections.end(); ++i)
@@ -480,7 +463,7 @@
   nav_graph->write(writer);
   writer.end_section();
 
-  writer.start_section("objects");
+  writer.start_section("layers");
   for(Gtk::ListStore::Children::iterator i = layer_tree->children().begin(); i != layer_tree->children().end(); ++i)
     {
       const Gtk::TreeRow& row = *i;
@@ -619,6 +602,8 @@
 boost::shared_ptr<NavGraphNodeObjectModel>
 SectorModel::find_navgraph_node(NodeHandle node) const
 {
+  // FIXME: Could solve this better by either a map/unsorted_set or by having
+  // a userdata ptr in NavGraph
   const Layers& layers = get_layers();
   for(Layers::const_reverse_iterator layer = layers.rbegin(); layer != layers.rend(); ++layer)
   {
@@ -644,6 +629,8 @@
 boost::shared_ptr<NavGraphEdgeObjectModel>
 SectorModel::find_navgraph_edge(EdgeHandle edge) const
 {
+  // FIXME: Could solve this better by either a map/unsorted_set or by having
+  // a userdata ptr in NavGraph
   const Layers& layers = get_layers();
   for(Layers::const_reverse_iterator layer = layers.rbegin(); layer != layers.rend(); ++layer)
   {
@@ -665,5 +652,32 @@
   
   return boost::shared_ptr<NavGraphEdgeObjectModel>(); 
 }
+
+void
+SectorModel::delete_navgraph_edges(NavGraphNodeObjectModel& node)
+{
+  // FIXME: Kind of ugly, higher level template might help
+  const Layers& layers = get_layers();
+  for(Layers::const_reverse_iterator layer = layers.rbegin(); layer != layers.rend(); ++layer)
+  {
+    if (*layer)
+    {
+      for(Layer::const_iterator obj = (*layer)->begin(); obj != (*layer)->end(); ++obj)
+      {
+        boost::shared_ptr<NavGraphEdgeObjectModel> edge = boost::dynamic_pointer_cast<NavGraphEdgeObjectModel>(*obj);
+        if (edge)
+        {
+          /*
+          if (edge.get_lhs().get() == &node ||
+              edge.get_rhs().get() == &node)
+          {
+
+          }
+          */
+        }
+      }
+    }
+  }  
+}
 
 /* EOF */

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-07 23:28:45 UTC (rev 3205)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-08 23:22:14 UTC (rev 3206)
@@ -88,7 +88,7 @@
   SectorModel();
   ~SectorModel();
 
-  void draw(SceneContext& sc, const SelectMask& layers, bool draw_navgraph);
+  void draw(SceneContext& sc, const SelectMask& layers);
 
   void update(float delta);
 
@@ -140,6 +140,7 @@
 
   boost::shared_ptr<NavGraphNodeObjectModel> find_navgraph_node(NodeHandle node) const;
   boost::shared_ptr<NavGraphEdgeObjectModel> find_navgraph_edge(EdgeHandle edge) const;
+  void delete_navgraph_edges(NavGraphNodeObjectModel& node);
 
   void queue_draw();
 

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-07 23:28:45 UTC (rev 3205)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-08 23:22:14 UTC (rev 3206)
@@ -37,7 +37,7 @@
 #include "editor/group_command.hpp"
 #include "editor/object_commands.hpp"
 #include "editor/functor_command.hpp"
-
+#include "editor/document.hpp"
 #include "editor/sprite_object_model.hpp"
 #include "editor/windstille_widget.hpp"
 
@@ -47,19 +47,18 @@
                                    const Glib::RefPtr<const Gdk::GL::Config>&  glconfig,
                                    const Glib::RefPtr<const Gdk::GL::Context>& share_list)
   : editor(editor_),
-    undo_manager(new UndoManager()),
+    document(new Document),
     filename(),
-    sector_model(new SectorModel()),
     control_points(),
     state(),
     compositor(),
     sc(),
-    scroll_tool(new ScrollTool()),
+    scroll_tool(new ScrollTool),
     selection(),
     map_type(DecalObjectModel::COLORMAP),
     background_pattern(),
-    draw_background_pattern(true),
     select_mask(1),
+    draw_background_pattern(true),
     draw_only_active_layers(true),
     grid_enabled(false)
 {
@@ -130,9 +129,9 @@
 void
 WindstilleWidget::execute(CommandHandle cmd)
 {
-  undo_manager->execute(cmd);
+  document->get_undo_manager().execute(cmd);
   EditorWindow::current()->update_undo_state();
-  sector_model->rebuild_scene_graph();
+  document->get_sector_model().rebuild_scene_graph();
 }
 
 bool
@@ -257,7 +256,7 @@
 WindstilleWidget::update(float delta)
 {
   std::cout << this << " WindstilleWidget::update(" << delta << ")" << std::endl;
-  sector_model->update(delta);
+  document->get_sector_model().update(delta);
   queue_draw();
 }
 
@@ -268,7 +267,7 @@
     {
       state.push(*sc);
       
-      sc->light().fill_screen(sector_model->get_ambient_color());
+      sc->light().fill_screen(document->get_sector_model().get_ambient_color());
 
       if (draw_background_pattern)
         {
@@ -281,9 +280,9 @@
         }
 
       if (draw_only_active_layers)
-        sector_model->draw(*sc, SelectMask(), editor.get_draw_navgraph());
+        document->get_sector_model().draw(*sc, SelectMask());
       else
-        sector_model->draw(*sc, select_mask, editor.get_draw_navgraph());
+        document->get_sector_model().draw(*sc, select_mask);
 
       if (!selection->empty())
         {
@@ -306,7 +305,7 @@
           EditorWindow::current()->get_current_tool()->draw(*sc);
         }
 
-      compositor->render(*sc, sector_model->get_scene_graph(), state);
+      compositor->render(*sc, document->get_sector_model().get_scene_graph(), state);
 
       state.pop(*sc);
 
@@ -321,13 +320,13 @@
 void
 WindstilleWidget::undo()
 {
-  undo_manager->undo();
+  document->get_undo_manager().undo();
 }
 
 void
 WindstilleWidget::redo()
 {
-  undo_manager->redo();
+  document->get_undo_manager().redo();
 }
 
 void
@@ -335,7 +334,7 @@
 {
   for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
     {
-      sector_model->raise(*i);
+      document->get_sector_model().raise(*i);
     }
   queue_draw();
 }
@@ -345,7 +344,7 @@
 {
   for(Selection::reverse_iterator i = selection->rbegin(); i != selection->rend(); ++i)
     {
-      sector_model->lower(*i);
+      document->get_sector_model().lower(*i);
     }
   queue_draw();
 }
@@ -355,7 +354,7 @@
 {
   for(Selection::reverse_iterator i = selection->rbegin(); i != selection->rend(); ++i)
     {
-      sector_model->raise_to_top(*i);
+      document->get_sector_model().raise_to_top(*i);
     }
   queue_draw();
 }
@@ -365,7 +364,7 @@
 {
   for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
     {
-      sector_model->lower_to_bottom(*i);
+      document->get_sector_model().lower_to_bottom(*i);
     }
   queue_draw();
 }
@@ -482,7 +481,7 @@
   SelectionHandle new_selection = Selection::create();
   for(Selection::reverse_iterator i = selection->rbegin(); i != selection->rend(); ++i)
     {
-      LayerHandle layer = sector_model->get_layer(*i);
+      LayerHandle layer = document->get_sector_model().get_layer(*i);
       ObjectModelHandle obj = (*i)->clone();
 
       parent_map[*i] = obj;
@@ -578,7 +577,7 @@
   boost::shared_ptr<GroupCommand> group_cmd(new GroupCommand());
   for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
     {
-      group_cmd->add(CommandHandle(new ObjectRemoveCommand(*sector_model, *i)));
+      group_cmd->add(CommandHandle(new ObjectRemoveCommand(document->get_sector_model(), *i)));
     }
 
   execute(group_cmd);
@@ -587,13 +586,13 @@
 }
 
 bool
-WindstilleWidget::scroll(GdkEventScroll* event_)
+WindstilleWidget::scroll(GdkEventScroll* ev)
 {
-  if (event_->direction == GDK_SCROLL_UP)
+  if (ev->direction == GDK_SCROLL_UP)
     {
       //viewer->get_state().zoom(1.1f, Vector2i(event->x, event->y));
     }
-  else if (event_->direction == GDK_SCROLL_DOWN)
+  else if (ev->direction == GDK_SCROLL_DOWN)
     {
       //viewer->get_state().zoom(1.0f/1.1f, Vector2i(event->x, event->y));
     }
@@ -601,25 +600,25 @@
 }
 
 bool
-WindstilleWidget::mouse_down(GdkEventButton* event_)
+WindstilleWidget::mouse_down(GdkEventButton* ev)
 {
   grab_focus();
 
-  //std::cout << "Button Press: " << event_->x << ", " << event_->y << " - " << event_->button << std::endl;
+  //std::cout << "Button Press: " << ev->x << ", " << ev->y << " - " << ev->button << std::endl;
 
-  if (event_->button == 1)
+  if (ev->button == 1)
     { // Tool
-      EditorWindow::current()->get_current_tool()->mouse_down(event_, *this);
+      EditorWindow::current()->get_current_tool()->mouse_down(ev, *this);
       return true;
     }
-  else if (event_->button == 2)
+  else if (ev->button == 2)
     { // Scroll
-      scroll_tool->mouse_down(event_, *this);
+      scroll_tool->mouse_down(ev, *this);
       return true;
     }
-  else if (event_->button == 3)
+  else if (ev->button == 3)
     { // Context Menu
-      EditorWindow::current()->get_current_tool()->mouse_right_down(event_, *this);
+      EditorWindow::current()->get_current_tool()->mouse_right_down(ev, *this);
       return true;
     }
   else
@@ -629,29 +628,29 @@
 }
 
 bool
-WindstilleWidget::mouse_move(GdkEventMotion* event_)
+WindstilleWidget::mouse_move(GdkEventMotion* ev)
 {
-  //std::cout << "Motion: " << event_->x << ", " << event_->y << std::endl;
+  //std::cout << "Motion: " << ev->x << ", " << ev->y << std::endl;
   
-  EditorWindow::current()->get_current_tool()->mouse_move(event_, *this);
-  scroll_tool->mouse_move(event_, *this);
+  EditorWindow::current()->get_current_tool()->mouse_move(ev, *this);
+  scroll_tool->mouse_move(ev, *this);
   
   return true;
 }
 
 bool
-WindstilleWidget::mouse_up(GdkEventButton* event_)
+WindstilleWidget::mouse_up(GdkEventButton* ev)
 {
-  //std::cout << "Button Release: " << event_->x << ", " << event_->y << " - " << event_->button << std::endl;
-  //viewer->on_mouse_button_up(Vector2i(event_->x, event_->y), event_->button);
-  if (event_->button == 1)
+  //std::cout << "Button Release: " << ev->x << ", " << ev->y << " - " << ev->button << std::endl;
+  //viewer->on_mouse_button_up(Vector2i(ev->x, ev->y), ev->button);
+  if (ev->button == 1)
     {
-      EditorWindow::current()->get_current_tool()->mouse_up(event_, *this);
+      EditorWindow::current()->get_current_tool()->mouse_up(ev, *this);
       queue_draw();
     }
-  else if (event_->button == 2)
+  else if (ev->button == 2)
     {
-      scroll_tool->mouse_up(event_, *this);
+      scroll_tool->mouse_up(ev, *this);
       queue_draw();
     }
 
@@ -659,11 +658,11 @@
 }
 
 bool
-WindstilleWidget::key_press(GdkEventKey* event_)
+WindstilleWidget::key_press(GdkEventKey* ev)
 {
-  //std::cout << event_->keyval << " keypress " << state.get_pos() << std::endl;
+  //std::cout << ev->keyval << " keypress " << state.get_pos() << std::endl;
 
-  switch(event_->keyval)
+  switch(ev->keyval)
     {
       case GDK_1:
         map_type = DecalObjectModel::COLORMAP;
@@ -720,9 +719,9 @@
 }
 
 bool
-WindstilleWidget::key_release(GdkEventKey* /*event_*/)
+WindstilleWidget::key_release(GdkEventKey* ev)
 { // /usr/include/gtk-2.0/gdk/gdkkeysyms.h
-  //std::cout << "KeyRelease: " << (int)event_->keyval << std::endl;
+  //std::cout << "KeyRelease: " << (int)ev->keyval << std::endl;
   return true;
 }
 
@@ -764,7 +763,7 @@
     }
   else
     {
-      execute(CommandHandle(new ObjectAddCommand(sector_model->get_layer(path_), object)));
+      execute(CommandHandle(new ObjectAddCommand(document->get_sector_model().get_layer(path_), object)));
     }
 }
 
@@ -825,7 +824,7 @@
     }
   else
     {
-      return sector_model->get_layer(path_);  
+      return document->get_sector_model().get_layer(path_);  
     }
 }
 
@@ -897,17 +896,11 @@
     }
 }
 
-SectorModel*
-WindstilleWidget::get_sector_model()
-{
-  return sector_model.get();
-}
-
 void
 WindstilleWidget::load_file(const std::string& filename_)
 {
   filename = filename_;
-  sector_model->load(filename);
+  document->get_sector_model().load(filename);
   queue_draw();
 }
 

Modified: trunk/windstille/src/editor/windstille_widget.hpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.hpp	2009-09-07 23:28:45 UTC (rev 3205)
+++ trunk/windstille/src/editor/windstille_widget.hpp	2009-09-08 23:22:14 UTC (rev 3206)
@@ -40,6 +40,9 @@
 #include "editor/select_mask.hpp"
 #include "editor/layer.hpp"
 #include "editor/command.hpp"
+#include "editor/sector_model.hpp"
+#include "editor/undo_manager.hpp"
+#include "editor/document.hpp"
 
 class Tool;
 class UndoManager;
@@ -56,10 +59,9 @@
 private:
   EditorWindow& editor;
 
-  boost::scoped_ptr<UndoManager> undo_manager;
+  boost::scoped_ptr<Document> document;
 
   std::string filename;
-  boost::scoped_ptr<SectorModel> sector_model;
   std::vector<ControlPointHandle> control_points;
 
   GraphicContextState   state;
@@ -69,14 +71,14 @@
   SelectionHandle selection;
   DecalObjectModel::MapType map_type;
   Texture background_pattern;
+  SelectMask select_mask;
   bool draw_background_pattern;
-  SelectMask select_mask;
   bool draw_only_active_layers;
   bool grid_enabled;
   
 public:
   WindstilleWidget(EditorWindow& editor,
-                   const Glib::RefPtr<const Gdk::GL::Config>& glconfig,
+                   const Glib::RefPtr<const Gdk::GL::Config>&  glconfig,
                    const Glib::RefPtr<const Gdk::GL::Context>& share_list);
   virtual ~WindstilleWidget();
 
@@ -133,8 +135,8 @@
 
   void selection_object_properties();
 
-  SectorModel* get_sector_model();
-  UndoManager* get_undo_manager() const { return undo_manager.get(); }
+  SectorModel* get_sector_model() const { return &(document->get_sector_model()); }
+  UndoManager* get_undo_manager() const { return &(document->get_undo_manager()); }
   void set_selection(const SelectionHandle& selection);
   SelectionHandle get_selection() const;
 



From grumbel at mail.berlios.de  Wed Sep  9 02:37:27 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 9 Sep 2009 02:37:27 +0200
Subject: [Windstille-commit] r3207 - trunk/windstille/src/editor
Message-ID: <200909090037.n890bRXk018645@sheep.berlios.de>

Author: grumbel
Date: 2009-09-09 02:37:20 +0200 (Wed, 09 Sep 2009)
New Revision: 3207

Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/document.hpp
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/editor_window.hpp
   trunk/windstille/src/editor/select_tool.cpp
   trunk/windstille/src/editor/windstille_widget.cpp
   trunk/windstille/src/editor/windstille_widget.hpp
Log:
Moving more things into Document, breaking stuff along the way

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-08 23:22:14 UTC (rev 3206)
+++ trunk/windstille/src/editor/document.cpp	2009-09-09 00:37:20 UTC (rev 3207)
@@ -18,12 +18,26 @@
 
 #include "editor/document.hpp"
 
+#include <boost/bind.hpp>
+
+#include "editor/selection.hpp"
 #include "editor/undo_manager.hpp"
 #include "editor/sector_model.hpp"
+#include "editor/editor_window.hpp"
+#include "editor/object_model.hpp"
+#include "editor/decal_object_model.hpp"
 
+#include "editor/group_command.hpp"
+#include "editor/object_commands.hpp"
+#include "editor/functor_command.hpp"
+#include "editor/layer_commands.hpp"
+
 Document::Document()
   : m_undo_manager(new UndoManager()),
-    m_sector_model(new SectorModel())
+    m_sector_model(new SectorModel()),
+    m_selection(Selection::create()),
+    m_control_points(),
+    m_sig_on_change()
 {
 }
 
@@ -34,11 +48,326 @@
 void
 Document::undo()
 {
+  m_undo_manager->undo();
 }
 
 void
 Document::redo()
 {
+  m_undo_manager->redo();
 }
 
+void
+Document::execute(CommandHandle cmd)
+{
+  // FIXME: All stuff should be routed through this
+  m_undo_manager->execute(cmd);
+  EditorWindow::current()->update_undo_state();
+  m_sector_model->rebuild_scene_graph();
+  m_sig_on_change();
+}
+
+void
+Document::selection_raise()
+{
+  for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+    {
+      m_sector_model->raise(*i);
+    }
+
+  m_sig_on_change();
+}
+
+void
+Document::selection_lower()
+{
+  for(Selection::reverse_iterator i = m_selection->rbegin(); i != m_selection->rend(); ++i)
+    {
+      m_sector_model->lower(*i);
+    }
+
+  m_sig_on_change();
+}
+
+void
+Document::selection_raise_to_top()
+{
+  for(Selection::reverse_iterator i = m_selection->rbegin(); i != m_selection->rend(); ++i)
+    {
+      m_sector_model->raise_to_top(*i);
+    }
+
+  m_sig_on_change();
+}
+
+void
+Document::selection_lower_to_bottom()
+{
+  for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+    {
+      m_sector_model->lower_to_bottom(*i);
+    }
+
+  m_sig_on_change();
+}
+
+void
+Document::selection_vflip()
+{
+  if (!m_selection->empty())
+    {
+      boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
+
+      if (m_selection->size() > 1)
+        {
+          const Vector2f& center = m_selection->get_bounding_box().get_center();
+          for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+            {
+              Vector2f pos = (*i)->get_world_pos();
+          
+              pos.y = center.y + (center.y - pos.y);
+          
+              //(*i)->set_world_pos(pos);
+              group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_world_pos, *i, (*i)->get_world_pos()),
+                                                                  boost::bind(&ObjectModel::set_world_pos, *i, pos))));
+            }
+        }
+
+      for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+        {
+          //(*i)->set_vflip(!(*i)->get_vflip());
+          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_vflip, *i,  (*i)->get_vflip()),
+                                                              boost::bind(&ObjectModel::set_vflip, *i, !(*i)->get_vflip()))));
+        }
+
+      execute(group_command);
+    }
+}
+
+void
+Document::selection_hflip()
+{
+  if (!m_selection->empty())
+    {
+      boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
+
+      if (m_selection->size() > 1)
+        {
+          const Vector2f& center = m_selection->get_bounding_box().get_center();
+          for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+            {
+              Vector2f pos = (*i)->get_world_pos();
+          
+              pos.x = center.x + (center.x - pos.x);
+          
+              //(*i)->set_world_pos(pos);
+              group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_world_pos, *i, (*i)->get_world_pos()),
+                                                                  boost::bind(&ObjectModel::set_world_pos, *i, pos))));
+            }
+        }
+
+      for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+        {
+          //(*i)->set_hflip(!(*i)->get_hflip());
+          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_hflip, *i,  (*i)->get_hflip()),
+                                                              boost::bind(&ObjectModel::set_hflip, *i, !(*i)->get_hflip()))));
+        }
+
+      execute(group_command);
+    }
+}
+
+void
+Document::selection_connect_parent()
+{
+  if (m_selection->size() >= 2)
+    {
+      boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
+
+      ObjectModelHandle parent = *m_selection->begin();
+
+      Selection::iterator i = m_selection->begin();
+      ++i;
+      for(; i != m_selection->end(); ++i)
+        {
+          //(*i)->set_parent(parent);
+          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_parent, *i, (*i)->get_parent(), true),
+                                                              boost::bind(&ObjectModel::set_parent, *i, parent, true))));
+        }
+
+      execute(group_command);
+    }
+}
+
+void
+Document::selection_clear_parent()
+{
+  boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
+
+  for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+    {
+      //(*i)->set_parent(ObjectModelHandle());
+      group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_parent, *i, (*i)->get_parent(), true),
+                                                          boost::bind(&ObjectModel::set_parent, *i, ObjectModelHandle(), true))));
+    }
+
+  execute(group_command);
+}
+
+void
+Document::selection_duplicate()
+{
+  boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
+  std::map<ObjectModelHandle, ObjectModelHandle> parent_map;
+
+  SelectionHandle new_selection = Selection::create();
+  for(Selection::reverse_iterator i = m_selection->rbegin(); i != m_selection->rend(); ++i)
+    {
+      LayerHandle layer = m_sector_model->get_layer(*i);
+      ObjectModelHandle obj = (*i)->clone();
+
+      parent_map[*i] = obj;
+
+      if (!layer)
+        {
+          EditorWindow::current()->print("Couldn't find parent layer while duplicating");
+        }
+      else
+        {
+          // Move clone a litte to make it more obvious that something happened
+          obj->set_rel_pos(obj->get_rel_pos() + Vector2f(32.0f, 32.0f));
+          new_selection->add(obj);
+
+          //layer->add(obj);
+          group_command->add(CommandHandle(new ObjectAddCommand(layer, obj)));
+        }
+    }
+
+  // Second pass to set the parents to the cloned objects
+  for(Selection::iterator i = new_selection->begin(); i != new_selection->end(); ++i)
+    {
+      if ((*i)->get_parent())
+        {
+          std::map<ObjectModelHandle, ObjectModelHandle>::iterator it = parent_map.find((*i)->get_parent());
+          
+          if (it == parent_map.end())
+            {
+              // When the parent wasn't part of the selection, leave
+              // the parent untouched
+            }
+          else
+            {
+              (*i)->set_parent(it->second);
+            }
+        }
+    }
+
+  execute(group_command);
+  set_selection(new_selection);
+}
+
+void
+Document::selection_reset_rotation()
+{
+  boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
+
+  for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+    {
+      DecalObjectModel* decal = dynamic_cast<DecalObjectModel*>(i->get());
+
+      if (decal)
+        {
+          //decal->set_angle(0.0f);
+          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&DecalObjectModel::set_angle, decal, decal->get_angle()),
+                                                              boost::bind(&DecalObjectModel::set_angle, decal, 0.0f))));
+        }
+    }
+
+  on_selection_change();
+  execute(group_command);
+}
+
+void
+Document::selection_object_properties()
+{
+  std::cout << "Display Dialog" << std::endl;
+}
+
+void
+Document::selection_reset_scale()
+{
+  boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
+
+ for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+    {
+      DecalObjectModel* decal = dynamic_cast<DecalObjectModel*>(i->get());
+      if (decal)
+        {
+          //decal->set_scale(Vector2f(1.0f, 1.0f));
+          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&DecalObjectModel::set_scale, decal, decal->get_scale()),
+                                                              boost::bind(&DecalObjectModel::set_scale, decal, Vector2f(1.0f, 1.0f)))));
+        }
+    }
+
+ on_selection_change();
+ execute(group_command);
+}
+
+void
+Document::selection_delete()
+{
+  boost::shared_ptr<GroupCommand> group_cmd(new GroupCommand());
+  for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+    {
+      group_cmd->add(CommandHandle(new ObjectRemoveCommand(*m_sector_model, *i)));
+    }
+  execute(group_cmd);
+  m_selection->clear();
+}
+
+void
+Document::set_selection(const SelectionHandle& selection)
+{
+  m_selection = selection;
+  m_selection->signal_changed.connect(sigc::mem_fun(*this, &Document::on_selection_change));
+  on_selection_change();
+}
+
+void
+Document::on_selection_change()
+{
+  m_control_points.clear();
+
+  if (!m_selection->is_moving())
+    {
+      m_selection->add_control_points(m_control_points);
+    }
+}
+
+ControlPointHandle
+Document::get_control_point(const Vector2f& pos) const
+{
+  for(std::vector<ControlPointHandle>::const_iterator i = m_control_points.begin();  
+      i != m_control_points.end(); ++i)
+    {
+      if ((*i)->get_bounding_box().is_inside(pos))
+        return *i;
+    }
+  return ControlPointHandle();
+}
+
+void
+Document::clear_control_points()
+{
+  m_control_points.clear();
+}
+
+void
+Document::create_control_points()
+{
+  m_control_points.clear();
+  m_selection->add_control_points(m_control_points);
+}
+
+
 /* EOF */

Modified: trunk/windstille/src/editor/document.hpp
===================================================================
--- trunk/windstille/src/editor/document.hpp	2009-09-08 23:22:14 UTC (rev 3206)
+++ trunk/windstille/src/editor/document.hpp	2009-09-09 00:37:20 UTC (rev 3207)
@@ -21,25 +21,72 @@
 
 #include <boost/scoped_ptr.hpp>
 
+#include "editor/selection.hpp"
+#include "editor/command.hpp"
+
 class UndoManager;
 class SectorModel;
 
+/**
+ *  Document wraps SectorModel with undo/redo functionality and
+ *  provides data and functions for editing that are not part of the
+ *  central data, such as selections.
+ */
 class Document // FIXME: name is not so great
 {
 private:
   boost::scoped_ptr<UndoManager> m_undo_manager;
   boost::scoped_ptr<SectorModel> m_sector_model;
 
+  SelectionHandle m_selection;
+
+  std::vector<ControlPointHandle> m_control_points;
+
+  sigc::signal<void> m_sig_on_change;
+
 public:
   Document();
   ~Document();
 
   UndoManager& get_undo_manager() const { return *m_undo_manager; }
   SectorModel& get_sector_model() const { return *m_sector_model; }
+  SelectionHandle get_selection() const { return m_selection; }
 
   void undo();
   void redo();
+  void execute(CommandHandle cmd);
+  
+  void selection_raise();
+  void selection_lower();
 
+  void selection_raise_to_top();
+  void selection_lower_to_bottom();
+
+  void selection_vflip();
+  void selection_hflip();
+
+  void selection_connect_parent();
+  void selection_clear_parent();
+  
+  void selection_duplicate();
+  void selection_delete();
+
+  void selection_reset_rotation();
+  void selection_reset_scale();
+
+  void selection_object_properties();
+
+  void set_selection(const SelectionHandle& selection);
+
+  void on_selection_change();
+
+  ControlPointHandle get_control_point(const Vector2f& pos) const;
+
+  void clear_control_points();
+  void create_control_points();
+
+  sigc::signal<void>& signal_on_change() { return m_sig_on_change; }
+
 private:
   Document(const Document&);
   Document& operator=(const Document&);

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-08 23:22:14 UTC (rev 3206)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-09 00:37:20 UTC (rev 3207)
@@ -44,6 +44,7 @@
 #include "editor/navgraph_insert_tool.hpp"
 #include "editor/sector_model.hpp"
 #include "editor/layer_widget.hpp"
+#include "editor/document.hpp"
 
 #include "editor/editor_window.hpp"
 
@@ -276,38 +277,38 @@
                     sigc::mem_fun(*this, &EditorWindow::on_select_all));
 
   action_group->add(Gtk::Action::create("Delete",      Gtk::Stock::DELETE),
-                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_windstille_widget), &WindstilleWidget::selection_delete));
+                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_document), &Document::selection_delete));
   action_group->add(Gtk::Action::create_with_icon_name("Duplicate", "duplicate", "Duplicate Object", "Duplicate Object"),
                     Gtk::AccelKey(GDK_d, Gdk::CONTROL_MASK),
-                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_windstille_widget), &WindstilleWidget::selection_duplicate));
+                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_document), &Document::selection_duplicate));
 
   action_group->add(Gtk::Action::create("MenuObject",    "_Object"));
   action_group->add(Gtk::Action::create_with_icon_name("RaiseObjectToTop", "object_raise_to_top", "Raise To Top", "Raise Object to Top"),
-                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_windstille_widget), &WindstilleWidget::selection_raise_to_top));
+                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_document), &Document::selection_raise_to_top));
   action_group->add(Gtk::Action::create_with_icon_name("RaiseObject", "object_raise", "Raise", "Raise Object"),
-                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_windstille_widget), &WindstilleWidget::selection_raise));
+                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_document), &Document::selection_raise));
   action_group->add(Gtk::Action::create_with_icon_name("LowerObject", "object_lower", "Lower", "Lower Object"),
-                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_windstille_widget), &WindstilleWidget::selection_lower));                    
+                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_document), &Document::selection_lower));                    
   action_group->add(Gtk::Action::create_with_icon_name("LowerObjectToBottom", "object_lower_to_bottom", "Lower To Bottom", "Lower Object to Bottom"),
-                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_windstille_widget), &WindstilleWidget::selection_lower_to_bottom));
+                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_document), &Document::selection_lower_to_bottom));
 
   action_group->add(Gtk::Action::create_with_icon_name("ConnectParent", "connect_parent", "Connect Parent", "Connect Parent"),
-                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_windstille_widget), &WindstilleWidget::selection_connect_parent));
+                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_document), &Document::selection_connect_parent));
   action_group->add(Gtk::Action::create_with_icon_name("ClearParent", "clear_parent", "Clear Parent", "Clear Parent"),
-                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_windstille_widget), &WindstilleWidget::selection_clear_parent));
+                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_document), &Document::selection_clear_parent));
 
   action_group->add(Gtk::Action::create_with_icon_name("ResetRotation", "reload", "Reset Rotation", "Reset Rotation"),
-                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_windstille_widget), &WindstilleWidget::selection_reset_rotation));
+                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_document), &Document::selection_reset_rotation));
   action_group->add(Gtk::Action::create_with_icon_name("ResetScale", "reload", "Reset Scale", "Reset Scale"),
-                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_windstille_widget), &WindstilleWidget::selection_reset_scale));
+                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_document), &Document::selection_reset_scale));
 
   action_group->add(Gtk::Action::create_with_icon_name("ObjectProperties", "properties", "Object Properties", "Object Properties"),
-                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_windstille_widget), &WindstilleWidget::selection_object_properties));
+                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_document), &Document::selection_object_properties));
 
   action_group->add(Gtk::Action::create_with_icon_name("HFlipObject", "object_hflip", "Horizontal Flip", "Horizontal Flip"),
-                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_windstille_widget), &WindstilleWidget::selection_hflip));
+                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_document), &Document::selection_hflip));
   action_group->add(Gtk::Action::create_with_icon_name("VFlipObject", "object_vflip", "Vertical Flip", "Vertical Flip"),
-                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_windstille_widget), &WindstilleWidget::selection_vflip));
+                    sigc::bind(sigc::mem_fun(*this, &EditorWindow::call_with_document), &Document::selection_vflip));
 
   action_group->add(Gtk::Action::create("MenuView",    "_View"));
   action_group->add(Gtk::Action::create("Zoom100",     Gtk::Stock::ZOOM_100),
@@ -695,7 +696,7 @@
 {
   if (WindstilleWidget* wst = get_windstille_widget())
     {
-      wst->undo();
+      wst->get_document().undo();
       update_undo_state();
       queue_draw();
     }
@@ -706,7 +707,7 @@
 {
   if (WindstilleWidget* wst = get_windstille_widget())
     {
-      wst->redo();
+      wst->get_document().redo();
       update_undo_state();
       queue_draw();
     }
@@ -823,12 +824,12 @@
 }
 
 void
-EditorWindow::call_with_windstille_widget(void (WindstilleWidget::*func)())
+EditorWindow::call_with_document(void (Document::*func)())
 {
   WindstilleWidget* wst = get_windstille_widget();
   if (wst)
     {
-      (wst->*func)();
+      (wst->get_document().*func)();
     }
 }
 
@@ -876,8 +877,8 @@
 {
   if (WindstilleWidget* wst = get_windstille_widget())
     {
-      clipboard = wst->get_selection()->clone();
-      wst->selection_delete();
+      clipboard = wst->get_document().get_selection()->clone();
+      wst->get_document().selection_delete();
       queue_draw();
     }
 }
@@ -887,7 +888,7 @@
 {
   if (WindstilleWidget* wst = get_windstille_widget())
     {
-      clipboard = wst->get_selection()->clone();
+      clipboard = wst->get_document().get_selection()->clone();
     }
 }
 
@@ -942,7 +943,7 @@
               layer->add(*i);
             }
 
-          wst->set_selection(clipboard);
+          wst->get_document().set_selection(clipboard);
           clipboard = clipboard->clone();
           queue_draw();
         }
@@ -958,7 +959,7 @@
       LayerHandle layer = wst->get_current_layer();
       SelectionHandle selection = Selection::create();
       selection->add(layer->begin(), layer->end());
-      wst->set_selection(selection);
+      wst->get_document().set_selection(selection);
     }
 }
 

Modified: trunk/windstille/src/editor/editor_window.hpp
===================================================================
--- trunk/windstille/src/editor/editor_window.hpp	2009-09-08 23:22:14 UTC (rev 3206)
+++ trunk/windstille/src/editor/editor_window.hpp	2009-09-09 00:37:20 UTC (rev 3207)
@@ -34,6 +34,7 @@
 #include "editor/minimap_widget.hpp"
 #include "editor/object_selector.hpp"
 #include "editor/layer_manager.hpp"
+#include "editor/document.hpp"
 
 class Tool;
 class WindstilleWidget;
@@ -148,7 +149,7 @@
   /** Queue a file to be loaded once the editor is full realized */
   void queue_for_load(const std::string& filename);
 
-  void call_with_windstille_widget(void (WindstilleWidget::*func)());
+  void call_with_document(void (Document::*func)());
 
   void on_recent_file(const Glib::RefPtr<Gtk::RecentAction>& recent_action);
   

Modified: trunk/windstille/src/editor/select_tool.cpp
===================================================================
--- trunk/windstille/src/editor/select_tool.cpp	2009-09-08 23:22:14 UTC (rev 3206)
+++ trunk/windstille/src/editor/select_tool.cpp	2009-09-09 00:37:20 UTC (rev 3207)
@@ -43,11 +43,11 @@
   start_time = event->time;
   click_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
 
-  ctrl_point = wst.get_control_point(click_pos);
+  ctrl_point = wst.get_document().get_control_point(click_pos);
   if (ctrl_point)
     {
       mode = CONTROL_DRAG_MODE;
-      wst.clear_control_points();
+      wst.get_document().clear_control_points();
       ctrl_point->on_move_start(event);
     }
   else
@@ -55,30 +55,30 @@
       ObjectModelHandle object = wst.get_sector_model()->get_object_at(click_pos, wst.get_select_mask());
       if (object.get())
         {
-          if (wst.get_selection()->has_object(object))
+          if (wst.get_document().get_selection()->has_object(object))
             {
-              selection = wst.get_selection();
+              selection = wst.get_document().get_selection();
               if (event->state & GDK_SHIFT_MASK)
                 {
                   selection->remove(object);
                 }
               else
                 {
-                  selection = wst.get_selection();
+                  selection = wst.get_document().get_selection();
                 }
             }
           else
             {
               if (event->state & GDK_SHIFT_MASK)
                 {
-                  selection = wst.get_selection();
+                  selection = wst.get_document().get_selection();
                   selection->add(object);
                 }
               else
                 {
                   selection = Selection::create();
                   selection->add(object);
-                  wst.set_selection(selection);
+                  wst.get_document().set_selection(selection);
                 }
             }
       
@@ -175,7 +175,7 @@
   if (mode == CONTROL_DRAG_MODE)
     {
       ctrl_point->on_move_end(event, pos - click_pos);
-      wst.create_control_points();
+      wst.get_document().create_control_points();
       wst.queue_draw();
     }
   else if (mode == OBJECT_DRAG_MODE)
@@ -205,11 +205,11 @@
       if (event->state & GDK_SHIFT_MASK)
         {
           SelectionHandle new_selection = wst.get_sector_model()->get_selection(rect, wst.get_select_mask());
-          wst.get_selection()->add(new_selection->begin(), new_selection->end());
+          wst.get_document().get_selection()->add(new_selection->begin(), new_selection->end());
         }
       else
         {
-          wst.set_selection(wst.get_sector_model()->get_selection(rect, wst.get_select_mask()));
+          wst.get_document().set_selection(wst.get_sector_model()->get_selection(rect, wst.get_select_mask()));
         }
       wst.queue_draw();
     }

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-08 23:22:14 UTC (rev 3206)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-09 00:37:20 UTC (rev 3207)
@@ -47,14 +47,13 @@
                                    const Glib::RefPtr<const Gdk::GL::Config>&  glconfig,
                                    const Glib::RefPtr<const Gdk::GL::Context>& share_list)
   : editor(editor_),
-    document(new Document),
+    m_document(new Document),
     filename(),
     control_points(),
     state(),
     compositor(),
     sc(),
     scroll_tool(new ScrollTool),
-    selection(),
     map_type(DecalObjectModel::COLORMAP),
     background_pattern(),
     select_mask(1),
@@ -119,7 +118,7 @@
   targets.push_back(Gtk::TargetEntry("application/x-windstille-decal"));
   drag_dest_set(targets, Gtk::DEST_DEFAULT_ALL, Gdk::ACTION_COPY);
 
-  set_selection(Selection::create());
+  m_document->signal_on_change().connect(sigc::mem_fun(this, &WindstilleWidget::on_document_change));
 }
 
 WindstilleWidget::~WindstilleWidget()
@@ -129,9 +128,9 @@
 void
 WindstilleWidget::execute(CommandHandle cmd)
 {
-  document->get_undo_manager().execute(cmd);
+  m_document->get_undo_manager().execute(cmd);
   EditorWindow::current()->update_undo_state();
-  document->get_sector_model().rebuild_scene_graph();
+  m_document->get_sector_model().rebuild_scene_graph();
 }
 
 bool
@@ -256,7 +255,7 @@
 WindstilleWidget::update(float delta)
 {
   std::cout << this << " WindstilleWidget::update(" << delta << ")" << std::endl;
-  document->get_sector_model().update(delta);
+  m_document->get_sector_model().update(delta);
   queue_draw();
 }
 
@@ -267,7 +266,7 @@
     {
       state.push(*sc);
       
-      sc->light().fill_screen(document->get_sector_model().get_ambient_color());
+      sc->light().fill_screen(m_document->get_sector_model().get_ambient_color());
 
       if (draw_background_pattern)
         {
@@ -280,15 +279,15 @@
         }
 
       if (draw_only_active_layers)
-        document->get_sector_model().draw(*sc, SelectMask());
+        m_document->get_sector_model().draw(*sc, SelectMask());
       else
-        document->get_sector_model().draw(*sc, select_mask);
+        m_document->get_sector_model().draw(*sc, select_mask);
 
-      if (!selection->empty())
+      if (!m_document->get_selection()->empty())
         {
-          for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
+          for(Selection::iterator i = m_document->get_selection()->begin(); i != m_document->get_selection()->end(); ++i)
             {
-              (*i)->draw_select(*sc, i == selection->begin());
+              (*i)->draw_select(*sc, i == m_document->get_selection()->begin());
             }
 
           //sc->control().draw_rect(selection->get_bounding_box(), Color(1.0f, 1.0f, 1.0f, 1.0f));
@@ -305,7 +304,7 @@
           EditorWindow::current()->get_current_tool()->draw(*sc);
         }
 
-      compositor->render(*sc, document->get_sector_model().get_scene_graph(), state);
+      compositor->render(*sc, m_document->get_sector_model().get_scene_graph(), state);
 
       state.pop(*sc);
 
@@ -317,274 +316,6 @@
     }
 }
 
-void
-WindstilleWidget::undo()
-{
-  document->get_undo_manager().undo();
-}
-
-void
-WindstilleWidget::redo()
-{
-  document->get_undo_manager().redo();
-}
-
-void
-WindstilleWidget::selection_raise()
-{
-  for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
-    {
-      document->get_sector_model().raise(*i);
-    }
-  queue_draw();
-}
-
-void
-WindstilleWidget::selection_lower()
-{
-  for(Selection::reverse_iterator i = selection->rbegin(); i != selection->rend(); ++i)
-    {
-      document->get_sector_model().lower(*i);
-    }
-  queue_draw();
-}
-
-void
-WindstilleWidget::selection_raise_to_top()
-{
-  for(Selection::reverse_iterator i = selection->rbegin(); i != selection->rend(); ++i)
-    {
-      document->get_sector_model().raise_to_top(*i);
-    }
-  queue_draw();
-}
-
-void
-WindstilleWidget::selection_lower_to_bottom()
-{
-  for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
-    {
-      document->get_sector_model().lower_to_bottom(*i);
-    }
-  queue_draw();
-}
-
-void
-WindstilleWidget::selection_vflip()
-{
-  if (!selection->empty())
-    {
-      boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
-
-      if (selection->size() > 1)
-        {
-          const Vector2f& center = selection->get_bounding_box().get_center();
-          for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
-            {
-              Vector2f pos = (*i)->get_world_pos();
-          
-              pos.y = center.y + (center.y - pos.y);
-          
-              //(*i)->set_world_pos(pos);
-              group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_world_pos, *i, (*i)->get_world_pos()),
-                                                                  boost::bind(&ObjectModel::set_world_pos, *i, pos))));
-            }
-        }
-
-      for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
-        {
-          //(*i)->set_vflip(!(*i)->get_vflip());
-          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_vflip, *i,  (*i)->get_vflip()),
-                                                              boost::bind(&ObjectModel::set_vflip, *i, !(*i)->get_vflip()))));
-        }
-
-      execute(group_command);
-    }
-}
-
-void
-WindstilleWidget::selection_hflip()
-{
-  if (!selection->empty())
-    {
-      boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
-
-      if (selection->size() > 1)
-        {
-          const Vector2f& center = selection->get_bounding_box().get_center();
-          for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
-            {
-              Vector2f pos = (*i)->get_world_pos();
-          
-              pos.x = center.x + (center.x - pos.x);
-          
-              //(*i)->set_world_pos(pos);
-              group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_world_pos, *i, (*i)->get_world_pos()),
-                                                                  boost::bind(&ObjectModel::set_world_pos, *i, pos))));
-            }
-        }
-
-      for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
-        {
-          //(*i)->set_hflip(!(*i)->get_hflip());
-          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_hflip, *i,  (*i)->get_hflip()),
-                                                              boost::bind(&ObjectModel::set_hflip, *i, !(*i)->get_hflip()))));
-        }
-
-      execute(group_command);
-    }
-}
-
-void
-WindstilleWidget::selection_connect_parent()
-{
-  if (selection->size() >= 2)
-    {
-      boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
-
-      ObjectModelHandle parent = *selection->begin();
-
-      Selection::iterator i = selection->begin();
-      ++i;
-      for(; i != selection->end(); ++i)
-        {
-          //(*i)->set_parent(parent);
-          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_parent, *i, (*i)->get_parent(), true),
-                                                              boost::bind(&ObjectModel::set_parent, *i, parent, true))));
-        }
-
-      execute(group_command);
-    }
-}
-
-void
-WindstilleWidget::selection_clear_parent()
-{
-  boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
-
-  for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
-    {
-      //(*i)->set_parent(ObjectModelHandle());
-      group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_parent, *i, (*i)->get_parent(), true),
-                                                          boost::bind(&ObjectModel::set_parent, *i, ObjectModelHandle(), true))));
-    }
-
-  execute(group_command);
-}
-
-void
-WindstilleWidget::selection_duplicate()
-{
-  boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
-  std::map<ObjectModelHandle, ObjectModelHandle> parent_map;
-
-  SelectionHandle new_selection = Selection::create();
-  for(Selection::reverse_iterator i = selection->rbegin(); i != selection->rend(); ++i)
-    {
-      LayerHandle layer = document->get_sector_model().get_layer(*i);
-      ObjectModelHandle obj = (*i)->clone();
-
-      parent_map[*i] = obj;
-
-      if (!layer)
-        {
-          EditorWindow::current()->print("Couldn't find parent layer while duplicating");
-        }
-      else
-        {
-          // Move clone a litte to make it more obvious that something happened
-          obj->set_rel_pos(obj->get_rel_pos() + Vector2f(32.0f, 32.0f));
-          new_selection->add(obj);
-
-          //layer->add(obj);
-          group_command->add(CommandHandle(new ObjectAddCommand(layer, obj)));
-        }
-    }
-
-  // Second pass to set the parents to the cloned objects
-  for(Selection::iterator i = new_selection->begin(); i != new_selection->end(); ++i)
-    {
-      if ((*i)->get_parent())
-        {
-          std::map<ObjectModelHandle, ObjectModelHandle>::iterator it = parent_map.find((*i)->get_parent());
-          
-          if (it == parent_map.end())
-            {
-              // When the parent wasn't part of the selection, leave
-              // the parent untouched
-            }
-          else
-            {
-              (*i)->set_parent(it->second);
-            }
-        }
-    }
-
-  execute(group_command);
-  set_selection(new_selection);
-}
-
-void
-WindstilleWidget::selection_reset_rotation()
-{
-  boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
-
-  for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
-    {
-      DecalObjectModel* decal = dynamic_cast<DecalObjectModel*>(i->get());
-
-      if (decal)
-        {
-          //decal->set_angle(0.0f);
-          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&DecalObjectModel::set_angle, decal, decal->get_angle()),
-                                                              boost::bind(&DecalObjectModel::set_angle, decal, 0.0f))));
-        }
-    }
-
-  on_selection_change();
-  execute(group_command);
-}
-
-void
-WindstilleWidget::selection_object_properties()
-{
-  std::cout << "Display Dialog" << std::endl;
-}
-
-void
-WindstilleWidget::selection_reset_scale()
-{
-  boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
-
- for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
-    {
-      DecalObjectModel* decal = dynamic_cast<DecalObjectModel*>(i->get());
-      if (decal)
-        {
-          //decal->set_scale(Vector2f(1.0f, 1.0f));
-          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&DecalObjectModel::set_scale, decal, decal->get_scale()),
-                                                              boost::bind(&DecalObjectModel::set_scale, decal, Vector2f(1.0f, 1.0f)))));
-        }
-    }
-
- on_selection_change();
- execute(group_command);
-}
-
-void
-WindstilleWidget::selection_delete()
-{
-  boost::shared_ptr<GroupCommand> group_cmd(new GroupCommand());
-  for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
-    {
-      group_cmd->add(CommandHandle(new ObjectRemoveCommand(document->get_sector_model(), *i)));
-    }
-
-  execute(group_cmd);
-  selection->clear();
-  queue_draw();
-}
-
 bool
 WindstilleWidget::scroll(GdkEventScroll* ev)
 {
@@ -598,7 +329,7 @@
     }
   return false;
 }
-
+
 bool
 WindstilleWidget::mouse_down(GdkEventButton* ev)
 {
@@ -684,7 +415,7 @@
         break;
 
       case GDK_d:
-        selection_duplicate();
+        m_document->selection_duplicate();
         break;
 
       case GDK_s:
@@ -692,7 +423,7 @@
         break;
 
       case GDK_Delete:
-        selection_delete();
+        m_document->selection_delete();
         break;
 
       case GDK_Left:
@@ -763,7 +494,7 @@
     }
   else
     {
-      execute(CommandHandle(new ObjectAddCommand(document->get_sector_model().get_layer(path_), object)));
+      execute(CommandHandle(new ObjectAddCommand(m_document->get_sector_model().get_layer(path_), object)));
     }
 }
 
@@ -796,20 +527,6 @@
   queue_draw();
 }
 
-void
-WindstilleWidget::set_selection(const SelectionHandle& selection_)
-{
-  selection = selection_;
-  selection->signal_changed.connect(sigc::mem_fun(*this, &WindstilleWidget::on_selection_change));
-  on_selection_change();
-}
-
-SelectionHandle
-WindstilleWidget::get_selection() const
-{
-  return selection;
-}
-
 LayerHandle
 WindstilleWidget::get_current_layer()
 {
@@ -824,7 +541,7 @@
     }
   else
     {
-      return document->get_sector_model().get_layer(path_);  
+      return m_document->get_sector_model().get_layer(path_);  
     }
 }
 
@@ -847,44 +564,13 @@
 }
 
 void
-WindstilleWidget::on_selection_change()
+WindstilleWidget::on_document_change()
 {
-  control_points.clear();
-
-  if (!selection->is_moving())
-    {
-      selection->add_control_points(control_points);
-    }
-  
+  m_document->get_sector_model().rebuild_scene_graph();
   queue_draw();
 }
 
-ControlPointHandle
-WindstilleWidget::get_control_point(const Vector2f& pos) const
-{
-  for(std::vector<ControlPointHandle>::const_iterator i = control_points.begin();  
-      i != control_points.end(); ++i)
-    {
-      if ((*i)->get_bounding_box().is_inside(pos))
-        return *i;
-    }
-  return ControlPointHandle();
-}
-
 void
-WindstilleWidget::clear_control_points()
-{
-  control_points.clear();
-}
-
-void
-WindstilleWidget::create_control_points()
-{
-  control_points.clear();
-  selection->add_control_points(control_points);
-}
-
-void
 WindstilleWidget::save_screenshot(const std::string& filename_)
 {
   Glib::RefPtr<Gdk::GL::Window> glwindow = get_gl_window();
@@ -900,7 +586,7 @@
 WindstilleWidget::load_file(const std::string& filename_)
 {
   filename = filename_;
-  document->get_sector_model().load(filename);
+  m_document->get_sector_model().load(filename);
   queue_draw();
 }
 

Modified: trunk/windstille/src/editor/windstille_widget.hpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.hpp	2009-09-08 23:22:14 UTC (rev 3206)
+++ trunk/windstille/src/editor/windstille_widget.hpp	2009-09-09 00:37:20 UTC (rev 3207)
@@ -59,7 +59,7 @@
 private:
   EditorWindow& editor;
 
-  boost::scoped_ptr<Document> document;
+  boost::scoped_ptr<Document> m_document;
 
   std::string filename;
   std::vector<ControlPointHandle> control_points;
@@ -68,7 +68,6 @@
   boost::scoped_ptr<Compositor> compositor;
   boost::scoped_ptr<SceneContext> sc;
   boost::scoped_ptr<ScrollTool> scroll_tool;
-  SelectionHandle selection;
   DecalObjectModel::MapType map_type;
   Texture background_pattern;
   SelectMask select_mask;
@@ -112,34 +111,10 @@
   void draw();
   void update(float delta);
 
-  void undo();
-  void redo();
+  Document&    get_document() const { return *m_document; }
+  SectorModel* get_sector_model() const { return &(m_document->get_sector_model()); }
+  UndoManager* get_undo_manager() const { return &(m_document->get_undo_manager()); }
 
-  void selection_raise();
-  void selection_lower();
-
-  void selection_raise_to_top();
-  void selection_lower_to_bottom();
-
-  void selection_vflip();
-  void selection_hflip();
-
-  void selection_connect_parent();
-  void selection_clear_parent();
-  
-  void selection_duplicate();
-  void selection_delete();
-
-  void selection_reset_rotation();
-  void selection_reset_scale();
-
-  void selection_object_properties();
-
-  SectorModel* get_sector_model() const { return &(document->get_sector_model()); }
-  UndoManager* get_undo_manager() const { return &(document->get_undo_manager()); }
-  void set_selection(const SelectionHandle& selection);
-  SelectionHandle get_selection() const;
-
   SelectMask& get_select_mask() { return select_mask; }
 
   SceneContext* get_sc() const { return sc.get(); }
@@ -160,12 +135,8 @@
   std::string get_filename() const { return filename; }
   void set_filename(const std::string& filename_) { filename = filename_; }
 
-  ControlPointHandle get_control_point(const Vector2f& pos) const;
-
-  void clear_control_points();
-  void create_control_points();
-
   void on_selection_change();
+  void on_document_change();
 
   void save_screenshot(const std::string& filename);
 



From grumbel at mail.berlios.de  Wed Sep  9 02:57:41 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 9 Sep 2009 02:57:41 +0200
Subject: [Windstille-commit] r3208 - trunk/windstille/src/editor
Message-ID: <200909090057.n890vfLC022908@sheep.berlios.de>

Author: grumbel
Date: 2009-09-09 02:57:39 +0200 (Wed, 09 Sep 2009)
New Revision: 3208

Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/document.hpp
   trunk/windstille/src/editor/windstille_widget.hpp
Log:
Added some convenience wrapper for Commands

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-09 00:37:20 UTC (rev 3207)
+++ trunk/windstille/src/editor/document.cpp	2009-09-09 00:57:39 UTC (rev 3208)
@@ -68,6 +68,36 @@
 }
 
 void
+Document::layer_add(const Gtk::TreeModel::Path& path)
+{
+  execute(CommandHandle(new LayerAddCommand(*m_sector_model, path)));
+}
+
+void
+Document::layer_remove(const Gtk::TreeModel::Path& path)
+{
+  execute(CommandHandle(new LayerDeleteCommand(*m_sector_model, path)));
+}
+
+void
+Document::object_add(LayerHandle layer, ObjectModelHandle object)
+{
+  execute(CommandHandle(new ObjectAddCommand(layer, object)));
+}
+
+void
+Document::object_remove(ObjectModelHandle object)
+{
+  execute(CommandHandle(new ObjectRemoveCommand(*m_sector_model, object)));
+}
+
+void
+Document::object_set_pos(ObjectModelHandle object, const Vector2f& new_pos)
+{
+  execute(CommandHandle(new ObjectSetPosCommand(object, new_pos)));
+}
+
+void
 Document::selection_raise()
 {
   for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)

Modified: trunk/windstille/src/editor/document.hpp
===================================================================
--- trunk/windstille/src/editor/document.hpp	2009-09-09 00:37:20 UTC (rev 3207)
+++ trunk/windstille/src/editor/document.hpp	2009-09-09 00:57:39 UTC (rev 3208)
@@ -23,14 +23,15 @@
 
 #include "editor/selection.hpp"
 #include "editor/command.hpp"
+#include "editor/layer.hpp"
 
 class UndoManager;
 class SectorModel;
 
 /**
- *  Document wraps SectorModel with undo/redo functionality and
+ *  Document wraps undo/redo functionality around SectorModel and
  *  provides data and functions for editing that are not part of the
- *  central data, such as selections.
+ *  central data, such as Selections and ControlPoints.
  */
 class Document // FIXME: name is not so great
 {
@@ -52,10 +53,28 @@
   SectorModel& get_sector_model() const { return *m_sector_model; }
   SelectionHandle get_selection() const { return m_selection; }
 
+  /* Undo/Redo Handling
+   * @{*/  
   void undo();
   void redo();
   void execute(CommandHandle cmd);
-  
+  /** @} */
+
+  /* Layer Commands
+   * @{*/
+  void layer_add(const Gtk::TreeModel::Path& path);
+  void layer_remove(const Gtk::TreeModel::Path& path);
+  /** @} */
+
+  /* Object Commands
+   * @{*/
+  void object_add(LayerHandle layer, ObjectModelHandle object);
+  void object_remove(ObjectModelHandle object);
+  void object_set_pos(ObjectModelHandle object, const Vector2f& new_pos);
+  /** @} */
+
+  /* Selection Commands
+   * @{*/
   void selection_raise();
   void selection_lower();
 
@@ -77,17 +96,21 @@
   void selection_object_properties();
 
   void set_selection(const SelectionHandle& selection);
+  /** @} */
 
-  void on_selection_change();
-
+  /* Control Point Stuff
+   * @{*/  
   ControlPointHandle get_control_point(const Vector2f& pos) const;
-
   void clear_control_points();
   void create_control_points();
+  /** @} */
 
   sigc::signal<void>& signal_on_change() { return m_sig_on_change; }
 
 private:
+  void on_selection_change();
+
+private:
   Document(const Document&);
   Document& operator=(const Document&);
 };

Modified: trunk/windstille/src/editor/windstille_widget.hpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.hpp	2009-09-09 00:37:20 UTC (rev 3207)
+++ trunk/windstille/src/editor/windstille_widget.hpp	2009-09-09 00:57:39 UTC (rev 3208)
@@ -135,11 +135,12 @@
   std::string get_filename() const { return filename; }
   void set_filename(const std::string& filename_) { filename = filename_; }
 
+  void save_screenshot(const std::string& filename);
+
+private:
   void on_selection_change();
   void on_document_change();
 
-  void save_screenshot(const std::string& filename);
-
 private:
   WindstilleWidget (const WindstilleWidget&);
   WindstilleWidget& operator= (const WindstilleWidget&);



From grumbel at mail.berlios.de  Wed Sep  9 03:02:38 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 9 Sep 2009 03:02:38 +0200
Subject: [Windstille-commit] r3209 - trunk/windstille/src/editor
Message-ID: <200909090102.n8912cB1023703@sheep.berlios.de>

Author: grumbel
Date: 2009-09-09 03:02:37 +0200 (Wed, 09 Sep 2009)
New Revision: 3209

Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/document.hpp
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/windstille_widget.cpp
   trunk/windstille/src/editor/windstille_widget.hpp
Log:
Removed get_undo_manager()

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-09 00:57:39 UTC (rev 3208)
+++ trunk/windstille/src/editor/document.cpp	2009-09-09 01:02:37 UTC (rev 3209)
@@ -57,6 +57,18 @@
   m_undo_manager->redo();
 }
 
+bool
+Document::has_undo() const
+{
+  return m_undo_manager->can_undo();
+}
+
+bool
+Document::has_redo() const
+{
+  return m_undo_manager->can_redo();
+}
+
 void
 Document::execute(CommandHandle cmd)
 {

Modified: trunk/windstille/src/editor/document.hpp
===================================================================
--- trunk/windstille/src/editor/document.hpp	2009-09-09 00:57:39 UTC (rev 3208)
+++ trunk/windstille/src/editor/document.hpp	2009-09-09 01:02:37 UTC (rev 3209)
@@ -49,7 +49,6 @@
   Document();
   ~Document();
 
-  UndoManager& get_undo_manager() const { return *m_undo_manager; }
   SectorModel& get_sector_model() const { return *m_sector_model; }
   SelectionHandle get_selection() const { return m_selection; }
 
@@ -57,6 +56,8 @@
    * @{*/  
   void undo();
   void redo();
+  bool has_undo() const;
+  bool has_redo() const;
   void execute(CommandHandle cmd);
   /** @} */
 

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-09 00:57:39 UTC (rev 3208)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-09 01:02:37 UTC (rev 3209)
@@ -686,8 +686,8 @@
 {
   if (WindstilleWidget* wst = get_windstille_widget())
     {
-      action_group->get_action("Undo")->set_sensitive(wst->get_undo_manager()->can_undo());
-      action_group->get_action("Redo")->set_sensitive(wst->get_undo_manager()->can_redo());
+      action_group->get_action("Undo")->set_sensitive(wst->get_document().has_undo());
+      action_group->get_action("Redo")->set_sensitive(wst->get_document().has_redo());
     }
 }
 

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-09 00:57:39 UTC (rev 3208)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-09 01:02:37 UTC (rev 3209)
@@ -128,7 +128,7 @@
 void
 WindstilleWidget::execute(CommandHandle cmd)
 {
-  m_document->get_undo_manager().execute(cmd);
+  m_document->execute(cmd);
   EditorWindow::current()->update_undo_state();
   m_document->get_sector_model().rebuild_scene_graph();
 }

Modified: trunk/windstille/src/editor/windstille_widget.hpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.hpp	2009-09-09 00:57:39 UTC (rev 3208)
+++ trunk/windstille/src/editor/windstille_widget.hpp	2009-09-09 01:02:37 UTC (rev 3209)
@@ -113,8 +113,7 @@
 
   Document&    get_document() const { return *m_document; }
   SectorModel* get_sector_model() const { return &(m_document->get_sector_model()); }
-  UndoManager* get_undo_manager() const { return &(m_document->get_undo_manager()); }
-
+  
   SelectMask& get_select_mask() { return select_mask; }
 
   SceneContext* get_sc() const { return sc.get(); }



From grumbel at mail.berlios.de  Wed Sep  9 06:44:42 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 9 Sep 2009 06:44:42 +0200
Subject: [Windstille-commit] r3210 - trunk/windstille/src/editor
Message-ID: <200909090444.n894ignb013652@sheep.berlios.de>

Author: grumbel
Date: 2009-09-09 06:44:38 +0200 (Wed, 09 Sep 2009)
New Revision: 3210

Modified:
   trunk/windstille/src/editor/decal_object_model.cpp
   trunk/windstille/src/editor/decal_object_model.hpp
Log:
Fixed cloning

Modified: trunk/windstille/src/editor/decal_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.cpp	2009-09-09 01:02:37 UTC (rev 3209)
+++ trunk/windstille/src/editor/decal_object_model.cpp	2009-09-09 04:44:38 UTC (rev 3210)
@@ -79,6 +79,20 @@
 {
 }
 
+DecalObjectModel::DecalObjectModel(const DecalObjectModel& rhs)
+  : ObjectModel(rhs),
+    path(rhs.path),
+    surface(rhs.surface),
+    software_surface(rhs.software_surface),
+    type(rhs.type),
+    scale(rhs.scale),
+    angle(rhs.angle),
+    hflip(rhs.hflip),
+    vflip(rhs.vflip),
+    m_drawable()
+{
+}
+
 DecalObjectModel::~DecalObjectModel()
 {
 }

Modified: trunk/windstille/src/editor/decal_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.hpp	2009-09-09 01:02:37 UTC (rev 3209)
+++ trunk/windstille/src/editor/decal_object_model.hpp	2009-09-09 04:44:38 UTC (rev 3210)
@@ -54,6 +54,7 @@
   DecalObjectModel(const FileReader& reader);
   DecalObjectModel(const std::string& name, const Vector2f& rel_pos, 
                    const std::string& path_, MapType type_);
+  DecalObjectModel(const DecalObjectModel& rhs);
   ~DecalObjectModel();
 
   void set_scale(const Vector2f& scale);



From grumbel at mail.berlios.de  Wed Sep  9 06:46:03 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 9 Sep 2009 06:46:03 +0200
Subject: [Windstille-commit] r3211 - trunk/windstille/src/editor
Message-ID: <200909090446.n894k3ao016621@sheep.berlios.de>

Author: grumbel
Date: 2009-09-09 06:45:59 +0200 (Wed, 09 Sep 2009)
New Revision: 3211

Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/document.hpp
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/navgraph_edge_object_model.cpp
   trunk/windstille/src/editor/navgraph_insert_tool.cpp
   trunk/windstille/src/editor/navgraph_node_object_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
   trunk/windstille/src/editor/select_tool.cpp
   trunk/windstille/src/editor/selection.cpp
   trunk/windstille/src/editor/windstille_widget.cpp
   trunk/windstille/src/editor/windstille_widget.hpp
Log:
Replaced some pointers with references and changed stuff from raw Command objects to simple Document member function calls

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-09 04:44:38 UTC (rev 3210)
+++ trunk/windstille/src/editor/document.cpp	2009-09-09 04:45:59 UTC (rev 3211)
@@ -41,6 +41,16 @@
 {
 }
 
+Document::Document(const std::string& filename)
+  : m_undo_manager(new UndoManager()),
+    m_sector_model(new SectorModel()),
+    m_selection(Selection::create()),
+    m_control_points(),
+    m_sig_on_change()
+{
+  m_sector_model->load(filename);
+}
+
 Document::~Document()
 {
 }
@@ -57,6 +67,16 @@
   m_undo_manager->redo();
 }
 
+void
+Document::undo_group_begin()
+{
+}
+
+void
+Document::undo_group_end()
+{
+}
+
 bool
 Document::has_undo() const
 {
@@ -80,6 +100,13 @@
 }
 
 void
+Document::execute(const boost::function<void ()>& undo_callback,
+                  const boost::function<void ()>& redo_callback)
+{
+  execute(CommandHandle(new FunctorCommand(undo_callback, redo_callback)));
+}
+
+void
 Document::layer_add(const Gtk::TreeModel::Path& path)
 {
   execute(CommandHandle(new LayerAddCommand(*m_sector_model, path)));
@@ -411,5 +438,4 @@
   m_selection->add_control_points(m_control_points);
 }
 
-
 /* EOF */

Modified: trunk/windstille/src/editor/document.hpp
===================================================================
--- trunk/windstille/src/editor/document.hpp	2009-09-09 04:44:38 UTC (rev 3210)
+++ trunk/windstille/src/editor/document.hpp	2009-09-09 04:45:59 UTC (rev 3211)
@@ -20,6 +20,7 @@
 #define HEADER_WINDSTILLE_EDITOR_DOCUMENT_HPP
 
 #include <boost/scoped_ptr.hpp>
+#include <boost/function.hpp>
 
 #include "editor/selection.hpp"
 #include "editor/command.hpp"
@@ -47,17 +48,24 @@
 
 public:
   Document();
+  Document(const std::string& filename);
   ~Document();
 
   SectorModel& get_sector_model() const { return *m_sector_model; }
-  SelectionHandle get_selection() const { return m_selection; }
 
   /* Undo/Redo Handling
    * @{*/  
   void undo();
   void redo();
+
+  void undo_group_begin();
+  void undo_group_end();
+
   bool has_undo() const;
   bool has_redo() const;
+
+  void execute(const boost::function<void ()>& undo_callback,
+               const boost::function<void ()>& redo_callback);
   void execute(CommandHandle cmd);
   /** @} */
 
@@ -97,6 +105,7 @@
   void selection_object_properties();
 
   void set_selection(const SelectionHandle& selection);
+  SelectionHandle get_selection() const { return m_selection; }
   /** @} */
 
   /* Control Point Stuff

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-09 04:44:38 UTC (rev 3210)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-09 04:45:59 UTC (rev 3211)
@@ -33,8 +33,6 @@
 #include <gtkmm/stock.h>
 #include <gtkmm/separatortoolitem.h>
 
-#include "editor/layer_commands.hpp"
-#include "editor/undo_manager.hpp"
 #include "display/scene_context.hpp"
 #include "editor/windstille_widget.hpp"
 #include "editor/about_window.hpp"
@@ -446,8 +444,6 @@
 void
 EditorWindow::on_new()
 {
-  //std::cout << "on_new" << std::endl;
-
   // FIXME: We abuse the minimap as our root GLContext
   WindstilleWidget* wst = Gtk::manage(new WindstilleWidget(*this, glconfig, minimap_widget.get_gl_context()));
 
@@ -456,7 +452,7 @@
   wst->show();
   notebook.set_current_page(new_page);
 
-  layer_manager.set_model(wst->get_sector_model());
+  layer_manager.set_model(&wst->get_document().get_sector_model());
   layer_widget->update(wst->get_select_mask());
 }
 
@@ -527,7 +523,7 @@
         {
           std::ofstream out(wst->get_filename().c_str());
           FileWriter writer(out);
-          wst->get_sector_model()->write(writer);
+          wst->get_document().get_sector_model().write(writer);
           print("Wrote: " + wst->get_filename());
         }
     }
@@ -570,7 +566,7 @@
               std::ofstream out(filename.c_str());
               FileWriter writer(out);
 
-              wst->get_sector_model()->write(writer);
+              wst->get_document().get_sector_model().write(writer);
               wst->set_filename(filename);
 
               notebook.set_tab_label_text(*notebook.get_nth_page(page), Glib::path_get_basename(filename));
@@ -803,7 +799,7 @@
 
   if (WindstilleWidget* wst = get_windstille_widget())
     {
-      layer_manager.set_model(wst->get_sector_model());
+      layer_manager.set_model(&wst->get_document().get_sector_model());
       layer_widget->update(wst->get_select_mask());
 
       toggle_color_layer->set_active(wst->get_sc()->get_render_mask() & SceneContext::COLORMAP);
@@ -897,11 +893,7 @@
 {
   if (WindstilleWidget* wst = get_windstille_widget())
     {
-      //std::cout << "Deleting layer: " << wst << std::endl;
-      //wst->get_sector_model()->delete_layer(wst->get_current_layer_path());
-
-      CommandHandle cmd(new LayerDeleteCommand(*wst->get_sector_model(), wst->get_current_layer_path()));
-      wst->execute(cmd);
+      wst->get_document().layer_remove(wst->get_current_layer_path());
       queue_draw();
     }
 }
@@ -911,7 +903,7 @@
 {
   if (WindstilleWidget* wst = get_windstille_widget())
     {
-      wst->get_sector_model()->reverse_layers();
+      wst->get_document().get_sector_model().reverse_layers();
     }
 }
 
@@ -920,12 +912,7 @@
 {
   if (WindstilleWidget* wst = get_windstille_widget())
     {
-      //std::cout << "Adding layer" << std::endl;
-      //wst->get_sector_model()->add_layer("New Layer", wst->get_current_layer_path());
-
-      CommandHandle cmd(new LayerAddCommand(*wst->get_sector_model(), wst->get_current_layer_path()));
-      wst->execute(cmd);
-
+      wst->get_document().layer_add(wst->get_current_layer_path());
       layer_manager.get_treeview().expand_all();
     }
 }
@@ -968,7 +955,7 @@
 {
   if (WindstilleWidget* wst = get_windstille_widget())
     {
-      wst->get_sector_model()->set_all_visible(v);
+      wst->get_document().get_sector_model().set_all_visible(v);
       wst->queue_draw();
     }
 }
@@ -978,7 +965,7 @@
 {
   if (WindstilleWidget* wst = get_windstille_widget())
     {
-      wst->get_sector_model()->set_all_locked(v);
+      wst->get_document().get_sector_model().set_all_locked(v);
       wst->queue_draw();
     }
 }

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-09 04:44:38 UTC (rev 3210)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-09 04:45:59 UTC (rev 3211)
@@ -33,8 +33,8 @@
     m_edge()
 {
   std::cout << "Adding edge" << std::endl;
-  m_edge = sector.get_nav_graph()->add_edge(m_lhs->get_node(),
-                                            m_rhs->get_node());
+  m_edge = sector.get_nav_graph().add_edge(m_lhs->get_node(),
+                                           m_rhs->get_node());
 }
 
 void

Modified: trunk/windstille/src/editor/navgraph_insert_tool.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-09 04:44:38 UTC (rev 3210)
+++ trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-09 04:45:59 UTC (rev 3211)
@@ -26,7 +26,6 @@
 #include "editor/editor_window.hpp"
 #include "editor/navgraph_node_object_model.hpp"
 #include "editor/navgraph_edge_object_model.hpp"
-#include "editor/object_commands.hpp"
 
 NavgraphInsertTool::NavgraphInsertTool()
   : mouse_pos(),
@@ -42,8 +41,8 @@
 NavgraphInsertTool::mouse_down(GdkEventButton* event, WindstilleWidget& wst)
 {
   mouse_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
-  NavigationGraph& navgraph = *wst.get_sector_model()->get_nav_graph();
-  SectorModel* sector = wst.get_sector_model();
+  NavigationGraph& navgraph = wst.get_document().get_sector_model().get_nav_graph();
+  SectorModel& sector = wst.get_document().get_sector_model();
 
   NodeHandle node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
   EdgeHandle edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
@@ -54,10 +53,10 @@
     {
       if (node)
       { // connect last node with existing node
-        NavGraphEdgeObjectModel* edge_obj = new NavGraphEdgeObjectModel(sector->find_navgraph_node(last_node),
-                                                                        sector->find_navgraph_node(node),
-                                                                        *sector);
-        wst.execute(CommandHandle(new ObjectAddCommand(wst.get_current_layer(), ObjectModelHandle(edge_obj))));
+        NavGraphEdgeObjectModel* edge_obj = new NavGraphEdgeObjectModel(sector.find_navgraph_node(last_node),
+                                                                        sector.find_navgraph_node(node),
+                                                                        sector);
+        wst.get_document().object_add(wst.get_current_layer(), ObjectModelHandle(edge_obj));
 
         last_node = NodeHandle();
         connection_node = NodeHandle();
@@ -65,14 +64,17 @@
       else
       { // connect last node with newly created node
         // FIXME: Make this a GroupCommand
-        NavGraphNodeObjectModel* obj = new NavGraphNodeObjectModel(mouse_pos, *sector);
+        NavGraphNodeObjectModel* obj = new NavGraphNodeObjectModel(mouse_pos, sector);
         node = obj->get_node();
-        wst.execute(CommandHandle(new ObjectAddCommand(wst.get_current_layer(), ObjectModelHandle(obj))));
+        
+        NavGraphEdgeObjectModel* edge_obj = new NavGraphEdgeObjectModel(sector.find_navgraph_node(last_node),
+                                                                        sector.find_navgraph_node(node), 
+                                                                        sector);
 
-        NavGraphEdgeObjectModel* edge_obj = new NavGraphEdgeObjectModel(sector->find_navgraph_node(last_node),
-                                                                        sector->find_navgraph_node(node), 
-                                                                        *sector);
-        wst.execute(CommandHandle(new ObjectAddCommand(wst.get_current_layer(), ObjectModelHandle(edge_obj))));
+        wst.get_document().undo_group_begin();
+        wst.get_document().object_add(wst.get_current_layer(), ObjectModelHandle(obj));
+        wst.get_document().object_add(wst.get_current_layer(), ObjectModelHandle(edge_obj));
+        wst.get_document().undo_group_end();
 
         last_node = NodeHandle();
       }
@@ -94,9 +96,9 @@
       }
       else
       {
-        NavGraphNodeObjectModel* obj = new NavGraphNodeObjectModel(mouse_pos, *sector);
+        NavGraphNodeObjectModel* obj = new NavGraphNodeObjectModel(mouse_pos, sector);
         last_node = obj->get_node();
-        wst.execute(CommandHandle(new ObjectAddCommand(wst.get_current_layer(), ObjectModelHandle(obj))));
+        wst.get_document().object_add(wst.get_current_layer(), ObjectModelHandle(obj));
               
         mode = EDGE_MODE;
       }
@@ -110,7 +112,7 @@
 void
 NavgraphInsertTool::mouse_move(GdkEventMotion* event, WindstilleWidget& wst)
 {
-  NavigationGraph& navgraph = *wst.get_sector_model()->get_nav_graph();
+  NavigationGraph& navgraph = wst.get_document().get_sector_model().get_nav_graph();
   mouse_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
 
   {
@@ -143,7 +145,7 @@
 NavgraphInsertTool::mouse_up(GdkEventButton* event, WindstilleWidget& wst)
 {
   mouse_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
-  //NavigationGraph& navgraph = *wst.get_sector_model()->get_nav_graph();
+  //NavigationGraph& navgraph = *wst.get_sector_model().get_nav_graph();
 
   switch(mode)
     {
@@ -160,7 +162,7 @@
 void
 NavgraphInsertTool::mouse_right_down(GdkEventButton* /*event*/, WindstilleWidget& wst)
 {
-  NavigationGraph& navgraph = *wst.get_sector_model()->get_nav_graph();
+  NavigationGraph& navgraph = wst.get_document().get_sector_model().get_nav_graph();
 
   NodeHandle node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
   EdgeHandle edge = navgraph.find_closest_edge(mouse_pos, 16.0f);

Modified: trunk/windstille/src/editor/navgraph_node_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-09 04:44:38 UTC (rev 3210)
+++ trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-09 04:45:59 UTC (rev 3211)
@@ -28,7 +28,7 @@
     m_drawable(),
     m_node()
 {
-  m_node = sector.get_nav_graph()->add_node(pos);
+  m_node = sector.get_nav_graph().add_node(pos);
 }
 
 void

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-09 04:44:38 UTC (rev 3210)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-09 04:45:59 UTC (rev 3211)
@@ -79,7 +79,7 @@
 private:
   boost::scoped_ptr<NavigationGraph> nav_graph;
   boost::scoped_ptr<SceneGraph>      scene_graph;
-  Glib::RefPtr<Gtk::ListStore> layer_tree;
+  Glib::RefPtr<Gtk::ListStore>       layer_tree;
   Color ambient_color;
   
 public:
@@ -135,8 +135,8 @@
                   std::map<ObjectModelHandle, std::string>& parent_table);
   void write(FileWriter& writer) const;
 
-  NavigationGraph* get_nav_graph() const { return nav_graph.get(); }
-  SceneGraph*      get_scene_graph() const { return scene_graph.get(); }
+  NavigationGraph& get_nav_graph()   const { return *nav_graph; }
+  SceneGraph&      get_scene_graph() const { return *scene_graph; }
 
   boost::shared_ptr<NavGraphNodeObjectModel> find_navgraph_node(NodeHandle node) const;
   boost::shared_ptr<NavGraphEdgeObjectModel> find_navgraph_edge(EdgeHandle edge) const;

Modified: trunk/windstille/src/editor/select_tool.cpp
===================================================================
--- trunk/windstille/src/editor/select_tool.cpp	2009-09-09 04:44:38 UTC (rev 3210)
+++ trunk/windstille/src/editor/select_tool.cpp	2009-09-09 04:45:59 UTC (rev 3211)
@@ -52,7 +52,7 @@
     }
   else
     {  
-      ObjectModelHandle object = wst.get_sector_model()->get_object_at(click_pos, wst.get_select_mask());
+      ObjectModelHandle object = wst.get_document().get_sector_model().get_object_at(click_pos, wst.get_select_mask());
       if (object.get())
         {
           if (wst.get_document().get_selection()->has_object(object))
@@ -118,7 +118,7 @@
 
   for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
     {
-      SnapData snap = wst.get_sector_model()->snap_object((*i)->get_bounding_box(), ignore_objects);
+      SnapData snap = wst.get_document().get_sector_model().snap_object((*i)->get_bounding_box(), ignore_objects);
       best_snap.merge(snap);
     }
               
@@ -204,12 +204,12 @@
       rect.normalize();
       if (event->state & GDK_SHIFT_MASK)
         {
-          SelectionHandle new_selection = wst.get_sector_model()->get_selection(rect, wst.get_select_mask());
+          SelectionHandle new_selection = wst.get_document().get_sector_model().get_selection(rect, wst.get_select_mask());
           wst.get_document().get_selection()->add(new_selection->begin(), new_selection->end());
         }
       else
         {
-          wst.get_document().set_selection(wst.get_sector_model()->get_selection(rect, wst.get_select_mask()));
+          wst.get_document().set_selection(wst.get_document().get_sector_model().get_selection(rect, wst.get_select_mask()));
         }
       wst.queue_draw();
     }

Modified: trunk/windstille/src/editor/selection.cpp
===================================================================
--- trunk/windstille/src/editor/selection.cpp	2009-09-09 04:44:38 UTC (rev 3210)
+++ trunk/windstille/src/editor/selection.cpp	2009-09-09 04:45:59 UTC (rev 3211)
@@ -19,9 +19,6 @@
 #include <iostream>
 #include <boost/bind.hpp>
 
-#include "editor/undo_manager.hpp"
-#include "editor/group_command.hpp"
-#include "editor/functor_command.hpp"
 #include "editor/windstille_widget.hpp"
 #include "editor/editor_window.hpp"
 #include "editor/selection.hpp"
@@ -140,22 +137,18 @@
 {
   moving = false;
 
-  boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
-
+  wst.get_document().undo_group_begin();
   for(Objects::iterator i = objects.begin(); i != objects.end(); ++i)
+  {
+    if (non_moveable_objects.find(*i) == non_moveable_objects.end())
     {
-      if (non_moveable_objects.find(*i) == non_moveable_objects.end())
-        {
-          //(*i)->on_move_end(offset);
-          //(*i)->set_rel_pos(object_orig_poss[i - objects.begin()]);
-
-          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_rel_pos, *i, object_orig_poss[i - objects.begin()]),
-                                                              boost::bind(&ObjectModel::set_rel_pos, *i, object_orig_poss[i - objects.begin()] + offset))));
-        }
+      wst.get_document().execute(boost::bind(&ObjectModel::set_rel_pos, *i, object_orig_poss[i - objects.begin()]),
+                                 boost::bind(&ObjectModel::set_rel_pos, *i, object_orig_poss[i - objects.begin()] + offset));
     }
+  }
+  wst.get_document().undo_group_end();
 
   non_moveable_objects.clear();
-  wst.execute(group_command);
   signal_changed();
 }
 

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-09 04:44:38 UTC (rev 3210)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-09 04:45:59 UTC (rev 3211)
@@ -33,9 +33,7 @@
 #include "editor/editor_window.hpp"
 #include "editor/scroll_tool.hpp"
 #include "editor/sector_model.hpp"
-#include "editor/undo_manager.hpp"
 #include "editor/group_command.hpp"
-#include "editor/object_commands.hpp"
 #include "editor/functor_command.hpp"
 #include "editor/document.hpp"
 #include "editor/sprite_object_model.hpp"
@@ -125,14 +123,6 @@
 {
 }
 
-void
-WindstilleWidget::execute(CommandHandle cmd)
-{
-  m_document->execute(cmd);
-  EditorWindow::current()->update_undo_state();
-  m_document->get_sector_model().rebuild_scene_graph();
-}
-
 bool
 WindstilleWidget::on_timeout()
 {
@@ -304,7 +294,7 @@
           EditorWindow::current()->get_current_tool()->draw(*sc);
         }
 
-      compositor->render(*sc, m_document->get_sector_model().get_scene_graph(), state);
+      compositor->render(*sc, &m_document->get_sector_model().get_scene_graph(), state);
 
       state.pop(*sc);
 
@@ -494,7 +484,7 @@
     }
   else
     {
-      execute(CommandHandle(new ObjectAddCommand(m_document->get_sector_model().get_layer(path_), object)));
+      get_document().object_add(m_document->get_sector_model().get_layer(path_), object);
     }
 }
 
@@ -553,19 +543,20 @@
   EditorWindow::current()->get_layer_manager().get_treeview().get_cursor(path_, focus_column);
 
   if (!path_.gobj())
-    {
-      std::cout << "WindstilleWidget::get_current_layer_path(): Error: Couldn't get path" << std::endl;
-      return Gtk::TreeModel::Path();
-    }
+  {
+    std::cout << "WindstilleWidget::get_current_layer_path(): Error: Couldn't get path" << std::endl;
+    return Gtk::TreeModel::Path();
+  }
   else
-    {
-      return path_;
-     }
+  {
+    return path_;
+  }
 }
 
 void
 WindstilleWidget::on_document_change()
 {
+  EditorWindow::current()->update_undo_state();
   m_document->get_sector_model().rebuild_scene_graph();
   queue_draw();
 }
@@ -586,8 +577,7 @@
 WindstilleWidget::load_file(const std::string& filename_)
 {
   filename = filename_;
-  m_document->get_sector_model().load(filename);
-  queue_draw();
+  m_document.reset(new Document(filename));
 }
 
 /* EOF */

Modified: trunk/windstille/src/editor/windstille_widget.hpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.hpp	2009-09-09 04:44:38 UTC (rev 3210)
+++ trunk/windstille/src/editor/windstille_widget.hpp	2009-09-09 04:45:59 UTC (rev 3211)
@@ -41,11 +41,9 @@
 #include "editor/layer.hpp"
 #include "editor/command.hpp"
 #include "editor/sector_model.hpp"
-#include "editor/undo_manager.hpp"
 #include "editor/document.hpp"
 
 class Tool;
-class UndoManager;
 class ScrollTool;
 class SectorModel;
 class EditorWindow;
@@ -83,8 +81,6 @@
 
   GraphicContextState& get_state() { return state; }
 
-  void execute(CommandHandle cmd);
-
   virtual void on_realize();
   virtual bool on_timeout();
   virtual bool on_configure_event(GdkEventConfigure* event);
@@ -112,7 +108,6 @@
   void update(float delta);
 
   Document&    get_document() const { return *m_document; }
-  SectorModel* get_sector_model() const { return &(m_document->get_sector_model()); }
   
   SelectMask& get_select_mask() { return select_mask; }
 
@@ -137,7 +132,6 @@
   void save_screenshot(const std::string& filename);
 
 private:
-  void on_selection_change();
   void on_document_change();
 
 private:



From grumbel at mail.berlios.de  Wed Sep  9 07:07:29 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 9 Sep 2009 07:07:29 +0200
Subject: [Windstille-commit] r3212 - trunk/windstille/src/editor
Message-ID: <200909090507.n8957T9H007773@sheep.berlios.de>

Author: grumbel
Date: 2009-09-09 07:07:28 +0200 (Wed, 09 Sep 2009)
New Revision: 3212

Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/document.hpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
Log:
Moved file loading into constructor, implemented undo_group_begin/end

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-09 04:45:59 UTC (rev 3211)
+++ trunk/windstille/src/editor/document.cpp	2009-09-09 05:07:28 UTC (rev 3212)
@@ -35,20 +35,21 @@
 Document::Document()
   : m_undo_manager(new UndoManager()),
     m_sector_model(new SectorModel()),
+    m_group_command(),
     m_selection(Selection::create()),
     m_control_points(),
-    m_sig_on_change()
+    m_sig_on_change()    
 {
 }
 
 Document::Document(const std::string& filename)
   : m_undo_manager(new UndoManager()),
-    m_sector_model(new SectorModel()),
+    m_sector_model(new SectorModel(filename)),
+    m_group_command(),
     m_selection(Selection::create()),
     m_control_points(),
     m_sig_on_change()
 {
-  m_sector_model->load(filename);
 }
 
 Document::~Document()
@@ -70,11 +71,15 @@
 void
 Document::undo_group_begin()
 {
+  assert(!m_group_command);
+  m_group_command.reset(new GroupCommand());
 }
 
 void
 Document::undo_group_end()
 {
+  execute(m_group_command);
+  m_group_command.reset();
 }
 
 bool
@@ -92,11 +97,17 @@
 void
 Document::execute(CommandHandle cmd)
 {
-  // FIXME: All stuff should be routed through this
-  m_undo_manager->execute(cmd);
-  EditorWindow::current()->update_undo_state();
-  m_sector_model->rebuild_scene_graph();
-  m_sig_on_change();
+  if (m_group_command)
+  {
+    m_group_command->add(cmd);
+  }
+  else
+  {
+    m_undo_manager->execute(cmd);
+    EditorWindow::current()->update_undo_state();
+    m_sector_model->rebuild_scene_graph();
+    m_sig_on_change();
+  }
 }
 
 void

Modified: trunk/windstille/src/editor/document.hpp
===================================================================
--- trunk/windstille/src/editor/document.hpp	2009-09-09 04:45:59 UTC (rev 3211)
+++ trunk/windstille/src/editor/document.hpp	2009-09-09 05:07:28 UTC (rev 3212)
@@ -22,6 +22,7 @@
 #include <boost/scoped_ptr.hpp>
 #include <boost/function.hpp>
 
+#include "editor/group_command.hpp"
 #include "editor/selection.hpp"
 #include "editor/command.hpp"
 #include "editor/layer.hpp"
@@ -40,6 +41,7 @@
   boost::scoped_ptr<UndoManager> m_undo_manager;
   boost::scoped_ptr<SectorModel> m_sector_model;
 
+  boost::shared_ptr<GroupCommand> m_group_command;
   SelectionHandle m_selection;
 
   std::vector<ControlPointHandle> m_control_points;

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-09 04:45:59 UTC (rev 3211)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-09 05:07:28 UTC (rev 3212)
@@ -38,6 +38,16 @@
 
 LayerManagerColumns* LayerManagerColumns::instance_ = 0;
 
+
+SectorModel::SectorModel(const std::string& filename)
+  : nav_graph(new NavigationGraph()),
+    scene_graph(new SceneGraph()),
+    layer_tree(),
+    ambient_color()
+{
+  load(filename);
+}
+
 SectorModel::SectorModel()
   : nav_graph(new NavigationGraph()),
     scene_graph(new SceneGraph()),

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-09 04:45:59 UTC (rev 3211)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-09 05:07:28 UTC (rev 3212)
@@ -86,6 +86,7 @@
   typedef std::vector<LayerHandle> Layers;
 
   SectorModel();
+  SectorModel(const std::string& filename);
   ~SectorModel();
 
   void draw(SceneContext& sc, const SelectMask& layers);
@@ -129,10 +130,6 @@
 
   SnapData snap_object(const Rectf& object, const std::set<ObjectModelHandle>& ignore_objects) const;
 
-  void load(const std::string& filename);
-  void load_layer(const FileReader& filename, 
-                  std::map<std::string, ObjectModelHandle>& id_table,
-                  std::map<ObjectModelHandle, std::string>& parent_table);
   void write(FileWriter& writer) const;
 
   NavigationGraph& get_nav_graph()   const { return *nav_graph; }
@@ -147,6 +144,12 @@
   void rebuild_scene_graph();
 
 private:
+  void load(const std::string& filename);
+  void load_layer(const FileReader& filename, 
+                  std::map<std::string, ObjectModelHandle>& id_table,
+                  std::map<ObjectModelHandle, std::string>& parent_table); 
+
+private:
   SectorModel(const SectorModel&);
   SectorModel& operator=(const SectorModel&);
 };



From grumbel at mail.berlios.de  Wed Sep  9 07:29:51 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 9 Sep 2009 07:29:51 +0200
Subject: [Windstille-commit] r3213 - trunk/windstille/src/editor
Message-ID: <200909090529.n895TpAS006578@sheep.berlios.de>

Author: grumbel
Date: 2009-09-09 07:29:50 +0200 (Wed, 09 Sep 2009)
New Revision: 3213

Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/document.hpp
   trunk/windstille/src/editor/navgraph_edge_object_model.cpp
   trunk/windstille/src/editor/navgraph_edge_object_model.hpp
   trunk/windstille/src/editor/windstille_widget.cpp
   trunk/windstille/src/editor/windstille_widget.hpp
Log:
Fixed ControlPoints and undo_group_end()

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-09 05:07:28 UTC (rev 3212)
+++ trunk/windstille/src/editor/document.cpp	2009-09-09 05:29:50 UTC (rev 3213)
@@ -78,8 +78,9 @@
 void
 Document::undo_group_end()
 {
-  execute(m_group_command);
+  CommandHandle tmp = m_group_command;
   m_group_command.reset();
+  execute(tmp);
 }
 
 bool

Modified: trunk/windstille/src/editor/document.hpp
===================================================================
--- trunk/windstille/src/editor/document.hpp	2009-09-09 05:07:28 UTC (rev 3212)
+++ trunk/windstille/src/editor/document.hpp	2009-09-09 05:29:50 UTC (rev 3213)
@@ -115,6 +115,7 @@
   ControlPointHandle get_control_point(const Vector2f& pos) const;
   void clear_control_points();
   void create_control_points();
+  const std::vector<ControlPointHandle>& get_control_points() const { return m_control_points; }
   /** @} */
 
   sigc::signal<void>& signal_on_change() { return m_sig_on_change; }

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-09 05:07:28 UTC (rev 3212)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-09 05:29:50 UTC (rev 3213)
@@ -33,10 +33,13 @@
     m_edge()
 {
   std::cout << "Adding edge" << std::endl;
-  m_edge = sector.get_nav_graph().add_edge(m_lhs->get_node(),
-                                           m_rhs->get_node());
+  m_edge = sector.get_nav_graph().add_edge(m_lhs->get_node(), m_rhs->get_node());
 }
 
+NavGraphEdgeObjectModel::~NavGraphEdgeObjectModel()
+{
+}
+
 void
 NavGraphEdgeObjectModel::update(float delta)
 {

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-09 05:07:28 UTC (rev 3212)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-09 05:29:50 UTC (rev 3213)
@@ -39,6 +39,7 @@
   NavGraphEdgeObjectModel(boost::shared_ptr<NavGraphNodeObjectModel> lhs,
                           boost::shared_ptr<NavGraphNodeObjectModel> rhs,
                           SectorModel& sector);
+  virtual ~NavGraphEdgeObjectModel();
 
   void add_to_scenegraph(SceneGraph& sg);
   void update(float delta);

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-09 05:07:28 UTC (rev 3212)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-09 05:29:50 UTC (rev 3213)
@@ -47,7 +47,6 @@
   : editor(editor_),
     m_document(new Document),
     filename(),
-    control_points(),
     state(),
     compositor(),
     sc(),
@@ -283,8 +282,8 @@
           //sc->control().draw_rect(selection->get_bounding_box(), Color(1.0f, 1.0f, 1.0f, 1.0f));
         }
 
-      for(std::vector<ControlPointHandle>::iterator i = control_points.begin();
-          i != control_points.end(); ++i)
+      for(std::vector<ControlPointHandle>::const_iterator i = m_document->get_control_points().begin();
+          i != m_document->get_control_points().end(); ++i)
         {
           (*i)->draw(*sc);
         }

Modified: trunk/windstille/src/editor/windstille_widget.hpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.hpp	2009-09-09 05:07:28 UTC (rev 3212)
+++ trunk/windstille/src/editor/windstille_widget.hpp	2009-09-09 05:29:50 UTC (rev 3213)
@@ -60,7 +60,6 @@
   boost::scoped_ptr<Document> m_document;
 
   std::string filename;
-  std::vector<ControlPointHandle> control_points;
 
   GraphicContextState   state;
   boost::scoped_ptr<Compositor> compositor;



From grumbel at mail.berlios.de  Thu Sep 10 14:48:56 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 10 Sep 2009 14:48:56 +0200
Subject: [Windstille-commit] r3214 - trunk/windstille/src/util
Message-ID: <200909101248.n8ACmu6v016143@sheep.berlios.de>

Author: grumbel
Date: 2009-09-10 14:48:56 +0200 (Thu, 10 Sep 2009)
New Revision: 3214

Modified:
   trunk/windstille/src/util/pathname.cpp
Log:
Append '/' to path when none is present

Modified: trunk/windstille/src/util/pathname.cpp
===================================================================
--- trunk/windstille/src/util/pathname.cpp	2009-09-09 05:29:50 UTC (rev 3213)
+++ trunk/windstille/src/util/pathname.cpp	2009-09-10 12:48:56 UTC (rev 3214)
@@ -65,11 +65,21 @@
 void Pathname::set_datadir(const std::string& datadir)
 {
   s_datadir = datadir;
+
+  if ( !s_datadir.empty() && s_datadir[s_datadir.size()-1] != '/' )
+  {
+    s_datadir += '/';
+  }
 }
 
 void Pathname::set_userdir(const std::string& userdir)
 {
   s_userdir = userdir;
+
+  if ( !s_userdir.empty() && s_userdir[s_userdir.size()-1] != '/' )
+  {
+    s_userdir += '/';
+  }
 }
 
 std::string Pathname::get_datadir()



From grumbel at mail.berlios.de  Thu Sep 10 14:49:26 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 10 Sep 2009 14:49:26 +0200
Subject: [Windstille-commit] r3215 - trunk/windstille/src/editor
Message-ID: <200909101249.n8ACnQci016191@sheep.berlios.de>

Author: grumbel
Date: 2009-09-10 14:49:26 +0200 (Thu, 10 Sep 2009)
New Revision: 3215

Added:
   trunk/windstille/src/editor/navigation_graph_model.cpp
   trunk/windstille/src/editor/navigation_graph_model.hpp
Log:
Started implementing NavigationGraphModel

Added: trunk/windstille/src/editor/navigation_graph_model.cpp
===================================================================
--- trunk/windstille/src/editor/navigation_graph_model.cpp	2009-09-10 12:48:56 UTC (rev 3214)
+++ trunk/windstille/src/editor/navigation_graph_model.cpp	2009-09-10 12:49:26 UTC (rev 3215)
@@ -0,0 +1,103 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "editor/navigation_graph_model.hpp"
+
+#include "editor/navgraph_edge_object_model.hpp"
+#include "editor/navgraph_node_object_model.hpp"
+#include "math/line.hpp"
+#include "navigation/navigation_graph.hpp"
+
+NavigationGraphModel::NavigationGraphModel()
+  : nodes(),
+    edges()   
+{
+}
+
+NavigationGraphModel::~NavigationGraphModel()
+{
+}
+  
+boost::shared_ptr<NavGraphNodeObjectModel>
+NavigationGraphModel::create_node(const Vector2f& pos)
+{
+  boost::shared_ptr<NavGraphNodeObjectModel> node(new NavGraphNodeObjectModel(pos));
+  nodes.push_back(node);
+  return node;
+}
+
+boost::shared_ptr<NavGraphEdgeObjectModel>
+NavigationGraphModel::create_edge(boost::shared_ptr<NavGraphNodeObjectModel> lhs, 
+                                  boost::shared_ptr<NavGraphNodeObjectModel> rhs)
+{
+  boost::shared_ptr<NavGraphEdgeObjectModel> edge(new NavGraphEdgeObjectModel(lhs, rhs));
+  edges.push_back(edge);
+  return edge;
+}
+
+  
+void
+NavigationGraphModel::remove_node(boost::shared_ptr<NavGraphNodeObjectModel> node)
+{
+}
+
+void
+NavigationGraphModel::remove_edge(boost::shared_ptr<NavGraphEdgeObjectModel> edge)
+{
+}
+
+boost::shared_ptr<NavGraphNodeObjectModel>
+NavigationGraphModel::find_closest_node(const Vector2f& pos, float radius) const
+{
+  boost::shared_ptr<NavGraphNodeObjectModel> node;
+  float min_distance = radius;
+
+  for(Nodes::const_iterator i = nodes.begin(); i != nodes.end(); ++i)
+  {
+    float current_distance = (pos - (*i)->get_world_pos()).length();
+    if (current_distance < min_distance)
+    {
+      min_distance = current_distance;
+      node = *i;
+    }
+  }
+
+  return node;
+}
+
+boost::shared_ptr<NavGraphEdgeObjectModel>
+NavigationGraphModel::find_closest_edge(const Vector2f& pos, float radius) const
+{
+  boost::shared_ptr<NavGraphEdgeObjectModel> edge;
+  float min_distance = radius;
+
+  for(Edges::const_iterator i = edges.begin(); i != edges.end(); ++i)
+  {
+    float current_distance = Line((*i)->get_lhs()->get_world_pos(),
+                                  (*i)->get_rhs()->get_world_pos()).distance(pos);
+    if (current_distance < min_distance)
+    {
+      min_distance = current_distance;
+      edge = *i;
+    }
+  }
+
+  return edge;
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/navigation_graph_model.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/navigation_graph_model.hpp
===================================================================
--- trunk/windstille/src/editor/navigation_graph_model.hpp	2009-09-10 12:48:56 UTC (rev 3214)
+++ trunk/windstille/src/editor/navigation_graph_model.hpp	2009-09-10 12:49:26 UTC (rev 3215)
@@ -0,0 +1,61 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_EDITOR_NAVIGATION_GRAPH_MODEL_HPP
+#define HEADER_WINDSTILLE_EDITOR_NAVIGATION_GRAPH_MODEL_HPP
+
+#include <vector>
+#include <boost/shared_ptr.hpp>
+#include <boost/scoped_ptr.hpp>
+
+class Vector2f;
+class NavigationGraph;
+class NavGraphEdgeObjectModel;
+class NavGraphNodeObjectModel;
+
+class NavigationGraphModel
+{
+private:
+  typedef std::vector<boost::shared_ptr<NavGraphNodeObjectModel> > Nodes; 
+  typedef std::vector<boost::shared_ptr<NavGraphEdgeObjectModel> > Edges;
+
+  Nodes nodes;
+  Edges edges;
+
+public:
+  NavigationGraphModel();
+  ~NavigationGraphModel();
+  
+  boost::shared_ptr<NavGraphNodeObjectModel> create_node(const Vector2f& pos);
+  boost::shared_ptr<NavGraphEdgeObjectModel> create_edge(boost::shared_ptr<NavGraphNodeObjectModel> lhs, 
+                                                         boost::shared_ptr<NavGraphNodeObjectModel> rhs);
+  
+  void remove_node(boost::shared_ptr<NavGraphNodeObjectModel> node);
+  void remove_edge(boost::shared_ptr<NavGraphEdgeObjectModel> edge);
+
+  boost::shared_ptr<NavGraphNodeObjectModel> find_closest_node(const Vector2f& pos, float radius) const;
+  boost::shared_ptr<NavGraphEdgeObjectModel> find_closest_edge(const Vector2f& pos, float radius) const;
+
+private:
+  NavigationGraphModel(const NavigationGraphModel&);
+  NavigationGraphModel& operator=(const NavigationGraphModel&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/navigation_graph_model.hpp
___________________________________________________________________
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Thu Sep 10 14:50:53 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 10 Sep 2009 14:50:53 +0200
Subject: [Windstille-commit] r3216 - trunk/windstille/src/editor
Message-ID: <200909101250.n8ACorYB016433@sheep.berlios.de>

Author: grumbel
Date: 2009-09-10 14:50:52 +0200 (Thu, 10 Sep 2009)
New Revision: 3216

Added:
   trunk/windstille/src/editor/layer_manager_columns.hpp
Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/document.hpp
   trunk/windstille/src/editor/layer.cpp
   trunk/windstille/src/editor/layer_manager.cpp
   trunk/windstille/src/editor/layer_manager.hpp
   trunk/windstille/src/editor/navgraph_edge_object_model.cpp
   trunk/windstille/src/editor/navgraph_edge_object_model.hpp
   trunk/windstille/src/editor/navgraph_insert_tool.cpp
   trunk/windstille/src/editor/navgraph_node_object_model.cpp
   trunk/windstille/src/editor/navgraph_node_object_model.hpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
   trunk/windstille/src/editor/windstille_widget.cpp
Log:
NavGraph stuff

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-10 12:49:26 UTC (rev 3215)
+++ trunk/windstille/src/editor/document.cpp	2009-09-10 12:50:52 UTC (rev 3216)
@@ -26,6 +26,7 @@
 #include "editor/editor_window.hpp"
 #include "editor/object_model.hpp"
 #include "editor/decal_object_model.hpp"
+#include "editor/navgraph_edge_object_model.hpp"
 
 #include "editor/group_command.hpp"
 #include "editor/object_commands.hpp"
@@ -131,6 +132,30 @@
 }
 
 void
+Document::navgraph_node_add(boost::shared_ptr<NavGraphNodeObjectModel> node)
+{
+}
+
+void
+Document::navgraph_node_remove(boost::shared_ptr<NavGraphNodeObjectModel> node)
+{
+}
+
+void
+Document::navgraph_edge_add(LayerHandle layer, 
+                            boost::shared_ptr<NavGraphNodeObjectModel> lhs,
+                            boost::shared_ptr<NavGraphNodeObjectModel> rhs)
+{
+  boost::shared_ptr<NavGraphEdgeObjectModel> edge_obj(new NavGraphEdgeObjectModel(lhs, rhs)); //, *m_sector_model));
+  object_add(layer, edge_obj);
+}
+
+void
+Document::navgraph_edge_remove(boost::shared_ptr<NavGraphEdgeObjectModel> edge)
+{
+}
+
+void
 Document::object_add(LayerHandle layer, ObjectModelHandle object)
 {
   execute(CommandHandle(new ObjectAddCommand(layer, object)));

Modified: trunk/windstille/src/editor/document.hpp
===================================================================
--- trunk/windstille/src/editor/document.hpp	2009-09-10 12:49:26 UTC (rev 3215)
+++ trunk/windstille/src/editor/document.hpp	2009-09-10 12:50:52 UTC (rev 3216)
@@ -29,6 +29,8 @@
 
 class UndoManager;
 class SectorModel;
+class NavGraphNodeObjectModel;
+class NavGraphEdgeObjectModel;
 
 /**
  *  Document wraps undo/redo functionality around SectorModel and
@@ -77,6 +79,17 @@
   void layer_remove(const Gtk::TreeModel::Path& path);
   /** @} */
 
+  /* NavGraph Commands
+   * @{*/
+  void navgraph_node_add(boost::shared_ptr<NavGraphNodeObjectModel> node);
+  void navgraph_node_remove(boost::shared_ptr<NavGraphNodeObjectModel> node);
+
+  void navgraph_edge_add(LayerHandle layer, 
+                         boost::shared_ptr<NavGraphNodeObjectModel> lhs,
+                         boost::shared_ptr<NavGraphNodeObjectModel> rhs);
+  void navgraph_edge_remove(boost::shared_ptr<NavGraphEdgeObjectModel> edge);
+  /** @} */
+
   /* Object Commands
    * @{*/
   void object_add(LayerHandle layer, ObjectModelHandle object);

Modified: trunk/windstille/src/editor/layer.cpp
===================================================================
--- trunk/windstille/src/editor/layer.cpp	2009-09-10 12:49:26 UTC (rev 3215)
+++ trunk/windstille/src/editor/layer.cpp	2009-09-10 12:50:52 UTC (rev 3216)
@@ -18,6 +18,7 @@
 
 #include "editor/layer.hpp"
 
+#include "editor/layer_manager_columns.hpp"
 #include "editor/sector_model.hpp"
 
 Layer::Layer(SectorModel& sector)

Modified: trunk/windstille/src/editor/layer_manager.cpp
===================================================================
--- trunk/windstille/src/editor/layer_manager.cpp	2009-09-10 12:49:26 UTC (rev 3215)
+++ trunk/windstille/src/editor/layer_manager.cpp	2009-09-10 12:50:52 UTC (rev 3216)
@@ -16,6 +16,8 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
+#include "editor/layer_manager.hpp"
+
 #include <iostream>
 #include <gtkmm/stock.h>
 #include <gtkmm/toolbar.h>
@@ -26,7 +28,7 @@
 
 #include "editor/editor_window.hpp"
 #include "editor/sector_model.hpp"
-#include "editor/layer_manager.hpp"
+#include "editor/layer_manager_columns.hpp"
 
 LayerManager::LayerManager(EditorWindow& editor_)
   : editor(editor_),

Modified: trunk/windstille/src/editor/layer_manager.hpp
===================================================================
--- trunk/windstille/src/editor/layer_manager.hpp	2009-09-10 12:49:26 UTC (rev 3215)
+++ trunk/windstille/src/editor/layer_manager.hpp	2009-09-10 12:50:52 UTC (rev 3216)
@@ -19,11 +19,16 @@
 #ifndef HEADER_WINDSTILLE_EDITOR_LAYER_MANAGER_HPP
 #define HEADER_WINDSTILLE_EDITOR_LAYER_MANAGER_HPP
 
+#include <gtkmm/box.h>
+#include <gtkmm/label.h>
+#include <gtkmm/scrolledwindow.h>
+#include <gtkmm/toggleaction.h>
+#include <gtkmm/treeview.h>
 #include <gtkmm/uimanager.h>
-
+
 class SectorModel;
 class EditorWindow;
-
+
 class LayerManager : public Gtk::VBox
 {
 private:
@@ -51,7 +56,7 @@
   LayerManager(const LayerManager&);
   LayerManager& operator=(const LayerManager&);
 };
-
+
 #endif
 
 /* EOF */

Added: trunk/windstille/src/editor/layer_manager_columns.hpp
===================================================================
--- trunk/windstille/src/editor/layer_manager_columns.hpp	2009-09-10 12:49:26 UTC (rev 3215)
+++ trunk/windstille/src/editor/layer_manager_columns.hpp	2009-09-10 12:50:52 UTC (rev 3216)
@@ -0,0 +1,59 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_EDTIOR_LAYER_MANAGER_COLUMNS_HPP
+#define HEADER_WINDSTILLE_EDTIOR_LAYER_MANAGER_COLUMNS_HPP
+
+class LayerManagerColumns : public Gtk::TreeModel::ColumnRecord
+{
+private:
+  static LayerManagerColumns* instance_;
+
+public:
+  static LayerManagerColumns& instance() {
+    if (instance_)
+      return *instance_;
+    else
+      return *(instance_ = new LayerManagerColumns());
+  }
+
+  Gtk::TreeModelColumn<Glib::RefPtr<Gdk::Pixbuf> > type_icon;
+  Gtk::TreeModelColumn<Glib::ustring>              name;
+  Gtk::TreeModelColumn<bool>                       visible;
+  Gtk::TreeModelColumn<bool>                       locked;
+  Gtk::TreeModelColumn<LayerHandle>                layer;
+
+private:
+  LayerManagerColumns()
+    : type_icon(),
+      name(),
+      visible(),
+      locked(),
+      layer()
+  {
+    add(type_icon); 
+    add(name); 
+    add(visible); 
+    add(locked);
+    add(layer);
+  }
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/layer_manager_columns.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-10 12:49:26 UTC (rev 3215)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-10 12:50:52 UTC (rev 3216)
@@ -24,16 +24,15 @@
 #include "scenegraph/vertex_array_drawable.hpp"
 
 NavGraphEdgeObjectModel::NavGraphEdgeObjectModel(boost::shared_ptr<NavGraphNodeObjectModel> lhs,
-                                                 boost::shared_ptr<NavGraphNodeObjectModel> rhs,
-                                                 SectorModel& sector)
+                                                 boost::shared_ptr<NavGraphNodeObjectModel> rhs)
+                                                 //SectorModel& sector)
   : ObjectModel("NavGraphEdgeObjectModel", Vector2f()),
     m_lhs(lhs),
     m_rhs(rhs),
     m_drawable(),
     m_edge()
 {
-  std::cout << "Adding edge" << std::endl;
-  m_edge = sector.get_nav_graph().add_edge(m_lhs->get_node(), m_rhs->get_node());
+  //m_edge = sector.get_nav_graph().add_edge(m_lhs->get_node(), m_rhs->get_node());
 }
 
 NavGraphEdgeObjectModel::~NavGraphEdgeObjectModel()

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-10 12:49:26 UTC (rev 3215)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-10 12:50:52 UTC (rev 3216)
@@ -19,8 +19,6 @@
 #ifndef HEADER_WINDSTILLE_EDITOR_NAVGRAPH_EDGE_OBJECT_MODEL_HPP
 #define HEADER_WINDSTILLE_EDITOR_NAVGRAPH_EDGE_OBJECT_MODEL_HPP
 
-#include <boost/weak_ptr.hpp>
-
 #include "navigation/navigation_graph.hpp"
 #include "editor/object_model.hpp"
 
@@ -37,8 +35,7 @@
 
 public:
   NavGraphEdgeObjectModel(boost::shared_ptr<NavGraphNodeObjectModel> lhs,
-                          boost::shared_ptr<NavGraphNodeObjectModel> rhs,
-                          SectorModel& sector);
+                          boost::shared_ptr<NavGraphNodeObjectModel> rhs);
   virtual ~NavGraphEdgeObjectModel();
 
   void add_to_scenegraph(SceneGraph& sg);

Modified: trunk/windstille/src/editor/navgraph_insert_tool.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-10 12:49:26 UTC (rev 3215)
+++ trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-10 12:50:52 UTC (rev 3216)
@@ -53,29 +53,23 @@
     {
       if (node)
       { // connect last node with existing node
-        NavGraphEdgeObjectModel* edge_obj = new NavGraphEdgeObjectModel(sector.find_navgraph_node(last_node),
-                                                                        sector.find_navgraph_node(node),
-                                                                        sector);
-        wst.get_document().object_add(wst.get_current_layer(), ObjectModelHandle(edge_obj));
-
+        wst.get_document().navgraph_edge_add(wst.get_current_layer(),
+                                             sector.find_navgraph_node(last_node),
+                                             sector.find_navgraph_node(node));
         last_node = NodeHandle();
         connection_node = NodeHandle();
       }
       else
       { // connect last node with newly created node
         // FIXME: Make this a GroupCommand
-        NavGraphNodeObjectModel* obj = new NavGraphNodeObjectModel(mouse_pos, sector);
-        node = obj->get_node();
+        boost::shared_ptr<NavGraphNodeObjectModel> node_obj(new NavGraphNodeObjectModel(mouse_pos)); //, sector));
         
-        NavGraphEdgeObjectModel* edge_obj = new NavGraphEdgeObjectModel(sector.find_navgraph_node(last_node),
-                                                                        sector.find_navgraph_node(node), 
-                                                                        sector);
-
         wst.get_document().undo_group_begin();
-        wst.get_document().object_add(wst.get_current_layer(), ObjectModelHandle(obj));
-        wst.get_document().object_add(wst.get_current_layer(), ObjectModelHandle(edge_obj));
+        wst.get_document().object_add(wst.get_document().get_sector_model().get_navgraph_layer(), node_obj);
+        wst.get_document().navgraph_edge_add(wst.get_current_layer(), sector.find_navgraph_node(last_node), node_obj);
         wst.get_document().undo_group_end();
 
+        node = node_obj->get_node();       
         last_node = NodeHandle();
       }
       mode = NO_MODE;
@@ -96,10 +90,9 @@
       }
       else
       {
-        NavGraphNodeObjectModel* obj = new NavGraphNodeObjectModel(mouse_pos, sector);
-        last_node = obj->get_node();
-        wst.get_document().object_add(wst.get_current_layer(), ObjectModelHandle(obj));
-              
+        boost::shared_ptr<NavGraphNodeObjectModel> node_obj(new NavGraphNodeObjectModel(mouse_pos));//, sector));
+        last_node = node_obj->get_node();
+        wst.get_document().object_add(wst.get_document().get_sector_model().get_navgraph_layer(), node_obj);
         mode = EDGE_MODE;
       }
     }
@@ -163,13 +156,15 @@
 NavgraphInsertTool::mouse_right_down(GdkEventButton* /*event*/, WindstilleWidget& wst)
 {
   NavigationGraph& navgraph = wst.get_document().get_sector_model().get_nav_graph();
+  SectorModel& sector = wst.get_document().get_sector_model();
 
   NodeHandle node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
   EdgeHandle edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
 
   if (node)
     {
-      navgraph.remove_node(node);
+      //navgraph.remove_node(node);
+      wst.get_document().object_remove(sector.find_navgraph_node(node));
 
       mouse_over_edge = EdgeHandle();
       mouse_over_node = NodeHandle();
@@ -178,7 +173,8 @@
     }
   else if (edge)
     {
-      navgraph.remove_edge(edge);
+      //navgraph.remove_edge(edge);
+      wst.get_document().object_remove(sector.find_navgraph_edge(edge));
 
       mouse_over_edge = EdgeHandle();
       mouse_over_node = NodeHandle();
@@ -189,7 +185,7 @@
     {
       
     }
-}  
+}
   
 void
 NavgraphInsertTool::draw(SceneContext& sc)

Modified: trunk/windstille/src/editor/navgraph_node_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-10 12:49:26 UTC (rev 3215)
+++ trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-10 12:50:52 UTC (rev 3216)
@@ -23,14 +23,18 @@
 #include "scenegraph/scene_graph.hpp"
 #include "navigation/node.hpp"
 
-NavGraphNodeObjectModel::NavGraphNodeObjectModel(const Vector2f& pos, SectorModel& sector)
+NavGraphNodeObjectModel::NavGraphNodeObjectModel(const Vector2f& pos)//, SectorModel& sector)
   : ObjectModel("NavGraphNodeObjectModel", pos),
     m_drawable(),
     m_node()
 {
-  m_node = sector.get_nav_graph().add_node(pos);
+  //m_node = sector.get_nav_graph().add_node(pos);
 }
 
+NavGraphNodeObjectModel::~NavGraphNodeObjectModel()
+{
+}
+
 void
 NavGraphNodeObjectModel::add_to_scenegraph(SceneGraph& sg)
 {

Modified: trunk/windstille/src/editor/navgraph_node_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-10 12:49:26 UTC (rev 3215)
+++ trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-10 12:50:52 UTC (rev 3216)
@@ -33,7 +33,8 @@
   NodeHandle m_node;
 
 public:
-  NavGraphNodeObjectModel(const Vector2f& pos, SectorModel& sector);
+  NavGraphNodeObjectModel(const Vector2f& pos);//, SectorModel& sector);
+  ~NavGraphNodeObjectModel();
 
   void add_to_scenegraph(SceneGraph& sg);
   void set_rel_pos(const Vector2f& rel_pos_);

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-10 12:49:26 UTC (rev 3215)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-10 12:50:52 UTC (rev 3216)
@@ -22,19 +22,20 @@
 #include <iostream>
 #include <gdkmm/pixbuf.h>
 
-#include "navigation/navigation_graph.hpp"
-#include "scenegraph/scene_graph.hpp"
-#include "navigation/edge.hpp"
-#include "navigation/node.hpp"
+#include "display/scene_context.hpp"
+#include "display/surface.hpp"
 #include "editor/editor_window.hpp"
-#include "editor/windstille_widget.hpp"
+#include "editor/layer_manager_columns.hpp"
+#include "editor/navgraph_edge_object_model.hpp"
 #include "editor/navgraph_node_object_model.hpp"
-#include "editor/navgraph_edge_object_model.hpp"
-#include "util/file_reader.hpp"
-#include "display/scene_context.hpp"
-#include "display/surface.hpp"
 #include "editor/object_model_factory.hpp"
 #include "editor/sector_model.hpp"
+#include "editor/windstille_widget.hpp"
+#include "navigation/edge.hpp"
+#include "navigation/navigation_graph.hpp"
+#include "navigation/node.hpp"
+#include "scenegraph/scene_graph.hpp"
+#include "util/file_reader.hpp"
 
 LayerManagerColumns* LayerManagerColumns::instance_ = 0;
 
@@ -42,19 +43,22 @@
 SectorModel::SectorModel(const std::string& filename)
   : nav_graph(new NavigationGraph()),
     scene_graph(new SceneGraph()),
-    layer_tree(),
+    layer_tree(Gtk::ListStore::create(LayerManagerColumns::instance())),
+    navgraph_layer(new Layer(*this)),
     ambient_color()
 {
+  register_callbacks();
   load(filename);
 }
 
 SectorModel::SectorModel()
   : nav_graph(new NavigationGraph()),
     scene_graph(new SceneGraph()),
-    layer_tree(),
+    layer_tree(Gtk::ListStore::create(LayerManagerColumns::instance())),
+    navgraph_layer(new Layer(*this)),
     ambient_color()
 {
-  layer_tree = Gtk::ListStore::create(LayerManagerColumns::instance());
+  register_callbacks();
 
   Gtk::ListStore::iterator it = layer_tree->append();
 
@@ -65,7 +69,15 @@
   (*it)[LayerManagerColumns::instance().locked]    = false;
   (*it)[LayerManagerColumns::instance().layer]     = layer;
   layer->sync(*it);
+}
 
+SectorModel::~SectorModel()
+{
+}
+
+void
+SectorModel::register_callbacks()
+{  
   layer_tree->signal_row_changed().connect(sigc::mem_fun(*this, &SectorModel::on_row_changed));
   layer_tree->signal_row_deleted().connect(sigc::mem_fun(*this, &SectorModel::on_row_deleted));
   layer_tree->signal_row_has_child_toggled().connect(sigc::mem_fun(*this, &SectorModel::on_row_has_child_toggled));
@@ -73,10 +85,6 @@
   layer_tree->signal_rows_reordered().connect(sigc::mem_fun(*this, &SectorModel::on_rows_reordered));
 }
 
-SectorModel::~SectorModel()
-{
-}
-
 void
 SectorModel::add_layer(LayerHandle layer, const Gtk::TreeModel::Path& path)
 {
@@ -257,17 +265,22 @@
   const Layers& layers = get_layers();
   SelectionHandle selection = Selection::create();
 
+  if (ObjectModelHandle object = navgraph_layer->get_object_at(pos, layermask))
+  {
+    return object;
+  }
+  
   for(Layers::const_reverse_iterator i = layers.rbegin(); i != layers.rend(); ++i)
+  {
+    if ((*i)->is_visible() && !(*i)->is_locked())
     {
-      if ((*i)->is_visible() && !(*i)->is_locked())
-        {
-          ObjectModelHandle object = (*i)->get_object_at(pos, layermask);
+      ObjectModelHandle object = (*i)->get_object_at(pos, layermask);
           
-          if (object.get())
-            return object;
-        }
+      if (object)
+        return object;
     }
-
+  }
+  
   return ObjectModelHandle();
 }
 
@@ -277,14 +290,19 @@
   const Layers& layers = get_layers();
   SelectionHandle selection = Selection::create();
 
+  {
+    SelectionHandle new_sel = navgraph_layer->get_selection(rect, layermask);
+    selection->add(new_sel->begin(), new_sel->end());
+  }
+
   for(Layers::const_reverse_iterator i = layers.rbegin(); i != layers.rend(); ++i)
+  {
+    if ((*i)->is_visible() && !(*i)->is_locked())
     {
-      if ((*i)->is_visible() && !(*i)->is_locked())
-        {
-          SelectionHandle new_sel = (*i)->get_selection(rect, layermask);
-          selection->add(new_sel->begin(), new_sel->end());
-        }
+      SelectionHandle new_sel = (*i)->get_selection(rect, layermask);
+      selection->add(new_sel->begin(), new_sel->end());
     }
+  }
 
   return selection;
 }
@@ -537,7 +555,7 @@
 {
   // FIXME: should make a queue_rebuild_scene_graph() to limit the number of rebuilds per frame to 1
   scene_graph->clear();
-
+  
   const Layers& layers = get_layers();
   for(Layers::const_reverse_iterator layer = layers.rbegin(); layer != layers.rend(); ++layer)
   {
@@ -553,6 +571,11 @@
     }
   }
 
+  for(Layer::const_iterator obj = navgraph_layer->begin(); obj != navgraph_layer->end(); ++obj)
+  {
+    (*obj)->add_to_scenegraph(*scene_graph);
+  }
+
   queue_draw();
 }
 
@@ -614,23 +637,16 @@
 {
   // FIXME: Could solve this better by either a map/unsorted_set or by having
   // a userdata ptr in NavGraph
-  const Layers& layers = get_layers();
-  for(Layers::const_reverse_iterator layer = layers.rbegin(); layer != layers.rend(); ++layer)
+  for(Layer::const_iterator obj = navgraph_layer->begin(); obj != navgraph_layer->end(); ++obj)
   {
-    if (*layer)
+    boost::shared_ptr<NavGraphNodeObjectModel> test_node = boost::dynamic_pointer_cast<NavGraphNodeObjectModel>(*obj);
+    if (test_node)
     {
-      for(Layer::const_iterator obj = (*layer)->begin(); obj != (*layer)->end(); ++obj)
+      if (test_node->get_node() == node)
       {
-        boost::shared_ptr<NavGraphNodeObjectModel> test_node = boost::dynamic_pointer_cast<NavGraphNodeObjectModel>(*obj);
-        if (test_node)
-        {
-          if (test_node->get_node() == node)
-          {
-            return test_node;
-          }
-        }
+        return test_node;
       }
-    } 
+    }
   }
   
   return boost::shared_ptr<NavGraphNodeObjectModel>();

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-10 12:49:26 UTC (rev 3215)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-10 12:50:52 UTC (rev 3216)
@@ -37,49 +37,14 @@
 class NavGraphEdgeObjectModel;
 class SceneGraph;
 class SceneContext;
-class LayerManagerColumns;
 
-class LayerManagerColumns : public Gtk::TreeModel::ColumnRecord
-{
-private:
-  static LayerManagerColumns* instance_;
-
-public:
-  static LayerManagerColumns& instance() {
-    if (instance_)
-      return *instance_;
-    else
-      return *(instance_ = new LayerManagerColumns());
-  }
-
-  Gtk::TreeModelColumn<Glib::RefPtr<Gdk::Pixbuf> > type_icon;
-  Gtk::TreeModelColumn<Glib::ustring>              name;
-  Gtk::TreeModelColumn<bool>                       visible;
-  Gtk::TreeModelColumn<bool>                       locked;
-  Gtk::TreeModelColumn<LayerHandle>                layer;
-
-private:
-  LayerManagerColumns()
-    : type_icon(),
-      name(),
-      visible(),
-      locked(),
-      layer()
-  {
-    add(type_icon); 
-    add(name); 
-    add(visible); 
-    add(locked);
-    add(layer);
-  }
-};
-
 class SectorModel
 {
 private:
   boost::scoped_ptr<NavigationGraph> nav_graph;
   boost::scoped_ptr<SceneGraph>      scene_graph;
   Glib::RefPtr<Gtk::ListStore>       layer_tree;
+  LayerHandle navgraph_layer;
   Color ambient_color;
   
 public:
@@ -104,6 +69,7 @@
   void add(const ObjectModelHandle& object, const Gtk::TreeModel::Path& path);
   void remove(const ObjectModelHandle& object);
   LayerHandle get_layer(const ObjectModelHandle& object) const;
+  LayerHandle get_navgraph_layer() const { return navgraph_layer; }
 
   void  set_ambient_color(const Color& color) { ambient_color = color; }
   Color get_ambient_color() const { return ambient_color; }
@@ -148,6 +114,7 @@
   void load_layer(const FileReader& filename, 
                   std::map<std::string, ObjectModelHandle>& id_table,
                   std::map<ObjectModelHandle, std::string>& parent_table); 
+  void register_callbacks();
 
 private:
   SectorModel(const SectorModel&);

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-10 12:49:26 UTC (rev 3215)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-10 12:50:52 UTC (rev 3216)
@@ -577,6 +577,7 @@
 {
   filename = filename_;
   m_document.reset(new Document(filename));
+  on_document_change();
 }
 
 /* EOF */



From grumbel at mail.berlios.de  Thu Sep 10 16:43:50 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 10 Sep 2009 16:43:50 +0200
Subject: [Windstille-commit] r3217 - trunk/windstille/src/editor
Message-ID: <200909101443.n8AEhoNY025220@sheep.berlios.de>

Author: grumbel
Date: 2009-09-10 16:43:49 +0200 (Thu, 10 Sep 2009)
New Revision: 3217

Modified:
   trunk/windstille/src/editor/navgraph_insert_tool.cpp
   trunk/windstille/src/editor/navgraph_insert_tool.hpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
Log:
Switched from NavigationGraph to NavigationGraphModel

Modified: trunk/windstille/src/editor/navgraph_insert_tool.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-10 12:50:52 UTC (rev 3216)
+++ trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-10 14:43:49 UTC (rev 3217)
@@ -41,11 +41,11 @@
 NavgraphInsertTool::mouse_down(GdkEventButton* event, WindstilleWidget& wst)
 {
   mouse_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
-  NavigationGraph& navgraph = wst.get_document().get_sector_model().get_nav_graph();
-  SectorModel& sector = wst.get_document().get_sector_model();
+  NavigationGraphModel& navgraph = wst.get_document().get_sector_model().get_nav_graph();
+  //SectorModel& sector = wst.get_document().get_sector_model();
 
-  NodeHandle node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
-  EdgeHandle edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
+  boost::shared_ptr<NavGraphNodeObjectModel> node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
+  boost::shared_ptr<NavGraphEdgeObjectModel> edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
 
   switch(mode)
   {
@@ -53,11 +53,9 @@
     {
       if (node)
       { // connect last node with existing node
-        wst.get_document().navgraph_edge_add(wst.get_current_layer(),
-                                             sector.find_navgraph_node(last_node),
-                                             sector.find_navgraph_node(node));
-        last_node = NodeHandle();
-        connection_node = NodeHandle();
+        wst.get_document().navgraph_edge_add(wst.get_current_layer(), last_node, node);
+        last_node = boost::shared_ptr<NavGraphNodeObjectModel>();
+        connection_node = boost::shared_ptr<NavGraphNodeObjectModel>();
       }
       else
       { // connect last node with newly created node
@@ -66,11 +64,11 @@
         
         wst.get_document().undo_group_begin();
         wst.get_document().object_add(wst.get_document().get_sector_model().get_navgraph_layer(), node_obj);
-        wst.get_document().navgraph_edge_add(wst.get_current_layer(), sector.find_navgraph_node(last_node), node_obj);
+        wst.get_document().navgraph_edge_add(wst.get_current_layer(), last_node, node_obj);
         wst.get_document().undo_group_end();
 
-        node = node_obj->get_node();       
-        last_node = NodeHandle();
+        node = node_obj;
+        last_node = boost::shared_ptr<NavGraphNodeObjectModel>();
       }
       mode = NO_MODE;
     }
@@ -91,7 +89,7 @@
       else
       {
         boost::shared_ptr<NavGraphNodeObjectModel> node_obj(new NavGraphNodeObjectModel(mouse_pos));//, sector));
-        last_node = node_obj->get_node();
+        last_node = node_obj;
         wst.get_document().object_add(wst.get_document().get_sector_model().get_navgraph_layer(), node_obj);
         mode = EDGE_MODE;
       }
@@ -105,12 +103,12 @@
 void
 NavgraphInsertTool::mouse_move(GdkEventMotion* event, WindstilleWidget& wst)
 {
-  NavigationGraph& navgraph = wst.get_document().get_sector_model().get_nav_graph();
+  NavigationGraphModel& navgraph = wst.get_document().get_sector_model().get_nav_graph();
   mouse_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
 
   {
-    NodeHandle new_mouse_over_node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
-    EdgeHandle new_mouse_over_edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
+    boost::shared_ptr<NavGraphNodeObjectModel> new_mouse_over_node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
+    boost::shared_ptr<NavGraphEdgeObjectModel> new_mouse_over_edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
 
     if (new_mouse_over_node != mouse_over_node ||
         new_mouse_over_edge != mouse_over_edge)
@@ -138,12 +136,12 @@
 NavgraphInsertTool::mouse_up(GdkEventButton* event, WindstilleWidget& wst)
 {
   mouse_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
-  //NavigationGraph& navgraph = *wst.get_sector_model().get_nav_graph();
+  //NavigationGraphModel& navgraph = *wst.get_sector_model().get_nav_graph();
 
   switch(mode)
     {
       case EDGE_MODE:
-        connection_node = NodeHandle();
+        connection_node = boost::shared_ptr<NavGraphNodeObjectModel>();
         wst.queue_draw();
         break;
 
@@ -155,29 +153,29 @@
 void
 NavgraphInsertTool::mouse_right_down(GdkEventButton* /*event*/, WindstilleWidget& wst)
 {
-  NavigationGraph& navgraph = wst.get_document().get_sector_model().get_nav_graph();
-  SectorModel& sector = wst.get_document().get_sector_model();
+  NavigationGraphModel& navgraph = wst.get_document().get_sector_model().get_nav_graph();
+  //SectorModel& sector = wst.get_document().get_sector_model();
 
-  NodeHandle node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
-  EdgeHandle edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
+  boost::shared_ptr<NavGraphNodeObjectModel> node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
+  boost::shared_ptr<NavGraphEdgeObjectModel> edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
 
   if (node)
     {
       //navgraph.remove_node(node);
-      wst.get_document().object_remove(sector.find_navgraph_node(node));
+      wst.get_document().object_remove(node);
 
-      mouse_over_edge = EdgeHandle();
-      mouse_over_node = NodeHandle();
+      mouse_over_edge = boost::shared_ptr<NavGraphEdgeObjectModel>();
+      mouse_over_node = boost::shared_ptr<NavGraphNodeObjectModel>();
 
       wst.queue_draw();
     }
   else if (edge)
     {
       //navgraph.remove_edge(edge);
-      wst.get_document().object_remove(sector.find_navgraph_edge(edge));
+      wst.get_document().object_remove(edge);
 
-      mouse_over_edge = EdgeHandle();
-      mouse_over_node = NodeHandle();
+      mouse_over_edge = boost::shared_ptr<NavGraphEdgeObjectModel>();
+      mouse_over_node = boost::shared_ptr<NavGraphNodeObjectModel>();
 
       wst.queue_draw();
     }
@@ -194,25 +192,25 @@
     {
       if (connection_node)
         {
-          sc.control().draw_line(last_node->get_pos(), connection_node->get_pos(), Color(1,1,1));
-          sc.control().draw_rect(Rectf(connection_node->get_pos() - Vector2f(16,16), Sizef(32,32)), Color(1.0f, 1.0f, 1.0f));
+          sc.control().draw_line(last_node->get_world_pos(), connection_node->get_world_pos(), Color(1,1,1));
+          sc.control().draw_rect(Rectf(connection_node->get_world_pos() - Vector2f(16,16), Sizef(32,32)), Color(1.0f, 1.0f, 1.0f));
         }
       else
         {
-          sc.control().draw_line(last_node->get_pos(), mouse_pos, Color(1,1,1));
+          sc.control().draw_line(last_node->get_world_pos(), mouse_pos, Color(1,1,1));
         }
 
-      sc.control().draw_rect(Rectf(last_node->get_pos() - Vector2f(16,16), Sizef(32,32)), Color(1.0f, 1.0f, 1.0f));
+      sc.control().draw_rect(Rectf(last_node->get_world_pos() - Vector2f(16,16), Sizef(32,32)), Color(1.0f, 1.0f, 1.0f));
     }
 
   if (mouse_over_node)
     {
-      sc.control().draw_rect(Rectf(mouse_over_node->get_pos() - Vector2f(16,16), Sizef(32,32)), Color(1.0f, 1.0f, 1.0f));      
+      sc.control().draw_rect(Rectf(mouse_over_node->get_world_pos() - Vector2f(16,16), Sizef(32,32)), Color(1.0f, 1.0f, 1.0f));      
     }
   else if (mouse_over_edge)
     {
-      sc.control().draw_line(mouse_over_edge->get_node1()->get_pos(), 
-                             mouse_over_edge->get_node2()->get_pos(), Color(1,1,1));
+      sc.control().draw_line(mouse_over_edge->get_lhs()->get_world_pos(), 
+                             mouse_over_edge->get_rhs()->get_world_pos(), Color(1,1,1));
     }
 }
   

Modified: trunk/windstille/src/editor/navgraph_insert_tool.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_insert_tool.hpp	2009-09-10 12:50:52 UTC (rev 3216)
+++ trunk/windstille/src/editor/navgraph_insert_tool.hpp	2009-09-10 14:43:49 UTC (rev 3217)
@@ -20,10 +20,14 @@
 #define HEADER_WINDSTILLE_EDITOR_NAVGRAPH_INSERT_TOOL_HPP
 
 #include <set>
+#include <boost/shared_ptr.hpp>
 
 #include "math/rect.hpp"
 #include "editor/tool.hpp"
 #include "navigation/navigation_graph.hpp"
+
+class NavGraphNodeObjectModel;
+class NavGraphEdgeObjectModel;
 
 class NavgraphInsertTool : public Tool
 {
@@ -35,11 +39,11 @@
     NO_MODE      // mode is determined by next click
   } mode;
 
-  NodeHandle last_node;
-  NodeHandle connection_node;
+  boost::shared_ptr<NavGraphNodeObjectModel> last_node;
+  boost::shared_ptr<NavGraphNodeObjectModel> connection_node;
 
-  NodeHandle mouse_over_node;
-  EdgeHandle mouse_over_edge;
+  boost::shared_ptr<NavGraphNodeObjectModel> mouse_over_node;
+  boost::shared_ptr<NavGraphEdgeObjectModel> mouse_over_edge;
 
 public:
   NavgraphInsertTool();

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-10 12:50:52 UTC (rev 3216)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-10 14:43:49 UTC (rev 3217)
@@ -31,8 +31,7 @@
 #include "editor/object_model_factory.hpp"
 #include "editor/sector_model.hpp"
 #include "editor/windstille_widget.hpp"
-#include "navigation/edge.hpp"
-#include "navigation/navigation_graph.hpp"
+#include "editor/navigation_graph_model.hpp"
 #include "navigation/node.hpp"
 #include "scenegraph/scene_graph.hpp"
 #include "util/file_reader.hpp"
@@ -41,7 +40,7 @@
 
 
 SectorModel::SectorModel(const std::string& filename)
-  : nav_graph(new NavigationGraph()),
+  : nav_graph(new NavigationGraphModel()),
     scene_graph(new SceneGraph()),
     layer_tree(Gtk::ListStore::create(LayerManagerColumns::instance())),
     navgraph_layer(new Layer(*this)),
@@ -52,7 +51,7 @@
 }
 
 SectorModel::SectorModel()
-  : nav_graph(new NavigationGraph()),
+  : nav_graph(new NavigationGraphModel),
     scene_graph(new SceneGraph()),
     layer_tree(Gtk::ListStore::create(LayerManagerColumns::instance())),
     navgraph_layer(new Layer(*this)),
@@ -439,9 +438,9 @@
       ambient_color = Color(0,0,0,1);
       reader.get("ambient-color", ambient_color);
 
-      FileReader navigation_section;
-      reader.get("navigation", navigation_section);
-      nav_graph->load(navigation_section);
+      //FileReader navigation_section;
+      //reader.get("navigation", navigation_section);
+      //nav_graph->load(navigation_section);
 
       FileReader layers_section;
       reader.get("layers", layers_section);
@@ -487,9 +486,9 @@
   writer.write("ambient-color", ambient_color);
   writer.write("init-script", "init.nut");
 
-  writer.start_section("navigation");
-  nav_graph->write(writer);
-  writer.end_section();
+  //writer.start_section("navigation");
+  //nav_graph->write(writer);
+  //writer.end_section();
 
   writer.start_section("layers");
   for(Gtk::ListStore::Children::iterator i = layer_tree->children().begin(); i != layer_tree->children().end(); ++i)
@@ -632,53 +631,6 @@
   rebuild_scene_graph();
 }
 
-boost::shared_ptr<NavGraphNodeObjectModel>
-SectorModel::find_navgraph_node(NodeHandle node) const
-{
-  // FIXME: Could solve this better by either a map/unsorted_set or by having
-  // a userdata ptr in NavGraph
-  for(Layer::const_iterator obj = navgraph_layer->begin(); obj != navgraph_layer->end(); ++obj)
-  {
-    boost::shared_ptr<NavGraphNodeObjectModel> test_node = boost::dynamic_pointer_cast<NavGraphNodeObjectModel>(*obj);
-    if (test_node)
-    {
-      if (test_node->get_node() == node)
-      {
-        return test_node;
-      }
-    }
-  }
-  
-  return boost::shared_ptr<NavGraphNodeObjectModel>();
-}
-
-boost::shared_ptr<NavGraphEdgeObjectModel>
-SectorModel::find_navgraph_edge(EdgeHandle edge) const
-{
-  // FIXME: Could solve this better by either a map/unsorted_set or by having
-  // a userdata ptr in NavGraph
-  const Layers& layers = get_layers();
-  for(Layers::const_reverse_iterator layer = layers.rbegin(); layer != layers.rend(); ++layer)
-  {
-    if (*layer)
-    {
-      for(Layer::const_iterator obj = (*layer)->begin(); obj != (*layer)->end(); ++obj)
-      {
-        boost::shared_ptr<NavGraphEdgeObjectModel> test_edge = boost::dynamic_pointer_cast<NavGraphEdgeObjectModel>(*obj);
-        if (test_edge)
-        {
-          if (test_edge->get_edge() == edge)
-          {
-            return test_edge;
-          }
-        }
-      }
-    } 
-  }
-  
-  return boost::shared_ptr<NavGraphEdgeObjectModel>(); 
-}
-
 void
 SectorModel::delete_navgraph_edges(NavGraphNodeObjectModel& node)
 {

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-10 12:50:52 UTC (rev 3216)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-10 14:43:49 UTC (rev 3217)
@@ -27,10 +27,10 @@
 
 #include "display/color.hpp"
 #include "editor/layer.hpp"
+#include "editor/navigation_graph_model.hpp"
 #include "editor/object_model.hpp"
 #include "editor/selection.hpp"
 #include "math/vector2f.hpp"
-#include "navigation/navigation_graph.hpp"
 
 class NavigationGraph;
 class NavGraphNodeObjectModel;
@@ -41,7 +41,7 @@
 class SectorModel
 {
 private:
-  boost::scoped_ptr<NavigationGraph> nav_graph;
+  boost::scoped_ptr<NavigationGraphModel> nav_graph;
   boost::scoped_ptr<SceneGraph>      scene_graph;
   Glib::RefPtr<Gtk::ListStore>       layer_tree;
   LayerHandle navgraph_layer;
@@ -98,11 +98,9 @@
 
   void write(FileWriter& writer) const;
 
-  NavigationGraph& get_nav_graph()   const { return *nav_graph; }
+  NavigationGraphModel& get_nav_graph()   const { return *nav_graph; }
   SceneGraph&      get_scene_graph() const { return *scene_graph; }
 
-  boost::shared_ptr<NavGraphNodeObjectModel> find_navgraph_node(NodeHandle node) const;
-  boost::shared_ptr<NavGraphEdgeObjectModel> find_navgraph_edge(EdgeHandle edge) const;
   void delete_navgraph_edges(NavGraphNodeObjectModel& node);
 
   void queue_draw();



From grumbel at mail.berlios.de  Thu Sep 10 16:48:12 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 10 Sep 2009 16:48:12 +0200
Subject: [Windstille-commit] r3218 - trunk/windstille/src/editor
Message-ID: <200909101448.n8AEmCBR025835@sheep.berlios.de>

Author: grumbel
Date: 2009-09-10 16:48:10 +0200 (Thu, 10 Sep 2009)
New Revision: 3218

Modified:
   trunk/windstille/src/editor/decal_object_model.cpp
   trunk/windstille/src/editor/decal_rotate_control_point.cpp
   trunk/windstille/src/editor/decal_scale_control_point.cpp
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/layer.cpp
   trunk/windstille/src/editor/layer_manager.cpp
   trunk/windstille/src/editor/layer_widget.cpp
   trunk/windstille/src/editor/minimap_widget.cpp
   trunk/windstille/src/editor/navgraph_edge_object_model.cpp
   trunk/windstille/src/editor/navgraph_insert_tool.cpp
   trunk/windstille/src/editor/object_model.cpp
   trunk/windstille/src/editor/object_model_factory.cpp
   trunk/windstille/src/editor/object_selector.cpp
   trunk/windstille/src/editor/property_dialog.cpp
   trunk/windstille/src/editor/scroll_tool.cpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/select_mask.hpp
   trunk/windstille/src/editor/select_tool.cpp
   trunk/windstille/src/editor/selection.cpp
   trunk/windstille/src/editor/selection.hpp
   trunk/windstille/src/editor/snap_data.hpp
   trunk/windstille/src/editor/undo_manager.cpp
   trunk/windstille/src/editor/windstille_widget.cpp
   trunk/windstille/src/editor/zoom_tool.cpp
Log:
Auto reindented everything with emacs

Modified: trunk/windstille/src/editor/decal_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/decal_object_model.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -215,20 +215,20 @@
 
   if (fabsf(p.x) < surface.get_width()/2 &&
       fabsf(p.y) < surface.get_height()/2)
-    {
-      if (hflip)
-        p.x = -p.x;
+  {
+    if (hflip)
+      p.x = -p.x;
 
-      if (vflip)
-        p.y = -p.y;
+    if (vflip)
+      p.y = -p.y;
 
-      return software_surface.is_at(static_cast<int>(p.x + surface.get_width()/2),
-                                    static_cast<int>(p.y + surface.get_height()/2));
-    }
+    return software_surface.is_at(static_cast<int>(p.x + surface.get_width()/2),
+				  static_cast<int>(p.y + surface.get_height()/2));
+  }
   else
-    {
-      return false;
-    }
+  {
+    return false;
+  }
 }
 
 void

Modified: trunk/windstille/src/editor/decal_rotate_control_point.cpp
===================================================================
--- trunk/windstille/src/editor/decal_rotate_control_point.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/decal_rotate_control_point.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -47,10 +47,10 @@
   float new_angle = orig_angle + current_angle - base_angle;
 
   if (event->state & GDK_CONTROL_MASK)
-    {
-      float steps = 16.0f;
-      new_angle = roundf((new_angle / (2.0f * math::pi)) * steps) / steps * 2.0f * math::pi;
-    }
+  {
+    float steps = 16.0f;
+    new_angle = roundf((new_angle / (2.0f * math::pi)) * steps) / steps * 2.0f * math::pi;
+  }
 
   object->set_angle(new_angle);
 }

Modified: trunk/windstille/src/editor/decal_scale_control_point.cpp
===================================================================
--- trunk/windstille/src/editor/decal_scale_control_point.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/decal_scale_control_point.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -48,16 +48,16 @@
   Vector2f new_scale = orig_scale;
 
   if (x_scale)
-    {
-      new_scale.x = current.x / start.x;
-      new_scale.x *= orig_scale.x;
-    }
+  {
+    new_scale.x = current.x / start.x;
+    new_scale.x *= orig_scale.x;
+  }
 
   if (y_scale)
-    {
-      new_scale.y = current.y / start.y;
-      new_scale.y *= orig_scale.y;
-    }
+  {
+    new_scale.y = current.y / start.y;
+    new_scale.y *= orig_scale.y;
+  }
 
   object->set_scale(new_scale);
 }

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/document.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -177,9 +177,9 @@
 Document::selection_raise()
 {
   for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
-    {
-      m_sector_model->raise(*i);
-    }
+  {
+    m_sector_model->raise(*i);
+  }
 
   m_sig_on_change();
 }
@@ -188,9 +188,9 @@
 Document::selection_lower()
 {
   for(Selection::reverse_iterator i = m_selection->rbegin(); i != m_selection->rend(); ++i)
-    {
-      m_sector_model->lower(*i);
-    }
+  {
+    m_sector_model->lower(*i);
+  }
 
   m_sig_on_change();
 }
@@ -199,9 +199,9 @@
 Document::selection_raise_to_top()
 {
   for(Selection::reverse_iterator i = m_selection->rbegin(); i != m_selection->rend(); ++i)
-    {
-      m_sector_model->raise_to_top(*i);
-    }
+  {
+    m_sector_model->raise_to_top(*i);
+  }
 
   m_sig_on_change();
 }
@@ -210,9 +210,9 @@
 Document::selection_lower_to_bottom()
 {
   for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
-    {
-      m_sector_model->lower_to_bottom(*i);
-    }
+  {
+    m_sector_model->lower_to_bottom(*i);
+  }
 
   m_sig_on_change();
 }
@@ -221,88 +221,88 @@
 Document::selection_vflip()
 {
   if (!m_selection->empty())
+  {
+    boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
+
+    if (m_selection->size() > 1)
     {
-      boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
-
-      if (m_selection->size() > 1)
-        {
-          const Vector2f& center = m_selection->get_bounding_box().get_center();
-          for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
-            {
-              Vector2f pos = (*i)->get_world_pos();
+      const Vector2f& center = m_selection->get_bounding_box().get_center();
+      for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+      {
+	Vector2f pos = (*i)->get_world_pos();
           
-              pos.y = center.y + (center.y - pos.y);
+	pos.y = center.y + (center.y - pos.y);
           
-              //(*i)->set_world_pos(pos);
-              group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_world_pos, *i, (*i)->get_world_pos()),
-                                                                  boost::bind(&ObjectModel::set_world_pos, *i, pos))));
-            }
-        }
+	//(*i)->set_world_pos(pos);
+	group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_world_pos, *i, (*i)->get_world_pos()),
+							    boost::bind(&ObjectModel::set_world_pos, *i, pos))));
+      }
+    }
 
-      for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
-        {
-          //(*i)->set_vflip(!(*i)->get_vflip());
-          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_vflip, *i,  (*i)->get_vflip()),
-                                                              boost::bind(&ObjectModel::set_vflip, *i, !(*i)->get_vflip()))));
-        }
+    for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+    {
+      //(*i)->set_vflip(!(*i)->get_vflip());
+      group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_vflip, *i,  (*i)->get_vflip()),
+							  boost::bind(&ObjectModel::set_vflip, *i, !(*i)->get_vflip()))));
+    }
 
-      execute(group_command);
-    }
+    execute(group_command);
+  }
 }
 
 void
 Document::selection_hflip()
 {
   if (!m_selection->empty())
+  {
+    boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
+
+    if (m_selection->size() > 1)
     {
-      boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
-
-      if (m_selection->size() > 1)
-        {
-          const Vector2f& center = m_selection->get_bounding_box().get_center();
-          for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
-            {
-              Vector2f pos = (*i)->get_world_pos();
+      const Vector2f& center = m_selection->get_bounding_box().get_center();
+      for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+      {
+	Vector2f pos = (*i)->get_world_pos();
           
-              pos.x = center.x + (center.x - pos.x);
+	pos.x = center.x + (center.x - pos.x);
           
-              //(*i)->set_world_pos(pos);
-              group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_world_pos, *i, (*i)->get_world_pos()),
-                                                                  boost::bind(&ObjectModel::set_world_pos, *i, pos))));
-            }
-        }
+	//(*i)->set_world_pos(pos);
+	group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_world_pos, *i, (*i)->get_world_pos()),
+							    boost::bind(&ObjectModel::set_world_pos, *i, pos))));
+      }
+    }
 
-      for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
-        {
-          //(*i)->set_hflip(!(*i)->get_hflip());
-          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_hflip, *i,  (*i)->get_hflip()),
-                                                              boost::bind(&ObjectModel::set_hflip, *i, !(*i)->get_hflip()))));
-        }
+    for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+    {
+      //(*i)->set_hflip(!(*i)->get_hflip());
+      group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_hflip, *i,  (*i)->get_hflip()),
+							  boost::bind(&ObjectModel::set_hflip, *i, !(*i)->get_hflip()))));
+    }
 
-      execute(group_command);
-    }
+    execute(group_command);
+  }
 }
 
 void
 Document::selection_connect_parent()
 {
   if (m_selection->size() >= 2)
-    {
-      boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
+  {
+    boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
 
-      ObjectModelHandle parent = *m_selection->begin();
+    ObjectModelHandle parent = *m_selection->begin();
 
-      Selection::iterator i = m_selection->begin();
-      ++i;
-      for(; i != m_selection->end(); ++i)
-        {
-          //(*i)->set_parent(parent);
-          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_parent, *i, (*i)->get_parent(), true),
-                                                              boost::bind(&ObjectModel::set_parent, *i, parent, true))));
-        }
+    Selection::iterator i = m_selection->begin();
+    ++i;
+    for(; i != m_selection->end(); ++i)
+    {
+      //(*i)->set_parent(parent);
+      group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_parent, *i, (*i)->get_parent(), true),
+							  boost::bind(&ObjectModel::set_parent, *i, parent, true))));
+    }
 
-      execute(group_command);
-    }
+    execute(group_command);
+  }
 }
 
 void
@@ -311,11 +311,11 @@
   boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
 
   for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
-    {
-      //(*i)->set_parent(ObjectModelHandle());
-      group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_parent, *i, (*i)->get_parent(), true),
-                                                          boost::bind(&ObjectModel::set_parent, *i, ObjectModelHandle(), true))));
-    }
+  {
+    //(*i)->set_parent(ObjectModelHandle());
+    group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_parent, *i, (*i)->get_parent(), true),
+							boost::bind(&ObjectModel::set_parent, *i, ObjectModelHandle(), true))));
+  }
 
   execute(group_command);
 }
@@ -328,45 +328,45 @@
 
   SelectionHandle new_selection = Selection::create();
   for(Selection::reverse_iterator i = m_selection->rbegin(); i != m_selection->rend(); ++i)
-    {
-      LayerHandle layer = m_sector_model->get_layer(*i);
-      ObjectModelHandle obj = (*i)->clone();
+  {
+    LayerHandle layer = m_sector_model->get_layer(*i);
+    ObjectModelHandle obj = (*i)->clone();
 
-      parent_map[*i] = obj;
+    parent_map[*i] = obj;
 
-      if (!layer)
-        {
-          EditorWindow::current()->print("Couldn't find parent layer while duplicating");
-        }
-      else
-        {
-          // Move clone a litte to make it more obvious that something happened
-          obj->set_rel_pos(obj->get_rel_pos() + Vector2f(32.0f, 32.0f));
-          new_selection->add(obj);
+    if (!layer)
+    {
+      EditorWindow::current()->print("Couldn't find parent layer while duplicating");
+    }
+    else
+    {
+      // Move clone a litte to make it more obvious that something happened
+      obj->set_rel_pos(obj->get_rel_pos() + Vector2f(32.0f, 32.0f));
+      new_selection->add(obj);
 
-          //layer->add(obj);
-          group_command->add(CommandHandle(new ObjectAddCommand(layer, obj)));
-        }
+      //layer->add(obj);
+      group_command->add(CommandHandle(new ObjectAddCommand(layer, obj)));
     }
+  }
 
   // Second pass to set the parents to the cloned objects
   for(Selection::iterator i = new_selection->begin(); i != new_selection->end(); ++i)
+  {
+    if ((*i)->get_parent())
     {
-      if ((*i)->get_parent())
-        {
-          std::map<ObjectModelHandle, ObjectModelHandle>::iterator it = parent_map.find((*i)->get_parent());
+      std::map<ObjectModelHandle, ObjectModelHandle>::iterator it = parent_map.find((*i)->get_parent());
           
-          if (it == parent_map.end())
-            {
-              // When the parent wasn't part of the selection, leave
-              // the parent untouched
-            }
-          else
-            {
-              (*i)->set_parent(it->second);
-            }
-        }
+      if (it == parent_map.end())
+      {
+	// When the parent wasn't part of the selection, leave
+	// the parent untouched
+      }
+      else
+      {
+	(*i)->set_parent(it->second);
+      }
     }
+  }
 
   execute(group_command);
   set_selection(new_selection);
@@ -378,16 +378,16 @@
   boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
 
   for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+  {
+    DecalObjectModel* decal = dynamic_cast<DecalObjectModel*>(i->get());
+
+    if (decal)
     {
-      DecalObjectModel* decal = dynamic_cast<DecalObjectModel*>(i->get());
-
-      if (decal)
-        {
-          //decal->set_angle(0.0f);
-          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&DecalObjectModel::set_angle, decal, decal->get_angle()),
-                                                              boost::bind(&DecalObjectModel::set_angle, decal, 0.0f))));
-        }
+      //decal->set_angle(0.0f);
+      group_command->add(CommandHandle(new FunctorCommand(boost::bind(&DecalObjectModel::set_angle, decal, decal->get_angle()),
+							  boost::bind(&DecalObjectModel::set_angle, decal, 0.0f))));
     }
+  }
 
   on_selection_change();
   execute(group_command);
@@ -404,19 +404,19 @@
 {
   boost::shared_ptr<GroupCommand> group_command(new GroupCommand());
 
- for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+  for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
+  {
+    DecalObjectModel* decal = dynamic_cast<DecalObjectModel*>(i->get());
+    if (decal)
     {
-      DecalObjectModel* decal = dynamic_cast<DecalObjectModel*>(i->get());
-      if (decal)
-        {
-          //decal->set_scale(Vector2f(1.0f, 1.0f));
-          group_command->add(CommandHandle(new FunctorCommand(boost::bind(&DecalObjectModel::set_scale, decal, decal->get_scale()),
-                                                              boost::bind(&DecalObjectModel::set_scale, decal, Vector2f(1.0f, 1.0f)))));
-        }
+      //decal->set_scale(Vector2f(1.0f, 1.0f));
+      group_command->add(CommandHandle(new FunctorCommand(boost::bind(&DecalObjectModel::set_scale, decal, decal->get_scale()),
+							  boost::bind(&DecalObjectModel::set_scale, decal, Vector2f(1.0f, 1.0f)))));
     }
+  }
 
- on_selection_change();
- execute(group_command);
+  on_selection_change();
+  execute(group_command);
 }
 
 void
@@ -424,9 +424,9 @@
 {
   boost::shared_ptr<GroupCommand> group_cmd(new GroupCommand());
   for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
-    {
-      group_cmd->add(CommandHandle(new ObjectRemoveCommand(*m_sector_model, *i)));
-    }
+  {
+    group_cmd->add(CommandHandle(new ObjectRemoveCommand(*m_sector_model, *i)));
+  }
   execute(group_cmd);
   m_selection->clear();
 }
@@ -445,9 +445,9 @@
   m_control_points.clear();
 
   if (!m_selection->is_moving())
-    {
-      m_selection->add_control_points(m_control_points);
-    }
+  {
+    m_selection->add_control_points(m_control_points);
+  }
 }
 
 ControlPointHandle
@@ -455,10 +455,10 @@
 {
   for(std::vector<ControlPointHandle>::const_iterator i = m_control_points.begin();  
       i != m_control_points.end(); ++i)
-    {
-      if ((*i)->get_bounding_box().is_inside(pos))
-        return *i;
-    }
+  {
+    if ((*i)->get_bounding_box().is_inside(pos))
+      return *i;
+  }
   return ControlPointHandle();
 }
 

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -460,21 +460,21 @@
 EditorWindow::load_file(const std::string& filename)
 {
   try 
-    {
-      on_new();
-      WindstilleWidget* wst = get_windstille_widget();
-      wst->load_file(filename);
-      wst->set_filename(filename);
-      notebook.set_tab_label_text(*notebook.get_nth_page(notebook.get_current_page()), Glib::path_get_basename(filename));
+  {
+    on_new();
+    WindstilleWidget* wst = get_windstille_widget();
+    wst->load_file(filename);
+    wst->set_filename(filename);
+    notebook.set_tab_label_text(*notebook.get_nth_page(notebook.get_current_page()), Glib::path_get_basename(filename));
 
-      print("Loaded: " + filename);
-    }
+    print("Loaded: " + filename);
+  }
   catch(std::exception& err)
-    {
-      std::ostringstream str;
-      str << "EditorWindow::load_file: " << err.what();
-      print(str.str());
-    }
+  {
+    std::ostringstream str;
+    str << "EditorWindow::load_file: " << err.what();
+    print(str.str());
+  }
 }
 
 void
@@ -489,44 +489,44 @@
   dialog.set_current_folder("data/sectors/");
 
   switch(dialog.run())
+  {
+    case(Gtk::RESPONSE_OK):
     {
-      case(Gtk::RESPONSE_OK):
-        {
-          //std::cout << "Select clicked." << std::endl;
-          //std::cout << "Folder selected: " << dialog.get_filename()
-          //          << std::endl;
+      //std::cout << "Select clicked." << std::endl;
+      //std::cout << "Folder selected: " << dialog.get_filename()
+      //          << std::endl;
           
-          add_recent_file(dialog.get_filename());
+      add_recent_file(dialog.get_filename());
 
-          load_file(dialog.get_filename());
-          break;
-        }
+      load_file(dialog.get_filename());
+      break;
+    }
 
-      case(Gtk::RESPONSE_CANCEL):
-        {
-          //std::cout << "Cancel clicked." << std::endl;
-          break;
-        }
+    case(Gtk::RESPONSE_CANCEL):
+    {
+      //std::cout << "Cancel clicked." << std::endl;
+      break;
     }
+  }
 }
 
 void
 EditorWindow::on_save()
 {
   if (WindstilleWidget* wst = get_windstille_widget())
+  {
+    if (wst->get_filename().empty())
     {
-      if (wst->get_filename().empty())
-        {
-          on_save_as();
-        }
-      else
-        {
-          std::ofstream out(wst->get_filename().c_str());
-          FileWriter writer(out);
-          wst->get_document().get_sector_model().write(writer);
-          print("Wrote: " + wst->get_filename());
-        }
+      on_save_as();
     }
+    else
+    {
+      std::ofstream out(wst->get_filename().c_str());
+      FileWriter writer(out);
+      wst->get_document().get_sector_model().write(writer);
+      print("Wrote: " + wst->get_filename());
+    }
+  }
 }
 
 void
@@ -534,54 +534,54 @@
 {
   int page = notebook.get_current_page();
   if (page == -1)
-    {
-      // do nothing;
-    }
+  {
+    // do nothing;
+  }
   else
-    {
-      Gtk::FileChooserDialog dialog("Save File",
-                                    Gtk::FILE_CHOOSER_ACTION_SAVE);
-      dialog.set_transient_for(*this);
-      dialog.set_do_overwrite_confirmation(true);
+  {
+    Gtk::FileChooserDialog dialog("Save File",
+				  Gtk::FILE_CHOOSER_ACTION_SAVE);
+    dialog.set_transient_for(*this);
+    dialog.set_do_overwrite_confirmation(true);
 
-      dialog.add_button(Gtk::Stock::CANCEL, Gtk::RESPONSE_CANCEL);
-      dialog.add_button(Gtk::Stock::SAVE,   Gtk::RESPONSE_OK);
+    dialog.add_button(Gtk::Stock::CANCEL, Gtk::RESPONSE_CANCEL);
+    dialog.add_button(Gtk::Stock::SAVE,   Gtk::RESPONSE_OK);
 
-      WindstilleWidget* wst = static_cast<WindstilleWidget*>(notebook.get_nth_page(page));
+    WindstilleWidget* wst = static_cast<WindstilleWidget*>(notebook.get_nth_page(page));
  
-      if (wst->get_filename().empty())
-        dialog.set_current_folder("data/sectors/");
-      else
-        dialog.set_current_folder(Glib::path_get_dirname(wst->get_filename()));
+    if (wst->get_filename().empty())
+      dialog.set_current_folder("data/sectors/");
+    else
+      dialog.set_current_folder(Glib::path_get_dirname(wst->get_filename()));
 
-      switch(dialog.run())
-        {
-          case(Gtk::RESPONSE_OK):
-            {
-              //std::cout << "Select clicked." << std::endl;
-              //std::cout << "Folder selected: " << dialog.get_filename()
-              //          << std::endl;
+    switch(dialog.run())
+    {
+      case(Gtk::RESPONSE_OK):
+      {
+	//std::cout << "Select clicked." << std::endl;
+	//std::cout << "Folder selected: " << dialog.get_filename()
+	//          << std::endl;
 
-              std::string filename = dialog.get_filename();
-              std::ofstream out(filename.c_str());
-              FileWriter writer(out);
+	std::string filename = dialog.get_filename();
+	std::ofstream out(filename.c_str());
+	FileWriter writer(out);
 
-              wst->get_document().get_sector_model().write(writer);
-              wst->set_filename(filename);
+	wst->get_document().get_sector_model().write(writer);
+	wst->set_filename(filename);
 
-              notebook.set_tab_label_text(*notebook.get_nth_page(page), Glib::path_get_basename(filename));
-              add_recent_file(filename);
-              print("Wrote: " + filename);
-              break;
-            }
+	notebook.set_tab_label_text(*notebook.get_nth_page(page), Glib::path_get_basename(filename));
+	add_recent_file(filename);
+	print("Wrote: " + filename);
+	break;
+      }
 
-          case(Gtk::RESPONSE_CANCEL):
-            {
-              //std::cout << "Cancel clicked." << std::endl;
-              break;
-            }
-        }
+      case(Gtk::RESPONSE_CANCEL):
+      {
+	//std::cout << "Cancel clicked." << std::endl;
+	break;
+      }
     }
+  }
 }
 
 void
@@ -589,42 +589,42 @@
 {
   int page = notebook.get_current_page();
   if (page == -1)
-    {
-      // do nothing;
-    }
+  {
+    // do nothing;
+  }
   else
+  {
+    if (WindstilleWidget* wst = static_cast<WindstilleWidget*>(notebook.get_nth_page(page)))
     {
-      if (WindstilleWidget* wst = static_cast<WindstilleWidget*>(notebook.get_nth_page(page)))
-        {
-          Gtk::FileChooserDialog dialog("Save Screenshot",
-                                        Gtk::FILE_CHOOSER_ACTION_SAVE);
-          dialog.set_transient_for(*this);
-          dialog.set_do_overwrite_confirmation(true);
+      Gtk::FileChooserDialog dialog("Save Screenshot",
+				    Gtk::FILE_CHOOSER_ACTION_SAVE);
+      dialog.set_transient_for(*this);
+      dialog.set_do_overwrite_confirmation(true);
 
-          dialog.add_button(Gtk::Stock::CANCEL, Gtk::RESPONSE_CANCEL);
-          dialog.add_button(Gtk::Stock::SAVE,   Gtk::RESPONSE_OK);
+      dialog.add_button(Gtk::Stock::CANCEL, Gtk::RESPONSE_CANCEL);
+      dialog.add_button(Gtk::Stock::SAVE,   Gtk::RESPONSE_OK);
 
  
-          dialog.set_current_folder("/tmp/");
+      dialog.set_current_folder("/tmp/");
 
-          switch(dialog.run())
-            {
-              case(Gtk::RESPONSE_OK):
-                {
-                  std::string filename = dialog.get_filename();
-                  std::cout << "unimplemented screenshot: " << filename << std::endl;
-                  wst->save_screenshot(filename);
-                  break;
-                }
+      switch(dialog.run())
+      {
+	case(Gtk::RESPONSE_OK):
+	{
+	  std::string filename = dialog.get_filename();
+	  std::cout << "unimplemented screenshot: " << filename << std::endl;
+	  wst->save_screenshot(filename);
+	  break;
+	}
 
-              case(Gtk::RESPONSE_CANCEL):
-                {
-                  //std::cout << "Cancel clicked." << std::endl;
-                  break;
-                }
-            }
-        }
+	case(Gtk::RESPONSE_CANCEL):
+	{
+	  //std::cout << "Cancel clicked." << std::endl;
+	  break;
+	}
+      }
     }
+  }
 }
 
 void
@@ -632,25 +632,25 @@
 {
   int page = notebook.get_current_page();
   if (page != -1)
-    {
-      notebook.remove_page(page);
+  {
+    notebook.remove_page(page);
 
-      if (!get_windstille_widget())
-        layer_manager.set_model(0);
-    }
+    if (!get_windstille_widget())
+      layer_manager.set_model(0);
+  }
 }
 
 void
 EditorWindow::show_minimap(bool v)
 {
   if (v)
-    {
-      minimap_widget.show();
-    }
+  {
+    minimap_widget.show();
+  }
   else
-    {
-      minimap_widget.hide();
-    }
+  {
+    minimap_widget.hide();
+  }
 }
 
 void
@@ -681,32 +681,32 @@
 EditorWindow::update_undo_state()
 {
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      action_group->get_action("Undo")->set_sensitive(wst->get_document().has_undo());
-      action_group->get_action("Redo")->set_sensitive(wst->get_document().has_redo());
-    }
+  {
+    action_group->get_action("Undo")->set_sensitive(wst->get_document().has_undo());
+    action_group->get_action("Redo")->set_sensitive(wst->get_document().has_redo());
+  }
 }
 
 void
 EditorWindow::on_undo()
 {
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      wst->get_document().undo();
-      update_undo_state();
-      queue_draw();
-    }
+  {
+    wst->get_document().undo();
+    update_undo_state();
+    queue_draw();
+  }
 }
 
 void
 EditorWindow::on_redo()
 {
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      wst->get_document().redo();
-      update_undo_state();
-      queue_draw();
-    }
+  {
+    wst->get_document().redo();
+    update_undo_state();
+    queue_draw();
+  }
 }
 
 void
@@ -714,62 +714,62 @@
 {
   //std::cout << "on_tool_select()" << action->get_active() << std::endl;
   if (action->get_active())
-    {
-      current_tool = tool;
-      if (WindstilleWidget* wst = get_windstille_widget())
-        wst->queue_draw();
-    }
+  {
+    current_tool = tool;
+    if (WindstilleWidget* wst = get_windstille_widget())
+      wst->queue_draw();
+  }
 }
 
 void
 EditorWindow::toggle_render_layer(Glib::RefPtr<Gtk::ToggleAction> action, unsigned int mask)
 {
   if (WindstilleWidget* wst = get_windstille_widget())
+  {
+    SceneContext& sc = *wst->get_sc();
+
+    if (action->get_active())
     {
-      SceneContext& sc = *wst->get_sc();
+      sc.set_render_mask(sc.get_render_mask() | mask);
+    }
+    else
+    {
+      sc.set_render_mask(sc.get_render_mask() & (~mask));
+    }
 
-      if (action->get_active())
-        {
-          sc.set_render_mask(sc.get_render_mask() | mask);
-        }
-      else
-        {
-          sc.set_render_mask(sc.get_render_mask() & (~mask));
-        }
-
-      //std::cout << "mask: " << sc.get_render_mask() << std::endl;
-      wst->queue_draw();
-    }
+    //std::cout << "mask: " << sc.get_render_mask() << std::endl;
+    wst->queue_draw();
+  }
 }
 
 void
 EditorWindow::toggle_draw_only_active_layer(Glib::RefPtr<Gtk::ToggleAction> action)
 {
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      wst->set_draw_only_active_layer(action->get_active());
-      wst->queue_draw();
-    }
+  {
+    wst->set_draw_only_active_layer(action->get_active());
+    wst->queue_draw();
+  }
 }
 
 void
 EditorWindow::toggle_background_layer(Glib::RefPtr<Gtk::ToggleAction> action)
 {
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      wst->set_draw_background_pattern(action->get_active());
-      wst->queue_draw();
-    }
+  {
+    wst->set_draw_background_pattern(action->get_active());
+    wst->queue_draw();
+  }
 }
 
 void
 EditorWindow::toggle_grid_layer(Glib::RefPtr<Gtk::ToggleAction> action)
 {
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      wst->enable_grid(action->get_active());
-      wst->queue_draw();
-    }
+  {
+    wst->enable_grid(action->get_active());
+    wst->queue_draw();
+  }
 }
 
 Tool*
@@ -783,13 +783,13 @@
 {
   int page = notebook.get_current_page();
   if (page == -1)
-    {
-      return 0;
-    }
+  {
+    return 0;
+  }
   else
-    {
-      return static_cast<WindstilleWidget*>(notebook.get_nth_page(page));
-    }
+  {
+    return static_cast<WindstilleWidget*>(notebook.get_nth_page(page));
+  }
 }
 
 void
@@ -798,25 +798,25 @@
   //std::cout << "on_switch_page(" << page << ", " << page_num << ")" << std::endl;
 
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      layer_manager.set_model(&wst->get_document().get_sector_model());
-      layer_widget->update(wst->get_select_mask());
+  {
+    layer_manager.set_model(&wst->get_document().get_sector_model());
+    layer_widget->update(wst->get_select_mask());
 
-      toggle_color_layer->set_active(wst->get_sc()->get_render_mask() & SceneContext::COLORMAP);
-      toggle_light_layer->set_active(wst->get_sc()->get_render_mask() & SceneContext::LIGHTMAP);
-      toggle_highlight_layer->set_active(wst->get_sc()->get_render_mask() & SceneContext::HIGHLIGHTMAP);
-      toggle_control_layer->set_active(wst->get_sc()->get_render_mask() & SceneContext::CONTROLMAP);
+    toggle_color_layer->set_active(wst->get_sc()->get_render_mask() & SceneContext::COLORMAP);
+    toggle_light_layer->set_active(wst->get_sc()->get_render_mask() & SceneContext::LIGHTMAP);
+    toggle_highlight_layer->set_active(wst->get_sc()->get_render_mask() & SceneContext::HIGHLIGHTMAP);
+    toggle_control_layer->set_active(wst->get_sc()->get_render_mask() & SceneContext::CONTROLMAP);
 
-      background_layer->set_active(wst->get_draw_background_pattern());
-      visible_layer->set_active(wst->get_draw_only_active_layer());
-      grid_layer->set_active(wst->get_enable_grid());
+    background_layer->set_active(wst->get_draw_background_pattern());
+    visible_layer->set_active(wst->get_draw_only_active_layer());
+    grid_layer->set_active(wst->get_enable_grid());
 
-      update_undo_state();
-    }
+    update_undo_state();
+  }
   else
-    {
-      layer_manager.set_model(0);
-    }
+  {
+    layer_manager.set_model(0);
+  }
 }
 
 void
@@ -824,18 +824,18 @@
 {
   WindstilleWidget* wst = get_windstille_widget();
   if (wst)
-    {
-      (wst->get_document().*func)();
-    }
+  {
+    (wst->get_document().*func)();
+  }
 }
 
 bool
 EditorWindow::on_timeout()
 {
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      wst->update(0.050f);
-    }
+  {
+    wst->update(0.050f);
+  }
   return true;
 }
 
@@ -845,96 +845,96 @@
   //std::cout << "EditorWindow::on_layer_toggle(" << layer << ", " << status << ")" << std::endl;
 
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      wst->get_select_mask().set(layer, status_);
-      wst->queue_draw();
-    }
+  {
+    wst->get_select_mask().set(layer, status_);
+    wst->queue_draw();
+  }
 }
 
 void
 EditorWindow::on_play()
 {
   if (play_action->get_active())
-    {
-      //std::cout << "Play" << std::endl;
-      timeout_connection = Glib::signal_timeout().connect(sigc::mem_fun(*this, &EditorWindow::on_timeout),
-                                                          50,
-                                                          Glib::PRIORITY_DEFAULT);
-    }
+  {
+    //std::cout << "Play" << std::endl;
+    timeout_connection = Glib::signal_timeout().connect(sigc::mem_fun(*this, &EditorWindow::on_timeout),
+							50,
+							Glib::PRIORITY_DEFAULT);
+  }
   else
-    {
-      //std::cout << "Stop" << std::endl;
-      timeout_connection.disconnect();
-    }
+  {
+    //std::cout << "Stop" << std::endl;
+    timeout_connection.disconnect();
+  }
 }
 
 void
 EditorWindow::on_cut()
 {
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      clipboard = wst->get_document().get_selection()->clone();
-      wst->get_document().selection_delete();
-      queue_draw();
-    }
+  {
+    clipboard = wst->get_document().get_selection()->clone();
+    wst->get_document().selection_delete();
+    queue_draw();
+  }
 }
 
 void
 EditorWindow::on_copy()
 {
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      clipboard = wst->get_document().get_selection()->clone();
-    }
+  {
+    clipboard = wst->get_document().get_selection()->clone();
+  }
 }
 
 void
 EditorWindow::on_delete_layer()
 {
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      wst->get_document().layer_remove(wst->get_current_layer_path());
-      queue_draw();
-    }
+  {
+    wst->get_document().layer_remove(wst->get_current_layer_path());
+    queue_draw();
+  }
 }
 
 void
 EditorWindow::on_reverse_layers()
 {
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      wst->get_document().get_sector_model().reverse_layers();
-    }
+  {
+    wst->get_document().get_sector_model().reverse_layers();
+  }
 }
 
 void
 EditorWindow::on_new_layer()
 {
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      wst->get_document().layer_add(wst->get_current_layer_path());
-      layer_manager.get_treeview().expand_all();
-    }
+  {
+    wst->get_document().layer_add(wst->get_current_layer_path());
+    layer_manager.get_treeview().expand_all();
+  }
 }
 
 void
 EditorWindow::on_paste()
 {
   if (clipboard.get())
+  {
+    if (WindstilleWidget* wst = get_windstille_widget())
     {
-      if (WindstilleWidget* wst = get_windstille_widget())
-        {
-          LayerHandle layer = wst->get_current_layer();
-          for(Selection::reverse_iterator i = clipboard->rbegin(); i != clipboard->rend(); ++i)
-            {
-              layer->add(*i);
-            }
+      LayerHandle layer = wst->get_current_layer();
+      for(Selection::reverse_iterator i = clipboard->rbegin(); i != clipboard->rend(); ++i)
+      {
+	layer->add(*i);
+      }
 
-          wst->get_document().set_selection(clipboard);
-          clipboard = clipboard->clone();
-          queue_draw();
-        }
+      wst->get_document().set_selection(clipboard);
+      clipboard = clipboard->clone();
+      queue_draw();
     }
+  }
 }
 
 void
@@ -942,32 +942,32 @@
 {
   // Select all on current layer
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      LayerHandle layer = wst->get_current_layer();
-      SelectionHandle selection = Selection::create();
-      selection->add(layer->begin(), layer->end());
-      wst->get_document().set_selection(selection);
-    }
+  {
+    LayerHandle layer = wst->get_current_layer();
+    SelectionHandle selection = Selection::create();
+    selection->add(layer->begin(), layer->end());
+    wst->get_document().set_selection(selection);
+  }
 }
 
 void
 EditorWindow::on_show_all(bool v)
 {
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      wst->get_document().get_sector_model().set_all_visible(v);
-      wst->queue_draw();
-    }
+  {
+    wst->get_document().get_sector_model().set_all_visible(v);
+    wst->queue_draw();
+  }
 }
 
 void
 EditorWindow::on_lock_all(bool v)
 {
   if (WindstilleWidget* wst = get_windstille_widget())
-    {
-      wst->get_document().get_sector_model().set_all_locked(v);
-      wst->queue_draw();
-    }
+  {
+    wst->get_document().get_sector_model().set_all_locked(v);
+    wst->queue_draw();
+  }
 }
 
 void

Modified: trunk/windstille/src/editor/layer.cpp
===================================================================
--- trunk/windstille/src/editor/layer.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/layer.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -66,10 +66,10 @@
 Layer::draw(SceneContext& sc, const SelectMask& select_mask)
 {
   for(Objects::iterator i = objects.begin(); i != objects.end(); ++i)
-    {
-      if (select_mask.match((*i)->get_select_mask()))
-        (*i)->draw(sc);
-    }
+  {
+    if (select_mask.match((*i)->get_select_mask()))
+      (*i)->draw(sc);
+  }
 }
 
 void
@@ -84,38 +84,38 @@
 Layer::update(float delta)
 {
   for(Objects::iterator i = objects.begin(); i != objects.end(); ++i)
-    {
-      (*i)->update(delta);
-    }
+  {
+    (*i)->update(delta);
+  }
 }
 
 ObjectModelHandle
 Layer::get_object_at(const Vector2f& pos, const SelectMask& select_mask) const
 {
   for(Objects::const_reverse_iterator i = objects.rbegin(); i != objects.rend(); ++i)
+  {
+    if (select_mask.match((*i)->get_select_mask()) &&
+	(*i)->is_at(pos))
     {
-      if (select_mask.match((*i)->get_select_mask()) &&
-          (*i)->is_at(pos))
-        {
-          return *i;
-        }
+      return *i;
     }
+  }
   return ObjectModelHandle();
 }
 
 SelectionHandle
 Layer::get_selection(const Rectf& rect, const SelectMask& select_mask) const
 {
- SelectionHandle selection = Selection::create();
+  SelectionHandle selection = Selection::create();
 
   for(Objects::const_reverse_iterator i = objects.rbegin(); i != objects.rend(); ++i)
+  {
+    if (select_mask.match((*i)->get_select_mask()) &&
+	rect.contains((*i)->get_bounding_box()))
     {
-      if (select_mask.match((*i)->get_select_mask()) &&
-          rect.contains((*i)->get_bounding_box()))
-        {
-          selection->add(*i);
-        }
+      selection->add(*i);
     }
+  }
 
   return selection;
 }
@@ -159,16 +159,16 @@
   j = std::find_if(j, objects.end(), OverlapsWith(object->get_bounding_box()));
 
   if (j == objects.end())
-    {
-      // object overlaps with no other object, no point in raising it
-    }
+  {
+    // object overlaps with no other object, no point in raising it
+  }
   else
-    {
-      objects.erase(i);
-      objects.insert(++j, object);
+  {
+    objects.erase(i);
+    objects.insert(++j, object);
       
-      m_sector.rebuild_scene_graph();
-    }
+    m_sector.rebuild_scene_graph();
+  }
 }
 
 void
@@ -182,19 +182,19 @@
   j = std::find_if(j, objects.rend(), OverlapsWith(object->get_bounding_box()));
 
   if (j == objects.rend())
-    {
-      // object overlaps with no other object, no point in lowering it
-    }
+  {
+    // object overlaps with no other object, no point in lowering it
+  }
   else
-    {
-      // the base() of base in one further then where the reverse
-      // iterator was, so we have to move back to get the same
-      // position
-      objects.erase(--(i.base()));
-      objects.insert(--(j.base()), object);
+  {
+    // the base() of base in one further then where the reverse
+    // iterator was, so we have to move back to get the same
+    // position
+    objects.erase(--(i.base()));
+    objects.insert(--(j.base()), object);
 
-      m_sector.rebuild_scene_graph();
-    }
+    m_sector.rebuild_scene_graph();
+  }
 }
 
 SnapData
@@ -206,15 +206,15 @@
 
   // Find the smallest snap offset
   for(Objects::const_reverse_iterator i = objects.rbegin(); i != objects.rend(); ++i)
+  {
+    // object is not in the list of objects to ignore
+    if ((*i)->is_snappable() &&
+	ignore_objects.find(*i) == ignore_objects.end())
     {
-      // object is not in the list of objects to ignore
-      if ((*i)->is_snappable() &&
-          ignore_objects.find(*i) == ignore_objects.end())
-        {
-          SnapData snap = (*i)->snap_object(rect);
-          best_snap.merge(snap);
-        }
+      SnapData snap = (*i)->snap_object(rect);
+      best_snap.merge(snap);
     }
+  }
 
   return best_snap;
 }
@@ -223,9 +223,9 @@
 Layer::write(FileWriter& writer) const
 {
   for(Objects::const_iterator i = objects.begin(); i != objects.end(); ++i)
-    {
-      (*i)->write(writer);
-    }
+  {
+    (*i)->write(writer);
+  }
 }
 
 /* EOF */

Modified: trunk/windstille/src/editor/layer_manager.cpp
===================================================================
--- trunk/windstille/src/editor/layer_manager.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/layer_manager.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -65,7 +65,7 @@
   auto_lock = Gtk::ToggleAction::create_with_icon_name("AutoLockLayer", "auto_lock", "Auto Lock All", "All layers except the current ones are treated as locked");
   action_group->add(auto_lock,
                     sigc::bind(sigc::mem_fun(*this, &LayerManager::on_auto_lock), auto_lock));
-                    //sigc::bind(sigc::mem_fun(editor, &EditorWindow::on_auto_lock), auto_lock));
+  //sigc::bind(sigc::mem_fun(editor, &EditorWindow::on_auto_lock), auto_lock));
 
   ui_manager->insert_action_group(action_group);
 
@@ -108,51 +108,51 @@
 LayerManager::set_model(SectorModel* model)
 {
   if (model)
-    {
-      treeview.set_model(model->get_layer_tree());
+  {
+    treeview.set_model(model->get_layer_tree());
 
-      // Recreate all the columns, since if we don't do that, we lose
-      // editability for some reason
-      treeview.remove_all_columns();
-      treeview.append_column("Type", LayerManagerColumns::instance().type_icon);
-      treeview.append_column_editable("Name", LayerManagerColumns::instance().name);
-      treeview.append_column_editable("Visible", LayerManagerColumns::instance().visible);
-      treeview.append_column_editable("Locked", LayerManagerColumns::instance().locked);
-
-      treeview.expand_all();
-      treeview.set_cursor(Gtk::TreeModel::Path("0"));
-    }
+    // Recreate all the columns, since if we don't do that, we lose
+    // editability for some reason
+    treeview.remove_all_columns();
+    treeview.append_column("Type", LayerManagerColumns::instance().type_icon);
+    treeview.append_column_editable("Name", LayerManagerColumns::instance().name);
+    treeview.append_column_editable("Visible", LayerManagerColumns::instance().visible);
+    treeview.append_column_editable("Locked", LayerManagerColumns::instance().locked);
+    
+    treeview.expand_all();
+    treeview.set_cursor(Gtk::TreeModel::Path("0"));
+  }
   else
-    {
-      treeview.set_model(Glib::RefPtr<Gtk::ListStore>());
-    }
+  {
+    treeview.set_model(Glib::RefPtr<Gtk::ListStore>());
+  }
 }
 
 void
 LayerManager::on_cursor_changed()
 {
   if (auto_lock->get_active())
+  {
+    Gtk::TreeModel::Path path_;
+    Gtk::TreeViewColumn* focus_column;
+    treeview.get_cursor(path_, focus_column);
+      
+    if (!path_.gobj())
     {
-      Gtk::TreeModel::Path path_;
-      Gtk::TreeViewColumn* focus_column;
-      treeview.get_cursor(path_, focus_column);
-      
-      if (!path_.gobj())
-        {
-          std::cout << "LayerManager::on_cursor_changed(): Error: Couldn't get path" << std::endl;
-        }
-      else
-        {
-          //std::cout << "on_cursor_changed: " << path.to_string() << std::endl;
-          Gtk::TreeModel::iterator it = treeview.get_model()->get_iter(path_);
-          if (it)
-            {
-              EditorWindow::current()->on_lock_all(true);
-              (*it)[LayerManagerColumns::instance().locked] = false;
-              ((LayerHandle)(*it)[LayerManagerColumns::instance().layer])->sync(*it);
-            }
-        }
+      std::cout << "LayerManager::on_cursor_changed(): Error: Couldn't get path" << std::endl;
     }
+    else
+    {
+      //std::cout << "on_cursor_changed: " << path.to_string() << std::endl;
+      Gtk::TreeModel::iterator it = treeview.get_model()->get_iter(path_);
+      if (it)
+      {
+	EditorWindow::current()->on_lock_all(true);
+	(*it)[LayerManagerColumns::instance().locked] = false;
+	((LayerHandle)(*it)[LayerManagerColumns::instance().layer])->sync(*it);
+      }
+    }
+  }
 }
 
 void

Modified: trunk/windstille/src/editor/layer_widget.cpp
===================================================================
--- trunk/windstille/src/editor/layer_widget.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/layer_widget.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -31,29 +31,29 @@
   int layer_number = 0;
   for(int y = 0; y < 2; ++y)
     for(int x = 0; x < 9; ++x)
+    {
+      if ((x+1) % 5)
       {
-        if ((x+1) % 5)
-          {
-            Gtk::ToggleButton* button = Gtk::manage(new Gtk::ToggleButton());
-            button->set_size_request(16, 16);
-            table.attach(*button, x, x+1, y, y+1);
+	Gtk::ToggleButton* button = Gtk::manage(new Gtk::ToggleButton());
+	button->set_size_request(16, 16);
+	table.attach(*button, x, x+1, y, y+1);
 
-            button->signal_toggled().connect(sigc::bind(sigc::mem_fun(*this, &LayerWidget::on_layer_toggle), 
-                                                        button, layer_number));
-            buttons.push_back(button);
-            layer_number += 1;
-          }
-        else
-          {
-            if (y == 0)
-              {
-                Gtk::VSeparator* separator = Gtk::manage(new Gtk::VSeparator());
-                //Gtk::Widget* separator = Gtk::manage(new Gtk::Widget());
-                separator->set_size_request(12, -1);
-                table.attach(*separator, x, x+1, 0, 2);
-              }
-          }
+	button->signal_toggled().connect(sigc::bind(sigc::mem_fun(*this, &LayerWidget::on_layer_toggle), 
+						    button, layer_number));
+	buttons.push_back(button);
+	layer_number += 1;
       }
+      else
+      {
+	if (y == 0)
+	{
+	  Gtk::VSeparator* separator = Gtk::manage(new Gtk::VSeparator());
+	  //Gtk::Widget* separator = Gtk::manage(new Gtk::Widget());
+	  separator->set_size_request(12, -1);
+	  table.attach(*separator, x, x+1, 0, 2);
+	}
+      }
+    }
 
   add(table);
 }
@@ -72,9 +72,9 @@
 LayerWidget::update(const SelectMask& layers)
 {
   for(int i = 0; i < layers.size(); ++i)
-    {
-      buttons[i]->set_active(layers.get(i));
-    }
+  {
+    buttons[i]->set_active(layers.get(i));
+  }
 }
 
 SelectMask
@@ -82,9 +82,9 @@
 {
   SelectMask select_mask;
   for(int i = 0; i < select_mask.size(); ++i)
-    {
-      select_mask.set(i, buttons[i]->get_active());
-    }
+  {
+    select_mask.set(i, buttons[i]->get_active());
+  }
   return select_mask;
 }
 

Modified: trunk/windstille/src/editor/minimap_widget.cpp
===================================================================
--- trunk/windstille/src/editor/minimap_widget.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/minimap_widget.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -54,17 +54,17 @@
   Glib::RefPtr<Gdk::GL::Window> glwindow = get_gl_window();
 
   if (!glwindow->gl_begin(get_gl_context()))
-    {
-      return false;
-    }
+  {
+    return false;
+  }
   else
-    {
-      //glClear(GL_COLOR_BUFFER_BIT);
-      //glwindow->swap_buffers();
-      glwindow->gl_end();
+  {
+    //glClear(GL_COLOR_BUFFER_BIT);
+    //glwindow->swap_buffers();
+    glwindow->gl_end();
 
-      return true;
-    }
+    return true;
+  }
 }
 
 /* EOF */

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -25,7 +25,7 @@
 
 NavGraphEdgeObjectModel::NavGraphEdgeObjectModel(boost::shared_ptr<NavGraphNodeObjectModel> lhs,
                                                  boost::shared_ptr<NavGraphNodeObjectModel> rhs)
-                                                 //SectorModel& sector)
+  //SectorModel& sector)
   : ObjectModel("NavGraphEdgeObjectModel", Vector2f()),
     m_lhs(lhs),
     m_rhs(rhs),
@@ -44,14 +44,14 @@
 {
   if (m_drawable)
   {
-      m_drawable->clear();
-      m_drawable->set_mode(GL_LINES);
+    m_drawable->clear();
+    m_drawable->set_mode(GL_LINES);
 
-      m_drawable->color(Color(0.0f, 1.0f, 1.0f));
-      m_drawable->vertex(m_lhs->get_world_pos());
+    m_drawable->color(Color(0.0f, 1.0f, 1.0f));
+    m_drawable->vertex(m_lhs->get_world_pos());
 
-      m_drawable->color(Color(0.0f, 1.0f, 1.0f));
-      m_drawable->vertex(m_rhs->get_world_pos());
+    m_drawable->color(Color(0.0f, 1.0f, 1.0f));
+    m_drawable->vertex(m_rhs->get_world_pos());
   }
 }
 

Modified: trunk/windstille/src/editor/navgraph_insert_tool.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -112,24 +112,24 @@
 
     if (new_mouse_over_node != mouse_over_node ||
         new_mouse_over_edge != mouse_over_edge)
-      {
-        mouse_over_node = new_mouse_over_node; 
-        mouse_over_edge = new_mouse_over_edge; 
+    {
+      mouse_over_node = new_mouse_over_node; 
+      mouse_over_edge = new_mouse_over_edge; 
 
-        wst.queue_draw();
-      }
+      wst.queue_draw();
+    }
   }
 
   switch(mode)
-    {
-      case EDGE_MODE:
-        connection_node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
-        wst.queue_draw();
-        break;
+  {
+    case EDGE_MODE:
+      connection_node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
+      wst.queue_draw();
+      break;
 
-      case NO_MODE:
-        break;
-    }
+    case NO_MODE:
+      break;
+  }
 }
 
 void
@@ -139,15 +139,15 @@
   //NavigationGraphModel& navgraph = *wst.get_sector_model().get_nav_graph();
 
   switch(mode)
-    {
-      case EDGE_MODE:
-        connection_node = boost::shared_ptr<NavGraphNodeObjectModel>();
-        wst.queue_draw();
-        break;
+  {
+    case EDGE_MODE:
+      connection_node = boost::shared_ptr<NavGraphNodeObjectModel>();
+      wst.queue_draw();
+      break;
 
-      case NO_MODE:
-        break;
-    }
+    case NO_MODE:
+      break;
+  }
 }
 
 void
@@ -160,58 +160,58 @@
   boost::shared_ptr<NavGraphEdgeObjectModel> edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
 
   if (node)
-    {
-      //navgraph.remove_node(node);
-      wst.get_document().object_remove(node);
+  {
+    //navgraph.remove_node(node);
+    wst.get_document().object_remove(node);
 
-      mouse_over_edge = boost::shared_ptr<NavGraphEdgeObjectModel>();
-      mouse_over_node = boost::shared_ptr<NavGraphNodeObjectModel>();
+    mouse_over_edge = boost::shared_ptr<NavGraphEdgeObjectModel>();
+    mouse_over_node = boost::shared_ptr<NavGraphNodeObjectModel>();
 
-      wst.queue_draw();
-    }
+    wst.queue_draw();
+  }
   else if (edge)
-    {
-      //navgraph.remove_edge(edge);
-      wst.get_document().object_remove(edge);
+  {
+    //navgraph.remove_edge(edge);
+    wst.get_document().object_remove(edge);
 
-      mouse_over_edge = boost::shared_ptr<NavGraphEdgeObjectModel>();
-      mouse_over_node = boost::shared_ptr<NavGraphNodeObjectModel>();
+    mouse_over_edge = boost::shared_ptr<NavGraphEdgeObjectModel>();
+    mouse_over_node = boost::shared_ptr<NavGraphNodeObjectModel>();
 
-      wst.queue_draw();
-    }
+    wst.queue_draw();
+  }
   else
-    {
+  {
       
-    }
+  }
 }
   
 void
 NavgraphInsertTool::draw(SceneContext& sc)
 {
   if (last_node)
+  {
+    if (connection_node)
     {
-      if (connection_node)
-        {
-          sc.control().draw_line(last_node->get_world_pos(), connection_node->get_world_pos(), Color(1,1,1));
-          sc.control().draw_rect(Rectf(connection_node->get_world_pos() - Vector2f(16,16), Sizef(32,32)), Color(1.0f, 1.0f, 1.0f));
-        }
-      else
-        {
-          sc.control().draw_line(last_node->get_world_pos(), mouse_pos, Color(1,1,1));
-        }
-
-      sc.control().draw_rect(Rectf(last_node->get_world_pos() - Vector2f(16,16), Sizef(32,32)), Color(1.0f, 1.0f, 1.0f));
+      sc.control().draw_line(last_node->get_world_pos(), connection_node->get_world_pos(), Color(1,1,1));
+      sc.control().draw_rect(Rectf(connection_node->get_world_pos() - Vector2f(16,16), Sizef(32,32)), Color(1.0f, 1.0f, 1.0f));
     }
+    else
+    {
+      sc.control().draw_line(last_node->get_world_pos(), mouse_pos, Color(1,1,1));
+    }
 
+    sc.control().draw_rect(Rectf(last_node->get_world_pos() - Vector2f(16,16), Sizef(32,32)), Color(1.0f, 1.0f, 1.0f));
+  }
+
   if (mouse_over_node)
-    {
-      sc.control().draw_rect(Rectf(mouse_over_node->get_world_pos() - Vector2f(16,16), Sizef(32,32)), Color(1.0f, 1.0f, 1.0f));      
-    }
+  {
+    sc.control().draw_rect(Rectf(mouse_over_node->get_world_pos() - Vector2f(16,16), Sizef(32,32)), Color(1.0f, 1.0f, 1.0f));      
+  }
   else if (mouse_over_edge)
-    {
-      sc.control().draw_line(mouse_over_edge->get_lhs()->get_world_pos(), 
-                             mouse_over_edge->get_rhs()->get_world_pos(), Color(1,1,1));
-    }
+  {
+    sc.control().draw_line(mouse_over_edge->get_lhs()->get_world_pos(), 
+			   mouse_over_edge->get_rhs()->get_world_pos(), Color(1,1,1));
+  }
 }
   
 /* EOF */

Modified: trunk/windstille/src/editor/object_model.cpp
===================================================================
--- trunk/windstille/src/editor/object_model.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/object_model.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -84,31 +84,31 @@
   { // Remove the old parent
     ObjectModelHandle parent = parent_ptr.lock();
     if (parent)
-      { 
-        rel_pos += parent->get_world_pos();
-        parent_ptr = ObjectModelPtr();
-      }
+    { 
+      rel_pos += parent->get_world_pos();
+      parent_ptr = ObjectModelPtr();
+    }
   }
 
   // Check that we don't create a loop to 'this' by parenting
   ObjectModelHandle pptr = parent_;
   while(pptr.get())
+  {
+    if (pptr.get() == this)
     {
-      if (pptr.get() == this)
-        {
-          EditorWindow::current()->print("Error: Trying to create parent loop");
+      EditorWindow::current()->print("Error: Trying to create parent loop");
 
-          parent_ptr = ObjectModelPtr();
-          return;
-        }
-      pptr = pptr->get_parent();
+      parent_ptr = ObjectModelPtr();
+      return;
     }
+    pptr = pptr->get_parent();
+  }
 
   // Set new parent
   if (parent_.get() && recalc_pos)
-    {
-      rel_pos -= parent_->get_world_pos();
-    }
+  {
+    rel_pos -= parent_->get_world_pos();
+  }
 
   parent_ptr = parent_;
 }
@@ -118,13 +118,13 @@
 {
   ObjectModelHandle parent = parent_ptr.lock();
   if (parent.get())
-    {
-      return rel_pos + parent->get_world_pos();
-    }
+  {
+    return rel_pos + parent->get_world_pos();
+  }
   else
-    {
-      return rel_pos;
-    }
+  {
+    return rel_pos;
+  }
 }
 
 void
@@ -159,9 +159,9 @@
   Vector2f wo_pos = get_world_pos();
 
   if (ObjectModelHandle parent = parent_ptr.lock())
-    {
-      sc.control().draw_line(wo_pos, parent->get_world_pos(), Color(0,0,1, 0.5f));
-    }
+  {
+    sc.control().draw_line(wo_pos, parent->get_world_pos(), Color(0,0,1, 0.5f));
+  }
 
   //sc.control().fill_rect(Rectf(wo_pos - Vector2f(8, 8), Sizef(16, 16)), Color(1,0,0));
 }
@@ -205,81 +205,81 @@
   float y_dist = std::min(top_dist, bottom_dist);
 
   if (x_dist < y_dist)
-    { // closer on the X axis
-      if (overlap(rect.top, rect.bottom,  in.top, in.bottom))
-        {
-          float y_snap = 0.0f;
+  { // closer on the X axis
+    if (overlap(rect.top, rect.bottom,  in.top, in.bottom))
+    {
+      float y_snap = 0.0f;
 
-          if (fabs(rect.top - in.top) < snap_threshold)
-            {
-              y_snap = rect.top - in.top;
-              snap.y_set = true;
-            }
+      if (fabs(rect.top - in.top) < snap_threshold)
+      {
+	y_snap = rect.top - in.top;
+	snap.y_set = true;
+      }
 
-          if (fabs(rect.bottom - in.bottom) < snap_threshold)
-            {
-              y_snap = rect.bottom - in.bottom;
-              snap.y_set = true;
-            }
+      if (fabs(rect.bottom - in.bottom) < snap_threshold)
+      {
+	y_snap = rect.bottom - in.bottom;
+	snap.y_set = true;
+      }
 
-          if (left_dist < right_dist)
-            { // snap to left edge
-              if (left_dist < snap_threshold)
-                {
-                  snap.offset.x = rect.left - in.right;
-                  snap.offset.y = y_snap;
-                  snap.x_set = true;
-                }
-            }
-          else
-            { // snap to right edge
-              if (right_dist < snap_threshold)
-                {
-                  snap.offset.x = rect.right - in.left;
-                  snap.offset.y = y_snap;
-                  snap.x_set = true;
-                }
-            }
-        }
+      if (left_dist < right_dist)
+      { // snap to left edge
+	if (left_dist < snap_threshold)
+	{
+	  snap.offset.x = rect.left - in.right;
+	  snap.offset.y = y_snap;
+	  snap.x_set = true;
+	}
+      }
+      else
+      { // snap to right edge
+	if (right_dist < snap_threshold)
+	{
+	  snap.offset.x = rect.right - in.left;
+	  snap.offset.y = y_snap;
+	  snap.x_set = true;
+	}
+      }
     }
+  }
   else
-    { // closer on the Y axis
-      if (overlap(rect.left, rect.right,  in.left, in.right))
-        {
-          float x_snap = 0.0f;
+  { // closer on the Y axis
+    if (overlap(rect.left, rect.right,  in.left, in.right))
+    {
+      float x_snap = 0.0f;
 
-          if (fabs(rect.left - in.left) < snap_threshold)
-            {
-              x_snap = rect.left - in.left;
-              snap.x_set = true;
-            }
+      if (fabs(rect.left - in.left) < snap_threshold)
+      {
+	x_snap = rect.left - in.left;
+	snap.x_set = true;
+      }
 
-          if (fabs(rect.right - in.right) < snap_threshold)
-            {
-              x_snap = rect.right - in.right;
-              snap.x_set = true;
-            }
+      if (fabs(rect.right - in.right) < snap_threshold)
+      {
+	x_snap = rect.right - in.right;
+	snap.x_set = true;
+      }
 
-          if (top_dist < bottom_dist)
-            { // snap to top edge
-              if (top_dist < snap_threshold)
-                {
-                  snap.offset.x = x_snap;
-                  snap.offset.y = rect.top - in.bottom;
-                  snap.y_set = true;
-                }
-            }
-          else
-            { // snap to bottom edge
-              if (bottom_dist < snap_threshold)
-                {
-                  snap.offset.x = x_snap;
-                  snap.offset.y = rect.bottom - in.top;
-                  snap.y_set = true;
-                }
-            }
-        }      
-    }
+      if (top_dist < bottom_dist)
+      { // snap to top edge
+	if (top_dist < snap_threshold)
+	{
+	  snap.offset.x = x_snap;
+	  snap.offset.y = rect.top - in.bottom;
+	  snap.y_set = true;
+	}
+      }
+      else
+      { // snap to bottom edge
+	if (bottom_dist < snap_threshold)
+	{
+	  snap.offset.x = x_snap;
+	  snap.offset.y = rect.bottom - in.top;
+	  snap.y_set = true;
+	}
+      }
+    }      
+  }
 
   return snap;
 }

Modified: trunk/windstille/src/editor/object_model_factory.cpp
===================================================================
--- trunk/windstille/src/editor/object_model_factory.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/object_model_factory.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -26,14 +26,14 @@
 ObjectModelFactory::create(const FileReader& reader)
 {
   if (reader.get_name() == "decal")
-    {
-      return ObjectModelHandle(new DecalObjectModel(reader));
-    }
+  {
+    return ObjectModelHandle(new DecalObjectModel(reader));
+  }
   else
-    {
-      throw std::runtime_error("Unknown object type '" + reader.get_name() + "'");
-      return ObjectModelHandle();
-    }
+  {
+    throw std::runtime_error("Unknown object type '" + reader.get_name() + "'");
+    return ObjectModelHandle();
+  }
 }
 
 /* EOF */

Modified: trunk/windstille/src/editor/object_selector.cpp
===================================================================
--- trunk/windstille/src/editor/object_selector.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/object_selector.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -192,69 +192,69 @@
 
   Glib::Dir dir(pathname);
   for(Glib::Dir::iterator i = dir.begin(); i != dir.end(); ++i)
+  {
+    if (has_suffix(*i, ".png"))
     {
-      if (has_suffix(*i, ".png"))
-        {
-          Glib::ustring path_ = pathname;
-          path_ += *i;
-          images.push_back(path_);
-        }
+      Glib::ustring path_ = pathname;
+      path_ += *i;
+      images.push_back(path_);
     }
+  }
 
   std::sort(images.begin(), images.end());
 
   for(std::vector<Glib::ustring>::iterator i = images.begin(); i != images.end(); ++i)    
-    {
-      Glib::RefPtr<Gdk::Pixbuf> pixbuf = Gdk::Pixbuf::create_from_file(*i);
-      Glib::RefPtr<Gdk::Pixbuf> icon;
+  {
+    Glib::RefPtr<Gdk::Pixbuf> pixbuf = Gdk::Pixbuf::create_from_file(*i);
+    Glib::RefPtr<Gdk::Pixbuf> icon;
 
-      { // Create an icon, by scaling it down, keeping aspect
-        // intact and adding a background (important to make drag&drop easier)
-        int size     = 48; // size of the icon
-        int min_size = 16; // minimum width/height of the icon after scaling
+    { // Create an icon, by scaling it down, keeping aspect
+      // intact and adding a background (important to make drag&drop easier)
+      int size     = 48; // size of the icon
+      int min_size = 16; // minimum width/height of the icon after scaling
 
-        if (1)
-          {
-            icon = Gdk::Pixbuf::create_from_file("data/editor/icon_bg.png");
-            size = std::max(icon->get_width(), icon->get_height());
-          }
-        else
-          {
-            icon = Gdk::Pixbuf::create(Gdk::COLORSPACE_RGB, true, 8, size, size);
-            icon->fill(0x444444ff);
-          }
+      if (1)
+      {
+	icon = Gdk::Pixbuf::create_from_file("data/editor/icon_bg.png");
+	size = std::max(icon->get_width(), icon->get_height());
+      }
+      else
+      {
+	icon = Gdk::Pixbuf::create(Gdk::COLORSPACE_RGB, true, 8, size, size);
+	icon->fill(0x444444ff);
+      }
 
-        // Scale pixbuf to icon size while keeping aspect ratio intact
-        double x_scale = (double)size / pixbuf->get_width();
-        double y_scale = (double)size / pixbuf->get_height();
+      // Scale pixbuf to icon size while keeping aspect ratio intact
+      double x_scale = (double)size / pixbuf->get_width();
+      double y_scale = (double)size / pixbuf->get_height();
 
-        if (x_scale * pixbuf->get_width() < min_size)
-          x_scale = min_size / pixbuf->get_width();
+      if (x_scale * pixbuf->get_width() < min_size)
+	x_scale = min_size / pixbuf->get_width();
 
-        if (y_scale * pixbuf->get_height() < min_size)
-          y_scale = min_size / pixbuf->get_height();
+      if (y_scale * pixbuf->get_height() < min_size)
+	y_scale = min_size / pixbuf->get_height();
 
-        if (pixbuf->get_width() > pixbuf->get_height())              
-          y_scale = x_scale;
-        else
-          x_scale = y_scale;
+      if (pixbuf->get_width() > pixbuf->get_height())              
+	y_scale = x_scale;
+      else
+	x_scale = y_scale;
 
-        int r_w = int(pixbuf->get_width() * x_scale);
-        int r_h = int(pixbuf->get_height() * y_scale);
+      int r_w = int(pixbuf->get_width() * x_scale);
+      int r_h = int(pixbuf->get_height() * y_scale);
 
-        pixbuf->composite(icon, 
-                          (size - r_w)/2, (size - r_h)/2,
-                          r_w, r_h,
-                          (size - r_w)/2, (size - r_h)/2,
-                          x_scale, y_scale,
-                          Gdk::INTERP_TILES, 
-                          255);
-      }
+      pixbuf->composite(icon, 
+			(size - r_w)/2, (size - r_h)/2,
+			r_w, r_h,
+			(size - r_w)/2, (size - r_h)/2,
+			x_scale, y_scale,
+			Gdk::INTERP_TILES, 
+			255);
+    }
 
-      add_decal(icon, *i, 
-                "file:///home/ingo/projects/windstille/trunk/windstille/" + *i, 
-                filter_);
-    }
+    add_decal(icon, *i, 
+	      "file:///home/ingo/projects/windstille/trunk/windstille/" + *i, 
+	      filter_);
+  }
 }
 
 void
@@ -290,28 +290,28 @@
   for(Gtk::IconView::ArrayHandle_TreePaths::iterator i = selection.begin();
       i != selection.end();
       ++i)
-    {
-      Gtk::TreeModel::Path path_ = list_filter->convert_path_to_child_path(*i);
-      Gtk::ListStore::iterator it = list_store->get_iter(path_);
+  {
+    Gtk::TreeModel::Path path_ = list_filter->convert_path_to_child_path(*i);
+    Gtk::ListStore::iterator it = list_store->get_iter(path_);
 
-      iconpath = (*it)[Columns::instance().pathname];
-    }
+    iconpath = (*it)[Columns::instance().pathname];
+  }
 
   if (iconpath.empty())
-    {
-      // refuse drag: how?
-    }
+  {
+    // refuse drag: how?
+  }
   else
+  {
+    Glib::RefPtr<Gdk::Pixbuf> pixbuf = Gdk::Pixbuf::create_from_file(iconpath);
+    if (WindstilleWidget* wst = EditorWindow::current()->get_windstille_widget())
     {
-      Glib::RefPtr<Gdk::Pixbuf> pixbuf = Gdk::Pixbuf::create_from_file(iconpath);
-      if (WindstilleWidget* wst = EditorWindow::current()->get_windstille_widget())
-        {
-          pixbuf = pixbuf->scale_simple(std::max(4, int(static_cast<float>(pixbuf->get_width())  * wst->get_state().get_zoom())),
-                                        std::max(4, int(static_cast<float>(pixbuf->get_height()) * wst->get_state().get_zoom())),
-                                        Gdk::INTERP_TILES);
-        }
-      context->set_icon(pixbuf, pixbuf->get_width()/2, pixbuf->get_height()/2);
+      pixbuf = pixbuf->scale_simple(std::max(4, int(static_cast<float>(pixbuf->get_width())  * wst->get_state().get_zoom())),
+				    std::max(4, int(static_cast<float>(pixbuf->get_height()) * wst->get_state().get_zoom())),
+				    Gdk::INTERP_TILES);
     }
+    context->set_icon(pixbuf, pixbuf->get_width()/2, pixbuf->get_height()/2);
+  }
 }
 
 void
@@ -326,21 +326,21 @@
   for(Gtk::IconView::ArrayHandle_TreePaths::const_iterator i = selection.begin();
       i != selection.end();
       ++i)
+  {
+    Gtk::TreeModel::Path path_ = list_filter->convert_path_to_child_path(*i);
+    Gtk::ListStore::iterator it = list_store->get_iter(path_);
+
+    if (selection_data.get_target() == "application/x-windstille-decal")
     {
-      Gtk::TreeModel::Path path_ = list_filter->convert_path_to_child_path(*i);
-      Gtk::ListStore::iterator it = list_store->get_iter(path_);
-
-      if (selection_data.get_target() == "application/x-windstille-decal")
-        {
-          const std::string& str = (*it)[Columns::instance().pathname];
-          selection_data.set(8, reinterpret_cast<const guint8*>(str.c_str()), str.length());
-        }
-      else
-        {
-          const std::string& str = (*it)[Columns::instance().url];
-          selection_data.set(8, reinterpret_cast<const guint8*>(str.c_str()), str.length());
-        }
+      const std::string& str = (*it)[Columns::instance().pathname];
+      selection_data.set(8, reinterpret_cast<const guint8*>(str.c_str()), str.length());
     }
+    else
+    {
+      const std::string& str = (*it)[Columns::instance().url];
+      selection_data.set(8, reinterpret_cast<const guint8*>(str.c_str()), str.length());
+    }
+  }
 }
 
 /* EOF */

Modified: trunk/windstille/src/editor/property_dialog.cpp
===================================================================
--- trunk/windstille/src/editor/property_dialog.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/property_dialog.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -23,17 +23,17 @@
 #if 0
   std::vector<std::string> props = properties.get_properties();
   for(std::vector<std::string>::iterator i = props.begin(); i != props.end(); ++i)
+  {
+    Property& prop = properties.get_property(*i);
+    if (prop.get_type() == "int")
     {
-      Property& prop = properties.get_property(*i);
-      if (prop.get_type() == "int")
-        {
-          new Gtk::Label(*i);
-          new Gtk::TextEntry();
-        }
-      else if (prop.get_type() == "float")
-        {
-        }
+      new Gtk::Label(*i);
+      new Gtk::TextEntry();
     }
+    else if (prop.get_type() == "float")
+    {
+    }
+  }
 #endif 
 }
 

Modified: trunk/windstille/src/editor/scroll_tool.cpp
===================================================================
--- trunk/windstille/src/editor/scroll_tool.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/scroll_tool.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -40,23 +40,23 @@
 ScrollTool::mouse_move(GdkEventMotion* event, WindstilleWidget& wst)
 {
   if (mode == SCROLLING)
-    {
-      Vector2f offset = orig_click - orig_state.screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
-      wst.get_state().set_pos(orig_state.get_pos() + offset);
-      wst.queue_draw();
-    }
+  {
+    Vector2f offset = orig_click - orig_state.screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
+    wst.get_state().set_pos(orig_state.get_pos() + offset);
+    wst.queue_draw();
+  }
 }
 
 void
 ScrollTool::mouse_up(GdkEventButton* event, WindstilleWidget& wst)
 {
   if (mode == SCROLLING)
-    {
-      Vector2f offset = orig_click - orig_state.screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
-      wst.get_state().set_pos(orig_state.get_pos() + offset);
-      mode = NO_MODE;
-      wst.queue_draw();
-    }
+  {
+    Vector2f offset = orig_click - orig_state.screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
+    wst.get_state().set_pos(orig_state.get_pos() + offset);
+    mode = NO_MODE;
+    wst.queue_draw();
+  }
 }
 
 /* EOF */

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -87,7 +87,7 @@
 void
 SectorModel::add_layer(LayerHandle layer, const Gtk::TreeModel::Path& path)
 {
- Gtk::ListStore::iterator it;
+  Gtk::ListStore::iterator it;
 
   if (path.empty())
     it = layer_tree->append();
@@ -124,13 +124,13 @@
 SectorModel::delete_layer(const Gtk::TreeModel::Path& path)
 {
   if (path.empty())
-    {
-      EditorWindow::current()->print("SectorModel::delete_layer(): invalid empty path");
-    }
+  {
+    EditorWindow::current()->print("SectorModel::delete_layer(): invalid empty path");
+  }
   else
-    {
-      layer_tree->erase(layer_tree->get_iter(path));
-    }
+  {
+    layer_tree->erase(layer_tree->get_iter(path));
+  }
 }
 
 void
@@ -149,15 +149,15 @@
 SectorModel::add(const ObjectModelHandle& object, const Gtk::TreeModel::Path& path)
 {
   if (path.empty())
-    {
-      EditorWindow::current()->print("SectorModel::add(): invalid empty path");
-    }
+  {
+    EditorWindow::current()->print("SectorModel::add(): invalid empty path");
+  }
   else
-    { 
-      Gtk::ListStore::iterator it = layer_tree->get_iter(path);
-      ((LayerHandle)(*it)[LayerManagerColumns::instance().layer])->add(object);
-      rebuild_scene_graph();
-    }
+  { 
+    Gtk::ListStore::iterator it = layer_tree->get_iter(path);
+    ((LayerHandle)(*it)[LayerManagerColumns::instance().layer])->add(object);
+    rebuild_scene_graph();
+  }
 }
 
 void
@@ -166,9 +166,9 @@
   const Layers& layers = get_layers();
  
   for(Layers::const_reverse_iterator i = layers.rbegin(); i != layers.rend(); ++i)
-    {
-      (*i)->remove(object);
-    }
+  {
+    (*i)->remove(object);
+  }
   rebuild_scene_graph();
 }
 
@@ -200,21 +200,21 @@
 SectorModel::get_layer(const Gtk::TreeModel::Path& path) const
 {
   if (!path.empty())
+  {
+    Gtk::TreeModel::iterator it = layer_tree->get_iter(path);
+    if (it)
     {
-      Gtk::TreeModel::iterator it = layer_tree->get_iter(path);
-      if (it)
-        {
-          return (*it)[LayerManagerColumns::instance().layer];
-        }
-      else
-        {
-          return LayerHandle();
-        }
+      return (*it)[LayerManagerColumns::instance().layer];
     }
-  else
+    else
     {
       return LayerHandle();
     }
+  }
+  else
+  {
+    return LayerHandle();
+  }
 }
 
 LayerHandle
@@ -223,12 +223,12 @@
   const Layers& layers = get_layers();
  
   for(Layers::const_reverse_iterator i = layers.rbegin(); i != layers.rend(); ++i)
+  {
+    if ((*i)->has_object(object))
     {
-      if ((*i)->has_object(object))
-        {
-          return *i;
-        }
-    }  
+      return *i;
+    }
+  }  
   
   return LayerHandle();
 }
@@ -240,10 +240,10 @@
   const Layers& layers = get_layers();
  
   for(Layers::const_iterator i = layers.begin(); i != layers.end(); ++i)
-    {
-      if ((*i)->is_visible())
-        (*i)->draw(sc, layermask);
-    }
+  {
+    if ((*i)->is_visible())
+      (*i)->draw(sc, layermask);
+  }
 }
 
 void
@@ -252,10 +252,10 @@
   const Layers& layers = get_layers();
 
   for(Layers::const_iterator i = layers.begin(); i != layers.end(); ++i)
-    {
-      if ((*i)->is_visible())
-        (*i)->update(delta);
-    }
+  {
+    if ((*i)->is_visible())
+      (*i)->update(delta);
+  }
 }
 
 ObjectModelHandle
@@ -311,10 +311,10 @@
 {
   const Layers& layers = get_layers();
   for(Layers::const_reverse_iterator i = layers.rbegin(); i != layers.rend(); ++i)
-    {
-      if ((*i)->has_object(object))
-        return *i;
-    }
+  {
+    if ((*i)->has_object(object))
+      return *i;
+  }
   return LayerHandle();
 }
 
@@ -349,12 +349,12 @@
 
   SnapData snap_data;
   for(Layers::const_iterator i = layers.begin(); i != layers.end(); ++i)
+  {
+    if ((*i)->is_visible())
     {
-      if ((*i)->is_visible())
-        {
-          snap_data.merge((*i)->snap_object(rect, ignore_objects));
-        }
+      snap_data.merge((*i)->snap_object(rect, ignore_objects));
     }
+  }
   return snap_data;
 }
 
@@ -492,20 +492,20 @@
 
   writer.start_section("layers");
   for(Gtk::ListStore::Children::iterator i = layer_tree->children().begin(); i != layer_tree->children().end(); ++i)
-    {
-      const Gtk::TreeRow& row = *i;
+  {
+    const Gtk::TreeRow& row = *i;
 
-      writer.start_section("layer");
-      writer.write("name",    (Glib::ustring)(row[LayerManagerColumns::instance().name]));
-      writer.write("visible", (bool)row[LayerManagerColumns::instance().visible]);
-      writer.write("locked",  (bool)row[LayerManagerColumns::instance().locked]);
+    writer.start_section("layer");
+    writer.write("name",    (Glib::ustring)(row[LayerManagerColumns::instance().name]));
+    writer.write("visible", (bool)row[LayerManagerColumns::instance().visible]);
+    writer.write("locked",  (bool)row[LayerManagerColumns::instance().locked]);
 
-      writer.start_section("objects");
-      ((LayerHandle)row[LayerManagerColumns::instance().layer])->write(writer);
-      writer.end_section();
+    writer.start_section("objects");
+    ((LayerHandle)row[LayerManagerColumns::instance().layer])->write(writer);
+    writer.end_section();
 
-      writer.end_section();
-    }
+    writer.end_section();
+  }
   writer.end_section();
 
   writer.end_section();
@@ -582,9 +582,9 @@
 SectorModel::queue_draw()
 {
   if (WindstilleWidget* wst = EditorWindow::current()->get_windstille_widget())
-    {
-      wst->queue_draw();
-    }
+  {
+    wst->queue_draw();
+  }
 }
 
 void
@@ -593,14 +593,14 @@
   //std::cout << "LayerManager:on_row_changed" << std::endl;
 
   if (iter)
+  {
+    // Update the Layer object with data from the tree
+    LayerHandle layer = (*iter)[LayerManagerColumns::instance().layer];
+    if (layer)
     {
-      // Update the Layer object with data from the tree
-      LayerHandle layer = (*iter)[LayerManagerColumns::instance().layer];
-      if (layer)
-        {
-          layer->sync(*iter);
-        }
+      layer->sync(*iter);
     }
+  }
   rebuild_scene_graph();
 }
 
@@ -646,11 +646,11 @@
         if (edge)
         {
           /*
-          if (edge.get_lhs().get() == &node ||
-              edge.get_rhs().get() == &node)
-          {
+	    if (edge.get_lhs().get() == &node ||
+	    edge.get_rhs().get() == &node)
+	    {
 
-          }
+	    }
           */
         }
       }

Modified: trunk/windstille/src/editor/select_mask.hpp
===================================================================
--- trunk/windstille/src/editor/select_mask.hpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/select_mask.hpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -41,13 +41,13 @@
   void set(unsigned int layer, bool enable)
   {
     if (enable)
-      {
-        mask = mask | (1u<<layer);
-      }
+    {
+      mask = mask | (1u<<layer);
+    }
     else
-      {
-        mask = mask & (~(1u<<layer));
-      }
+    {
+      mask = mask & (~(1u<<layer));
+    }
   }
 
   int size() const 

Modified: trunk/windstille/src/editor/select_tool.cpp
===================================================================
--- trunk/windstille/src/editor/select_tool.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/select_tool.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -28,12 +28,12 @@
 static const int MOVE_THRESHOLD = 16;
 
 SelectTool::SelectTool()
- : click_pos(),
-   rect(),
-   selection(),
-   ctrl_point(),
-   start_time(),
-   mode(NO_MODE)    
+  : click_pos(),
+    rect(),
+    selection(),
+    ctrl_point(),
+    start_time(),
+    mode(NO_MODE)    
 {
 }
 
@@ -45,55 +45,55 @@
 
   ctrl_point = wst.get_document().get_control_point(click_pos);
   if (ctrl_point)
+  {
+    mode = CONTROL_DRAG_MODE;
+    wst.get_document().clear_control_points();
+    ctrl_point->on_move_start(event);
+  }
+  else
+  {  
+    ObjectModelHandle object = wst.get_document().get_sector_model().get_object_at(click_pos, wst.get_select_mask());
+    if (object.get())
     {
-      mode = CONTROL_DRAG_MODE;
-      wst.get_document().clear_control_points();
-      ctrl_point->on_move_start(event);
-    }
-  else
-    {  
-      ObjectModelHandle object = wst.get_document().get_sector_model().get_object_at(click_pos, wst.get_select_mask());
-      if (object.get())
-        {
-          if (wst.get_document().get_selection()->has_object(object))
-            {
-              selection = wst.get_document().get_selection();
-              if (event->state & GDK_SHIFT_MASK)
-                {
-                  selection->remove(object);
-                }
-              else
-                {
-                  selection = wst.get_document().get_selection();
-                }
-            }
-          else
-            {
-              if (event->state & GDK_SHIFT_MASK)
-                {
-                  selection = wst.get_document().get_selection();
-                  selection->add(object);
-                }
-              else
-                {
-                  selection = Selection::create();
-                  selection->add(object);
-                  wst.get_document().set_selection(selection);
-                }
-            }
-      
-          mode = OBJECT_DRAG_MODE;
-        }
+      if (wst.get_document().get_selection()->has_object(object))
+      {
+	selection = wst.get_document().get_selection();
+	if (event->state & GDK_SHIFT_MASK)
+	{
+	  selection->remove(object);
+	}
+	else
+	{
+	  selection = wst.get_document().get_selection();
+	}
+      }
       else
-        {
-          rect.left   = click_pos.x;
-          rect.top    = click_pos.y;
-          rect.right  = click_pos.x;
-          rect.bottom = click_pos.y;
+      {
+	if (event->state & GDK_SHIFT_MASK)
+	{
+	  selection = wst.get_document().get_selection();
+	  selection->add(object);
+	}
+	else
+	{
+	  selection = Selection::create();
+	  selection->add(object);
+	  wst.get_document().set_selection(selection);
+	}
+      }
       
-          mode = SELECT_MODE;
-        }
+      mode = OBJECT_DRAG_MODE;
     }
+    else
+    {
+      rect.left   = click_pos.x;
+      rect.top    = click_pos.y;
+      rect.right  = click_pos.x;
+      rect.bottom = click_pos.y;
+      
+      mode = SELECT_MODE;
+    }
+  }
 
   wst.queue_draw();
 }
@@ -105,22 +105,22 @@
   std::set<ObjectModelHandle> ignore_objects(selection->begin(), selection->end());
 
   if (!wst.get_draw_only_active_layer())
-    {
-      // ignore all objects not on the current active layer
-      for(Layer::iterator i = wst.get_current_layer()->begin(); i != wst.get_current_layer()->end(); ++i)
-        { // FIXME: Should iterate over all objects, not just objects in the current layer
-          if (!wst.get_select_mask().match((*i)->get_select_mask()))
-            ignore_objects.insert(*i);
-        }
+  {
+    // ignore all objects not on the current active layer
+    for(Layer::iterator i = wst.get_current_layer()->begin(); i != wst.get_current_layer()->end(); ++i)
+    { // FIXME: Should iterate over all objects, not just objects in the current layer
+      if (!wst.get_select_mask().match((*i)->get_select_mask()))
+	ignore_objects.insert(*i);
     }
+  }
 
   SnapData best_snap;
 
   for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
-    {
-      SnapData snap = wst.get_document().get_sector_model().snap_object((*i)->get_bounding_box(), ignore_objects);
-      best_snap.merge(snap);
-    }
+  {
+    SnapData snap = wst.get_document().get_sector_model().snap_object((*i)->get_bounding_box(), ignore_objects);
+    best_snap.merge(snap);
+  }
               
   return best_snap.offset;
 }
@@ -131,39 +131,39 @@
   Vector2f pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
 
   if (mode == CONTROL_DRAG_MODE)
-    {
-      ctrl_point->on_move_update(event, pos - click_pos);
-      wst.queue_draw();
-    }
+  {
+    ctrl_point->on_move_update(event, pos - click_pos);
+    wst.queue_draw();
+  }
   else if (mode == OBJECT_DRAG_MODE)
+  {
+    Vector2f offset = pos - click_pos;
+          
+    if ((event->time - start_time) > MOVE_TIMEOUT ||
+	offset.length() > MOVE_THRESHOLD)
     {
-      Vector2f offset = pos - click_pos;
-          
-      if ((event->time - start_time) > MOVE_TIMEOUT ||
-          offset.length() > MOVE_THRESHOLD)
-        {
-          if (!selection->is_moving())
-            selection->on_move_start();
+      if (!selection->is_moving())
+	selection->on_move_start();
 
-          selection->on_move_update(offset);
+      selection->on_move_update(offset);
       
-          if (event->state & GDK_CONTROL_MASK)
-            {
-              selection->on_move_update(offset + process_snap(wst));
-            }
+      if (event->state & GDK_CONTROL_MASK)
+      {
+	selection->on_move_update(offset + process_snap(wst));
+      }
 
-          wst.queue_draw();
-        }
+      wst.queue_draw();
     }
+  }
   else if (mode == SELECT_MODE)
-    {
-      rect.left   = click_pos.x;
-      rect.top    = click_pos.y;
-      rect.right  = pos.x;
-      rect.bottom = pos.y;
+  {
+    rect.left   = click_pos.x;
+    rect.top    = click_pos.y;
+    rect.right  = pos.x;
+    rect.bottom = pos.y;
 
-      wst.queue_draw();
-    }
+    wst.queue_draw();
+  }
 }
 
 void
@@ -173,46 +173,46 @@
 
   // Select objects
   if (mode == CONTROL_DRAG_MODE)
-    {
-      ctrl_point->on_move_end(event, pos - click_pos);
-      wst.get_document().create_control_points();
-      wst.queue_draw();
-    }
+  {
+    ctrl_point->on_move_end(event, pos - click_pos);
+    wst.get_document().create_control_points();
+    wst.queue_draw();
+  }
   else if (mode == OBJECT_DRAG_MODE)
+  {
+    Vector2f offset = pos - click_pos;
+
+    if (event->time - start_time > MOVE_TIMEOUT ||
+	offset.length() > MOVE_THRESHOLD)
     {
-      Vector2f offset = pos - click_pos;
-
-      if (event->time - start_time > MOVE_TIMEOUT ||
-          offset.length() > MOVE_THRESHOLD)
-        {
-          selection->on_move_update(offset);
+      selection->on_move_update(offset);
       
-          if (event->state & GDK_CONTROL_MASK)
-            {
-              selection->on_move_end(wst, offset + process_snap(wst));
-            }
-          else
-            {
-              selection->on_move_end(wst, offset);
-            }
-          wst.queue_draw();
-        }
+      if (event->state & GDK_CONTROL_MASK)
+      {
+	selection->on_move_end(wst, offset + process_snap(wst));
+      }
+      else
+      {
+	selection->on_move_end(wst, offset);
+      }
+      wst.queue_draw();
     }
+  }
   else if (mode == SELECT_MODE)
+  {
+    mode = NO_MODE;
+    rect.normalize();
+    if (event->state & GDK_SHIFT_MASK)
     {
-      mode = NO_MODE;
-      rect.normalize();
-      if (event->state & GDK_SHIFT_MASK)
-        {
-          SelectionHandle new_selection = wst.get_document().get_sector_model().get_selection(rect, wst.get_select_mask());
-          wst.get_document().get_selection()->add(new_selection->begin(), new_selection->end());
-        }
-      else
-        {
-          wst.get_document().set_selection(wst.get_document().get_sector_model().get_selection(rect, wst.get_select_mask()));
-        }
-      wst.queue_draw();
+      SelectionHandle new_selection = wst.get_document().get_sector_model().get_selection(rect, wst.get_select_mask());
+      wst.get_document().get_selection()->add(new_selection->begin(), new_selection->end());
     }
+    else
+    {
+      wst.get_document().set_selection(wst.get_document().get_sector_model().get_selection(rect, wst.get_select_mask()));
+    }
+    wst.queue_draw();
+  }
 
   mode = NO_MODE;
 }
@@ -228,10 +228,10 @@
 SelectTool::draw(SceneContext& sc)
 {
   if (mode == SELECT_MODE)
-    {
-      sc.control().fill_rect(rect, Color(0.5f, 0.5f, 1.0f, 0.25));
-      sc.control().draw_rect(rect, Color(0.5f, 0.5f, 1.0f)); 
-    }
+  {
+    sc.control().fill_rect(rect, Color(0.5f, 0.5f, 1.0f, 0.25));
+    sc.control().draw_rect(rect, Color(0.5f, 0.5f, 1.0f)); 
+  }
 }
 
 /* EOF */

Modified: trunk/windstille/src/editor/selection.cpp
===================================================================
--- trunk/windstille/src/editor/selection.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/selection.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -48,14 +48,14 @@
 {
   Objects::iterator it = std::find(objects.begin(), objects.end(), object);
   if (it != objects.end())
-    {
-      objects.erase(it);
-      signal_changed();
-    }
+  {
+    objects.erase(it);
+    signal_changed();
+  }
   else
-    {
-      EditorWindow::current()->print("Selection:remove(): object not in selection");
-    }
+  {
+    EditorWindow::current()->print("Selection:remove(): object not in selection");
+  }
 }
 
 bool
@@ -83,12 +83,12 @@
 {
   ObjectModelHandle parent = object->get_parent();
   while (parent)
-    {
-      if (has_object(parent))
-        return true;
+  {
+    if (has_object(parent))
+      return true;
 
-      parent = parent->get_parent();
-    }
+    parent = parent->get_parent();
+  }
 
   return false;
 }
@@ -99,23 +99,23 @@
   moving = true;
 
   for(Objects::iterator i = objects.begin(); i != objects.end(); ++i)
+  {
+    if (contains_parent(*i))
     {
-      if (contains_parent(*i))
-        {
-          non_moveable_objects.insert(*i);
-        }
+      non_moveable_objects.insert(*i);
     }
+  }
 
   object_orig_poss.clear();
 
   for(Objects::iterator i = objects.begin(); i != objects.end(); ++i)
+  {
+    if (non_moveable_objects.find(*i) == non_moveable_objects.end())
     {
-      if (non_moveable_objects.find(*i) == non_moveable_objects.end())
-        {
-          //(*i)->on_move_start();
-          object_orig_poss.push_back((*i)->get_rel_pos());
-        }
+      //(*i)->on_move_start();
+      object_orig_poss.push_back((*i)->get_rel_pos());
     }
+  }
 
   signal_changed();
 }
@@ -124,12 +124,12 @@
 Selection::on_move_update(const Vector2f& offset)
 {
   for(Objects::iterator i = objects.begin(); i != objects.end(); ++i)
+  {
+    if (non_moveable_objects.find(*i) == non_moveable_objects.end())
     {
-      if (non_moveable_objects.find(*i) == non_moveable_objects.end())
-        {
-          (*i)->set_rel_pos(object_orig_poss[i - objects.begin()] + offset);
-        }
+      (*i)->set_rel_pos(object_orig_poss[i - objects.begin()] + offset);
     }
+  }
 }
 
 void
@@ -158,30 +158,30 @@
   SelectionHandle selection = Selection::create();
   std::map<ObjectModelHandle, ObjectModelHandle> parent_map;
   for(Objects::const_iterator i = objects.begin(); i != objects.end(); ++i)
-    {
-      ObjectModelHandle obj = (*i)->clone();
-      parent_map[*i] = obj;
-      selection->add(obj);
-    }
+  {
+    ObjectModelHandle obj = (*i)->clone();
+    parent_map[*i] = obj;
+    selection->add(obj);
+  }
 
   // Second pass to set the parents to the cloned objects
   for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
+  {
+    if ((*i)->get_parent())
     {
-      if ((*i)->get_parent())
-        {
-          std::map<ObjectModelHandle, ObjectModelHandle>::iterator it = parent_map.find((*i)->get_parent());
+      std::map<ObjectModelHandle, ObjectModelHandle>::iterator it = parent_map.find((*i)->get_parent());
           
-          if (it == parent_map.end())
-            {
-              // When the parent wasn't part of the selection, leave
-              // the parent untouched
-            }
-          else
-            {
-              (*i)->set_parent(it->second);
-            }
-        }
+      if (it == parent_map.end())
+      {
+	// When the parent wasn't part of the selection, leave
+	// the parent untouched
+      }
+      else
+      {
+	(*i)->set_parent(it->second);
+      }
     }
+  }
 
   return selection;
 }
@@ -190,47 +190,47 @@
 Selection::get_bounding_box() const
 {
   if (empty())
-    {
-      return Rectf();
-    }
+  {
+    return Rectf();
+  }
   else
+  {
+    Rectf rect = objects.front()->get_bounding_box();
+    for(Objects::const_iterator i = objects.begin()+1; i != objects.end(); ++i)
     {
-      Rectf rect = objects.front()->get_bounding_box();
-      for(Objects::const_iterator i = objects.begin()+1; i != objects.end(); ++i)
-        {
-          rect = rect.grow((*i)->get_bounding_box());
-        }
-      return rect;
+      rect = rect.grow((*i)->get_bounding_box());
     }
+    return rect;
+  }
 }
 
 void
 Selection::reset()
 {
   for(Objects::const_iterator i = objects.begin(); i != objects.end(); ++i)
-    {
-      (*i)->reset();
-    }
+  {
+    (*i)->reset();
+  }
 }
 
 void
 Selection::add_control_points(std::vector<ControlPointHandle>& control_points)
 {
   if (!empty())
+  {
+    if (size() == 1)
     {
-      if (size() == 1)
-        {
-          objects[0]->add_control_points(control_points);
-        }
-      else
-        {
-          const Rectf& rect = get_bounding_box();
-          control_points.push_back(ControlPoint::create(Vector2f(rect.left, rect.top)));
-          control_points.push_back(ControlPoint::create(Vector2f(rect.right, rect.top)));
-          control_points.push_back(ControlPoint::create(Vector2f(rect.left, rect.bottom)));
-          control_points.push_back(ControlPoint::create(Vector2f(rect.right, rect.bottom)));
-        }
+      objects[0]->add_control_points(control_points);
     }
+    else
+    {
+      const Rectf& rect = get_bounding_box();
+      control_points.push_back(ControlPoint::create(Vector2f(rect.left, rect.top)));
+      control_points.push_back(ControlPoint::create(Vector2f(rect.right, rect.top)));
+      control_points.push_back(ControlPoint::create(Vector2f(rect.left, rect.bottom)));
+      control_points.push_back(ControlPoint::create(Vector2f(rect.right, rect.bottom)));
+    }
+  }
 }
 
 /* EOF */

Modified: trunk/windstille/src/editor/selection.hpp
===================================================================
--- trunk/windstille/src/editor/selection.hpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/selection.hpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -57,9 +57,9 @@
   template<class Iter>
   void add(Iter begin_, Iter end_) {
     for(Iter i = begin_; i != end_; ++i)
-      {
-        add(*i);
-      }
+    {
+      add(*i);
+    }
     signal_changed();
   }
 

Modified: trunk/windstille/src/editor/snap_data.hpp
===================================================================
--- trunk/windstille/src/editor/snap_data.hpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/snap_data.hpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -36,17 +36,17 @@
   {
     if (((x_set && rhs.x_set) && (rhs.offset.x < offset.x)) ||
         (!x_set && rhs.x_set))
-      {
-        offset.x = rhs.offset.x;
-        x_set = true;
-      }
+    {
+      offset.x = rhs.offset.x;
+      x_set = true;
+    }
 
     if (((y_set && rhs.y_set) && (rhs.offset.y < offset.y)) ||
         (!y_set && rhs.y_set))
-      {
-        offset.y = rhs.offset.y;
-        y_set = true;
-      }
+    {
+      offset.y = rhs.offset.y;
+      y_set = true;
+    }
   }
 };
 

Modified: trunk/windstille/src/editor/undo_manager.cpp
===================================================================
--- trunk/windstille/src/editor/undo_manager.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/undo_manager.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -39,24 +39,24 @@
 UndoManager::undo()
 {
   if (!undo_stack.empty())
-    {
-      CommandHandle cmd = undo_stack.back();
-      undo_stack.pop_back();
-      cmd->undo();
-      redo_stack.push_back(cmd);
-    }
+  {
+    CommandHandle cmd = undo_stack.back();
+    undo_stack.pop_back();
+    cmd->undo();
+    redo_stack.push_back(cmd);
+  }
 }
 
 void
 UndoManager::redo()
 {
   if (!redo_stack.empty())
-    {
-      CommandHandle cmd = redo_stack.back();
-      redo_stack.pop_back();
-      cmd->redo();
-      undo_stack.push_back(cmd);
-    }
+  {
+    CommandHandle cmd = redo_stack.back();
+    redo_stack.pop_back();
+    cmd->redo();
+    undo_stack.push_back(cmd);
+  }
 }
 
 /* EOF */

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -144,41 +144,41 @@
   Glib::RefPtr<Gdk::GL::Window> glwindow = get_gl_window();
 
   if (glwindow->gl_begin(get_gl_context()))
+  {
+    if (!lib_init)
     {
-      if (!lib_init)
-        {
-          lib_init = true;
-          GLenum err = glewInit();
-          if(err != GLEW_OK) {
-            std::ostringstream msg;
-            msg << "Display:: Couldn't initialize glew: " << glewGetString(err);
-            throw std::runtime_error(msg.str());
-          }
+      lib_init = true;
+      GLenum err = glewInit();
+      if(err != GLEW_OK) {
+	std::ostringstream msg;
+	msg << "Display:: Couldn't initialize glew: " << glewGetString(err);
+	throw std::runtime_error(msg.str());
+      }
 
-          OpenGLState::init();
-        }
+      OpenGLState::init();
+    }
       
-      if (!sc.get())
-        {
-          sc.reset(new SceneContext());
-          compositor.reset(new Compositor(Size(get_width(), get_height()),
-                                          Size(get_width(), get_height())));
-          sc->set_render_mask(sc->get_render_mask() & ~SceneContext::LIGHTMAP);
-        }
+    if (!sc.get())
+    {
+      sc.reset(new SceneContext());
+      compositor.reset(new Compositor(Size(get_width(), get_height()),
+				      Size(get_width(), get_height())));
+      sc->set_render_mask(sc->get_render_mask() & ~SceneContext::LIGHTMAP);
+    }
       
-      background_pattern = Texture(Pathname("editor/background_layer.png"));
-      background_pattern.set_wrap(GL_REPEAT);
+    background_pattern = Texture(Pathname("editor/background_layer.png"));
+    background_pattern.set_wrap(GL_REPEAT);
 
-      glViewport(0, 0, get_width(), get_height());
-      glMatrixMode(GL_PROJECTION);
-      glLoadIdentity();
-      glOrtho(0.0, get_width(), get_height(), 0.0, 1000.0, -1000.0);
+    glViewport(0, 0, get_width(), get_height());
+    glMatrixMode(GL_PROJECTION);
+    glLoadIdentity();
+    glOrtho(0.0, get_width(), get_height(), 0.0, 1000.0, -1000.0);
 
-      glMatrixMode(GL_MODELVIEW);
-      glLoadIdentity();
+    glMatrixMode(GL_MODELVIEW);
+    glLoadIdentity();
   
-      glwindow->gl_end();
-    }
+    glwindow->gl_end();
+  }
 }
 
 bool
@@ -190,29 +190,29 @@
   Glib::RefPtr<Gdk::GL::Window> glwindow = get_gl_window();
 
   if (!glwindow->gl_begin(get_gl_context()))
+  {
+    return false;
+  }
+  else
+  {
+    if (compositor.get())
     {
-      return false;
+      compositor.reset(new Compositor(Size(ev->width, ev->height),
+				      Size(ev->width, ev->height)));
     }
-  else
-    {
-      if (compositor.get())
-      {
-        compositor.reset(new Compositor(Size(ev->width, ev->height),
-                                        Size(ev->width, ev->height)));
-      }
 
-      glViewport(0, 0, get_width(), get_height());
-      glMatrixMode(GL_PROJECTION);
-      glLoadIdentity();
-      glOrtho(0.0, get_width(), get_height(), 0.0, 1000.0, -1000.0);
+    glViewport(0, 0, get_width(), get_height());
+    glMatrixMode(GL_PROJECTION);
+    glLoadIdentity();
+    glOrtho(0.0, get_width(), get_height(), 0.0, 1000.0, -1000.0);
 
-      glMatrixMode(GL_MODELVIEW);
-      glLoadIdentity();
+    glMatrixMode(GL_MODELVIEW);
+    glLoadIdentity();
   
-      glwindow->gl_end();
+    glwindow->gl_end();
 
-      return true;
-    }
+    return true;
+  }
 }
 
 bool
@@ -221,23 +221,23 @@
   Glib::RefPtr<Gdk::GL::Window> glwindow = get_gl_window();
 
   if (!glwindow->gl_begin(get_gl_context()))
-    {
-      return false;
-    }
+  {
+    return false;
+  }
   else
-    {
-      draw();
+  {
+    draw();
 
-      // Swap buffers.
-      if (glwindow->is_double_buffered())
-        glwindow->swap_buffers();
-      else
-        glFlush();
+    // Swap buffers.
+    if (glwindow->is_double_buffered())
+      glwindow->swap_buffers();
+    else
+      glFlush();
 
-      glwindow->gl_end();
+    glwindow->gl_end();
 
-      return true;
-    }
+    return true;
+  }
 }
 
 void
@@ -252,70 +252,70 @@
 WindstilleWidget::draw()
 {
   if (sc.get())
-    {
-      state.push(*sc);
+  {
+    state.push(*sc);
       
-      sc->light().fill_screen(m_document->get_sector_model().get_ambient_color());
+    sc->light().fill_screen(m_document->get_sector_model().get_ambient_color());
 
-      if (draw_background_pattern)
-        {
-          sc->color().fill_pattern(background_pattern, 
-                                   state.get_offset() * state.get_zoom());
-        }
-      else
-        {
-          sc->color().fill_screen(Color());
-        }
+    if (draw_background_pattern)
+    {
+      sc->color().fill_pattern(background_pattern, 
+			       state.get_offset() * state.get_zoom());
+    }
+    else
+    {
+      sc->color().fill_screen(Color());
+    }
 
-      if (draw_only_active_layers)
-        m_document->get_sector_model().draw(*sc, SelectMask());
-      else
-        m_document->get_sector_model().draw(*sc, select_mask);
+    if (draw_only_active_layers)
+      m_document->get_sector_model().draw(*sc, SelectMask());
+    else
+      m_document->get_sector_model().draw(*sc, select_mask);
 
-      if (!m_document->get_selection()->empty())
-        {
-          for(Selection::iterator i = m_document->get_selection()->begin(); i != m_document->get_selection()->end(); ++i)
-            {
-              (*i)->draw_select(*sc, i == m_document->get_selection()->begin());
-            }
+    if (!m_document->get_selection()->empty())
+    {
+      for(Selection::iterator i = m_document->get_selection()->begin(); i != m_document->get_selection()->end(); ++i)
+      {
+	(*i)->draw_select(*sc, i == m_document->get_selection()->begin());
+      }
 
-          //sc->control().draw_rect(selection->get_bounding_box(), Color(1.0f, 1.0f, 1.0f, 1.0f));
-        }
+      //sc->control().draw_rect(selection->get_bounding_box(), Color(1.0f, 1.0f, 1.0f, 1.0f));
+    }
 
-      for(std::vector<ControlPointHandle>::const_iterator i = m_document->get_control_points().begin();
-          i != m_document->get_control_points().end(); ++i)
-        {
-          (*i)->draw(*sc);
-        }
+    for(std::vector<ControlPointHandle>::const_iterator i = m_document->get_control_points().begin();
+	i != m_document->get_control_points().end(); ++i)
+    {
+      (*i)->draw(*sc);
+    }
 
-      if (EditorWindow::current()->get_current_tool())
-        {
-          EditorWindow::current()->get_current_tool()->draw(*sc);
-        }
+    if (EditorWindow::current()->get_current_tool())
+    {
+      EditorWindow::current()->get_current_tool()->draw(*sc);
+    }
 
-      compositor->render(*sc, &m_document->get_sector_model().get_scene_graph(), state);
+    compositor->render(*sc, &m_document->get_sector_model().get_scene_graph(), state);
 
-      state.pop(*sc);
+    state.pop(*sc);
 
-      if (grid_enabled)
-        {
-          Display::draw_grid(state.get_offset() * state.get_zoom(),
-                             Sizef(128.0f * state.get_zoom(), 128.0f * state.get_zoom()), Color(1,1,1,0.5f));
-        }
+    if (grid_enabled)
+    {
+      Display::draw_grid(state.get_offset() * state.get_zoom(),
+			 Sizef(128.0f * state.get_zoom(), 128.0f * state.get_zoom()), Color(1,1,1,0.5f));
     }
+  }
 }
 
 bool
 WindstilleWidget::scroll(GdkEventScroll* ev)
 {
   if (ev->direction == GDK_SCROLL_UP)
-    {
-      //viewer->get_state().zoom(1.1f, Vector2i(event->x, event->y));
-    }
+  {
+    //viewer->get_state().zoom(1.1f, Vector2i(event->x, event->y));
+  }
   else if (ev->direction == GDK_SCROLL_DOWN)
-    {
-      //viewer->get_state().zoom(1.0f/1.1f, Vector2i(event->x, event->y));
-    }
+  {
+    //viewer->get_state().zoom(1.0f/1.1f, Vector2i(event->x, event->y));
+  }
   return false;
 }
 
@@ -327,24 +327,24 @@
   //std::cout << "Button Press: " << ev->x << ", " << ev->y << " - " << ev->button << std::endl;
 
   if (ev->button == 1)
-    { // Tool
-      EditorWindow::current()->get_current_tool()->mouse_down(ev, *this);
-      return true;
-    }
+  { // Tool
+    EditorWindow::current()->get_current_tool()->mouse_down(ev, *this);
+    return true;
+  }
   else if (ev->button == 2)
-    { // Scroll
-      scroll_tool->mouse_down(ev, *this);
-      return true;
-    }
+  { // Scroll
+    scroll_tool->mouse_down(ev, *this);
+    return true;
+  }
   else if (ev->button == 3)
-    { // Context Menu
-      EditorWindow::current()->get_current_tool()->mouse_right_down(ev, *this);
-      return true;
-    }
+  { // Context Menu
+    EditorWindow::current()->get_current_tool()->mouse_right_down(ev, *this);
+    return true;
+  }
   else
-    {
-      return false;
-    }
+  {
+    return false;
+  }
 }
 
 bool
@@ -364,15 +364,15 @@
   //std::cout << "Button Release: " << ev->x << ", " << ev->y << " - " << ev->button << std::endl;
   //viewer->on_mouse_button_up(Vector2i(ev->x, ev->y), ev->button);
   if (ev->button == 1)
-    {
-      EditorWindow::current()->get_current_tool()->mouse_up(ev, *this);
-      queue_draw();
-    }
+  {
+    EditorWindow::current()->get_current_tool()->mouse_up(ev, *this);
+    queue_draw();
+  }
   else if (ev->button == 2)
-    {
-      scroll_tool->mouse_up(ev, *this);
-      queue_draw();
-    }
+  {
+    scroll_tool->mouse_up(ev, *this);
+    queue_draw();
+  }
 
   return false;
 }
@@ -383,57 +383,57 @@
   //std::cout << ev->keyval << " keypress " << state.get_pos() << std::endl;
 
   switch(ev->keyval)
-    {
-      case GDK_1:
-        map_type = DecalObjectModel::COLORMAP;
-        EditorWindow::current()->print("COLORMAP");
-        break;
+  {
+    case GDK_1:
+      map_type = DecalObjectModel::COLORMAP;
+      EditorWindow::current()->print("COLORMAP");
+      break;
 
-      case GDK_2:
-        map_type = DecalObjectModel::LIGHTMAP;
-        EditorWindow::current()->print("LIGHTMAP");
-        break;
+    case GDK_2:
+      map_type = DecalObjectModel::LIGHTMAP;
+      EditorWindow::current()->print("LIGHTMAP");
+      break;
 
-      case GDK_3:
-        map_type = DecalObjectModel::HIGHLIGHTMAP;
-        EditorWindow::current()->print("HIGHLIGHT");
-        break;
+    case GDK_3:
+      map_type = DecalObjectModel::HIGHLIGHTMAP;
+      EditorWindow::current()->print("HIGHLIGHT");
+      break;
 
-      case GDK_a:
-        EditorWindow::current()->on_select_all();
-        break;
+    case GDK_a:
+      EditorWindow::current()->on_select_all();
+      break;
 
-      case GDK_d:
-        m_document->selection_duplicate();
-        break;
+    case GDK_d:
+      m_document->selection_duplicate();
+      break;
 
-      case GDK_s:
-        SurfaceManager::current()->save_all_as_png();
-        break;
+    case GDK_s:
+      SurfaceManager::current()->save_all_as_png();
+      break;
 
-      case GDK_Delete:
-        m_document->selection_delete();
-        break;
+    case GDK_Delete:
+      m_document->selection_delete();
+      break;
 
-      case GDK_Left:
-        state.set_pos(state.get_pos() + Vector2f(-100.0f, 0.0f));
-        break;
+    case GDK_Left:
+      state.set_pos(state.get_pos() + Vector2f(-100.0f, 0.0f));
+      break;
 
-      case GDK_Right:
-        state.set_pos(state.get_pos() + Vector2f(100.0f, 0.0f));
-        queue_draw();
-        break;
+    case GDK_Right:
+      state.set_pos(state.get_pos() + Vector2f(100.0f, 0.0f));
+      queue_draw();
+      break;
 
-      case GDK_Up:
-        state.set_pos(state.get_pos() + Vector2f(0.0f, -100.0f));
-        queue_draw();
-        break;
+    case GDK_Up:
+      state.set_pos(state.get_pos() + Vector2f(0.0f, -100.0f));
+      queue_draw();
+      break;
 
-      case GDK_Down:
-        state.set_pos(state.get_pos() + Vector2f(0.0f, 100.0f));
-        queue_draw();
-        break;
-    }
+    case GDK_Down:
+      state.set_pos(state.get_pos() + Vector2f(0.0f, 100.0f));
+      queue_draw();
+      break;
+  }
 
   return true;
 }
@@ -478,13 +478,13 @@
   EditorWindow::current()->get_layer_manager().get_treeview().get_cursor(path_, focus_column);
 
   if (!path_.gobj())
-    {
-      std::cout << "WindstilleWidget::on_drag_data_received(): Error: Couldn't get path" << std::endl;
-    }
+  {
+    std::cout << "WindstilleWidget::on_drag_data_received(): Error: Couldn't get path" << std::endl;
+  }
   else
-    {
-      get_document().object_add(m_document->get_sector_model().get_layer(path_), object);
-    }
+  {
+    get_document().object_add(m_document->get_sector_model().get_layer(path_), object);
+  }
 }
 
 void
@@ -524,14 +524,14 @@
   EditorWindow::current()->get_layer_manager().get_treeview().get_cursor(path_, focus_column);
 
   if (!path_.gobj())
-    {
-      std::cout << "WindstilleWidget::get_current_layer(): Error: Couldn't get path" << std::endl;
-      return LayerHandle();
-    }
+  {
+    std::cout << "WindstilleWidget::get_current_layer(): Error: Couldn't get path" << std::endl;
+    return LayerHandle();
+  }
   else
-    {
-      return m_document->get_sector_model().get_layer(path_);  
-    }
+  {
+    return m_document->get_sector_model().get_layer(path_);  
+  }
 }
 
 Gtk::TreeModel::Path
@@ -566,10 +566,10 @@
   Glib::RefPtr<Gdk::GL::Window> glwindow = get_gl_window();
 
   if (glwindow->gl_begin(get_gl_context()))
-    {
-      Display::save_screenshot(Pathname(filename_, Pathname::kSysPath));
-      glwindow->gl_end();
-    }
+  {
+    Display::save_screenshot(Pathname(filename_, Pathname::kSysPath));
+    glwindow->gl_end();
+  }
 }
 
 void

Modified: trunk/windstille/src/editor/zoom_tool.cpp
===================================================================
--- trunk/windstille/src/editor/zoom_tool.cpp	2009-09-10 14:43:49 UTC (rev 3217)
+++ trunk/windstille/src/editor/zoom_tool.cpp	2009-09-10 14:48:10 UTC (rev 3218)
@@ -33,38 +33,38 @@
 ZoomTool::mouse_down (GdkEventButton* event, WindstilleWidget& wst)
 {
   if (mode == NO_MODE)
-    {
-      mouse_pos = click_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
+  {
+    mouse_pos = click_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
 
-      mode = RECT_MODE;
+    mode = RECT_MODE;
 
-      wst.queue_draw();
-    }
+    wst.queue_draw();
+  }
 }
 
 void
 ZoomTool::mouse_move(GdkEventMotion* event, WindstilleWidget& wst)
 {
   if (mode == RECT_MODE)
-    {
-      mouse_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
-      wst.queue_draw();
-    }
+  {
+    mouse_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
+    wst.queue_draw();
+  }
 }
 
 void
 ZoomTool::mouse_up(GdkEventButton* /*event*/, WindstilleWidget& wst)
 {
   if (mode == RECT_MODE)
-    {
-      Rectf rect(click_pos, mouse_pos);
-      rect.normalize();
-      wst.get_state().zoom_to(rect);
+  {
+    Rectf rect(click_pos, mouse_pos);
+    rect.normalize();
+    wst.get_state().zoom_to(rect);
 
-      mode = NO_MODE;
+    mode = NO_MODE;
 
-      wst.queue_draw();
-    }
+    wst.queue_draw();
+  }
 }
 
 void
@@ -77,13 +77,13 @@
 ZoomTool::draw(SceneContext& sc)
 {
   if (mode == RECT_MODE)
-    {
-      Rectf rect(click_pos, mouse_pos);
-      rect.normalize();
+  {
+    Rectf rect(click_pos, mouse_pos);
+    rect.normalize();
 
-      sc.control().fill_rect(rect, Color(1.0f, 1.0f, 0.0f, 0.25));
-      sc.control().draw_rect(rect, Color(1.0f, 1.0f, 0.0f)); 
-    }
+    sc.control().fill_rect(rect, Color(1.0f, 1.0f, 0.0f, 0.25));
+    sc.control().draw_rect(rect, Color(1.0f, 1.0f, 0.0f)); 
+  }
 }
 
 /* EOF */



From grumbel at mail.berlios.de  Thu Sep 10 16:54:49 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 10 Sep 2009 16:54:49 +0200
Subject: [Windstille-commit] r3219 - trunk/windstille/src/editor
Message-ID: <200909101454.n8AEsn2T026518@sheep.berlios.de>

Author: grumbel
Date: 2009-09-10 16:54:49 +0200 (Thu, 10 Sep 2009)
New Revision: 3219

Modified:
   trunk/windstille/src/editor/decal_object_model.cpp
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/layer.cpp
   trunk/windstille/src/editor/layer_manager.cpp
   trunk/windstille/src/editor/layer_widget.cpp
   trunk/windstille/src/editor/navgraph_insert_tool.cpp
   trunk/windstille/src/editor/object_model.cpp
   trunk/windstille/src/editor/object_selector.cpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/select_tool.cpp
   trunk/windstille/src/editor/selection.cpp
   trunk/windstille/src/editor/windstille_widget.cpp
Log:
Auto reindented everything with emacs again to get rid of tabs

Modified: trunk/windstille/src/editor/decal_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.cpp	2009-09-10 14:48:10 UTC (rev 3218)
+++ trunk/windstille/src/editor/decal_object_model.cpp	2009-09-10 14:54:49 UTC (rev 3219)
@@ -223,7 +223,7 @@
       p.y = -p.y;
 
     return software_surface.is_at(static_cast<int>(p.x + surface.get_width()/2),
-				  static_cast<int>(p.y + surface.get_height()/2));
+                                  static_cast<int>(p.y + surface.get_height()/2));
   }
   else
   {

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-10 14:48:10 UTC (rev 3218)
+++ trunk/windstille/src/editor/document.cpp	2009-09-10 14:54:49 UTC (rev 3219)
@@ -229,13 +229,13 @@
       const Vector2f& center = m_selection->get_bounding_box().get_center();
       for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
       {
-	Vector2f pos = (*i)->get_world_pos();
+        Vector2f pos = (*i)->get_world_pos();
           
-	pos.y = center.y + (center.y - pos.y);
+        pos.y = center.y + (center.y - pos.y);
           
-	//(*i)->set_world_pos(pos);
-	group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_world_pos, *i, (*i)->get_world_pos()),
-							    boost::bind(&ObjectModel::set_world_pos, *i, pos))));
+        //(*i)->set_world_pos(pos);
+        group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_world_pos, *i, (*i)->get_world_pos()),
+                                                            boost::bind(&ObjectModel::set_world_pos, *i, pos))));
       }
     }
 
@@ -243,7 +243,7 @@
     {
       //(*i)->set_vflip(!(*i)->get_vflip());
       group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_vflip, *i,  (*i)->get_vflip()),
-							  boost::bind(&ObjectModel::set_vflip, *i, !(*i)->get_vflip()))));
+                                                          boost::bind(&ObjectModel::set_vflip, *i, !(*i)->get_vflip()))));
     }
 
     execute(group_command);
@@ -262,13 +262,13 @@
       const Vector2f& center = m_selection->get_bounding_box().get_center();
       for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
       {
-	Vector2f pos = (*i)->get_world_pos();
+        Vector2f pos = (*i)->get_world_pos();
           
-	pos.x = center.x + (center.x - pos.x);
+        pos.x = center.x + (center.x - pos.x);
           
-	//(*i)->set_world_pos(pos);
-	group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_world_pos, *i, (*i)->get_world_pos()),
-							    boost::bind(&ObjectModel::set_world_pos, *i, pos))));
+        //(*i)->set_world_pos(pos);
+        group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_world_pos, *i, (*i)->get_world_pos()),
+                                                            boost::bind(&ObjectModel::set_world_pos, *i, pos))));
       }
     }
 
@@ -276,7 +276,7 @@
     {
       //(*i)->set_hflip(!(*i)->get_hflip());
       group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_hflip, *i,  (*i)->get_hflip()),
-							  boost::bind(&ObjectModel::set_hflip, *i, !(*i)->get_hflip()))));
+                                                          boost::bind(&ObjectModel::set_hflip, *i, !(*i)->get_hflip()))));
     }
 
     execute(group_command);
@@ -298,7 +298,7 @@
     {
       //(*i)->set_parent(parent);
       group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_parent, *i, (*i)->get_parent(), true),
-							  boost::bind(&ObjectModel::set_parent, *i, parent, true))));
+                                                          boost::bind(&ObjectModel::set_parent, *i, parent, true))));
     }
 
     execute(group_command);
@@ -314,7 +314,7 @@
   {
     //(*i)->set_parent(ObjectModelHandle());
     group_command->add(CommandHandle(new FunctorCommand(boost::bind(&ObjectModel::set_parent, *i, (*i)->get_parent(), true),
-							boost::bind(&ObjectModel::set_parent, *i, ObjectModelHandle(), true))));
+                                                        boost::bind(&ObjectModel::set_parent, *i, ObjectModelHandle(), true))));
   }
 
   execute(group_command);
@@ -358,12 +358,12 @@
           
       if (it == parent_map.end())
       {
-	// When the parent wasn't part of the selection, leave
-	// the parent untouched
+        // When the parent wasn't part of the selection, leave
+        // the parent untouched
       }
       else
       {
-	(*i)->set_parent(it->second);
+        (*i)->set_parent(it->second);
       }
     }
   }
@@ -385,7 +385,7 @@
     {
       //decal->set_angle(0.0f);
       group_command->add(CommandHandle(new FunctorCommand(boost::bind(&DecalObjectModel::set_angle, decal, decal->get_angle()),
-							  boost::bind(&DecalObjectModel::set_angle, decal, 0.0f))));
+                                                          boost::bind(&DecalObjectModel::set_angle, decal, 0.0f))));
     }
   }
 
@@ -411,7 +411,7 @@
     {
       //decal->set_scale(Vector2f(1.0f, 1.0f));
       group_command->add(CommandHandle(new FunctorCommand(boost::bind(&DecalObjectModel::set_scale, decal, decal->get_scale()),
-							  boost::bind(&DecalObjectModel::set_scale, decal, Vector2f(1.0f, 1.0f)))));
+                                                          boost::bind(&DecalObjectModel::set_scale, decal, Vector2f(1.0f, 1.0f)))));
     }
   }
 

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-10 14:48:10 UTC (rev 3218)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-10 14:54:49 UTC (rev 3219)
@@ -540,7 +540,7 @@
   else
   {
     Gtk::FileChooserDialog dialog("Save File",
-				  Gtk::FILE_CHOOSER_ACTION_SAVE);
+                                  Gtk::FILE_CHOOSER_ACTION_SAVE);
     dialog.set_transient_for(*this);
     dialog.set_do_overwrite_confirmation(true);
 
@@ -558,27 +558,27 @@
     {
       case(Gtk::RESPONSE_OK):
       {
-	//std::cout << "Select clicked." << std::endl;
-	//std::cout << "Folder selected: " << dialog.get_filename()
-	//          << std::endl;
+        //std::cout << "Select clicked." << std::endl;
+        //std::cout << "Folder selected: " << dialog.get_filename()
+        //          << std::endl;
 
-	std::string filename = dialog.get_filename();
-	std::ofstream out(filename.c_str());
-	FileWriter writer(out);
+        std::string filename = dialog.get_filename();
+        std::ofstream out(filename.c_str());
+        FileWriter writer(out);
 
-	wst->get_document().get_sector_model().write(writer);
-	wst->set_filename(filename);
+        wst->get_document().get_sector_model().write(writer);
+        wst->set_filename(filename);
 
-	notebook.set_tab_label_text(*notebook.get_nth_page(page), Glib::path_get_basename(filename));
-	add_recent_file(filename);
-	print("Wrote: " + filename);
-	break;
+        notebook.set_tab_label_text(*notebook.get_nth_page(page), Glib::path_get_basename(filename));
+        add_recent_file(filename);
+        print("Wrote: " + filename);
+        break;
       }
 
       case(Gtk::RESPONSE_CANCEL):
       {
-	//std::cout << "Cancel clicked." << std::endl;
-	break;
+        //std::cout << "Cancel clicked." << std::endl;
+        break;
       }
     }
   }
@@ -597,7 +597,7 @@
     if (WindstilleWidget* wst = static_cast<WindstilleWidget*>(notebook.get_nth_page(page)))
     {
       Gtk::FileChooserDialog dialog("Save Screenshot",
-				    Gtk::FILE_CHOOSER_ACTION_SAVE);
+                                    Gtk::FILE_CHOOSER_ACTION_SAVE);
       dialog.set_transient_for(*this);
       dialog.set_do_overwrite_confirmation(true);
 
@@ -609,19 +609,19 @@
 
       switch(dialog.run())
       {
-	case(Gtk::RESPONSE_OK):
-	{
-	  std::string filename = dialog.get_filename();
-	  std::cout << "unimplemented screenshot: " << filename << std::endl;
-	  wst->save_screenshot(filename);
-	  break;
-	}
+        case(Gtk::RESPONSE_OK):
+        {
+          std::string filename = dialog.get_filename();
+          std::cout << "unimplemented screenshot: " << filename << std::endl;
+          wst->save_screenshot(filename);
+          break;
+        }
 
-	case(Gtk::RESPONSE_CANCEL):
-	{
-	  //std::cout << "Cancel clicked." << std::endl;
-	  break;
-	}
+        case(Gtk::RESPONSE_CANCEL):
+        {
+          //std::cout << "Cancel clicked." << std::endl;
+          break;
+        }
       }
     }
   }
@@ -858,8 +858,8 @@
   {
     //std::cout << "Play" << std::endl;
     timeout_connection = Glib::signal_timeout().connect(sigc::mem_fun(*this, &EditorWindow::on_timeout),
-							50,
-							Glib::PRIORITY_DEFAULT);
+                                                        50,
+                                                        Glib::PRIORITY_DEFAULT);
   }
   else
   {
@@ -927,7 +927,7 @@
       LayerHandle layer = wst->get_current_layer();
       for(Selection::reverse_iterator i = clipboard->rbegin(); i != clipboard->rend(); ++i)
       {
-	layer->add(*i);
+        layer->add(*i);
       }
 
       wst->get_document().set_selection(clipboard);

Modified: trunk/windstille/src/editor/layer.cpp
===================================================================
--- trunk/windstille/src/editor/layer.cpp	2009-09-10 14:48:10 UTC (rev 3218)
+++ trunk/windstille/src/editor/layer.cpp	2009-09-10 14:54:49 UTC (rev 3219)
@@ -95,7 +95,7 @@
   for(Objects::const_reverse_iterator i = objects.rbegin(); i != objects.rend(); ++i)
   {
     if (select_mask.match((*i)->get_select_mask()) &&
-	(*i)->is_at(pos))
+        (*i)->is_at(pos))
     {
       return *i;
     }
@@ -111,7 +111,7 @@
   for(Objects::const_reverse_iterator i = objects.rbegin(); i != objects.rend(); ++i)
   {
     if (select_mask.match((*i)->get_select_mask()) &&
-	rect.contains((*i)->get_bounding_box()))
+        rect.contains((*i)->get_bounding_box()))
     {
       selection->add(*i);
     }
@@ -209,7 +209,7 @@
   {
     // object is not in the list of objects to ignore
     if ((*i)->is_snappable() &&
-	ignore_objects.find(*i) == ignore_objects.end())
+        ignore_objects.find(*i) == ignore_objects.end())
     {
       SnapData snap = (*i)->snap_object(rect);
       best_snap.merge(snap);

Modified: trunk/windstille/src/editor/layer_manager.cpp
===================================================================
--- trunk/windstille/src/editor/layer_manager.cpp	2009-09-10 14:48:10 UTC (rev 3218)
+++ trunk/windstille/src/editor/layer_manager.cpp	2009-09-10 14:54:49 UTC (rev 3219)
@@ -147,9 +147,9 @@
       Gtk::TreeModel::iterator it = treeview.get_model()->get_iter(path_);
       if (it)
       {
-	EditorWindow::current()->on_lock_all(true);
-	(*it)[LayerManagerColumns::instance().locked] = false;
-	((LayerHandle)(*it)[LayerManagerColumns::instance().layer])->sync(*it);
+        EditorWindow::current()->on_lock_all(true);
+        (*it)[LayerManagerColumns::instance().locked] = false;
+        ((LayerHandle)(*it)[LayerManagerColumns::instance().layer])->sync(*it);
       }
     }
   }

Modified: trunk/windstille/src/editor/layer_widget.cpp
===================================================================
--- trunk/windstille/src/editor/layer_widget.cpp	2009-09-10 14:48:10 UTC (rev 3218)
+++ trunk/windstille/src/editor/layer_widget.cpp	2009-09-10 14:54:49 UTC (rev 3219)
@@ -34,24 +34,24 @@
     {
       if ((x+1) % 5)
       {
-	Gtk::ToggleButton* button = Gtk::manage(new Gtk::ToggleButton());
-	button->set_size_request(16, 16);
-	table.attach(*button, x, x+1, y, y+1);
+        Gtk::ToggleButton* button = Gtk::manage(new Gtk::ToggleButton());
+        button->set_size_request(16, 16);
+        table.attach(*button, x, x+1, y, y+1);
 
-	button->signal_toggled().connect(sigc::bind(sigc::mem_fun(*this, &LayerWidget::on_layer_toggle), 
-						    button, layer_number));
-	buttons.push_back(button);
-	layer_number += 1;
+        button->signal_toggled().connect(sigc::bind(sigc::mem_fun(*this, &LayerWidget::on_layer_toggle), 
+                                                    button, layer_number));
+        buttons.push_back(button);
+        layer_number += 1;
       }
       else
       {
-	if (y == 0)
-	{
-	  Gtk::VSeparator* separator = Gtk::manage(new Gtk::VSeparator());
-	  //Gtk::Widget* separator = Gtk::manage(new Gtk::Widget());
-	  separator->set_size_request(12, -1);
-	  table.attach(*separator, x, x+1, 0, 2);
-	}
+        if (y == 0)
+        {
+          Gtk::VSeparator* separator = Gtk::manage(new Gtk::VSeparator());
+          //Gtk::Widget* separator = Gtk::manage(new Gtk::Widget());
+          separator->set_size_request(12, -1);
+          table.attach(*separator, x, x+1, 0, 2);
+        }
       }
     }
 

Modified: trunk/windstille/src/editor/navgraph_insert_tool.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-10 14:48:10 UTC (rev 3218)
+++ trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-10 14:54:49 UTC (rev 3219)
@@ -210,7 +210,7 @@
   else if (mouse_over_edge)
   {
     sc.control().draw_line(mouse_over_edge->get_lhs()->get_world_pos(), 
-			   mouse_over_edge->get_rhs()->get_world_pos(), Color(1,1,1));
+                           mouse_over_edge->get_rhs()->get_world_pos(), Color(1,1,1));
   }
 }
   

Modified: trunk/windstille/src/editor/object_model.cpp
===================================================================
--- trunk/windstille/src/editor/object_model.cpp	2009-09-10 14:48:10 UTC (rev 3218)
+++ trunk/windstille/src/editor/object_model.cpp	2009-09-10 14:54:49 UTC (rev 3219)
@@ -212,33 +212,33 @@
 
       if (fabs(rect.top - in.top) < snap_threshold)
       {
-	y_snap = rect.top - in.top;
-	snap.y_set = true;
+        y_snap = rect.top - in.top;
+        snap.y_set = true;
       }
 
       if (fabs(rect.bottom - in.bottom) < snap_threshold)
       {
-	y_snap = rect.bottom - in.bottom;
-	snap.y_set = true;
+        y_snap = rect.bottom - in.bottom;
+        snap.y_set = true;
       }
 
       if (left_dist < right_dist)
       { // snap to left edge
-	if (left_dist < snap_threshold)
-	{
-	  snap.offset.x = rect.left - in.right;
-	  snap.offset.y = y_snap;
-	  snap.x_set = true;
-	}
+        if (left_dist < snap_threshold)
+        {
+          snap.offset.x = rect.left - in.right;
+          snap.offset.y = y_snap;
+          snap.x_set = true;
+        }
       }
       else
       { // snap to right edge
-	if (right_dist < snap_threshold)
-	{
-	  snap.offset.x = rect.right - in.left;
-	  snap.offset.y = y_snap;
-	  snap.x_set = true;
-	}
+        if (right_dist < snap_threshold)
+        {
+          snap.offset.x = rect.right - in.left;
+          snap.offset.y = y_snap;
+          snap.x_set = true;
+        }
       }
     }
   }
@@ -250,33 +250,33 @@
 
       if (fabs(rect.left - in.left) < snap_threshold)
       {
-	x_snap = rect.left - in.left;
-	snap.x_set = true;
+        x_snap = rect.left - in.left;
+        snap.x_set = true;
       }
 
       if (fabs(rect.right - in.right) < snap_threshold)
       {
-	x_snap = rect.right - in.right;
-	snap.x_set = true;
+        x_snap = rect.right - in.right;
+        snap.x_set = true;
       }
 
       if (top_dist < bottom_dist)
       { // snap to top edge
-	if (top_dist < snap_threshold)
-	{
-	  snap.offset.x = x_snap;
-	  snap.offset.y = rect.top - in.bottom;
-	  snap.y_set = true;
-	}
+        if (top_dist < snap_threshold)
+        {
+          snap.offset.x = x_snap;
+          snap.offset.y = rect.top - in.bottom;
+          snap.y_set = true;
+        }
       }
       else
       { // snap to bottom edge
-	if (bottom_dist < snap_threshold)
-	{
-	  snap.offset.x = x_snap;
-	  snap.offset.y = rect.bottom - in.top;
-	  snap.y_set = true;
-	}
+        if (bottom_dist < snap_threshold)
+        {
+          snap.offset.x = x_snap;
+          snap.offset.y = rect.bottom - in.top;
+          snap.y_set = true;
+        }
       }
     }      
   }

Modified: trunk/windstille/src/editor/object_selector.cpp
===================================================================
--- trunk/windstille/src/editor/object_selector.cpp	2009-09-10 14:48:10 UTC (rev 3218)
+++ trunk/windstille/src/editor/object_selector.cpp	2009-09-10 14:54:49 UTC (rev 3219)
@@ -215,13 +215,13 @@
 
       if (1)
       {
-	icon = Gdk::Pixbuf::create_from_file("data/editor/icon_bg.png");
-	size = std::max(icon->get_width(), icon->get_height());
+        icon = Gdk::Pixbuf::create_from_file("data/editor/icon_bg.png");
+        size = std::max(icon->get_width(), icon->get_height());
       }
       else
       {
-	icon = Gdk::Pixbuf::create(Gdk::COLORSPACE_RGB, true, 8, size, size);
-	icon->fill(0x444444ff);
+        icon = Gdk::Pixbuf::create(Gdk::COLORSPACE_RGB, true, 8, size, size);
+        icon->fill(0x444444ff);
       }
 
       // Scale pixbuf to icon size while keeping aspect ratio intact
@@ -229,31 +229,31 @@
       double y_scale = (double)size / pixbuf->get_height();
 
       if (x_scale * pixbuf->get_width() < min_size)
-	x_scale = min_size / pixbuf->get_width();
+        x_scale = min_size / pixbuf->get_width();
 
       if (y_scale * pixbuf->get_height() < min_size)
-	y_scale = min_size / pixbuf->get_height();
+        y_scale = min_size / pixbuf->get_height();
 
       if (pixbuf->get_width() > pixbuf->get_height())              
-	y_scale = x_scale;
+        y_scale = x_scale;
       else
-	x_scale = y_scale;
+        x_scale = y_scale;
 
       int r_w = int(pixbuf->get_width() * x_scale);
       int r_h = int(pixbuf->get_height() * y_scale);
 
       pixbuf->composite(icon, 
-			(size - r_w)/2, (size - r_h)/2,
-			r_w, r_h,
-			(size - r_w)/2, (size - r_h)/2,
-			x_scale, y_scale,
-			Gdk::INTERP_TILES, 
-			255);
+                        (size - r_w)/2, (size - r_h)/2,
+                        r_w, r_h,
+                        (size - r_w)/2, (size - r_h)/2,
+                        x_scale, y_scale,
+                        Gdk::INTERP_TILES, 
+                        255);
     }
 
     add_decal(icon, *i, 
-	      "file:///home/ingo/projects/windstille/trunk/windstille/" + *i, 
-	      filter_);
+              "file:///home/ingo/projects/windstille/trunk/windstille/" + *i, 
+              filter_);
   }
 }
 
@@ -307,8 +307,8 @@
     if (WindstilleWidget* wst = EditorWindow::current()->get_windstille_widget())
     {
       pixbuf = pixbuf->scale_simple(std::max(4, int(static_cast<float>(pixbuf->get_width())  * wst->get_state().get_zoom())),
-				    std::max(4, int(static_cast<float>(pixbuf->get_height()) * wst->get_state().get_zoom())),
-				    Gdk::INTERP_TILES);
+                                    std::max(4, int(static_cast<float>(pixbuf->get_height()) * wst->get_state().get_zoom())),
+                                    Gdk::INTERP_TILES);
     }
     context->set_icon(pixbuf, pixbuf->get_width()/2, pixbuf->get_height()/2);
   }

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-10 14:48:10 UTC (rev 3218)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-10 14:54:49 UTC (rev 3219)
@@ -646,11 +646,11 @@
         if (edge)
         {
           /*
-	    if (edge.get_lhs().get() == &node ||
-	    edge.get_rhs().get() == &node)
-	    {
+            if (edge.get_lhs().get() == &node ||
+            edge.get_rhs().get() == &node)
+            {
 
-	    }
+            }
           */
         }
       }

Modified: trunk/windstille/src/editor/select_tool.cpp
===================================================================
--- trunk/windstille/src/editor/select_tool.cpp	2009-09-10 14:48:10 UTC (rev 3218)
+++ trunk/windstille/src/editor/select_tool.cpp	2009-09-10 14:54:49 UTC (rev 3219)
@@ -57,29 +57,29 @@
     {
       if (wst.get_document().get_selection()->has_object(object))
       {
-	selection = wst.get_document().get_selection();
-	if (event->state & GDK_SHIFT_MASK)
-	{
-	  selection->remove(object);
-	}
-	else
-	{
-	  selection = wst.get_document().get_selection();
-	}
+        selection = wst.get_document().get_selection();
+        if (event->state & GDK_SHIFT_MASK)
+        {
+          selection->remove(object);
+        }
+        else
+        {
+          selection = wst.get_document().get_selection();
+        }
       }
       else
       {
-	if (event->state & GDK_SHIFT_MASK)
-	{
-	  selection = wst.get_document().get_selection();
-	  selection->add(object);
-	}
-	else
-	{
-	  selection = Selection::create();
-	  selection->add(object);
-	  wst.get_document().set_selection(selection);
-	}
+        if (event->state & GDK_SHIFT_MASK)
+        {
+          selection = wst.get_document().get_selection();
+          selection->add(object);
+        }
+        else
+        {
+          selection = Selection::create();
+          selection->add(object);
+          wst.get_document().set_selection(selection);
+        }
       }
       
       mode = OBJECT_DRAG_MODE;
@@ -110,7 +110,7 @@
     for(Layer::iterator i = wst.get_current_layer()->begin(); i != wst.get_current_layer()->end(); ++i)
     { // FIXME: Should iterate over all objects, not just objects in the current layer
       if (!wst.get_select_mask().match((*i)->get_select_mask()))
-	ignore_objects.insert(*i);
+        ignore_objects.insert(*i);
     }
   }
 
@@ -140,16 +140,16 @@
     Vector2f offset = pos - click_pos;
           
     if ((event->time - start_time) > MOVE_TIMEOUT ||
-	offset.length() > MOVE_THRESHOLD)
+        offset.length() > MOVE_THRESHOLD)
     {
       if (!selection->is_moving())
-	selection->on_move_start();
+        selection->on_move_start();
 
       selection->on_move_update(offset);
       
       if (event->state & GDK_CONTROL_MASK)
       {
-	selection->on_move_update(offset + process_snap(wst));
+        selection->on_move_update(offset + process_snap(wst));
       }
 
       wst.queue_draw();
@@ -183,17 +183,17 @@
     Vector2f offset = pos - click_pos;
 
     if (event->time - start_time > MOVE_TIMEOUT ||
-	offset.length() > MOVE_THRESHOLD)
+        offset.length() > MOVE_THRESHOLD)
     {
       selection->on_move_update(offset);
       
       if (event->state & GDK_CONTROL_MASK)
       {
-	selection->on_move_end(wst, offset + process_snap(wst));
+        selection->on_move_end(wst, offset + process_snap(wst));
       }
       else
       {
-	selection->on_move_end(wst, offset);
+        selection->on_move_end(wst, offset);
       }
       wst.queue_draw();
     }

Modified: trunk/windstille/src/editor/selection.cpp
===================================================================
--- trunk/windstille/src/editor/selection.cpp	2009-09-10 14:48:10 UTC (rev 3218)
+++ trunk/windstille/src/editor/selection.cpp	2009-09-10 14:54:49 UTC (rev 3219)
@@ -173,12 +173,12 @@
           
       if (it == parent_map.end())
       {
-	// When the parent wasn't part of the selection, leave
-	// the parent untouched
+        // When the parent wasn't part of the selection, leave
+        // the parent untouched
       }
       else
       {
-	(*i)->set_parent(it->second);
+        (*i)->set_parent(it->second);
       }
     }
   }

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-10 14:48:10 UTC (rev 3218)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-10 14:54:49 UTC (rev 3219)
@@ -150,9 +150,9 @@
       lib_init = true;
       GLenum err = glewInit();
       if(err != GLEW_OK) {
-	std::ostringstream msg;
-	msg << "Display:: Couldn't initialize glew: " << glewGetString(err);
-	throw std::runtime_error(msg.str());
+        std::ostringstream msg;
+        msg << "Display:: Couldn't initialize glew: " << glewGetString(err);
+        throw std::runtime_error(msg.str());
       }
 
       OpenGLState::init();
@@ -162,7 +162,7 @@
     {
       sc.reset(new SceneContext());
       compositor.reset(new Compositor(Size(get_width(), get_height()),
-				      Size(get_width(), get_height())));
+                                      Size(get_width(), get_height())));
       sc->set_render_mask(sc->get_render_mask() & ~SceneContext::LIGHTMAP);
     }
       
@@ -198,7 +198,7 @@
     if (compositor.get())
     {
       compositor.reset(new Compositor(Size(ev->width, ev->height),
-				      Size(ev->width, ev->height)));
+                                      Size(ev->width, ev->height)));
     }
 
     glViewport(0, 0, get_width(), get_height());
@@ -260,7 +260,7 @@
     if (draw_background_pattern)
     {
       sc->color().fill_pattern(background_pattern, 
-			       state.get_offset() * state.get_zoom());
+                               state.get_offset() * state.get_zoom());
     }
     else
     {
@@ -276,14 +276,14 @@
     {
       for(Selection::iterator i = m_document->get_selection()->begin(); i != m_document->get_selection()->end(); ++i)
       {
-	(*i)->draw_select(*sc, i == m_document->get_selection()->begin());
+        (*i)->draw_select(*sc, i == m_document->get_selection()->begin());
       }
 
       //sc->control().draw_rect(selection->get_bounding_box(), Color(1.0f, 1.0f, 1.0f, 1.0f));
     }
 
     for(std::vector<ControlPointHandle>::const_iterator i = m_document->get_control_points().begin();
-	i != m_document->get_control_points().end(); ++i)
+        i != m_document->get_control_points().end(); ++i)
     {
       (*i)->draw(*sc);
     }
@@ -300,7 +300,7 @@
     if (grid_enabled)
     {
       Display::draw_grid(state.get_offset() * state.get_zoom(),
-			 Sizef(128.0f * state.get_zoom(), 128.0f * state.get_zoom()), Color(1,1,1,0.5f));
+                         Sizef(128.0f * state.get_zoom(), 128.0f * state.get_zoom()), Color(1,1,1,0.5f));
     }
   }
 }



From grumbel at mail.berlios.de  Thu Sep 10 20:27:22 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 10 Sep 2009 20:27:22 +0200
Subject: [Windstille-commit] r3220 - trunk/windstille/src/editor
Message-ID: <200909101827.n8AIRMcO030982@sheep.berlios.de>

Author: grumbel
Date: 2009-09-10 20:27:22 +0200 (Thu, 10 Sep 2009)
New Revision: 3220

Added:
   trunk/windstille/src/editor/navgraph_commands.hpp
Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/navgraph_insert_tool.cpp
   trunk/windstille/src/editor/navigation_graph_model.cpp
   trunk/windstille/src/editor/navigation_graph_model.hpp
Log:
Added some NavGraphCommands (not yet implemented)

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-10 14:54:49 UTC (rev 3219)
+++ trunk/windstille/src/editor/document.cpp	2009-09-10 18:27:22 UTC (rev 3220)
@@ -28,10 +28,11 @@
 #include "editor/decal_object_model.hpp"
 #include "editor/navgraph_edge_object_model.hpp"
 
+#include "editor/functor_command.hpp"
 #include "editor/group_command.hpp"
+#include "editor/layer_commands.hpp"
+#include "editor/navgraph_commands.hpp"
 #include "editor/object_commands.hpp"
-#include "editor/functor_command.hpp"
-#include "editor/layer_commands.hpp"
 
 Document::Document()
   : m_undo_manager(new UndoManager()),
@@ -134,11 +135,13 @@
 void
 Document::navgraph_node_add(boost::shared_ptr<NavGraphNodeObjectModel> node)
 {
+  execute(CommandHandle(new NavGraphNodeAddCommand(node)));
 }
 
 void
 Document::navgraph_node_remove(boost::shared_ptr<NavGraphNodeObjectModel> node)
 {
+  execute(CommandHandle(new NavGraphNodeRemoveCommand(node)));
 }
 
 void
@@ -146,13 +149,13 @@
                             boost::shared_ptr<NavGraphNodeObjectModel> lhs,
                             boost::shared_ptr<NavGraphNodeObjectModel> rhs)
 {
-  boost::shared_ptr<NavGraphEdgeObjectModel> edge_obj(new NavGraphEdgeObjectModel(lhs, rhs)); //, *m_sector_model));
-  object_add(layer, edge_obj);
+  execute(CommandHandle(new NavGraphEdgeAddCommand(layer, lhs, rhs)));
 }
 
 void
 Document::navgraph_edge_remove(boost::shared_ptr<NavGraphEdgeObjectModel> edge)
 {
+  execute(CommandHandle(new NavGraphEdgeRemoveCommand(edge)));
 }
 
 void

Added: trunk/windstille/src/editor/navgraph_commands.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_commands.hpp	2009-09-10 14:54:49 UTC (rev 3219)
+++ trunk/windstille/src/editor/navgraph_commands.hpp	2009-09-10 18:27:22 UTC (rev 3220)
@@ -0,0 +1,108 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_EDITOR_NAVGRAPH_COMMANDS_HPP
+#define HEADER_WINDSTILLE_EDITOR_NAVGRAPH_COMMANDS_HPP
+
+#include "editor/command.hpp"
+
+class NavGraphNodeAddCommand : public Command
+{
+private:
+  boost::shared_ptr<NavGraphNodeObjectModel> m_node;
+
+public:
+  NavGraphNodeAddCommand(boost::shared_ptr<NavGraphNodeObjectModel> node)
+    : m_node(node)
+  {}
+
+  void redo() 
+  {
+  }
+
+  void undo() 
+  {
+  }
+};
+
+class NavGraphNodeRemoveCommand : public Command
+{
+private:
+  boost::shared_ptr<NavGraphNodeObjectModel> m_node;
+
+public:
+  NavGraphNodeRemoveCommand(boost::shared_ptr<NavGraphNodeObjectModel> node)
+    : m_node(node)
+  {}
+
+  void redo() 
+  {
+  }
+
+  void undo() 
+  {
+  }
+};
+
+class NavGraphEdgeAddCommand : public Command
+{
+private:
+  LayerHandle m_layer;
+  boost::shared_ptr<NavGraphNodeObjectModel> m_lhs;
+  boost::shared_ptr<NavGraphNodeObjectModel> m_rhs;
+
+public:
+  NavGraphEdgeAddCommand(LayerHandle layer, 
+                         boost::shared_ptr<NavGraphNodeObjectModel> lhs,
+                         boost::shared_ptr<NavGraphNodeObjectModel> rhs)
+    : m_layer(layer),
+      m_lhs(lhs),
+      m_rhs(rhs)
+  {}
+
+  void redo() 
+  {
+  }
+
+  void undo() 
+  {
+  }
+};
+
+class NavGraphEdgeRemoveCommand : public Command
+{
+private:
+  boost::shared_ptr<NavGraphEdgeObjectModel> m_edge;
+
+public:
+  NavGraphEdgeRemoveCommand(boost::shared_ptr<NavGraphEdgeObjectModel> edge)
+    : m_edge(edge)
+  {}
+
+  void redo() 
+  {
+  }
+
+  void undo() 
+  {
+  }
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/navgraph_commands.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/editor/navgraph_insert_tool.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-10 14:54:49 UTC (rev 3219)
+++ trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-10 18:27:22 UTC (rev 3220)
@@ -42,7 +42,6 @@
 {
   mouse_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
   NavigationGraphModel& navgraph = wst.get_document().get_sector_model().get_nav_graph();
-  //SectorModel& sector = wst.get_document().get_sector_model();
 
   boost::shared_ptr<NavGraphNodeObjectModel> node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
   boost::shared_ptr<NavGraphEdgeObjectModel> edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
@@ -54,8 +53,9 @@
       if (node)
       { // connect last node with existing node
         wst.get_document().navgraph_edge_add(wst.get_current_layer(), last_node, node);
-        last_node = boost::shared_ptr<NavGraphNodeObjectModel>();
-        connection_node = boost::shared_ptr<NavGraphNodeObjectModel>();
+
+        last_node.reset();
+        connection_node.reset();
       }
       else
       { // connect last node with newly created node
@@ -68,7 +68,8 @@
         wst.get_document().undo_group_end();
 
         node = node_obj;
-        last_node = boost::shared_ptr<NavGraphNodeObjectModel>();
+
+        last_node.reset();
       }
       mode = NO_MODE;
     }
@@ -83,7 +84,8 @@
       }
       else if (edge)
       {
-        navgraph.remove_edge(edge);
+        wst.get_document().navgraph_edge_remove(edge);
+
         mode = NO_MODE;
       }
       else
@@ -107,7 +109,8 @@
   mouse_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
 
   {
-    boost::shared_ptr<NavGraphNodeObjectModel> new_mouse_over_node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
+    // FIXME: Radius should scale with zoom
+    boost::shared_ptr<NavGraphNodeObjectModel> new_mouse_over_node = navgraph.find_closest_node(mouse_pos, 16.0f);
     boost::shared_ptr<NavGraphEdgeObjectModel> new_mouse_over_edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
 
     if (new_mouse_over_node != mouse_over_node ||
@@ -136,7 +139,6 @@
 NavgraphInsertTool::mouse_up(GdkEventButton* event, WindstilleWidget& wst)
 {
   mouse_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
-  //NavigationGraphModel& navgraph = *wst.get_sector_model().get_nav_graph();
 
   switch(mode)
   {
@@ -154,28 +156,25 @@
 NavgraphInsertTool::mouse_right_down(GdkEventButton* /*event*/, WindstilleWidget& wst)
 {
   NavigationGraphModel& navgraph = wst.get_document().get_sector_model().get_nav_graph();
-  //SectorModel& sector = wst.get_document().get_sector_model();
 
   boost::shared_ptr<NavGraphNodeObjectModel> node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
   boost::shared_ptr<NavGraphEdgeObjectModel> edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
 
   if (node)
   {
-    //navgraph.remove_node(node);
-    wst.get_document().object_remove(node);
+    wst.get_document().navgraph_node_remove(node);
 
-    mouse_over_edge = boost::shared_ptr<NavGraphEdgeObjectModel>();
-    mouse_over_node = boost::shared_ptr<NavGraphNodeObjectModel>();
+    mouse_over_edge.reset();
+    mouse_over_node.reset();
 
     wst.queue_draw();
   }
   else if (edge)
   {
-    //navgraph.remove_edge(edge);
-    wst.get_document().object_remove(edge);
+    wst.get_document().navgraph_edge_remove(edge);
 
-    mouse_over_edge = boost::shared_ptr<NavGraphEdgeObjectModel>();
-    mouse_over_node = boost::shared_ptr<NavGraphNodeObjectModel>();
+    mouse_over_edge.reset();
+    mouse_over_node.reset();
 
     wst.queue_draw();
   }

Modified: trunk/windstille/src/editor/navigation_graph_model.cpp
===================================================================
--- trunk/windstille/src/editor/navigation_graph_model.cpp	2009-09-10 14:54:49 UTC (rev 3219)
+++ trunk/windstille/src/editor/navigation_graph_model.cpp	2009-09-10 18:27:22 UTC (rev 3220)
@@ -50,6 +50,17 @@
   return edge;
 }
 
+void
+NavigationGraphModel::add_node(boost::shared_ptr<NavGraphNodeObjectModel> node)
+{
+  nodes.push_back(node);
+}
+
+void
+NavigationGraphModel::add_edge(boost::shared_ptr<NavGraphEdgeObjectModel> edge)
+{
+  edges.push_back(edge);
+}
   
 void
 NavigationGraphModel::remove_node(boost::shared_ptr<NavGraphNodeObjectModel> node)
@@ -77,6 +88,8 @@
     }
   }
 
+  std::cout << "find_closest_node: " << nodes.size() << " " << node.get() << std::endl;
+
   return node;
 }
 

Modified: trunk/windstille/src/editor/navigation_graph_model.hpp
===================================================================
--- trunk/windstille/src/editor/navigation_graph_model.hpp	2009-09-10 14:54:49 UTC (rev 3219)
+++ trunk/windstille/src/editor/navigation_graph_model.hpp	2009-09-10 18:27:22 UTC (rev 3220)
@@ -44,6 +44,9 @@
   boost::shared_ptr<NavGraphNodeObjectModel> create_node(const Vector2f& pos);
   boost::shared_ptr<NavGraphEdgeObjectModel> create_edge(boost::shared_ptr<NavGraphNodeObjectModel> lhs, 
                                                          boost::shared_ptr<NavGraphNodeObjectModel> rhs);
+
+  void add_node(boost::shared_ptr<NavGraphNodeObjectModel> node);
+  void add_edge(boost::shared_ptr<NavGraphEdgeObjectModel> edge);
   
   void remove_node(boost::shared_ptr<NavGraphNodeObjectModel> node);
   void remove_edge(boost::shared_ptr<NavGraphEdgeObjectModel> edge);



From grumbel at mail.berlios.de  Fri Sep 11 01:30:40 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 11 Sep 2009 01:30:40 +0200
Subject: [Windstille-commit] r3221 - trunk/windstille/src/editor
Message-ID: <200909102330.n8ANUex3006074@sheep.berlios.de>

Author: grumbel
Date: 2009-09-11 01:30:39 +0200 (Fri, 11 Sep 2009)
New Revision: 3221

Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/navgraph_commands.hpp
   trunk/windstille/src/editor/navgraph_edge_object_model.cpp
   trunk/windstille/src/editor/navgraph_edge_object_model.hpp
   trunk/windstille/src/editor/navgraph_insert_tool.cpp
   trunk/windstille/src/editor/navgraph_node_object_model.cpp
   trunk/windstille/src/editor/navgraph_node_object_model.hpp
   trunk/windstille/src/editor/navigation_graph_model.cpp
   trunk/windstille/src/editor/navigation_graph_model.hpp
   trunk/windstille/src/editor/object_commands.hpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
Log:
Some more NavGraph work

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-10 18:27:22 UTC (rev 3220)
+++ trunk/windstille/src/editor/document.cpp	2009-09-10 23:30:39 UTC (rev 3221)
@@ -135,13 +135,13 @@
 void
 Document::navgraph_node_add(boost::shared_ptr<NavGraphNodeObjectModel> node)
 {
-  execute(CommandHandle(new NavGraphNodeAddCommand(node)));
+  execute(CommandHandle(new NavGraphNodeAddCommand(*m_sector_model, node)));
 }
 
 void
 Document::navgraph_node_remove(boost::shared_ptr<NavGraphNodeObjectModel> node)
 {
-  execute(CommandHandle(new NavGraphNodeRemoveCommand(node)));
+  execute(CommandHandle(new NavGraphNodeRemoveCommand(*m_sector_model, node)));
 }
 
 void
@@ -149,13 +149,14 @@
                             boost::shared_ptr<NavGraphNodeObjectModel> lhs,
                             boost::shared_ptr<NavGraphNodeObjectModel> rhs)
 {
-  execute(CommandHandle(new NavGraphEdgeAddCommand(layer, lhs, rhs)));
+  boost::shared_ptr<NavGraphEdgeObjectModel> edge(new NavGraphEdgeObjectModel(lhs, rhs));
+  execute(CommandHandle(new NavGraphEdgeAddCommand(*m_sector_model, layer, edge)));
 }
 
 void
 Document::navgraph_edge_remove(boost::shared_ptr<NavGraphEdgeObjectModel> edge)
 {
-  execute(CommandHandle(new NavGraphEdgeRemoveCommand(edge)));
+  execute(CommandHandle(new NavGraphEdgeRemoveCommand(*m_sector_model, edge)));
 }
 
 void

Modified: trunk/windstille/src/editor/navgraph_commands.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_commands.hpp	2009-09-10 18:27:22 UTC (rev 3220)
+++ trunk/windstille/src/editor/navgraph_commands.hpp	2009-09-10 23:30:39 UTC (rev 3221)
@@ -19,87 +19,122 @@
 #ifndef HEADER_WINDSTILLE_EDITOR_NAVGRAPH_COMMANDS_HPP
 #define HEADER_WINDSTILLE_EDITOR_NAVGRAPH_COMMANDS_HPP
 
+#include <iostream>
+
 #include "editor/command.hpp"
+#include "editor/navigation_graph_model.hpp"
 
 class NavGraphNodeAddCommand : public Command
 {
 private:
+  SectorModel& m_sector;
   boost::shared_ptr<NavGraphNodeObjectModel> m_node;
 
 public:
-  NavGraphNodeAddCommand(boost::shared_ptr<NavGraphNodeObjectModel> node)
-    : m_node(node)
+  NavGraphNodeAddCommand(SectorModel& sector, 
+                         boost::shared_ptr<NavGraphNodeObjectModel> node)
+    : m_sector(sector),
+      m_node(node)
   {}
 
   void redo() 
   {
+    m_sector.get_nav_graph().add_node(m_node);
   }
 
   void undo() 
   {
+    m_sector.get_nav_graph().remove_node(m_node);
   }
 };
 
 class NavGraphNodeRemoveCommand : public Command
 {
 private:
+  SectorModel& m_sector;
   boost::shared_ptr<NavGraphNodeObjectModel> m_node;
 
 public:
-  NavGraphNodeRemoveCommand(boost::shared_ptr<NavGraphNodeObjectModel> node)
-    : m_node(node)
+  NavGraphNodeRemoveCommand(SectorModel& sector, 
+                            boost::shared_ptr<NavGraphNodeObjectModel> node)
+    : m_sector(sector),
+      m_node(node)
   {}
 
   void redo() 
   {
+    m_sector.get_nav_graph().remove_node(m_node);
   }
 
   void undo() 
   {
+    m_sector.get_nav_graph().add_node(m_node);
   }
 };
 
 class NavGraphEdgeAddCommand : public Command
 {
 private:
+  SectorModel& m_sector;
   LayerHandle m_layer;
-  boost::shared_ptr<NavGraphNodeObjectModel> m_lhs;
-  boost::shared_ptr<NavGraphNodeObjectModel> m_rhs;
+  boost::shared_ptr<NavGraphEdgeObjectModel> m_edge;
 
 public:
-  NavGraphEdgeAddCommand(LayerHandle layer, 
-                         boost::shared_ptr<NavGraphNodeObjectModel> lhs,
-                         boost::shared_ptr<NavGraphNodeObjectModel> rhs)
-    : m_layer(layer),
-      m_lhs(lhs),
-      m_rhs(rhs)
+  NavGraphEdgeAddCommand(SectorModel& sector, 
+                         LayerHandle layer, 
+                         boost::shared_ptr<NavGraphEdgeObjectModel> edge)
+    : m_sector(sector),
+      m_layer(layer),
+      m_edge(edge)
   {}
 
   void redo() 
   {
+    if (m_layer)
+      m_layer->add(m_edge);
+    else
+      std::cout << "NavGraphEdgeAddCommand: null layer" << std::endl;
+
+    m_sector.get_nav_graph().add_edge(m_edge);
   }
 
   void undo() 
   {
+    m_sector.get_nav_graph().remove_edge(m_edge);
+    m_layer->remove(m_edge);
   }
 };
 
 class NavGraphEdgeRemoveCommand : public Command
 {
 private:
+  SectorModel& m_sector;
+  LayerHandle m_layer;
   boost::shared_ptr<NavGraphEdgeObjectModel> m_edge;
 
 public:
-  NavGraphEdgeRemoveCommand(boost::shared_ptr<NavGraphEdgeObjectModel> edge)
-    : m_edge(edge)
+  NavGraphEdgeRemoveCommand(SectorModel& sector, 
+                            boost::shared_ptr<NavGraphEdgeObjectModel> edge)
+    : m_sector(sector),
+      m_layer(sector.get_layer(edge)),
+      m_edge(edge)
   {}
 
   void redo() 
   {
+    if (m_layer)
+      m_layer->remove(m_edge);
+    else
+      std::cout << "NavGraphEdgeRemoveCommand: null layer" << std::endl;
+
+    m_sector.get_nav_graph().remove_edge(m_edge);
   }
 
   void undo() 
   {
+    m_sector.get_nav_graph().add_edge(m_edge);
+    if (m_layer) 
+      m_layer->add(m_edge);
   }
 };
 

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-10 18:27:22 UTC (rev 3220)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-10 23:30:39 UTC (rev 3221)
@@ -25,12 +25,10 @@
 
 NavGraphEdgeObjectModel::NavGraphEdgeObjectModel(boost::shared_ptr<NavGraphNodeObjectModel> lhs,
                                                  boost::shared_ptr<NavGraphNodeObjectModel> rhs)
-  //SectorModel& sector)
   : ObjectModel("NavGraphEdgeObjectModel", Vector2f()),
     m_lhs(lhs),
     m_rhs(rhs),
-    m_drawable(),
-    m_edge()
+    m_drawable()
 {
   //m_edge = sector.get_nav_graph().add_edge(m_lhs->get_node(), m_rhs->get_node());
 }

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-10 18:27:22 UTC (rev 3220)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-10 23:30:39 UTC (rev 3221)
@@ -31,7 +31,6 @@
   boost::shared_ptr<NavGraphNodeObjectModel> m_lhs;
   boost::shared_ptr<NavGraphNodeObjectModel> m_rhs;
   boost::shared_ptr<VertexArrayDrawable> m_drawable;
-  EdgeHandle m_edge;
 
 public:
   NavGraphEdgeObjectModel(boost::shared_ptr<NavGraphNodeObjectModel> lhs,
@@ -45,8 +44,6 @@
   ObjectModelHandle clone() const;
   void write(FileWriter& writer) const;
 
-  EdgeHandle get_edge() const { return m_edge; }
-
   boost::shared_ptr<NavGraphNodeObjectModel> get_lhs() const { return m_lhs; }
   boost::shared_ptr<NavGraphNodeObjectModel> get_rhs() const { return m_rhs; }
 

Modified: trunk/windstille/src/editor/navgraph_insert_tool.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-10 18:27:22 UTC (rev 3220)
+++ trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-10 23:30:39 UTC (rev 3221)
@@ -24,6 +24,7 @@
 #include "navigation/edge.hpp"
 #include "editor/windstille_widget.hpp"
 #include "editor/editor_window.hpp"
+#include "editor/navigation_graph_model.hpp"
 #include "editor/navgraph_node_object_model.hpp"
 #include "editor/navgraph_edge_object_model.hpp"
 
@@ -43,7 +44,8 @@
   mouse_pos = wst.get_state().screen_to_world(Vector2f(static_cast<float>(event->x), static_cast<float>(event->y)));
   NavigationGraphModel& navgraph = wst.get_document().get_sector_model().get_nav_graph();
 
-  boost::shared_ptr<NavGraphNodeObjectModel> node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
+  // FIXME: Radius should scale with zoom
+  boost::shared_ptr<NavGraphNodeObjectModel> node = navgraph.find_closest_node(mouse_pos, 16.0f); 
   boost::shared_ptr<NavGraphEdgeObjectModel> edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
 
   switch(mode)
@@ -59,16 +61,15 @@
       }
       else
       { // connect last node with newly created node
-        // FIXME: Make this a GroupCommand
-        boost::shared_ptr<NavGraphNodeObjectModel> node_obj(new NavGraphNodeObjectModel(mouse_pos)); //, sector));
+        std::cout << "Node Group" << std::endl;
+        boost::shared_ptr<NavGraphNodeObjectModel> node_obj(new NavGraphNodeObjectModel(mouse_pos));
         
         wst.get_document().undo_group_begin();
-        wst.get_document().object_add(wst.get_document().get_sector_model().get_navgraph_layer(), node_obj);
+        wst.get_document().navgraph_node_add(node_obj);
         wst.get_document().navgraph_edge_add(wst.get_current_layer(), last_node, node_obj);
         wst.get_document().undo_group_end();
 
         node = node_obj;
-
         last_node.reset();
       }
       mode = NO_MODE;
@@ -85,14 +86,17 @@
       else if (edge)
       {
         wst.get_document().navgraph_edge_remove(edge);
-
+        
+        edge.reset();
         mode = NO_MODE;
       }
       else
       {
         boost::shared_ptr<NavGraphNodeObjectModel> node_obj(new NavGraphNodeObjectModel(mouse_pos));//, sector));
+
+        wst.get_document().navgraph_node_add(node_obj);
+
         last_node = node_obj;
-        wst.get_document().object_add(wst.get_document().get_sector_model().get_navgraph_layer(), node_obj);
         mode = EDGE_MODE;
       }
     }

Modified: trunk/windstille/src/editor/navgraph_node_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-10 18:27:22 UTC (rev 3220)
+++ trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-10 23:30:39 UTC (rev 3221)
@@ -25,10 +25,8 @@
 
 NavGraphNodeObjectModel::NavGraphNodeObjectModel(const Vector2f& pos)//, SectorModel& sector)
   : ObjectModel("NavGraphNodeObjectModel", pos),
-    m_drawable(),
-    m_node()
+    m_drawable()
 {
-  //m_node = sector.get_nav_graph().add_node(pos);
 }
 
 NavGraphNodeObjectModel::~NavGraphNodeObjectModel()
@@ -70,7 +68,6 @@
 NavGraphNodeObjectModel::set_rel_pos(const Vector2f& rel_pos_)
 {
   ObjectModel::set_rel_pos(rel_pos_);
-  m_node->set_pos(get_world_pos());
 }
 
 Rectf

Modified: trunk/windstille/src/editor/navgraph_node_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-10 18:27:22 UTC (rev 3220)
+++ trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-10 23:30:39 UTC (rev 3221)
@@ -30,7 +30,6 @@
 {
 private:
   boost::shared_ptr<VertexArrayDrawable> m_drawable;
-  NodeHandle m_node;
 
 public:
   NavGraphNodeObjectModel(const Vector2f& pos);//, SectorModel& sector);
@@ -40,8 +39,6 @@
   void set_rel_pos(const Vector2f& rel_pos_);
   void sync_drawable();
   
-  NodeHandle get_node() const { return m_node; }
-
   Rectf get_bounding_box() const;
   ObjectModelHandle clone() const;
   void write(FileWriter& writer) const;

Modified: trunk/windstille/src/editor/navigation_graph_model.cpp
===================================================================
--- trunk/windstille/src/editor/navigation_graph_model.cpp	2009-09-10 18:27:22 UTC (rev 3220)
+++ trunk/windstille/src/editor/navigation_graph_model.cpp	2009-09-10 23:30:39 UTC (rev 3221)
@@ -24,8 +24,8 @@
 #include "navigation/navigation_graph.hpp"
 
 NavigationGraphModel::NavigationGraphModel()
-  : nodes(),
-    edges()   
+  : m_nodes(),
+    m_edges()   
 {
 }
 
@@ -37,7 +37,7 @@
 NavigationGraphModel::create_node(const Vector2f& pos)
 {
   boost::shared_ptr<NavGraphNodeObjectModel> node(new NavGraphNodeObjectModel(pos));
-  nodes.push_back(node);
+  m_nodes.push_back(node);
   return node;
 }
 
@@ -46,30 +46,49 @@
                                   boost::shared_ptr<NavGraphNodeObjectModel> rhs)
 {
   boost::shared_ptr<NavGraphEdgeObjectModel> edge(new NavGraphEdgeObjectModel(lhs, rhs));
-  edges.push_back(edge);
+  m_edges.push_back(edge);
   return edge;
 }
 
 void
 NavigationGraphModel::add_node(boost::shared_ptr<NavGraphNodeObjectModel> node)
 {
-  nodes.push_back(node);
+  m_nodes.push_back(node);
 }
 
 void
 NavigationGraphModel::add_edge(boost::shared_ptr<NavGraphEdgeObjectModel> edge)
 {
-  edges.push_back(edge);
+  m_edges.push_back(edge);
 }
-  
+ 
+struct EdgeHasNode
+{
+  boost::shared_ptr<NavGraphNodeObjectModel> m_node;
+
+  EdgeHasNode(boost::shared_ptr<NavGraphNodeObjectModel> node)
+    : m_node(node)
+  {}
+
+  bool operator()(boost::shared_ptr<NavGraphEdgeObjectModel> edge)
+  {
+    return 
+      edge->get_lhs() == m_node ||
+      edge->get_rhs() == m_node;
+  }
+};
+ 
 void
 NavigationGraphModel::remove_node(boost::shared_ptr<NavGraphNodeObjectModel> node)
 {
+  m_nodes.erase(std::remove(m_nodes.begin(), m_nodes.end(), node));
+  m_edges.erase(std::remove_if(m_edges.begin(), m_edges.end(), EdgeHasNode(node)));
 }
 
 void
 NavigationGraphModel::remove_edge(boost::shared_ptr<NavGraphEdgeObjectModel> edge)
 {
+  m_edges.erase(std::remove(m_edges.begin(), m_edges.end(), edge));
 }
 
 boost::shared_ptr<NavGraphNodeObjectModel>
@@ -78,7 +97,7 @@
   boost::shared_ptr<NavGraphNodeObjectModel> node;
   float min_distance = radius;
 
-  for(Nodes::const_iterator i = nodes.begin(); i != nodes.end(); ++i)
+  for(Nodes::const_iterator i = m_nodes.begin(); i != m_nodes.end(); ++i)
   {
     float current_distance = (pos - (*i)->get_world_pos()).length();
     if (current_distance < min_distance)
@@ -88,8 +107,6 @@
     }
   }
 
-  std::cout << "find_closest_node: " << nodes.size() << " " << node.get() << std::endl;
-
   return node;
 }
 
@@ -99,7 +116,7 @@
   boost::shared_ptr<NavGraphEdgeObjectModel> edge;
   float min_distance = radius;
 
-  for(Edges::const_iterator i = edges.begin(); i != edges.end(); ++i)
+  for(Edges::const_iterator i = m_edges.begin(); i != m_edges.end(); ++i)
   {
     float current_distance = Line((*i)->get_lhs()->get_world_pos(),
                                   (*i)->get_rhs()->get_world_pos()).distance(pos);
@@ -113,4 +130,36 @@
   return edge;
 }
 
+boost::shared_ptr<NavGraphNodeObjectModel>
+NavigationGraphModel::get_object_at(const Vector2f& pos, const SelectMask& select_mask) const
+{
+  for(Nodes::const_reverse_iterator i = m_nodes.rbegin(); i != m_nodes.rend(); ++i)
+  {
+    if (select_mask.match((*i)->get_select_mask()) &&
+        (*i)->is_at(pos))
+    {
+      return *i;
+    }
+  }
+
+  return boost::shared_ptr<NavGraphNodeObjectModel>();
+}
+
+SelectionHandle
+NavigationGraphModel::get_selection(const Rectf& rect, const SelectMask& select_mask) const
+{
+  SelectionHandle selection = Selection::create();
+
+  for(Nodes::const_reverse_iterator i = m_nodes.rbegin(); i != m_nodes.rend(); ++i)
+  {
+    if (select_mask.match((*i)->get_select_mask()) &&
+        rect.contains((*i)->get_bounding_box()))
+    {
+      selection->add(*i);
+    }
+  }
+
+  return selection;
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/navigation_graph_model.hpp
===================================================================
--- trunk/windstille/src/editor/navigation_graph_model.hpp	2009-09-10 18:27:22 UTC (rev 3220)
+++ trunk/windstille/src/editor/navigation_graph_model.hpp	2009-09-10 23:30:39 UTC (rev 3221)
@@ -23,23 +23,29 @@
 #include <boost/shared_ptr.hpp>
 #include <boost/scoped_ptr.hpp>
 
+#include "editor/selection.hpp"
+
 class Vector2f;
 class NavigationGraph;
 class NavGraphEdgeObjectModel;
 class NavGraphNodeObjectModel;
+class SelectMask;
 
 class NavigationGraphModel
 {
-private:
+public:
   typedef std::vector<boost::shared_ptr<NavGraphNodeObjectModel> > Nodes; 
   typedef std::vector<boost::shared_ptr<NavGraphEdgeObjectModel> > Edges;
 
-  Nodes nodes;
-  Edges edges;
+private:
+  Nodes m_nodes;
+  Edges m_edges;
 
 public:
   NavigationGraphModel();
   ~NavigationGraphModel();
+
+  const Nodes& get_nodes() const { return m_nodes; }
   
   boost::shared_ptr<NavGraphNodeObjectModel> create_node(const Vector2f& pos);
   boost::shared_ptr<NavGraphEdgeObjectModel> create_edge(boost::shared_ptr<NavGraphNodeObjectModel> lhs, 
@@ -54,6 +60,9 @@
   boost::shared_ptr<NavGraphNodeObjectModel> find_closest_node(const Vector2f& pos, float radius) const;
   boost::shared_ptr<NavGraphEdgeObjectModel> find_closest_edge(const Vector2f& pos, float radius) const;
 
+  boost::shared_ptr<NavGraphNodeObjectModel> get_object_at(const Vector2f& pos, const SelectMask& layers) const;
+  SelectionHandle   get_selection(const Rectf& rect, const SelectMask& layers) const;
+
 private:
   NavigationGraphModel(const NavigationGraphModel&);
   NavigationGraphModel& operator=(const NavigationGraphModel&);

Modified: trunk/windstille/src/editor/object_commands.hpp
===================================================================
--- trunk/windstille/src/editor/object_commands.hpp	2009-09-10 18:27:22 UTC (rev 3220)
+++ trunk/windstille/src/editor/object_commands.hpp	2009-09-10 23:30:39 UTC (rev 3221)
@@ -38,11 +38,15 @@
   {}
   
   void redo() {
-    layer->remove(object);
+    if (layer)
+      layer->remove(object);
+    else
+      std::cout << "ObjectRemoveCommand: null layer" << std::endl;
   }
 
   void undo() {
-    layer->add(object);
+    if (layer)
+      layer->add(object);
   }
 
 };
@@ -60,11 +64,15 @@
   {}
   
   void redo() {
-    layer->add(object);
+    if (layer)
+      layer->add(object);
+    else
+      std::cout << "ObjectRemoveCommand: null layer" << std::endl;
   }
 
   void undo() {
-    layer->remove(object);
+    if (layer)
+      layer->remove(object);
   }
 };
 

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-10 18:27:22 UTC (rev 3220)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-10 23:30:39 UTC (rev 3221)
@@ -43,7 +43,6 @@
   : nav_graph(new NavigationGraphModel()),
     scene_graph(new SceneGraph()),
     layer_tree(Gtk::ListStore::create(LayerManagerColumns::instance())),
-    navgraph_layer(new Layer(*this)),
     ambient_color()
 {
   register_callbacks();
@@ -54,7 +53,6 @@
   : nav_graph(new NavigationGraphModel),
     scene_graph(new SceneGraph()),
     layer_tree(Gtk::ListStore::create(LayerManagerColumns::instance())),
-    navgraph_layer(new Layer(*this)),
     ambient_color()
 {
   register_callbacks();
@@ -263,12 +261,12 @@
 {
   const Layers& layers = get_layers();
   SelectionHandle selection = Selection::create();
-
-  if (ObjectModelHandle object = navgraph_layer->get_object_at(pos, layermask))
+  
+  if (ObjectModelHandle obj = nav_graph->get_object_at(pos, layermask))
   {
-    return object;
+    return obj;
   }
-  
+
   for(Layers::const_reverse_iterator i = layers.rbegin(); i != layers.rend(); ++i)
   {
     if ((*i)->is_visible() && !(*i)->is_locked())
@@ -290,7 +288,7 @@
   SelectionHandle selection = Selection::create();
 
   {
-    SelectionHandle new_sel = navgraph_layer->get_selection(rect, layermask);
+    SelectionHandle new_sel = nav_graph->get_selection(rect, layermask);
     selection->add(new_sel->begin(), new_sel->end());
   }
 
@@ -570,7 +568,7 @@
     }
   }
 
-  for(Layer::const_iterator obj = navgraph_layer->begin(); obj != navgraph_layer->end(); ++obj)
+  for(NavigationGraphModel::Nodes::const_iterator obj = nav_graph->get_nodes().begin(); obj != nav_graph->get_nodes().end(); ++obj)
   {
     (*obj)->add_to_scenegraph(*scene_graph);
   }

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-10 18:27:22 UTC (rev 3220)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-10 23:30:39 UTC (rev 3221)
@@ -27,12 +27,11 @@
 
 #include "display/color.hpp"
 #include "editor/layer.hpp"
-#include "editor/navigation_graph_model.hpp"
 #include "editor/object_model.hpp"
 #include "editor/selection.hpp"
 #include "math/vector2f.hpp"
 
-class NavigationGraph;
+class NavigationGraphModel;
 class NavGraphNodeObjectModel;
 class NavGraphEdgeObjectModel;
 class SceneGraph;
@@ -44,7 +43,6 @@
   boost::scoped_ptr<NavigationGraphModel> nav_graph;
   boost::scoped_ptr<SceneGraph>      scene_graph;
   Glib::RefPtr<Gtk::ListStore>       layer_tree;
-  LayerHandle navgraph_layer;
   Color ambient_color;
   
 public:
@@ -69,7 +67,6 @@
   void add(const ObjectModelHandle& object, const Gtk::TreeModel::Path& path);
   void remove(const ObjectModelHandle& object);
   LayerHandle get_layer(const ObjectModelHandle& object) const;
-  LayerHandle get_navgraph_layer() const { return navgraph_layer; }
 
   void  set_ambient_color(const Color& color) { ambient_color = color; }
   Color get_ambient_color() const { return ambient_color; }
@@ -98,7 +95,7 @@
 
   void write(FileWriter& writer) const;
 
-  NavigationGraphModel& get_nav_graph()   const { return *nav_graph; }
+  NavigationGraphModel& get_nav_graph() const { return *nav_graph; }
   SceneGraph&      get_scene_graph() const { return *scene_graph; }
 
   void delete_navgraph_edges(NavGraphNodeObjectModel& node);



From grumbel at mail.berlios.de  Fri Sep 11 01:34:46 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 11 Sep 2009 01:34:46 +0200
Subject: [Windstille-commit] r3222 - trunk/windstille
Message-ID: <200909102334.n8ANYk2U015072@sheep.berlios.de>

Author: grumbel
Date: 2009-09-11 01:34:46 +0200 (Fri, 11 Sep 2009)
New Revision: 3222

Modified:
   trunk/windstille/TODO
Log:
TODO updates

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2009-09-10 23:30:39 UTC (rev 3221)
+++ trunk/windstille/TODO	2009-09-10 23:34:46 UTC (rev 3222)
@@ -28,6 +28,22 @@
 * NavGraphInsertTool needs to be rewritten
 
 * NavGraphSelectTool would become obsolote
+
+* SceneGraph needs to be updated while drag&drop is in progress
+
+* deleting a NavGraphNodeObjectModel must remove all the connected
+  NavGraphEdgeObjectModel
+
+* Move scroll_tool to EditorWindow, away from WindstilleWidget
+
+* NavGraphEdgeObjectModel modifies the Navgraph by bypassing the undo system, that is wrong
+
+* delete/remove/erase naming is a bit mixed up in a few places
+
+* NavGraph object creating and deletion must be routed through undo
+  system, also the raw navgraph must be updated properly
+
+* write NavigationGraphModel (!!!)
 
 Overview
 ========



From grumbel at mail.berlios.de  Fri Sep 11 06:25:55 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 11 Sep 2009 06:25:55 +0200
Subject: [Windstille-commit] r3223 - trunk/windstille/src/editor
Message-ID: <200909110425.n8B4PtEj017214@sheep.berlios.de>

Author: grumbel
Date: 2009-09-11 06:25:54 +0200 (Fri, 11 Sep 2009)
New Revision: 3223

Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/navgraph_insert_tool.cpp
   trunk/windstille/src/editor/navigation_graph_model.cpp
   trunk/windstille/src/editor/navigation_graph_model.hpp
   trunk/windstille/src/editor/sector_model.cpp
Log:
More tweaks to the NavigationGraph

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-10 23:34:46 UTC (rev 3222)
+++ trunk/windstille/src/editor/document.cpp	2009-09-11 04:25:54 UTC (rev 3223)
@@ -27,6 +27,7 @@
 #include "editor/object_model.hpp"
 #include "editor/decal_object_model.hpp"
 #include "editor/navgraph_edge_object_model.hpp"
+#include "editor/navgraph_node_object_model.hpp"
 
 #include "editor/functor_command.hpp"
 #include "editor/group_command.hpp"
@@ -80,6 +81,7 @@
 void
 Document::undo_group_end()
 {
+  assert(m_group_command);
   CommandHandle tmp = m_group_command;
   m_group_command.reset();
   execute(tmp);
@@ -141,7 +143,15 @@
 void
 Document::navgraph_node_remove(boost::shared_ptr<NavGraphNodeObjectModel> node)
 {
+  const std::vector<boost::shared_ptr<NavGraphEdgeObjectModel> >& edges = m_sector_model->get_nav_graph().find_edges(node);
+
+  undo_group_begin();
+  for(std::vector<boost::shared_ptr<NavGraphEdgeObjectModel> >::const_iterator i = edges.begin(); i != edges.end(); ++i)
+  {
+    execute(CommandHandle(new ObjectRemoveCommand(*m_sector_model, *i)));
+  }
   execute(CommandHandle(new NavGraphNodeRemoveCommand(*m_sector_model, node)));
+  undo_group_end();
 }
 
 void
@@ -156,7 +166,10 @@
 void
 Document::navgraph_edge_remove(boost::shared_ptr<NavGraphEdgeObjectModel> edge)
 {
+  undo_group_begin();
   execute(CommandHandle(new NavGraphEdgeRemoveCommand(*m_sector_model, edge)));
+  execute(CommandHandle(new ObjectRemoveCommand(*m_sector_model, edge)));
+  undo_group_end();
 }
 
 void
@@ -168,7 +181,18 @@
 void
 Document::object_remove(ObjectModelHandle object)
 {
-  execute(CommandHandle(new ObjectRemoveCommand(*m_sector_model, object)));
+  if (boost::shared_ptr<NavGraphNodeObjectModel> node = boost::dynamic_pointer_cast<NavGraphNodeObjectModel>(object))
+  {
+    navgraph_node_remove(node);
+  }
+  else if (boost::shared_ptr<NavGraphEdgeObjectModel> edge = boost::dynamic_pointer_cast<NavGraphEdgeObjectModel>(object))
+  {
+    navgraph_edge_remove(edge);
+  }
+  else
+  {
+    execute(CommandHandle(new ObjectRemoveCommand(*m_sector_model, object)));
+  }
 }
 
 void

Modified: trunk/windstille/src/editor/navgraph_insert_tool.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-10 23:34:46 UTC (rev 3222)
+++ trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-11 04:25:54 UTC (rev 3223)
@@ -61,7 +61,6 @@
       }
       else
       { // connect last node with newly created node
-        std::cout << "Node Group" << std::endl;
         boost::shared_ptr<NavGraphNodeObjectModel> node_obj(new NavGraphNodeObjectModel(mouse_pos));
         
         wst.get_document().undo_group_begin();

Modified: trunk/windstille/src/editor/navigation_graph_model.cpp
===================================================================
--- trunk/windstille/src/editor/navigation_graph_model.cpp	2009-09-10 23:34:46 UTC (rev 3222)
+++ trunk/windstille/src/editor/navigation_graph_model.cpp	2009-09-11 04:25:54 UTC (rev 3223)
@@ -23,8 +23,9 @@
 #include "math/line.hpp"
 #include "navigation/navigation_graph.hpp"
 
-NavigationGraphModel::NavigationGraphModel()
-  : m_nodes(),
+NavigationGraphModel::NavigationGraphModel(SectorModel& sector)
+  : m_sector(sector),
+    m_nodes(),
     m_edges()   
 {
 }
@@ -81,14 +82,14 @@
 void
 NavigationGraphModel::remove_node(boost::shared_ptr<NavGraphNodeObjectModel> node)
 {
-  m_nodes.erase(std::remove(m_nodes.begin(), m_nodes.end(), node));
-  m_edges.erase(std::remove_if(m_edges.begin(), m_edges.end(), EdgeHasNode(node)));
+  m_nodes.erase(std::remove(m_nodes.begin(), m_nodes.end(), node), m_nodes.end());
+  m_edges.erase(std::remove_if(m_edges.begin(), m_edges.end(), EdgeHasNode(node)), m_edges.end());
 }
 
 void
 NavigationGraphModel::remove_edge(boost::shared_ptr<NavGraphEdgeObjectModel> edge)
 {
-  m_edges.erase(std::remove(m_edges.begin(), m_edges.end(), edge));
+  m_edges.erase(std::remove(m_edges.begin(), m_edges.end(), edge), m_edges.end());
 }
 
 boost::shared_ptr<NavGraphNodeObjectModel>
@@ -130,6 +131,22 @@
   return edge;
 }
 
+std::vector<boost::shared_ptr<NavGraphEdgeObjectModel> >
+NavigationGraphModel::find_edges(boost::shared_ptr<NavGraphNodeObjectModel> node) const
+{
+  std::vector<boost::shared_ptr<NavGraphEdgeObjectModel> > edges;
+  
+  for(Edges::const_iterator i = m_edges.begin(); i != m_edges.end(); ++i)
+  {
+    if ((*i)->get_lhs() == node || (*i)->get_rhs() == node)
+    {
+      edges.push_back(*i);
+    }
+  }
+
+  return edges;
+}
+
 boost::shared_ptr<NavGraphNodeObjectModel>
 NavigationGraphModel::get_object_at(const Vector2f& pos, const SelectMask& select_mask) const
 {

Modified: trunk/windstille/src/editor/navigation_graph_model.hpp
===================================================================
--- trunk/windstille/src/editor/navigation_graph_model.hpp	2009-09-10 23:34:46 UTC (rev 3222)
+++ trunk/windstille/src/editor/navigation_graph_model.hpp	2009-09-11 04:25:54 UTC (rev 3223)
@@ -38,11 +38,12 @@
   typedef std::vector<boost::shared_ptr<NavGraphEdgeObjectModel> > Edges;
 
 private:
+  SectorModel& m_sector;
   Nodes m_nodes;
   Edges m_edges;
 
 public:
-  NavigationGraphModel();
+  NavigationGraphModel(SectorModel& sector);
   ~NavigationGraphModel();
 
   const Nodes& get_nodes() const { return m_nodes; }
@@ -60,6 +61,8 @@
   boost::shared_ptr<NavGraphNodeObjectModel> find_closest_node(const Vector2f& pos, float radius) const;
   boost::shared_ptr<NavGraphEdgeObjectModel> find_closest_edge(const Vector2f& pos, float radius) const;
 
+  std::vector<boost::shared_ptr<NavGraphEdgeObjectModel> > find_edges(boost::shared_ptr<NavGraphNodeObjectModel> node) const;
+
   boost::shared_ptr<NavGraphNodeObjectModel> get_object_at(const Vector2f& pos, const SelectMask& layers) const;
   SelectionHandle   get_selection(const Rectf& rect, const SelectMask& layers) const;
 

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-10 23:34:46 UTC (rev 3222)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-11 04:25:54 UTC (rev 3223)
@@ -40,7 +40,7 @@
 
 
 SectorModel::SectorModel(const std::string& filename)
-  : nav_graph(new NavigationGraphModel()),
+  : nav_graph(new NavigationGraphModel(*this)),
     scene_graph(new SceneGraph()),
     layer_tree(Gtk::ListStore::create(LayerManagerColumns::instance())),
     ambient_color()
@@ -50,7 +50,7 @@
 }
 
 SectorModel::SectorModel()
-  : nav_graph(new NavigationGraphModel),
+  : nav_graph(new NavigationGraphModel(*this)),
     scene_graph(new SceneGraph()),
     layer_tree(Gtk::ListStore::create(LayerManagerColumns::instance())),
     ambient_color()



From grumbel at mail.berlios.de  Fri Sep 11 06:51:59 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 11 Sep 2009 06:51:59 +0200
Subject: [Windstille-commit] r3224 - trunk/windstille/src/editor
Message-ID: <200909110451.n8B4pxfO004333@sheep.berlios.de>

Author: grumbel
Date: 2009-09-11 06:51:57 +0200 (Fri, 11 Sep 2009)
New Revision: 3224

Modified:
   trunk/windstille/src/editor/navgraph_edge_object_model.cpp
   trunk/windstille/src/editor/navgraph_edge_object_model.hpp
   trunk/windstille/src/editor/navgraph_node_object_model.cpp
   trunk/windstille/src/editor/navigation_graph_model.cpp
   trunk/windstille/src/editor/navigation_graph_model.hpp
   trunk/windstille/src/editor/sector_model.cpp
Log:
Implemented save for NavigationGraphModel

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-11 04:25:54 UTC (rev 3223)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-11 04:51:57 UTC (rev 3224)
@@ -79,6 +79,14 @@
 void
 NavGraphEdgeObjectModel::write(FileWriter& writer) const
 {
+  writer.start_section("navgraph-edge-ref");
+  writer.write("edge", get_id());
+  writer.end_section();
+}
+
+void
+NavGraphEdgeObjectModel::write_real(FileWriter& writer) const
+{
   writer.start_section("navgraph-edge");
   ObjectModel::write_member(writer);
   writer.write("lhs-node", m_lhs->get_id());

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-11 04:25:54 UTC (rev 3223)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-11 04:51:57 UTC (rev 3224)
@@ -43,6 +43,7 @@
   Rectf get_bounding_box() const;
   ObjectModelHandle clone() const;
   void write(FileWriter& writer) const;
+  void write_real(FileWriter& writer) const;
 
   boost::shared_ptr<NavGraphNodeObjectModel> get_lhs() const { return m_lhs; }
   boost::shared_ptr<NavGraphNodeObjectModel> get_rhs() const { return m_rhs; }

Modified: trunk/windstille/src/editor/navgraph_node_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-11 04:25:54 UTC (rev 3223)
+++ trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-11 04:51:57 UTC (rev 3224)
@@ -88,7 +88,6 @@
 {
   writer.start_section("navgraph-node");
   ObjectModel::write_member(writer);
-  //writer.write("vflip",   vflip);
   writer.end_section();
 }
 

Modified: trunk/windstille/src/editor/navigation_graph_model.cpp
===================================================================
--- trunk/windstille/src/editor/navigation_graph_model.cpp	2009-09-11 04:25:54 UTC (rev 3223)
+++ trunk/windstille/src/editor/navigation_graph_model.cpp	2009-09-11 04:51:57 UTC (rev 3224)
@@ -179,4 +179,22 @@
   return selection;
 }
 
+void
+NavigationGraphModel::write(FileWriter& writer) const
+{
+  writer.start_section("nodes");
+  for(Nodes::const_reverse_iterator i = m_nodes.rbegin(); i != m_nodes.rend(); ++i)
+  {
+    (*i)->write(writer);
+  }
+  writer.end_section();
+
+  writer.start_section("edges");
+  for(Edges::const_reverse_iterator i = m_edges.rbegin(); i != m_edges.rend(); ++i)
+  {
+    (*i)->write_real(writer);
+  }
+  writer.end_section();
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/navigation_graph_model.hpp
===================================================================
--- trunk/windstille/src/editor/navigation_graph_model.hpp	2009-09-11 04:25:54 UTC (rev 3223)
+++ trunk/windstille/src/editor/navigation_graph_model.hpp	2009-09-11 04:51:57 UTC (rev 3224)
@@ -66,6 +66,8 @@
   boost::shared_ptr<NavGraphNodeObjectModel> get_object_at(const Vector2f& pos, const SelectMask& layers) const;
   SelectionHandle   get_selection(const Rectf& rect, const SelectMask& layers) const;
 
+  void write(FileWriter& writer) const;
+
 private:
   NavigationGraphModel(const NavigationGraphModel&);
   NavigationGraphModel& operator=(const NavigationGraphModel&);

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-11 04:25:54 UTC (rev 3223)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-11 04:51:57 UTC (rev 3224)
@@ -484,9 +484,9 @@
   writer.write("ambient-color", ambient_color);
   writer.write("init-script", "init.nut");
 
-  //writer.start_section("navigation");
-  //nav_graph->write(writer);
-  //writer.end_section();
+  writer.start_section("navigation");
+  nav_graph->write(writer);
+  writer.end_section();
 
   writer.start_section("layers");
   for(Gtk::ListStore::Children::iterator i = layer_tree->children().begin(); i != layer_tree->children().end(); ++i)



From grumbel at mail.berlios.de  Fri Sep 11 07:44:40 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 11 Sep 2009 07:44:40 +0200
Subject: [Windstille-commit] r3225 - trunk/windstille/src/editor
Message-ID: <200909110544.n8B5iecQ029014@sheep.berlios.de>

Author: grumbel
Date: 2009-09-11 07:44:39 +0200 (Fri, 11 Sep 2009)
New Revision: 3225

Modified:
   trunk/windstille/src/editor/navgraph_node_object_model.cpp
   trunk/windstille/src/editor/navgraph_node_object_model.hpp
   trunk/windstille/src/editor/navigation_graph_model.cpp
   trunk/windstille/src/editor/navigation_graph_model.hpp
   trunk/windstille/src/editor/sector_model.cpp
Log:
Implemented NavigationGraph loading in the editor

Modified: trunk/windstille/src/editor/navgraph_node_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-11 04:51:57 UTC (rev 3224)
+++ trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-11 05:44:39 UTC (rev 3225)
@@ -23,6 +23,12 @@
 #include "scenegraph/scene_graph.hpp"
 #include "navigation/node.hpp"
 
+NavGraphNodeObjectModel::NavGraphNodeObjectModel(const FileReader& reader)
+  : ObjectModel(reader),
+    m_drawable()
+{
+}
+
 NavGraphNodeObjectModel::NavGraphNodeObjectModel(const Vector2f& pos)//, SectorModel& sector)
   : ObjectModel("NavGraphNodeObjectModel", pos),
     m_drawable()

Modified: trunk/windstille/src/editor/navgraph_node_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-11 04:51:57 UTC (rev 3224)
+++ trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-11 05:44:39 UTC (rev 3225)
@@ -25,6 +25,7 @@
 #include "navigation/navigation_graph.hpp"
 
 class VertexArrayDrawable;
+class FileReader;
 
 class NavGraphNodeObjectModel : public ObjectModel
 {
@@ -32,7 +33,8 @@
   boost::shared_ptr<VertexArrayDrawable> m_drawable;
 
 public:
-  NavGraphNodeObjectModel(const Vector2f& pos);//, SectorModel& sector);
+  NavGraphNodeObjectModel(const FileReader& reader);
+  NavGraphNodeObjectModel(const Vector2f& pos);
   ~NavGraphNodeObjectModel();
 
   void add_to_scenegraph(SceneGraph& sg);

Modified: trunk/windstille/src/editor/navigation_graph_model.cpp
===================================================================
--- trunk/windstille/src/editor/navigation_graph_model.cpp	2009-09-11 04:51:57 UTC (rev 3224)
+++ trunk/windstille/src/editor/navigation_graph_model.cpp	2009-09-11 05:44:39 UTC (rev 3225)
@@ -22,6 +22,7 @@
 #include "editor/navgraph_node_object_model.hpp"
 #include "math/line.hpp"
 #include "navigation/navigation_graph.hpp"
+#include "util/file_reader.hpp"
 
 NavigationGraphModel::NavigationGraphModel(SectorModel& sector)
   : m_sector(sector),
@@ -197,4 +198,89 @@
   writer.end_section();
 }
 
+void
+NavigationGraphModel::load(const FileReader& reader, std::map<std::string, ObjectModelHandle>& all_id_table)
+{
+  std::cout << "NavigationGraphModel::load" << std::endl;
+  std::map<std::string, boost::shared_ptr<NavGraphNodeObjectModel> > id_table;
+
+  FileReader nodes_section;
+  if (reader.get("nodes", nodes_section))
+  {
+    const std::vector<FileReader>& sections = nodes_section.get_sections();
+    for(std::vector<FileReader>::const_iterator i = sections.begin(); i != sections.end(); ++i)
+    {
+      if (i->get_name() == "navgraph-node")
+      {
+        boost::shared_ptr<NavGraphNodeObjectModel> node(new NavGraphNodeObjectModel(*i));
+
+        std::string id_str;
+        if (i->get("id", id_str))
+        {
+          id_table[id_str] = node;
+        }
+
+        m_nodes.push_back(node);
+      }
+      else
+      {
+        std::cout << "NavigationGraphModel:load: unknown tag " << i->get_name() << std::endl;
+      }
+    }
+  }
+  else
+  {
+    std::cout << "NavigationGraphModel: nodes missing" << std::endl;
+  }
+
+  FileReader edges_section;
+  if (reader.get("edges", edges_section))
+  {
+    const std::vector<FileReader>& sections = edges_section.get_sections();
+    for(std::vector<FileReader>::const_iterator i = sections.begin(); i != sections.end(); ++i)
+    {
+      if (i->get_name() == "navgraph-edge")
+      {
+        std::string lhs;
+        std::string rhs;
+
+        if (i->get("lhs-node", lhs) && i->get("rhs-node", rhs))
+        {
+          boost::shared_ptr<NavGraphNodeObjectModel> lhs_node = id_table[lhs];
+          boost::shared_ptr<NavGraphNodeObjectModel> rhs_node = id_table[rhs];
+
+          if (lhs_node && rhs_node)
+          {
+            boost::shared_ptr<NavGraphEdgeObjectModel> edge(new NavGraphEdgeObjectModel(lhs_node, rhs_node));
+
+            std::string id_str;
+            if (i->get("id", id_str))
+            {
+              all_id_table[id_str] = edge;
+            }
+
+            m_edges.push_back(edge);
+          }
+          else
+          {
+            std::cout << "Error: NavigationGraphModel::load: couldn't resolve edge: " << lhs_node << " " << rhs_node << std::endl;
+          }
+        }
+        else
+        {
+          std::cout << "Error: NavigationGraphModel::load: invalid edge" << std::endl;
+        }
+      }
+      else
+      {
+        std::cout << "NavigationGraphModel:load: unknown tag " << i->get_name() << std::endl;
+      }
+    }
+  }
+  else
+  {
+    std::cout << "NavigationGraphModel: edges missing" << std::endl;
+  }
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/navigation_graph_model.hpp
===================================================================
--- trunk/windstille/src/editor/navigation_graph_model.hpp	2009-09-11 04:51:57 UTC (rev 3224)
+++ trunk/windstille/src/editor/navigation_graph_model.hpp	2009-09-11 05:44:39 UTC (rev 3225)
@@ -67,6 +67,7 @@
   SelectionHandle   get_selection(const Rectf& rect, const SelectMask& layers) const;
 
   void write(FileWriter& writer) const;
+  void load(const FileReader& reader, std::map<std::string, ObjectModelHandle>& id_table);
 
 private:
   NavigationGraphModel(const NavigationGraphModel&);

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-11 04:51:57 UTC (rev 3224)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-11 05:44:39 UTC (rev 3225)
@@ -380,21 +380,32 @@
   {
     try 
     {
-      ObjectModelHandle obj = ObjectModelFactory::create(*j);
-
-      layer->add(obj);
-
-      std::string id_str;
-      if (j->read("id", id_str))
+      if (j->get_name() == "navgraph-edge-ref")
       {
-        id_table[id_str] = obj;
+        std::string id_str;
+        if (j->get("edge", id_str))
+        {
+          layer->add(id_table[id_str]);
+        }
       }
+      else
+      {
+        ObjectModelHandle obj = ObjectModelFactory::create(*j);
 
-      std::string parent_str;
-      if (j->read("parent", parent_str))
-      {
-        if (!parent_str.empty())
-          parent_table[obj] = parent_str;
+        layer->add(obj);
+
+        std::string id_str;
+        if (j->read("id", id_str))
+        {
+          id_table[id_str] = obj;
+        }
+
+        std::string parent_str;
+        if (j->read("parent", parent_str))
+        {
+          if (!parent_str.empty())
+            parent_table[obj] = parent_str;
+        }
       }
     }
     catch(std::exception& err)
@@ -436,9 +447,9 @@
       ambient_color = Color(0,0,0,1);
       reader.get("ambient-color", ambient_color);
 
-      //FileReader navigation_section;
-      //reader.get("navigation", navigation_section);
-      //nav_graph->load(navigation_section);
+      FileReader navigation_section;
+      reader.get("navigation", navigation_section);
+      nav_graph->load(navigation_section, id_table);
 
       FileReader layers_section;
       reader.get("layers", layers_section);



From grumbel at mail.berlios.de  Sat Sep 12 02:47:56 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 12 Sep 2009 02:47:56 +0200
Subject: [Windstille-commit] r3226 - trunk/windstille/src/editor
Message-ID: <200909120047.n8C0luNB017050@sheep.berlios.de>

Author: grumbel
Date: 2009-09-12 02:47:54 +0200 (Sat, 12 Sep 2009)
New Revision: 3226

Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/document.hpp
   trunk/windstille/src/editor/layer_commands.hpp
   trunk/windstille/src/editor/navgraph_edge_object_model.cpp
   trunk/windstille/src/editor/navgraph_insert_tool.cpp
   trunk/windstille/src/editor/navigation_graph_model.cpp
   trunk/windstille/src/editor/navigation_graph_model.hpp
   trunk/windstille/src/editor/sector_model.cpp
Log:
More NavGraph work

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-11 05:44:39 UTC (rev 3225)
+++ trunk/windstille/src/editor/document.cpp	2009-09-12 00:47:54 UTC (rev 3226)
@@ -60,15 +60,27 @@
 }
 
 void
+Document::on_change()
+{
+  EditorWindow::current()->update_undo_state();
+  m_sector_model->rebuild_scene_graph();
+  m_sig_on_change();
+}
+
+void
 Document::undo()
 {
+  std::cout << "UNDO" << std::endl;
   m_undo_manager->undo();
+  std::cout << "on_change" << std::endl;
+  on_change();
 }
 
 void
 Document::redo()
 {
   m_undo_manager->redo();
+  on_change();
 }
 
 void
@@ -82,6 +94,8 @@
 Document::undo_group_end()
 {
   assert(m_group_command);
+
+  // reseting m_group_command is needed for execute to evaluate the command
   CommandHandle tmp = m_group_command;
   m_group_command.reset();
   execute(tmp);
@@ -104,14 +118,13 @@
 {
   if (m_group_command)
   {
+    std::cout << "Group Command" << std::endl;
     m_group_command->add(cmd);
   }
   else
   {
     m_undo_manager->execute(cmd);
-    EditorWindow::current()->update_undo_state();
-    m_sector_model->rebuild_scene_graph();
-    m_sig_on_change();
+    on_change();  
   }
 }
 
@@ -159,8 +172,15 @@
                             boost::shared_ptr<NavGraphNodeObjectModel> lhs,
                             boost::shared_ptr<NavGraphNodeObjectModel> rhs)
 {
-  boost::shared_ptr<NavGraphEdgeObjectModel> edge(new NavGraphEdgeObjectModel(lhs, rhs));
-  execute(CommandHandle(new NavGraphEdgeAddCommand(*m_sector_model, layer, edge)));
+  if (m_sector_model->get_nav_graph().has_edge(lhs, rhs))
+  {
+    std::cout << "Document::navgraph_edge_add: edge already exists, ignoring" << std::endl;
+  }
+  else
+  {
+    boost::shared_ptr<NavGraphEdgeObjectModel> edge(new NavGraphEdgeObjectModel(lhs, rhs));
+    execute(CommandHandle(new NavGraphEdgeAddCommand(*m_sector_model, layer, edge)));
+  }
 }
 
 void

Modified: trunk/windstille/src/editor/document.hpp
===================================================================
--- trunk/windstille/src/editor/document.hpp	2009-09-11 05:44:39 UTC (rev 3225)
+++ trunk/windstille/src/editor/document.hpp	2009-09-12 00:47:54 UTC (rev 3226)
@@ -135,6 +135,7 @@
 
 private:
   void on_selection_change();
+  void on_change();
 
 private:
   Document(const Document&);

Modified: trunk/windstille/src/editor/layer_commands.hpp
===================================================================
--- trunk/windstille/src/editor/layer_commands.hpp	2009-09-11 05:44:39 UTC (rev 3225)
+++ trunk/windstille/src/editor/layer_commands.hpp	2009-09-12 00:47:54 UTC (rev 3226)
@@ -36,6 +36,7 @@
   {}
 
   void redo() {
+    // FIXME: We should recycle the actual layer object instead of creating a new one
     sector.add_layer("New Layer", path);
   }
 

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-11 05:44:39 UTC (rev 3225)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-12 00:47:54 UTC (rev 3226)
@@ -30,7 +30,15 @@
     m_rhs(rhs),
     m_drawable()
 {
-  //m_edge = sector.get_nav_graph().add_edge(m_lhs->get_node(), m_rhs->get_node());
+  if (m_lhs == m_rhs)
+  {
+    throw std::runtime_error("NavGraphEdgeObjectModel: lhs and rhs must not be the same");
+  }
+
+  // We enforce order so that we can easier compare
+  // NavGraphEdgeObjectModel's with one another
+  if (!(m_lhs < m_rhs))
+    std::swap(m_lhs, m_rhs);
 }
 
 NavGraphEdgeObjectModel::~NavGraphEdgeObjectModel()

Modified: trunk/windstille/src/editor/navgraph_insert_tool.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-11 05:44:39 UTC (rev 3225)
+++ trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-12 00:47:54 UTC (rev 3226)
@@ -52,7 +52,14 @@
   {
     case EDGE_MODE:
     {
-      if (node)
+      if (node == last_node)
+      {
+        std::cout << "NavgraphInsertTool: Trying to connect node to itself, ignoring" << std::endl;
+
+        last_node.reset();
+        connection_node.reset();
+      }
+      else if (node)
       { // connect last node with existing node
         wst.get_document().navgraph_edge_add(wst.get_current_layer(), last_node, node);
 

Modified: trunk/windstille/src/editor/navigation_graph_model.cpp
===================================================================
--- trunk/windstille/src/editor/navigation_graph_model.cpp	2009-09-11 05:44:39 UTC (rev 3225)
+++ trunk/windstille/src/editor/navigation_graph_model.cpp	2009-09-12 00:47:54 UTC (rev 3226)
@@ -33,25 +33,8 @@
 
 NavigationGraphModel::~NavigationGraphModel()
 {
-}
-  
-boost::shared_ptr<NavGraphNodeObjectModel>
-NavigationGraphModel::create_node(const Vector2f& pos)
-{
-  boost::shared_ptr<NavGraphNodeObjectModel> node(new NavGraphNodeObjectModel(pos));
-  m_nodes.push_back(node);
-  return node;
-}
+} 
 
-boost::shared_ptr<NavGraphEdgeObjectModel>
-NavigationGraphModel::create_edge(boost::shared_ptr<NavGraphNodeObjectModel> lhs, 
-                                  boost::shared_ptr<NavGraphNodeObjectModel> rhs)
-{
-  boost::shared_ptr<NavGraphEdgeObjectModel> edge(new NavGraphEdgeObjectModel(lhs, rhs));
-  m_edges.push_back(edge);
-  return edge;
-}
-
 void
 NavigationGraphModel::add_node(boost::shared_ptr<NavGraphNodeObjectModel> node)
 {
@@ -83,8 +66,10 @@
 void
 NavigationGraphModel::remove_node(boost::shared_ptr<NavGraphNodeObjectModel> node)
 {
+  std::cout << "remove_node: " << m_nodes.size() << std::endl;
   m_nodes.erase(std::remove(m_nodes.begin(), m_nodes.end(), node), m_nodes.end());
   m_edges.erase(std::remove_if(m_edges.begin(), m_edges.end(), EdgeHasNode(node)), m_edges.end());
+  std::cout << "remove_node: after: " << m_nodes.size() << std::endl;
 }
 
 void
@@ -180,6 +165,24 @@
   return selection;
 }
 
+bool
+NavigationGraphModel::has_edge(boost::shared_ptr<NavGraphNodeObjectModel> lhs, boost::shared_ptr<NavGraphNodeObjectModel> rhs) const
+{
+  // We enforce order so that we can easier compare
+  // NavGraphEdgeObjectModel's with one another
+  if (!(lhs < rhs))
+    std::swap(lhs, rhs);
+
+  for(Edges::const_reverse_iterator i = m_edges.rbegin(); i != m_edges.rend(); ++i)
+  {
+    if ((*i)->get_lhs() == lhs &&
+        (*i)->get_rhs() == rhs)
+      return true;
+  }
+
+  return false;
+}
+
 void
 NavigationGraphModel::write(FileWriter& writer) const
 {

Modified: trunk/windstille/src/editor/navigation_graph_model.hpp
===================================================================
--- trunk/windstille/src/editor/navigation_graph_model.hpp	2009-09-11 05:44:39 UTC (rev 3225)
+++ trunk/windstille/src/editor/navigation_graph_model.hpp	2009-09-12 00:47:54 UTC (rev 3226)
@@ -48,10 +48,6 @@
 
   const Nodes& get_nodes() const { return m_nodes; }
   
-  boost::shared_ptr<NavGraphNodeObjectModel> create_node(const Vector2f& pos);
-  boost::shared_ptr<NavGraphEdgeObjectModel> create_edge(boost::shared_ptr<NavGraphNodeObjectModel> lhs, 
-                                                         boost::shared_ptr<NavGraphNodeObjectModel> rhs);
-
   void add_node(boost::shared_ptr<NavGraphNodeObjectModel> node);
   void add_edge(boost::shared_ptr<NavGraphEdgeObjectModel> edge);
   
@@ -66,6 +62,8 @@
   boost::shared_ptr<NavGraphNodeObjectModel> get_object_at(const Vector2f& pos, const SelectMask& layers) const;
   SelectionHandle   get_selection(const Rectf& rect, const SelectMask& layers) const;
 
+  bool has_edge(boost::shared_ptr<NavGraphNodeObjectModel> lhs, boost::shared_ptr<NavGraphNodeObjectModel> rhs) const;
+
   void write(FileWriter& writer) const;
   void load(const FileReader& reader, std::map<std::string, ObjectModelHandle>& id_table);
 

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-11 05:44:39 UTC (rev 3225)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-12 00:47:54 UTC (rev 3226)
@@ -579,9 +579,10 @@
     }
   }
 
-  for(NavigationGraphModel::Nodes::const_iterator obj = nav_graph->get_nodes().begin(); obj != nav_graph->get_nodes().end(); ++obj)
+  std::cout << "rebuild_scene_graph: " << nav_graph->get_nodes().size() << std::endl;
+  for(NavigationGraphModel::Nodes::const_iterator i = nav_graph->get_nodes().begin(); i != nav_graph->get_nodes().end(); ++i)
   {
-    (*obj)->add_to_scenegraph(*scene_graph);
+    (*i)->add_to_scenegraph(*scene_graph);
   }
 
   queue_draw();



From grumbel at mail.berlios.de  Sat Sep 12 03:11:12 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 12 Sep 2009 03:11:12 +0200
Subject: [Windstille-commit] r3227 - trunk/windstille/src/editor
Message-ID: <200909120111.n8C1BCG3019425@sheep.berlios.de>

Author: grumbel
Date: 2009-09-12 03:11:10 +0200 (Sat, 12 Sep 2009)
New Revision: 3227

Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/document.hpp
   trunk/windstille/src/editor/layer.cpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
   trunk/windstille/src/editor/windstille_widget.cpp
   trunk/windstille/src/editor/windstille_widget.hpp
Log:
Removed manual calls to rebuild_scene_graph() instead handle it via Document::on_change() signal

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-12 00:47:54 UTC (rev 3226)
+++ trunk/windstille/src/editor/document.cpp	2009-09-12 01:11:10 UTC (rev 3227)
@@ -39,6 +39,7 @@
   : m_undo_manager(new UndoManager()),
     m_sector_model(new SectorModel()),
     m_group_command(),
+    m_group_command_count(0),
     m_selection(Selection::create()),
     m_control_points(),
     m_sig_on_change()    
@@ -49,6 +50,7 @@
   : m_undo_manager(new UndoManager()),
     m_sector_model(new SectorModel(filename)),
     m_group_command(),
+    m_group_command_count(0),
     m_selection(Selection::create()),
     m_control_points(),
     m_sig_on_change()
@@ -63,7 +65,6 @@
 Document::on_change()
 {
   EditorWindow::current()->update_undo_state();
-  m_sector_model->rebuild_scene_graph();
   m_sig_on_change();
 }
 
@@ -86,19 +87,29 @@
 void
 Document::undo_group_begin()
 {
-  assert(!m_group_command);
-  m_group_command.reset(new GroupCommand());
+  if (m_group_command)
+  {
+    m_group_command_count += 1;
+  }
+  else
+  {
+    m_group_command.reset(new GroupCommand());
+    m_group_command_count = 1;
+  }
 }
 
 void
 Document::undo_group_end()
 {
-  assert(m_group_command);
+  m_group_command_count -= 1;
 
-  // reseting m_group_command is needed for execute to evaluate the command
-  CommandHandle tmp = m_group_command;
-  m_group_command.reset();
-  execute(tmp);
+  if (m_group_command_count == 0)
+  {
+    // reseting m_group_command is needed for execute to evaluate the command
+    CommandHandle tmp = m_group_command;
+    m_group_command.reset();
+    execute(tmp);
+  }
 }
 
 bool
@@ -470,12 +481,13 @@
 void
 Document::selection_delete()
 {
-  boost::shared_ptr<GroupCommand> group_cmd(new GroupCommand());
+  undo_group_begin();
   for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)
   {
-    group_cmd->add(CommandHandle(new ObjectRemoveCommand(*m_sector_model, *i)));
+    object_remove(*i);
   }
-  execute(group_cmd);
+  undo_group_end();
+
   m_selection->clear();
 }
 

Modified: trunk/windstille/src/editor/document.hpp
===================================================================
--- trunk/windstille/src/editor/document.hpp	2009-09-12 00:47:54 UTC (rev 3226)
+++ trunk/windstille/src/editor/document.hpp	2009-09-12 01:11:10 UTC (rev 3227)
@@ -44,6 +44,7 @@
   boost::scoped_ptr<SectorModel> m_sector_model;
 
   boost::shared_ptr<GroupCommand> m_group_command;
+  int m_group_command_count;
   SelectionHandle m_selection;
 
   std::vector<ControlPointHandle> m_control_points;

Modified: trunk/windstille/src/editor/layer.cpp
===================================================================
--- trunk/windstille/src/editor/layer.cpp	2009-09-12 00:47:54 UTC (rev 3226)
+++ trunk/windstille/src/editor/layer.cpp	2009-09-12 01:11:10 UTC (rev 3227)
@@ -44,21 +44,18 @@
 Layer::add(const ObjectModelHandle& object)
 {
   objects.push_back(object);
-  m_sector.rebuild_scene_graph();
 }
 
 void
 Layer::remove(const ObjectModelHandle& object)
 {
   objects.remove(object);
-  m_sector.rebuild_scene_graph();
 }
 
 Layer::iterator
 Layer::erase(iterator it)
 {
   it = objects.erase(it);
-  m_sector.rebuild_scene_graph();
   return it;
 }
 
@@ -125,7 +122,6 @@
 {
   objects.remove(object);
   objects.push_back(object); 
-  m_sector.rebuild_scene_graph();
 }
 
 void
@@ -133,7 +129,6 @@
 {
   objects.remove(object);
   objects.push_front(object); 
-  m_sector.rebuild_scene_graph();
 }
 
 struct OverlapsWith
@@ -166,8 +161,6 @@
   {
     objects.erase(i);
     objects.insert(++j, object);
-      
-    m_sector.rebuild_scene_graph();
   }
 }
 
@@ -192,8 +185,6 @@
     // position
     objects.erase(--(i.base()));
     objects.insert(--(j.base()), object);
-
-    m_sector.rebuild_scene_graph();
   }
 }
 

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-12 00:47:54 UTC (rev 3226)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-12 01:11:10 UTC (rev 3227)
@@ -41,7 +41,6 @@
 
 SectorModel::SectorModel(const std::string& filename)
   : nav_graph(new NavigationGraphModel(*this)),
-    scene_graph(new SceneGraph()),
     layer_tree(Gtk::ListStore::create(LayerManagerColumns::instance())),
     ambient_color()
 {
@@ -51,7 +50,6 @@
 
 SectorModel::SectorModel()
   : nav_graph(new NavigationGraphModel(*this)),
-    scene_graph(new SceneGraph()),
     layer_tree(Gtk::ListStore::create(LayerManagerColumns::instance())),
     ambient_color()
 {
@@ -154,7 +152,6 @@
   { 
     Gtk::ListStore::iterator it = layer_tree->get_iter(path);
     ((LayerHandle)(*it)[LayerManagerColumns::instance().layer])->add(object);
-    rebuild_scene_graph();
   }
 }
 
@@ -167,7 +164,6 @@
   {
     (*i)->remove(object);
   }
-  rebuild_scene_graph();
 }
 
 struct GetLayersFunctor
@@ -559,10 +555,10 @@
 }
 
 void
-SectorModel::rebuild_scene_graph()
+SectorModel::rebuild_scene_graph(SceneGraph& sg)
 {
   // FIXME: should make a queue_rebuild_scene_graph() to limit the number of rebuilds per frame to 1
-  scene_graph->clear();
+  sg.clear();
   
   const Layers& layers = get_layers();
   for(Layers::const_reverse_iterator layer = layers.rbegin(); layer != layers.rend(); ++layer)
@@ -573,7 +569,7 @@
       {
         if ((*layer)->is_visible())
         {
-          (*obj)->add_to_scenegraph(*scene_graph);
+          (*obj)->add_to_scenegraph(sg);
         }
       }
     }
@@ -582,22 +578,11 @@
   std::cout << "rebuild_scene_graph: " << nav_graph->get_nodes().size() << std::endl;
   for(NavigationGraphModel::Nodes::const_iterator i = nav_graph->get_nodes().begin(); i != nav_graph->get_nodes().end(); ++i)
   {
-    (*i)->add_to_scenegraph(*scene_graph);
+    (*i)->add_to_scenegraph(sg);
   }
-
-  queue_draw();
 }
 
 void
-SectorModel::queue_draw()
-{
-  if (WindstilleWidget* wst = EditorWindow::current()->get_windstille_widget())
-  {
-    wst->queue_draw();
-  }
-}
-
-void
 SectorModel::on_row_changed(const Gtk::TreeModel::Path& /*path*/, const Gtk::TreeModel::iterator& iter)
 {
   //std::cout << "LayerManager:on_row_changed" << std::endl;
@@ -611,14 +596,12 @@
       layer->sync(*iter);
     }
   }
-  rebuild_scene_graph();
 }
 
 void
 SectorModel::on_row_deleted(const Gtk::TreeModel::Path& /*path*/)
 {
   std::cout << "LayerManager:on_row_deleted" << std::endl;
-  rebuild_scene_graph();
 }
 
 void
@@ -631,14 +614,12 @@
 SectorModel::on_row_inserted(const Gtk::TreeModel::Path& /*path*/, const Gtk::TreeModel::iterator& /*iter*/)
 {
   std::cout << "LayerManager:on_row_inserted" << std::endl;
-  rebuild_scene_graph();
 }
 
 void
 SectorModel::on_rows_reordered(const Gtk::TreeModel::Path& /*path*/, const Gtk::TreeModel::iterator& /*iter*/, int* /*new_order*/)
 {
   std::cout << "LayerManager:on_row_reordered" << std::endl;
-  rebuild_scene_graph();
 }
 
 void

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-12 00:47:54 UTC (rev 3226)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-12 01:11:10 UTC (rev 3227)
@@ -41,7 +41,6 @@
 {
 private:
   boost::scoped_ptr<NavigationGraphModel> nav_graph;
-  boost::scoped_ptr<SceneGraph>      scene_graph;
   Glib::RefPtr<Gtk::ListStore>       layer_tree;
   Color ambient_color;
   
@@ -96,14 +95,11 @@
   void write(FileWriter& writer) const;
 
   NavigationGraphModel& get_nav_graph() const { return *nav_graph; }
-  SceneGraph&      get_scene_graph() const { return *scene_graph; }
 
   void delete_navgraph_edges(NavGraphNodeObjectModel& node);
 
-  void queue_draw();
+  void rebuild_scene_graph(SceneGraph& sg);
 
-  void rebuild_scene_graph();
-
 private:
   void load(const std::string& filename);
   void load_layer(const FileReader& filename, 

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-12 00:47:54 UTC (rev 3226)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-12 01:11:10 UTC (rev 3227)
@@ -22,22 +22,23 @@
 #include <gtkmm.h>
 #include <boost/bind.hpp>
 
-#include "sprite2d/sprite.hpp"
+#include "display/compositor.hpp"
 #include "display/display.hpp"
-#include "display/compositor.hpp"
-#include "display/texture_manager.hpp"
-#include "display/surface_manager.hpp"
 #include "display/opengl_state.hpp"
 #include "display/surface.hpp"
-#include "util/pathname.hpp"
+#include "display/surface_manager.hpp"
+#include "display/texture_manager.hpp"
+#include "editor/document.hpp"
 #include "editor/editor_window.hpp"
+#include "editor/functor_command.hpp"
+#include "editor/group_command.hpp"
 #include "editor/scroll_tool.hpp"
 #include "editor/sector_model.hpp"
-#include "editor/group_command.hpp"
-#include "editor/functor_command.hpp"
-#include "editor/document.hpp"
 #include "editor/sprite_object_model.hpp"
 #include "editor/windstille_widget.hpp"
+#include "scenegraph/scene_graph.hpp"
+#include "sprite2d/sprite.hpp"
+#include "util/pathname.hpp"
 
 bool lib_init = false;
 
@@ -46,6 +47,8 @@
                                    const Glib::RefPtr<const Gdk::GL::Context>& share_list)
   : editor(editor_),
     m_document(new Document),
+    m_scene_graph(new SceneGraph()),
+    m_rebuild_scene_graph(true),
     filename(),
     state(),
     compositor(),
@@ -251,6 +254,12 @@
 void
 WindstilleWidget::draw()
 {
+  if (m_rebuild_scene_graph)
+  {
+    m_rebuild_scene_graph = false;
+    m_document->get_sector_model().rebuild_scene_graph(*m_scene_graph);
+  }
+
   if (sc.get())
   {
     state.push(*sc);
@@ -293,7 +302,7 @@
       EditorWindow::current()->get_current_tool()->draw(*sc);
     }
 
-    compositor->render(*sc, &m_document->get_sector_model().get_scene_graph(), state);
+    compositor->render(*sc, m_scene_graph.get(), state);
 
     state.pop(*sc);
 
@@ -555,8 +564,9 @@
 void
 WindstilleWidget::on_document_change()
 {
+  std::cout << "WindstilleWidget::on_document_change" << std::endl;
+  m_rebuild_scene_graph = true;
   EditorWindow::current()->update_undo_state();
-  m_document->get_sector_model().rebuild_scene_graph();
   queue_draw();
 }
 

Modified: trunk/windstille/src/editor/windstille_widget.hpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.hpp	2009-09-12 00:47:54 UTC (rev 3226)
+++ trunk/windstille/src/editor/windstille_widget.hpp	2009-09-12 01:11:10 UTC (rev 3227)
@@ -57,7 +57,9 @@
 private:
   EditorWindow& editor;
 
-  boost::scoped_ptr<Document> m_document;
+  boost::scoped_ptr<Document>   m_document;
+  boost::scoped_ptr<SceneGraph> m_scene_graph;
+  bool m_rebuild_scene_graph;
 
   std::string filename;
 



From grumbel at mail.berlios.de  Sat Sep 12 03:39:26 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 12 Sep 2009 03:39:26 +0200
Subject: [Windstille-commit] r3228 - trunk/windstille/src/editor
Message-ID: <200909120139.n8C1dQJg022190@sheep.berlios.de>

Author: grumbel
Date: 2009-09-12 03:39:26 +0200 (Sat, 12 Sep 2009)
New Revision: 3228

Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/document.hpp
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/navgraph_edge_object_model.cpp
   trunk/windstille/src/editor/navgraph_node_object_model.cpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/windstille_widget.cpp
Log:
Hooked emit m_sig_on_change() when the layer_tree changes

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-12 01:11:10 UTC (rev 3227)
+++ trunk/windstille/src/editor/document.cpp	2009-09-12 01:39:26 UTC (rev 3228)
@@ -44,6 +44,11 @@
     m_control_points(),
     m_sig_on_change()    
 {
+  m_sector_model->get_layer_tree()->signal_row_changed().connect(sigc::mem_fun(*this, &Document::on_row_changed));
+  m_sector_model->get_layer_tree()->signal_row_deleted().connect(sigc::mem_fun(*this, &Document::on_row_deleted));
+  m_sector_model->get_layer_tree()->signal_row_has_child_toggled().connect(sigc::mem_fun(*this, &Document::on_row_has_child_toggled));
+  m_sector_model->get_layer_tree()->signal_row_inserted().connect(sigc::mem_fun(*this, &Document::on_row_inserted));
+  m_sector_model->get_layer_tree()->signal_rows_reordered().connect(sigc::mem_fun(*this, &Document::on_rows_reordered));
 }
 
 Document::Document(const std::string& filename)
@@ -55,6 +60,11 @@
     m_control_points(),
     m_sig_on_change()
 {
+  m_sector_model->get_layer_tree()->signal_row_changed().connect(sigc::mem_fun(*this, &Document::on_row_changed));
+  m_sector_model->get_layer_tree()->signal_row_deleted().connect(sigc::mem_fun(*this, &Document::on_row_deleted));
+  m_sector_model->get_layer_tree()->signal_row_has_child_toggled().connect(sigc::mem_fun(*this, &Document::on_row_has_child_toggled));
+  m_sector_model->get_layer_tree()->signal_row_inserted().connect(sigc::mem_fun(*this, &Document::on_row_inserted));
+  m_sector_model->get_layer_tree()->signal_rows_reordered().connect(sigc::mem_fun(*this, &Document::on_rows_reordered));
 }
 
 Document::~Document()
@@ -535,4 +545,34 @@
   m_selection->add_control_points(m_control_points);
 }
 
+void
+Document::on_row_changed(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter)
+{
+  m_sig_on_change();
+}
+
+void
+Document::on_row_deleted(const Gtk::TreeModel::Path& path)
+{
+  m_sig_on_change();
+}
+
+void
+Document::on_row_has_child_toggled(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter)
+{
+  m_sig_on_change();
+}
+
+void
+Document::on_row_inserted(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter)
+{
+  m_sig_on_change();
+}
+
+void
+Document::on_rows_reordered(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter, int* new_order)
+{
+  m_sig_on_change();
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/document.hpp
===================================================================
--- trunk/windstille/src/editor/document.hpp	2009-09-12 01:11:10 UTC (rev 3227)
+++ trunk/windstille/src/editor/document.hpp	2009-09-12 01:39:26 UTC (rev 3228)
@@ -138,6 +138,12 @@
   void on_selection_change();
   void on_change();
 
+  void on_row_changed(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter);
+  void on_row_deleted(const Gtk::TreeModel::Path& path);
+  void on_row_has_child_toggled(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter);
+  void on_row_inserted(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter);
+  void on_rows_reordered(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter, int* new_order);
+
 private:
   Document(const Document&);
   Document& operator=(const Document&);

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-12 01:11:10 UTC (rev 3227)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-12 01:39:26 UTC (rev 3228)
@@ -16,9 +16,6 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
-// /usr/include/gtkmm-2.4/gtkmm/recentmanager.h causes warning, so we have to disable -Weffc++
-#pragma GCC diagnostic ignored "-Weffc++"
-
 #include <fstream>
 #include <iostream>
 #include <gdkmm/pixbuf.h>

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-12 01:11:10 UTC (rev 3227)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.cpp	2009-09-12 01:39:26 UTC (rev 3228)
@@ -81,7 +81,9 @@
 ObjectModelHandle
 NavGraphEdgeObjectModel::clone() const
 {
-  return ObjectModelHandle();
+  // FIXME: This is incorrect for copy paste, as there we need to
+  // connect to the cloned nodes, not the old ones
+  return ObjectModelHandle(new NavGraphEdgeObjectModel(m_lhs, m_rhs));
 }
 
 void

Modified: trunk/windstille/src/editor/navgraph_node_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-12 01:11:10 UTC (rev 3227)
+++ trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-12 01:39:26 UTC (rev 3228)
@@ -29,7 +29,7 @@
 {
 }
 
-NavGraphNodeObjectModel::NavGraphNodeObjectModel(const Vector2f& pos)//, SectorModel& sector)
+NavGraphNodeObjectModel::NavGraphNodeObjectModel(const Vector2f& pos)
   : ObjectModel("NavGraphNodeObjectModel", pos),
     m_drawable()
 {
@@ -86,7 +86,7 @@
 ObjectModelHandle 
 NavGraphNodeObjectModel::clone() const
 {
-  return ObjectModelHandle();
+  return ObjectModelHandle(new NavGraphNodeObjectModel(get_world_pos()));
 }
 
 void

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-12 01:11:10 UTC (rev 3227)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-12 01:39:26 UTC (rev 3228)
@@ -583,7 +583,7 @@
 }
 
 void
-SectorModel::on_row_changed(const Gtk::TreeModel::Path& /*path*/, const Gtk::TreeModel::iterator& iter)
+SectorModel::on_row_changed(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter)
 {
   //std::cout << "LayerManager:on_row_changed" << std::endl;
 
@@ -599,25 +599,25 @@
 }
 
 void
-SectorModel::on_row_deleted(const Gtk::TreeModel::Path& /*path*/)
+SectorModel::on_row_deleted(const Gtk::TreeModel::Path& path)
 {
   std::cout << "LayerManager:on_row_deleted" << std::endl;
 }
 
 void
-SectorModel::on_row_has_child_toggled(const Gtk::TreeModel::Path& /*path*/, const Gtk::TreeModel::iterator& /*iter*/)
+SectorModel::on_row_has_child_toggled(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& /*iter*/)
 {
   //std::cout << "LayerManager:on_row_has_child_toggled" << std::endl;
 }
 
 void
-SectorModel::on_row_inserted(const Gtk::TreeModel::Path& /*path*/, const Gtk::TreeModel::iterator& /*iter*/)
+SectorModel::on_row_inserted(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& /*iter*/)
 {
   std::cout << "LayerManager:on_row_inserted" << std::endl;
 }
 
 void
-SectorModel::on_rows_reordered(const Gtk::TreeModel::Path& /*path*/, const Gtk::TreeModel::iterator& /*iter*/, int* /*new_order*/)
+SectorModel::on_rows_reordered(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& /*iter*/, int* /*new_order*/)
 {
   std::cout << "LayerManager:on_row_reordered" << std::endl;
 }

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-12 01:11:10 UTC (rev 3227)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-12 01:39:26 UTC (rev 3228)
@@ -420,6 +420,11 @@
       SurfaceManager::current()->save_all_as_png();
       break;
 
+    case GDK_F5: // force a rebuild of the scenegraph
+      m_rebuild_scene_graph = true;
+      queue_draw();
+      break;
+
     case GDK_Delete:
       m_document->selection_delete();
       break;



From grumbel at mail.berlios.de  Sat Sep 12 03:43:48 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 12 Sep 2009 03:43:48 +0200
Subject: [Windstille-commit] r3229 - trunk/windstille/src/editor
Message-ID: <200909120143.n8C1hmBa022432@sheep.berlios.de>

Author: grumbel
Date: 2009-09-12 03:43:47 +0200 (Sat, 12 Sep 2009)
New Revision: 3229

Modified:
   trunk/windstille/src/editor/editor_window.cpp
Log:
Route paste command through undo system

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-12 01:39:26 UTC (rev 3228)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-12 01:43:47 UTC (rev 3229)
@@ -921,11 +921,13 @@
   {
     if (WindstilleWidget* wst = get_windstille_widget())
     {
+      wst->get_document().undo_group_begin();
       LayerHandle layer = wst->get_current_layer();
       for(Selection::reverse_iterator i = clipboard->rbegin(); i != clipboard->rend(); ++i)
       {
-        layer->add(*i);
+        wst->get_document().object_add(layer, *i);
       }
+      wst->get_document().undo_group_end();
 
       wst->get_document().set_selection(clipboard);
       clipboard = clipboard->clone();



From grumbel at mail.berlios.de  Sat Sep 12 05:22:25 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 12 Sep 2009 05:22:25 +0200
Subject: [Windstille-commit] r3230 - trunk/windstille
Message-ID: <200909120322.n8C3MPEU000150@sheep.berlios.de>

Author: grumbel
Date: 2009-09-12 05:22:24 +0200 (Sat, 12 Sep 2009)
New Revision: 3230

Modified:
   trunk/windstille/TODO
Log:
TODO updates

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2009-09-12 01:43:47 UTC (rev 3229)
+++ trunk/windstille/TODO	2009-09-12 03:22:24 UTC (rev 3230)
@@ -13,37 +13,30 @@
 Editor Restructuring
 ====================
 
-* NavigationGraph gets removed (maybe just temporarly, since it could
-  be needed for 'NavGraph snapping')
+* SceneGraph needs to be updated while drag&drop is in progress
 
-* NavigationGraph is replaced with normal ObjectModel objects
-  (NavGraphNodeObjectModel, NavGraphEdgeObjectModel)
+* Move scroll_tool to EditorWindow, away from WindstilleWidget
 
-* NavGraphEdgeObjectModel can be moved around across layers (this is
-  why it needs to be selectable)
+* delete/remove/erase naming is a bit mixed up in a few places
 
-* NavGraphNodeObjectModel are somewhat special in that they show up
-  when their connected Edges shows up
+* ZoomTool seems broken
 
-* NavGraphInsertTool needs to be rewritten
 
-* NavGraphSelectTool would become obsolote
+* being able to directly mark Edges still feels wonky, need to rethink the thing again
 
-* SceneGraph needs to be updated while drag&drop is in progress
+* copy&paste works only very limited with edges, i.e. copying from one
+  sector to another causes crazy stuff to happen as the nodes it links
+  to are on another sector
 
-* deleting a NavGraphNodeObjectModel must remove all the connected
-  NavGraphEdgeObjectModel
+* add grid snapping to navgraph
 
-* Move scroll_tool to EditorWindow, away from WindstilleWidget
+* add horizontal/vertical snapping
 
-* NavGraphEdgeObjectModel modifies the Navgraph by bypassing the undo system, that is wrong
+* draw NavGraph lines thicker (glLineWidth())
 
-* delete/remove/erase naming is a bit mixed up in a few places
+* color code them by layer
 
-* NavGraph object creating and deletion must be routed through undo
-  system, also the raw navgraph must be updated properly
-
-* write NavigationGraphModel (!!!)
+* implement navgraph loading in the game engine
 
 Overview
 ========



From grumbel at mail.berlios.de  Sat Sep 12 07:24:24 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 12 Sep 2009 07:24:24 +0200
Subject: [Windstille-commit] r3231 - trunk/windstille/src/engine
Message-ID: <200909120524.n8C5OOKk010375@sheep.berlios.de>

Author: grumbel
Date: 2009-09-12 07:24:21 +0200 (Sat, 12 Sep 2009)
New Revision: 3231

Added:
   trunk/windstille/src/engine/sector_builder.cpp
   trunk/windstille/src/engine/sector_builder.hpp
Modified:
   trunk/windstille/src/engine/sector.hpp
Log:
Added SectorBuilder class for loading the Sector (rather incomplete right now)

Modified: trunk/windstille/src/engine/sector.hpp
===================================================================
--- trunk/windstille/src/engine/sector.hpp	2009-09-12 03:22:24 UTC (rev 3230)
+++ trunk/windstille/src/engine/sector.hpp	2009-09-12 05:24:21 UTC (rev 3231)
@@ -41,7 +41,6 @@
 class SceneGraph;
 class Doll;
 
-/** */
 class Sector : public Currenton<Sector>
 { 
 private:

Added: trunk/windstille/src/engine/sector_builder.cpp
===================================================================
--- trunk/windstille/src/engine/sector_builder.cpp	2009-09-12 03:22:24 UTC (rev 3230)
+++ trunk/windstille/src/engine/sector_builder.cpp	2009-09-12 05:24:21 UTC (rev 3231)
@@ -0,0 +1,135 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "engine/sector_builder.hpp"
+
+#include <string>
+#include <iostream>
+#include <sstream>
+#include <stdexcept>
+
+#include "app/globals.hpp"
+#include "display/color.hpp"
+#include "engine/game_object.hpp"
+#include "engine/sector.hpp"
+#include "util/file_reader.hpp"
+
+SectorBuilder::SectorBuilder(const Pathname& filename, Sector& sector)
+  : m_filename(filename),
+    m_sector(sector),
+    id_table(),
+    parent_table()
+{
+  if (debug) std::cout << "Sector:parse_file '" << m_filename << "'" << std::endl;
+  
+  FileReader reader = FileReader::parse(m_filename);
+  if(reader.get_name() != "windstille-sector") 
+  {
+    std::ostringstream msg;
+    msg << "'" << m_filename << "' is not a windstille-sector file";
+    throw std::runtime_error(msg.str());
+  }
+  else
+  {
+    parse_body(reader);
+  }
+}
+
+void
+SectorBuilder::parse_body(const FileReader& reader)
+{
+  { // check version
+    int version = 1;
+    if (!reader.get("version", version))
+      std::cerr << "Warning no version specified in levelformat.\n";
+
+    if (version > 3)
+      std::cerr << "Warning: format version is newer than game.\n";
+  }
+
+  //reader.get("name",          name);
+  //reader.get("music",         music);
+  //reader.get("init-script",   init_script);
+
+  Color ambient_light;
+  if (reader.get("ambient-color", ambient_light))
+  {
+    m_sector.set_ambient_light(ambient_light);
+  }
+    
+  parse_objects(reader);
+  parse_navgraph(reader);
+
+  if (debug) std::cout << "Finished parsing" << std::endl;
+}
+
+void
+SectorBuilder::parse_objects(const FileReader& reader)
+{
+  FileReader objects_reader;
+  if (!reader.get("objects", objects_reader))
+  {
+    throw std::runtime_error("No objects specified");
+  }
+  else
+  {
+    std::vector<FileReader> objects_readers = objects_reader.get_sections();
+    for(std::vector<FileReader>::iterator i = objects_readers.begin(); i != objects_readers.end(); ++i)
+    {
+      m_sector.add_object(*i);
+    }
+
+    // Set the parents properly
+    for(std::map<GameObject*, std::string>::iterator i = parent_table.begin(); i != parent_table.end(); ++i)
+    {
+      std::map<std::string, GameObject*>::iterator j = id_table.find(i->second);
+      if (j == id_table.end())
+      {
+        std::cout << "Error: Couldn't resolve 'id': " << i->second << std::endl;
+      }
+      else
+      {
+        i->first->set_parent(j->second);
+      }
+    }
+  }
+}
+
+void
+SectorBuilder::parse_navgraph(const FileReader& reader)
+{
+  FileReader navgraph_reader;
+  if (!reader.get("navigation", navgraph_reader))
+  {
+    throw std::runtime_error("SectorBuilder: 'navigation' section missing");
+  }
+  else
+  {
+    FileReader nodes_reader;
+    if (navgraph_reader.get("nodes", nodes_reader))
+    {
+    }
+
+    FileReader edges_reader;
+    if (navgraph_reader.get("edges", edges_reader))
+    {
+    }
+  }
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/engine/sector_builder.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/engine/sector_builder.hpp
===================================================================
--- trunk/windstille/src/engine/sector_builder.hpp	2009-09-12 03:22:24 UTC (rev 3230)
+++ trunk/windstille/src/engine/sector_builder.hpp	2009-09-12 05:24:21 UTC (rev 3231)
@@ -0,0 +1,53 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_EDITOR_SECTOR_BUILDER_HPP
+#define HEADER_WINDSTILLE_EDITOR_SECTOR_BUILDER_HPP
+
+#include <map>
+#include <string>
+
+class FileReader;
+class GameObject;
+class Pathname;
+class Sector;
+
+class SectorBuilder
+{
+private:
+  const Pathname& m_filename;
+  Sector&  m_sector;
+  std::map<std::string, GameObject*> id_table;
+  std::map<GameObject*, std::string> parent_table;
+
+public:
+  SectorBuilder(const Pathname& filename, Sector& sector);
+  
+private:
+  void parse_body(const FileReader& reader);
+  void parse_objects(const FileReader& reader);
+  void parse_navgraph(const FileReader& reader);
+
+private:
+  SectorBuilder(const SectorBuilder&);
+  SectorBuilder& operator=(const SectorBuilder&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/engine/sector_builder.hpp
___________________________________________________________________
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Sat Sep 12 07:53:27 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 12 Sep 2009 07:53:27 +0200
Subject: [Windstille-commit] r3232 - in trunk/windstille/src: engine objects
	scripting tile
Message-ID: <200909120553.n8C5rRf1008959@sheep.berlios.de>

Author: grumbel
Date: 2009-09-12 07:53:23 +0200 (Sat, 12 Sep 2009)
New Revision: 3232

Modified:
   trunk/windstille/src/engine/sector.cpp
   trunk/windstille/src/engine/sector.hpp
   trunk/windstille/src/engine/sector_builder.cpp
   trunk/windstille/src/engine/sector_builder.hpp
   trunk/windstille/src/objects/background_gradient.cpp
   trunk/windstille/src/objects/background_gradient.hpp
   trunk/windstille/src/objects/box.cpp
   trunk/windstille/src/objects/box.hpp
   trunk/windstille/src/objects/character.cpp
   trunk/windstille/src/objects/character.hpp
   trunk/windstille/src/objects/elevator.cpp
   trunk/windstille/src/objects/elevator.hpp
   trunk/windstille/src/objects/hedgehog.cpp
   trunk/windstille/src/objects/hedgehog.hpp
   trunk/windstille/src/objects/layer.cpp
   trunk/windstille/src/objects/liquid.cpp
   trunk/windstille/src/objects/liquid.hpp
   trunk/windstille/src/objects/nightvision.cpp
   trunk/windstille/src/objects/nightvision.hpp
   trunk/windstille/src/objects/scriptable_object.cpp
   trunk/windstille/src/objects/scriptable_object.hpp
   trunk/windstille/src/objects/shockwave.cpp
   trunk/windstille/src/objects/shockwave.hpp
   trunk/windstille/src/objects/spider_mine.cpp
   trunk/windstille/src/objects/spider_mine.hpp
   trunk/windstille/src/objects/swarm.cpp
   trunk/windstille/src/objects/swarm.hpp
   trunk/windstille/src/objects/test_object.cpp
   trunk/windstille/src/objects/test_object.hpp
   trunk/windstille/src/objects/trigger.cpp
   trunk/windstille/src/objects/trigger.hpp
   trunk/windstille/src/objects/vrdummy.cpp
   trunk/windstille/src/objects/vrdummy.hpp
   trunk/windstille/src/scripting/interface.cpp
   trunk/windstille/src/tile/tile_map.cpp
   trunk/windstille/src/tile/tile_map.hpp
Log:
Implemented SectorBuilder, NavGraph building still missing

Modified: trunk/windstille/src/engine/sector.cpp
===================================================================
--- trunk/windstille/src/engine/sector.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/engine/sector.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -22,6 +22,7 @@
 
 #include "collision/collision_engine.hpp"
 #include "engine/squirrel_thread.hpp"
+#include "engine/sector_builder.hpp"
 #include "navigation/navigation_graph.hpp"
 #include "scenegraph/navigation_graph_drawable.hpp"
 #include "scenegraph/scene_graph.hpp"
@@ -63,16 +64,12 @@
     ambient_light(),
     interactive_tilemap(0),
     interactivebackground_tilemap(0),
-    player(0),
-    id_table(),
-    parent_table()
+    player(0)
 {
   if (debug) std::cout << "Creating new Sector" << std::endl;
   
-  interactive_tilemap = 0;
-  interactivebackground_tilemap = 0;
+  SectorBuilder(arg_filename, *this);
 
-  parse_file(filename);
   if (interactive_tilemap)
   {
     // add interactive to collision engine
@@ -97,187 +94,6 @@
 }
 
 void
-Sector::parse_file(const Pathname& filename_)
-{
-  if (debug) std::cout << "Sector:parse_file '" << filename_ << "'" << std::endl;
-  
-  FileReader reader = FileReader::parse(filename_);
-  if(reader.get_name() != "windstille-sector") 
-  {
-    std::ostringstream msg;
-    msg << "'" << filename_ << "' is not a windstille-sector file";
-    throw std::runtime_error(msg.str());
-  }
-  else
-  {
-    int version = 1;
-    if (!reader.get("version", version))
-      std::cerr << "Warning no version specified in levelformat.\n";
-
-    if (version > 3)
-      std::cerr << "Warning: format version is newer than game.\n";
-
-    reader.get("name",          name);
-    reader.get("music",         music);
-    reader.get("init-script",   init_script);
-    reader.get("ambient-color", ambient_light);
-  
-    FileReader objects_reader;
-    if (!reader.get("objects", objects_reader))
-    {
-      throw std::runtime_error("No objects specified");
-    }
-
-    std::vector<FileReader> objects_readers = objects_reader.get_sections();
-    for(std::vector<FileReader>::iterator i = objects_readers.begin(); i != objects_readers.end(); ++i)
-    {
-      add_object(*i);
-    }
-
-    // Set the parents properly
-    for(std::map<GameObject*, std::string>::iterator i = parent_table.begin(); i != parent_table.end(); ++i)
-    {
-      std::map<std::string, GameObject*>::iterator j = id_table.find(i->second);
-      if (j == id_table.end())
-      {
-        std::cout << "Error: Couldn't resolve 'id': " << i->second << std::endl;
-      }
-      else
-      {
-        i->first->set_parent(j->second);
-      }
-    }
-
-    FileReader navgraph_reader;
-    if (reader.get("navigation", navgraph_reader))
-    {
-      navigation_graph->load(navgraph_reader);
-    }
-
-    if (debug) std::cout << "Finished parsing" << std::endl;
-  }
-}
-
-void
-Sector::add_object(FileReader& reader)
-{
-  GameObject* obj = 0;
-  if(reader.get_name() == "tilemap") 
-  {
-    std::auto_ptr<TileMap> tilemap(new TileMap(reader));
-
-    if (tilemap->get_name() == "interactive")
-      interactive_tilemap = tilemap.get();
-    else if (tilemap->get_name() == "interactivebackground")
-      interactivebackground_tilemap = tilemap.get();
-
-    obj = tilemap.release();
-  }
-  else if(reader.get_name() == "background")
-  {
-    // TODO
-  }
-  else if (reader.get_name() == "background-gradient")
-  {
-    obj = new BackgroundGradient(reader);
-  }
-  else if(reader.get_name() == "trigger")
-  {
-    obj = new Trigger(reader);
-  }
-  else if(reader.get_name() == "box")
-  {
-    obj = new Box(reader);
-  }
-  else if(reader.get_name() == "shockwave")
-  {
-    obj = new Shockwave(reader);
-  }
-  else if(reader.get_name() == "elevator")
-  {
-    obj = new Elevator(reader);
-  }
-  else if(reader.get_name() == "character")
-  {    
-    obj = new Character(reader);
-  }
-  else if(reader.get_name() == "spider-mine")
-  {
-    obj = new SpiderMine(reader);
-  }
-  else if(reader.get_name() == "hedgehog")
-  {
-    obj = new Hedgehog(reader);
-  }
-  else if(reader.get_name() == "test-object")
-  {
-    obj = new TestObject(reader);
-  }
-  else if (reader.get_name() == "nightvision")
-  {
-    obj = new Nightvision(reader);
-  }
-  else if (reader.get_name() == "particle-system")
-  {
-    // FIXME: disabled due to work on the editor: obj = new ParticleSystem(reader);
-  }
-  else if(reader.get_name() == "scriptable-object")
-  {    
-    obj = new ScriptableObject(reader);
-  }
-  else if(reader.get_name() == "decal")
-  {    
-    obj = new Decal(reader);
-  }
-  else if(reader.get_name() == "layer")
-  {    
-    obj = new Layer(reader);
-  }
-  else if (reader.get_name() == "vrdummy")
-  {
-    obj = new VRDummy(reader);
-  }
-  else if (reader.get_name() == "swarm")
-  {
-    obj = new Swarm(reader);
-  }
-  else if (reader.get_name() == "laserpointer")
-  {
-    obj = new LaserPointer();
-  }
-  else if (reader.get_name() == "liquid")
-  {
-    obj = new Liquid(reader);
-  }
-  else if (reader.get_name() == "particle-systems")
-  {
-    obj = new ParticleSystems(reader);
-  }
-  else 
-  {
-    std::cout << "Skipping unknown Object: " << reader.get_name() << "\n";
-  }
-
-  if (obj)
-  {
-    std::string id_str;
-    if (reader.read("id", id_str))
-    {
-      id_table[id_str] = obj;
-    }
-
-    std::string parent_str;
-    if (reader.read("parent", parent_str))
-    {
-      if (!parent_str.empty())
-        parent_table[obj] = parent_str;
-    }
-
-    add(obj);
-  }
-}
-
-void
 Sector::activate()
 {
   commit_adds();

Modified: trunk/windstille/src/engine/sector.hpp
===================================================================
--- trunk/windstille/src/engine/sector.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/engine/sector.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -63,16 +63,15 @@
 
   Color ambient_light;
 
+public:
   /** The TileMap with which the player interacts */
   TileMap* interactive_tilemap;
   TileMap* interactivebackground_tilemap;
 
+private:
   Player* player;
   Doll*   doll;
 
-  std::map<std::string, GameObject*> id_table;
-  std::map<GameObject*, std::string> parent_table;
-
 private:
   void parse_file(const Pathname& filename);
 
@@ -105,7 +104,6 @@
   Color get_ambient_light() const;
 
   void add(GameObject*);
-  void add_object(FileReader& reader);
 
   CollisionEngine* get_collision_engine() const { return collision_engine.get(); }
   SceneGraph& get_scene_graph() const { return *scene_graph; }

Modified: trunk/windstille/src/engine/sector_builder.cpp
===================================================================
--- trunk/windstille/src/engine/sector_builder.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/engine/sector_builder.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -28,7 +28,29 @@
 #include "engine/game_object.hpp"
 #include "engine/sector.hpp"
 #include "util/file_reader.hpp"
+#include "tile/tile_map.hpp"
 
+#include "objects/background_gradient.hpp"
+#include "objects/box.hpp"
+#include "objects/character.hpp"
+#include "objects/decal.hpp"
+#include "objects/doll.hpp"
+#include "objects/elevator.hpp"
+#include "objects/hedgehog.hpp"
+#include "objects/laser_pointer.hpp"
+#include "objects/layer.hpp"
+#include "objects/liquid.hpp"
+#include "objects/nightvision.hpp"
+#include "objects/particle_systems.hpp"
+#include "objects/player.hpp"
+#include "objects/scriptable_object.hpp"
+#include "objects/shockwave.hpp"
+#include "objects/spider_mine.hpp"
+#include "objects/swarm.hpp"
+#include "objects/test_object.hpp"
+#include "objects/trigger.hpp"
+#include "objects/vrdummy.hpp"
+
 SectorBuilder::SectorBuilder(const Pathname& filename, Sector& sector)
   : m_filename(filename),
     m_sector(sector),
@@ -79,9 +101,10 @@
 }
 
 void
-SectorBuilder::parse_objects(const FileReader& reader)
+SectorBuilder::parse_layer(const FileReader& reader)
 {
   FileReader objects_reader;
+
   if (!reader.get("objects", objects_reader))
   {
     throw std::runtime_error("No objects specified");
@@ -91,9 +114,30 @@
     std::vector<FileReader> objects_readers = objects_reader.get_sections();
     for(std::vector<FileReader>::iterator i = objects_readers.begin(); i != objects_readers.end(); ++i)
     {
-      m_sector.add_object(*i);
+      parse_object(*i);
     }
+  }
+}
 
+void
+SectorBuilder::parse_objects(const FileReader& reader)
+{
+  FileReader objects_reader;
+
+  // FIXME: try both for backward compatibility
+  if (!reader.get("objects", objects_reader) &&
+      !reader.get("layers", objects_reader))
+  {
+    throw std::runtime_error("No objects specified");
+  }
+  else
+  {
+    std::vector<FileReader> objects_readers = objects_reader.get_sections();
+    for(std::vector<FileReader>::iterator i = objects_readers.begin(); i != objects_readers.end(); ++i)
+    {
+      parse_object(*i);
+    }
+
     // Set the parents properly
     for(std::map<GameObject*, std::string>::iterator i = parent_table.begin(); i != parent_table.end(); ++i)
     {
@@ -111,12 +155,131 @@
 }
 
 void
+SectorBuilder::parse_object(const FileReader& reader)
+{
+  GameObject* obj = 0;
+  if(reader.get_name() == "tilemap") 
+  {
+    std::auto_ptr<TileMap> tilemap(new TileMap(reader));
+
+    if (tilemap->get_name() == "interactive")
+      m_sector.interactive_tilemap = tilemap.get();
+    else if (tilemap->get_name() == "interactivebackground")
+      m_sector.interactivebackground_tilemap = tilemap.get();
+
+    obj = tilemap.release();
+  }
+  else if(reader.get_name() == "background")
+  {
+    // TODO
+  }
+  else if (reader.get_name() == "background-gradient")
+  {
+    obj = new BackgroundGradient(reader);
+  }
+  else if(reader.get_name() == "trigger")
+  {
+    obj = new Trigger(reader);
+  }
+  else if(reader.get_name() == "box")
+  {
+    obj = new Box(reader);
+  }
+  else if(reader.get_name() == "shockwave")
+  {
+    obj = new Shockwave(reader);
+  }
+  else if(reader.get_name() == "elevator")
+  {
+    obj = new Elevator(reader);
+  }
+  else if(reader.get_name() == "character")
+  {    
+    obj = new Character(reader);
+  }
+  else if(reader.get_name() == "spider-mine")
+  {
+    obj = new SpiderMine(reader);
+  }
+  else if(reader.get_name() == "hedgehog")
+  {
+    obj = new Hedgehog(reader);
+  }
+  else if(reader.get_name() == "test-object")
+  {
+    obj = new TestObject(reader);
+  }
+  else if (reader.get_name() == "nightvision")
+  {
+    obj = new Nightvision(reader);
+  }
+  else if (reader.get_name() == "particle-system")
+  {
+    // FIXME: disabled due to work on the editor: obj = new ParticleSystem(reader);
+  }
+  else if(reader.get_name() == "scriptable-object")
+  {    
+    obj = new ScriptableObject(reader);
+  }
+  else if(reader.get_name() == "decal")
+  {    
+    obj = new Decal(reader);
+  }
+  else if(reader.get_name() == "layer")
+  {    
+    parse_layer(reader);
+  }
+  else if (reader.get_name() == "vrdummy")
+  {
+    obj = new VRDummy(reader);
+  }
+  else if (reader.get_name() == "swarm")
+  {
+    obj = new Swarm(reader);
+  }
+  else if (reader.get_name() == "laserpointer")
+  {
+    obj = new LaserPointer();
+  }
+  else if (reader.get_name() == "liquid")
+  {
+    obj = new Liquid(reader);
+  }
+  else if (reader.get_name() == "particle-systems")
+  {
+    obj = new ParticleSystems(reader);
+  }
+  else 
+  {
+    std::cout << "Skipping unknown Object: " << reader.get_name() << "\n";
+  }
+
+  if (obj)
+  {
+    std::string id_str;
+    if (reader.read("id", id_str))
+    {
+      id_table[id_str] = obj;
+    }
+
+    std::string parent_str;
+    if (reader.read("parent", parent_str))
+    {
+      if (!parent_str.empty())
+        parent_table[obj] = parent_str;
+    }
+
+    m_sector.add(obj);
+  }
+}
+
+void
 SectorBuilder::parse_navgraph(const FileReader& reader)
 {
   FileReader navgraph_reader;
   if (!reader.get("navigation", navgraph_reader))
   {
-    throw std::runtime_error("SectorBuilder: 'navigation' section missing");
+    //throw std::runtime_error("SectorBuilder: 'navigation' section missing");
   }
   else
   {

Modified: trunk/windstille/src/engine/sector_builder.hpp
===================================================================
--- trunk/windstille/src/engine/sector_builder.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/engine/sector_builder.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -40,7 +40,9 @@
   
 private:
   void parse_body(const FileReader& reader);
+  void parse_layer(const FileReader& reader);
   void parse_objects(const FileReader& reader);
+  void parse_object(const FileReader& reader);
   void parse_navgraph(const FileReader& reader);
 
 private:

Modified: trunk/windstille/src/objects/background_gradient.cpp
===================================================================
--- trunk/windstille/src/objects/background_gradient.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/background_gradient.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -23,7 +23,7 @@
 #include "scenegraph/vertex_array_drawable.hpp"
 #include "scenegraph/gradient_drawable.hpp"
 
-BackgroundGradient::BackgroundGradient(FileReader& props)
+BackgroundGradient::BackgroundGradient(const FileReader& props)
   : drawable()
 {
   std::vector<float> colors;

Modified: trunk/windstille/src/objects/background_gradient.hpp
===================================================================
--- trunk/windstille/src/objects/background_gradient.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/background_gradient.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -29,7 +29,7 @@
   boost::shared_ptr<GradientDrawable> drawable;
 
 public:
-  BackgroundGradient(FileReader& props);
+  BackgroundGradient(const FileReader& props);
   ~BackgroundGradient();
     
 private:

Modified: trunk/windstille/src/objects/box.cpp
===================================================================
--- trunk/windstille/src/objects/box.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/box.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -22,7 +22,7 @@
 
 #include "collision/collision_engine.hpp"
 
-Box::Box(FileReader& props)
+Box::Box(const FileReader& props)
   : sprite(),
     colobj(0),
     gravity()

Modified: trunk/windstille/src/objects/box.hpp
===================================================================
--- trunk/windstille/src/objects/box.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/box.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -33,7 +33,7 @@
   float gravity;
 
 public:
-  Box(FileReader& props);
+  Box(const FileReader& props);
   virtual ~Box();
 
   void collision(const CollisionData& data); 

Modified: trunk/windstille/src/objects/character.cpp
===================================================================
--- trunk/windstille/src/objects/character.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/character.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -22,7 +22,7 @@
 #include "engine/script_manager.hpp"
 #include "app/console.hpp"
 
-Character::Character(FileReader& props)
+Character::Character(const FileReader& props)
   : sprite(),
     z_pos(100.0f)
 {

Modified: trunk/windstille/src/objects/character.hpp
===================================================================
--- trunk/windstille/src/objects/character.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/character.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -29,7 +29,7 @@
   float z_pos;
     
 public:
-  Character(FileReader& props);
+  Character(const FileReader& props);
   ~Character();
   
   void update(float delta);

Modified: trunk/windstille/src/objects/elevator.cpp
===================================================================
--- trunk/windstille/src/objects/elevator.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/elevator.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -20,7 +20,7 @@
 #include "engine/sector.hpp"
 #include "collision/collision_engine.hpp"
 
-Elevator::Elevator(FileReader& props)
+Elevator::Elevator(const FileReader& props)
   : size(),
     colobject(),
     sprite()

Modified: trunk/windstille/src/objects/elevator.hpp
===================================================================
--- trunk/windstille/src/objects/elevator.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/elevator.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -32,7 +32,7 @@
   Sprite sprite;
 
 public:
-  Elevator(FileReader& props);
+  Elevator(const FileReader& props);
   ~Elevator();
 
   void draw(SceneContext& sc);

Modified: trunk/windstille/src/objects/hedgehog.cpp
===================================================================
--- trunk/windstille/src/objects/hedgehog.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/hedgehog.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -19,7 +19,7 @@
 #include "objects/player.hpp"
 #include "objects/hedgehog.hpp"
 
-Hedgehog::Hedgehog(FileReader& props)
+Hedgehog::Hedgehog(const FileReader& props)
   : sprite(Pathname("images/hedgehog.sprite")),
     die_sprite(Pathname("images/hedgehog_die1.sprite")),
     light(Pathname("images/hedgehog_light.sprite")),

Modified: trunk/windstille/src/objects/hedgehog.hpp
===================================================================
--- trunk/windstille/src/objects/hedgehog.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/hedgehog.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -32,7 +32,7 @@
   bool direction_left;
   enum { WALKING, FALLING, DYING } state;
 public:
-  Hedgehog(FileReader& props);
+  Hedgehog(const FileReader& props);
   ~Hedgehog();
 
   void draw(SceneContext& gc);

Modified: trunk/windstille/src/objects/layer.cpp
===================================================================
--- trunk/windstille/src/objects/layer.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/layer.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -27,6 +27,7 @@
   : objects(),
     new_objects()
 {
+#if 0
   FileReader objects_reader;
   if(reader.get("objects", objects_reader) == false)
   {
@@ -40,6 +41,7 @@
       Sector::current()->add_object(*i);
     }
   }
+#endif
 }
 
 Layer::~Layer()

Modified: trunk/windstille/src/objects/liquid.cpp
===================================================================
--- trunk/windstille/src/objects/liquid.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/liquid.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -24,7 +24,7 @@
 
 #define SAMPLES 5
 
-Liquid::Liquid(FileReader& props)
+Liquid::Liquid(const FileReader& props)
   : texture(),
     t(),
     heightfield_store1(),

Modified: trunk/windstille/src/objects/liquid.hpp
===================================================================
--- trunk/windstille/src/objects/liquid.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/liquid.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -41,7 +41,7 @@
   boost::shared_ptr<VertexArrayDrawable> m_water_body;
 
 public:
-  Liquid(FileReader& props);
+  Liquid(const FileReader& props);
   ~Liquid();
 
   void update(float delta);

Modified: trunk/windstille/src/objects/nightvision.cpp
===================================================================
--- trunk/windstille/src/objects/nightvision.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/nightvision.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -22,7 +22,7 @@
 #include "scenegraph/vertex_array_drawable.hpp"
 #include "math/random.hpp"
 
-Nightvision::Nightvision(FileReader& /*props*/)
+Nightvision::Nightvision(const FileReader& props)
   : nightvision(Pathname("images/nightvision.sprite")),
     noise(Pathname("images/noise.png"))
 {

Modified: trunk/windstille/src/objects/nightvision.hpp
===================================================================
--- trunk/windstille/src/objects/nightvision.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/nightvision.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -31,7 +31,7 @@
   Texture noise;
 
 public:
-  Nightvision(FileReader& props);
+  Nightvision(const FileReader& props);
   ~Nightvision();
 
   void draw(SceneContext& sc);

Modified: trunk/windstille/src/objects/scriptable_object.cpp
===================================================================
--- trunk/windstille/src/objects/scriptable_object.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/scriptable_object.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -22,7 +22,7 @@
 #include "app/globals.hpp"
 #include "objects/scriptable_object.hpp"
 
-ScriptableObject::ScriptableObject(FileReader& props)
+ScriptableObject::ScriptableObject(const FileReader& props)
   : z_pos(50),
     target_speed(0),
     acceleration(0),

Modified: trunk/windstille/src/objects/scriptable_object.hpp
===================================================================
--- trunk/windstille/src/objects/scriptable_object.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/scriptable_object.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -58,7 +58,7 @@
   void flash();
 
 public:
-  ScriptableObject(FileReader& reader);
+  ScriptableObject(const FileReader& reader);
   virtual ~ScriptableObject();
 
   void draw (SceneContext& sc);

Modified: trunk/windstille/src/objects/shockwave.cpp
===================================================================
--- trunk/windstille/src/objects/shockwave.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/shockwave.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -22,7 +22,7 @@
 #include "display/shader_object.hpp"
 #include "scenegraph/shockwave_drawable.hpp"
 
-Shockwave::Shockwave(FileReader& props)
+Shockwave::Shockwave(const FileReader& props)
   : pos(),
     noise(Pathname("images/noise3.png")),
     shader_program(),

Modified: trunk/windstille/src/objects/shockwave.hpp
===================================================================
--- trunk/windstille/src/objects/shockwave.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/shockwave.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -32,7 +32,7 @@
   float radius;
 
 public:
-  Shockwave(FileReader& props);
+  Shockwave(const FileReader& props);
   ~Shockwave();
 
   void draw (SceneContext& context);

Modified: trunk/windstille/src/objects/spider_mine.cpp
===================================================================
--- trunk/windstille/src/objects/spider_mine.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/spider_mine.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -19,7 +19,7 @@
 #include "objects/spider_mine.hpp"
 #include "objects/player.hpp"
 
-SpiderMine::SpiderMine(FileReader& props)
+SpiderMine::SpiderMine(const FileReader& props)
   : sprite(),
     explode(Pathname("images/explosion.sprite")),
     explode_light(Pathname("images/explolight.sprite")),

Modified: trunk/windstille/src/objects/spider_mine.hpp
===================================================================
--- trunk/windstille/src/objects/spider_mine.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/spider_mine.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -38,7 +38,7 @@
   void search_for_player(float delta);
 
 public:
-  SpiderMine(FileReader& props);
+  SpiderMine(const FileReader& props);
   ~SpiderMine();
   
   void update(float delta);

Modified: trunk/windstille/src/objects/swarm.cpp
===================================================================
--- trunk/windstille/src/objects/swarm.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/swarm.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -23,7 +23,7 @@
 
 #include "objects/swarm.hpp"
 
-Swarm::Swarm(FileReader& props)
+Swarm::Swarm(const FileReader& props)
   : agents(),
     target(),
     turn_speed()

Modified: trunk/windstille/src/objects/swarm.hpp
===================================================================
--- trunk/windstille/src/objects/swarm.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/swarm.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -53,7 +53,7 @@
   float turn_speed; 
 
 public:
-  Swarm(FileReader& reader);
+  Swarm(const FileReader& reader);
   
   void draw(SceneContext& sc);
   void update(float delta);

Modified: trunk/windstille/src/objects/test_object.cpp
===================================================================
--- trunk/windstille/src/objects/test_object.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/test_object.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -20,7 +20,7 @@
 
 #include "objects/test_object.hpp"
 
-TestObject::TestObject(FileReader& props)
+TestObject::TestObject(const FileReader& props)
   : sprite(),
     attached_sprites(),
     pos()

Modified: trunk/windstille/src/objects/test_object.hpp
===================================================================
--- trunk/windstille/src/objects/test_object.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/test_object.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -28,7 +28,7 @@
 class TestObject : public GameObject
 {
 public:
-  TestObject(FileReader& reader);
+  TestObject(const FileReader& reader);
   virtual ~TestObject();
 
   void draw(SceneContext& context);

Modified: trunk/windstille/src/objects/trigger.cpp
===================================================================
--- trunk/windstille/src/objects/trigger.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/trigger.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -21,7 +21,7 @@
 #include "engine/sector.hpp"
 #include "objects/player.hpp"
 
-Trigger::Trigger(FileReader& props)
+Trigger::Trigger(const FileReader& props)
   : area(),
     callback(),
     triggered(false), 

Modified: trunk/windstille/src/objects/trigger.hpp
===================================================================
--- trunk/windstille/src/objects/trigger.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/trigger.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -36,7 +36,7 @@
   bool one_time_trigger;
   
 public:
-  Trigger(FileReader& props);
+  Trigger(const FileReader& props);
   virtual ~Trigger();
 
   void draw (SceneContext& gc);

Modified: trunk/windstille/src/objects/vrdummy.cpp
===================================================================
--- trunk/windstille/src/objects/vrdummy.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/vrdummy.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -19,7 +19,7 @@
 #include "math/random.hpp"
 #include "objects/vrdummy.hpp"
 
-VRDummy::VRDummy(FileReader& props)
+VRDummy::VRDummy(const FileReader& props)
   : sprite(),
     highlight(),
     rotation(),

Modified: trunk/windstille/src/objects/vrdummy.hpp
===================================================================
--- trunk/windstille/src/objects/vrdummy.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/objects/vrdummy.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -34,7 +34,7 @@
   float jump_time;
 
 public:
-  VRDummy(FileReader& props);
+  VRDummy(const FileReader& props);
   ~VRDummy();
 
   void draw(SceneContext& gc);

Modified: trunk/windstille/src/scripting/interface.cpp
===================================================================
--- trunk/windstille/src/scripting/interface.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/scripting/interface.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -368,8 +368,9 @@
 
     try 
     {
-      SExprFileReader reader(new lisp::Lisp(entries), true);
-      Sector::current()->add_object(reader);
+      assert(!"spawn_object is broken");
+      //SExprFileReader reader(new lisp::Lisp(entries), true);
+      //Sector::current()->add_object(reader);
     }
     catch (std::exception& e) 
     {

Modified: trunk/windstille/src/tile/tile_map.cpp
===================================================================
--- trunk/windstille/src/tile/tile_map.cpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/tile/tile_map.cpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -28,7 +28,7 @@
 #include "screen/view.hpp"
 #include "scenegraph/vertex_array_drawable.hpp"
 
-TileMap::TileMap(FileReader& props)
+TileMap::TileMap(const FileReader& props)
   : field(),
     z_pos(),
     total_time()

Modified: trunk/windstille/src/tile/tile_map.hpp
===================================================================
--- trunk/windstille/src/tile/tile_map.hpp	2009-09-12 05:24:21 UTC (rev 3231)
+++ trunk/windstille/src/tile/tile_map.hpp	2009-09-12 05:53:23 UTC (rev 3232)
@@ -37,7 +37,7 @@
   float total_time;
 
 public:
-  TileMap(FileReader& props);
+  TileMap(const FileReader& props);
   virtual ~TileMap();
 
   void update (float delta);



From grumbel at mail.berlios.de  Sat Sep 12 17:35:17 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 12 Sep 2009 17:35:17 +0200
Subject: [Windstille-commit] r3233 - in trunk/windstille/src: editor
	scenegraph
Message-ID: <200909121535.n8CFZHYZ002135@sheep.berlios.de>

Author: grumbel
Date: 2009-09-12 17:35:16 +0200 (Sat, 12 Sep 2009)
New Revision: 3233

Modified:
   trunk/windstille/src/editor/decal_object_model.cpp
   trunk/windstille/src/scenegraph/surface_quad_drawable.hpp
Log:
Added proper highlight/lightmap handling


Modified: trunk/windstille/src/editor/decal_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.cpp	2009-09-12 05:53:23 UTC (rev 3232)
+++ trunk/windstille/src/editor/decal_object_model.cpp	2009-09-12 15:35:16 UTC (rev 3233)
@@ -271,9 +271,28 @@
 {
   if (!m_drawable)
   {
+    // FIXME: Could recycle the drawable, instead of allocating a new one each time
     m_drawable.reset(new SurfaceQuadDrawable(surface, Vector2f(), Quad(get_bounding_box()),
                                              DrawingParameters(), 0.0f,
                                              Matrix::identity()));
+    
+    switch(type)
+    {
+      case COLORMAP:     
+        m_drawable->set_render_mask(SceneContext::COLORMAP);
+        break;
+
+      case LIGHTMAP:
+        m_drawable->set_render_mask(SceneContext::LIGHTMAP);
+        m_drawable->get_params().set_blend_func(GL_SRC_ALPHA, GL_ONE); 
+        break;
+
+      case HIGHLIGHTMAP: 
+        m_drawable->set_render_mask(SceneContext::HIGHLIGHTMAP);
+        m_drawable->get_params().set_blend_func(GL_SRC_ALPHA, GL_ONE); 
+        break;
+    }
+
     sync();
   }
 

Modified: trunk/windstille/src/scenegraph/surface_quad_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/surface_quad_drawable.hpp	2009-09-12 05:53:23 UTC (rev 3232)
+++ trunk/windstille/src/scenegraph/surface_quad_drawable.hpp	2009-09-12 15:35:16 UTC (rev 3233)
@@ -42,6 +42,8 @@
   {
   }
 
+  DrawingParameters& get_params() { return m_params; }
+
   void draw() 
   {
     OpenGLState state;



From grumbel at mail.berlios.de  Sat Sep 12 17:36:39 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 12 Sep 2009 17:36:39 +0200
Subject: [Windstille-commit] r3234 - trunk/windstille/src/engine
Message-ID: <200909121536.n8CFaddn002245@sheep.berlios.de>

Author: grumbel
Date: 2009-09-12 17:36:38 +0200 (Sat, 12 Sep 2009)
New Revision: 3234

Modified:
   trunk/windstille/src/engine/sector_builder.cpp
Log:
Implemented navgraph loading


Modified: trunk/windstille/src/engine/sector_builder.cpp
===================================================================
--- trunk/windstille/src/engine/sector_builder.cpp	2009-09-12 15:35:16 UTC (rev 3233)
+++ trunk/windstille/src/engine/sector_builder.cpp	2009-09-12 15:36:38 UTC (rev 3234)
@@ -27,8 +27,9 @@
 #include "display/color.hpp"
 #include "engine/game_object.hpp"
 #include "engine/sector.hpp"
+#include "navigation/navigation_graph.hpp"
+#include "tile/tile_map.hpp"
 #include "util/file_reader.hpp"
-#include "tile/tile_map.hpp"
 
 #include "objects/background_gradient.hpp"
 #include "objects/box.hpp"
@@ -276,21 +277,68 @@
 void
 SectorBuilder::parse_navgraph(const FileReader& reader)
 {
+  std::map<std::string, NodeHandle> id_to_node;
+
   FileReader navgraph_reader;
   if (!reader.get("navigation", navgraph_reader))
   {
-    //throw std::runtime_error("SectorBuilder: 'navigation' section missing");
+    throw std::runtime_error("SectorBuilder: 'navigation' section missing");
   }
   else
   {
     FileReader nodes_reader;
     if (navgraph_reader.get("nodes", nodes_reader))
     {
+      const std::vector<FileReader>& nodes_readers = nodes_reader.get_sections();
+      for(std::vector<FileReader>::const_iterator i = nodes_readers.begin(); i != nodes_readers.end(); ++i)
+      {
+        if (i->get_name() != "navgraph-node")
+        {
+          std::cout << "SectorBuilder::parse_navgraph(): Unknown nodes tag: " << i->get_name() << std::endl;
+        }
+        else
+        {
+          Vector2f pos;
+          if (i->get("pos", pos))
+          {
+            NodeHandle node = m_sector.get_navigation_graph().add_node(pos);
+            std::string id;
+            if (i->get("id", id))
+            {
+              id_to_node[id] = node;
+            }
+          }
+        }
+      }
     }
 
     FileReader edges_reader;
     if (navgraph_reader.get("edges", edges_reader))
     {
+      const std::vector<FileReader>& edges_readers = edges_reader.get_sections();
+      for(std::vector<FileReader>::const_iterator i = edges_readers.begin(); i != edges_readers.end(); ++i)
+      {
+        if (i->get_name() != "navgraph-edge")
+        {
+          std::cout << "SectorBuilder::parse_navgraph(): Unknown edges tag: " << i->get_name() << std::endl;
+        }
+        else
+        {
+          std::string lhs_node;
+          std::string rhs_node;
+          if (i->get("lhs-node", lhs_node) &&
+              i->get("rhs-node", rhs_node))
+          {
+            std::map<std::string, NodeHandle>::iterator lhs = id_to_node.find(lhs_node);
+            std::map<std::string, NodeHandle>::iterator rhs = id_to_node.find(rhs_node);
+            if (lhs != id_to_node.end() &&
+                rhs != id_to_node.end())
+            {
+              EdgeHandle edge = m_sector.get_navigation_graph().add_edge(lhs->second, rhs->second);
+            }
+          }
+        }
+      }
     }
   }
 }



From grumbel at mail.berlios.de  Sat Sep 12 17:37:56 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 12 Sep 2009 17:37:56 +0200
Subject: [Windstille-commit] r3235 - trunk/windstille/src/editor
Message-ID: <200909121537.n8CFbua0002375@sheep.berlios.de>

Author: grumbel
Date: 2009-09-12 17:37:56 +0200 (Sat, 12 Sep 2009)
New Revision: 3235

Modified:
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/windstille_widget.cpp
Log:
Fixed a few issues with the display not getting properly updated

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-12 15:36:38 UTC (rev 3234)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-12 15:37:56 UTC (rev 3235)
@@ -463,7 +463,7 @@
     wst->load_file(filename);
     wst->set_filename(filename);
     notebook.set_tab_label_text(*notebook.get_nth_page(notebook.get_current_page()), Glib::path_get_basename(filename));
-
+    layer_manager.set_model(&wst->get_document().get_sector_model());
     print("Loaded: " + filename);
   }
   catch(std::exception& err)
@@ -790,7 +790,7 @@
 }
 
 void
-EditorWindow::on_switch_page(GtkNotebookPage* /*page*/, guint /*page_num*/)
+EditorWindow::on_switch_page(GtkNotebookPage* page, guint page_num)
 {
   //std::cout << "on_switch_page(" << page << ", " << page_num << ")" << std::endl;
 

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-12 15:36:38 UTC (rev 3234)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-12 15:37:56 UTC (rev 3235)
@@ -585,7 +585,7 @@
 void
 SectorModel::on_row_changed(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter)
 {
-  //std::cout << "LayerManager:on_row_changed" << std::endl;
+  std::cout << "LayerManager:on_row_changed" << std::endl;
 
   if (iter)
   {
@@ -605,19 +605,19 @@
 }
 
 void
-SectorModel::on_row_has_child_toggled(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& /*iter*/)
+SectorModel::on_row_has_child_toggled(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter)
 {
   //std::cout << "LayerManager:on_row_has_child_toggled" << std::endl;
 }
 
 void
-SectorModel::on_row_inserted(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& /*iter*/)
+SectorModel::on_row_inserted(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter)
 {
   std::cout << "LayerManager:on_row_inserted" << std::endl;
 }
 
 void
-SectorModel::on_rows_reordered(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& /*iter*/, int* /*new_order*/)
+SectorModel::on_rows_reordered(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter, int* new_order)
 {
   std::cout << "LayerManager:on_row_reordered" << std::endl;
 }

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-12 15:36:38 UTC (rev 3234)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-12 15:37:56 UTC (rev 3235)
@@ -118,7 +118,7 @@
   targets.push_back(Gtk::TargetEntry("application/x-windstille-decal"));
   drag_dest_set(targets, Gtk::DEST_DEFAULT_ALL, Gdk::ACTION_COPY);
 
-  m_document->signal_on_change().connect(sigc::mem_fun(this, &WindstilleWidget::on_document_change));
+  m_document->signal_on_change().connect(sigc::mem_fun(*this, &WindstilleWidget::on_document_change));
 }
 
 WindstilleWidget::~WindstilleWidget()
@@ -254,7 +254,7 @@
 void
 WindstilleWidget::draw()
 {
-  if (m_rebuild_scene_graph)
+  if (true || m_rebuild_scene_graph) // FIXME: always rebuild for now, optimize later
   {
     m_rebuild_scene_graph = false;
     m_document->get_sector_model().rebuild_scene_graph(*m_scene_graph);
@@ -592,6 +592,7 @@
 {
   filename = filename_;
   m_document.reset(new Document(filename));
+  m_document->signal_on_change().connect(sigc::mem_fun(*this, &WindstilleWidget::on_document_change));
   on_document_change();
 }
 



From grumbel at mail.berlios.de  Sat Sep 12 23:02:55 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 12 Sep 2009 23:02:55 +0200
Subject: [Windstille-commit] r3236 - trunk/windstille/src/editor
Message-ID: <200909122102.n8CL2tEn006765@sheep.berlios.de>

Author: grumbel
Date: 2009-09-12 23:02:54 +0200 (Sat, 12 Sep 2009)
New Revision: 3236

Modified:
   trunk/windstille/src/editor/decal_object_model.cpp
   trunk/windstille/src/editor/decal_object_model.hpp
Log:
Use SurfaceDrawable instead of SurfaceQuadDrawable


Modified: trunk/windstille/src/editor/decal_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.cpp	2009-09-12 15:37:56 UTC (rev 3235)
+++ trunk/windstille/src/editor/decal_object_model.cpp	2009-09-12 21:02:54 UTC (rev 3236)
@@ -18,17 +18,16 @@
 
 #include <iostream>
 
-#include "util/file_reader.hpp"
+#include "display/drawing_parameters.hpp"
+#include "display/scene_context.hpp"
 #include "display/surface.hpp"
-#include "display/drawing_parameters.hpp"
 #include "display/surface_drawing_parameters.hpp"
-#include "display/surface_drawing_parameters.hpp"
-#include "display/scene_context.hpp"
+#include "editor/decal_rotate_control_point.hpp"
 #include "editor/decal_scale_control_point.hpp"
-#include "editor/decal_rotate_control_point.hpp"
-#include "scenegraph/surface_quad_drawable.hpp"
+#include "editor/sector_model.hpp"
 #include "scenegraph/scene_graph.hpp"
-#include "editor/sector_model.hpp"
+#include "scenegraph/surface_drawable.hpp"
+#include "util/file_reader.hpp"
 
 #include "editor/decal_object_model.hpp"
 
@@ -272,10 +271,14 @@
   if (!m_drawable)
   {
     // FIXME: Could recycle the drawable, instead of allocating a new one each time
-    m_drawable.reset(new SurfaceQuadDrawable(surface, Vector2f(), Quad(get_bounding_box()),
-                                             DrawingParameters(), 0.0f,
-                                             Matrix::identity()));
-    
+    m_drawable.reset(new SurfaceDrawable(surface, 
+                                         SurfaceDrawingParameters()
+                                         .set_hflip(hflip)
+                                         .set_vflip(vflip)
+                                         .set_scale(scale)
+                                         .set_angle(angle),
+                                         0.0f, Matrix::identity()));
+
     switch(type)
     {
       case COLORMAP:     
@@ -304,9 +307,18 @@
 {
   if (m_drawable)
   {
-    Quad quad(get_bounding_box());
-    quad.rotate(angle);
-    m_drawable->set_quad(quad);
+    Vector2f center_offset(-surface.get_width() /2,
+                           -surface.get_height()/2);
+
+    center_offset.x *= scale.x;
+    center_offset.y *= scale.y;
+
+    m_drawable->get_params()
+      .set_pos(get_world_pos() + center_offset)
+      .set_hflip(hflip)
+      .set_vflip(vflip)
+      .set_scale(scale)
+      .set_angle(angle);
   }
 }
 

Modified: trunk/windstille/src/editor/decal_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.hpp	2009-09-12 15:37:56 UTC (rev 3235)
+++ trunk/windstille/src/editor/decal_object_model.hpp	2009-09-12 21:02:54 UTC (rev 3236)
@@ -25,7 +25,7 @@
 #include "display/software_surface.hpp"
 #include "editor/object_model.hpp"
 
-class SurfaceQuadDrawable;
+class SurfaceDrawable;
 
 class DecalObjectModel : public ObjectModel
 {
@@ -48,7 +48,7 @@
   bool hflip;
   bool vflip;
 
-  boost::shared_ptr<SurfaceQuadDrawable> m_drawable;
+  boost::shared_ptr<SurfaceDrawable> m_drawable;
 
 public:
   DecalObjectModel(const FileReader& reader);



From grumbel at mail.berlios.de  Sat Sep 12 23:05:23 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 12 Sep 2009 23:05:23 +0200
Subject: [Windstille-commit] r3237 - trunk/windstille/src/editor
Message-ID: <200909122105.n8CL5N0K006933@sheep.berlios.de>

Author: grumbel
Date: 2009-09-12 23:05:23 +0200 (Sat, 12 Sep 2009)
New Revision: 3237

Modified:
   trunk/windstille/src/editor/navgraph_insert_tool.cpp
Log:
Added edge snapping to horizontal/vertical


Modified: trunk/windstille/src/editor/navgraph_insert_tool.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-12 21:02:54 UTC (rev 3236)
+++ trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-12 21:05:23 UTC (rev 3237)
@@ -68,6 +68,24 @@
       }
       else
       { // connect last node with newly created node
+        if (event->state & GDK_SHIFT_MASK && 
+            last_node)
+        {
+          float angle = atan2f(mouse_pos.y - last_node->get_world_pos().y,
+                               mouse_pos.x - last_node->get_world_pos().x);
+
+          std::cout << angle << std::endl;
+          if (fabsf(angle) > 1.0f/4.0f * math::pi &&
+              fabsf(angle) < 3.0f/4.0f * math::pi)
+          {
+            mouse_pos.x = last_node->get_world_pos().x;
+          }
+          else 
+          {
+            mouse_pos.y = last_node->get_world_pos().y;
+          }
+        }
+
         boost::shared_ptr<NavGraphNodeObjectModel> node_obj(new NavGraphNodeObjectModel(mouse_pos));
         
         wst.get_document().undo_group_begin();
@@ -143,6 +161,24 @@
     case NO_MODE:
       break;
   }
+
+  if (event->state & GDK_SHIFT_MASK && 
+      last_node)
+  {
+    float angle = atan2f(mouse_pos.y - last_node->get_world_pos().y,
+                         mouse_pos.x - last_node->get_world_pos().x);
+
+    std::cout << angle << std::endl;
+    if (fabsf(angle) > 1.0f/4.0f * math::pi &&
+        fabsf(angle) < 3.0f/4.0f * math::pi)
+    {
+      mouse_pos.x = last_node->get_world_pos().x;
+    }
+    else 
+    {
+      mouse_pos.y = last_node->get_world_pos().y;
+    }
+  }
 }
 
 void
@@ -200,7 +236,7 @@
   if (last_node)
   {
     if (connection_node)
-    {
+    {        
       sc.control().draw_line(last_node->get_world_pos(), connection_node->get_world_pos(), Color(1,1,1));
       sc.control().draw_rect(Rectf(connection_node->get_world_pos() - Vector2f(16,16), Sizef(32,32)), Color(1.0f, 1.0f, 1.0f));
     }



From grumbel at mail.berlios.de  Sat Sep 12 23:06:46 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 12 Sep 2009 23:06:46 +0200
Subject: [Windstille-commit] r3238 - in trunk/windstille/src: editor
	scenegraph
Message-ID: <200909122106.n8CL6kMc007091@sheep.berlios.de>

Author: grumbel
Date: 2009-09-12 23:06:43 +0200 (Sat, 12 Sep 2009)
New Revision: 3238

Modified:
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/windstille_widget.cpp
   trunk/windstille/src/scenegraph/surface_drawable.hpp
   trunk/windstille/src/scenegraph/vertex_array_drawable.cpp
Log:
Misc smaller changes


Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-12 21:05:23 UTC (rev 3237)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-12 21:06:43 UTC (rev 3238)
@@ -575,7 +575,7 @@
     }
   }
 
-  std::cout << "rebuild_scene_graph: " << nav_graph->get_nodes().size() << std::endl;
+  //std::cout << "rebuild_scene_graph: " << nav_graph->get_nodes().size() << std::endl;
   for(NavigationGraphModel::Nodes::const_iterator i = nav_graph->get_nodes().begin(); i != nav_graph->get_nodes().end(); ++i)
   {
     (*i)->add_to_scenegraph(sg);

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-12 21:05:23 UTC (rev 3237)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-12 21:06:43 UTC (rev 3238)
@@ -134,16 +134,9 @@
 void
 WindstilleWidget::on_realize()
 {
+  std::cout << "WindstilleWidget::on_realize()" << std::endl;
   Gtk::DrawingArea::on_realize();
 
-  std::cout << "on_realize: " << get_width() << "x" << get_height() << std::endl;
-
-  state.set_size(get_width(), get_height());
-  Display::aspect_size.width  = get_width();
-  Display::aspect_size.height = get_height();
-
-  std::cout << Display::aspect_size << std::endl;
-
   Glib::RefPtr<Gdk::GL::Window> glwindow = get_gl_window();
 
   if (glwindow->gl_begin(get_gl_context()))
@@ -190,6 +183,9 @@
   Display::aspect_size.width  = ev->width;
   Display::aspect_size.height = ev->height;
 
+  state.set_size(Display::aspect_size.width,
+                 Display::aspect_size.height);
+
   Glib::RefPtr<Gdk::GL::Window> glwindow = get_gl_window();
 
   if (!glwindow->gl_begin(get_gl_context()))

Modified: trunk/windstille/src/scenegraph/surface_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/surface_drawable.hpp	2009-09-12 21:05:23 UTC (rev 3237)
+++ trunk/windstille/src/scenegraph/surface_drawable.hpp	2009-09-12 21:06:43 UTC (rev 3238)
@@ -30,8 +30,8 @@
 
 public:
   SurfaceDrawable(Surface surface_, const SurfaceDrawingParameters& params_,
-                        float z_pos_,
-                        const Matrix& modelview_)
+                  float z_pos_,
+                  const Matrix& modelview_)
     : Drawable(pos, z_pos_, modelview_), 
       surface(surface_), 
       params(params_)

Modified: trunk/windstille/src/scenegraph/vertex_array_drawable.cpp
===================================================================
--- trunk/windstille/src/scenegraph/vertex_array_drawable.cpp	2009-09-12 21:05:23 UTC (rev 3237)
+++ trunk/windstille/src/scenegraph/vertex_array_drawable.cpp	2009-09-12 21:06:43 UTC (rev 3238)
@@ -20,7 +20,7 @@
 #include "scenegraph/vertex_array_drawable.hpp"
 
 VertexArrayDrawable::VertexArrayDrawable(const Vector2f& pos_, float z_pos_, 
-                                                     const Matrix& modelview_)
+                                         const Matrix& modelview_)
   : Drawable(pos_, z_pos_, modelview_),
     mode(GL_QUADS),
     blend_sfactor(GL_SRC_ALPHA),
@@ -67,30 +67,30 @@
   state.set_blend_func(blend_sfactor, blend_dfactor);
   
   if (texture)
-    {
-      state.bind_texture(texture);
-    }
+  {
+    state.bind_texture(texture);
+  }
 
   if (!colors.empty())
-    {
-      state.enable_client_state(GL_COLOR_ARRAY);
-      glColorPointer(4, GL_UNSIGNED_BYTE, 0, &*colors.begin());
-    }
+  {
+    state.enable_client_state(GL_COLOR_ARRAY);
+    glColorPointer(4, GL_UNSIGNED_BYTE, 0, &*colors.begin());
+  }
   else
-    {
-      state.disable_client_state(GL_COLOR_ARRAY);
-      state.color(Color(1.0f, 1.0f, 1.0f));
-    }
+  {
+    state.disable_client_state(GL_COLOR_ARRAY);
+    state.color(Color(1.0f, 1.0f, 1.0f));
+  }
 
   if (!texcoords.empty())
-    {
-      state.enable_client_state(GL_TEXTURE_COORD_ARRAY);
-      glTexCoordPointer(2, GL_FLOAT, 0, &*texcoords.begin());
-    }
+  {
+    state.enable_client_state(GL_TEXTURE_COORD_ARRAY);
+    glTexCoordPointer(2, GL_FLOAT, 0, &*texcoords.begin());
+  }
   else
-    {
-      state.disable_client_state(GL_TEXTURE_COORD_ARRAY);
-    }
+  {
+    state.disable_client_state(GL_TEXTURE_COORD_ARRAY);
+  }
 
   // FIXME: Might be worth to not use VertexArrays when we have a pretty small number of vertices
   state.disable_client_state(GL_NORMAL_ARRAY);
@@ -103,7 +103,18 @@
   glPushMatrix();
   glMultMatrixf(modelview.matrix);
 
-  glDrawArrays(mode, start, end);
+  if (mode == GL_LINES ||
+      mode == GL_LINE_LOOP)
+  {
+    // FIXME: Hack: make this configurable
+    glLineWidth(2.0f);
+    glDrawArrays(mode, start, end);
+    glLineWidth(1.0f);
+  }
+  else
+  {
+    glDrawArrays(mode, start, end);
+  }
 
   glPopMatrix();
 }



From grumbel at mail.berlios.de  Sun Sep 13 16:22:04 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sun, 13 Sep 2009 16:22:04 +0200
Subject: [Windstille-commit] r3239 - trunk/windstille/src/editor
Message-ID: <200909131422.n8DEM4X8023399@sheep.berlios.de>

Author: grumbel
Date: 2009-09-13 16:22:03 +0200 (Sun, 13 Sep 2009)
New Revision: 3239

Modified:
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
Log:
Fixed some issues with object ordering

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-12 21:06:43 UTC (rev 3238)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-13 14:22:03 UTC (rev 3239)
@@ -20,6 +20,7 @@
 #include <limits>
 #include <assert.h>
 #include <iostream>
+#include <algorithm>
 #include <gdkmm/pixbuf.h>
 
 #include "display/scene_context.hpp"
@@ -166,27 +167,23 @@
   }
 }
 
-struct GetLayersFunctor
+SectorModel::Layers
+SectorModel::get_layers() const
 {
-  SectorModel::Layers& objects;
-
-  GetLayersFunctor(SectorModel::Layers& objects_) 
-    : objects(objects_)
-  {}
-
-  bool get_layers(const Gtk::TreeModel::iterator& it)
+  Layers lst;
+ 
+  // LayerTree holds the layers in reverse order, so we reverse them here
+  Gtk::TreeModel::Children childs = layer_tree->children(); 
+  for(Gtk::TreeModel::Children::const_iterator it = childs.begin();
+      it != childs.end(); ++it)
   {
-    objects.push_back((*it)[LayerManagerColumns::instance().layer]);
-    return false;
+    lst.push_back((*it)[LayerManagerColumns::instance().layer]);
   }
-};
 
-SectorModel::Layers
-SectorModel::get_layers() const
-{
-  Layers lst;
-  GetLayersFunctor func(lst);
-  layer_tree->foreach_iter(sigc::mem_fun(func, &GetLayersFunctor::get_layers));
+  // FIXME: for some reason reverse iterators don't work with
+  // Gtk::TreeModel::Children, so we do it manually
+  std::reverse(lst.begin(), lst.end());
+
   return lst;
 }
 
@@ -381,7 +378,15 @@
         std::string id_str;
         if (j->get("edge", id_str))
         {
-          layer->add(id_table[id_str]);
+          std::map<std::string, ObjectModelHandle>::iterator it = id_table.find(id_str);
+          if (it == id_table.end())
+          {
+            std::cout << "SectorModel::load_layer: couldn't resource navgraph-edge-ref: " << id_str << std::endl;
+          }
+          else
+          {
+            layer->add(it->second);
+          }
         }
       }
       else
@@ -451,7 +456,8 @@
       reader.get("layers", layers_section);
 
       const std::vector<FileReader>& sections = layers_section.get_sections();
-      for(std::vector<FileReader>::const_iterator i = sections.begin(); i != sections.end(); ++i)
+      // Load layer in reversed order, as ListStore is in reverse
+      for(std::vector<FileReader>::const_reverse_iterator i = sections.rbegin(); i != sections.rend(); ++i)
       {
         if (i->get_name() == "layer")
         {
@@ -496,17 +502,16 @@
   writer.end_section();
 
   writer.start_section("layers");
-  for(Gtk::ListStore::Children::iterator i = layer_tree->children().begin(); i != layer_tree->children().end(); ++i)
+  const Layers& layers = get_layers();
+  for(Layers::const_iterator i = layers.begin(); i != layers.end(); ++i)
   {
-    const Gtk::TreeRow& row = *i;
-
     writer.start_section("layer");
-    writer.write("name",    (Glib::ustring)(row[LayerManagerColumns::instance().name]));
-    writer.write("visible", (bool)row[LayerManagerColumns::instance().visible]);
-    writer.write("locked",  (bool)row[LayerManagerColumns::instance().locked]);
+    writer.write("name",    (*i)->get_name());
+    writer.write("visible", (*i)->is_visible());
+    writer.write("locked",  (*i)->is_locked());
 
     writer.start_section("objects");
-    ((LayerHandle)row[LayerManagerColumns::instance().layer])->write(writer);
+    (*i)->write(writer);
     writer.end_section();
 
     writer.end_section();
@@ -561,7 +566,7 @@
   sg.clear();
   
   const Layers& layers = get_layers();
-  for(Layers::const_reverse_iterator layer = layers.rbegin(); layer != layers.rend(); ++layer)
+  for(Layers::const_iterator layer = layers.begin(); layer != layers.end(); ++layer)
   {
     if (*layer)
     {
@@ -585,7 +590,7 @@
 void
 SectorModel::on_row_changed(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter)
 {
-  std::cout << "LayerManager:on_row_changed" << std::endl;
+  //std::cout << "LayerManager:on_row_changed" << std::endl;
 
   if (iter)
   {
@@ -613,13 +618,13 @@
 void
 SectorModel::on_row_inserted(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter)
 {
-  std::cout << "LayerManager:on_row_inserted" << std::endl;
+  //std::cout << "LayerManager:on_row_inserted" << std::endl;
 }
 
 void
 SectorModel::on_rows_reordered(const Gtk::TreeModel::Path& path, const Gtk::TreeModel::iterator& iter, int* new_order)
 {
-  std::cout << "LayerManager:on_row_reordered" << std::endl;
+  //std::cout << "LayerManager:on_row_reordered" << std::endl;
 }
 
 void

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-12 21:06:43 UTC (rev 3238)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-13 14:22:03 UTC (rev 3239)
@@ -41,7 +41,7 @@
 {
 private:
   boost::scoped_ptr<NavigationGraphModel> nav_graph;
-  Glib::RefPtr<Gtk::ListStore>       layer_tree;
+  Glib::RefPtr<Gtk::ListStore> layer_tree;
   Color ambient_color;
   
 public:



From grumbel at mail.berlios.de  Mon Sep 14 00:53:33 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 14 Sep 2009 00:53:33 +0200
Subject: [Windstille-commit] r3240 - in trunk/windstille/src: display editor
	engine
Message-ID: <200909132253.n8DMrXW9009140@sheep.berlios.de>

Author: grumbel
Date: 2009-09-14 00:53:26 +0200 (Mon, 14 Sep 2009)
New Revision: 3240

Modified:
   trunk/windstille/src/display/basic_compositor_impl.hpp
   trunk/windstille/src/editor/decal_rotate_control_point.cpp
   trunk/windstille/src/editor/decal_scale_control_point.cpp
   trunk/windstille/src/editor/layer_manager_columns.hpp
   trunk/windstille/src/engine/sector_builder.cpp
   trunk/windstille/src/engine/sector_builder.hpp
Log:
Minor cleanup

Modified: trunk/windstille/src/display/basic_compositor_impl.hpp
===================================================================
--- trunk/windstille/src/display/basic_compositor_impl.hpp	2009-09-13 14:22:03 UTC (rev 3239)
+++ trunk/windstille/src/display/basic_compositor_impl.hpp	2009-09-13 22:53:26 UTC (rev 3240)
@@ -16,8 +16,8 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
-#ifndef HEADER_BASIC_COMPOSITOR_IMPL_HPP
-#define HEADER_BASIC_COMPOSITOR_IMPL_HPP
+#ifndef HEADER_WINDSTILLE_DISPLAY_BASIC_COMPOSITOR_IMPL_HPP
+#define HEADER_WINDSTILLE_DISPLAY_BASIC_COMPOSITOR_IMPL_HPP
 
 #include "display/compositor_impl.hpp"
 #include "display/surface.hpp"

Modified: trunk/windstille/src/editor/decal_rotate_control_point.cpp
===================================================================
--- trunk/windstille/src/editor/decal_rotate_control_point.cpp	2009-09-13 14:22:03 UTC (rev 3239)
+++ trunk/windstille/src/editor/decal_rotate_control_point.cpp	2009-09-13 22:53:26 UTC (rev 3240)
@@ -29,7 +29,7 @@
 }
 
 void
-DecalRotateControlPoint::on_move_start(GdkEventMotion* /*event*/) 
+DecalRotateControlPoint::on_move_start(GdkEventMotion* event) 
 {
 }
 

Modified: trunk/windstille/src/editor/decal_scale_control_point.cpp
===================================================================
--- trunk/windstille/src/editor/decal_scale_control_point.cpp	2009-09-13 14:22:03 UTC (rev 3239)
+++ trunk/windstille/src/editor/decal_scale_control_point.cpp	2009-09-13 22:53:26 UTC (rev 3240)
@@ -30,12 +30,12 @@
 {}
 
 void
-DecalScaleControlPoint::on_move_start(GdkEventButton* /*event*/)
+DecalScaleControlPoint::on_move_start(GdkEventButton* event)
 { 
 }
 
 void
-DecalScaleControlPoint::on_move_update(GdkEventMotion* /*event*/, const Vector2f& offset_) 
+DecalScaleControlPoint::on_move_update(GdkEventMotion* event, const Vector2f& offset_) 
 {
   offset = offset_; 
 

Modified: trunk/windstille/src/editor/layer_manager_columns.hpp
===================================================================
--- trunk/windstille/src/editor/layer_manager_columns.hpp	2009-09-13 14:22:03 UTC (rev 3239)
+++ trunk/windstille/src/editor/layer_manager_columns.hpp	2009-09-13 22:53:26 UTC (rev 3240)
@@ -16,8 +16,8 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
-#ifndef HEADER_WINDSTILLE_EDTIOR_LAYER_MANAGER_COLUMNS_HPP
-#define HEADER_WINDSTILLE_EDTIOR_LAYER_MANAGER_COLUMNS_HPP
+#ifndef HEADER_WINDSTILLE_EDITOR_LAYER_MANAGER_COLUMNS_HPP
+#define HEADER_WINDSTILLE_EDITOR_LAYER_MANAGER_COLUMNS_HPP
 
 class LayerManagerColumns : public Gtk::TreeModel::ColumnRecord
 {

Modified: trunk/windstille/src/engine/sector_builder.cpp
===================================================================
--- trunk/windstille/src/engine/sector_builder.cpp	2009-09-13 14:22:03 UTC (rev 3239)
+++ trunk/windstille/src/engine/sector_builder.cpp	2009-09-13 22:53:26 UTC (rev 3240)
@@ -170,6 +170,10 @@
 
     obj = tilemap.release();
   }
+  else if (reader.get_name() == "navgraph-edge-ref")
+  {
+    // FIXME: Implement me
+  }
   else if(reader.get_name() == "background")
   {
     // TODO
@@ -282,7 +286,8 @@
   FileReader navgraph_reader;
   if (!reader.get("navigation", navgraph_reader))
   {
-    throw std::runtime_error("SectorBuilder: 'navigation' section missing");
+    // throw std::runtime_error("SectorBuilder: 'navigation' section missing");
+    std::cout << "SectorBuilder: 'navigation' section missing" << std::endl;
   }
   else
   {

Modified: trunk/windstille/src/engine/sector_builder.hpp
===================================================================
--- trunk/windstille/src/engine/sector_builder.hpp	2009-09-13 14:22:03 UTC (rev 3239)
+++ trunk/windstille/src/engine/sector_builder.hpp	2009-09-13 22:53:26 UTC (rev 3240)
@@ -16,8 +16,8 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
-#ifndef HEADER_WINDSTILLE_EDITOR_SECTOR_BUILDER_HPP
-#define HEADER_WINDSTILLE_EDITOR_SECTOR_BUILDER_HPP
+#ifndef HEADER_WINDSTILLE_ENGINE_SECTOR_BUILDER_HPP
+#define HEADER_WINDSTILLE_ENGINE_SECTOR_BUILDER_HPP
 
 #include <map>
 #include <string>



From grumbel at mail.berlios.de  Mon Sep 14 01:13:03 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 14 Sep 2009 01:13:03 +0200
Subject: [Windstille-commit] r3241 - trunk/windstille/src/editor
Message-ID: <200909132313.n8DND3UI028510@sheep.berlios.de>

Author: grumbel
Date: 2009-09-14 01:13:01 +0200 (Mon, 14 Sep 2009)
New Revision: 3241

Added:
   trunk/windstille/src/editor/sector_model_builder.cpp
   trunk/windstille/src/editor/sector_model_builder.hpp
Modified:
   trunk/windstille/src/editor/layer_manager_columns.hpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
Log:
Separated loading out into SectorModelBuilder

Modified: trunk/windstille/src/editor/layer_manager_columns.hpp
===================================================================
--- trunk/windstille/src/editor/layer_manager_columns.hpp	2009-09-13 22:53:26 UTC (rev 3240)
+++ trunk/windstille/src/editor/layer_manager_columns.hpp	2009-09-13 23:13:01 UTC (rev 3241)
@@ -19,6 +19,10 @@
 #ifndef HEADER_WINDSTILLE_EDITOR_LAYER_MANAGER_COLUMNS_HPP
 #define HEADER_WINDSTILLE_EDITOR_LAYER_MANAGER_COLUMNS_HPP
 
+#include <gtkmm/treemodelcolumn.h>
+
+#include "layer.hpp"
+
 class LayerManagerColumns : public Gtk::TreeModel::ColumnRecord
 {
 private:

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-13 22:53:26 UTC (rev 3240)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-13 23:13:01 UTC (rev 3241)
@@ -29,10 +29,11 @@
 #include "editor/layer_manager_columns.hpp"
 #include "editor/navgraph_edge_object_model.hpp"
 #include "editor/navgraph_node_object_model.hpp"
+#include "editor/navigation_graph_model.hpp"
 #include "editor/object_model_factory.hpp"
 #include "editor/sector_model.hpp"
+#include "editor/sector_model_builder.hpp"
 #include "editor/windstille_widget.hpp"
-#include "editor/navigation_graph_model.hpp"
 #include "navigation/node.hpp"
 #include "scenegraph/scene_graph.hpp"
 #include "util/file_reader.hpp"
@@ -46,7 +47,7 @@
     ambient_color()
 {
   register_callbacks();
-  load(filename);
+  SectorModelBuilder(filename, *this);
 }
 
 SectorModel::SectorModel()
@@ -350,143 +351,6 @@
 }
 
 void
-SectorModel::load_layer(const FileReader& reader, 
-                        std::map<std::string, ObjectModelHandle>& id_table,
-                        std::map<ObjectModelHandle, std::string>& parent_table)
-{
-  FileReader objects_reader;
-  FileReader layers_reader;
-
-  std::string name = "New Layer";
-  bool visible = true;;
-  bool locked  = false;
-
-  reader.get("name",    name);
-  reader.get("visible", visible);
-  reader.get("locked",  locked);
-  reader.get("objects", objects_reader);
-
-  LayerHandle layer = LayerHandle(new Layer(*this));
-
-  const std::vector<FileReader>& objects_sections = objects_reader.get_sections();
-  for(std::vector<FileReader>::const_iterator j = objects_sections.begin(); j != objects_sections.end(); ++j)
-  {
-    try 
-    {
-      if (j->get_name() == "navgraph-edge-ref")
-      {
-        std::string id_str;
-        if (j->get("edge", id_str))
-        {
-          std::map<std::string, ObjectModelHandle>::iterator it = id_table.find(id_str);
-          if (it == id_table.end())
-          {
-            std::cout << "SectorModel::load_layer: couldn't resource navgraph-edge-ref: " << id_str << std::endl;
-          }
-          else
-          {
-            layer->add(it->second);
-          }
-        }
-      }
-      else
-      {
-        ObjectModelHandle obj = ObjectModelFactory::create(*j);
-
-        layer->add(obj);
-
-        std::string id_str;
-        if (j->read("id", id_str))
-        {
-          id_table[id_str] = obj;
-        }
-
-        std::string parent_str;
-        if (j->read("parent", parent_str))
-        {
-          if (!parent_str.empty())
-            parent_table[obj] = parent_str;
-        }
-      }
-    }
-    catch(std::exception& err)
-    {
-      std::cout << "SectorModel::load_layer: " << err.what() << std::endl;
-    }
-  }
-
-  // Append the layer to the tree
-  Gtk::ListStore::iterator it = layer_tree->append();
-
-  (*it)[LayerManagerColumns::instance().type_icon] = Gdk::Pixbuf::create_from_file("data/editor/type.png");
-  (*it)[LayerManagerColumns::instance().name]      = name;
-  (*it)[LayerManagerColumns::instance().visible]   = visible; 
-  (*it)[LayerManagerColumns::instance().locked]    = locked; 
-  (*it)[LayerManagerColumns::instance().layer]     = layer;
-
-  layer->sync(*it);
-}
-
-void
-SectorModel::load(const std::string& filename)
-{
-  layer_tree->clear();
-
-  std::ifstream stream(filename.c_str());
-  if (!stream)
-  {
-    throw std::runtime_error("File not found " + filename);
-  }
-  else
-  {
-    std::map<std::string, ObjectModelHandle> id_table;
-    std::map<ObjectModelHandle, std::string> parent_table;
-
-    FileReader reader = FileReader::parse(stream, filename);
-    if (reader.get_name() == "windstille-sector")
-    {
-      ambient_color = Color(0,0,0,1);
-      reader.get("ambient-color", ambient_color);
-
-      FileReader navigation_section;
-      reader.get("navigation", navigation_section);
-      nav_graph->load(navigation_section, id_table);
-
-      FileReader layers_section;
-      reader.get("layers", layers_section);
-
-      const std::vector<FileReader>& sections = layers_section.get_sections();
-      // Load layer in reversed order, as ListStore is in reverse
-      for(std::vector<FileReader>::const_reverse_iterator i = sections.rbegin(); i != sections.rend(); ++i)
-      {
-        if (i->get_name() == "layer")
-        {
-          load_layer(*i, id_table, parent_table);
-        }
-        else
-        {
-          std::cout << "SectorModel::load: ignoring unknown type '" << i->get_name() << "'" << std::endl;
-        }
-      }
-          
-      // Set the parents properly
-      for(std::map<ObjectModelHandle, std::string>::iterator i = parent_table.begin(); i != parent_table.end(); ++i)
-      {
-        std::map<std::string, ObjectModelHandle>::iterator j = id_table.find(i->second);
-        if (j == id_table.end())
-        {
-          std::cout << "Error: Couldn't resolve 'id': " << i->second << std::endl;
-        }
-        else
-        {
-          i->first->set_parent(j->second, false);
-        }
-      }
-    }
-  }
-}
-
-void
 SectorModel::write(FileWriter& writer) const
 {
   writer.write_raw(";; -*- scheme -*-\n");

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-13 22:53:26 UTC (rev 3240)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-13 23:13:01 UTC (rev 3241)
@@ -101,10 +101,6 @@
   void rebuild_scene_graph(SceneGraph& sg);
 
 private:
-  void load(const std::string& filename);
-  void load_layer(const FileReader& filename, 
-                  std::map<std::string, ObjectModelHandle>& id_table,
-                  std::map<ObjectModelHandle, std::string>& parent_table); 
   void register_callbacks();
 
 private:

Added: trunk/windstille/src/editor/sector_model_builder.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model_builder.cpp	2009-09-13 22:53:26 UTC (rev 3240)
+++ trunk/windstille/src/editor/sector_model_builder.cpp	2009-09-13 23:13:01 UTC (rev 3241)
@@ -0,0 +1,171 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "editor/sector_model_builder.hpp"
+
+#include <fstream>
+#include <stdexcept>
+
+#include "display/color.hpp"
+#include "editor/layer_manager_columns.hpp"
+#include "editor/navigation_graph_model.hpp"
+#include "editor/object_model_factory.hpp"
+#include "editor/sector_model.hpp"
+#include "util/file_reader.hpp"
+
+SectorModelBuilder::SectorModelBuilder(const std::string& filename, SectorModel& sector)
+  : m_sector(sector)
+{
+  m_sector.get_layer_tree()->clear();
+
+  std::ifstream stream(filename.c_str());
+  if (!stream)
+  {
+    throw std::runtime_error("File not found " + filename);
+  }
+  else
+  {
+    std::map<std::string, ObjectModelHandle> id_table;
+    std::map<ObjectModelHandle, std::string> parent_table;
+
+    FileReader reader = FileReader::parse(stream, filename);
+    if (reader.get_name() == "windstille-sector")
+    {
+      Color ambient_color;
+      if (reader.get("ambient-color", ambient_color))
+      {
+        m_sector.set_ambient_color(ambient_color);
+      }
+
+      FileReader navigation_section;
+      reader.get("navigation", navigation_section);
+      m_sector.get_nav_graph().load(navigation_section, id_table);
+
+      FileReader layers_section;
+      reader.get("layers", layers_section);
+
+      const std::vector<FileReader>& sections = layers_section.get_sections();
+      // Load layer in reversed order, as ListStore is in reverse
+      for(std::vector<FileReader>::const_reverse_iterator i = sections.rbegin(); i != sections.rend(); ++i)
+      {
+        if (i->get_name() == "layer")
+        {
+          load_layer(*i, id_table, parent_table);
+        }
+        else
+        {
+          std::cout << "SectorModel::load: ignoring unknown type '" << i->get_name() << "'" << std::endl;
+        }
+      }
+          
+      // Set the parents properly
+      for(std::map<ObjectModelHandle, std::string>::iterator i = parent_table.begin(); i != parent_table.end(); ++i)
+      {
+        std::map<std::string, ObjectModelHandle>::iterator j = id_table.find(i->second);
+        if (j == id_table.end())
+        {
+          std::cout << "Error: Couldn't resolve 'id': " << i->second << std::endl;
+        }
+        else
+        {
+          i->first->set_parent(j->second, false);
+        }
+      }
+    }
+  }
+}
+
+void
+SectorModelBuilder::load_layer(const FileReader& reader, 
+                               std::map<std::string, ObjectModelHandle>& id_table,
+                               std::map<ObjectModelHandle, std::string>& parent_table)
+{
+  FileReader objects_reader;
+  FileReader layers_reader;
+
+  std::string name = "New Layer";
+  bool visible = true;;
+  bool locked  = false;
+
+  reader.get("name",    name);
+  reader.get("visible", visible);
+  reader.get("locked",  locked);
+  reader.get("objects", objects_reader);
+
+  LayerHandle layer = LayerHandle(new Layer(m_sector));
+
+  const std::vector<FileReader>& objects_sections = objects_reader.get_sections();
+  for(std::vector<FileReader>::const_iterator j = objects_sections.begin(); j != objects_sections.end(); ++j)
+  {
+    try 
+    {
+      if (j->get_name() == "navgraph-edge-ref")
+      {
+        std::string id_str;
+        if (j->get("edge", id_str))
+        {
+          std::map<std::string, ObjectModelHandle>::iterator it = id_table.find(id_str);
+          if (it == id_table.end())
+          {
+            std::cout << "SectorModel::load_layer: couldn't resource navgraph-edge-ref: " << id_str << std::endl;
+          }
+          else
+          {
+            layer->add(it->second);
+          }
+        }
+      }
+      else
+      {
+        ObjectModelHandle obj = ObjectModelFactory::create(*j);
+
+        layer->add(obj);
+
+        std::string id_str;
+        if (j->read("id", id_str))
+        {
+          id_table[id_str] = obj;
+        }
+
+        std::string parent_str;
+        if (j->read("parent", parent_str))
+        {
+          if (!parent_str.empty())
+            parent_table[obj] = parent_str;
+        }
+      }
+    }
+    catch(std::exception& err)
+    {
+      std::cout << "SectorModel::load_layer: " << err.what() << std::endl;
+    }
+  }
+
+  // Append the layer to the tree
+  Gtk::ListStore::iterator it = m_sector.get_layer_tree()->append();
+
+  (*it)[LayerManagerColumns::instance().type_icon] = Gdk::Pixbuf::create_from_file("data/editor/type.png");
+  (*it)[LayerManagerColumns::instance().name]      = name;
+  (*it)[LayerManagerColumns::instance().visible]   = visible; 
+  (*it)[LayerManagerColumns::instance().locked]    = locked; 
+  (*it)[LayerManagerColumns::instance().layer]     = layer;
+
+  layer->sync(*it);
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/sector_model_builder.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/sector_model_builder.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model_builder.hpp	2009-09-13 22:53:26 UTC (rev 3240)
+++ trunk/windstille/src/editor/sector_model_builder.hpp	2009-09-13 23:13:01 UTC (rev 3241)
@@ -0,0 +1,51 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_EDITOR_SECTOR_MODEL_BUILDER_HPP
+#define HEADER_WINDSTILLE_EDITOR_SECTOR_MODEL_BUILDER_HPP
+
+#include <string>
+#include <map>
+
+#include "object_model.hpp"
+
+class SectorModel;
+class FileReader;
+
+class SectorModelBuilder
+{
+private:
+  SectorModel& m_sector;
+  
+public:
+  SectorModelBuilder(const std::string& filename, SectorModel& sector);
+
+private:
+  void load(const std::string& filename);
+  void load_layer(const FileReader& filename, 
+                  std::map<std::string, ObjectModelHandle>& id_table,
+                  std::map<ObjectModelHandle, std::string>& parent_table); 
+
+private:
+  SectorModelBuilder(const SectorModelBuilder&);
+  SectorModelBuilder& operator=(const SectorModelBuilder&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/sector_model_builder.hpp
___________________________________________________________________
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Mon Sep 14 20:43:19 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 14 Sep 2009 20:43:19 +0200
Subject: [Windstille-commit] r3242 - trunk/windstille/src/editor
Message-ID: <200909141843.n8EIhJcU005291@sheep.berlios.de>

Author: grumbel
Date: 2009-09-14 20:43:18 +0200 (Mon, 14 Sep 2009)
New Revision: 3242

Modified:
   trunk/windstille/src/editor/sector_model_builder.cpp
   trunk/windstille/src/editor/sector_model_builder.hpp
Log:
Turned some local variables into member variables

Modified: trunk/windstille/src/editor/sector_model_builder.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model_builder.cpp	2009-09-13 23:13:01 UTC (rev 3241)
+++ trunk/windstille/src/editor/sector_model_builder.cpp	2009-09-14 18:43:18 UTC (rev 3242)
@@ -29,7 +29,9 @@
 #include "util/file_reader.hpp"
 
 SectorModelBuilder::SectorModelBuilder(const std::string& filename, SectorModel& sector)
-  : m_sector(sector)
+  : m_sector(sector),
+    m_id_table(),
+    m_parent_table()
 {
   m_sector.get_layer_tree()->clear();
 
@@ -40,9 +42,6 @@
   }
   else
   {
-    std::map<std::string, ObjectModelHandle> id_table;
-    std::map<ObjectModelHandle, std::string> parent_table;
-
     FileReader reader = FileReader::parse(stream, filename);
     if (reader.get_name() == "windstille-sector")
     {
@@ -54,7 +53,7 @@
 
       FileReader navigation_section;
       reader.get("navigation", navigation_section);
-      m_sector.get_nav_graph().load(navigation_section, id_table);
+      m_sector.get_nav_graph().load(navigation_section, m_id_table);
 
       FileReader layers_section;
       reader.get("layers", layers_section);
@@ -65,7 +64,7 @@
       {
         if (i->get_name() == "layer")
         {
-          load_layer(*i, id_table, parent_table);
+          load_layer(*i);
         }
         else
         {
@@ -74,10 +73,10 @@
       }
           
       // Set the parents properly
-      for(std::map<ObjectModelHandle, std::string>::iterator i = parent_table.begin(); i != parent_table.end(); ++i)
+      for(std::map<ObjectModelHandle, std::string>::iterator i = m_parent_table.begin(); i != m_parent_table.end(); ++i)
       {
-        std::map<std::string, ObjectModelHandle>::iterator j = id_table.find(i->second);
-        if (j == id_table.end())
+        std::map<std::string, ObjectModelHandle>::iterator j = m_id_table.find(i->second);
+        if (j == m_id_table.end())
         {
           std::cout << "Error: Couldn't resolve 'id': " << i->second << std::endl;
         }
@@ -91,9 +90,7 @@
 }
 
 void
-SectorModelBuilder::load_layer(const FileReader& reader, 
-                               std::map<std::string, ObjectModelHandle>& id_table,
-                               std::map<ObjectModelHandle, std::string>& parent_table)
+SectorModelBuilder::load_layer(const FileReader& reader)
 {
   FileReader objects_reader;
   FileReader layers_reader;
@@ -119,8 +116,8 @@
         std::string id_str;
         if (j->get("edge", id_str))
         {
-          std::map<std::string, ObjectModelHandle>::iterator it = id_table.find(id_str);
-          if (it == id_table.end())
+          std::map<std::string, ObjectModelHandle>::iterator it = m_id_table.find(id_str);
+          if (it == m_id_table.end())
           {
             std::cout << "SectorModel::load_layer: couldn't resource navgraph-edge-ref: " << id_str << std::endl;
           }
@@ -139,14 +136,14 @@
         std::string id_str;
         if (j->read("id", id_str))
         {
-          id_table[id_str] = obj;
+          m_id_table[id_str] = obj;
         }
 
         std::string parent_str;
         if (j->read("parent", parent_str))
         {
           if (!parent_str.empty())
-            parent_table[obj] = parent_str;
+            m_parent_table[obj] = parent_str;
         }
       }
     }

Modified: trunk/windstille/src/editor/sector_model_builder.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model_builder.hpp	2009-09-13 23:13:01 UTC (rev 3241)
+++ trunk/windstille/src/editor/sector_model_builder.hpp	2009-09-14 18:43:18 UTC (rev 3242)
@@ -31,15 +31,15 @@
 {
 private:
   SectorModel& m_sector;
-  
+  std::map<std::string, ObjectModelHandle> m_id_table;
+  std::map<ObjectModelHandle, std::string> m_parent_table;
+
 public:
   SectorModelBuilder(const std::string& filename, SectorModel& sector);
 
 private:
   void load(const std::string& filename);
-  void load_layer(const FileReader& filename, 
-                  std::map<std::string, ObjectModelHandle>& id_table,
-                  std::map<ObjectModelHandle, std::string>& parent_table); 
+  void load_layer(const FileReader& filename);
 
 private:
   SectorModelBuilder(const SectorModelBuilder&);



From grumbel at mail.berlios.de  Mon Sep 14 20:44:14 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 14 Sep 2009 20:44:14 +0200
Subject: [Windstille-commit] r3243 - in trunk/windstille: . src/editor
Message-ID: <200909141844.n8EIiE90005374@sheep.berlios.de>

Author: grumbel
Date: 2009-09-14 20:44:12 +0200 (Mon, 14 Sep 2009)
New Revision: 3243

Modified:
   trunk/windstille/TODO
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/select_tool.cpp
   trunk/windstille/src/editor/select_tool.hpp
   trunk/windstille/src/editor/windstille_widget.cpp
Log:
Added grid snapping for objects

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2009-09-14 18:43:18 UTC (rev 3242)
+++ trunk/windstille/TODO	2009-09-14 18:44:12 UTC (rev 3243)
@@ -19,9 +19,6 @@
 
 * delete/remove/erase naming is a bit mixed up in a few places
 
-* ZoomTool seems broken
-
-
 * being able to directly mark Edges still feels wonky, need to rethink the thing again
 
 * copy&paste works only very limited with edges, i.e. copying from one
@@ -30,14 +27,24 @@
 
 * add grid snapping to navgraph
 
-* add horizontal/vertical snapping
-
 * draw NavGraph lines thicker (glLineWidth())
 
 * color code them by layer
 
-* implement navgraph loading in the game engine
+* add special drawing for different edge types (i.e. draw stairs for stair type edges)
 
+SceneGraph/Compositor
+=====================
+
+* could make use of occlusion query, to hide highlight sources when
+  they are covered:
+
+  * http://www.opengl.org/registry/specs/ARB/occlusion_query.txt
+  * http://developer.download.nvidia.com/SDK/9.5/Samples/DEMOS/OpenGL/occlusion_query.zip
+
+* add support for multipass rendering with shader scripts (to simulate
+  glass and things like that)
+
 Overview
 ========
 
@@ -55,8 +62,6 @@
 
 * add trigger to NavGraph
 
-* add Grid snapping to the Editor
-
 * build a more complete scenario
 
 * tweak graphics (lightmaps are to big, stuff doesn't tile properly, etc.)

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-14 18:43:18 UTC (rev 3242)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-14 18:44:12 UTC (rev 3243)
@@ -347,6 +347,7 @@
       snap_data.merge((*i)->snap_object(rect, ignore_objects));
     }
   }
+
   return snap_data;
 }
 

Modified: trunk/windstille/src/editor/select_tool.cpp
===================================================================
--- trunk/windstille/src/editor/select_tool.cpp	2009-09-14 18:43:18 UTC (rev 3242)
+++ trunk/windstille/src/editor/select_tool.cpp	2009-09-14 18:44:12 UTC (rev 3243)
@@ -98,7 +98,81 @@
   wst.queue_draw();
 }
 
+static float snap_to_grid(float v, int grid)
+{
+    int v_i = static_cast<int>(v);
+    int rounded = v_i / grid * grid;
+    int left  = rounded;
+    int right = rounded + ((v >= 0) ? grid : -grid);
+
+    if (abs(left - v_i) < abs(right - v_i))
+    {
+      return static_cast<float>(left) - v;
+    }
+    else
+    {
+      return static_cast<float>(right) - v;
+    }
+}
+
 Vector2f
+SelectTool::process_grid_snap(WindstilleWidget& wst)
+{
+  const int grid_width = 128;
+  const float snap_distance = 16.0f;
+  SnapData best_snap;
+
+  // Snap to the 64x64 grid
+  for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
+  {
+    const Rectf& r = (*i)->get_bounding_box();
+
+    Rectf snap_rect(snap_to_grid(r.left,   grid_width),
+                    snap_to_grid(r.top,    grid_width),
+                    snap_to_grid(r.right,  grid_width),
+                    snap_to_grid(r.bottom, grid_width));
+
+    {
+      SnapData snap;
+
+      if (fabs(snap_rect.left) < snap_distance)
+      {
+        snap.x_set = true;
+        snap.offset.x = snap_rect.left;
+      }
+
+      if (fabs(snap_rect.top) < snap_distance)
+      {
+        snap.y_set = true;
+        snap.offset.y = snap_rect.top;
+      }
+      
+      best_snap.merge(snap);
+    }
+
+    {
+      SnapData snap;
+
+      if (fabs(snap_rect.right) < snap_distance)
+      {
+        snap.x_set = true;
+        snap.offset.x = snap_rect.right;
+      }
+
+      if (fabs(snap_rect.bottom) < snap_distance)
+      {
+        snap.y_set = true;
+        snap.offset.y = snap_rect.bottom;
+      }
+      
+      best_snap.merge(snap);
+    }
+  }
+   
+  return best_snap.offset;
+}
+
+Vector2f
 SelectTool::process_snap(WindstilleWidget& wst)
 {
   // ignore all objects in the selection
@@ -121,7 +195,7 @@
     SnapData snap = wst.get_document().get_sector_model().snap_object((*i)->get_bounding_box(), ignore_objects);
     best_snap.merge(snap);
   }
-              
+ 
   return best_snap.offset;
 }
 
@@ -146,11 +220,15 @@
         selection->on_move_start();
 
       selection->on_move_update(offset);
-      
+
       if (event->state & GDK_CONTROL_MASK)
       {
         selection->on_move_update(offset + process_snap(wst));
       }
+      else if (event->state & GDK_SHIFT_MASK)
+      {
+        selection->on_move_update(offset + process_grid_snap(wst));
+      }
 
       wst.queue_draw();
     }
@@ -191,6 +269,10 @@
       {
         selection->on_move_end(wst, offset + process_snap(wst));
       }
+      else if (event->state & GDK_SHIFT_MASK)
+      {
+        selection->on_move_end(wst, offset + process_grid_snap(wst));
+      }
       else
       {
         selection->on_move_end(wst, offset);

Modified: trunk/windstille/src/editor/select_tool.hpp
===================================================================
--- trunk/windstille/src/editor/select_tool.hpp	2009-09-14 18:43:18 UTC (rev 3242)
+++ trunk/windstille/src/editor/select_tool.hpp	2009-09-14 18:44:12 UTC (rev 3243)
@@ -40,6 +40,7 @@
   } mode;
 
   Vector2f process_snap(WindstilleWidget& wst);
+  Vector2f process_grid_snap(WindstilleWidget& wst);
 
 public:
   SelectTool();

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-14 18:43:18 UTC (rev 3242)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-14 18:44:12 UTC (rev 3243)
@@ -305,7 +305,7 @@
     if (grid_enabled)
     {
       Display::draw_grid(state.get_offset() * state.get_zoom(),
-                         Sizef(128.0f * state.get_zoom(), 128.0f * state.get_zoom()), Color(1,1,1,0.5f));
+                         Sizef(128.0f * state.get_zoom(), 128.0f * state.get_zoom()), Color(1,1,1,0.75f));
     }
   }
 }



From grumbel at mail.berlios.de  Mon Sep 14 21:07:11 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 14 Sep 2009 21:07:11 +0200
Subject: [Windstille-commit] r3244 -
	trunk/windstille/data/sectors/trainstation
Message-ID: <200909141907.n8EJ7Bx4006945@sheep.berlios.de>

Author: grumbel
Date: 2009-09-14 21:07:06 +0200 (Mon, 14 Sep 2009)
New Revision: 3244

Modified:
   trunk/windstille/data/sectors/trainstation/worker.wst
Log:
Corrected object positions, so that they are multiple of 64

Modified: trunk/windstille/data/sectors/trainstation/worker.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/worker.wst	2009-09-14 18:44:12 UTC (rev 3243)
+++ trunk/windstille/data/sectors/trainstation/worker.wst	2009-09-14 19:07:06 UTC (rev 3244)
@@ -7,54 +7,81 @@
   (init-script "init.nut")
   (navigation
     (nodes
-      (node
-        (id 1)
-        (pos -1749.87 666.882))
-      (node
-        (id 2)
-        (pos 1526 671.65))
-      (node
-        (id 3)
-        (pos 2117.28 671.65))
-      (node
-        (id 4)
-        (pos 864.109 21.5156))
-      (node
-        (id 5)
-        (pos 2039.89 23.4687))
-      (node
-        (id 6)
-        (pos -1032.38 27.3749)))
+      (navgraph-node
+        (id "0xa2182d8")
+        (pos -1899 642)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0xa218388")
+        (pos 1611 644)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0xa218320")
+        (pos 2418 642)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0xa218278")
+        (pos 955 0)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0xa2181e0")
+        (pos 2363 2)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0xa23ef18")
+        (pos -1174 0)
+        (parent "")
+        (select-mask -1)))
     (edges
-      (edge
-        (node1 1)
-        (node2 2)
-        (properties 0))
-      (edge
-        (node1 2)
-        (node2 3)
-        (properties 0))
-      (edge
-        (node1 2)
-        (node2 4)
-        (properties 0))
-      (edge
-        (node1 4)
-        (node2 5)
-        (properties 0))
-      (edge
-        (node1 4)
-        (node2 6)
-        (properties 0))))
-  (objects
+      (navgraph-edge
+        (id "0xa2187e0")
+        (pos 70 -23)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0xa218388")
+        (rhs-node "0xa2182d8"))
+      (navgraph-edge
+        (id "0xa218740")
+        (pos 70 -23)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0xa218320")
+        (rhs-node "0xa218388"))
+      (navgraph-edge
+        (id "0xa218660")
+        (pos 70 -23)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0xa2181e0")
+        (rhs-node "0xa218278"))
+      (navgraph-edge
+        (id "0xa218590")
+        (pos 70 -23)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0xa23ef18")
+        (rhs-node "0xa218278"))
+      (navgraph-edge
+        (id "0xa218058")
+        (pos 70 -23)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0xa218278")
+        (rhs-node "0xa218388"))))
+  (layers
     (layer
       (name "Background")
       (visible #t)
-      (locked #f)
+      (locked #t)
       (objects
         (decal
-          (id "0x917d3b8")
-          (pos 355 472)
+          (id "0xacf8ec8")
+          (pos 448 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -64,8 +91,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x916f460")
-          (pos 739 472)
+          (id "0xacf5858")
+          (pos 832 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -75,8 +102,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x916fe38")
-          (pos 1507 472)
+          (id "0xb113560")
+          (pos 1600 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -86,8 +113,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9194d20")
-          (pos 1123 472)
+          (id "0xb113f10")
+          (pos 1216 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -97,8 +124,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9195010")
-          (pos -29 472)
+          (id "0xb112da8")
+          (pos 64 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -108,8 +135,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x926d560")
-          (pos -1565 472)
+          (id "0xb112b28")
+          (pos -1472 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -119,8 +146,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x926d6f8")
-          (pos -413 472)
+          (id "0xb113c48")
+          (pos -320 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -130,8 +157,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x926d848")
-          (pos -797 472)
+          (id "0xb113680")
+          (pos -704 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -141,8 +168,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x93b1a88")
-          (pos -1181 472)
+          (id "0xb113a30")
+          (pos -1088 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -152,8 +179,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x93b1cd0")
-          (pos 1891 472)
+          (id "0xb113778")
+          (pos 1984 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -163,8 +190,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9489f08")
-          (pos 1984 -168)
+          (id "0xb1155a8")
+          (pos 2112 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -174,8 +201,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9489fe0")
-          (pos -1088 -168)
+          (id "0xb115648")
+          (pos -960 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -185,8 +212,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x948a130")
-          (pos -704 -168)
+          (id "0xb1149a0")
+          (pos -576 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -196,8 +223,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x95ce358")
-          (pos -320 -168)
+          (id "0xb114ac8")
+          (pos -192 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -207,8 +234,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x95ce510")
-          (pos 64 -168)
+          (id "0xb115238")
+          (pos 192 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -218,8 +245,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x96a6828")
-          (pos 1216 -168)
+          (id "0xb1150b8")
+          (pos 1344 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -229,8 +256,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x96a68b8")
-          (pos 1600 -168)
+          (id "0xb1152d8")
+          (pos 1728 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -240,8 +267,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9201440")
-          (pos 832 -168)
+          (id "0xb115378")
+          (pos 960 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -251,8 +278,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x97eace0")
-          (pos 448 -168)
+          (id "0xb114c78")
+          (pos 576 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -264,11 +291,11 @@
     (layer
       (name "Shadow")
       (visible #t)
-      (locked #f)
+      (locked #t)
       (objects
         (decal
-          (id "0x97eb008")
-          (pos 1441 707)
+          (id "0xacf7a18")
+          (pos 1511 684)
           (parent "")
           (select-mask 1)
           (path "images/decal/dark.png")
@@ -278,8 +305,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x916c820")
-          (pos 335 636)
+          (id "0xacf7af8")
+          (pos 405 613)
           (parent "")
           (select-mask 1)
           (path "images/decal/dark.png")
@@ -289,8 +316,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x92012a0")
-          (pos 880 619)
+          (id "0xad05430")
+          (pos 950 596)
           (parent "")
           (select-mask 1)
           (path "images/decal/dark.png")
@@ -300,8 +327,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9201128")
-          (pos 595 535)
+          (id "0xad05240")
+          (pos 665 512)
           (parent "")
           (select-mask 1)
           (path "images/decal/dark.png")
@@ -311,8 +338,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9201180")
-          (pos -216 713)
+          (id "0xacf96d8")
+          (pos -146 690)
           (parent "")
           (select-mask 1)
           (path "images/decal/dark.png")
@@ -322,8 +349,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x992f310")
-          (pos 77 707)
+          (id "0xacf9548")
+          (pos 147 684)
           (parent "")
           (select-mask 1)
           (path "images/decal/dark.png")
@@ -333,8 +360,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x992f110")
-          (pos 1162 267)
+          (id "0xacf8a00")
+          (pos 1232 244)
           (parent "")
           (select-mask 1)
           (path "images/decal/dark.png")
@@ -344,8 +371,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x91706e0")
-          (pos 938 92)
+          (id "0xacf8ba8")
+          (pos 1008 69)
           (parent "")
           (select-mask 1)
           (path "images/decal/dark.png")
@@ -355,8 +382,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9170520")
-          (pos 1207 674)
+          (id "0xacf8cb0")
+          (pos 1277 651)
           (parent "")
           (select-mask 1)
           (path "images/decal/dark.png")
@@ -368,11 +395,11 @@
     (layer
       (name "Locker")
       (visible #t)
-      (locked #f)
+      (locked #t)
       (objects
         (decal
-          (id "0x9170468")
-          (pos 347 535)
+          (id "0xab86220")
+          (pos 448 512)
           (parent "")
           (select-mask 1)
           (path "images/objects/locker.png")
@@ -382,8 +409,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9a07eb0")
-          (pos 475 535)
+          (id "0xab86f58")
+          (pos 576 512)
           (parent "")
           (select-mask 1)
           (path "images/objects/locker.png")
@@ -393,8 +420,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9a079d0")
-          (pos 603 535)
+          (id "0xab83bb8")
+          (pos 704 512)
           (parent "")
           (select-mask 1)
           (path "images/objects/locker.png")
@@ -404,8 +431,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9a07b00")
-          (pos 731 535)
+          (id "0xab83930")
+          (pos 832 512)
           (parent "")
           (select-mask 1)
           (path "images/objects/locker.png")
@@ -415,8 +442,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9a68c70")
-          (pos 859 535)
+          (id "0xab839f0")
+          (pos 960 512)
           (parent "")
           (select-mask 1)
           (path "images/objects/locker.png")
@@ -426,8 +453,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9a68b20")
-          (pos -698 521)
+          (id "0xab842a0")
+          (pos -705 497)
           (parent "")
           (select-mask 1)
           (path "images/objects/elevatordoor.png")
@@ -437,8 +464,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9a88d30")
-          (pos -699 536)
+          (id "0xab84ae0")
+          (pos -704 512)
           (parent "")
           (select-mask 1)
           (path "images/objects/door.png")
@@ -448,8 +475,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9a28850")
-          (pos -317 620)
+          (id "0xacfa198")
+          (pos -247 597)
           (parent "")
           (select-mask 1)
           (path "images/objects/bed.png")
@@ -459,8 +486,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9ac98b0")
-          (pos 82 620)
+          (id "0xacf5750")
+          (pos 152 597)
           (parent "")
           (select-mask 1)
           (path "images/objects/bed.png")
@@ -470,8 +497,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9ac9190")
-          (pos -168 -104)
+          (id "0xacf9f80")
+          (pos -98 -127)
           (parent "")
           (select-mask 1)
           (path "images/objects/door.png")
@@ -481,8 +508,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9ac9258")
-          (pos -167 -119)
+          (id "0xae7bfc8")
+          (pos -97 -142)
           (parent "")
           (select-mask 1)
           (path "images/objects/elevatordoor.png")
@@ -492,8 +519,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9ac93c0")
-          (pos 421 -119)
+          (id "0xae7c588")
+          (pos 491 -142)
           (parent "")
           (select-mask 1)
           (path "images/objects/elevatordoor.png")
@@ -503,8 +530,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9bff3f0")
-          (pos 419 -104)
+          (id "0xae7be60")
+          (pos 489 -127)
           (parent "")
           (select-mask 1)
           (path "images/objects/door.png")
@@ -514,8 +541,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9bff4c0")
-          (pos -718 -119)
+          (id "0xae7bd28")
+          (pos -648 -142)
           (parent "")
           (select-mask 1)
           (path "images/objects/elevatordoor.png")
@@ -525,8 +552,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9bff558")
-          (pos -719 -104)
+          (id "0xae7c120")
+          (pos -649 -127)
           (parent "")
           (select-mask 1)
           (path "images/objects/door.png")
@@ -538,11 +565,11 @@
     (layer
       (name "Stairs")
       (visible #t)
-      (locked #f)
+      (locked #t)
       (objects
         (decal
-          (id "0x9bc7b68")
-          (pos 1356 380)
+          (id "0xa218a70")
+          (pos 1426 357)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair2.png")
@@ -552,8 +579,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9bc7c08")
-          (pos 1356 540)
+          (id "0xa427ca0")
+          (pos 1426 517)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair1.png")
@@ -563,8 +590,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9caea10")
-          (pos 1484 668)
+          (id "0xa42a3f0")
+          (pos 1554 645)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair1.png")
@@ -574,8 +601,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9d49810")
-          (pos 1484 508)
+          (id "0xa42a580")
+          (pos 1554 485)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair2.png")
@@ -585,8 +612,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9cae828")
-          (pos 1228 252)
+          (id "0xa42acf0")
+          (pos 1298 229)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair2.png")
@@ -596,8 +623,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9cae8a8")
-          (pos 1100 284)
+          (id "0xab85e00")
+          (pos 1170 261)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair1.png")
@@ -607,8 +634,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9d935e0")
-          (pos 1100 124)
+          (id "0xab85f80")
+          (pos 1170 101)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair2.png")
@@ -618,8 +645,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9d79b48")
-          (pos 1228 412)
+          (id "0xab86148")
+          (pos 1298 389)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair1.png")
@@ -629,8 +656,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9dad0d0")
-          (pos 968 156)
+          (id "0xa42a8d8")
+          (pos 1038 133)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair1.png")
@@ -640,8 +667,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9dbd290")
-          (pos 968 -4)
+          (id "0xa42ab48")
+          (pos 1038 -27)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair2.png")
@@ -651,13 +678,20 @@
           (hflip #f)
           (vflip #f))))
     (layer
+      (name "NGStairs")
+      (visible #t)
+      (locked #t)
+      (objects
+        (navgraph-edge-ref
+          (edge "0xa218058"))))
+    (layer
       (name "Ground")
       (visible #t)
       (locked #f)
       (objects
         (decal
-          (id "0x9a082f0")
-          (pos 1651 728)
+          (id "0xa2f2120")
+          (pos 1791 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -667,8 +701,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x916ed90")
-          (pos 883 728)
+          (id "0xa2f4610")
+          (pos 1023 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -678,8 +712,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x916ee20")
-          (pos 1140 729)
+          (id "0xa2f6030")
+          (pos 1280 704)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -689,8 +723,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9193028")
-          (pos 371 728)
+          (id "0xa2f4560")
+          (pos 511 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -700,8 +734,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x91939b8")
-          (pos 115 728)
+          (id "0xa2f6190")
+          (pos 255 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -711,8 +745,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9193640")
-          (pos -141 728)
+          (id "0xa2f5ec8")
+          (pos -1 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -722,8 +756,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x91934f8")
-          (pos 627 728)
+          (id "0xa2f5be0")
+          (pos 767 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -733,8 +767,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9193760")
-          (pos 1395 728)
+          (id "0xa2fb100")
+          (pos 1535 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -744,8 +778,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9193cc0")
-          (pos -93 216)
+          (id "0xa2fb1a8")
+          (pos 0 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -755,8 +789,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9193b00")
-          (pos 163 216)
+          (id "0xa2f9540")
+          (pos 256 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -766,8 +800,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9193c08")
-          (pos 419 216)
+          (id "0xa2f9400")
+          (pos 512 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -777,8 +811,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9193190")
-          (pos 1187 216)
+          (id "0xa2f9e68")
+          (pos 1280 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -788,8 +822,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9193ec8")
-          (pos 931 216)
+          (id "0xa2facb8")
+          (pos 1024 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -799,8 +833,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9193fd0")
-          (pos 675 216)
+          (id "0xa2fad60")
+          (pos 768 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -810,8 +844,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x91949d0")
-          (pos 1699 216)
+          (id "0xa2fa420")
+          (pos 1792 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -821,8 +855,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9f4b178")
-          (pos 1443 216)
+          (id "0xa2fa5e0")
+          (pos 1536 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -832,8 +866,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9f4b280")
-          (pos -909 728)
+          (id "0xa2fae68")
+          (pos -769 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -843,8 +877,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9f4b3b0")
-          (pos -653 728)
+          (id "0xa2f9f30")
+          (pos -513 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -854,8 +888,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x91946b8")
-          (pos -1421 728)
+          (id "0xa2fa048")
+          (pos -1281 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -865,8 +899,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x91947a8")
-          (pos -1677 728)
+          (id "0xa2fa718")
+          (pos -1537 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -876,8 +910,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9fab7a0")
-          (pos -1933 728)
+          (id "0xa42aef0")
+          (pos -1793 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -887,8 +921,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa03be00")
-          (pos -1165 728)
+          (id "0xa2fa970")
+          (pos -1025 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -898,8 +932,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9fab5f0")
-          (pos -397 728)
+          (id "0xa2faa30")
+          (pos -257 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -909,8 +943,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa03bee8")
-          (pos -1885 216)
+          (id "0xa42af40")
+          (pos -1792 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -920,8 +954,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9fcbbb0")
-          (pos -1629 216)
+          (id "0xa42c2a8")
+          (pos -1536 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -931,8 +965,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9fcb9d8")
-          (pos -1373 216)
+          (id "0xa42b4d8")
+          (pos -1280 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -942,8 +976,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa09c580")
-          (pos -605 216)
+          (id "0xa42b2d8")
+          (pos -512 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -953,8 +987,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9194440")
-          (pos -861 216)
+          (id "0xa42b368")
+          (pos -768 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -964,8 +998,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x91942d8")
-          (pos -1117 216)
+          (id "0xa42bb60")
+          (pos -1024 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -975,8 +1009,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa134f48")
-          (pos -349 216)
+          (id "0xa42b8c0")
+          (pos -256 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -986,8 +1020,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa1351c8")
-          (pos 1907 728)
+          (id "0xa42b730")
+          (pos 2047 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -997,8 +1031,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa175508")
-          (pos 2163 728)
+          (id "0xa42c118")
+          (pos 2303 703)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -1008,8 +1042,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa1756e0")
-          (pos 1955 216)
+          (id "0xa42bfb0")
+          (pos 2048 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1019,8 +1053,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa1755e8")
-          (pos 2211 216)
+          (id "0xa426e90")
+          (pos 2304 192)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1030,8 +1064,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa0b4e08")
-          (pos 1924 88)
+          (id "0xa426f90")
+          (pos 2304 64)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -1041,8 +1075,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa09c400")
-          (pos -380 88)
+          (id "0xa4269a8")
+          (pos 0 64)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -1052,8 +1086,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa09c4d0")
-          (pos -636 88)
+          (id "0xa426c60")
+          (pos -256 64)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -1063,8 +1097,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa1c5780")
-          (pos -892 88)
+          (id "0xa426a48")
+          (pos -512 64)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -1074,8 +1108,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa1c58c0")
-          (pos 1412 88)
+          (id "0xa427a70")
+          (pos 1792 64)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -1085,8 +1119,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa235eb0")
-          (pos 644 88)
+          (id "0xa4278f0")
+          (pos 1024 64)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -1096,8 +1130,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2661e0")
-          (pos -124 88)
+          (id "0xa427740")
+          (pos 256 64)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -1107,8 +1141,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa266400")
-          (pos 132 88)
+          (id "0xa427180")
+          (pos 512 64)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -1118,8 +1152,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa266228")
-          (pos 388 88)
+          (id "0xa4274e8")
+          (pos 768 64)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -1129,8 +1163,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa27e6c8")
-          (pos 1156 88)
+          (id "0xa427280")
+          (pos 1536 64)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -1140,8 +1174,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa27e560")
-          (pos 900 88)
+          (id "0xa428a90")
+          (pos 1280 64)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -1151,8 +1185,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa0b4b38")
-          (pos 1668 88)
+          (id "0xa428030")
+          (pos 2048 64)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -1162,8 +1196,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2ae9e8")
-          (pos 2234 -424)
+          (id "0xa4284b0")
+          (pos 2304 -448)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1173,8 +1207,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2ae848")
-          (pos 1978 -424)
+          (id "0xa428b30")
+          (pos 2048 -448)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1184,8 +1218,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2dec60")
-          (pos -326 -424)
+          (id "0xa428340")
+          (pos -256 -447)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1195,8 +1229,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa0b4758")
-          (pos -1094 -424)
+          (id "0xa4281a8")
+          (pos -1024 -447)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1206,8 +1240,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa326e40")
-          (pos -838 -424)
+          (id "0xa42ade0")
+          (pos -768 -447)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1217,8 +1251,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa387698")
-          (pos -582 -424)
+          (id "0xa428768")
+          (pos -512 -447)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1228,8 +1262,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa387858")
-          (pos 1466 -424)
+          (id "0xa3688f8")
+          (pos 1536 -447)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1239,8 +1273,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa3a7b30")
-          (pos 1722 -424)
+          (id "0xa368c20")
+          (pos 1792 -447)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1250,8 +1284,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa3879a8")
-          (pos 698 -424)
+          (id "0xa368e00")
+          (pos 768 -447)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1261,8 +1295,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa3a7c48")
-          (pos 954 -424)
+          (id "0xa369000")
+          (pos 1024 -447)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1272,8 +1306,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa3e8098")
-          (pos 1210 -424)
+          (id "0xa368e60")
+          (pos 1280 -447)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1283,8 +1317,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa3e8110")
-          (pos 442 -424)
+          (id "0xa369350")
+          (pos 512 -447)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1294,8 +1328,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa327310")
-          (pos 186 -424)
+          (id "0xa369520")
+          (pos 256 -447)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1305,8 +1339,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa327638")
-          (pos -70 -424)
+          (id "0xa3696e8")
+          (pos 0 -447)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1314,15 +1348,59 @@
           (scale 1 1)
           (angle 0)
           (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0xa22ff68")
+          (pos -768 64)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/blueground.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0xa1314c0")
+          (pos -1024 64)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/blueground.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0xa132f28")
+          (pos -1280 64)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/blueground.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0xa132ea0")
+          (pos -1536 64)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/blueground.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
           (vflip #f))))
     (layer
       (name "Highlight")
       (visible #t)
-      (locked #f)
+      (locked #t)
       (objects
         (decal
-          (id "0xa428588")
-          (pos -511 284)
+          (id "0xa241000")
+          (pos -441 261)
           (parent "")
           (select-mask 1)
           (path "images/objects/apartmentlamp_highlight.png")
@@ -1332,8 +1410,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9de6bc0")
-          (pos 667 283)
+          (id "0xa2c3968")
+          (pos 737 260)
           (parent "")
           (select-mask 1)
           (path "images/objects/apartmentlamp_highlight.png")
@@ -1343,8 +1421,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9ac9740")
-          (pos 1330 280)
+          (id "0xa258948")
+          (pos 1400 257)
           (parent "")
           (select-mask 1)
           (path "images/objects/apartmentlamp_highlight.png")
@@ -1354,8 +1432,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa06c0d8")
-          (pos 46 280)
+          (id "0xa258a18")
+          (pos 116 257)
           (parent "")
           (select-mask 1)
           (path "images/objects/apartmentlamp_highlight.png")
@@ -1365,8 +1443,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa428500")
-          (pos -490 305)
+          (id "0xa258ad8")
+          (pos -420 282)
           (parent "")
           (select-mask 1)
           (path "images/decal/rooflamp_bloom.png")
@@ -1376,8 +1454,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9192c00")
-          (pos 56 311)
+          (id "0xa2e7d20")
+          (pos 126 288)
           (parent "")
           (select-mask 1)
           (path "images/decal/rooflamp_bloom.png")
@@ -1387,8 +1465,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9192dd8")
-          (pos 666 291)
+          (id "0xa2e7ed0")
+          (pos 736 268)
           (parent "")
           (select-mask 1)
           (path "images/decal/rooflamp_bloom.png")
@@ -1398,8 +1476,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa326f20")
-          (pos 1341 302)
+          (id "0xa2e9758")
+          (pos 1411 279)
           (parent "")
           (select-mask 1)
           (path "images/decal/rooflamp_bloom.png")
@@ -1409,8 +1487,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa326ff8")
-          (pos 1403 -339)
+          (id "0xa2e7f90")
+          (pos 1473 -362)
           (parent "")
           (select-mask 1)
           (path "images/decal/rooflamp_bloom.png")
@@ -1420,8 +1498,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa327160")
-          (pos 738 -336)
+          (id "0xa2e80b8")
+          (pos 808 -359)
           (parent "")
           (select-mask 1)
           (path "images/decal/rooflamp_bloom.png")
@@ -1431,8 +1509,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9d69938")
-          (pos 118 -330)
+          (id "0xa2e8198")
+          (pos 188 -353)
           (parent "")
           (select-mask 1)
           (path "images/decal/rooflamp_bloom.png")
@@ -1442,8 +1520,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa205c08")
-          (pos -428 -336)
+          (id "0xa2e9090")
+          (pos -358 -359)
           (parent "")
           (select-mask 1)
           (path "images/decal/rooflamp_bloom.png")
@@ -1453,8 +1531,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa205d18")
-          (pos 108 -360)
+          (id "0xa2e9168")
+          (pos 178 -383)
           (parent "")
           (select-mask 1)
           (path "images/objects/apartmentlamp_highlight.png")
@@ -1464,8 +1542,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa542ca0")
-          (pos 1393 -360)
+          (id "0xa2e9560")
+          (pos 1463 -383)
           (parent "")
           (select-mask 1)
           (path "images/objects/apartmentlamp_highlight.png")
@@ -1475,8 +1553,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa5422d0")
-          (pos 729 -358)
+          (id "0xa2e93f0")
+          (pos 799 -381)
           (parent "")
           (select-mask 1)
           (path "images/objects/apartmentlamp_highlight.png")
@@ -1486,8 +1564,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa542470")
-          (pos -449 -356)
+          (id "0xa2e92b0")
+          (pos -379 -379)
           (parent "")
           (select-mask 1)
           (path "images/objects/apartmentlamp_highlight.png")
@@ -1499,11 +1577,11 @@
     (layer
       (name "Light")
       (visible #t)
-      (locked #f)
+      (locked #t)
       (objects
         (decal
-          (id "0xa542de8")
-          (pos 68 602)
+          (id "0xa21ad58")
+          (pos 138 579)
           (parent "")
           (select-mask 1)
           (path "images/decal/light.png")
@@ -1513,8 +1591,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa5428e8")
-          (pos 1357 593)
+          (id "0xa240c58")
+          (pos 1427 570)
           (parent "")
           (select-mask 1)
           (path "images/decal/light.png")
@@ -1524,8 +1602,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa578ec8")
-          (pos -509 585)
+          (id "0xa240dc8")
+          (pos -439 562)
           (parent "")
           (select-mask 1)
           (path "images/decal/light.png")
@@ -1535,8 +1613,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa578f58")
-          (pos 676 586)
+          (id "0xa258f90")
+          (pos 746 563)
           (parent "")
           (select-mask 1)
           (path "images/decal/light.png")
@@ -1546,8 +1624,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa579018")
-          (pos 54 -115)
+          (id "0xa259320")
+          (pos 124 -138)
           (parent "")
           (select-mask 1)
           (path "images/decal/light.png")
@@ -1557,8 +1635,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa5427a8")
-          (pos 663 -130)
+          (id "0xa259200")
+          (pos 733 -153)
           (parent "")
           (select-mask 1)
           (path "images/decal/light.png")
@@ -1568,8 +1646,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa542670")
-          (pos -526 -130)
+          (id "0xa242020")
+          (pos -456 -153)
           (parent "")
           (select-mask 1)
           (path "images/decal/light.png")
@@ -1579,8 +1657,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa5420e8")
-          (pos 1343 -123)
+          (id "0xa242140")
+          (pos 1413 -146)
           (parent "")
           (select-mask 1)
           (path "images/decal/light.png")
@@ -1592,11 +1670,11 @@
     (layer
       (name "Scene")
       (visible #t)
-      (locked #f)
+      (locked #t)
       (objects
         (decal
-          (id "0xa428330")
-          (pos 1214 549)
+          (id "0xa218b98")
+          (pos 1284 526)
           (parent "")
           (select-mask 1)
           (path "images/decal/humanreference.png")
@@ -1604,6 +1682,14 @@
           (scale 1 1)
           (angle 0)
           (hflip #f)
-          (vflip #f))))))
+          (vflip #f))
+        (navgraph-edge-ref
+          (edge "0xa2187e0"))
+        (navgraph-edge-ref
+          (edge "0xa218740"))
+        (navgraph-edge-ref
+          (edge "0xa218660"))
+        (navgraph-edge-ref
+          (edge "0xa218590"))))))
 
 ;; EOF ;;



From grumbel at mail.berlios.de  Mon Sep 14 21:14:42 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 14 Sep 2009 21:14:42 +0200
Subject: [Windstille-commit] r3245 - trunk/windstille/src/editor
Message-ID: <200909141914.n8EJEg1G007374@sheep.berlios.de>

Author: grumbel
Date: 2009-09-14 21:14:40 +0200 (Mon, 14 Sep 2009)
New Revision: 3245

Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/document.hpp
   trunk/windstille/src/editor/editor_window.cpp
Log:
Fixed SelectAll behaviour

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-14 19:07:06 UTC (rev 3244)
+++ trunk/windstille/src/editor/document.cpp	2009-09-14 19:14:40 UTC (rev 3245)
@@ -502,6 +502,21 @@
 }
 
 void
+Document::select_all()
+{
+  SelectionHandle selection = Selection::create();
+  SectorModel::Layers layers = m_sector_model->get_layers();
+
+  for(SectorModel::Layers::iterator i = layers.begin(); i != layers.end(); ++i)
+  {
+    if (!(*i)->is_locked())
+      selection->add((*i)->begin(), (*i)->end());
+  }
+  
+  set_selection(selection);
+}
+
+void
 Document::set_selection(const SelectionHandle& selection)
 {
   m_selection = selection;
@@ -518,6 +533,7 @@
   {
     m_selection->add_control_points(m_control_points);
   }
+  m_sig_on_change();
 }
 
 ControlPointHandle

Modified: trunk/windstille/src/editor/document.hpp
===================================================================
--- trunk/windstille/src/editor/document.hpp	2009-09-14 19:07:06 UTC (rev 3244)
+++ trunk/windstille/src/editor/document.hpp	2009-09-14 19:14:40 UTC (rev 3245)
@@ -120,6 +120,8 @@
 
   void selection_object_properties();
 
+  void select_all();
+
   void set_selection(const SelectionHandle& selection);
   SelectionHandle get_selection() const { return m_selection; }
   /** @} */

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-14 19:07:06 UTC (rev 3244)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-14 19:14:40 UTC (rev 3245)
@@ -942,10 +942,7 @@
   // Select all on current layer
   if (WindstilleWidget* wst = get_windstille_widget())
   {
-    LayerHandle layer = wst->get_current_layer();
-    SelectionHandle selection = Selection::create();
-    selection->add(layer->begin(), layer->end());
-    wst->get_document().set_selection(selection);
+    wst->get_document().select_all();
   }
 }
 



From grumbel at mail.berlios.de  Mon Sep 14 21:46:54 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 14 Sep 2009 21:46:54 +0200
Subject: [Windstille-commit] r3246 - trunk/windstille/src/editor
Message-ID: <200909141946.n8EJksCI010194@sheep.berlios.de>

Author: grumbel
Date: 2009-09-14 21:46:54 +0200 (Mon, 14 Sep 2009)
New Revision: 3246

Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/windstille_widget.cpp
Log:
Removed some debuging std::cout

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-14 19:14:40 UTC (rev 3245)
+++ trunk/windstille/src/editor/document.cpp	2009-09-14 19:46:54 UTC (rev 3246)
@@ -139,7 +139,6 @@
 {
   if (m_group_command)
   {
-    std::cout << "Group Command" << std::endl;
     m_group_command->add(cmd);
   }
   else

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-14 19:14:40 UTC (rev 3245)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-14 19:46:54 UTC (rev 3246)
@@ -565,7 +565,6 @@
 void
 WindstilleWidget::on_document_change()
 {
-  std::cout << "WindstilleWidget::on_document_change" << std::endl;
   m_rebuild_scene_graph = true;
   EditorWindow::current()->update_undo_state();
   queue_draw();



From grumbel at mail.berlios.de  Mon Sep 14 21:47:08 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 14 Sep 2009 21:47:08 +0200
Subject: [Windstille-commit] r3247 - trunk/windstille/src/editor
Message-ID: <200909141947.n8EJl8l5010225@sheep.berlios.de>

Author: grumbel
Date: 2009-09-14 21:47:08 +0200 (Mon, 14 Sep 2009)
New Revision: 3247

Modified:
   trunk/windstille/src/editor/decal_object_model.hpp
Log:
Sync on flip()

Modified: trunk/windstille/src/editor/decal_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.hpp	2009-09-14 19:46:54 UTC (rev 3246)
+++ trunk/windstille/src/editor/decal_object_model.hpp	2009-09-14 19:47:08 UTC (rev 3247)
@@ -75,8 +75,8 @@
   bool get_hflip() const { return hflip; }
   bool get_vflip() const { return vflip; }
 
-  void set_hflip(bool t) { hflip = t; }
-  void set_vflip(bool t) { vflip = t; }
+  void set_hflip(bool t) { hflip = t; sync(); }
+  void set_vflip(bool t) { vflip = t; sync(); }
 
   bool is_at(const Vector2f& pos) const;
 



From grumbel at mail.berlios.de  Mon Sep 14 22:18:08 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 14 Sep 2009 22:18:08 +0200
Subject: [Windstille-commit] r3248 - in trunk/windstille: . src/editor
Message-ID: <200909142018.n8EKI8DH013265@sheep.berlios.de>

Author: grumbel
Date: 2009-09-14 22:18:07 +0200 (Mon, 14 Sep 2009)
New Revision: 3248

Modified:
   trunk/windstille/TODO
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/editor_window.hpp
   trunk/windstille/src/editor/windstille_widget.cpp
   trunk/windstille/src/editor/windstille_widget.hpp
Log:
Moved ScrollTool out of WindstilleWidget

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2009-09-14 19:47:08 UTC (rev 3247)
+++ trunk/windstille/TODO	2009-09-14 20:18:07 UTC (rev 3248)
@@ -15,8 +15,6 @@
 
 * SceneGraph needs to be updated while drag&drop is in progress
 
-* Move scroll_tool to EditorWindow, away from WindstilleWidget
-
 * delete/remove/erase naming is a bit mixed up in a few places
 
 * being able to directly mark Edges still feels wonky, need to rethink the thing again
@@ -25,13 +23,16 @@
   sector to another causes crazy stuff to happen as the nodes it links
   to are on another sector
 
-* add grid snapping to navgraph
+* draw NavGraph lines thicker (i.e. glLineWidth())
 
-* draw NavGraph lines thicker (glLineWidth())
-
 * color code them by layer
 
 * add special drawing for different edge types (i.e. draw stairs for stair type edges)
+
+* add grid snapping to navgraph
+
+* moving a NavGraphNodeModel snaps the bounding box to the grid, while
+  it should snap the center point
 
 SceneGraph/Compositor
 =====================

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-14 19:47:08 UTC (rev 3247)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-14 20:18:07 UTC (rev 3248)
@@ -35,6 +35,7 @@
 #include "editor/about_window.hpp"
 #include "editor/editor_window.hpp"
 #include "editor/zoom_tool.hpp"
+#include "editor/scroll_tool.hpp"
 #include "editor/select_tool.hpp"
 #include "editor/navgraph_insert_tool.hpp"
 #include "editor/sector_model.hpp"
@@ -74,6 +75,7 @@
     select_tool(new SelectTool()),
     navgraph_insert_tool(new NavgraphInsertTool()),
     zoom_tool(new ZoomTool()),
+    scroll_tool(new ScrollTool()),
     current_tool(select_tool.get()),
     layer_widget(),
     timeout_connection(),
@@ -775,6 +777,12 @@
   return current_tool;
 }
 
+ScrollTool*
+EditorWindow::get_scroll_tool() const
+{
+  return scroll_tool.get();
+}
+
 WindstilleWidget*
 EditorWindow::get_windstille_widget()
 {

Modified: trunk/windstille/src/editor/editor_window.hpp
===================================================================
--- trunk/windstille/src/editor/editor_window.hpp	2009-09-14 19:47:08 UTC (rev 3247)
+++ trunk/windstille/src/editor/editor_window.hpp	2009-09-14 20:18:07 UTC (rev 3248)
@@ -40,6 +40,7 @@
 class WindstilleWidget;
 class SelectTool;
 class ZoomTool;
+class ScrollTool;
 class LayerWidget;
 class NavgraphInsertTool;
 
@@ -84,6 +85,7 @@
   boost::scoped_ptr<SelectTool>   select_tool;
   boost::scoped_ptr<NavgraphInsertTool> navgraph_insert_tool;
   boost::scoped_ptr<ZoomTool>     zoom_tool;
+  boost::scoped_ptr<ScrollTool>   scroll_tool;
   Tool* current_tool;
   LayerWidget* layer_widget;
 
@@ -140,6 +142,7 @@
   void on_reverse_layers();
 
   Tool* get_current_tool() const;
+  ScrollTool* get_scroll_tool() const;
 
   LayerManager& get_layer_manager() { return layer_manager; }
   WindstilleWidget* get_windstille_widget();

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-14 19:47:08 UTC (rev 3247)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-14 20:18:07 UTC (rev 3248)
@@ -53,7 +53,6 @@
     state(),
     compositor(),
     sc(),
-    scroll_tool(new ScrollTool),
     map_type(DecalObjectModel::COLORMAP),
     background_pattern(),
     select_mask(1),
@@ -338,7 +337,7 @@
   }
   else if (ev->button == 2)
   { // Scroll
-    scroll_tool->mouse_down(ev, *this);
+    EditorWindow::current()->get_scroll_tool()->mouse_down(ev, *this);
     return true;
   }
   else if (ev->button == 3)
@@ -358,7 +357,7 @@
   //std::cout << "Motion: " << ev->x << ", " << ev->y << std::endl;
   
   EditorWindow::current()->get_current_tool()->mouse_move(ev, *this);
-  scroll_tool->mouse_move(ev, *this);
+  EditorWindow::current()->get_scroll_tool()->mouse_move(ev, *this);
   
   return true;
 }
@@ -375,7 +374,7 @@
   }
   else if (ev->button == 2)
   {
-    scroll_tool->mouse_up(ev, *this);
+    EditorWindow::current()->get_scroll_tool()->mouse_up(ev, *this);
     queue_draw();
   }
 

Modified: trunk/windstille/src/editor/windstille_widget.hpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.hpp	2009-09-14 19:47:08 UTC (rev 3247)
+++ trunk/windstille/src/editor/windstille_widget.hpp	2009-09-14 20:18:07 UTC (rev 3248)
@@ -66,7 +66,6 @@
   GraphicContextState   state;
   boost::scoped_ptr<Compositor> compositor;
   boost::scoped_ptr<SceneContext> sc;
-  boost::scoped_ptr<ScrollTool> scroll_tool;
   DecalObjectModel::MapType map_type;
   Texture background_pattern;
   SelectMask select_mask;



From grumbel at mail.berlios.de  Mon Sep 14 23:56:00 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 14 Sep 2009 23:56:00 +0200
Subject: [Windstille-commit] r3249 - trunk/windstille/src/navigation
Message-ID: <200909142156.n8ELu0At021518@sheep.berlios.de>

Author: grumbel
Date: 2009-09-14 23:55:59 +0200 (Mon, 14 Sep 2009)
New Revision: 3249

Modified:
   trunk/windstille/src/navigation/edge.cpp
   trunk/windstille/src/navigation/edge.hpp
   trunk/windstille/src/navigation/node.hpp
Log:
Minor cleanup

Modified: trunk/windstille/src/navigation/edge.cpp
===================================================================
--- trunk/windstille/src/navigation/edge.cpp	2009-09-14 20:18:07 UTC (rev 3248)
+++ trunk/windstille/src/navigation/edge.cpp	2009-09-14 21:55:59 UTC (rev 3249)
@@ -16,10 +16,11 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
+#include "navigation/edge.hpp"
+
 #include <assert.h>
 
 #include "navigation/node.hpp"
-#include "navigation/edge.hpp"
 
 Edge::Edge(Node* node1_, Node* node2_, Properties props_)
   : node1(node1_), 

Modified: trunk/windstille/src/navigation/edge.hpp
===================================================================
--- trunk/windstille/src/navigation/edge.hpp	2009-09-14 20:18:07 UTC (rev 3248)
+++ trunk/windstille/src/navigation/edge.hpp	2009-09-14 21:55:59 UTC (rev 3249)
@@ -25,7 +25,6 @@
 
 class Node;
 
-/** */
 class Edge
 {
 private:

Modified: trunk/windstille/src/navigation/node.hpp
===================================================================
--- trunk/windstille/src/navigation/node.hpp	2009-09-14 20:18:07 UTC (rev 3248)
+++ trunk/windstille/src/navigation/node.hpp	2009-09-14 21:55:59 UTC (rev 3249)
@@ -25,7 +25,6 @@
 
 #include "navigation/edge_position.hpp"
 
-/** */
 class Node
 {
 private:



From grumbel at mail.berlios.de  Mon Sep 14 23:56:36 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 14 Sep 2009 23:56:36 +0200
Subject: [Windstille-commit] r3250 - trunk/windstille/src/editor
Message-ID: <200909142156.n8ELual3021621@sheep.berlios.de>

Author: grumbel
Date: 2009-09-14 23:56:35 +0200 (Mon, 14 Sep 2009)
New Revision: 3250

Modified:
   trunk/windstille/src/editor/object_model.cpp
   trunk/windstille/src/editor/object_model.hpp
   trunk/windstille/src/editor/select_tool.cpp
Log:
Moved grid snapping into ObjectModel, so objects can override the behaviour

Modified: trunk/windstille/src/editor/object_model.cpp
===================================================================
--- trunk/windstille/src/editor/object_model.cpp	2009-09-14 21:55:59 UTC (rev 3249)
+++ trunk/windstille/src/editor/object_model.cpp	2009-09-14 21:56:35 UTC (rev 3250)
@@ -188,7 +188,65 @@
     return true;
 }
 
+static float float_snap_to_grid(float v, float grid)
+{
+  return (roundf(v / grid) * grid) - v;
+}
+
 SnapData
+ObjectModel::snap_to_grid(float grid_size) const
+{
+  const float snap_threshold = 16.0f;
+
+  const Rectf& r = get_bounding_box();
+
+  Rectf snap_rect(float_snap_to_grid(r.left,   grid_size),
+                  float_snap_to_grid(r.top,    grid_size),
+                  float_snap_to_grid(r.right,  grid_size),
+                  float_snap_to_grid(r.bottom, grid_size));
+
+  SnapData best_snap;
+
+  {
+    SnapData snap;
+
+    if (fabs(snap_rect.left) < snap_threshold)
+    {
+      snap.x_set = true;
+      snap.offset.x = snap_rect.left;
+    }
+
+    if (fabs(snap_rect.top) < snap_threshold)
+    {
+      snap.y_set = true;
+      snap.offset.y = snap_rect.top;
+    }
+      
+    best_snap.merge(snap);
+  }
+
+  {
+    SnapData snap;
+
+    if (fabs(snap_rect.right) < snap_threshold)
+    {
+      snap.x_set = true;
+      snap.offset.x = snap_rect.right;
+    }
+
+    if (fabs(snap_rect.bottom) < snap_threshold)
+    {
+      snap.y_set = true;
+      snap.offset.y = snap_rect.bottom;
+    }
+      
+    best_snap.merge(snap);
+  }
+
+  return best_snap;
+}
+
+SnapData
 ObjectModel::snap_object(const Rectf& in) const
 {
   const Rectf& rect = get_bounding_box();

Modified: trunk/windstille/src/editor/object_model.hpp
===================================================================
--- trunk/windstille/src/editor/object_model.hpp	2009-09-14 21:55:59 UTC (rev 3249)
+++ trunk/windstille/src/editor/object_model.hpp	2009-09-14 21:56:35 UTC (rev 3250)
@@ -65,6 +65,7 @@
   virtual void   set_select_mask(const SelectMask& select_mask_) { select_mask = select_mask_; }
 
   SnapData snap_object(const Rectf& rect) const;
+  SnapData snap_to_grid(float grid_size) const;
 
   virtual bool get_hflip() const { return false; }
   virtual bool get_vflip() const { return false; }

Modified: trunk/windstille/src/editor/select_tool.cpp
===================================================================
--- trunk/windstille/src/editor/select_tool.cpp	2009-09-14 21:55:59 UTC (rev 3249)
+++ trunk/windstille/src/editor/select_tool.cpp	2009-09-14 21:56:35 UTC (rev 3250)
@@ -98,75 +98,14 @@
   wst.queue_draw();
 }
 
-static float snap_to_grid(float v, int grid)
-{
-    int v_i = static_cast<int>(v);
-    int rounded = v_i / grid * grid;
-    int left  = rounded;
-    int right = rounded + ((v >= 0) ? grid : -grid);
-
-    if (abs(left - v_i) < abs(right - v_i))
-    {
-      return static_cast<float>(left) - v;
-    }
-    else
-    {
-      return static_cast<float>(right) - v;
-    }
-}
-
 Vector2f
 SelectTool::process_grid_snap(WindstilleWidget& wst)
 {
-  const int grid_width = 128;
-  const float snap_distance = 16.0f;
   SnapData best_snap;
 
-  // Snap to the 64x64 grid
   for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
   {
-    const Rectf& r = (*i)->get_bounding_box();
-
-    Rectf snap_rect(snap_to_grid(r.left,   grid_width),
-                    snap_to_grid(r.top,    grid_width),
-                    snap_to_grid(r.right,  grid_width),
-                    snap_to_grid(r.bottom, grid_width));
-
-    {
-      SnapData snap;
-
-      if (fabs(snap_rect.left) < snap_distance)
-      {
-        snap.x_set = true;
-        snap.offset.x = snap_rect.left;
-      }
-
-      if (fabs(snap_rect.top) < snap_distance)
-      {
-        snap.y_set = true;
-        snap.offset.y = snap_rect.top;
-      }
-      
-      best_snap.merge(snap);
-    }
-
-    {
-      SnapData snap;
-
-      if (fabs(snap_rect.right) < snap_distance)
-      {
-        snap.x_set = true;
-        snap.offset.x = snap_rect.right;
-      }
-
-      if (fabs(snap_rect.bottom) < snap_distance)
-      {
-        snap.y_set = true;
-        snap.offset.y = snap_rect.bottom;
-      }
-      
-      best_snap.merge(snap);
-    }
+    best_snap.merge((*i)->snap_to_grid(128));
   }
    
   return best_snap.offset;



From grumbel at mail.berlios.de  Tue Sep 15 00:01:30 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 15 Sep 2009 00:01:30 +0200
Subject: [Windstille-commit] r3251 - trunk/windstille/src/editor
Message-ID: <200909142201.n8EM1U8g022331@sheep.berlios.de>

Author: grumbel
Date: 2009-09-15 00:01:29 +0200 (Tue, 15 Sep 2009)
New Revision: 3251

Modified:
   trunk/windstille/src/editor/navgraph_node_object_model.cpp
   trunk/windstille/src/editor/navgraph_node_object_model.hpp
   trunk/windstille/src/editor/object_model.hpp
Log:
Implemented proper grid snapping for NavGraphNodes

Modified: trunk/windstille/src/editor/navgraph_node_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-14 21:56:35 UTC (rev 3250)
+++ trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-14 22:01:29 UTC (rev 3251)
@@ -83,6 +83,36 @@
                Sizef(20.0f, 20.0f));
 }
 
+static float float_snap_to_grid(float v, float grid)
+{ 
+  return (roundf(v / grid) * grid) - v;
+}
+
+SnapData
+NavGraphNodeObjectModel::snap_to_grid(float grid_size) const
+{
+  const float snap_threshold = 16.0f;
+
+  float snap_x = float_snap_to_grid(get_world_pos().x, grid_size);
+  float snap_y = float_snap_to_grid(get_world_pos().y, grid_size);
+
+  SnapData snap;
+
+  if (fabs(snap_x) < snap_threshold)
+    {
+      snap.x_set = true;
+      snap.offset.x = snap_x;
+    }
+
+  if (fabs(snap_y) < snap_threshold)
+    {
+      snap.y_set = true;
+      snap.offset.y = snap_y;
+    }
+
+  return snap;
+}
+
 ObjectModelHandle 
 NavGraphNodeObjectModel::clone() const
 {

Modified: trunk/windstille/src/editor/navgraph_node_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-14 21:56:35 UTC (rev 3250)
+++ trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-14 22:01:29 UTC (rev 3251)
@@ -45,6 +45,8 @@
   ObjectModelHandle clone() const;
   void write(FileWriter& writer) const;
 
+  SnapData snap_to_grid(float grid_size) const;
+
 private:
   NavGraphNodeObjectModel(const NavGraphNodeObjectModel&);
   NavGraphNodeObjectModel& operator=(const NavGraphNodeObjectModel&);

Modified: trunk/windstille/src/editor/object_model.hpp
===================================================================
--- trunk/windstille/src/editor/object_model.hpp	2009-09-14 21:56:35 UTC (rev 3250)
+++ trunk/windstille/src/editor/object_model.hpp	2009-09-14 22:01:29 UTC (rev 3251)
@@ -64,8 +64,8 @@
   virtual SelectMask get_select_mask() const { return select_mask; }
   virtual void   set_select_mask(const SelectMask& select_mask_) { select_mask = select_mask_; }
 
-  SnapData snap_object(const Rectf& rect) const;
-  SnapData snap_to_grid(float grid_size) const;
+  virtual SnapData snap_object(const Rectf& rect) const;
+  virtual SnapData snap_to_grid(float grid_size) const;
 
   virtual bool get_hflip() const { return false; }
   virtual bool get_vflip() const { return false; }



From grumbel at mail.berlios.de  Tue Sep 15 19:13:22 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 15 Sep 2009 19:13:22 +0200
Subject: [Windstille-commit] r3252 - trunk/windstille/src/editor
Message-ID: <200909151713.n8FHDMDO009918@sheep.berlios.de>

Author: grumbel
Date: 2009-09-15 19:13:04 +0200 (Tue, 15 Sep 2009)
New Revision: 3252

Modified:
   trunk/windstille/src/editor/layer.cpp
   trunk/windstille/src/editor/layer.hpp
   trunk/windstille/src/editor/navgraph_edge_object_model.hpp
   trunk/windstille/src/editor/navgraph_node_object_model.cpp
   trunk/windstille/src/editor/navgraph_node_object_model.hpp
   trunk/windstille/src/editor/object_model.cpp
   trunk/windstille/src/editor/object_model.hpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
   trunk/windstille/src/editor/select_tool.cpp
Log:
Changed snap_object() to a snap_to_object(), thus reversing the logic, also implemented snapping for NavGraphNode

Modified: trunk/windstille/src/editor/layer.cpp
===================================================================
--- trunk/windstille/src/editor/layer.cpp	2009-09-14 22:01:29 UTC (rev 3251)
+++ trunk/windstille/src/editor/layer.cpp	2009-09-15 17:13:04 UTC (rev 3252)
@@ -189,10 +189,8 @@
 }
 
 SnapData
-Layer::snap_object(const Rectf& rect, const std::set<ObjectModelHandle>& ignore_objects) const
+Layer::snap_object(ObjectModelHandle object, const std::set<ObjectModelHandle>& ignore_objects) const
 {
-  //float min_x_offset = std::numeric_limits<float>::max();
-  //float min_y_offset = std::numeric_limits<float>::max();
   SnapData best_snap;
 
   // Find the smallest snap offset
@@ -202,7 +200,7 @@
     if ((*i)->is_snappable() &&
         ignore_objects.find(*i) == ignore_objects.end())
     {
-      SnapData snap = (*i)->snap_object(rect);
+      SnapData snap = object->snap_to_object((*i)->get_bounding_box());
       best_snap.merge(snap);
     }
   }

Modified: trunk/windstille/src/editor/layer.hpp
===================================================================
--- trunk/windstille/src/editor/layer.hpp	2009-09-14 22:01:29 UTC (rev 3251)
+++ trunk/windstille/src/editor/layer.hpp	2009-09-15 17:13:04 UTC (rev 3252)
@@ -80,7 +80,7 @@
   void raise(ObjectModelHandle object);
   void lower(ObjectModelHandle object);
 
-  SnapData snap_object(const Rectf& rect, const std::set<ObjectModelHandle>& ignore_objects) const;
+  SnapData snap_object(ObjectModelHandle object, const std::set<ObjectModelHandle>& ignore_objects) const;
 
   void write(FileWriter& writer) const;
 

Modified: trunk/windstille/src/editor/navgraph_edge_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-14 22:01:29 UTC (rev 3251)
+++ trunk/windstille/src/editor/navgraph_edge_object_model.hpp	2009-09-15 17:13:04 UTC (rev 3252)
@@ -45,6 +45,8 @@
   void write(FileWriter& writer) const;
   void write_real(FileWriter& writer) const;
 
+  bool is_snappable() const { return false; }
+
   boost::shared_ptr<NavGraphNodeObjectModel> get_lhs() const { return m_lhs; }
   boost::shared_ptr<NavGraphNodeObjectModel> get_rhs() const { return m_rhs; }
 

Modified: trunk/windstille/src/editor/navgraph_node_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-14 22:01:29 UTC (rev 3251)
+++ trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-15 17:13:04 UTC (rev 3252)
@@ -22,6 +22,7 @@
 #include "scenegraph/vertex_array_drawable.hpp"
 #include "scenegraph/scene_graph.hpp"
 #include "navigation/node.hpp"
+#include "editor/constants.hpp"
 
 NavGraphNodeObjectModel::NavGraphNodeObjectModel(const FileReader& reader)
   : ObjectModel(reader),
@@ -91,20 +92,20 @@
 SnapData
 NavGraphNodeObjectModel::snap_to_grid(float grid_size) const
 {
-  const float snap_threshold = 16.0f;
+  std::cout << "NavGraphNodeObjectModel:grid" << std::endl;
 
   float snap_x = float_snap_to_grid(get_world_pos().x, grid_size);
   float snap_y = float_snap_to_grid(get_world_pos().y, grid_size);
 
   SnapData snap;
 
-  if (fabs(snap_x) < snap_threshold)
+  if (fabs(snap_x) < g_snap_threshold)
     {
       snap.x_set = true;
       snap.offset.x = snap_x;
     }
 
-  if (fabs(snap_y) < snap_threshold)
+  if (fabs(snap_y) < g_snap_threshold)
     {
       snap.y_set = true;
       snap.offset.y = snap_y;
@@ -113,6 +114,47 @@
   return snap;
 }
 
+SnapData
+NavGraphNodeObjectModel::snap_to_object(const Rectf& in) const
+{
+  const Vector2f& pos = get_world_pos();
+
+  SnapData snap;
+
+  Rectf dist(in.left   - pos.x,
+             in.top    - pos.y,
+             in.right  - pos.x,
+             in.bottom - pos.y);
+
+  if (fabsf(dist.left) <= fabsf(dist.right) && 
+      fabsf(dist.left) < g_snap_threshold)
+  {
+    snap.x_set    = true;
+    snap.offset.x = dist.left;    
+  }
+  else if (fabsf(dist.left) > fabsf(dist.right) && 
+           fabsf(dist.right) < g_snap_threshold)
+  {
+    snap.x_set    = true;
+    snap.offset.x = dist.right;
+  }
+
+  if (fabsf(dist.top) <= fabsf(dist.bottom) && 
+      fabsf(dist.top) < g_snap_threshold)
+  {
+    snap.y_set    = true;
+    snap.offset.y = dist.top;    
+  }
+  else if (fabsf(dist.top) > fabsf(dist.bottom) && 
+           fabsf(dist.bottom) < g_snap_threshold)
+  {
+    snap.y_set    = true;
+    snap.offset.y = dist.bottom;
+  }
+
+  return snap;
+}
+
 ObjectModelHandle 
 NavGraphNodeObjectModel::clone() const
 {

Modified: trunk/windstille/src/editor/navgraph_node_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-14 22:01:29 UTC (rev 3251)
+++ trunk/windstille/src/editor/navgraph_node_object_model.hpp	2009-09-15 17:13:04 UTC (rev 3252)
@@ -45,6 +45,7 @@
   ObjectModelHandle clone() const;
   void write(FileWriter& writer) const;
 
+  SnapData snap_to_object(const Rectf& rect) const;
   SnapData snap_to_grid(float grid_size) const;
 
 private:

Modified: trunk/windstille/src/editor/object_model.cpp
===================================================================
--- trunk/windstille/src/editor/object_model.cpp	2009-09-14 22:01:29 UTC (rev 3251)
+++ trunk/windstille/src/editor/object_model.cpp	2009-09-15 17:13:04 UTC (rev 3252)
@@ -16,14 +16,16 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
+#include "editor/object_model.hpp"
+
 #include <iostream>
 #include <sstream>
 
+#include "display/scene_context.hpp"
+#include "display/surface_drawing_parameters.hpp"
+#include "editor/constants.hpp"
 #include "editor/editor_window.hpp"
 #include "util/file_reader.hpp"
-#include "display/surface_drawing_parameters.hpp"
-#include "display/scene_context.hpp"
-#include "editor/object_model.hpp"
 
 ObjectModel::ObjectModel(const std::string& name_, const Vector2f& rel_pos_)
   : name(name_),
@@ -196,8 +198,6 @@
 SnapData
 ObjectModel::snap_to_grid(float grid_size) const
 {
-  const float snap_threshold = 16.0f;
-
   const Rectf& r = get_bounding_box();
 
   Rectf snap_rect(float_snap_to_grid(r.left,   grid_size),
@@ -210,13 +210,13 @@
   {
     SnapData snap;
 
-    if (fabs(snap_rect.left) < snap_threshold)
+    if (fabs(snap_rect.left) < g_snap_threshold)
     {
       snap.x_set = true;
       snap.offset.x = snap_rect.left;
     }
 
-    if (fabs(snap_rect.top) < snap_threshold)
+    if (fabs(snap_rect.top) < g_snap_threshold)
     {
       snap.y_set = true;
       snap.offset.y = snap_rect.top;
@@ -228,13 +228,13 @@
   {
     SnapData snap;
 
-    if (fabs(snap_rect.right) < snap_threshold)
+    if (fabs(snap_rect.right) < g_snap_threshold)
     {
       snap.x_set = true;
       snap.offset.x = snap_rect.right;
     }
 
-    if (fabs(snap_rect.bottom) < snap_threshold)
+    if (fabs(snap_rect.bottom) < g_snap_threshold)
     {
       snap.y_set = true;
       snap.offset.y = snap_rect.bottom;
@@ -247,17 +247,15 @@
 }
 
 SnapData
-ObjectModel::snap_object(const Rectf& in) const
+ObjectModel::snap_to_object(const Rectf& in) const
 {
   const Rectf& rect = get_bounding_box();
-  float snap_threshold = 16.0f;
   
-  // Reset offset to zero, since it might not be
   SnapData snap;
 
-  float left_dist   = fabsf(rect.left - in.right);
-  float right_dist  = fabsf(rect.right - in.left);
-  float top_dist    = fabsf(rect.top - in.bottom);
+  float left_dist   = fabsf(rect.left   - in.right);
+  float right_dist  = fabsf(rect.right  - in.left);
+  float top_dist    = fabsf(rect.top    - in.bottom);
   float bottom_dist = fabsf(rect.bottom - in.top);
   float x_dist = std::min(left_dist, right_dist);
   float y_dist = std::min(top_dist, bottom_dist);
@@ -268,13 +266,13 @@
     {
       float y_snap = 0.0f;
 
-      if (fabs(rect.top - in.top) < snap_threshold)
+      if (fabs(rect.top - in.top) < g_snap_threshold)
       {
         y_snap = rect.top - in.top;
         snap.y_set = true;
       }
 
-      if (fabs(rect.bottom - in.bottom) < snap_threshold)
+      if (fabs(rect.bottom - in.bottom) < g_snap_threshold)
       {
         y_snap = rect.bottom - in.bottom;
         snap.y_set = true;
@@ -282,7 +280,7 @@
 
       if (left_dist < right_dist)
       { // snap to left edge
-        if (left_dist < snap_threshold)
+        if (left_dist < g_snap_threshold)
         {
           snap.offset.x = rect.left - in.right;
           snap.offset.y = y_snap;
@@ -291,7 +289,7 @@
       }
       else
       { // snap to right edge
-        if (right_dist < snap_threshold)
+        if (right_dist < g_snap_threshold)
         {
           snap.offset.x = rect.right - in.left;
           snap.offset.y = y_snap;
@@ -306,13 +304,13 @@
     {
       float x_snap = 0.0f;
 
-      if (fabs(rect.left - in.left) < snap_threshold)
+      if (fabs(rect.left - in.left) < g_snap_threshold)
       {
         x_snap = rect.left - in.left;
         snap.x_set = true;
       }
 
-      if (fabs(rect.right - in.right) < snap_threshold)
+      if (fabs(rect.right - in.right) < g_snap_threshold)
       {
         x_snap = rect.right - in.right;
         snap.x_set = true;
@@ -320,7 +318,7 @@
 
       if (top_dist < bottom_dist)
       { // snap to top edge
-        if (top_dist < snap_threshold)
+        if (top_dist < g_snap_threshold)
         {
           snap.offset.x = x_snap;
           snap.offset.y = rect.top - in.bottom;
@@ -329,7 +327,7 @@
       }
       else
       { // snap to bottom edge
-        if (bottom_dist < snap_threshold)
+        if (bottom_dist < g_snap_threshold)
         {
           snap.offset.x = x_snap;
           snap.offset.y = rect.bottom - in.top;
@@ -339,6 +337,8 @@
     }      
   }
 
+  snap.offset = -snap.offset;
+
   return snap;
 }
 

Modified: trunk/windstille/src/editor/object_model.hpp
===================================================================
--- trunk/windstille/src/editor/object_model.hpp	2009-09-14 22:01:29 UTC (rev 3251)
+++ trunk/windstille/src/editor/object_model.hpp	2009-09-15 17:13:04 UTC (rev 3252)
@@ -64,7 +64,7 @@
   virtual SelectMask get_select_mask() const { return select_mask; }
   virtual void   set_select_mask(const SelectMask& select_mask_) { select_mask = select_mask_; }
 
-  virtual SnapData snap_object(const Rectf& rect) const;
+  virtual SnapData snap_to_object(const Rectf& rect) const;
   virtual SnapData snap_to_grid(float grid_size) const;
 
   virtual bool get_hflip() const { return false; }

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-14 22:01:29 UTC (rev 3251)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-15 17:13:04 UTC (rev 3252)
@@ -335,7 +335,7 @@
 }
 
 SnapData
-SectorModel::snap_object(const Rectf& rect, const std::set<ObjectModelHandle>& ignore_objects) const
+SectorModel::snap_object(ObjectModelHandle object, const std::set<ObjectModelHandle>& ignore_objects) const
 {
   const Layers& layers = get_layers();
 
@@ -344,7 +344,7 @@
   {
     if ((*i)->is_visible())
     {
-      snap_data.merge((*i)->snap_object(rect, ignore_objects));
+      snap_data.merge((*i)->snap_object(object, ignore_objects));
     }
   }
 

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-14 22:01:29 UTC (rev 3251)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-15 17:13:04 UTC (rev 3252)
@@ -90,7 +90,7 @@
   void raise(ObjectModelHandle object);
   void lower(ObjectModelHandle object);
 
-  SnapData snap_object(const Rectf& object, const std::set<ObjectModelHandle>& ignore_objects) const;
+  SnapData snap_object(ObjectModelHandle object, const std::set<ObjectModelHandle>& ignore_objects) const;
 
   void write(FileWriter& writer) const;
 

Modified: trunk/windstille/src/editor/select_tool.cpp
===================================================================
--- trunk/windstille/src/editor/select_tool.cpp	2009-09-14 22:01:29 UTC (rev 3251)
+++ trunk/windstille/src/editor/select_tool.cpp	2009-09-15 17:13:04 UTC (rev 3252)
@@ -131,7 +131,7 @@
 
   for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
   {
-    SnapData snap = wst.get_document().get_sector_model().snap_object((*i)->get_bounding_box(), ignore_objects);
+    SnapData snap = wst.get_document().get_sector_model().snap_object(*i, ignore_objects);
     best_snap.merge(snap);
   }
  



From grumbel at mail.berlios.de  Tue Sep 15 22:04:45 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 15 Sep 2009 22:04:45 +0200
Subject: [Windstille-commit] r3253 - trunk/windstille/src/editor
Message-ID: <200909152004.n8FK4j8k018249@sheep.berlios.de>

Author: grumbel
Date: 2009-09-15 22:04:41 +0200 (Tue, 15 Sep 2009)
New Revision: 3253

Modified:
   trunk/windstille/src/editor/navgraph_insert_tool.cpp
Log:
Added right click cancel for edge creation

Modified: trunk/windstille/src/editor/navgraph_insert_tool.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-15 17:13:04 UTC (rev 3252)
+++ trunk/windstille/src/editor/navgraph_insert_tool.cpp	2009-09-15 20:04:41 UTC (rev 3253)
@@ -168,7 +168,7 @@
     float angle = atan2f(mouse_pos.y - last_node->get_world_pos().y,
                          mouse_pos.x - last_node->get_world_pos().x);
 
-    std::cout << angle << std::endl;
+    //std::cout << angle << std::endl;
     if (fabsf(angle) > 1.0f/4.0f * math::pi &&
         fabsf(angle) < 3.0f/4.0f * math::pi)
     {
@@ -203,30 +203,46 @@
 {
   NavigationGraphModel& navgraph = wst.get_document().get_sector_model().get_nav_graph();
 
-  boost::shared_ptr<NavGraphNodeObjectModel> node = navgraph.find_closest_node(mouse_pos, 16.0f); // FIXME: Radius should scale with zoom
-  boost::shared_ptr<NavGraphEdgeObjectModel> edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
-
-  if (node)
+  switch(mode)
   {
-    wst.get_document().navgraph_node_remove(node);
+    case EDGE_MODE:
+    {
+      mode = NO_MODE;
+      last_node.reset();
+      wst.queue_draw();
+      break;
+    }
 
-    mouse_over_edge.reset();
-    mouse_over_node.reset();
+    case NO_MODE:
+    {
+      // FIXME: Radius should scale with zoom
+      boost::shared_ptr<NavGraphNodeObjectModel> node = navgraph.find_closest_node(mouse_pos, 16.0f); 
+      boost::shared_ptr<NavGraphEdgeObjectModel> edge = navgraph.find_closest_edge(mouse_pos, 16.0f);
 
-    wst.queue_draw();
-  }
-  else if (edge)
-  {
-    wst.get_document().navgraph_edge_remove(edge);
+      if (node)
+      {
+        wst.get_document().navgraph_node_remove(node);
 
-    mouse_over_edge.reset();
-    mouse_over_node.reset();
+        mouse_over_edge.reset();
+        mouse_over_node.reset();
 
-    wst.queue_draw();
-  }
-  else
-  {
+        wst.queue_draw();
+      }
+      else if (edge)
+      {
+        wst.get_document().navgraph_edge_remove(edge);
+
+        mouse_over_edge.reset();
+        mouse_over_node.reset();
+
+        wst.queue_draw();
+      }
+      else
+      {
       
+      }
+      break;
+    }
   }
 }
   



From grumbel at mail.berlios.de  Tue Sep 15 22:05:10 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 15 Sep 2009 22:05:10 +0200
Subject: [Windstille-commit] r3254 - trunk/windstille/src/editor
Message-ID: <200909152005.n8FK5Ap0018348@sheep.berlios.de>

Author: grumbel
Date: 2009-09-15 22:05:08 +0200 (Tue, 15 Sep 2009)
New Revision: 3254

Added:
   trunk/windstille/src/editor/constants.cpp
   trunk/windstille/src/editor/constants.hpp
Log:
Moved constants into separate file

Added: trunk/windstille/src/editor/constants.cpp
===================================================================
--- trunk/windstille/src/editor/constants.cpp	2009-09-15 20:04:41 UTC (rev 3253)
+++ trunk/windstille/src/editor/constants.cpp	2009-09-15 20:05:08 UTC (rev 3254)
@@ -0,0 +1,23 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "constants.hpp"
+
+const float g_snap_threshold = 16.0f;
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/constants.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/constants.hpp
===================================================================
--- trunk/windstille/src/editor/constants.hpp	2009-09-15 20:04:41 UTC (rev 3253)
+++ trunk/windstille/src/editor/constants.hpp	2009-09-15 20:05:08 UTC (rev 3254)
@@ -0,0 +1,26 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_EDITOR_CONSTANTS_HPP
+#define HEADER_WINDSTILLE_EDITOR_CONSTANTS_HPP
+
+extern const float g_snap_threshold;
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/constants.hpp
___________________________________________________________________
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Tue Sep 15 22:05:46 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 15 Sep 2009 22:05:46 +0200
Subject: [Windstille-commit] r3255 - trunk/windstille/src/editor
Message-ID: <200909152005.n8FK5k5Z018442@sheep.berlios.de>

Author: grumbel
Date: 2009-09-15 22:05:44 +0200 (Tue, 15 Sep 2009)
New Revision: 3255

Modified:
   trunk/windstille/src/editor/navgraph_node_object_model.cpp
   trunk/windstille/src/editor/object_model.cpp
   trunk/windstille/src/editor/snap_data.hpp
Log:
Cleanupd up snapping code a bit

Modified: trunk/windstille/src/editor/navgraph_node_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-15 20:05:08 UTC (rev 3254)
+++ trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-15 20:05:44 UTC (rev 3255)
@@ -92,8 +92,6 @@
 SnapData
 NavGraphNodeObjectModel::snap_to_grid(float grid_size) const
 {
-  std::cout << "NavGraphNodeObjectModel:grid" << std::endl;
-
   float snap_x = float_snap_to_grid(get_world_pos().x, grid_size);
   float snap_y = float_snap_to_grid(get_world_pos().y, grid_size);
 
@@ -101,14 +99,12 @@
 
   if (fabs(snap_x) < g_snap_threshold)
     {
-      snap.x_set = true;
-      snap.offset.x = snap_x;
+      snap.set_x(snap_x);
     }
 
   if (fabs(snap_y) < g_snap_threshold)
     {
-      snap.y_set = true;
-      snap.offset.y = snap_y;
+      snap.set_y(snap_y);
     }
 
   return snap;
@@ -129,27 +125,23 @@
   if (fabsf(dist.left) <= fabsf(dist.right) && 
       fabsf(dist.left) < g_snap_threshold)
   {
-    snap.x_set    = true;
-    snap.offset.x = dist.left;    
+    snap.set_x(dist.left);
   }
   else if (fabsf(dist.left) > fabsf(dist.right) && 
            fabsf(dist.right) < g_snap_threshold)
   {
-    snap.x_set    = true;
-    snap.offset.x = dist.right;
+    snap.set_x(dist.right);
   }
 
   if (fabsf(dist.top) <= fabsf(dist.bottom) && 
       fabsf(dist.top) < g_snap_threshold)
   {
-    snap.y_set    = true;
-    snap.offset.y = dist.top;    
+    snap.set_y(dist.top);
   }
   else if (fabsf(dist.top) > fabsf(dist.bottom) && 
            fabsf(dist.bottom) < g_snap_threshold)
   {
-    snap.y_set    = true;
-    snap.offset.y = dist.bottom;
+    snap.set_y(dist.bottom);
   }
 
   return snap;

Modified: trunk/windstille/src/editor/object_model.cpp
===================================================================
--- trunk/windstille/src/editor/object_model.cpp	2009-09-15 20:05:08 UTC (rev 3254)
+++ trunk/windstille/src/editor/object_model.cpp	2009-09-15 20:05:44 UTC (rev 3255)
@@ -212,14 +212,12 @@
 
     if (fabs(snap_rect.left) < g_snap_threshold)
     {
-      snap.x_set = true;
-      snap.offset.x = snap_rect.left;
+      snap.set_x(snap_rect.left);
     }
 
     if (fabs(snap_rect.top) < g_snap_threshold)
     {
-      snap.y_set = true;
-      snap.offset.y = snap_rect.top;
+      snap.set_y(snap_rect.top);
     }
       
     best_snap.merge(snap);
@@ -230,14 +228,12 @@
 
     if (fabs(snap_rect.right) < g_snap_threshold)
     {
-      snap.x_set = true;
-      snap.offset.x = snap_rect.right;
+      snap.set_x(snap_rect.right);
     }
 
     if (fabs(snap_rect.bottom) < g_snap_threshold)
     {
-      snap.y_set = true;
-      snap.offset.y = snap_rect.bottom;
+      snap.set_y(snap_rect.bottom);
     }
       
     best_snap.merge(snap);
@@ -266,13 +262,13 @@
     {
       float y_snap = 0.0f;
 
-      if (fabs(rect.top - in.top) < g_snap_threshold)
+      if (fabsf(rect.top - in.top) < g_snap_threshold)
       {
         y_snap = rect.top - in.top;
         snap.y_set = true;
       }
 
-      if (fabs(rect.bottom - in.bottom) < g_snap_threshold)
+      if (fabsf(rect.bottom - in.bottom) < g_snap_threshold)
       {
         y_snap = rect.bottom - in.bottom;
         snap.y_set = true;
@@ -282,18 +278,16 @@
       { // snap to left edge
         if (left_dist < g_snap_threshold)
         {
-          snap.offset.x = rect.left - in.right;
+          snap.set_x(rect.left - in.right);
           snap.offset.y = y_snap;
-          snap.x_set = true;
         }
       }
       else
       { // snap to right edge
         if (right_dist < g_snap_threshold)
         {
-          snap.offset.x = rect.right - in.left;
+          snap.set_x(rect.right - in.left);
           snap.offset.y = y_snap;
-          snap.x_set = true;
         }
       }
     }
@@ -304,13 +298,13 @@
     {
       float x_snap = 0.0f;
 
-      if (fabs(rect.left - in.left) < g_snap_threshold)
+      if (fabsf(rect.left - in.left) < g_snap_threshold)
       {
         x_snap = rect.left - in.left;
         snap.x_set = true;
       }
 
-      if (fabs(rect.right - in.right) < g_snap_threshold)
+      if (fabsf(rect.right - in.right) < g_snap_threshold)
       {
         x_snap = rect.right - in.right;
         snap.x_set = true;
@@ -321,8 +315,8 @@
         if (top_dist < g_snap_threshold)
         {
           snap.offset.x = x_snap;
-          snap.offset.y = rect.top - in.bottom;
-          snap.y_set = true;
+          
+          snap.set_y(rect.top - in.bottom);
         }
       }
       else
@@ -330,8 +324,7 @@
         if (bottom_dist < g_snap_threshold)
         {
           snap.offset.x = x_snap;
-          snap.offset.y = rect.bottom - in.top;
-          snap.y_set = true;
+          snap.set_y(rect.bottom - in.top);
         }
       }
     }      

Modified: trunk/windstille/src/editor/snap_data.hpp
===================================================================
--- trunk/windstille/src/editor/snap_data.hpp	2009-09-15 20:05:08 UTC (rev 3254)
+++ trunk/windstille/src/editor/snap_data.hpp	2009-09-15 20:05:44 UTC (rev 3255)
@@ -19,19 +19,38 @@
 #ifndef HEADER_WINDSTILLE_EDITOR_SNAP_DATA_HPP
 #define HEADER_WINDSTILLE_EDITOR_SNAP_DATA_HPP
 
+/**
+ *  SnapData contains the offset that an object has to be moved by to
+ *  'snap' to a neighbouring object or the grid. SnapData can be
+ *  merged with other SnapData objects so that only the closest 'snap'
+ *  propogates.
+ */
 class SnapData
 {
 public:
   Vector2f offset;
   bool x_set;
   bool y_set;
-  
+
+public:  
   SnapData() 
     : offset(0, 0),
       x_set(false),
       y_set(false)
   {}
   
+  void set_x(float x)
+  {
+    x_set    = true;
+    offset.x = x;
+  }
+
+  void set_y(float y)
+  {
+    y_set    = true;
+    offset.y = y;
+  }
+
   void merge(const SnapData& rhs) 
   {
     if (((x_set && rhs.x_set) && (rhs.offset.x < offset.x)) ||



From grumbel at mail.berlios.de  Tue Sep 15 22:13:15 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 15 Sep 2009 22:13:15 +0200
Subject: [Windstille-commit] r3256 - trunk/windstille/src/editor
Message-ID: <200909152013.n8FKDF9G019011@sheep.berlios.de>

Author: grumbel
Date: 2009-09-15 22:13:13 +0200 (Tue, 15 Sep 2009)
New Revision: 3256

Modified:
   trunk/windstille/src/editor/navgraph_node_object_model.cpp
Log:
Only snap when we are close to the object

Modified: trunk/windstille/src/editor/navgraph_node_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-15 20:05:44 UTC (rev 3255)
+++ trunk/windstille/src/editor/navgraph_node_object_model.cpp	2009-09-15 20:13:13 UTC (rev 3256)
@@ -122,27 +122,35 @@
              in.right  - pos.x,
              in.bottom - pos.y);
 
-  if (fabsf(dist.left) <= fabsf(dist.right) && 
-      fabsf(dist.left) < g_snap_threshold)
+  if (pos.y > in.top - g_snap_threshold &&
+      pos.y < in.bottom + g_snap_threshold)
   {
-    snap.set_x(dist.left);
+    if (fabsf(dist.left) <= fabsf(dist.right) && 
+        fabsf(dist.left) < g_snap_threshold)
+    {
+      snap.set_x(dist.left);
+    }
+    else if (fabsf(dist.left) > fabsf(dist.right) && 
+             fabsf(dist.right) < g_snap_threshold)
+    {
+      snap.set_x(dist.right);
+    }
   }
-  else if (fabsf(dist.left) > fabsf(dist.right) && 
-           fabsf(dist.right) < g_snap_threshold)
-  {
-    snap.set_x(dist.right);
-  }
 
-  if (fabsf(dist.top) <= fabsf(dist.bottom) && 
-      fabsf(dist.top) < g_snap_threshold)
+  if (pos.x > in.left  - g_snap_threshold &&
+      pos.x < in.right + g_snap_threshold)
   {
-    snap.set_y(dist.top);
+    if (fabsf(dist.top) <= fabsf(dist.bottom) && 
+        fabsf(dist.top) < g_snap_threshold)
+    {
+      snap.set_y(dist.top);
+    }
+    else if (fabsf(dist.top) > fabsf(dist.bottom) && 
+             fabsf(dist.bottom) < g_snap_threshold)
+    {
+      snap.set_y(dist.bottom);
+    }
   }
-  else if (fabsf(dist.top) > fabsf(dist.bottom) && 
-           fabsf(dist.bottom) < g_snap_threshold)
-  {
-    snap.set_y(dist.bottom);
-  }
 
   return snap;
 }



From grumbel at mail.berlios.de  Wed Sep 16 16:03:30 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 16 Sep 2009 16:03:30 +0200
Subject: [Windstille-commit] r3257 - in trunk/windstille/src: editor engine
	objects
Message-ID: <200909161403.n8GE3UDp024807@sheep.berlios.de>

Author: grumbel
Date: 2009-09-16 16:03:26 +0200 (Wed, 16 Sep 2009)
New Revision: 3257

Added:
   trunk/windstille/src/engine/game_object_handle.hpp
   trunk/windstille/src/engine/object_factory.cpp
   trunk/windstille/src/engine/object_factory.hpp
Modified:
   trunk/windstille/src/editor/selection.cpp
   trunk/windstille/src/engine/game_object.hpp
   trunk/windstille/src/engine/sector.cpp
   trunk/windstille/src/engine/sector.hpp
   trunk/windstille/src/engine/sector_builder.cpp
   trunk/windstille/src/engine/sector_builder.hpp
   trunk/windstille/src/objects/player.cpp
Log:
Added factory class for GameObject creation, make more use of shared_ptr via GameObjectHandle

Modified: trunk/windstille/src/editor/selection.cpp
===================================================================
--- trunk/windstille/src/editor/selection.cpp	2009-09-15 20:13:13 UTC (rev 3256)
+++ trunk/windstille/src/editor/selection.cpp	2009-09-16 14:03:26 UTC (rev 3257)
@@ -39,8 +39,15 @@
 void
 Selection::add(const ObjectModelHandle& object)
 {
-  objects.push_back(object);
-  signal_changed();
+  if (!object)
+  {
+    std::cout << "Error: Selection:add(): trying to add NULL pointer" << std::endl;
+  }
+  else
+  {
+    objects.push_back(object);
+    signal_changed();
+  }
 }
 
 void

Modified: trunk/windstille/src/engine/game_object.hpp
===================================================================
--- trunk/windstille/src/engine/game_object.hpp	2009-09-15 20:13:13 UTC (rev 3256)
+++ trunk/windstille/src/engine/game_object.hpp	2009-09-16 14:03:26 UTC (rev 3257)
@@ -21,8 +21,9 @@
 
 #include <string>
 
+#include "display/scene_context.hpp"
+#include "engine/game_object_handle.hpp"
 #include "util/file_reader.hpp"
-#include "display/scene_context.hpp"
 
 class Sector;
 
@@ -104,7 +105,7 @@
    */
   virtual void update (float delta) {}
     
-  virtual void set_parent(GameObject* parent) {}
+  virtual void set_parent(GameObjectHandle parent) {}
 
 private:
   GameObject (const GameObject&);

Added: trunk/windstille/src/engine/game_object_handle.hpp
===================================================================
--- trunk/windstille/src/engine/game_object_handle.hpp	2009-09-15 20:13:13 UTC (rev 3256)
+++ trunk/windstille/src/engine/game_object_handle.hpp	2009-09-16 14:03:26 UTC (rev 3257)
@@ -0,0 +1,30 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_ENGINE_GAME_OBJECT_HANDLE_HPP
+#define HEADER_WINDSTILLE_ENGINE_GAME_OBJECT_HANDLE_HPP
+
+#include <boost/shared_ptr.hpp>
+
+class GameObject;
+
+typedef boost::shared_ptr<GameObject> GameObjectHandle;
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/engine/game_object_handle.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/engine/object_factory.cpp
===================================================================
--- trunk/windstille/src/engine/object_factory.cpp	2009-09-15 20:13:13 UTC (rev 3256)
+++ trunk/windstille/src/engine/object_factory.cpp	2009-09-16 14:03:26 UTC (rev 3257)
@@ -0,0 +1,123 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "engine/object_factory.hpp"
+
+#include "objects/background_gradient.hpp"
+#include "objects/box.hpp"
+#include "objects/character.hpp"
+#include "objects/decal.hpp"
+#include "objects/doll.hpp"
+#include "objects/elevator.hpp"
+#include "objects/hedgehog.hpp"
+#include "objects/laser_pointer.hpp"
+#include "objects/layer.hpp"
+#include "objects/liquid.hpp"
+#include "objects/nightvision.hpp"
+#include "objects/particle_systems.hpp"
+#include "objects/scriptable_object.hpp"
+#include "objects/shockwave.hpp"
+#include "objects/spider_mine.hpp"
+#include "objects/swarm.hpp"
+#include "objects/test_object.hpp"
+#include "objects/trigger.hpp"
+#include "objects/vrdummy.hpp"
+
+GameObjectHandle
+ObjectFactory::create(const FileReader& reader)
+{
+  if (reader.get_name() == "background-gradient")
+  {
+    return GameObjectHandle(new BackgroundGradient(reader));
+  }
+  else if(reader.get_name() == "trigger")
+  {
+    return GameObjectHandle(new Trigger(reader));
+  }
+  else if(reader.get_name() == "box")
+  {
+    return GameObjectHandle(new Box(reader));
+  }
+  else if(reader.get_name() == "shockwave")
+  {
+    return GameObjectHandle(new Shockwave(reader));
+  }
+  else if(reader.get_name() == "elevator")
+  {
+    return GameObjectHandle(new Elevator(reader));
+  }
+  else if(reader.get_name() == "character")
+  {    
+    return GameObjectHandle(new Character(reader));
+  }
+  else if(reader.get_name() == "spider-mine")
+  {
+    return GameObjectHandle(new SpiderMine(reader));
+  }
+  else if(reader.get_name() == "hedgehog")
+  {
+    return GameObjectHandle(new Hedgehog(reader));
+  }
+  else if(reader.get_name() == "test-object")
+  {
+    return GameObjectHandle(new TestObject(reader));
+  }
+  else if (reader.get_name() == "nightvision")
+  {
+    return GameObjectHandle(new Nightvision(reader));
+  }
+  else if (reader.get_name() == "particle-system")
+  {
+    // FIXME: disabled due to work on the editor: return GameObjectHandle(new ParticleSystem(reader));
+    return GameObjectHandle();
+  }
+  else if(reader.get_name() == "scriptable-object")
+  {    
+    return GameObjectHandle(new ScriptableObject(reader));
+  }
+  else if(reader.get_name() == "decal")
+  {    
+    return GameObjectHandle(new Decal(reader));
+  }
+  else if (reader.get_name() == "vrdummy")
+  {
+    return GameObjectHandle(new VRDummy(reader));
+  }
+  else if (reader.get_name() == "swarm")
+  {
+    return GameObjectHandle(new Swarm(reader));
+  }
+  else if (reader.get_name() == "laserpointer")
+  {
+    return GameObjectHandle(new LaserPointer());
+  }
+  else if (reader.get_name() == "liquid")
+  {
+    return GameObjectHandle(new Liquid(reader));
+  }
+  else if (reader.get_name() == "particle-systems")
+  {
+    return GameObjectHandle(new ParticleSystems(reader));
+  }
+  else
+  {
+    return GameObjectHandle();
+  }
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/engine/object_factory.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/engine/object_factory.hpp
===================================================================
--- trunk/windstille/src/engine/object_factory.hpp	2009-09-15 20:13:13 UTC (rev 3256)
+++ trunk/windstille/src/engine/object_factory.hpp	2009-09-16 14:03:26 UTC (rev 3257)
@@ -0,0 +1,39 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_ENGINE_OBJECT_FACTORY_HPP
+#define HEADER_WINDSTILLE_ENGINE_OBJECT_FACTORY_HPP
+
+#include "engine/game_object_handle.hpp"
+
+class FileReader;
+
+class ObjectFactory
+{
+private:
+public:
+  static GameObjectHandle create(const FileReader& reader);
+
+private:
+  ObjectFactory(const ObjectFactory&);
+  ObjectFactory& operator=(const ObjectFactory&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/engine/object_factory.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/engine/sector.cpp
===================================================================
--- trunk/windstille/src/engine/sector.cpp	2009-09-15 20:13:13 UTC (rev 3256)
+++ trunk/windstille/src/engine/sector.cpp	2009-09-16 14:03:26 UTC (rev 3257)
@@ -21,34 +21,15 @@
 #include <sstream>
 
 #include "collision/collision_engine.hpp"
-#include "engine/squirrel_thread.hpp"
 #include "engine/sector_builder.hpp"
+#include "engine/squirrel_thread.hpp"
 #include "navigation/navigation_graph.hpp"
+#include "objects/doll.hpp"
+#include "objects/player.hpp"
 #include "scenegraph/navigation_graph_drawable.hpp"
 #include "scenegraph/scene_graph.hpp"
 #include "sound/sound_manager.hpp"
 #include "tile/tile_map.hpp"
-
-#include "objects/background_gradient.hpp"
-#include "objects/box.hpp"
-#include "objects/character.hpp"
-#include "objects/decal.hpp"
-#include "objects/doll.hpp"
-#include "objects/elevator.hpp"
-#include "objects/hedgehog.hpp"
-#include "objects/laser_pointer.hpp"
-#include "objects/layer.hpp"
-#include "objects/liquid.hpp"
-#include "objects/nightvision.hpp"
-#include "objects/particle_systems.hpp"
-#include "objects/player.hpp"
-#include "objects/scriptable_object.hpp"
-#include "objects/shockwave.hpp"
-#include "objects/spider_mine.hpp"
-#include "objects/swarm.hpp"
-#include "objects/test_object.hpp"
-#include "objects/trigger.hpp"
-#include "objects/vrdummy.hpp"
 
 Sector::Sector(const Pathname& arg_filename)
   : collision_engine(new CollisionEngine()),
@@ -64,7 +45,7 @@
     ambient_light(),
     interactive_tilemap(0),
     interactivebackground_tilemap(0),
-    player(0)
+    player()
 {
   if (debug) std::cout << "Creating new Sector" << std::endl;
   
@@ -76,13 +57,13 @@
     collision_engine->add(new CollisionObject(interactive_tilemap));
 
     // Spawn the Player
-    player = new Player();
+    player.reset(new Player());
     player->set_pos(Vector2f(300,200));
     add(player);
   }
   else
   {
-    doll = new Doll();
+    doll.reset(new Doll());
     add(doll);
   }
 
@@ -172,9 +153,9 @@
 }
 
 void
-Sector::add(GameObject* obj)
+Sector::add(GameObjectHandle obj)
 {
-  new_objects.push_back(boost::shared_ptr<GameObject>(obj));
+  new_objects.push_back(obj);
 
   if(obj->get_name() != "") 
     {

Modified: trunk/windstille/src/engine/sector.hpp
===================================================================
--- trunk/windstille/src/engine/sector.hpp	2009-09-15 20:13:13 UTC (rev 3256)
+++ trunk/windstille/src/engine/sector.hpp	2009-09-16 14:03:26 UTC (rev 3257)
@@ -24,9 +24,10 @@
 #include <boost/shared_ptr.hpp>
 #include <boost/scoped_ptr.hpp>
 
+#include "display/color.hpp"
+#include "engine/game_object_handle.hpp"
+#include "util/currenton.hpp"
 #include "util/pathname.hpp"
-#include "util/currenton.hpp"
-#include "display/color.hpp"
 
 class CollisionEngine;
 class Entity;
@@ -69,8 +70,8 @@
   TileMap* interactivebackground_tilemap;
 
 private:
-  Player* player;
-  Doll*   doll;
+  boost::shared_ptr<Player> player;
+  boost::shared_ptr<Doll>   doll;
 
 private:
   void parse_file(const Pathname& filename);
@@ -103,7 +104,7 @@
   void  set_ambient_light(const Color& color);
   Color get_ambient_light() const;
 
-  void add(GameObject*);
+  void add(GameObjectHandle object);
 
   CollisionEngine* get_collision_engine() const { return collision_engine.get(); }
   SceneGraph& get_scene_graph() const { return *scene_graph; }

Modified: trunk/windstille/src/engine/sector_builder.cpp
===================================================================
--- trunk/windstille/src/engine/sector_builder.cpp	2009-09-15 20:13:13 UTC (rev 3256)
+++ trunk/windstille/src/engine/sector_builder.cpp	2009-09-16 14:03:26 UTC (rev 3257)
@@ -26,32 +26,12 @@
 #include "app/globals.hpp"
 #include "display/color.hpp"
 #include "engine/game_object.hpp"
+#include "engine/object_factory.hpp"
 #include "engine/sector.hpp"
 #include "navigation/navigation_graph.hpp"
 #include "tile/tile_map.hpp"
 #include "util/file_reader.hpp"
 
-#include "objects/background_gradient.hpp"
-#include "objects/box.hpp"
-#include "objects/character.hpp"
-#include "objects/decal.hpp"
-#include "objects/doll.hpp"
-#include "objects/elevator.hpp"
-#include "objects/hedgehog.hpp"
-#include "objects/laser_pointer.hpp"
-#include "objects/layer.hpp"
-#include "objects/liquid.hpp"
-#include "objects/nightvision.hpp"
-#include "objects/particle_systems.hpp"
-#include "objects/player.hpp"
-#include "objects/scriptable_object.hpp"
-#include "objects/shockwave.hpp"
-#include "objects/spider_mine.hpp"
-#include "objects/swarm.hpp"
-#include "objects/test_object.hpp"
-#include "objects/trigger.hpp"
-#include "objects/vrdummy.hpp"
-
 SectorBuilder::SectorBuilder(const Pathname& filename, Sector& sector)
   : m_filename(filename),
     m_sector(sector),
@@ -140,9 +120,9 @@
     }
 
     // Set the parents properly
-    for(std::map<GameObject*, std::string>::iterator i = parent_table.begin(); i != parent_table.end(); ++i)
+    for(std::map<GameObjectHandle, std::string>::iterator i = parent_table.begin(); i != parent_table.end(); ++i)
     {
-      std::map<std::string, GameObject*>::iterator j = id_table.find(i->second);
+      std::map<std::string, GameObjectHandle>::iterator j = id_table.find(i->second);
       if (j == id_table.end())
       {
         std::cout << "Error: Couldn't resolve 'id': " << i->second << std::endl;
@@ -158,8 +138,9 @@
 void
 SectorBuilder::parse_object(const FileReader& reader)
 {
-  GameObject* obj = 0;
-  if(reader.get_name() == "tilemap") 
+  GameObjectHandle obj;
+
+  if(reader.get_name() == "tilemap")
   {
     std::auto_ptr<TileMap> tilemap(new TileMap(reader));
 
@@ -168,7 +149,7 @@
     else if (tilemap->get_name() == "interactivebackground")
       m_sector.interactivebackground_tilemap = tilemap.get();
 
-    obj = tilemap.release();
+    obj.reset(tilemap.release());
   }
   else if (reader.get_name() == "navgraph-edge-ref")
   {
@@ -178,85 +159,17 @@
   {
     // TODO
   }
-  else if (reader.get_name() == "background-gradient")
-  {
-    obj = new BackgroundGradient(reader);
-  }
-  else if(reader.get_name() == "trigger")
-  {
-    obj = new Trigger(reader);
-  }
-  else if(reader.get_name() == "box")
-  {
-    obj = new Box(reader);
-  }
-  else if(reader.get_name() == "shockwave")
-  {
-    obj = new Shockwave(reader);
-  }
-  else if(reader.get_name() == "elevator")
-  {
-    obj = new Elevator(reader);
-  }
-  else if(reader.get_name() == "character")
-  {    
-    obj = new Character(reader);
-  }
-  else if(reader.get_name() == "spider-mine")
-  {
-    obj = new SpiderMine(reader);
-  }
-  else if(reader.get_name() == "hedgehog")
-  {
-    obj = new Hedgehog(reader);
-  }
-  else if(reader.get_name() == "test-object")
-  {
-    obj = new TestObject(reader);
-  }
-  else if (reader.get_name() == "nightvision")
-  {
-    obj = new Nightvision(reader);
-  }
-  else if (reader.get_name() == "particle-system")
-  {
-    // FIXME: disabled due to work on the editor: obj = new ParticleSystem(reader);
-  }
-  else if(reader.get_name() == "scriptable-object")
-  {    
-    obj = new ScriptableObject(reader);
-  }
-  else if(reader.get_name() == "decal")
-  {    
-    obj = new Decal(reader);
-  }
   else if(reader.get_name() == "layer")
   {    
     parse_layer(reader);
   }
-  else if (reader.get_name() == "vrdummy")
-  {
-    obj = new VRDummy(reader);
-  }
-  else if (reader.get_name() == "swarm")
-  {
-    obj = new Swarm(reader);
-  }
-  else if (reader.get_name() == "laserpointer")
-  {
-    obj = new LaserPointer();
-  }
-  else if (reader.get_name() == "liquid")
-  {
-    obj = new Liquid(reader);
-  }
-  else if (reader.get_name() == "particle-systems")
-  {
-    obj = new ParticleSystems(reader);
-  }
   else 
   {
-    std::cout << "Skipping unknown Object: " << reader.get_name() << "\n";
+    obj = ObjectFactory::create(reader);
+    if (!obj)
+    {
+      std::cout << "Skipping unknown Object: " << reader.get_name() << "\n";
+    }
   }
 
   if (obj)

Modified: trunk/windstille/src/engine/sector_builder.hpp
===================================================================
--- trunk/windstille/src/engine/sector_builder.hpp	2009-09-15 20:13:13 UTC (rev 3256)
+++ trunk/windstille/src/engine/sector_builder.hpp	2009-09-16 14:03:26 UTC (rev 3257)
@@ -22,6 +22,8 @@
 #include <map>
 #include <string>
 
+#include "engine/game_object_handle.hpp"
+
 class FileReader;
 class GameObject;
 class Pathname;
@@ -32,8 +34,8 @@
 private:
   const Pathname& m_filename;
   Sector&  m_sector;
-  std::map<std::string, GameObject*> id_table;
-  std::map<GameObject*, std::string> parent_table;
+  std::map<std::string, GameObjectHandle> id_table;
+  std::map<GameObjectHandle, std::string> parent_table;
 
 public:
   SectorBuilder(const Pathname& filename, Sector& sector);

Modified: trunk/windstille/src/objects/player.cpp
===================================================================
--- trunk/windstille/src/objects/player.cpp	2009-09-15 20:13:13 UTC (rev 3256)
+++ trunk/windstille/src/objects/player.cpp	2009-09-16 14:03:26 UTC (rev 3257)
@@ -384,7 +384,7 @@
       if (0)
         {
           // TODO remove me later, just here for testing
-          Grenade* grenade = new Grenade();
+          boost::shared_ptr<Grenade> grenade(new Grenade());
           grenade->set_pos(get_pos() + Vector2f(50, -300));
           grenade->set_velocity(Vector2f(20, -10));
           Sector::current()->add(grenade);



From grumbel at mail.berlios.de  Wed Sep 16 19:26:37 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 16 Sep 2009 19:26:37 +0200
Subject: [Windstille-commit] r3258 - trunk/windstille
Message-ID: <200909161726.n8GHQbAa008989@sheep.berlios.de>

Author: grumbel
Date: 2009-09-16 19:26:25 +0200 (Wed, 16 Sep 2009)
New Revision: 3258

Modified:
   trunk/windstille/TODO
Log:
TODO updates

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2009-09-16 14:03:26 UTC (rev 3257)
+++ trunk/windstille/TODO	2009-09-16 17:26:25 UTC (rev 3258)
@@ -25,7 +25,7 @@
 
 * draw NavGraph lines thicker (i.e. glLineWidth())
 
-* color code them by layer
+* color code them by layer (how to figure out the color?)
 
 * add special drawing for different edge types (i.e. draw stairs for stair type edges)
 
@@ -33,6 +33,30 @@
 
 * moving a NavGraphNodeModel snaps the bounding box to the grid, while
   it should snap the center point
+
+* horizontal/vertical navgraph edges are near impossible to select
+  (bounding box is just 1px height)
+
+* objects can't snap to NavGraphNode's as they are not part of the
+  normal layer structure, would also need inverse point-snapping to
+  work properly, as they shouldn't snap to the bounding_box of the node
+
+* implement a stop-watch HUD element
+
+* it takes 25sec to run through every corner of the worker.wst map (75 meter + stairs in size)
+
+* add auto-visible button similar to auto-lock button
+
+#0  0x081115a7 in Vector2f::operator+ (this=0x0, other=@0xbff04558) at src/math/vector2f.hpp:56
+#1  0x0816e342 in Selection::on_move_update (this=0x92043b8, offset=@0xbff04558) at src/editor/selection.cpp:130
+#2  0x0816c80f in SelectTool::mouse_up (this=0x8999dd0, event=0x8f878a0, wst=@0x8f8e5a0) at src/editor/select_tool.cpp:205
+#3  0x08174a22 in WindstilleWidget::mouse_up (this=0x8f8e5a0, ev=0x8f878a0) at src/editor/windstille_widget.cpp:372
+#4  0x08177788 in sigc::bound_mem_functor1<bool, WindstilleWidget, _GdkEventButton*>::operator() (this=0x902fc34, _A_a1=@0xbff04664) at /usr/include/sigc++-2.0/sigc++/functors/mem_fun.h:1851
+#5  0x081772bf in sigc::adaptor_functor<sigc::bound_mem_functor1<bool, WindstilleWidget, _GdkEventButton*> >::operator()<_GdkEventButton* const&> (this=0x902fc30, _A_arg1=@0xbff04664)
+
+* add a GenericObjectModel to the editor that just stores all the
+  information in the FileReader and writes it out again, use it for
+  all objects whose type isn't known by the editor
 
 SceneGraph/Compositor
 =====================
@@ -43,8 +67,24 @@
   * http://www.opengl.org/registry/specs/ARB/occlusion_query.txt
   * http://developer.download.nvidia.com/SDK/9.5/Samples/DEMOS/OpenGL/occlusion_query.zip
 
+  Have to figure if this would work with alpha textures:
+
+  * void glAlphaFunc(GLenum func, GLclampf ref);
+
 * add support for multipass rendering with shader scripts (to simulate
   glass and things like that)
+
+* play around with post-processing effects:
+
+  * bloom
+
+  * vignetting
+
+  * motion blur
+
+  * film grain
+
+  * lense flare
 
 Overview
 ========
@@ -72,6 +112,11 @@
   * calculate an arc from the current pos to the next ledge or landing spot
 
   * let character travel that arc
+
+* implement a grid display in the game engine
+
+* implement debugging information that shows the screen and world
+  coordinates of the mouse position in the game and in the editor
 
 Animation
 =========
@@ -110,6 +155,18 @@
   as: color, alpha, visibility (would be mainly useful for the editor
   to hide layers or highlight them)
 
+  * requires Nodes with state
+
+  * requires a pointer to the parent (boost::weak_ref)
+
+  * parent nodes should be a different type 'GroupNode' or something
+    like that
+
+  * draw() { set_color(color * parent->get_color()); }
+
+  * all nodes have a parent (the SceneGraph becomes one or gets a root
+    node)
+
 * SceneGraph could be used to promote rotation and scaling to children
 
 Navigation Graph
@@ -171,12 +228,15 @@
 Particle System
 ===============
 
+* add collision detection or bounding boxes to particle systems so
+  that smoke doesn't escape through walls
+
 * ParticleSystem could be hooked up to scripting
 
 * particle system doesn't take delta into proper account, breaks when
   doing set_game_speed(0.1) (might be issue with game_speed, not the ParticleSystem)
 
-* add a alpha ease-in to the particle system
+* add a alpha ease-in to the particle system to make better fire system
 
 * add a switch to turn of blending in the SurfaceDrawer (i.e.
   currently stuff fades out, but for some things that isn't a good
@@ -187,6 +247,9 @@
 * maybe do snow as fullscreen effect by just shifting the UV
   coordinates (wouldn't work for smoke/fog)
 
+* the particle system doesn't init correctly, causes particles to be
+  in the wrong spot on startup
+
 
 Scripting
 =========
@@ -267,8 +330,6 @@
 * ScriptableObject is a bad name, since all objects should be
   scriptable in one form or another
 
-* implement more advanced tab-completion for console
-
 * miniswig does not support __suspend with a return value, should be
   fixed, since Squirrel can handle it. Trouble is that the return
   value is created by the sq_wakeupvm() call, not by the
@@ -308,8 +369,6 @@
 * conversations really should be data with hooks for scripts, not pure
   scripts (FIXME: not clear if there is enough benefit and flexibilty
   to try that)
-
-* print and println behave different on console (?)
 
 Input Handling
 ==============
@@ -423,10 +482,6 @@
         yada yada yada yada yada yada yada yada yada yada
         yada yada yada"
 
-* add Ctrl-a, Ctrl-k shortcuts to console
-
-* save command history of the console between runs
-
 * cleanup the parenting code
 
 * why does src/navigation/node.hpp use SegmentPosition? Doesn't seem
@@ -465,12 +520,6 @@
 
 * scrap inventory and redesign it
 
-* console doesn't adopt to screen size
-
-* create a UTF32 string class for use in console, basically
-  basic_string<uint32_t> and a convert function to UTF-8 should be
-  enough
-
 * join Player and Character somewhat or derive one from the other, so
   that one can have scripted people running and jumping around
 
@@ -664,6 +713,24 @@
 * setting glLineWidth() leads to some interesting artefacts on the
   menus which might be a cool effect
 
+Console
+=======
+
+* add Ctrl-a, Ctrl-k shortcuts to console
+
+* save command history of the console between runs
+
+* console doesn't adopt to screen size (make it not fullscreen
+  covering)
+
+* create a UTF32 string class for use in console, basically
+  basic_string<uint32_t> and a convert function to UTF-8 should be
+  enough
+
+* implement more advanced tab-completion for console
+
+* print and println behave different on console (?)
+
 Editor
 ======
 
@@ -1025,7 +1092,12 @@
 Sound Effects
 =============
 
-* sound of a large power switch being toggled
+* sound of a large power switch being toggled to start a generator
+
+* sound of a metalic locker being opened
+
+* sound of a lightswitch being toggled
+
 
 http://orange.blender.org/blog/the-amazing-incredible-monkey-brush#more-49
 Hypatia



From grumbel at mail.berlios.de  Wed Sep 16 19:27:55 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 16 Sep 2009 19:27:55 +0200
Subject: [Windstille-commit] r3259 - trunk/windstille/src/editor
Message-ID: <200909161727.n8GHRt8h010477@sheep.berlios.de>

Author: grumbel
Date: 2009-09-16 19:27:38 +0200 (Wed, 16 Sep 2009)
New Revision: 3259

Modified:
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/editor_window.hpp
   trunk/windstille/src/editor/select_tool.cpp
Log:
Display information on selection rect in statusbar

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-16 17:26:25 UTC (rev 3258)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-16 17:27:38 UTC (rev 3259)
@@ -50,6 +50,8 @@
     hbox(),
     hpaned(),
     vpaned(),
+    status_hbox(),
+    status_label(),
     status(),
     ui_manager(Gtk::UIManager::create()),
     action_group(Gtk::ActionGroup::create()),
@@ -394,8 +396,11 @@
   vbox.pack_start(*ui_manager->get_widget("/MenuBar"), Gtk::PACK_SHRINK);
   vbox.pack_start(*ui_manager->get_widget("/ToolBar"), Gtk::PACK_SHRINK);
   vbox.add(hbox);
-  vbox.pack_end(status, Gtk::PACK_SHRINK);
 
+  status_hbox.pack_start(status_label, Gtk::PACK_SHRINK);
+  status_hbox.pack_start(status, Gtk::PACK_EXPAND_WIDGET);
+  vbox.pack_end(status_hbox, Gtk::PACK_SHRINK);
+
   // Hbox
   hbox.pack_start(*ui_manager->get_widget("/ToolBox"), Gtk::PACK_SHRINK);
   dynamic_cast<Gtk::Toolbar*>(ui_manager->get_widget("/ToolBox"))->set_orientation(Gtk::ORIENTATION_VERTICAL);
@@ -1012,5 +1017,11 @@
   std::cout << "[LOG] " << text << std::endl;
   Glib::signal_timeout().connect(sigc::bind(sigc::mem_fun(*this, &EditorWindow::remove_message), id), 6000);
 }
+
+void
+EditorWindow::print_coordinates(const std::string& text)
+{
+  status_label.set_text(text);
+}
 
 /* EOF */

Modified: trunk/windstille/src/editor/editor_window.hpp
===================================================================
--- trunk/windstille/src/editor/editor_window.hpp	2009-09-16 17:26:25 UTC (rev 3258)
+++ trunk/windstille/src/editor/editor_window.hpp	2009-09-16 17:27:38 UTC (rev 3259)
@@ -53,6 +53,8 @@
   Gtk::HBox   hbox;
   Gtk::HPaned hpaned;
   Gtk::VPaned vpaned;
+  Gtk::HBox      status_hbox;
+  Gtk::Label     status_label;
   Gtk::Statusbar status;
 
   Glib::RefPtr<Gtk::UIManager>   ui_manager;
@@ -164,6 +166,8 @@
   void print(const std::string& text);
   bool remove_message(guint id);
 
+  void print_coordinates(const std::string& text);
+
   Glib::RefPtr<Gtk::UIManager>   get_ui_manager() const { return ui_manager; }
   Glib::RefPtr<Gtk::ActionGroup> get_action_group() const { return action_group; }
   

Modified: trunk/windstille/src/editor/select_tool.cpp
===================================================================
--- trunk/windstille/src/editor/select_tool.cpp	2009-09-16 17:26:25 UTC (rev 3258)
+++ trunk/windstille/src/editor/select_tool.cpp	2009-09-16 17:27:38 UTC (rev 3259)
@@ -179,6 +179,11 @@
     rect.right  = pos.x;
     rect.bottom = pos.y;
 
+    std::ostringstream str;
+    str << "  (" << static_cast<int>(rect.left) << ", " << static_cast<int>(rect.top) << ")  " 
+        << abs(static_cast<int>(rect.get_width())) << " x " << abs(static_cast<int>(rect.get_height())) << "  ";
+    EditorWindow::current()->print_coordinates(str.str());
+
     wst.queue_draw();
   }
 }
@@ -235,6 +240,7 @@
     wst.queue_draw();
   }
 
+  EditorWindow::current()->print_coordinates(std::string());
   mode = NO_MODE;
 }
 



From grumbel at mail.berlios.de  Thu Sep 17 04:27:09 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 17 Sep 2009 04:27:09 +0200
Subject: [Windstille-commit] r3260 - in trunk/windstille/src: screen sprite3d
Message-ID: <200909170227.n8H2R9vX020663@sheep.berlios.de>

Author: grumbel
Date: 2009-09-17 04:27:07 +0200 (Thu, 17 Sep 2009)
New Revision: 3260

Modified:
   trunk/windstille/src/screen/armature_test.cpp
   trunk/windstille/src/screen/sprite2dview.cpp
   trunk/windstille/src/screen/sprite2dview.hpp
   trunk/windstille/src/sprite3d/data.cpp
Log:
Removed some more Physfs dependencies

Modified: trunk/windstille/src/screen/armature_test.cpp
===================================================================
--- trunk/windstille/src/screen/armature_test.cpp	2009-09-16 17:27:38 UTC (rev 3259)
+++ trunk/windstille/src/screen/armature_test.cpp	2009-09-17 02:27:07 UTC (rev 3260)
@@ -17,12 +17,13 @@
 */
 
 #include <GL/glew.h>
-#include <physfs.h>
+#include <boost/filesystem.hpp>
 
+#include "armature/pose.hpp"
 #include "input/controller.hpp"
+#include "screen/armature_test.hpp"
 #include "screen/screen_manager.hpp"
-#include "armature/pose.hpp"
-#include "screen/armature_test.hpp"
+#include "util/directory.hpp"
 
 ArmatureTest::ArmatureTest()
   : model(),
@@ -40,18 +41,18 @@
   FileReader armature_reader = FileReader::parse(Pathname("armature/armature.arm"));
   armature.reset(new Armature(armature_reader));
 
-  std::vector<std::string> file_lst;
   {
-    char** dirlist = PHYSFS_enumerateFiles("armature/pose/");
-    for (char **i = dirlist; *i != NULL; ++i)
-      if (!PHYSFS_isDirectory((std::string("armature/pose/") + *i).c_str())) {
+    Directory::List file_lst = Directory::read(Pathname("armature/pose/"));
+
+    for(Directory::List::iterator i = file_lst.begin(); i != file_lst.end(); ++i)
+    {
+      if (!boost::filesystem::is_directory(i->get_sys_path()))
+      {
         std::cout << "PoseFile: " << *i << std::endl;
-        Pathname path("armature/pose/");
-        path.append_path(*i);
-        FileReader pose_reader = FileReader::parse(path);
+        FileReader pose_reader = FileReader::parse(*i);
         poses.push_back(new Pose(pose_reader));       
       }
-    PHYSFS_freeList(dirlist);
+    }
   }
 
   pose_idx = 0;

Modified: trunk/windstille/src/screen/sprite2dview.cpp
===================================================================
--- trunk/windstille/src/screen/sprite2dview.cpp	2009-09-16 17:27:38 UTC (rev 3259)
+++ trunk/windstille/src/screen/sprite2dview.cpp	2009-09-17 02:27:07 UTC (rev 3260)
@@ -16,12 +16,14 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
-#include <physfs.h>
+#include "screen/sprite2dview.hpp"
 
+#include <boost/filesystem.hpp>
+
 #include "app/console.hpp"
+#include "display/surface_manager.hpp"
 #include "input/controller.hpp"
-#include "display/surface_manager.hpp"
-#include "sprite2dview.hpp"
+#include "util/directory.hpp"
 
 extern std::vector<std::string> arg_files;
 
@@ -55,13 +57,13 @@
 
   for(std::vector<std::string>::iterator i = arg_files.begin(); i != arg_files.end(); ++i)
   {
-    if (PHYSFS_isDirectory(i->c_str()))
+    if (boost::filesystem::is_directory(i->c_str()))
     { 
-      adddir(i->c_str());
+      adddir(Pathname(*i, Pathname::kSysPath));
     }
     else
     {
-      directory.push_back(*i);
+      directory.push_back(Pathname(*i, Pathname::kSysPath));
     }
   }
   
@@ -90,22 +92,21 @@
 }
 
 void
-Sprite2DView::adddir(const std::string& dirname)
+Sprite2DView::adddir(const Pathname& dirname)
 {
-  char** dirlist = PHYSFS_enumerateFiles(dirname.c_str());
-  for (char **i = dirlist; *i != NULL; ++i)
+  Directory::List lst = Directory::read(dirname);
+
+  for (Directory::List::iterator i = lst.begin(); i != lst.end(); ++i)
+  {
+    if (boost::filesystem::is_directory(i->get_sys_path()))
     {
-      //std::cout << dirname + "/" + *i << std::endl;
-      if (PHYSFS_isDirectory((dirname + "/" + *i).c_str()))
-        {
-          adddir(dirname + "/" + *i);
-        }
-      else
-        {
-          directory.push_back((dirname + "/" + *i).c_str());
-        }
+      adddir(*i);
     }
-  PHYSFS_freeList(dirlist);
+    else
+    {
+      directory.push_back(*i);
+    }
+  }
 }
 
 Sprite2DView::~Sprite2DView()
@@ -241,46 +242,51 @@
 Sprite2DView::next_image(int i)
 {
   if (directory.size() > 1)
+  {
+    if (new_sprite)
     {
-      if (new_sprite)
-        {
-          sprite = new_sprite;
-          sprite.set_alpha(1.0f);
-          new_sprite = Sprite();
-          offset = 0;
-          display_time = 0;
-        }
+      sprite = new_sprite;
+      sprite.set_alpha(1.0f);
+      new_sprite = Sprite();
+      offset = 0;
+      display_time = 0;
+    }
 
-      index = (unsigned int)(index + i) % directory.size();
+    index = (unsigned int)(index + i) % directory.size();
 
-      std::vector<std::string> dir;
+    std::vector<Pathname> dir;
 
-      if (shuffle)
-        dir = shuffle_directory;
-      else
-        dir = directory;
+    if (shuffle)
+      dir = shuffle_directory;
+    else
+      dir = directory;
       
-      bool retry = false;
+    bool retry = false;
 
-      do {
-        try {
-          new_sprite = Sprite(Pathname(dir[index]));
-          retry = false;
-        } catch(std::exception& e) {
-          // FIXME: won't work in combination with shuffle
-          std::cout << "Error: " << e.what() << std::endl;
-          std::cout << "Removing '" << directory[index] << "' from the list" << std::endl;
-          directory.erase(directory.begin() + index);
-          index = (unsigned int)(index) % directory.size();
-          retry = true;
-        }
-      } while (retry);
+    do 
+    {
+      try 
+      {
+        new_sprite = Sprite(dir[index]);
+        retry = false;
+      } 
+      catch(std::exception& e) 
+      {
+        // FIXME: won't work in combination with shuffle
+        std::cout << "Error: " << e.what() << std::endl;
+        std::cout << "Removing '" << directory[index] << "' from the list" << std::endl;
+        directory.erase(directory.begin() + index);
+        index = (unsigned int)(index) % directory.size();
+        retry = true;
+      }
+    } 
+    while (retry);
 
-      ignore_delta = true;
-      fadein = 0.0f;
-      prepare_sprite(new_sprite);
-      ConsoleLog << index << ": " << directory[index] << std::endl;
-    }
+    ignore_delta = true;
+    fadein = 0.0f;
+    prepare_sprite(new_sprite);
+    ConsoleLog << index << ": " << directory[index] << std::endl;
+  }
 
   SpriteManager::current()->cleanup();
   SurfaceManager::current()->cleanup();
@@ -348,8 +354,8 @@
     {
       if (shuffle)
         {
-          std::vector<std::string>::iterator i = std::find(directory.begin(), directory.end(),
-                                                           shuffle_directory[index]);
+          std::vector<Pathname>::iterator i = std::find(directory.begin(), directory.end(),
+                                                        shuffle_directory[index]);
           if (i != directory.end())
             {
               index = i - directory.begin() ;
@@ -357,7 +363,7 @@
         }
       else
         {
-          std::vector<std::string>::iterator i = std::find(shuffle_directory.begin(), shuffle_directory.end(),
+          std::vector<Pathname>::iterator i = std::find(shuffle_directory.begin(), shuffle_directory.end(),
                                                            directory[index]);
           if (i != shuffle_directory.end())
             {

Modified: trunk/windstille/src/screen/sprite2dview.hpp
===================================================================
--- trunk/windstille/src/screen/sprite2dview.hpp	2009-09-16 17:27:38 UTC (rev 3259)
+++ trunk/windstille/src/screen/sprite2dview.hpp	2009-09-17 02:27:07 UTC (rev 3260)
@@ -20,8 +20,9 @@
 #define HEADER_WINDSTILLE_SCREEN_SPRITE2DVIEW_HPP
 
 #include "display/scene_context.hpp"
+#include "screen/screen.hpp"
 #include "sprite2d/sprite.hpp"
-#include "screen/screen.hpp"
+#include "util/pathname.hpp"
 
 /**
  * A simple class to view 3d sprites and their different actions,
@@ -31,8 +32,8 @@
 {
 private:
   SceneContext sc;
-  std::vector<std::string> directory;
-  std::vector<std::string> shuffle_directory;
+  std::vector<Pathname> directory;
+  std::vector<Pathname> shuffle_directory;
 
   enum Mode { SLIDESHOW, MANUAL } mode;
   
@@ -65,7 +66,7 @@
   Sprite2DView();
   ~Sprite2DView();
   
-  void adddir(const std::string& dir);
+  void adddir(const Pathname& dir);
 
   void draw();
   void update(float delta, const Controller& controller);

Modified: trunk/windstille/src/sprite3d/data.cpp
===================================================================
--- trunk/windstille/src/sprite3d/data.cpp	2009-09-16 17:27:38 UTC (rev 3259)
+++ trunk/windstille/src/sprite3d/data.cpp	2009-09-17 02:27:07 UTC (rev 3260)
@@ -20,7 +20,6 @@
 
 #include <boost/scoped_array.hpp>
 #include <fstream>
-#include <physfs.h>
 #include <string.h>
 #include <errno.h>
 #include <stdexcept>



From grumbel at mail.berlios.de  Thu Sep 17 05:11:15 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 17 Sep 2009 05:11:15 +0200
Subject: [Windstille-commit] r3261 -
	trunk/windstille/data/sectors/trainstation
Message-ID: <200909170311.n8H3BF9b022773@sheep.berlios.de>

Author: grumbel
Date: 2009-09-17 05:11:14 +0200 (Thu, 17 Sep 2009)
New Revision: 3261

Modified:
   trunk/windstille/data/sectors/trainstation/worker.wst
Log:
Some cleanup and completion

Modified: trunk/windstille/data/sectors/trainstation/worker.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/worker.wst	2009-09-17 02:27:07 UTC (rev 3260)
+++ trunk/windstille/data/sectors/trainstation/worker.wst	2009-09-17 03:11:14 UTC (rev 3261)
@@ -8,71 +8,133 @@
   (navigation
     (nodes
       (navgraph-node
-        (id "0xa2182d8")
-        (pos -1899 642)
+        (id "0x9a76c50")
+        (pos -2176 256)
         (parent "")
         (select-mask -1))
       (navgraph-node
-        (id "0xa218388")
-        (pos 1611 644)
+        (id "0x9988000")
+        (pos 2432 256)
         (parent "")
         (select-mask -1))
       (navgraph-node
-        (id "0xa218320")
-        (pos 2418 642)
+        (id "0x991a998")
+        (pos 2432 -384)
         (parent "")
         (select-mask -1))
       (navgraph-node
-        (id "0xa218278")
-        (pos 955 0)
+        (id "0x991a9d8")
+        (pos -2176 -384)
         (parent "")
         (select-mask -1))
       (navgraph-node
-        (id "0xa2181e0")
-        (pos 2363 2)
+        (id "0x99903a0")
+        (pos -2176 640)
         (parent "")
         (select-mask -1))
       (navgraph-node
-        (id "0xa23ef18")
-        (pos -1174 0)
+        (id "0x9990450")
+        (pos 1536 640)
         (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x99903e8")
+        (pos 2432 640)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x9a79b98")
+        (pos 896 0)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x9989608")
+        (pos 2432 0)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x9905818")
+        (pos -2176 0)
+        (parent "")
         (select-mask -1)))
     (edges
       (navgraph-edge
-        (id "0xa2187e0")
-        (pos 70 -23)
+        (id "0x9a7a4d0")
+        (pos 0 0)
         (parent "")
         (select-mask -1)
-        (lhs-node "0xa218388")
-        (rhs-node "0xa2182d8"))
+        (lhs-node "0x99903a0")
+        (rhs-node "0x9a76c50"))
       (navgraph-edge
-        (id "0xa218740")
-        (pos 70 -23)
+        (id "0x998d430")
+        (pos 0 0)
         (parent "")
         (select-mask -1)
-        (lhs-node "0xa218320")
-        (rhs-node "0xa218388"))
+        (lhs-node "0x9988000")
+        (rhs-node "0x9a76c50"))
       (navgraph-edge
-        (id "0xa218660")
-        (pos 70 -23)
+        (id "0x9a74d10")
+        (pos 0 0)
         (parent "")
         (select-mask -1)
-        (lhs-node "0xa2181e0")
-        (rhs-node "0xa218278"))
+        (lhs-node "0x9988000")
+        (rhs-node "0x99903e8"))
       (navgraph-edge
-        (id "0xa218590")
-        (pos 70 -23)
+        (id "0x9d97198")
+        (pos 0 0)
         (parent "")
         (select-mask -1)
-        (lhs-node "0xa23ef18")
-        (rhs-node "0xa218278"))
+        (lhs-node "0x9989608")
+        (rhs-node "0x991a998"))
       (navgraph-edge
-        (id "0xa218058")
-        (pos 70 -23)
+        (id "0x99b6530")
+        (pos 0 0)
         (parent "")
         (select-mask -1)
-        (lhs-node "0xa218278")
-        (rhs-node "0xa218388"))))
+        (lhs-node "0x991a998")
+        (rhs-node "0x991a9d8"))
+      (navgraph-edge
+        (id "0x9694518")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x9905818")
+        (rhs-node "0x991a9d8"))
+      (navgraph-edge
+        (id "0x9990860")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x9990450")
+        (rhs-node "0x99903a0"))
+      (navgraph-edge
+        (id "0x99907c0")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x99903e8")
+        (rhs-node "0x9990450"))
+      (navgraph-edge
+        (id "0x99906e0")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x9989608")
+        (rhs-node "0x9a79b98"))
+      (navgraph-edge
+        (id "0x9990610")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x9905818")
+        (rhs-node "0x9a79b98"))
+      (navgraph-edge
+        (id "0x9990160")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x9a79b98")
+        (rhs-node "0x9990450"))))
   (layers
     (layer
       (name "Background")
@@ -80,8 +142,8 @@
       (locked #t)
       (objects
         (decal
-          (id "0xacf8ec8")
-          (pos 448 448)
+          (id "0x9baf498")
+          (pos 704 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -91,8 +153,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xacf5858")
-          (pos 832 448)
+          (id "0xaa2d370")
+          (pos 1088 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -102,8 +164,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb113560")
-          (pos 1600 448)
+          (id "0x9baec28")
+          (pos 1856 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -113,8 +175,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb113f10")
-          (pos 1216 448)
+          (id "0xaa2ceb8")
+          (pos 1472 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -124,8 +186,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb112da8")
-          (pos 64 448)
+          (id "0xaa2d060")
+          (pos 320 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -135,8 +197,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb112b28")
-          (pos -1472 448)
+          (id "0xaa2d188")
+          (pos -1216 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -146,8 +208,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb113c48")
-          (pos -320 448)
+          (id "0xaa6d950")
+          (pos -64 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -157,8 +219,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb113680")
-          (pos -704 448)
+          (id "0xaa6da08")
+          (pos -448 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -168,8 +230,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb113a30")
-          (pos -1088 448)
+          (id "0xaa6db20")
+          (pos -832 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -179,8 +241,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb113778")
-          (pos 1984 448)
+          (id "0xaa6d840")
+          (pos 2240 448)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -190,8 +252,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb1155a8")
-          (pos 2112 -192)
+          (id "0xaa6e908")
+          (pos 2240 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -201,8 +263,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb115648")
-          (pos -960 -192)
+          (id "0xaa6d548")
+          (pos -832 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -212,8 +274,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb1149a0")
-          (pos -576 -192)
+          (id "0xaa6d658")
+          (pos -448 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -223,8 +285,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb114ac8")
-          (pos -192 -192)
+          (id "0xaa6e2f8")
+          (pos -64 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -234,8 +296,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb115238")
-          (pos 192 -192)
+          (id "0xaa6e1c0")
+          (pos 320 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -245,8 +307,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb1150b8")
-          (pos 1344 -192)
+          (id "0xaa6e720")
+          (pos 1472 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -256,8 +318,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb1152d8")
-          (pos 1728 -192)
+          (id "0xaa6f388")
+          (pos 1856 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -267,8 +329,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb115378")
-          (pos 960 -192)
+          (id "0xaa6ed20")
+          (pos 1088 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -278,8 +340,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xb114c78")
-          (pos 576 -192)
+          (id "0xaa6eec8")
+          (pos 704 -192)
           (parent "")
           (select-mask 1)
           (path "images/objects/bluewall.png")
@@ -287,6 +349,61 @@
           (scale 1 1)
           (angle 0)
           (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x997c578")
+          (pos -1600 448)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/bluewall.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9a724f8")
+          (pos -1216 -192)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/bluewall.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9a6f700")
+          (pos -1600 -192)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/bluewall.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x991a4b0")
+          (pos -1984 448)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/bluewall.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x99c37b0")
+          (pos -1984 -192)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/bluewall.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
           (vflip #f))))
     (layer
       (name "Shadow")
@@ -294,7 +411,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0xacf7a18")
+          (id "0x9a7bb38")
           (pos 1511 684)
           (parent "")
           (select-mask 1)
@@ -305,7 +422,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xacf7af8")
+          (id "0xa59fc90")
           (pos 405 613)
           (parent "")
           (select-mask 1)
@@ -316,7 +433,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xad05430")
+          (id "0xa59ee48")
           (pos 950 596)
           (parent "")
           (select-mask 1)
@@ -327,7 +444,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xad05240")
+          (id "0x9bae830")
           (pos 665 512)
           (parent "")
           (select-mask 1)
@@ -338,7 +455,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xacf96d8")
+          (id "0xa59f288")
           (pos -146 690)
           (parent "")
           (select-mask 1)
@@ -349,7 +466,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xacf9548")
+          (id "0xa59f110")
           (pos 147 684)
           (parent "")
           (select-mask 1)
@@ -360,7 +477,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xacf8a00")
+          (id "0x9bae968")
           (pos 1232 244)
           (parent "")
           (select-mask 1)
@@ -371,7 +488,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xacf8ba8")
+          (id "0x9baea80")
           (pos 1008 69)
           (parent "")
           (select-mask 1)
@@ -382,7 +499,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xacf8cb0")
+          (id "0xa59efa0")
           (pos 1277 651)
           (parent "")
           (select-mask 1)
@@ -398,7 +515,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0xab86220")
+          (id "0x9d970c8")
           (pos 448 512)
           (parent "")
           (select-mask 1)
@@ -409,7 +526,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xab86f58")
+          (id "0x9d942a0")
           (pos 576 512)
           (parent "")
           (select-mask 1)
@@ -420,7 +537,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xab83bb8")
+          (id "0x9d95c90")
           (pos 704 512)
           (parent "")
           (select-mask 1)
@@ -431,7 +548,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xab83930")
+          (id "0x9d95108")
           (pos 832 512)
           (parent "")
           (select-mask 1)
@@ -442,7 +559,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xab839f0")
+          (id "0x9d95820")
           (pos 960 512)
           (parent "")
           (select-mask 1)
@@ -453,7 +570,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xab842a0")
+          (id "0x9d958b8")
           (pos -705 497)
           (parent "")
           (select-mask 1)
@@ -464,7 +581,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xab84ae0")
+          (id "0xa425d48")
           (pos -704 512)
           (parent "")
           (select-mask 1)
@@ -475,7 +592,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xacfa198")
+          (id "0x9d93920")
           (pos -247 597)
           (parent "")
           (select-mask 1)
@@ -486,7 +603,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xacf5750")
+          (id "0xa424920")
           (pos 152 597)
           (parent "")
           (select-mask 1)
@@ -497,7 +614,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xacf9f80")
+          (id "0xa425490")
           (pos -98 -127)
           (parent "")
           (select-mask 1)
@@ -508,7 +625,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xae7bfc8")
+          (id "0xa425c48")
           (pos -97 -142)
           (parent "")
           (select-mask 1)
@@ -519,7 +636,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xae7c588")
+          (id "0xa4258a0")
           (pos 491 -142)
           (parent "")
           (select-mask 1)
@@ -530,7 +647,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xae7be60")
+          (id "0xa425610")
           (pos 489 -127)
           (parent "")
           (select-mask 1)
@@ -541,7 +658,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xae7bd28")
+          (id "0xa425710")
           (pos -648 -142)
           (parent "")
           (select-mask 1)
@@ -552,7 +669,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xae7c120")
+          (id "0xa59f958")
           (pos -649 -127)
           (parent "")
           (select-mask 1)
@@ -568,8 +685,8 @@
       (locked #t)
       (objects
         (decal
-          (id "0xa218a70")
-          (pos 1426 357)
+          (id "0x9990a88")
+          (pos 1344 358)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair2.png")
@@ -579,8 +696,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa427ca0")
-          (pos 1426 517)
+          (id "0x9d903f8")
+          (pos 1344 518)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair1.png")
@@ -590,8 +707,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42a3f0")
-          (pos 1554 645)
+          (id "0x9b24000")
+          (pos 1472 646)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair1.png")
@@ -601,8 +718,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42a580")
-          (pos 1554 485)
+          (id "0x9d962d8")
+          (pos 1472 486)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair2.png")
@@ -612,8 +729,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42acf0")
-          (pos 1298 229)
+          (id "0x9d963c8")
+          (pos 1216 230)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair2.png")
@@ -623,8 +740,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xab85e00")
-          (pos 1170 261)
+          (id "0x9c65eb0")
+          (pos 1088 262)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair1.png")
@@ -634,8 +751,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xab85f80")
-          (pos 1170 101)
+          (id "0x9c65f00")
+          (pos 1088 102)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair2.png")
@@ -645,8 +762,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xab86148")
-          (pos 1298 389)
+          (id "0x9d96648")
+          (pos 1216 390)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair1.png")
@@ -656,8 +773,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42a8d8")
-          (pos 1038 133)
+          (id "0x9d96b48")
+          (pos 956 134)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair1.png")
@@ -667,8 +784,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42ab48")
-          (pos 1038 -27)
+          (id "0x9d96a50")
+          (pos 956 -26)
           (parent "")
           (select-mask 1)
           (path "images/decal/stair2.png")
@@ -682,15 +799,19 @@
       (visible #t)
       (locked #t)
       (objects
+      (particle-systems (name "particlesystems/fire.particles")
+      (pos 0 320))
+      (particle-systems (name "particlesystems/water.particles")
+      (pos 0 128))
         (navgraph-edge-ref
-          (edge "0xa218058"))))
+          (edge "0x9990160"))))
     (layer
       (name "Ground")
       (visible #t)
-      (locked #f)
+      (locked #t)
       (objects
         (decal
-          (id "0xa2f2120")
+          (id "0x9b31a40")
           (pos 1791 703)
           (parent "")
           (select-mask 1)
@@ -701,8 +822,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2f4610")
-          (pos 1023 703)
+          (id "0x9b33f30")
+          (pos 1024 704)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -712,7 +833,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2f6030")
+          (id "0x9b33da0")
           (pos 1280 704)
           (parent "")
           (select-mask 1)
@@ -723,8 +844,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2f4560")
-          (pos 511 703)
+          (id "0x9b31530")
+          (pos 512 704)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -734,8 +855,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2f6190")
-          (pos 255 703)
+          (id "0x9b31420")
+          (pos 256 704)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -745,8 +866,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2f5ec8")
-          (pos -1 703)
+          (id "0x9b31178")
+          (pos 0 704)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -756,8 +877,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2f5be0")
-          (pos 767 703)
+          (id "0x9b30fd0")
+          (pos 768 704)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -767,8 +888,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2fb100")
-          (pos 1535 703)
+          (id "0x9b311f8")
+          (pos 1536 704)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -778,7 +899,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2fb1a8")
+          (id "0x9b35b08")
           (pos 0 192)
           (parent "")
           (select-mask 1)
@@ -789,7 +910,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2f9540")
+          (id "0x9b2fcf8")
           (pos 256 192)
           (parent "")
           (select-mask 1)
@@ -800,7 +921,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2f9400")
+          (id "0x9b2f7e8")
           (pos 512 192)
           (parent "")
           (select-mask 1)
@@ -811,7 +932,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2f9e68")
+          (id "0x9b2fbf8")
           (pos 1280 192)
           (parent "")
           (select-mask 1)
@@ -822,7 +943,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2facb8")
+          (id "0x9b30d78")
           (pos 1024 192)
           (parent "")
           (select-mask 1)
@@ -833,7 +954,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2fad60")
+          (id "0x9b2f8c0")
           (pos 768 192)
           (parent "")
           (select-mask 1)
@@ -844,7 +965,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2fa420")
+          (id "0x9b30bf0")
           (pos 1792 192)
           (parent "")
           (select-mask 1)
@@ -855,7 +976,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2fa5e0")
+          (id "0x9b30908")
           (pos 1536 192)
           (parent "")
           (select-mask 1)
@@ -866,8 +987,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2fae68")
-          (pos -769 703)
+          (id "0x9b2fd58")
+          (pos -768 704)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -877,8 +998,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2f9f30")
-          (pos -513 703)
+          (id "0x9b300b8")
+          (pos -512 704)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -888,8 +1009,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2fa048")
-          (pos -1281 703)
+          (id "0x9b2ff30")
+          (pos -1280 704)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -899,8 +1020,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2fa718")
-          (pos -1537 703)
+          (id "0x9b303e0")
+          (pos -1536 704)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -910,8 +1031,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42aef0")
-          (pos -1793 703)
+          (id "0x9b30278")
+          (pos -1792 704)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -921,8 +1042,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2fa970")
-          (pos -1025 703)
+          (id "0x9b30998")
+          (pos -1024 704)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -932,8 +1053,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2faa30")
-          (pos -257 703)
+          (id "0x9b30a38")
+          (pos -256 704)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -943,7 +1064,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42af40")
+          (id "0x9b305a8")
           (pos -1792 192)
           (parent "")
           (select-mask 1)
@@ -954,7 +1075,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42c2a8")
+          (id "0x9c66e70")
           (pos -1536 192)
           (parent "")
           (select-mask 1)
@@ -965,7 +1086,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42b4d8")
+          (id "0x9c668c0")
           (pos -1280 192)
           (parent "")
           (select-mask 1)
@@ -976,7 +1097,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42b2d8")
+          (id "0x9c66f90")
           (pos -512 192)
           (parent "")
           (select-mask 1)
@@ -987,7 +1108,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42b368")
+          (id "0x9c666e8")
           (pos -768 192)
           (parent "")
           (select-mask 1)
@@ -998,7 +1119,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42bb60")
+          (id "0x9c66ab8")
           (pos -1024 192)
           (parent "")
           (select-mask 1)
@@ -1009,7 +1130,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42b8c0")
+          (id "0x9c66c30")
           (pos -256 192)
           (parent "")
           (select-mask 1)
@@ -1020,7 +1141,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42b730")
+          (id "0x9c64048")
           (pos 2047 703)
           (parent "")
           (select-mask 1)
@@ -1031,7 +1152,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42c118")
+          (id "0x9c663c0")
           (pos 2303 703)
           (parent "")
           (select-mask 1)
@@ -1042,7 +1163,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42bfb0")
+          (id "0x9c61bc0")
           (pos 2048 192)
           (parent "")
           (select-mask 1)
@@ -1053,7 +1174,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa426e90")
+          (id "0x9c66460")
           (pos 2304 192)
           (parent "")
           (select-mask 1)
@@ -1064,7 +1185,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa426f90")
+          (id "0x9c61cb8")
           (pos 2304 64)
           (parent "")
           (select-mask 1)
@@ -1075,7 +1196,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa4269a8")
+          (id "0x9c61d70")
           (pos 0 64)
           (parent "")
           (select-mask 1)
@@ -1086,7 +1207,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa426c60")
+          (id "0x9c62820")
           (pos -256 64)
           (parent "")
           (select-mask 1)
@@ -1097,7 +1218,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa426a48")
+          (id "0x9c626d0")
           (pos -512 64)
           (parent "")
           (select-mask 1)
@@ -1108,7 +1229,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa427a70")
+          (id "0x9c624d8")
           (pos 1792 64)
           (parent "")
           (select-mask 1)
@@ -1119,7 +1240,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa4278f0")
+          (id "0x9c61f30")
           (pos 1024 64)
           (parent "")
           (select-mask 1)
@@ -1130,7 +1251,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa427740")
+          (id "0x9c62258")
           (pos 256 64)
           (parent "")
           (select-mask 1)
@@ -1141,7 +1262,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa427180")
+          (id "0x9c62030")
           (pos 512 64)
           (parent "")
           (select-mask 1)
@@ -1152,7 +1273,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa4274e8")
+          (id "0x9c62fa8")
           (pos 768 64)
           (parent "")
           (select-mask 1)
@@ -1163,7 +1284,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa427280")
+          (id "0x9c62a40")
           (pos 1536 64)
           (parent "")
           (select-mask 1)
@@ -1174,7 +1295,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa428a90")
+          (id "0x9c62da8")
           (pos 1280 64)
           (parent "")
           (select-mask 1)
@@ -1185,7 +1306,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa428030")
+          (id "0x9c62b58")
           (pos 2048 64)
           (parent "")
           (select-mask 1)
@@ -1196,7 +1317,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa4284b0")
+          (id "0x9c63da0")
           (pos 2304 -448)
           (parent "")
           (select-mask 1)
@@ -1207,7 +1328,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa428b30")
+          (id "0x9c63b90")
           (pos 2048 -448)
           (parent "")
           (select-mask 1)
@@ -1218,8 +1339,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa428340")
-          (pos -256 -447)
+          (id "0x9c636e0")
+          (pos -256 -448)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1229,8 +1350,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa4281a8")
-          (pos -1024 -447)
+          (id "0x9c63960")
+          (pos -1024 -448)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1240,8 +1361,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa42ade0")
-          (pos -768 -447)
+          (id "0x9c63178")
+          (pos -768 -448)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1251,8 +1372,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa428768")
-          (pos -512 -447)
+          (id "0x9c63218")
+          (pos -512 -448)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1262,8 +1383,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa3688f8")
-          (pos 1536 -447)
+          (id "0x9c63590")
+          (pos 1536 -448)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1273,8 +1394,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa368c20")
-          (pos 1792 -447)
+          (id "0x9c632b8")
+          (pos 1792 -448)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1284,8 +1405,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa368e00")
-          (pos 768 -447)
+          (id "0x9d8f6e0")
+          (pos 768 -448)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1295,8 +1416,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa369000")
-          (pos 1024 -447)
+          (id "0x9d8f7f8")
+          (pos 1024 -448)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1306,8 +1427,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa368e60")
-          (pos 1280 -447)
+          (id "0x9d8f888")
+          (pos 1280 -448)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1317,8 +1438,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa369350")
-          (pos 512 -447)
+          (id "0x9d8fb50")
+          (pos 512 -448)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1328,8 +1449,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa369520")
-          (pos 256 -447)
+          (id "0x9d90190")
+          (pos 256 -448)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1339,8 +1460,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa3696e8")
-          (pos 0 -447)
+          (id "0x9d90208")
+          (pos 0 -448)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -1350,7 +1471,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa22ff68")
+          (id "0x9d8ff00")
           (pos -768 64)
           (parent "")
           (select-mask 1)
@@ -1361,7 +1482,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa1314c0")
+          (id "0x9d8fd28")
           (pos -1024 64)
           (parent "")
           (select-mask 1)
@@ -1372,7 +1493,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa132f28")
+          (id "0x9d8f540")
           (pos -1280 64)
           (parent "")
           (select-mask 1)
@@ -1383,7 +1504,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa132ea0")
+          (id "0x9d8f238")
           (pos -1536 64)
           (parent "")
           (select-mask 1)
@@ -1392,14 +1513,102 @@
           (scale 1 1)
           (angle 0)
           (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9a60dd0")
+          (pos -1792 64)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/blueground.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9969b98")
+          (pos -1280 -448)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/blueroof.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9a72570")
+          (pos -1536 -448)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/blueroof.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9a5efd8")
+          (pos -1792 -448)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/blueroof.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9a739e8")
+          (pos -2048 -448)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/blueroof.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9a5ecb0")
+          (pos -2048 704)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/blueground.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9a738c8")
+          (pos -2048 192)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/blueroof.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9a73540")
+          (pos -2048 64)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/blueground.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
           (vflip #f))))
     (layer
       (name "Highlight")
       (visible #t)
-      (locked #t)
+      (locked #f)
       (objects
         (decal
-          (id "0xa241000")
+          (id "0x9a7cdd0")
           (pos -441 261)
           (parent "")
           (select-mask 1)
@@ -1410,7 +1619,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2c3968")
+          (id "0x9a7cf40")
           (pos 737 260)
           (parent "")
           (select-mask 1)
@@ -1421,7 +1630,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa258948")
+          (id "0x9afe630")
           (pos 1400 257)
           (parent "")
           (select-mask 1)
@@ -1432,7 +1641,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa258a18")
+          (id "0x9a93608")
           (pos 116 257)
           (parent "")
           (select-mask 1)
@@ -1443,7 +1652,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa258ad8")
+          (id "0x9afe478")
           (pos -420 282)
           (parent "")
           (select-mask 1)
@@ -1454,7 +1663,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2e7d20")
+          (id "0x9afdfd8")
           (pos 126 288)
           (parent "")
           (select-mask 1)
@@ -1465,7 +1674,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2e7ed0")
+          (id "0x9afe0c8")
           (pos 736 268)
           (parent "")
           (select-mask 1)
@@ -1476,7 +1685,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2e9758")
+          (id "0x9afe190")
           (pos 1411 279)
           (parent "")
           (select-mask 1)
@@ -1487,7 +1696,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2e7f90")
+          (id "0x9b234b8")
           (pos 1473 -362)
           (parent "")
           (select-mask 1)
@@ -1498,7 +1707,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2e80b8")
+          (id "0x9b23220")
           (pos 808 -359)
           (parent "")
           (select-mask 1)
@@ -1509,7 +1718,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2e8198")
+          (id "0x9b247b8")
           (pos 188 -353)
           (parent "")
           (select-mask 1)
@@ -1520,7 +1729,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2e9090")
+          (id "0x9b238e0")
           (pos -358 -359)
           (parent "")
           (select-mask 1)
@@ -1531,7 +1740,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2e9168")
+          (id "0x9b23668")
           (pos 178 -383)
           (parent "")
           (select-mask 1)
@@ -1542,7 +1751,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2e9560")
+          (id "0x9b23790")
           (pos 1463 -383)
           (parent "")
           (select-mask 1)
@@ -1553,7 +1762,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2e93f0")
+          (id "0x9b24358")
           (pos 799 -381)
           (parent "")
           (select-mask 1)
@@ -1564,7 +1773,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2e92b0")
+          (id "0x9b35db8")
           (pos -379 -379)
           (parent "")
           (select-mask 1)
@@ -1573,14 +1782,146 @@
           (scale 1 1)
           (angle 0)
           (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9904b38")
+          (pos -1075 -356)
+          (parent "")
+          (select-mask 1)
+          (path "images/decal/rooflamp_bloom.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x998f5e8")
+          (pos -1096 -376)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/apartmentlamp_highlight.png")
+          (type 2)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9a64210")
+          (pos -1090 281)
+          (parent "")
+          (select-mask 1)
+          (path "images/decal/rooflamp_bloom.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9a642d8")
+          (pos -1111 261)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/apartmentlamp_highlight.png")
+          (type 2)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x996aa38")
+          (pos -1732 263)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/apartmentlamp_highlight.png")
+          (type 2)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9a66040")
+          (pos -1711 283)
+          (parent "")
+          (select-mask 1)
+          (path "images/decal/rooflamp_bloom.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x991ac38")
+          (pos -1679 -355)
+          (parent "")
+          (select-mask 1)
+          (path "images/decal/rooflamp_bloom.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9a5f2e0")
+          (pos -1700 -375)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/apartmentlamp_highlight.png")
+          (type 2)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x99c3150")
+          (pos 2110 -360)
+          (parent "")
+          (select-mask 1)
+          (path "images/decal/rooflamp_bloom.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9973918")
+          (pos 2100 -381)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/apartmentlamp_highlight.png")
+          (type 2)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x991ac88")
+          (pos 2027 262)
+          (parent "")
+          (select-mask 1)
+          (path "images/objects/apartmentlamp_highlight.png")
+          (type 2)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9979390")
+          (pos 2037 283)
+          (parent "")
+          (select-mask 1)
+          (path "images/decal/rooflamp_bloom.png")
+          (type 0)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
           (vflip #f))))
     (layer
       (name "Light")
       (visible #t)
-      (locked #t)
+      (locked #f)
       (objects
         (decal
-          (id "0xa21ad58")
+          (id "0x9992e20")
           (pos 138 579)
           (parent "")
           (select-mask 1)
@@ -1591,7 +1932,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa240c58")
+          (id "0x9993068")
           (pos 1427 570)
           (parent "")
           (select-mask 1)
@@ -1602,7 +1943,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa240dc8")
+          (id "0x9a93cb0")
           (pos -439 562)
           (parent "")
           (select-mask 1)
@@ -1613,7 +1954,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa258f90")
+          (id "0x9a93d78")
           (pos 746 563)
           (parent "")
           (select-mask 1)
@@ -1624,7 +1965,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa259320")
+          (id "0x9a93e20")
           (pos 124 -138)
           (parent "")
           (select-mask 1)
@@ -1635,7 +1976,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa259200")
+          (id "0x9a93fc8")
           (pos 733 -153)
           (parent "")
           (select-mask 1)
@@ -1646,7 +1987,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa242020")
+          (id "0x9a7cc28")
           (pos -456 -153)
           (parent "")
           (select-mask 1)
@@ -1657,7 +1998,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa242140")
+          (id "0x9a7d0b0")
           (pos 1413 -146)
           (parent "")
           (select-mask 1)
@@ -1666,6 +2007,72 @@
           (scale 1 1)
           (angle 0)
           (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x996b5b8")
+          (pos -1105 -162)
+          (parent "")
+          (select-mask 1)
+          (path "images/decal/light.png")
+          (type 1)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x998f570")
+          (pos -1120 475)
+          (parent "")
+          (select-mask 1)
+          (path "images/decal/light.png")
+          (type 1)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9a6e3b0")
+          (pos -1741 477)
+          (parent "")
+          (select-mask 1)
+          (path "images/decal/light.png")
+          (type 1)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x9a6aaf8")
+          (pos -1709 -161)
+          (parent "")
+          (select-mask 1)
+          (path "images/decal/light.png")
+          (type 1)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x996abb0")
+          (pos 2050 -144)
+          (parent "")
+          (select-mask 1)
+          (path "images/decal/light.png")
+          (type 1)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
+          (vflip #f))
+        (decal
+          (id "0x991cc88")
+          (pos 1977 499)
+          (parent "")
+          (select-mask 1)
+          (path "images/decal/light.png")
+          (type 1)
+          (scale 1 1)
+          (angle 0)
+          (hflip #f)
           (vflip #f))))
     (layer
       (name "Scene")
@@ -1673,7 +2080,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0xa218b98")
+          (id "0x9990be0")
           (pos 1284 526)
           (parent "")
           (select-mask 1)
@@ -1684,12 +2091,24 @@
           (hflip #f)
           (vflip #f))
         (navgraph-edge-ref
-          (edge "0xa2187e0"))
+          (edge "0x9990860"))
         (navgraph-edge-ref
-          (edge "0xa218740"))
+          (edge "0x99907c0"))
         (navgraph-edge-ref
-          (edge "0xa218660"))
+          (edge "0x99906e0"))
         (navgraph-edge-ref
-          (edge "0xa218590"))))))
+          (edge "0x9990610"))
+        (navgraph-edge-ref
+          (edge "0x9694518"))
+        (navgraph-edge-ref
+          (edge "0x99b6530"))
+        (navgraph-edge-ref
+          (edge "0x9d97198"))
+        (navgraph-edge-ref
+          (edge "0x9a74d10"))
+        (navgraph-edge-ref
+          (edge "0x998d430"))
+        (navgraph-edge-ref
+          (edge "0x9a7a4d0"))))))
 
 ;; EOF ;;



From grumbel at mail.berlios.de  Fri Sep 25 21:39:16 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 25 Sep 2009 21:39:16 +0200
Subject: [Windstille-commit] r3262 - trunk/windstille/src/editor
Message-ID: <200909251939.n8PJdG2H031435@sheep.berlios.de>

Author: grumbel
Date: 2009-09-25 21:39:15 +0200 (Fri, 25 Sep 2009)
New Revision: 3262

Added:
   trunk/windstille/src/editor/timeline.cpp
   trunk/windstille/src/editor/timeline.hpp
   trunk/windstille/src/editor/timeline_layer.cpp
   trunk/windstille/src/editor/timeline_layer.hpp
   trunk/windstille/src/editor/timeline_object.hpp
   trunk/windstille/src/editor/timeline_widget.cpp
   trunk/windstille/src/editor/timeline_widget.hpp
Log:
Some experimental stuff for animation and timeline editing

Added: trunk/windstille/src/editor/timeline.cpp
===================================================================
--- trunk/windstille/src/editor/timeline.cpp	2009-09-17 03:11:14 UTC (rev 3261)
+++ trunk/windstille/src/editor/timeline.cpp	2009-09-25 19:39:15 UTC (rev 3262)
@@ -0,0 +1,36 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "editor/timeline.hpp"
+
+#include "editor/timeline_layer.hpp"
+
+Timeline::Timeline()
+  : m_layers()
+{
+}
+
+TimelineLayerHandle
+Timeline::add_layer(const std::string& name)
+{
+  m_layers.push_back(TimelineLayerHandle(new TimelineLayer(name)));
+
+  return m_layers.back();
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/timeline.hpp
===================================================================
--- trunk/windstille/src/editor/timeline.hpp	2009-09-17 03:11:14 UTC (rev 3261)
+++ trunk/windstille/src/editor/timeline.hpp	2009-09-25 19:39:15 UTC (rev 3262)
@@ -0,0 +1,47 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_EDITOR_TIMELINE_HPP
+#define HEADER_WINDSTILLE_EDITOR_TIMELINE_HPP
+
+#include "editor/timeline_object.hpp"
+#include "editor/timeline_layer.hpp"
+
+class Vector2f;
+
+class Timeline
+{
+private:
+  std::vector<TimelineLayerHandle> m_layers;
+
+public:
+  Timeline();
+
+  TimelineObjectHandle get_object(const Vector2f& pos) const;
+  TimelineLayerHandle  get_layer(const Vector2f& pos) const;
+
+  TimelineLayerHandle add_layer(const std::string& name);
+
+private:
+  Timeline(const Timeline&);
+  Timeline& operator=(const Timeline&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/timeline_layer.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer.cpp	2009-09-17 03:11:14 UTC (rev 3261)
+++ trunk/windstille/src/editor/timeline_layer.cpp	2009-09-25 19:39:15 UTC (rev 3262)
@@ -0,0 +1,38 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "timeline_layer.hpp"
+
+TimelineLayer::TimelineLayer(const std::string& name)
+  : m_name(name),
+    m_objects()
+{
+}
+
+void
+TimelineLayer::add_object(TimelineObjectHandle object)
+{
+}
+
+TimelineObjectHandle
+TimelineLayer::get_object(float pos) const
+{
+  return TimelineObjectHandle();
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline_layer.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/timeline_layer.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer.hpp	2009-09-17 03:11:14 UTC (rev 3261)
+++ trunk/windstille/src/editor/timeline_layer.hpp	2009-09-25 19:39:15 UTC (rev 3262)
@@ -0,0 +1,52 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_TIMELINE_LAYER_HPP
+#define HEADER_WINDSTILLE_TIMELINE_LAYER_HPP
+
+#include <vector>
+#include <string>
+#include <boost/shared_ptr.hpp>
+
+#include "timeline_object.hpp"
+
+class TimelineLayer
+{
+private:
+  std::string m_name;
+  std::vector<TimelineObjectHandle> m_objects;
+
+public:
+  TimelineLayer(const std::string& name);
+
+  void add_object(TimelineObjectHandle object);
+
+  TimelineObjectHandle get_object(float pos) const;
+
+  void draw();
+
+private:
+  TimelineLayer(const TimelineLayer&);
+  TimelineLayer& operator=(const TimelineLayer&);
+};
+
+typedef boost::shared_ptr<TimelineLayer> TimelineLayerHandle;
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline_layer.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/timeline_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_object.hpp	2009-09-17 03:11:14 UTC (rev 3261)
+++ trunk/windstille/src/editor/timeline_object.hpp	2009-09-25 19:39:15 UTC (rev 3262)
@@ -0,0 +1,42 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_TIMELINE_OBJECT_HPP
+#define HEADER_WINDSTILLE_TIMELINE_OBJECT_HPP
+
+#include <boost/shared_ptr.hpp>
+
+class TimelineObject
+{
+private:
+public:
+  TimelineObject();
+
+  float get_pos() const;
+  float get_width() const;
+
+private:
+  TimelineObject(const TimelineObject&);
+  TimelineObject& operator=(const TimelineObject&);
+};
+
+typedef boost::shared_ptr<TimelineObject> TimelineObjectHandle;
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline_object.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/timeline_widget.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_widget.cpp	2009-09-17 03:11:14 UTC (rev 3261)
+++ trunk/windstille/src/editor/timeline_widget.cpp	2009-09-25 19:39:15 UTC (rev 3262)
@@ -0,0 +1,304 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "editor/timeline_widget.hpp"
+
+#include <iostream>
+
+#include "editor/timeline.hpp"
+
+TimelineWidget::TimelineWidget() :
+  m_timeline(),
+  down_pos(),
+  move_pos()
+{
+  signal_button_release_event().connect(sigc::mem_fun(this, &TimelineWidget::mouse_up));
+  signal_button_press_event().connect(sigc::mem_fun(this, &TimelineWidget::mouse_down));
+  signal_motion_notify_event().connect(sigc::mem_fun(this, &TimelineWidget::mouse_move));
+
+  add_events(Gdk::POINTER_MOTION_MASK | Gdk::BUTTON_PRESS_MASK | Gdk::BUTTON_RELEASE_MASK |
+             Gdk::KEY_PRESS_MASK      | Gdk::KEY_RELEASE_MASK | 
+             Gdk::ENTER_NOTIFY_MASK   | Gdk::LEAVE_NOTIFY_MASK);
+}
+
+TimelineWidget::~TimelineWidget()
+{
+}
+
+bool
+TimelineWidget::mouse_down(GdkEventButton* ev)
+{
+  down_pos.x = static_cast<float>(ev->x);
+  down_pos.y = static_cast<float>(ev->y);
+  return false;
+}
+
+bool
+TimelineWidget::mouse_up(GdkEventButton* ev)
+{
+  return false;
+}
+
+bool
+TimelineWidget::mouse_move(GdkEventMotion* ev)
+{
+  move_pos.x = static_cast<float>(ev->x);
+  move_pos.y = static_cast<float>(ev->y);
+  queue_draw();
+  return false;
+}
+
+bool
+TimelineWidget::on_expose_event(GdkEventExpose* ev)
+{
+  if (Glib::RefPtr<Gdk::Window> window = get_window())
+  {
+    Gtk::Allocation allocation = get_allocation();
+
+    Cairo::RefPtr<Cairo::Context> cr = window->create_cairo_context();
+
+    std::cout << "on_expose_event: " << allocation.get_width() << "x" << allocation.get_height() << std::endl;
+
+    if (1) // pixel perfect drawing
+      cr->translate(0.5, 0.5);
+
+    // clip to the area indicated by the expose event so that we only redraw
+    // the portion of the window that needs to be redrawn
+    cr->rectangle(ev->area.x,     ev->area.y,
+                  ev->area.width, ev->area.height);
+    cr->clip();
+
+    cr->set_source_rgb(1,1,1);
+    cr->rectangle(0, 0, allocation.get_width(), 32*4);
+    cr->fill();
+
+    cr->set_line_width(0.5);
+    cr->set_source_rgb(0,0,0);
+    // draw grid
+    for(int y = 0; y < allocation.get_height(); y += 32)
+    {
+      cr->move_to(0, y);
+      cr->line_to(allocation.get_width(), y);
+
+      if (0)
+        for(int x = 0; x < allocation.get_width(); x += 8)
+        {
+          cr->move_to(x, y - 3);
+          cr->line_to(x, y + 3);
+        }
+    }
+    cr->stroke();
+
+    cr->set_source_rgba(0,0,0, 0.25);
+    for(int x = 0; x < allocation.get_width(); x += 8)
+    {
+      if (x % 80)
+      {
+        cr->move_to(x, 0);
+        cr->line_to(x, allocation.get_height());
+      }
+    }
+    cr->stroke();
+
+    cr->set_source_rgba(0,0,0, 0.75);
+    for(int x = 0; x < allocation.get_width(); x += 8)
+    {
+      if (!(x % 80))
+      {
+        cr->move_to(x, 0);
+        cr->line_to(x, allocation.get_height());
+      }
+    }
+    cr->stroke();
+
+    cr->set_line_width(1.0);
+
+    // draw keyframe
+    for(int x = 32; x < 128; x += 16)
+    {
+      cr->set_source_rgb(0.0, 0.5, 0.75);
+      cr->rectangle(x, 32+4, 8, 24);
+      cr->fill();
+
+      cr->set_source_rgb(0, 0, 0);
+      cr->rectangle(x, 32+4, 8, 24);
+      cr->stroke();
+    }
+
+    // print some text
+    {
+      std::string text = "snd:Hello World!";
+      Cairo::TextExtents extents;
+
+      cr->select_font_face ("Sans", Cairo::FONT_SLANT_NORMAL, Cairo::FONT_WEIGHT_NORMAL);
+      cr->set_font_size(12);
+
+      cr->get_text_extents(text, extents);
+
+      std::cout << extents.x_bearing << " "
+                << extents.y_bearing << " "
+                << extents.width << " "
+                << extents.height << " "
+                << extents.x_advance << " "
+                << extents.y_advance << " "
+                << std::endl;
+
+      double x_border = 16.0f;
+      double y_border = 4.0f;
+      cr->set_source_rgb(0.0, 0.5, 0.75);
+      cr->rectangle(20  + extents.x_bearing - x_border, 
+                    118 + extents.y_bearing - y_border,
+                    extents.width  + 2*x_border,
+                    extents.height + 2*y_border);
+      cr->fill();
+
+      cr->set_source_rgb(0, 0, 0);
+      cr->rectangle(20  + extents.x_bearing - x_border, 
+                    118 + extents.y_bearing - y_border,
+                    extents.width  + 2*x_border,
+                    extents.height + 2*y_border);
+      cr->stroke();
+
+      cr->set_source_rgb(1,1,1);
+      cr->move_to(20,118);
+      cr->show_text(text);
+    }
+
+  std::cout << "down: " << down_pos << std::endl;
+  std::cout << "move: " << move_pos << std::endl;
+
+    // Select rectangle
+    {
+      cr->set_source_rgba(0,0,1,0.25);
+      cr->rectangle(down_pos.x, down_pos.y,
+                    move_pos.x - down_pos.x,
+                    move_pos.y - down_pos.y);
+      cr->fill();
+
+      cr->set_source_rgb(0,0,1);
+      cr->rectangle(down_pos.x, down_pos.y,
+                    move_pos.x - down_pos.x,
+                    move_pos.y - down_pos.y);
+      cr->stroke();
+    }
+  }
+
+  return true;
+}
+
+void
+TimelineWidget::set_timeline(boost::shared_ptr<Timeline> timeline)
+{
+  m_timeline = timeline;
+}
+
+#ifdef __TEST__
+
+#include <gtkmm/main.h>
+#include <gtkmm/window.h>
+#include <gtkmm/liststore.h>
+#include <gtkmm/treeview.h>
+#include <gtkmm/box.h>
+#include <gtkmm/adjustment.h>
+#include <gtkmm/table.h>
+#include <gtkmm/ruler.h>
+#include <gtkmm/scrollbar.h>
+
+class TimelineLayerColumns : public Gtk::TreeModel::ColumnRecord
+{
+public:
+  Gtk::TreeModelColumn<Glib::ustring> m_name;
+
+public:
+  TimelineLayerColumns() :
+    m_name()
+  {
+    add(m_name);
+  }
+};
+
+int main(int argc, char** argv)
+{
+  Gtk::Main kit(argc, argv);
+
+  Gtk::Window win;
+  win.set_title("Timeline Test");
+  win.set_default_size(800, 400);
+
+  TimelineLayerColumns columns;
+  Gtk::HRuler hruler;
+  Gtk::TreeView treeview;
+  treeview.set_headers_visible(false);
+  //treeview.set_fixed_height_mode(true);
+  treeview.set_grid_lines(Gtk::TREE_VIEW_GRID_LINES_BOTH);
+  treeview.remove_all_columns();
+  treeview.append_column_editable("Name", columns.m_name);
+
+  Glib::RefPtr<Gtk::ListStore> liststore = Gtk::ListStore::create(columns);
+
+  for(int i = 0; i < 5; ++i)
+  {
+    Gtk::ListStore::iterator it = liststore->append();
+    std::ostringstream str;
+    str << "Hello World: " << i;
+    (*it)[columns.m_name] = str.str();
+  }
+
+  treeview.set_model(liststore);
+  treeview.set_size_request(200, -1);
+  treeview.set_reorderable();
+
+  Gtk::Table table;
+
+  //table.set_size_request(800, 400);
+
+  Gtk::Adjustment hadjustment(50, 0, 100);
+  Gtk::Adjustment vadjustment(50, 0, 100);
+
+  Gtk::VScrollbar vscroll(vadjustment);
+  Gtk::HScrollbar hscroll(hadjustment);
+   
+  boost::shared_ptr<Timeline> timeline(new Timeline());
+
+  timeline->add_layer("Layer1");
+  timeline->add_layer("Layer2");
+
+  TimelineWidget timeline_widget;
+  timeline_widget.set_timeline(timeline);
+
+  hruler.set_range(0, 100, 50, 100);
+
+  table.attach(hruler, 1, 2, 0, 1, Gtk::FILL, Gtk::FILL);
+
+  table.attach(treeview, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL);
+  table.attach(timeline_widget, 1, 2, 1, 2, Gtk::FILL|Gtk::EXPAND, Gtk::FILL|Gtk::EXPAND);
+  table.attach(hscroll, 1, 2, 2, 3, Gtk::FILL, Gtk::FILL);
+  table.attach(vscroll, 2, 3, 1, 2, Gtk::FILL, Gtk::FILL);
+  timeline_widget.show();
+
+  win.add(table);
+  win.show_all();
+
+  Gtk::Main::run(win);
+
+  return 0;
+}
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline_widget.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/timeline_widget.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_widget.hpp	2009-09-17 03:11:14 UTC (rev 3261)
+++ trunk/windstille/src/editor/timeline_widget.hpp	2009-09-25 19:39:15 UTC (rev 3262)
@@ -0,0 +1,58 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_EDITOR_TIMELINE_WIDGET_HPP
+#define HEADER_WINDSTILLE_EDITOR_TIMELINE_WIDGET_HPP
+
+#include <gtkmm/drawingarea.h>
+#include <boost/shared_ptr.hpp>
+
+#include "math/vector2f.hpp"
+
+class Timeline;
+
+class TimelineWidget : public Gtk::DrawingArea
+{
+private:
+  boost::shared_ptr<Timeline> m_timeline;
+
+  Vector2f down_pos;
+  Vector2f move_pos;
+
+public:
+  TimelineWidget();
+  ~TimelineWidget();
+
+  void set_timeline(boost::shared_ptr<Timeline> timeline);
+
+  bool mouse_down(GdkEventButton* ev);
+  bool mouse_up(GdkEventButton* ev);
+  bool mouse_move(GdkEventMotion* ev);
+
+protected:
+  //Override default signal handler:
+  virtual bool on_expose_event(GdkEventExpose* event);
+
+private:
+  TimelineWidget(const TimelineWidget&);
+  TimelineWidget& operator=(const TimelineWidget&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline_widget.hpp
___________________________________________________________________
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Sat Sep 26 01:37:40 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 26 Sep 2009 01:37:40 +0200
Subject: [Windstille-commit] r3263 - in trunk/windstille/src: editor
	properties
Message-ID: <200909252337.n8PNbelU019459@sheep.berlios.de>

Author: grumbel
Date: 2009-09-26 01:37:38 +0200 (Sat, 26 Sep 2009)
New Revision: 3263

Added:
   trunk/windstille/src/editor/animation_widget.cpp
   trunk/windstille/src/editor/animation_widget.hpp
   trunk/windstille/src/editor/timeline_anim_object.hpp
   trunk/windstille/src/editor/timeline_keyframe_object.hpp
   trunk/windstille/src/editor/timeline_sound_object.hpp
Modified:
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/timeline.hpp
   trunk/windstille/src/editor/timeline_layer.cpp
   trunk/windstille/src/editor/timeline_layer.hpp
   trunk/windstille/src/editor/timeline_object.hpp
   trunk/windstille/src/editor/timeline_widget.cpp
   trunk/windstille/src/editor/timeline_widget.hpp
   trunk/windstille/src/properties/property.hpp
Log:
Some more work on timeline widget

Added: trunk/windstille/src/editor/animation_widget.cpp
===================================================================
--- trunk/windstille/src/editor/animation_widget.cpp	2009-09-25 19:39:15 UTC (rev 3262)
+++ trunk/windstille/src/editor/animation_widget.cpp	2009-09-25 23:37:38 UTC (rev 3263)
@@ -0,0 +1,110 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "editor/animation_widget.hpp"
+
+#include <boost/shared_ptr.hpp>
+
+#include "editor/timeline_widget.hpp"
+#include "editor/timeline.hpp"
+#include "editor/timeline_object.hpp"
+#include "editor/timeline_anim_object.hpp"
+#include "editor/timeline_sound_object.hpp"
+#include "editor/timeline_keyframe_object.hpp"
+
+class TimelineLayerColumns : public Gtk::TreeModel::ColumnRecord
+{
+public:
+  Gtk::TreeModelColumn<Glib::ustring> m_name;
+
+public:
+  TimelineLayerColumns() :
+    m_name()
+  {
+    add(m_name);
+  }
+};
+
+AnimationWidget::AnimationWidget() :
+  hadjustment(50, 0, 100),
+  vadjustment(50, 0, 100),
+  hruler(),
+  treeview(),
+  table(),
+  vscroll(vadjustment),
+  hscroll(hadjustment)
+{
+  TimelineLayerColumns columns;
+  treeview.set_headers_visible(false);
+  //treeview.set_fixed_height_mode(true);
+  treeview.set_grid_lines(Gtk::TREE_VIEW_GRID_LINES_BOTH);
+  treeview.remove_all_columns();
+  treeview.append_column_editable("Name", columns.m_name);
+
+  Glib::RefPtr<Gtk::ListStore> liststore = Gtk::ListStore::create(columns);
+
+  for(int i = 0; i < 5; ++i)
+  {
+    Gtk::ListStore::iterator it = liststore->append();
+    std::ostringstream str;
+    str << "Hello World: " << i;
+    (*it)[columns.m_name] = str.str();
+  }
+
+  treeview.set_model(liststore);
+  treeview.set_size_request(200, -1);
+  treeview.set_reorderable();
+   
+  boost::shared_ptr<Timeline> timeline(new Timeline());
+
+  TimelineLayerHandle layer1 = timeline->add_layer("Layer1");
+  TimelineLayerHandle layer2 = timeline->add_layer("Layer2");
+  TimelineLayerHandle layer3 = timeline->add_layer("Layer3");
+  TimelineLayerHandle layer4 = timeline->add_layer("Layer4");
+
+  layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(20.0f, 30.0f, "anim1.anim")));
+  layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(60.0f, 30.0f, "anim2.anim")));
+
+  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(8.0f)));
+  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(10.0f)));
+  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(11.0f)));
+  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(15.0f)));
+  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(20.0f)));
+  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(35.0f)));
+  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(40.0f)));
+
+  layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(10.0f, 10.0f, "sound1.wav")));
+  layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(30.0f, 40.0f, "sound.wav")));
+
+  TimelineWidget timeline_widget;
+  timeline_widget.set_timeline(timeline);
+
+  hruler.set_range(0, 100, 50, 100);
+
+  table.attach(hruler, 1, 2, 0, 1, Gtk::FILL, Gtk::FILL);
+
+  table.attach(treeview, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL);
+  table.attach(timeline_widget, 1, 2, 1, 2, Gtk::FILL|Gtk::EXPAND, Gtk::FILL|Gtk::EXPAND);
+  table.attach(hscroll, 1, 2, 2, 3, Gtk::FILL, Gtk::FILL);
+  table.attach(vscroll, 2, 3, 1, 2, Gtk::FILL, Gtk::FILL);
+  timeline_widget.show();
+
+  add(table);
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/animation_widget.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/animation_widget.hpp
===================================================================
--- trunk/windstille/src/editor/animation_widget.hpp	2009-09-25 19:39:15 UTC (rev 3262)
+++ trunk/windstille/src/editor/animation_widget.hpp	2009-09-25 23:37:38 UTC (rev 3263)
@@ -0,0 +1,55 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_ANIMATION_WIDGET_HPP
+#define HEADER_WINDSTILLE_ANIMATION_WIDGET_HPP
+
+#include <gtkmm/adjustment.h>
+#include <gtkmm/box.h>
+#include <gtkmm/box.h>
+#include <gtkmm/liststore.h>
+#include <gtkmm/main.h>
+#include <gtkmm/ruler.h>
+#include <gtkmm/scrollbar.h>
+#include <gtkmm/table.h>
+#include <gtkmm/treeview.h>
+#include <gtkmm/window.h>
+
+class AnimationWidget : public Gtk::VBox
+{
+private:
+  Gtk::Adjustment hadjustment;
+  Gtk::Adjustment vadjustment;
+
+  Gtk::HRuler     hruler;
+  Gtk::TreeView   treeview;
+  Gtk::Table      table;
+  Gtk::VScrollbar vscroll;
+  Gtk::HScrollbar hscroll;
+
+public:
+  AnimationWidget();
+
+private:
+  AnimationWidget(const AnimationWidget&);
+  AnimationWidget& operator=(const AnimationWidget&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/animation_widget.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-25 19:39:15 UTC (rev 3262)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-25 23:37:38 UTC (rev 3263)
@@ -16,6 +16,8 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
+#include "editor/editor_window.hpp"
+
 #include <fstream>
 #include <iostream>
 #include <gdkmm/pixbuf.h>
@@ -42,7 +44,12 @@
 #include "editor/layer_widget.hpp"
 #include "editor/document.hpp"
 
-#include "editor/editor_window.hpp"
+#include "editor/timeline.hpp"
+#include "editor/timeline_widget.hpp"
+#include "editor/timeline_object.hpp"
+#include "editor/timeline_anim_object.hpp"
+#include "editor/timeline_sound_object.hpp"
+#include "editor/timeline_keyframe_object.hpp"
 
 EditorWindow::EditorWindow(const Glib::RefPtr<const Gdk::GL::Config>& glconfig_)
   : vbox(),
@@ -450,7 +457,38 @@
 {
   // FIXME: We abuse the minimap as our root GLContext
   WindstilleWidget* wst = Gtk::manage(new WindstilleWidget(*this, glconfig, minimap_widget.get_gl_context()));
+  if (0)
+  {
+    Gtk::VBox* n_vbox = Gtk::manage(new Gtk::VBox);
+    n_vbox->add(*wst);
+    {
+      boost::shared_ptr<Timeline> timeline(new Timeline);
 
+      TimelineLayerHandle layer1 = timeline->add_layer("Layer1");
+      TimelineLayerHandle layer2 = timeline->add_layer("Layer2");
+      TimelineLayerHandle layer3 = timeline->add_layer("Layer3");
+      TimelineLayerHandle layer4 = timeline->add_layer("Layer4");
+
+      layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(20.0f, 30.0f, "anim1.anim")));
+      layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(60.0f, 30.0f, "anim2.anim")));
+
+      layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(8.0f)));
+      layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(10.0f)));
+      layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(11.0f)));
+      layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(15.0f)));
+      layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(20.0f)));
+      layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(35.0f)));
+      layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(40.0f)));
+
+      layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(10.0f, 10.0f, "sound1.wav")));
+      layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(30.0f, 40.0f, "sound.wav")));
+
+      TimelineWidget* timeline_widget = Gtk::manage(new TimelineWidget());
+      timeline_widget->set_timeline(timeline);
+      n_vbox->add(*timeline_widget);
+    }
+  }
+
   Glib::ustring title = Glib::ustring::compose("Unsaved Sector %1", notebook.get_n_pages()+1);
   int new_page = notebook.append_page(*wst, title);
   wst->show();
@@ -798,7 +836,7 @@
   }
   else
   {
-    return static_cast<WindstilleWidget*>(notebook.get_nth_page(page));
+    return dynamic_cast<WindstilleWidget*>(notebook.get_nth_page(page));
   }
 }
 

Modified: trunk/windstille/src/editor/timeline.hpp
===================================================================
--- trunk/windstille/src/editor/timeline.hpp	2009-09-25 19:39:15 UTC (rev 3262)
+++ trunk/windstille/src/editor/timeline.hpp	2009-09-25 23:37:38 UTC (rev 3263)
@@ -26,12 +26,25 @@
 
 class Timeline
 {
+public:
+  typedef std::vector<TimelineLayerHandle> Layers;
+  typedef Layers::iterator iterator;
+  typedef Layers::const_iterator const_iterator;
+
 private:
-  std::vector<TimelineLayerHandle> m_layers;
+  Layers m_layers;
 
 public:
   Timeline();
 
+  iterator begin() { return m_layers.begin(); }
+  iterator end()   { return m_layers.end();   }
+
+  const_iterator begin() const { return m_layers.begin(); }
+  const_iterator end()   const { return m_layers.end();   }
+
+  int size() const { return static_cast<int>(m_layers.size()); }
+
   TimelineObjectHandle get_object(const Vector2f& pos) const;
   TimelineLayerHandle  get_layer(const Vector2f& pos) const;
 

Added: trunk/windstille/src/editor/timeline_anim_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_anim_object.hpp	2009-09-25 19:39:15 UTC (rev 3262)
+++ trunk/windstille/src/editor/timeline_anim_object.hpp	2009-09-25 23:37:38 UTC (rev 3263)
@@ -0,0 +1,51 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_TIMELINE_ANIM_OBJECT_HPP
+#define HEADER_WINDSTILLE_TIMELINE_ANIM_OBJECT_HPP
+
+#include <string>
+
+#include "editor/timeline_object.hpp"
+
+class TimelineAnimObject : public TimelineObject
+{
+private:
+  float m_pos;
+  float m_width;
+  std::string m_name;
+
+public:
+  TimelineAnimObject(float pos, float width, const std::string& name) :
+    m_pos(pos),
+    m_width(width),
+    m_name(name)
+  {}
+
+  float get_pos()   const { return m_pos; }
+  float get_width() const { return m_width; }
+  std::string get_name() const { return m_name; }
+
+private:
+  TimelineAnimObject(const TimelineAnimObject&);
+  TimelineAnimObject& operator=(const TimelineAnimObject&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline_anim_object.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/timeline_keyframe_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_keyframe_object.hpp	2009-09-25 19:39:15 UTC (rev 3262)
+++ trunk/windstille/src/editor/timeline_keyframe_object.hpp	2009-09-25 23:37:38 UTC (rev 3263)
@@ -0,0 +1,44 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_TIMELINE_KEYFRAME_OBJECT_HPP
+#define HEADER_WINDSTILLE_TIMELINE_KEYFRAME_OBJECT_HPP
+
+#include "editor/timeline_object.hpp"
+
+class TimelineKeyframeObject : public TimelineObject
+{
+private:
+  float m_pos; 
+
+public:
+  TimelineKeyframeObject(float pos) :
+    m_pos(pos)
+  {}
+
+  float get_pos()   const { return m_pos; }
+  float get_width() const { return 1.0f; }
+
+private:
+  TimelineKeyframeObject(const TimelineKeyframeObject&);
+  TimelineKeyframeObject& operator=(const TimelineKeyframeObject&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline_keyframe_object.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/editor/timeline_layer.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer.cpp	2009-09-25 19:39:15 UTC (rev 3262)
+++ trunk/windstille/src/editor/timeline_layer.cpp	2009-09-25 23:37:38 UTC (rev 3263)
@@ -27,6 +27,7 @@
 void
 TimelineLayer::add_object(TimelineObjectHandle object)
 {
+  m_objects.push_back(object);
 }
 
 TimelineObjectHandle

Modified: trunk/windstille/src/editor/timeline_layer.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer.hpp	2009-09-25 19:39:15 UTC (rev 3262)
+++ trunk/windstille/src/editor/timeline_layer.hpp	2009-09-25 23:37:38 UTC (rev 3263)
@@ -27,19 +27,28 @@
 
 class TimelineLayer
 {
+public:
+  typedef std::vector<TimelineObjectHandle> Objects;
+  typedef std::vector<TimelineObjectHandle>::iterator iterator;
+  typedef std::vector<TimelineObjectHandle>::const_iterator const_iterator;
+
 private:
   std::string m_name;
-  std::vector<TimelineObjectHandle> m_objects;
+  Objects m_objects;
 
 public:
   TimelineLayer(const std::string& name);
 
+  iterator begin() { return m_objects.begin(); }
+  iterator end()   { return m_objects.end();   }
+
+  const_iterator begin() const { return m_objects.begin(); }
+  const_iterator end()   const { return m_objects.end();   }
+
   void add_object(TimelineObjectHandle object);
 
   TimelineObjectHandle get_object(float pos) const;
 
-  void draw();
-
 private:
   TimelineLayer(const TimelineLayer&);
   TimelineLayer& operator=(const TimelineLayer&);

Modified: trunk/windstille/src/editor/timeline_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_object.hpp	2009-09-25 19:39:15 UTC (rev 3262)
+++ trunk/windstille/src/editor/timeline_object.hpp	2009-09-25 23:37:38 UTC (rev 3263)
@@ -25,10 +25,11 @@
 {
 private:
 public:
-  TimelineObject();
+  TimelineObject() {}
+  virtual ~TimelineObject() {}
 
-  float get_pos() const;
-  float get_width() const;
+  virtual float get_pos() const =0;
+  virtual float get_width() const =0;
 
 private:
   TimelineObject(const TimelineObject&);

Added: trunk/windstille/src/editor/timeline_sound_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_sound_object.hpp	2009-09-25 19:39:15 UTC (rev 3262)
+++ trunk/windstille/src/editor/timeline_sound_object.hpp	2009-09-25 23:37:38 UTC (rev 3263)
@@ -0,0 +1,49 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_TIMELINE_SOUND_OBJECT_HPP
+#define HEADER_WINDSTILLE_TIMELINE_SOUND_OBJECT_HPP
+
+#include "editor/timeline_object.hpp"
+
+class TimelineSoundObject : public TimelineObject
+{
+private:
+  float m_pos;
+  float m_width;
+  std::string m_name;
+
+public:
+  TimelineSoundObject(float pos, float width, const std::string& name) :
+    m_pos(pos),
+    m_width(width),
+    m_name(name)
+  {}
+
+  float get_pos()   const { return m_pos; }
+  float get_width() const { return m_width; }
+  std::string get_name() const { return m_name; }
+
+private:
+  TimelineSoundObject(const TimelineSoundObject&);
+  TimelineSoundObject& operator=(const TimelineSoundObject&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline_sound_object.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/editor/timeline_widget.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_widget.cpp	2009-09-25 19:39:15 UTC (rev 3262)
+++ trunk/windstille/src/editor/timeline_widget.cpp	2009-09-25 23:37:38 UTC (rev 3263)
@@ -19,11 +19,19 @@
 #include "editor/timeline_widget.hpp"
 
 #include <iostream>
+#include <sstream>
 
+#include "math/rect.hpp"
 #include "editor/timeline.hpp"
+#include "editor/timeline_object.hpp"
+#include "editor/timeline_anim_object.hpp"
+#include "editor/timeline_sound_object.hpp"
+#include "editor/timeline_keyframe_object.hpp"
 
 TimelineWidget::TimelineWidget() :
   m_timeline(),
+  m_selection(),
+  is_mouse_down(false),
   down_pos(),
   move_pos()
 {
@@ -43,23 +51,35 @@
 bool
 TimelineWidget::mouse_down(GdkEventButton* ev)
 {
-  down_pos.x = static_cast<float>(ev->x);
-  down_pos.y = static_cast<float>(ev->y);
+  if (ev->button == 1)
+  {
+    is_mouse_down = true;
+    down_pos.x = static_cast<float>(ev->x);
+    down_pos.y = static_cast<float>(ev->y);
+  }
   return false;
 }
 
 bool
 TimelineWidget::mouse_up(GdkEventButton* ev)
 {
+  if (ev->button == 1)
+  {
+    is_mouse_down = false;
+    queue_draw();
+  }
   return false;
 }
 
 bool
 TimelineWidget::mouse_move(GdkEventMotion* ev)
 {
-  move_pos.x = static_cast<float>(ev->x);
-  move_pos.y = static_cast<float>(ev->y);
-  queue_draw();
+  if (is_mouse_down)
+  {
+    move_pos.x = static_cast<float>(ev->x);
+    move_pos.y = static_cast<float>(ev->y);
+    queue_draw();
+  }
   return false;
 }
 
@@ -72,7 +92,7 @@
 
     Cairo::RefPtr<Cairo::Context> cr = window->create_cairo_context();
 
-    std::cout << "on_expose_event: " << allocation.get_width() << "x" << allocation.get_height() << std::endl;
+    //std::cout << "on_expose_event: " << allocation.get_width() << "x" << allocation.get_height() << std::endl;
 
     if (1) // pixel perfect drawing
       cr->translate(0.5, 0.5);
@@ -83,122 +103,201 @@
                   ev->area.width, ev->area.height);
     cr->clip();
 
-    cr->set_source_rgb(1,1,1);
-    cr->rectangle(0, 0, allocation.get_width(), 32*4);
-    cr->fill();
+    draw_timeline(cr);
 
     cr->set_line_width(0.5);
     cr->set_source_rgb(0,0,0);
-    // draw grid
-    for(int y = 0; y < allocation.get_height(); y += 32)
-    {
-      cr->move_to(0, y);
-      cr->line_to(allocation.get_width(), y);
 
-      if (0)
-        for(int x = 0; x < allocation.get_width(); x += 8)
-        {
-          cr->move_to(x, y - 3);
-          cr->line_to(x, y + 3);
-        }
-    }
-    cr->stroke();
+    cr->set_line_width(1.0);
 
-    cr->set_source_rgba(0,0,0, 0.25);
-    for(int x = 0; x < allocation.get_width(); x += 8)
-    {
-      if (x % 80)
-      {
-        cr->move_to(x, 0);
-        cr->line_to(x, allocation.get_height());
-      }
-    }
+    draw_select_rectangle(cr);
+  }
+
+  return true;
+}
+
+void
+TimelineWidget::draw_select_rectangle(Cairo::RefPtr<Cairo::Context> cr)
+{
+  // Select rectangle
+  if (is_mouse_down)
+  {
+    //Rectf rect(down_pos, move_pos - down_pos);
+    //rect.normalize();
+
+    cr->set_source_rgba(0,0,1,0.25);
+    cr->rectangle(down_pos.x, down_pos.y,
+                  move_pos.x - down_pos.x,
+                  move_pos.y - down_pos.y);
+    cr->fill();
+
+    cr->set_source_rgb(0,0,1);
+    cr->rectangle(down_pos.x, down_pos.y,
+                  move_pos.x - down_pos.x,
+                  move_pos.y - down_pos.y);
     cr->stroke();
+  }
+}
 
-    cr->set_source_rgba(0,0,0, 0.75);
-    for(int x = 0; x < allocation.get_width(); x += 8)
+void
+TimelineWidget::draw_grid(Cairo::RefPtr<Cairo::Context> cr)
+{
+  Gtk::Allocation allocation = get_allocation();
+
+  cr->save();
+  
+  int height = m_timeline->size() * 32;
+
+  // draw vertical lines
+  cr->set_source_rgb(0.875, 0.875, 0.875);
+  for(int x = 0; x < allocation.get_width(); x += 8)
+  {
+    if (x % 80 == 0)
     {
-      if (!(x % 80))
-      {
-        cr->move_to(x, 0);
-        cr->line_to(x, allocation.get_height());
-      }
+      cr->rectangle(x, 0, 8, height);
     }
-    cr->stroke();
+  }
+  cr->fill();
 
-    cr->set_line_width(1.0);
+  cr->set_line_width(1.0);
 
-    // draw keyframe
-    for(int x = 32; x < 128; x += 16)
+  // draw horizontal lines
+  cr->set_source_rgb(0.5, 0.5, 0.5);
+  for(int y = 0; y <= height; y += 32)
+  {
+    cr->move_to(0, y);
+    cr->line_to(allocation.get_width(), y);
+  }
+  cr->stroke();
+
+  // draw vertical lines
+  cr->set_source_rgb(0.75, 0.75, 0.75);
+  for(int x = 0; x < allocation.get_width(); x += 8)
+  {
+      cr->move_to(x, 0);
+      cr->line_to(x, height);
+  }
+  cr->stroke();
+
+  cr->restore();
+}
+
+void
+TimelineWidget::draw_timeline(Cairo::RefPtr<Cairo::Context> cr)
+{
+  Gtk::Allocation allocation = get_allocation();
+
+  cr->save();
+
+  cr->set_source_rgb(1,1,1);
+  cr->rectangle(0, 0, allocation.get_width(), 32 * m_timeline->size());
+  cr->fill();
+  
+  draw_grid(cr);
+
+  cr->save();
+  for(Timeline::iterator i = m_timeline->begin(); i != m_timeline->end(); ++i)
+  {
+    draw_timeline_layer(cr, *i);
+    cr->translate(0, 32);
+  }
+  cr->restore();
+
+  cr->restore();
+}
+
+void
+TimelineWidget::draw_timeline_layer(Cairo::RefPtr<Cairo::Context> cr,
+                                    TimelineLayerHandle layer)
+{
+  cr->save();
+
+  cr->set_line_width(1.0);
+
+  for(TimelineLayer::iterator i = layer->begin(); i != layer->end(); ++i)
+  {
+    if (boost::shared_ptr<TimelineKeyframeObject> keyframe =
+        boost::dynamic_pointer_cast<TimelineKeyframeObject>(*i))
     {
-      cr->set_source_rgb(0.0, 0.5, 0.75);
-      cr->rectangle(x, 32+4, 8, 24);
+      cr->set_source_rgb(0.5, 0.75, 0.0);
+      cr->rectangle(keyframe->get_pos()*8, 4, 8, 24);
       cr->fill();
 
       cr->set_source_rgb(0, 0, 0);
-      cr->rectangle(x, 32+4, 8, 24);
-      cr->stroke();
+      cr->rectangle(keyframe->get_pos()*8, 4, 8, 24);
+      cr->stroke();     
     }
-
-    // print some text
+    else if (boost::shared_ptr<TimelineAnimObject> anim =
+             boost::dynamic_pointer_cast<TimelineAnimObject>(*i))
     {
-      std::string text = "snd:Hello World!";
       Cairo::TextExtents extents;
 
       cr->select_font_face ("Sans", Cairo::FONT_SLANT_NORMAL, Cairo::FONT_WEIGHT_NORMAL);
       cr->set_font_size(12);
 
-      cr->get_text_extents(text, extents);
+      cr->get_text_extents(anim->get_name(), extents);
 
-      std::cout << extents.x_bearing << " "
-                << extents.y_bearing << " "
-                << extents.width << " "
-                << extents.height << " "
-                << extents.x_advance << " "
-                << extents.y_advance << " "
-                << std::endl;
+      if (0)
+        std::cout << extents.x_bearing << " "
+                  << extents.y_bearing << " "
+                  << extents.width << " "
+                  << extents.height << " "
+                  << extents.x_advance << " "
+                  << extents.y_advance << " "
+                  << std::endl;
 
-      double x_border = 16.0f;
-      double y_border = 4.0f;
       cr->set_source_rgb(0.0, 0.5, 0.75);
-      cr->rectangle(20  + extents.x_bearing - x_border, 
-                    118 + extents.y_bearing - y_border,
-                    extents.width  + 2*x_border,
-                    extents.height + 2*y_border);
+      cr->rectangle(anim->get_pos()*8,  4,
+                    anim->get_width()*8, 24);
       cr->fill();
 
       cr->set_source_rgb(0, 0, 0);
-      cr->rectangle(20  + extents.x_bearing - x_border, 
-                    118 + extents.y_bearing - y_border,
-                    extents.width  + 2*x_border,
-                    extents.height + 2*y_border);
+      cr->rectangle(anim->get_pos()*8, 4,
+                    anim->get_width()*8, 24);
       cr->stroke();
 
       cr->set_source_rgb(1,1,1);
-      cr->move_to(20,118);
-      cr->show_text(text);
+      cr->move_to((anim->get_pos() + anim->get_width()/2)*8 - extents.width/2, 
+                  20);
+      cr->show_text(anim->get_name());
     }
+    else if (boost::shared_ptr<TimelineSoundObject> sound =
+             boost::dynamic_pointer_cast<TimelineSoundObject>(*i))
+    {
+      Cairo::TextExtents extents;
 
-  std::cout << "down: " << down_pos << std::endl;
-  std::cout << "move: " << move_pos << std::endl;
+      cr->select_font_face ("Sans", Cairo::FONT_SLANT_NORMAL, Cairo::FONT_WEIGHT_NORMAL);
+      cr->set_font_size(12);
 
-    // Select rectangle
-    {
-      cr->set_source_rgba(0,0,1,0.25);
-      cr->rectangle(down_pos.x, down_pos.y,
-                    move_pos.x - down_pos.x,
-                    move_pos.y - down_pos.y);
+      cr->get_text_extents(sound->get_name(), extents);
+
+      if (0)
+        std::cout << extents.x_bearing << " "
+                  << extents.y_bearing << " "
+                  << extents.width << " "
+                  << extents.height << " "
+                  << extents.x_advance << " "
+                  << extents.y_advance << " "
+                  << std::endl;
+
+      cr->set_source_rgb(0.75, 0.0, 0.5);
+      cr->rectangle(sound->get_pos()*8,  4,
+                    sound->get_width()*8, 24);
       cr->fill();
 
-      cr->set_source_rgb(0,0,1);
-      cr->rectangle(down_pos.x, down_pos.y,
-                    move_pos.x - down_pos.x,
-                    move_pos.y - down_pos.y);
+      cr->set_source_rgb(0, 0, 0);
+      cr->rectangle(sound->get_pos()*8, 4,
+                    sound->get_width()*8, 24);
       cr->stroke();
+
+      cr->set_source_rgb(1,1,1);
+      cr->move_to((sound->get_pos() + sound->get_width()/2)*8 - extents.width/2, 
+                  20);
+      cr->show_text(sound->get_name());
     }
   }
-
-  return true;
+  
+  cr->restore();
 }
 
 void
@@ -275,9 +374,25 @@
    
   boost::shared_ptr<Timeline> timeline(new Timeline());
 
-  timeline->add_layer("Layer1");
-  timeline->add_layer("Layer2");
+  TimelineLayerHandle layer1 = timeline->add_layer("Layer1");
+  TimelineLayerHandle layer2 = timeline->add_layer("Layer2");
+  TimelineLayerHandle layer3 = timeline->add_layer("Layer3");
+  TimelineLayerHandle layer4 = timeline->add_layer("Layer4");
 
+  layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(20.0f, 30.0f, "anim1.anim")));
+  layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(60.0f, 30.0f, "anim2.anim")));
+
+  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(8.0f)));
+  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(10.0f)));
+  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(11.0f)));
+  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(15.0f)));
+  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(20.0f)));
+  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(35.0f)));
+  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(40.0f)));
+
+  layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(10.0f, 10.0f, "sound1.wav")));
+  layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(30.0f, 40.0f, "sound.wav")));
+
   TimelineWidget timeline_widget;
   timeline_widget.set_timeline(timeline);
 

Modified: trunk/windstille/src/editor/timeline_widget.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_widget.hpp	2009-09-25 19:39:15 UTC (rev 3262)
+++ trunk/windstille/src/editor/timeline_widget.hpp	2009-09-25 23:37:38 UTC (rev 3263)
@@ -21,7 +21,9 @@
 
 #include <gtkmm/drawingarea.h>
 #include <boost/shared_ptr.hpp>
+#include <set>
 
+#include "editor/timeline_layer.hpp"
 #include "math/vector2f.hpp"
 
 class Timeline;
@@ -30,7 +32,9 @@
 {
 private:
   boost::shared_ptr<Timeline> m_timeline;
+  std::set<TimelineObjectHandle> m_selection;
 
+  bool     is_mouse_down;
   Vector2f down_pos;
   Vector2f move_pos;
 
@@ -49,6 +53,13 @@
   virtual bool on_expose_event(GdkEventExpose* event);
 
 private:
+  void draw_select_rectangle(Cairo::RefPtr<Cairo::Context> cr);
+  void draw_grid(Cairo::RefPtr<Cairo::Context> cr);
+  void draw_timeline(Cairo::RefPtr<Cairo::Context> cr);
+  void draw_timeline_layer(Cairo::RefPtr<Cairo::Context> cr,
+                           TimelineLayerHandle layer);
+
+private:
   TimelineWidget(const TimelineWidget&);
   TimelineWidget& operator=(const TimelineWidget&);
 };

Modified: trunk/windstille/src/properties/property.hpp
===================================================================
--- trunk/windstille/src/properties/property.hpp	2009-09-25 19:39:15 UTC (rev 3262)
+++ trunk/windstille/src/properties/property.hpp	2009-09-25 23:37:38 UTC (rev 3263)
@@ -31,8 +31,8 @@
   {}
   virtual ~Property() {}
 
-  virtual bool&   get_bool(void* obj) const = 0;
-  virtual int&   get_int(void* obj) const = 0;
+  virtual bool&  get_bool(void* obj)  const = 0;
+  virtual int&   get_int(void* obj)   const = 0;
   virtual float& get_float(void* obj) const = 0;
 
 private:



From grumbel at mail.berlios.de  Sat Sep 26 16:12:43 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 26 Sep 2009 16:12:43 +0200
Subject: [Windstille-commit] r3264 - trunk/windstille/src/editor
Message-ID: <200909261412.n8QEChDI018327@sheep.berlios.de>

Author: grumbel
Date: 2009-09-26 16:12:43 +0200 (Sat, 26 Sep 2009)
New Revision: 3264

Added:
   trunk/windstille/src/editor/timeline_layer_widget.cpp
   trunk/windstille/src/editor/timeline_layer_widget.hpp
Log:
Replaced TreeView with custom widget

Added: trunk/windstille/src/editor/timeline_layer_widget.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer_widget.cpp	2009-09-25 23:37:38 UTC (rev 3263)
+++ trunk/windstille/src/editor/timeline_layer_widget.cpp	2009-09-26 14:12:43 UTC (rev 3264)
@@ -0,0 +1,78 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "timeline_layer_widget.hpp"
+
+TimelineLayerWidget::TimelineLayerWidget() :
+  m_timeline()
+{
+}
+
+bool
+TimelineLayerWidget::on_expose_event(GdkEventExpose* ev)
+{
+  if (!m_timeline)
+    return false;
+
+  if (Glib::RefPtr<Gdk::Window> window = get_window())
+  {
+    Gtk::Allocation allocation = get_allocation();
+
+    Cairo::RefPtr<Cairo::Context> cr = window->create_cairo_context();
+
+    // clip to the area indicated by the expose event so that we only redraw
+    // the portion of the window that needs to be redrawn
+    cr->rectangle(ev->area.x,     ev->area.y,
+                  ev->area.width, ev->area.height);
+    cr->clip();
+
+    if (1) // pixel perfect drawing
+      cr->translate(0.5, 0.5);
+
+    cr->select_font_face ("Sans", Cairo::FONT_SLANT_NORMAL, Cairo::FONT_WEIGHT_NORMAL);
+    cr->set_font_size(12);
+
+    cr->set_line_width(1.0);
+
+    Cairo::TextExtents extents;
+    for(Timeline::iterator i = m_timeline->begin(); i != m_timeline->end(); ++i)
+    {
+      cr->get_text_extents((*i)->get_name(), extents);
+
+      cr->set_source_rgb(1,1,1);
+      cr->rectangle(0, 32 * (i - m_timeline->begin()),
+                    allocation.get_width(), 32);
+      cr->fill();
+
+      // draw text
+      cr->set_source_rgb(0,0,0);
+      cr->move_to(8, 10 + 32 * (i - m_timeline->begin()) - extents.y_bearing);
+      cr->show_text((*i)->get_name());
+
+      // draw line
+      cr->set_source_rgb(0,0,0);
+      cr->move_to(0, 32 + 32 * (i - m_timeline->begin()));
+      cr->line_to(allocation.get_width(), 32+ 32 * (i - m_timeline->begin()));
+      cr->stroke();
+    }
+  }
+
+  return false;
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline_layer_widget.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/timeline_layer_widget.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer_widget.hpp	2009-09-25 23:37:38 UTC (rev 3263)
+++ trunk/windstille/src/editor/timeline_layer_widget.hpp	2009-09-26 14:12:43 UTC (rev 3264)
@@ -0,0 +1,44 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_EDITOR_TIMELINE_LAYER_WIDGET_HPP
+#define HEADER_WINDSTILLE_EDITOR_TIMELINE_LAYER_WIDGET_HPP
+
+#include <gtkmm/drawingarea.h>
+
+#include "editor/timeline.hpp"
+
+class TimelineLayerWidget : public Gtk::DrawingArea
+{
+private:
+  TimelineHandle m_timeline;
+
+public:
+  TimelineLayerWidget();
+
+  virtual bool on_expose_event(GdkEventExpose* event);
+  void set_timeline(TimelineHandle timeline) { m_timeline = timeline; }
+
+private:
+  TimelineLayerWidget(const TimelineLayerWidget&);
+  TimelineLayerWidget& operator=(const TimelineLayerWidget&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline_layer_widget.hpp
___________________________________________________________________
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Sat Sep 26 16:24:39 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 26 Sep 2009 16:24:39 +0200
Subject: [Windstille-commit] r3265 - trunk/windstille/src/editor
Message-ID: <200909261424.n8QEOdT8019250@sheep.berlios.de>

Author: grumbel
Date: 2009-09-26 16:24:37 +0200 (Sat, 26 Sep 2009)
New Revision: 3265

Modified:
   trunk/windstille/src/editor/animation_widget.cpp
   trunk/windstille/src/editor/animation_widget.hpp
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/timeline.cpp
   trunk/windstille/src/editor/timeline.hpp
   trunk/windstille/src/editor/timeline_anim_object.hpp
   trunk/windstille/src/editor/timeline_keyframe_object.hpp
   trunk/windstille/src/editor/timeline_layer.cpp
   trunk/windstille/src/editor/timeline_layer.hpp
   trunk/windstille/src/editor/timeline_object.hpp
   trunk/windstille/src/editor/timeline_sound_object.hpp
   trunk/windstille/src/editor/timeline_widget.cpp
   trunk/windstille/src/editor/timeline_widget.hpp
Log:
Added some basic drag&drop to the TimelineWidget

Modified: trunk/windstille/src/editor/animation_widget.cpp
===================================================================
--- trunk/windstille/src/editor/animation_widget.cpp	2009-09-26 14:12:43 UTC (rev 3264)
+++ trunk/windstille/src/editor/animation_widget.cpp	2009-09-26 14:24:37 UTC (rev 3265)
@@ -21,61 +21,72 @@
 #include <boost/shared_ptr.hpp>
 
 #include "editor/timeline_widget.hpp"
-#include "editor/timeline.hpp"
 #include "editor/timeline_object.hpp"
 #include "editor/timeline_anim_object.hpp"
 #include "editor/timeline_sound_object.hpp"
 #include "editor/timeline_keyframe_object.hpp"
 
-class TimelineLayerColumns : public Gtk::TreeModel::ColumnRecord
-{
-public:
-  Gtk::TreeModelColumn<Glib::ustring> m_name;
-
-public:
-  TimelineLayerColumns() :
-    m_name()
-  {
-    add(m_name);
-  }
-};
-
 AnimationWidget::AnimationWidget() :
   hadjustment(50, 0, 100),
   vadjustment(50, 0, 100),
   hruler(),
+  scrolled(),
   treeview(),
   table(),
   vscroll(vadjustment),
-  hscroll(hadjustment)
+  hscroll(hadjustment),
+  m_timeline_widget(),
+  m_timeline_layer_widget(),
+  m_timeline()
 {
-  TimelineLayerColumns columns;
-  treeview.set_headers_visible(false);
-  //treeview.set_fixed_height_mode(true);
-  treeview.set_grid_lines(Gtk::TREE_VIEW_GRID_LINES_BOTH);
-  treeview.remove_all_columns();
-  treeview.append_column_editable("Name", columns.m_name);
+  hruler.set_range(0, 100, 50, 100);
 
-  Glib::RefPtr<Gtk::ListStore> liststore = Gtk::ListStore::create(columns);
+  table.attach(hruler, 1, 2, 0, 1, Gtk::FILL, Gtk::FILL);
 
-  for(int i = 0; i < 5; ++i)
-  {
-    Gtk::ListStore::iterator it = liststore->append();
-    std::ostringstream str;
-    str << "Hello World: " << i;
-    (*it)[columns.m_name] = str.str();
-  }
+  scrolled.set_policy(Gtk::POLICY_AUTOMATIC, Gtk::POLICY_NEVER);
+  scrolled.add(treeview);
 
-  treeview.set_model(liststore);
-  treeview.set_size_request(200, -1);
-  treeview.set_reorderable();
-   
+  m_timeline_layer_widget.set_size_request(140, -1);
+
+  table.attach(m_timeline_layer_widget, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL);
+  table.attach(m_timeline_widget, 1, 2, 1, 2, Gtk::FILL|Gtk::EXPAND, Gtk::FILL|Gtk::EXPAND);
+  table.attach(hscroll, 1, 2, 2, 3, Gtk::FILL, Gtk::FILL);
+  table.attach(vscroll, 2, 3, 1, 2, Gtk::FILL, Gtk::FILL);
+
+  add(table);
+}
+
+void
+AnimationWidget::set_timeline(TimelineHandle timeline)
+{
+  m_timeline = timeline;
+  m_timeline_widget.set_timeline(timeline);
+  m_timeline_layer_widget.set_timeline(timeline);
+}
+
+#ifdef __TEST__
+
+#include <gtkmm/main.h>
+#include <gtkmm/window.h>
+#include <gtkmm/liststore.h>
+#include <gtkmm/treeview.h>
+#include <gtkmm/box.h>
+#include <gtkmm/adjustment.h>
+#include <gtkmm/table.h>
+#include <gtkmm/ruler.h>
+#include <gtkmm/scrollbar.h>
+
+int main(int argc, char** argv)
+{
+  Gtk::Main kit(argc, argv);
+
+  // create test timeline  
   boost::shared_ptr<Timeline> timeline(new Timeline());
 
-  TimelineLayerHandle layer1 = timeline->add_layer("Layer1");
-  TimelineLayerHandle layer2 = timeline->add_layer("Layer2");
-  TimelineLayerHandle layer3 = timeline->add_layer("Layer3");
-  TimelineLayerHandle layer4 = timeline->add_layer("Layer4");
+  TimelineLayerHandle layer1 = timeline->add_layer("DoorLeft:pos");
+  TimelineLayerHandle layer2 = timeline->add_layer("DoorRight:pos");
+  TimelineLayerHandle layer3 = timeline->add_layer("AnimaitonLayer1");
+  TimelineLayerHandle layer4 = timeline->add_layer("SoundLayer2");
 
   layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(20.0f, 30.0f, "anim1.anim")));
   layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(60.0f, 30.0f, "anim2.anim")));
@@ -91,20 +102,21 @@
   layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(10.0f, 10.0f, "sound1.wav")));
   layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(30.0f, 40.0f, "sound.wav")));
 
-  TimelineWidget timeline_widget;
-  timeline_widget.set_timeline(timeline);
+  // create the window
+  Gtk::Window win;
+  win.set_title("Timeline Test");
+  win.set_default_size(800, 400);
 
-  hruler.set_range(0, 100, 50, 100);
+  AnimationWidget animation_widget;
+  animation_widget.set_timeline(timeline);
+  win.add(animation_widget);
+  win.show_all();
 
-  table.attach(hruler, 1, 2, 0, 1, Gtk::FILL, Gtk::FILL);
+  Gtk::Main::run(win);
 
-  table.attach(treeview, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL);
-  table.attach(timeline_widget, 1, 2, 1, 2, Gtk::FILL|Gtk::EXPAND, Gtk::FILL|Gtk::EXPAND);
-  table.attach(hscroll, 1, 2, 2, 3, Gtk::FILL, Gtk::FILL);
-  table.attach(vscroll, 2, 3, 1, 2, Gtk::FILL, Gtk::FILL);
-  timeline_widget.show();
-
-  add(table);
+  return 0;
 }
 
+#endif
+
 /* EOF */

Modified: trunk/windstille/src/editor/animation_widget.hpp
===================================================================
--- trunk/windstille/src/editor/animation_widget.hpp	2009-09-26 14:12:43 UTC (rev 3264)
+++ trunk/windstille/src/editor/animation_widget.hpp	2009-09-26 14:24:37 UTC (rev 3265)
@@ -29,7 +29,12 @@
 #include <gtkmm/table.h>
 #include <gtkmm/treeview.h>
 #include <gtkmm/window.h>
+#include <gtkmm/scrolledwindow.h>
 
+#include "editor/timeline.hpp"
+#include "editor/timeline_widget.hpp"
+#include "editor/timeline_layer_widget.hpp"
+
 class AnimationWidget : public Gtk::VBox
 {
 private:
@@ -37,14 +42,21 @@
   Gtk::Adjustment vadjustment;
 
   Gtk::HRuler     hruler;
+  Gtk::ScrolledWindow scrolled;
   Gtk::TreeView   treeview;
   Gtk::Table      table;
   Gtk::VScrollbar vscroll;
   Gtk::HScrollbar hscroll;
+  TimelineWidget  m_timeline_widget;
+  TimelineLayerWidget  m_timeline_layer_widget;
 
+  TimelineHandle m_timeline;
+
 public:
   AnimationWidget();
 
+  void set_timeline(TimelineHandle timeline);
+
 private:
   AnimationWidget(const AnimationWidget&);
   AnimationWidget& operator=(const AnimationWidget&);

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-26 14:12:43 UTC (rev 3264)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-26 14:24:37 UTC (rev 3265)
@@ -30,6 +30,7 @@
 #include <gtkmm/uimanager.h>
 #include <gtkmm/toolbar.h>
 #include <gtkmm/stock.h>
+#include <gtkmm/paned.h>
 #include <gtkmm/separatortoolitem.h>
 
 #include "display/scene_context.hpp"
@@ -45,6 +46,7 @@
 #include "editor/document.hpp"
 
 #include "editor/timeline.hpp"
+#include "editor/animation_widget.hpp"
 #include "editor/timeline_widget.hpp"
 #include "editor/timeline_object.hpp"
 #include "editor/timeline_anim_object.hpp"
@@ -456,42 +458,42 @@
 EditorWindow::on_new()
 {
   // FIXME: We abuse the minimap as our root GLContext
+  Gtk::VPaned* paned = Gtk::manage(new Gtk::VPaned);
   WindstilleWidget* wst = Gtk::manage(new WindstilleWidget(*this, glconfig, minimap_widget.get_gl_context()));
-  if (0)
-  {
-    Gtk::VBox* n_vbox = Gtk::manage(new Gtk::VBox);
-    n_vbox->add(*wst);
-    {
-      boost::shared_ptr<Timeline> timeline(new Timeline);
+  AnimationWidget* animation_widget = Gtk::manage(new AnimationWidget());
 
-      TimelineLayerHandle layer1 = timeline->add_layer("Layer1");
-      TimelineLayerHandle layer2 = timeline->add_layer("Layer2");
-      TimelineLayerHandle layer3 = timeline->add_layer("Layer3");
-      TimelineLayerHandle layer4 = timeline->add_layer("Layer4");
+  paned->pack1(*wst, Gtk::FILL|Gtk::EXPAND);
+  paned->pack2(*animation_widget, Gtk::FILL|Gtk::EXPAND);
+  paned->set_position(600);
 
-      layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(20.0f, 30.0f, "anim1.anim")));
-      layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(60.0f, 30.0f, "anim2.anim")));
+  { // FIXME: some random data for testing
+    boost::shared_ptr<Timeline> timeline(new Timeline);
 
-      layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(8.0f)));
-      layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(10.0f)));
-      layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(11.0f)));
-      layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(15.0f)));
-      layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(20.0f)));
-      layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(35.0f)));
-      layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(40.0f)));
+    TimelineLayerHandle layer1 = timeline->add_layer("Layer1");
+    TimelineLayerHandle layer2 = timeline->add_layer("Layer2");
+    TimelineLayerHandle layer3 = timeline->add_layer("Layer3");
+    TimelineLayerHandle layer4 = timeline->add_layer("Layer4");
 
-      layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(10.0f, 10.0f, "sound1.wav")));
-      layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(30.0f, 40.0f, "sound.wav")));
+    layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(20.0f, 30.0f, "anim1.anim")));
+    layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(60.0f, 30.0f, "anim2.anim")));
 
-      TimelineWidget* timeline_widget = Gtk::manage(new TimelineWidget());
-      timeline_widget->set_timeline(timeline);
-      n_vbox->add(*timeline_widget);
-    }
+    layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(8.0f)));
+    layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(10.0f)));
+    layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(11.0f)));
+    layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(15.0f)));
+    layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(20.0f)));
+    layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(35.0f)));
+    layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(40.0f)));
+
+    layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(10.0f, 10.0f, "sound1.wav")));
+    layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(30.0f, 40.0f, "sound.wav")));
+
+    animation_widget->set_timeline(timeline);
   }
 
   Glib::ustring title = Glib::ustring::compose("Unsaved Sector %1", notebook.get_n_pages()+1);
-  int new_page = notebook.append_page(*wst, title);
-  wst->show();
+  int new_page = notebook.append_page(*paned, title);
+  paned->show_all();
   notebook.set_current_page(new_page);
 
   layer_manager.set_model(&wst->get_document().get_sector_model());
@@ -836,7 +838,14 @@
   }
   else
   {
-    return dynamic_cast<WindstilleWidget*>(notebook.get_nth_page(page));
+    if (Gtk::VPaned* paned = dynamic_cast<Gtk::VPaned*>(notebook.get_nth_page(page)))
+    {
+      return dynamic_cast<WindstilleWidget*>(paned->get_child1());
+    }
+    else
+    {
+      return 0;
+    }
   }
 }
 

Modified: trunk/windstille/src/editor/timeline.cpp
===================================================================
--- trunk/windstille/src/editor/timeline.cpp	2009-09-26 14:12:43 UTC (rev 3264)
+++ trunk/windstille/src/editor/timeline.cpp	2009-09-26 14:24:37 UTC (rev 3265)
@@ -26,6 +26,20 @@
 }
 
 TimelineLayerHandle
+Timeline::get_layer(int n) const
+{
+  if (!m_layers.empty() &&
+      n >= 0 && n < static_cast<int>(m_layers.size()))
+  {
+    return m_layers[n];
+  }
+  else
+  {
+    return TimelineLayerHandle();
+  }
+}
+
+TimelineLayerHandle
 Timeline::add_layer(const std::string& name)
 {
   m_layers.push_back(TimelineLayerHandle(new TimelineLayer(name)));

Modified: trunk/windstille/src/editor/timeline.hpp
===================================================================
--- trunk/windstille/src/editor/timeline.hpp	2009-09-26 14:12:43 UTC (rev 3264)
+++ trunk/windstille/src/editor/timeline.hpp	2009-09-26 14:24:37 UTC (rev 3265)
@@ -44,10 +44,8 @@
   const_iterator end()   const { return m_layers.end();   }
 
   int size() const { return static_cast<int>(m_layers.size()); }
-
-  TimelineObjectHandle get_object(const Vector2f& pos) const;
-  TimelineLayerHandle  get_layer(const Vector2f& pos) const;
-
+  
+  TimelineLayerHandle get_layer(int n) const;
   TimelineLayerHandle add_layer(const std::string& name);
 
 private:
@@ -55,6 +53,8 @@
   Timeline& operator=(const Timeline&);
 };
 
+typedef boost::shared_ptr<Timeline> TimelineHandle;
+
 #endif
 
 /* EOF */

Modified: trunk/windstille/src/editor/timeline_anim_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_anim_object.hpp	2009-09-26 14:12:43 UTC (rev 3264)
+++ trunk/windstille/src/editor/timeline_anim_object.hpp	2009-09-26 14:24:37 UTC (rev 3265)
@@ -38,6 +38,7 @@
   {}
 
   float get_pos()   const { return m_pos; }
+  void  set_pos(float pos) { m_pos = pos; }
   float get_width() const { return m_width; }
   std::string get_name() const { return m_name; }
 

Modified: trunk/windstille/src/editor/timeline_keyframe_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_keyframe_object.hpp	2009-09-26 14:12:43 UTC (rev 3264)
+++ trunk/windstille/src/editor/timeline_keyframe_object.hpp	2009-09-26 14:24:37 UTC (rev 3265)
@@ -31,6 +31,7 @@
     m_pos(pos)
   {}
 
+  void  set_pos(float pos) { m_pos = pos; }
   float get_pos()   const { return m_pos; }
   float get_width() const { return 1.0f; }
 

Modified: trunk/windstille/src/editor/timeline_layer.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer.cpp	2009-09-26 14:12:43 UTC (rev 3264)
+++ trunk/windstille/src/editor/timeline_layer.cpp	2009-09-26 14:24:37 UTC (rev 3265)
@@ -16,8 +16,10 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
-#include "timeline_layer.hpp"
+#include "editor/timeline_layer.hpp"
 
+#include <assert.h>
+
 TimelineLayer::TimelineLayer(const std::string& name)
   : m_name(name),
     m_objects()
@@ -33,7 +35,35 @@
 TimelineObjectHandle
 TimelineLayer::get_object(float pos) const
 {
+  for(const_iterator i = begin(); i != end(); ++i)
+  {
+    if (pos >= (*i)->get_pos() &&
+        pos <  (*i)->get_pos() + (*i)->get_width())
+    {
+      return *i;
+    }
+  }
+
   return TimelineObjectHandle();
 }
 
+TimelineLayer::Objects
+TimelineLayer::get_objects(float selection_start, float selection_end) const
+{
+  assert(selection_start <= selection_end);
+
+  Objects objects;
+
+  for(const_iterator i = begin(); i != end(); ++i)
+  {
+    if (selection_start <= (*i)->get_pos() &&
+        selection_end   >  (*i)->get_pos() + (*i)->get_width())
+    {
+      objects.push_back(*i);
+    }
+  }
+
+  return objects;
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/timeline_layer.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer.hpp	2009-09-26 14:12:43 UTC (rev 3264)
+++ trunk/windstille/src/editor/timeline_layer.hpp	2009-09-26 14:24:37 UTC (rev 3265)
@@ -47,8 +47,11 @@
 
   void add_object(TimelineObjectHandle object);
 
+  Objects get_objects(float start, float end) const;
   TimelineObjectHandle get_object(float pos) const;
 
+  std::string get_name() const { return m_name; }
+
 private:
   TimelineLayer(const TimelineLayer&);
   TimelineLayer& operator=(const TimelineLayer&);

Modified: trunk/windstille/src/editor/timeline_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_object.hpp	2009-09-26 14:12:43 UTC (rev 3264)
+++ trunk/windstille/src/editor/timeline_object.hpp	2009-09-26 14:24:37 UTC (rev 3265)
@@ -30,6 +30,7 @@
 
   virtual float get_pos() const =0;
   virtual float get_width() const =0;
+  virtual void  set_pos(float pos) =0;
 
 private:
   TimelineObject(const TimelineObject&);

Modified: trunk/windstille/src/editor/timeline_sound_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_sound_object.hpp	2009-09-26 14:12:43 UTC (rev 3264)
+++ trunk/windstille/src/editor/timeline_sound_object.hpp	2009-09-26 14:24:37 UTC (rev 3265)
@@ -36,6 +36,7 @@
   {}
 
   float get_pos()   const { return m_pos; }
+  void  set_pos(float pos) { m_pos = pos; }
   float get_width() const { return m_width; }
   std::string get_name() const { return m_name; }
 

Modified: trunk/windstille/src/editor/timeline_widget.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_widget.cpp	2009-09-26 14:12:43 UTC (rev 3264)
+++ trunk/windstille/src/editor/timeline_widget.cpp	2009-09-26 14:24:37 UTC (rev 3265)
@@ -31,7 +31,7 @@
 TimelineWidget::TimelineWidget() :
   m_timeline(),
   m_selection(),
-  is_mouse_down(false),
+  m_mode(kNoMode),
   down_pos(),
   move_pos()
 {
@@ -53,9 +53,41 @@
 {
   if (ev->button == 1)
   {
-    is_mouse_down = true;
     down_pos.x = static_cast<float>(ev->x);
     down_pos.y = static_cast<float>(ev->y);
+    move_pos.x = static_cast<float>(ev->x);
+    move_pos.y = static_cast<float>(ev->y);
+
+    TimelineLayerHandle layer = m_timeline->get_layer(static_cast<int>(ev->y / 32));
+    if (layer)
+    {
+      TimelineObjectHandle obj = layer->get_object(static_cast<float>(ev->x / 8));
+      if (obj)
+      {
+        m_mode = kDragMode;
+
+        if (m_selection.find(obj) == m_selection.end())
+        {
+          if (!(ev->state & GDK_SHIFT_MASK))
+            m_selection.clear();
+
+          m_selection.insert(obj);
+        }
+        else
+        {
+          if (ev->state & GDK_SHIFT_MASK)
+          {
+            m_selection.erase(m_selection.find(obj));
+          }
+        }
+      }
+      else
+        m_mode = kSelectMode;
+    }
+    else
+    {
+      m_mode = kSelectMode;
+    }
   }
   return false;
 }
@@ -65,7 +97,28 @@
 {
   if (ev->button == 1)
   {
-    is_mouse_down = false;
+    if (m_mode == kSelectMode)
+    {
+      m_mode = kNoMode;
+
+      Rectf selection(down_pos, Vector2f(static_cast<float>(ev->x), static_cast<float>(ev->y)));
+      selection.normalize();
+
+      if (!(ev->state & GDK_SHIFT_MASK))
+        m_selection.clear();
+
+      add_to_selection(selection);
+    }
+    else if (m_mode == kDragMode)
+    {
+      m_mode = kNoMode;
+      for (std::set<TimelineObjectHandle>::iterator i = m_selection.begin(); 
+           i != m_selection.end(); ++i)
+      {
+        (*i)->set_pos((*i)->get_pos() + (move_pos.x - down_pos.x)/8);
+      }
+    }
+
     queue_draw();
   }
   return false;
@@ -74,15 +127,35 @@
 bool
 TimelineWidget::mouse_move(GdkEventMotion* ev)
 {
-  if (is_mouse_down)
+  if (m_mode == kSelectMode)
   {
     move_pos.x = static_cast<float>(ev->x);
     move_pos.y = static_cast<float>(ev->y);
     queue_draw();
   }
+  else if (m_mode == kDragMode)
+  {
+    move_pos.x = static_cast<float>(ev->x);
+    move_pos.y = static_cast<float>(ev->y);
+
+    queue_draw();
+  }
   return false;
 }
 
+void
+TimelineWidget::add_to_selection(const Rectf& selection)
+{
+  Timeline::iterator start = m_timeline->begin() + std::max(0, std::min(m_timeline->size(), static_cast<int>((selection.top+16)    / 32)));
+  Timeline::iterator end   = m_timeline->begin() + std::max(0, std::min(m_timeline->size(), static_cast<int>((selection.bottom+16) / 32)));
+
+  for(Timeline::iterator i = start; i != end; ++i)
+  {
+    const TimelineLayer::Objects& objects = (*i)->get_objects(selection.left / 8.0f, selection.right / 8.0f);
+    m_selection.insert(objects.begin(), objects.end());
+  }
+}
+
 bool
 TimelineWidget::on_expose_event(GdkEventExpose* ev)
 {
@@ -92,17 +165,15 @@
 
     Cairo::RefPtr<Cairo::Context> cr = window->create_cairo_context();
 
-    //std::cout << "on_expose_event: " << allocation.get_width() << "x" << allocation.get_height() << std::endl;
-
-    if (1) // pixel perfect drawing
-      cr->translate(0.5, 0.5);
-
     // clip to the area indicated by the expose event so that we only redraw
     // the portion of the window that needs to be redrawn
     cr->rectangle(ev->area.x,     ev->area.y,
                   ev->area.width, ev->area.height);
     cr->clip();
 
+    if (1) // pixel perfect drawing
+      cr->translate(0.5, 0.5);
+
     draw_timeline(cr);
 
     cr->set_line_width(0.5);
@@ -120,7 +191,7 @@
 TimelineWidget::draw_select_rectangle(Cairo::RefPtr<Cairo::Context> cr)
 {
   // Select rectangle
-  if (is_mouse_down)
+  if (m_mode == kSelectMode)
   {
     //Rectf rect(down_pos, move_pos - down_pos);
     //rect.normalize();
@@ -216,20 +287,42 @@
 
   for(TimelineLayer::iterator i = layer->begin(); i != layer->end(); ++i)
   {
+    bool in_selection = m_selection.find(*i) != m_selection.end();
+
     if (boost::shared_ptr<TimelineKeyframeObject> keyframe =
         boost::dynamic_pointer_cast<TimelineKeyframeObject>(*i))
     {
-      cr->set_source_rgb(0.5, 0.75, 0.0);
+      cr->save();
+        
+      if (in_selection)
+      {
+        cr->set_source_rgb(0.75, 1.0, 0.0);
+        if (m_mode == kDragMode)
+          cr->translate(move_pos.x - down_pos.x, 0.0);
+      }
+      else
+      {
+        cr->set_source_rgb(0.5, 0.75, 0.0);
+      }
+      
       cr->rectangle(keyframe->get_pos()*8, 4, 8, 24);
       cr->fill();
 
-      cr->set_source_rgb(0, 0, 0);
+      if (in_selection)
+        cr->set_source_rgb(0.25, 0.25, 0.25);
+      else
+        cr->set_source_rgb(0, 0, 0);
+
       cr->rectangle(keyframe->get_pos()*8, 4, 8, 24);
-      cr->stroke();     
+      cr->stroke();  
+      
+      cr->restore();
     }
     else if (boost::shared_ptr<TimelineAnimObject> anim =
              boost::dynamic_pointer_cast<TimelineAnimObject>(*i))
     {
+      cr->save();
+
       Cairo::TextExtents extents;
 
       cr->select_font_face ("Sans", Cairo::FONT_SLANT_NORMAL, Cairo::FONT_WEIGHT_NORMAL);
@@ -246,12 +339,30 @@
                   << extents.y_advance << " "
                   << std::endl;
 
-      cr->set_source_rgb(0.0, 0.5, 0.75);
+      if (in_selection)
+      {
+        cr->set_source_rgb(0.0, 0.75, 1.0);
+        if (m_mode == kDragMode)
+          cr->translate(move_pos.x - down_pos.x, 0.0);
+      }
+      else
+      {
+        cr->set_source_rgb(0.0, 0.5, 0.75);
+      }
+
       cr->rectangle(anim->get_pos()*8,  4,
                     anim->get_width()*8, 24);
       cr->fill();
 
-      cr->set_source_rgb(0, 0, 0);
+      if (in_selection)
+      {
+        cr->set_source_rgb(0.25, 0.25, 0.25);
+      }
+      else
+      {
+        cr->set_source_rgb(0, 0, 0);
+      }
+
       cr->rectangle(anim->get_pos()*8, 4,
                     anim->get_width()*8, 24);
       cr->stroke();
@@ -260,13 +371,17 @@
       cr->move_to((anim->get_pos() + anim->get_width()/2)*8 - extents.width/2, 
                   20);
       cr->show_text(anim->get_name());
+
+      cr->restore();
     }
     else if (boost::shared_ptr<TimelineSoundObject> sound =
              boost::dynamic_pointer_cast<TimelineSoundObject>(*i))
     {
+      cr->save();
+
       Cairo::TextExtents extents;
 
-      cr->select_font_face ("Sans", Cairo::FONT_SLANT_NORMAL, Cairo::FONT_WEIGHT_NORMAL);
+      cr->select_font_face("Sans", Cairo::FONT_SLANT_NORMAL, Cairo::FONT_WEIGHT_NORMAL);
       cr->set_font_size(12);
 
       cr->get_text_extents(sound->get_name(), extents);
@@ -280,7 +395,17 @@
                   << extents.y_advance << " "
                   << std::endl;
 
-      cr->set_source_rgb(0.75, 0.0, 0.5);
+      if (in_selection)
+      {
+        if (m_mode == kDragMode)
+          cr->translate(move_pos.x - down_pos.x, 0.0);
+        cr->set_source_rgb(1.0, 0.0, 0.75);
+      }
+      else
+      {
+        cr->set_source_rgb(0.75, 0.0, 0.5);
+      }
+
       cr->rectangle(sound->get_pos()*8,  4,
                     sound->get_width()*8, 24);
       cr->fill();
@@ -294,6 +419,8 @@
       cr->move_to((sound->get_pos() + sound->get_width()/2)*8 - extents.width/2, 
                   20);
       cr->show_text(sound->get_name());
+
+      cr->restore();
     }
   }
   
@@ -306,114 +433,4 @@
   m_timeline = timeline;
 }
 
-#ifdef __TEST__
-
-#include <gtkmm/main.h>
-#include <gtkmm/window.h>
-#include <gtkmm/liststore.h>
-#include <gtkmm/treeview.h>
-#include <gtkmm/box.h>
-#include <gtkmm/adjustment.h>
-#include <gtkmm/table.h>
-#include <gtkmm/ruler.h>
-#include <gtkmm/scrollbar.h>
-
-class TimelineLayerColumns : public Gtk::TreeModel::ColumnRecord
-{
-public:
-  Gtk::TreeModelColumn<Glib::ustring> m_name;
-
-public:
-  TimelineLayerColumns() :
-    m_name()
-  {
-    add(m_name);
-  }
-};
-
-int main(int argc, char** argv)
-{
-  Gtk::Main kit(argc, argv);
-
-  Gtk::Window win;
-  win.set_title("Timeline Test");
-  win.set_default_size(800, 400);
-
-  TimelineLayerColumns columns;
-  Gtk::HRuler hruler;
-  Gtk::TreeView treeview;
-  treeview.set_headers_visible(false);
-  //treeview.set_fixed_height_mode(true);
-  treeview.set_grid_lines(Gtk::TREE_VIEW_GRID_LINES_BOTH);
-  treeview.remove_all_columns();
-  treeview.append_column_editable("Name", columns.m_name);
-
-  Glib::RefPtr<Gtk::ListStore> liststore = Gtk::ListStore::create(columns);
-
-  for(int i = 0; i < 5; ++i)
-  {
-    Gtk::ListStore::iterator it = liststore->append();
-    std::ostringstream str;
-    str << "Hello World: " << i;
-    (*it)[columns.m_name] = str.str();
-  }
-
-  treeview.set_model(liststore);
-  treeview.set_size_request(200, -1);
-  treeview.set_reorderable();
-
-  Gtk::Table table;
-
-  //table.set_size_request(800, 400);
-
-  Gtk::Adjustment hadjustment(50, 0, 100);
-  Gtk::Adjustment vadjustment(50, 0, 100);
-
-  Gtk::VScrollbar vscroll(vadjustment);
-  Gtk::HScrollbar hscroll(hadjustment);
-   
-  boost::shared_ptr<Timeline> timeline(new Timeline());
-
-  TimelineLayerHandle layer1 = timeline->add_layer("Layer1");
-  TimelineLayerHandle layer2 = timeline->add_layer("Layer2");
-  TimelineLayerHandle layer3 = timeline->add_layer("Layer3");
-  TimelineLayerHandle layer4 = timeline->add_layer("Layer4");
-
-  layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(20.0f, 30.0f, "anim1.anim")));
-  layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(60.0f, 30.0f, "anim2.anim")));
-
-  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(8.0f)));
-  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(10.0f)));
-  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(11.0f)));
-  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(15.0f)));
-  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(20.0f)));
-  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(35.0f)));
-  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(40.0f)));
-
-  layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(10.0f, 10.0f, "sound1.wav")));
-  layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(30.0f, 40.0f, "sound.wav")));
-
-  TimelineWidget timeline_widget;
-  timeline_widget.set_timeline(timeline);
-
-  hruler.set_range(0, 100, 50, 100);
-
-  table.attach(hruler, 1, 2, 0, 1, Gtk::FILL, Gtk::FILL);
-
-  table.attach(treeview, 0, 1, 1, 2, Gtk::FILL, Gtk::FILL);
-  table.attach(timeline_widget, 1, 2, 1, 2, Gtk::FILL|Gtk::EXPAND, Gtk::FILL|Gtk::EXPAND);
-  table.attach(hscroll, 1, 2, 2, 3, Gtk::FILL, Gtk::FILL);
-  table.attach(vscroll, 2, 3, 1, 2, Gtk::FILL, Gtk::FILL);
-  timeline_widget.show();
-
-  win.add(table);
-  win.show_all();
-
-  Gtk::Main::run(win);
-
-  return 0;
-}
-
-#endif
-
 /* EOF */

Modified: trunk/windstille/src/editor/timeline_widget.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_widget.hpp	2009-09-26 14:12:43 UTC (rev 3264)
+++ trunk/windstille/src/editor/timeline_widget.hpp	2009-09-26 14:24:37 UTC (rev 3265)
@@ -23,10 +23,12 @@
 #include <boost/shared_ptr.hpp>
 #include <set>
 
+#include "editor/timeline.hpp"
 #include "editor/timeline_layer.hpp"
 #include "math/vector2f.hpp"
 
 class Timeline;
+class Rectf;
 
 class TimelineWidget : public Gtk::DrawingArea
 {
@@ -34,7 +36,7 @@
   boost::shared_ptr<Timeline> m_timeline;
   std::set<TimelineObjectHandle> m_selection;
 
-  bool     is_mouse_down;
+  enum { kNoMode, kSelectMode, kDragMode } m_mode;
   Vector2f down_pos;
   Vector2f move_pos;
 
@@ -42,7 +44,7 @@
   TimelineWidget();
   ~TimelineWidget();
 
-  void set_timeline(boost::shared_ptr<Timeline> timeline);
+  void set_timeline(TimelineHandle timeline);
 
   bool mouse_down(GdkEventButton* ev);
   bool mouse_up(GdkEventButton* ev);
@@ -58,6 +60,7 @@
   void draw_timeline(Cairo::RefPtr<Cairo::Context> cr);
   void draw_timeline_layer(Cairo::RefPtr<Cairo::Context> cr,
                            TimelineLayerHandle layer);
+  void add_to_selection(const Rectf& selection);
 
 private:
   TimelineWidget(const TimelineWidget&);



From grumbel at mail.berlios.de  Sun Sep 27 13:38:42 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sun, 27 Sep 2009 13:38:42 +0200
Subject: [Windstille-commit] r3266 - in tags/windstille-0.2.0/src: . input
Message-ID: <200909271138.n8RBcgTN025341@sheep.berlios.de>

Author: grumbel
Date: 2009-09-27 13:38:37 +0200 (Sun, 27 Sep 2009)
New Revision: 3266

Added:
   tags/windstille-0.2.0/src/input/
   tags/windstille-0.2.0/src/input/Makefile.am
   tags/windstille-0.2.0/src/input/axis_button.cxx
   tags/windstille-0.2.0/src/input/axis_button.hxx
   tags/windstille-0.2.0/src/input/axis_factory.cxx
   tags/windstille-0.2.0/src/input/axis_factory.hxx
   tags/windstille-0.2.0/src/input/button_axis.cxx
   tags/windstille-0.2.0/src/input/button_axis.hxx
   tags/windstille-0.2.0/src/input/button_factory.cxx
   tags/windstille-0.2.0/src/input/button_factory.hxx
   tags/windstille-0.2.0/src/input/controller.cxx
   tags/windstille-0.2.0/src/input/controller.hxx
   tags/windstille-0.2.0/src/input/input_axis.hxx
   tags/windstille-0.2.0/src/input/input_axis_input_device.cxx
   tags/windstille-0.2.0/src/input/input_axis_input_device.hxx
   tags/windstille-0.2.0/src/input/input_button.hxx
   tags/windstille-0.2.0/src/input/input_button_input_device.cxx
   tags/windstille-0.2.0/src/input/input_button_input_device.hxx
   tags/windstille-0.2.0/src/input/input_event.hxx
   tags/windstille-0.2.0/src/input/input_manager.cxx
   tags/windstille-0.2.0/src/input/input_manager.hxx
   tags/windstille-0.2.0/src/input/input_manager_custom.cxx
   tags/windstille-0.2.0/src/input/input_manager_custom.hxx
   tags/windstille-0.2.0/src/input/input_manager_impl.cxx
   tags/windstille-0.2.0/src/input/input_manager_impl.hxx
   tags/windstille-0.2.0/src/input/input_manager_player.cxx
   tags/windstille-0.2.0/src/input/input_manager_player.hxx
   tags/windstille-0.2.0/src/input/input_recorder.cxx
   tags/windstille-0.2.0/src/input/input_recorder.hxx
   tags/windstille-0.2.0/src/input/multi_button.cxx
   tags/windstille-0.2.0/src/input/multi_button.hxx
Log:
Made external input directory local (from feuerkraft rev 342)

Added: tags/windstille-0.2.0/src/input/Makefile.am
===================================================================
--- tags/windstille-0.2.0/src/input/Makefile.am	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/Makefile.am	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,37 @@
+noinst_LIBRARIES = libwindstille_input.a
+
+libwindstille_input_a_CPPFLAGS = \
+  @WINDSTILLE_CFLAGS@
+
+libwindstille_input_a_SOURCES = \
+  controller.hxx \
+  controller.cxx \
+  input_event.hxx \
+  input_manager.hxx \
+  input_manager.cxx \
+  input_manager_impl.hxx \
+  input_manager_impl.cxx \
+  input_manager_custom.hxx \
+  input_manager_custom.cxx \
+  input_manager_player.hxx \
+  input_manager_player.cxx \
+  input_button.hxx \
+  input_axis.hxx \
+  input_button_input_device.hxx \
+  input_button_input_device.cxx \
+  input_axis_input_device.hxx \
+  input_axis_input_device.cxx \
+  axis_button.hxx \
+  axis_button.cxx \
+  button_axis.hxx \
+  button_axis.cxx \
+  button_factory.hxx \
+  button_factory.cxx \
+  axis_factory.hxx \
+  axis_factory.cxx \
+  input_recorder.hxx \
+  input_recorder.cxx \
+  multi_button.hxx \
+  multi_button.cxx
+
+# EOF #

Added: tags/windstille-0.2.0/src/input/axis_button.cxx
===================================================================
--- tags/windstille-0.2.0/src/input/axis_button.cxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/axis_button.cxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,72 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include <iostream>
+#include "input_axis.hxx"
+#include "axis_button.hxx"
+
+AxisButton::AxisButton(InputAxis* axis, bool top)
+  : axis(axis),
+    down(false),
+    top(top)
+{
+  on_axis_move_slot = axis->on_move().connect(this, &AxisButton::on_axis_move);
+}
+
+AxisButton::~AxisButton()
+{
+}
+
+void
+AxisButton::update(float delta)
+{
+}
+
+void
+AxisButton::on_axis_move(float pos)
+{
+  if (top)
+    {
+      if (down && pos < 0.5f)
+        {
+          down = false;
+          button_up();
+        }
+      else if (!down && pos > 0.5f)
+        {
+          down = true;
+          button_down();
+        }
+    }
+  else
+    {
+      if (down && pos > -0.5f)
+        {
+          down = false;
+          button_up();
+        }
+      else if (!down && pos < -0.5f)
+        {
+          down = true;
+          button_down();
+        }
+    }
+}
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/axis_button.cxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/axis_button.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/axis_button.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/axis_button.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,53 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_AXIS_BUTTON_HXX
+#define HEADER_AXIS_BUTTON_HXX
+
+#include "input_button.hxx"
+
+class InputAxis;
+
+/** */
+class AxisButton : public InputButton
+{
+private:
+  CL_Slot on_axis_move_slot;
+  InputAxis* axis;
+  bool down;
+
+  /** true if the range 0..1 should be used to trigger, false if -1..0
+      should be used */
+  bool top;
+public:
+  AxisButton(InputAxis* axis, bool top);
+  ~AxisButton();
+
+  void update(float delta);
+  
+private:
+  void on_axis_move(float pos);
+
+  AxisButton (const AxisButton&);
+  AxisButton& operator= (const AxisButton&);
+};
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/axis_button.hxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/axis_factory.cxx
===================================================================
--- tags/windstille-0.2.0/src/input/axis_factory.cxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/axis_factory.cxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,79 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include <ClanLib/Display/joystick.h>
+#include "input_axis_input_device.hxx"
+#include "../feuerkraft_error.hxx"
+#include "../guile.hxx"
+#include "button_factory.hxx"
+#include "button_axis.hxx"
+#include "axis_factory.hxx"
+
+InputAxis* 
+AxisFactory::create(SCM lst)
+{
+  while(gh_pair_p(lst))
+    {
+      SCM sym  = gh_car(lst);
+      SCM data = gh_cdr(lst);
+      
+      if (gh_equal_p(sym, gh_symbol2scm("joystick-axis")))
+        {
+          return create_joystick_axis(data);
+        }
+      if (gh_equal_p(sym, gh_symbol2scm("button-axis")))
+        {
+          return create_button_axis(data);
+        }
+      else
+        {
+          throw FeuerkraftError("AxisFactory::create: parse error");
+        }
+
+      lst = gh_cdr(lst);
+    }
+  return 0;
+}
+
+InputAxis*
+AxisFactory::create_joystick_axis(SCM lst)
+{
+  int device_num = gh_scm2int(gh_car(lst));
+  int axis_num   = gh_scm2int(gh_cadr(lst));
+
+  if (device_num >= 0 && device_num < CL_Joystick::get_device_count())
+    return new InputAxisInputDevice(CL_Joystick::get_device(device_num), axis_num);
+  else
+    {
+      throw FeuerkraftError("Error: AxisFactory::create_joystick_axis: " 
+                            + Guile::scm2string(lst));
+      return 0;
+    }
+}
+
+InputAxis*
+AxisFactory::create_button_axis(SCM lst)
+{
+  InputButton* left  = ButtonFactory::create(gh_car(lst));
+  InputButton* right = ButtonFactory::create(gh_cadr(lst));
+
+  return new ButtonAxis(left, right);
+}
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/axis_factory.cxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/axis_factory.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/axis_factory.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/axis_factory.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,38 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_AXIS_FACTORY_HXX
+#define HEADER_AXIS_FACTORY_HXX
+
+#include <guile/gh.h>
+#include "input_axis.hxx"
+
+/** */
+class AxisFactory
+{
+public:
+  static InputAxis* create(SCM lst);
+private:
+  static InputAxis* create_joystick_axis(SCM lst);
+  static InputAxis* create_button_axis(SCM lst);
+};
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/axis_factory.hxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/button_axis.cxx
===================================================================
--- tags/windstille-0.2.0/src/input/button_axis.cxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/button_axis.cxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,87 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include <iostream>
+#include "input_button.hxx"
+#include "button_axis.hxx"
+
+ButtonAxis::ButtonAxis(InputButton* left, InputButton* right)
+  : left(left), right(right)
+{
+  slots.push_back(left->on_key_down().connect(this, &ButtonAxis::on_left_down));
+  slots.push_back(left->on_key_up().connect  (this, &ButtonAxis::on_left_up));
+
+  slots.push_back(right->on_key_down().connect(this, &ButtonAxis::on_right_down));
+  slots.push_back(right->on_key_up().connect  (this, &ButtonAxis::on_right_up));
+
+  left_state  = false;
+  right_state = false;
+  
+  pos = 0.0f;
+}
+
+void
+ButtonAxis::update(float delta)
+{
+  left->update(delta);
+  right->update(delta);
+
+  float new_pos = 0.0f;
+  if (left_state)
+    {
+      new_pos -= 1.0f;
+    }
+  
+  if (right_state)
+    {
+      new_pos += 1.0f;
+    }
+
+  if (new_pos != pos)
+    {
+      pos = new_pos;
+      move(pos);
+    }
+}
+
+void
+ButtonAxis::on_left_up()
+{
+  left_state = false;
+}
+
+void
+ButtonAxis::on_left_down()
+{
+  left_state = true;
+}
+
+void
+ButtonAxis::on_right_up()
+{
+  right_state = false;
+}
+
+void
+ButtonAxis::on_right_down()
+{
+  right_state = true;
+}
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/button_axis.cxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/button_axis.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/button_axis.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/button_axis.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,50 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_BUTTON_AXIS_HXX
+#define HEADER_BUTTON_AXIS_HXX
+
+#include "input_axis.hxx"
+
+class InputButton;
+
+class ButtonAxis : public InputAxis
+{
+private:
+  InputButton* left;
+  InputButton* right;
+
+  bool left_state;
+  bool right_state;
+  
+  float pos;
+private:
+  void on_left_up();
+  void on_left_down();
+
+  void on_right_up();
+  void on_right_down();
+public:
+  ButtonAxis(InputButton* left, InputButton* right);
+  void update(float delta);
+};
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/button_axis.hxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/button_factory.cxx
===================================================================
--- tags/windstille-0.2.0/src/input/button_factory.cxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/button_factory.cxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,111 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include <ClanLib/Display/joystick.h>
+#include <ClanLib/Display/keyboard.h>
+#include <ClanLib/Core/System/clanstring.h>
+#include "../guile.hxx"
+#include "../feuerkraft_error.hxx"
+#include "input_button.hxx"
+#include "input_axis.hxx"
+#include "input_button_input_device.hxx"
+#include "axis_factory.hxx"
+#include "axis_button.hxx"
+#include "multi_button.hxx"
+#include "button_factory.hxx"
+
+InputButton* 
+ButtonFactory::create(SCM lst)
+{
+  SCM sym = gh_car(lst);
+
+  if (gh_equal_p(sym, gh_symbol2scm("joystick-button")))
+    {
+      return create_joystick_button(gh_cdr(lst));
+    }
+  else if (gh_equal_p(sym, gh_symbol2scm("keyboard-button")))
+    {
+      return create_keyboard_button(gh_cdr(lst));
+    }
+  else if (gh_equal_p(sym, gh_symbol2scm("axis-button")))
+    {
+      return create_axis_button(gh_cdr(lst));
+    }
+  else if (gh_equal_p(sym, gh_symbol2scm("multi-button")))
+    {
+      return create_multi_button(gh_cdr(lst));
+    }
+  else
+    {
+      throw FeuerkraftError("ButtonFactory::create: parse error: '"
+                            + Guile::scm2string(lst) + "'");
+    }
+      
+  return 0;
+}
+
+InputButton*
+ButtonFactory::create_axis_button(SCM lst)
+{
+  InputAxis* axis = AxisFactory::create(gh_car(lst));
+  bool top = gh_scm2bool(gh_cadr(lst));
+  
+  return new AxisButton(axis, top);
+}
+
+InputButton*
+ButtonFactory::create_joystick_button(SCM lst)
+{
+  int device_num = gh_scm2int(gh_car(lst));
+  int button_num = gh_scm2int(gh_cadr(lst));
+  
+  if (device_num >= 0 && device_num < CL_Joystick::get_device_count())
+    return new InputButtonInputDevice(CL_Joystick::get_device(device_num), button_num);
+  else
+    {
+      throw FeuerkraftError("Error: ButtonFactory::create_joystick_button: device out of range"
+                            + CL_String::to(device_num) + " " + Guile::scm2string(lst));
+    }
+}
+
+InputButton*
+ButtonFactory::create_keyboard_button(SCM lst)
+{
+  std::string key_str = Guile::scm2string(gh_car(lst));
+  int key_num         = CL_Keyboard::get_device().string_to_keyid(key_str);
+
+  // FIXME: No error checking
+  return new InputButtonInputDevice(CL_Keyboard::get_device(), key_num);
+}
+
+InputButton*
+ButtonFactory::create_multi_button(SCM lst)
+{
+  MultiButton* button = new MultiButton();
+  
+  while (!gh_null_p(lst))
+    {
+      button->add(create(gh_car(lst)));
+      lst = gh_cdr(lst);
+    }
+  
+  return button;
+}
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/button_factory.cxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/button_factory.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/button_factory.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/button_factory.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,46 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_BUTTON_FACTORY_HXX
+#define HEADER_BUTTON_FACTORY_HXX
+
+#include <guile/gh.h>
+
+class InputButton;
+
+/** */
+class ButtonFactory
+{
+private:
+public:
+  static InputButton* create(SCM lst);
+
+private:
+  static InputButton* create_joystick_button(SCM lst);
+  static InputButton* create_keyboard_button(SCM lst);
+  static InputButton* create_axis_button(SCM lst);
+  static InputButton* create_multi_button(SCM lst);
+
+  ButtonFactory (const ButtonFactory&);
+  ButtonFactory& operator= (const ButtonFactory&);
+};
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/button_factory.hxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/controller.cxx
===================================================================
--- tags/windstille-0.2.0/src/input/controller.cxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/controller.cxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,90 @@
+//  $Id: controller.cxx,v 1.4 2003/10/31 23:24:41 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include "../assert.hxx"
+#include "controller.hxx"
+
+Controller::Controller()
+{
+  buttons.resize(ControllerDef::get_button_count());
+  axes.resize(ControllerDef::get_axis_count());
+}
+
+float
+Controller::get_axis_state(int name) const
+{
+  AssertMsg(name < int(axes.size()), "Controllor: Unknown AxisName");  
+  return axes[name];
+}
+        
+
+bool
+Controller::get_button_state(int name) const
+{
+  AssertMsg(name < int(buttons.size()), "Controllor: Unknown ButtonName");  
+  return buttons[name];
+}
+
+void
+Controller::set_axis_state(int name, float pos)
+{
+  AssertMsg(name < static_cast<int>(axes.size()), "Controllor: Unknown AxisName");
+  axes[name] = pos;
+}
+
+void
+Controller::set_button_state(int name, bool down)
+{
+  AssertMsg(name < static_cast<int>(buttons.size()), "Controller: Unknown ButtonName");
+  buttons[name] = down;
+}
+
+void
+Controller::add_axis_event(int name, float pos)
+{
+  InputEvent event;
+  event.type = AXIS_EVENT;
+  event.axis.name = name;
+  event.axis.pos  = pos;
+  events.push_back(event);
+}
+
+void
+Controller::add_button_event(int name, bool down)
+{
+  InputEvent event;
+  event.type = BUTTON_EVENT;
+  event.button.name = name;
+  event.button.down = down;
+  events.push_back(event);
+}
+
+InputEventLst
+Controller::get_events() const
+{
+  return events;
+}
+
+void
+Controller::set_events(const InputEventLst& lst)
+{
+  events = lst;
+}
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/controller.cxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/controller.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/controller.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/controller.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,59 @@
+//  $Id: controller.hxx,v 1.4 2003/10/31 23:24:41 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_CONTROLLER_HXX
+#define HEADER_CONTROLLER_HXX
+
+#include <vector>
+#include "../controller_def.hxx"
+#include "input_event.hxx"
+
+/** The Controller class presents the current state of the controller
+    and the input events that occurred on the controller since the
+    last update */
+class Controller
+{
+private:
+  /** State of all buttons, indexed by ButtonName */
+  std::vector<bool> buttons;
+  
+  /** State of all axis, indexed by AxisName */
+  std::vector<float> axes;
+
+  InputEventLst events;
+
+public:
+  Controller();
+
+  float get_axis_state  (int name) const;
+  bool  get_button_state(int name) const;
+
+  void  set_axis_state  (int name, float pos);
+  void  set_button_state(int name, bool down);
+
+  void add_axis_event  (int name, float pos);
+  void add_button_event(int name, bool down);
+
+  InputEventLst get_events() const;
+  void set_events(const InputEventLst& lst);
+};
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/controller.hxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_axis.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_axis.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_axis.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,42 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_AXIS_HXX
+#define HEADER_INPUT_AXIS_HXX
+
+#include <vector>
+#include <ClanLib/Signals/slot.h>
+#include <ClanLib/Signals/signal_v1.h>
+
+class InputAxis
+{
+protected:
+  std::vector<CL_Slot> slots;
+  CL_Signal_v1<float> move;  
+public:
+  InputAxis() {}
+  virtual ~InputAxis() {}
+
+  virtual void update(float delta) {}
+  CL_Signal_v1<float>& on_move() { return move; }
+};
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_axis.hxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_axis_input_device.cxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_axis_input_device.cxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_axis_input_device.cxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,38 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include <ClanLib/Display/input_event.h>
+#include "input_axis_input_device.hxx"
+
+InputAxisInputDevice::InputAxisInputDevice(CL_InputDevice& dev, int num)
+  : dev(dev), axis_num(num)
+{
+  slots.push_back(dev.sig_axis_move().connect(this, &InputAxisInputDevice::on_axis_move));
+}
+
+void
+InputAxisInputDevice::on_axis_move(const CL_InputEvent& event)
+{
+  if (event.id == axis_num)
+    {
+      move(event.axis_pos);
+    }
+}
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_axis_input_device.cxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_axis_input_device.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_axis_input_device.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_axis_input_device.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,41 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_AXIS_INPUT_DEVICE_HXX
+#define HEADER_INPUT_AXIS_INPUT_DEVICE_HXX
+
+#include <ClanLib/Display/input_device.h>
+#include "input_axis.hxx"
+
+class InputAxisInputDevice : public InputAxis
+{
+private:
+  CL_InputDevice dev;
+  int axis_num;
+
+  void on_axis_move(const CL_InputEvent& event); 
+
+public:
+  InputAxisInputDevice(CL_InputDevice& dev, int num);
+  void update(float delta) {}
+};
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_axis_input_device.hxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_button.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_button.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_button.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,46 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_BOTTON_HXX
+#define HEADER_INPUT_BOTTON_HXX
+
+#include <vector>
+#include <ClanLib/Signals/slot.h>
+#include <ClanLib/Signals/signal_v0.h>
+
+class InputButton
+{
+protected:
+  std::vector<CL_Slot> slots;
+  CL_Signal_v0 button_down;
+  CL_Signal_v0 button_up;
+
+public:
+  InputButton() {}
+  virtual ~InputButton() {}
+  
+  virtual void update(float delta) {}
+
+  CL_Signal_v0& on_key_down() { return button_down; }
+  CL_Signal_v0& on_key_up()   { return button_up; }
+};
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_button.hxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_button_input_device.cxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_button_input_device.cxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_button_input_device.cxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,49 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include <iostream>
+#include <ClanLib/Display/input_event.h>
+#include "input_button_input_device.hxx"
+
+InputButtonInputDevice::InputButtonInputDevice(CL_InputDevice& dev_, int keycode_)
+  : dev(dev_), keycode(keycode_)
+{
+  slots.push_back(dev.sig_key_down().connect(this, &InputButtonInputDevice::on_key_down));
+  slots.push_back(dev.sig_key_up().connect(this, &InputButtonInputDevice::on_key_up));
+}
+
+void
+InputButtonInputDevice::on_key_down(const CL_InputEvent& event)
+{
+  if (keycode == event.id)
+    {
+      button_down();
+    }
+}
+
+void
+InputButtonInputDevice::on_key_up(const CL_InputEvent& event)
+{
+  if (keycode == event.id)
+    {
+      button_up();
+    }
+}
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_button_input_device.cxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_button_input_device.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_button_input_device.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_button_input_device.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,43 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_BOTTON_INPUT_DEVICE_HXX
+#define HEADER_INPUT_BOTTON_INPUT_DEVICE_HXX
+
+#include <ClanLib/Display/input_device.h>
+#include "input_button.hxx"
+
+class InputButtonInputDevice : public InputButton
+{
+private:
+  CL_InputDevice dev;
+  int keycode;
+
+  void on_key_down(const CL_InputEvent& event);
+  void on_key_up(const CL_InputEvent& event);
+
+public:
+  InputButtonInputDevice(CL_InputDevice& dev, int keycode);
+  
+  void update(float delta) {}
+};
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_button_input_device.hxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_event.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_event.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_event.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,63 @@
+//  $Id: input_event.hxx,v 1.4 2003/10/31 23:24:41 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_EVENT_HXX
+#define HEADER_INPUT_EVENT_HXX
+
+#include <vector>
+
+enum InputEventType { BUTTON_EVENT, AXIS_EVENT };
+
+struct ButtonEvent
+{
+  int name;
+
+  /** true if down, false if up */
+  bool down;
+
+  bool is_down() const { return down; }
+  bool is_up()   const { return !down; }
+};
+
+struct AxisEvent
+{
+  int name;
+
+  /** Pos can be in range from [-1.0, 1.0], some axis will only use [0,1.0] */
+  float pos;
+
+  float get_pos() { return pos; }
+};
+
+struct InputEvent 
+{
+  InputEventType type;
+    
+  union 
+  {
+    struct ButtonEvent button;
+    struct AxisEvent   axis;
+  };
+};
+
+typedef std::vector<InputEvent> InputEventLst;
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_event.hxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_manager.cxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_manager.cxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_manager.cxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,98 @@
+//  $Id: input_manager.cxx,v 1.4 2003/08/20 00:15:10 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include <iostream>
+#include <assert.h>
+#include <stdexcept>
+#include <sstream>
+#include <ClanLib/Display/joystick.h>
+
+#include "../feuerkraft_error.hxx"
+#include "input_manager_custom.hxx"
+#include "input_manager_player.hxx"
+#include "input_manager_impl.hxx"
+#include "input_recorder.hxx"
+#include "input_manager.hxx"
+
+InputManagerImpl* InputManager::impl = 0;
+InputRecorder* InputManager::recorder = 0;
+
+void
+InputManager::init_playback(const std::string& filename)
+{
+  impl = new InputManagerPlayer(filename);
+}
+
+void
+InputManager::init(const std::string& filename)
+{
+  std::cout << "InputManager::init(" << filename << ")" << std::endl;
+  SCM port = scm_open_file(gh_str02scm(filename.c_str()),
+                           gh_str02scm("r"));
+  SCM lst  = scm_read(port);
+
+  if (gh_equal_p(gh_symbol2scm("feuerkraft-controller"), gh_car(lst)))
+    {
+      impl = new InputManagerCustom(gh_cdr(lst));
+    }
+  else
+    {
+      throw FeuerkraftError("Error: not a valid controller file: " + filename);
+    }
+  scm_close_port(port);
+}
+
+void
+InputManager::setup_recorder(const std::string& filename)
+{
+  if (recorder)
+    delete recorder;
+
+  recorder = new InputRecorder(filename);
+}
+
+void 
+InputManager::deinit()
+{
+  delete impl;
+}
+
+void
+InputManager::update(float delta)
+{
+  assert(impl);
+  impl->update(delta);
+  if (recorder)
+    recorder->record(get_controller());
+}
+
+Controller
+InputManager::get_controller()
+{
+  assert(impl);
+  return impl->get_controller();
+}
+
+void
+InputManager::clear()
+{
+  impl->clear();
+}
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_manager.cxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_manager.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_manager.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_manager.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,57 @@
+//  $Id: input_manager.hxx,v 1.3 2003/06/06 18:36:24 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_MANAGER_HXX
+#define HEADER_INPUT_MANAGER_HXX
+
+#include <vector>
+#include "controller.hxx"
+#include "input_event.hxx"
+
+class InputRecorder;
+class InputManagerImpl;
+
+/** */
+class InputManager
+{
+private:
+  static InputManagerImpl* impl;
+  static InputRecorder* recorder;
+public:
+  /** Init the InputManager with the data found in \a filename */
+  static void init(const std::string& filename = std::string());
+
+  /** Init the playback of a previously recorded file */
+  static void init_playback(const std::string& filenam);
+  static void deinit();
+
+  /** Record all input events to \a filename */
+  static void setup_recorder(const std::string& filename);
+
+  static void update(float delta);
+  static Controller get_controller();
+  static void clear();
+private:
+  InputManager(const InputManager&);
+  InputManager& operator=(const InputManager&);
+};
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_manager.hxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_manager_custom.cxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_manager_custom.cxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_manager_custom.cxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,141 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include <iostream>
+#include <ClanLib/Display/keyboard.h>
+#include <ClanLib/Display/joystick.h>
+#include <ClanLib/Display/display_iostream.h>
+#include <ClanLib/Display/keys.h>
+
+#include "../guile.hxx"
+#include "../assert.hxx"
+#include "../controller_def.hxx"
+#include "input_button_input_device.hxx"
+#include "input_axis_input_device.hxx"
+#include "button_factory.hxx"
+#include "axis_factory.hxx"
+
+#include "input_manager_custom.hxx"
+
+InputManagerCustom::InputManagerCustom(SCM lst)
+{
+  init(lst);
+
+  for (int i = 0; i < (int)buttons.size(); ++i)
+    {
+      if (buttons[i])
+        {
+          slots.push_back(buttons[i]->on_key_down().connect(this, &InputManagerCustom::on_button_down, i));
+          slots.push_back(buttons[i]->on_key_up().connect  (this, &InputManagerCustom::on_button_up,   i));
+        }
+      else
+        {
+          std::cout << "# Warrning: Button '" << ControllerDef::button_id2name(i)
+                    << "' not configured and will not be usable" << std::endl;
+        }
+    }
+
+  for (int i = 0; i < (int)axes.size(); ++i)
+    {
+      if (axes[i])
+        {
+          slots.push_back(axes[i]->on_move().connect(this, &InputManagerCustom::on_axis_move, i));
+        }
+      else
+        {
+          std::cout << "# Warrning: Axis '" << ControllerDef::axis_id2name(i)
+                    << "' not configured and will not be usable" << std::endl;
+        }
+    }
+}
+
+void 
+InputManagerCustom::init(SCM lst)
+{
+  buttons.resize(ControllerDef::get_button_count());
+  axes.resize(ControllerDef::get_axis_count());
+  
+  while (gh_pair_p(lst))
+    {
+      SCM sym  = gh_caar(lst);
+      SCM data = gh_cadar(lst);
+
+      std::string name = Guile::symbol2string(sym);
+
+      int id = ControllerDef::button_name2id(name);
+      if (id != -1)
+        {
+          buttons[id] = ButtonFactory::create(data);
+        }
+      else
+        {
+          id = ControllerDef::axis_name2id(name);
+          if (id != -1)
+            {
+              axes[id] = AxisFactory::create(data);
+            }
+          else
+            {
+              std::cout << "# Warning: InputManagerCustom::init: Error unknown tag: " 
+                        << Guile::scm2string(sym) << std::endl;
+            }
+        }
+
+      lst = gh_cdr(lst);
+    }
+}  
+
+void
+InputManagerCustom::on_axis_move(float pos, int name)
+{
+  add_axis_event(name, pos);
+  controller.set_axis_state(name, pos);
+}
+
+void
+InputManagerCustom::on_button_up(int name)
+{
+  add_button_event(name, false);
+  controller.set_button_state(name, false);
+}
+
+void
+InputManagerCustom::on_button_down(int name)
+{
+  add_button_event(name, true);
+  controller.set_button_state(name, true);
+}
+
+void
+InputManagerCustom::update(float delta)
+{
+  for (int i = 0; i < (int)buttons.size(); ++i)
+    {
+      if (buttons[i])
+        buttons[i]->update(delta);
+    }
+
+  for (int i = 0; i < (int)axes.size(); ++i)
+    {
+      if (axes[i])
+        axes[i]->update(delta);
+    }
+}
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_manager_custom.cxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_manager_custom.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_manager_custom.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_manager_custom.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,60 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_MANAGER_CUSTOM_HXX
+#define HEADER_INPUT_MANAGER_CUSTOM_HXX
+
+#include <guile/gh.h>
+#include <ClanLib/Display/input_device.h>
+#include <ClanLib/Display/input_event.h>
+#include "input_event.hxx"
+#include "input_button.hxx"
+#include "input_axis.hxx"
+#include "input_manager_impl.hxx"
+
+/** */
+class InputManagerCustom : public InputManagerImpl
+{
+private:
+  std::vector<CL_Slot> slots;
+
+  typedef std::vector<InputAxis*>   Axes;
+  typedef std::vector<InputButton*> Buttons;
+  
+  Axes    axes;
+  Buttons buttons;
+
+public:
+  InputManagerCustom(SCM lst);
+  
+  void update(float delta);
+
+  void on_button_up(int name);
+  void on_button_down(int name);
+  void on_axis_move(float pos, int name);
+private:
+  void init(SCM lst);
+
+  InputManagerCustom (const InputManagerCustom&);
+  InputManagerCustom& operator= (const InputManagerCustom&);
+};
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_manager_custom.hxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_manager_impl.cxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_manager_impl.cxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_manager_impl.cxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,61 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include "input_manager_impl.hxx"
+
+InputEventLst
+InputManagerImpl::get_events()
+{
+  return events;
+}
+
+Controller
+InputManagerImpl::get_controller()
+{
+  controller.set_events(events);
+  return controller;
+}
+
+void
+InputManagerImpl::add_axis_event(int name, float pos)
+{
+  InputEvent event;
+  event.type = AXIS_EVENT;
+  event.axis.name = name;
+  event.axis.pos  = pos;
+  events.push_back(event);
+}
+
+void
+InputManagerImpl::add_button_event(int name, bool down)
+{
+  InputEvent event;
+  event.type = BUTTON_EVENT;
+  event.button.name = name;
+  event.button.down = down;
+  events.push_back(event);
+}
+
+void
+InputManagerImpl::clear()
+{
+  events.clear();
+}
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_manager_impl.cxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_manager_impl.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_manager_impl.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_manager_impl.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,53 @@
+//  $Id: input_manager_impl.hxx,v 1.3 2003/06/06 18:36:24 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_MANAGER_IMPL_HXX
+#define HEADER_INPUT_MANAGER_IMPL_HXX
+
+#include "controller.hxx"
+#include "input_event.hxx"
+
+/** */
+class InputManagerImpl
+{
+protected:
+  Controller controller;
+  InputEventLst events;
+
+public:
+  InputManagerImpl() {}
+  virtual ~InputManagerImpl() {}
+
+  virtual void update(float delta) =0;
+  
+  InputEventLst get_events();
+
+  Controller get_controller();
+  void clear();
+
+  void add_axis_event  (int name, float pos);
+  void add_button_event(int name, bool down);
+private:
+  InputManagerImpl(const InputManagerImpl&);
+  InputManagerImpl& operator=(const InputManagerImpl&);
+};
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_manager_impl.hxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_manager_player.cxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_manager_player.cxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_manager_player.cxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,93 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include <iostream>
+#include "../guile.hxx"
+#include "input_manager_player.hxx"
+
+InputManagerPlayer::InputManagerPlayer(const std::string& filename)
+{
+  std::cout << "InputManagerPlayer::InputManagerPlayer(" << filename << ")" << std::endl;
+  entry_counter = 0;
+  SCM port = scm_open_file(gh_str02scm(filename.c_str()),
+                           gh_str02scm("r"));
+  SCM entry;
+  while(scm_eof_object_p(entry = scm_read(port)) == SCM_BOOL_F)
+    {
+      InputEventLst lst;
+      int entry_num = gh_scm2int(gh_cadr(entry));
+      entry = gh_cddr(entry);
+      
+      while(gh_pair_p(entry))
+        {
+          lst.push_back(scm2event(gh_car(entry)));
+          entry = gh_cdr(entry);
+        }
+      entries.push(Entry(entry_num, lst));
+    }
+  scm_close_port(port);
+}
+
+InputEvent
+InputManagerPlayer::scm2event(SCM entry)
+{
+  InputEvent event;
+  SCM sym  = gh_car(entry);
+  SCM data = gh_cdr(entry);
+
+  if (gh_equal_p(gh_symbol2scm("axis"), sym)) 
+    {
+      event.type = AXIS_EVENT;
+      event.axis.name = gh_scm2int(gh_car(data));
+      event.axis.pos  = gh_scm2double(gh_cadr(data));
+    } 
+  else if (gh_equal_p(gh_symbol2scm("button"), sym))
+    {
+      event.type = BUTTON_EVENT;
+      event.button.name = gh_scm2int(gh_car(data));
+      event.button.down = gh_scm2int(gh_cadr(data));
+    } 
+  else 
+    {
+      std::cout << "scm2event: Unknown sym: " << Guile::scm2string(sym) << std::endl;
+    }
+  return event;
+}
+  
+void
+InputManagerPlayer::update(float delta)
+{
+  if (entries.front().entry_num == entry_counter)
+    {
+      events = entries.front().events;
+      
+      for (InputEventLst::iterator i = events.begin(); i != events.end(); ++i)
+        {
+          if (i->type == AXIS_EVENT)
+            controller.set_axis_state(i->axis.name, i->axis.pos);
+          else if  (i->type == BUTTON_EVENT)
+            controller.set_button_state(i->button.name, i->button.down);
+        }
+      entries.pop();
+    }
+
+  entry_counter += 1;
+}
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_manager_player.cxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_manager_player.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_manager_player.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_manager_player.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,55 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_MANAGER_PLAYER_HXX
+#define HEADER_INPUT_MANAGER_PLAYER_HXX
+
+#include <queue>
+#include <string>
+#include <guile/gh.h>
+#include "input_manager_impl.hxx"
+
+/** Playback class for events recorded my the InputRecorder */
+class InputManagerPlayer : public InputManagerImpl
+{
+private:
+  struct Entry {
+    Entry(int num, const InputEventLst& lst) 
+      : entry_num(num), events(lst)
+    {}
+    int entry_num;
+    InputEventLst events;
+  };
+
+  int entry_counter;
+  std::queue<Entry> entries;
+public:
+  InputManagerPlayer(const std::string& filename);
+  
+  void update(float delta);
+private:
+  InputEvent scm2event(SCM lst);
+
+  InputManagerPlayer (const InputManagerPlayer&);
+  InputManagerPlayer& operator= (const InputManagerPlayer&);
+};
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_manager_player.hxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_recorder.cxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_recorder.cxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_recorder.cxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,61 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include "input_recorder.hxx"
+
+InputRecorder::InputRecorder(const std::string& filename)
+  : out(filename.c_str())
+{
+  entry_counter = 0;
+}
+
+InputRecorder::~InputRecorder()
+{
+  out.close();
+}
+
+void
+InputRecorder::record(const Controller& controller)
+{
+  InputEventLst lst = controller.get_events();
+
+  if (!lst.empty())
+    {
+      out << "(entry " << entry_counter << std::endl;
+ 
+      for (InputEventLst::iterator i = lst.begin(); i != lst.end(); ++i)
+        {
+          switch(i->type)
+            {
+            case AXIS_EVENT:
+              out << "  (axis " << i->axis.name << " " << i->axis.get_pos() << ")" << std::endl;
+              break;
+          
+            case BUTTON_EVENT:
+              out << "  (button " << i->button.name << " " << i->button.down << ")" << std::endl;
+              break;
+            }
+        }
+      out << ")\n" << std::endl;
+    }
+
+  entry_counter += 1;
+}
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_recorder.cxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/input_recorder.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/input_recorder.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/input_recorder.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,46 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_RECORDER_HXX
+#define HEADER_INPUT_RECORDER_HXX
+
+#include <fstream>
+#include "controller.hxx"
+
+/** The InputRecorder hooks into the InputManager and records all
+    input events to a file, thus allowing the later playback of the
+    events. */
+class InputRecorder
+{
+private:
+  std::ofstream out;
+  int entry_counter;
+public:
+  InputRecorder(const std::string& filename);
+  ~InputRecorder();
+
+  void record(const Controller& controller);
+private:
+  InputRecorder (const InputRecorder&);
+  InputRecorder& operator= (const InputRecorder&);
+};
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/input_recorder.hxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/multi_button.cxx
===================================================================
--- tags/windstille-0.2.0/src/input/multi_button.cxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/multi_button.cxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,65 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include <iostream>
+#include "multi_button.hxx"
+
+MultiButton::MultiButton()
+{
+  press_count = 0;
+}
+
+void
+MultiButton::add(InputButton* button)
+{
+  buttons.push_back(button);
+  slots.push_back(button->on_key_down().connect(this, &MultiButton::pressed));
+  slots.push_back(button->on_key_up().connect(this, &MultiButton::released));
+}
+
+void
+MultiButton::update(float delta)
+{
+  for (Buttons::iterator i = buttons.begin(); i != buttons.end(); ++i)
+    (*i)->update(delta);
+}
+
+void
+MultiButton::released()
+{
+  press_count -= 1;
+
+  if (press_count == 0)
+    button_up();
+
+  // FIXME: Workaround
+  if (press_count < 0)
+    press_count = 0;
+}
+
+void
+MultiButton::pressed()
+{
+  press_count += 1;
+
+  if (press_count == 1)
+    button_down();
+}
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/multi_button.cxx
___________________________________________________________________
Name: svn:eol-style
   + native

Added: tags/windstille-0.2.0/src/input/multi_button.hxx
===================================================================
--- tags/windstille-0.2.0/src/input/multi_button.hxx	2009-09-26 14:24:37 UTC (rev 3265)
+++ tags/windstille-0.2.0/src/input/multi_button.hxx	2009-09-27 11:38:37 UTC (rev 3266)
@@ -0,0 +1,46 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_MULTI_BUTTON_HXX
+#define HEADER_MULTI_BUTTON_HXX
+
+#include <vector>
+#include "input_button.hxx"
+
+/** */
+class MultiButton : public InputButton
+{
+private:
+  typedef std::vector<InputButton*> Buttons;
+  Buttons buttons;
+  std::vector<CL_Slot> slots;  
+  int press_count;
+public:
+  MultiButton();
+  
+  void add(InputButton*);
+  void update(float delta);
+private:
+  void released();
+  void pressed();
+};
+
+#endif
+
+/* EOF */


Property changes on: tags/windstille-0.2.0/src/input/multi_button.hxx
___________________________________________________________________
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Sun Sep 27 13:42:25 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sun, 27 Sep 2009 13:42:25 +0200
Subject: [Windstille-commit] r3267 - in tags/windstille-0.2.0: . src
	src/collision src/editor src/input
Message-ID: <200909271142.n8RBgPGb030140@sheep.berlios.de>

Author: grumbel
Date: 2009-09-27 13:42:19 +0200 (Sun, 27 Sep 2009)
New Revision: 3267

Removed:
   tags/windstille-0.2.0/aclocal.m4
Modified:
   tags/windstille-0.2.0/
   tags/windstille-0.2.0/autogen.sh
   tags/windstille-0.2.0/configure.ac
   tags/windstille-0.2.0/src/
   tags/windstille-0.2.0/src/Makefile.am
   tags/windstille-0.2.0/src/collision/collision_mask.cxx
   tags/windstille-0.2.0/src/collision/collision_mask.hxx
   tags/windstille-0.2.0/src/editor/editor_tilemap.cxx
   tags/windstille-0.2.0/src/editor/tile_selector.cxx
   tags/windstille-0.2.0/src/input/
   tags/windstille-0.2.0/src/player_view.cxx
   tags/windstille-0.2.0/src/screenshot.cxx
   tags/windstille-0.2.0/src/screenshot.hxx
   tags/windstille-0.2.0/src/tile.cxx
   tags/windstille-0.2.0/src/windstille_bonus.cxx
   tags/windstille-0.2.0/src/windstille_main.hxx
Log:
Some changes to make Windstille 0.2.x compile with ClanLib 0.8 (editor still looks broken)


Property changes on: tags/windstille-0.2.0
___________________________________________________________________
Name: svn:ignore
   - configure
Makefile.in
config.log
depcomp
config.h
Makefile
mkinstalldirs
config.status
stamp-h1
config.h.in
autom4te.cache
missing
install-sh

   + aclocal.m4
autom4te.cache
config.h
config.h.in
config.log
config.status
configure
depcomp
install-sh
Makefile
Makefile.in
missing
mkinstalldirs
stamp-h1


Deleted: tags/windstille-0.2.0/aclocal.m4
===================================================================
--- tags/windstille-0.2.0/aclocal.m4	2009-09-27 11:38:37 UTC (rev 3266)
+++ tags/windstille-0.2.0/aclocal.m4	2009-09-27 11:42:19 UTC (rev 3267)
@@ -1,893 +0,0 @@
-# generated automatically by aclocal 1.7.7 -*- Autoconf -*-
-
-# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002
-# Free Software Foundation, Inc.
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-# Do all the work for Automake.                            -*- Autoconf -*-
-
-# This macro actually does too much some checks are only needed if
-# your package does certain things.  But this isn't really a big deal.
-
-# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003
-# Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
-# serial 10
-
-AC_PREREQ([2.54])
-
-# Autoconf 2.50 wants to disallow AM_ names.  We explicitly allow
-# the ones we care about.
-m4_pattern_allow([^AM_[A-Z]+FLAGS$])dnl
-
-# AM_INIT_AUTOMAKE(PACKAGE, VERSION, [NO-DEFINE])
-# AM_INIT_AUTOMAKE([OPTIONS])
-# -----------------------------------------------
-# The call with PACKAGE and VERSION arguments is the old style
-# call (pre autoconf-2.50), which is being phased out.  PACKAGE
-# and VERSION should now be passed to AC_INIT and removed from
-# the call to AM_INIT_AUTOMAKE.
-# We support both call styles for the transition.  After
-# the next Automake release, Autoconf can make the AC_INIT
-# arguments mandatory, and then we can depend on a new Autoconf
-# release and drop the old call support.
-AC_DEFUN([AM_INIT_AUTOMAKE],
-[AC_REQUIRE([AM_SET_CURRENT_AUTOMAKE_VERSION])dnl
- AC_REQUIRE([AC_PROG_INSTALL])dnl
-# test to see if srcdir already configured
-if test "`cd $srcdir && pwd`" != "`pwd`" &&
-   test -f $srcdir/config.status; then
-  AC_MSG_ERROR([source directory already configured; run "make distclean" there first])
-fi
-
-# test whether we have cygpath
-if test -z "$CYGPATH_W"; then
-  if (cygpath --version) >/dev/null 2>/dev/null; then
-    CYGPATH_W='cygpath -w'
-  else
-    CYGPATH_W=echo
-  fi
-fi
-AC_SUBST([CYGPATH_W])
-
-# Define the identity of the package.
-dnl Distinguish between old-style and new-style calls.
-m4_ifval([$2],
-[m4_ifval([$3], [_AM_SET_OPTION([no-define])])dnl
- AC_SUBST([PACKAGE], [$1])dnl
- AC_SUBST([VERSION], [$2])],
-[_AM_SET_OPTIONS([$1])dnl
- AC_SUBST([PACKAGE], ['AC_PACKAGE_TARNAME'])dnl
- AC_SUBST([VERSION], ['AC_PACKAGE_VERSION'])])dnl
-
-_AM_IF_OPTION([no-define],,
-[AC_DEFINE_UNQUOTED(PACKAGE, "$PACKAGE", [Name of package])
- AC_DEFINE_UNQUOTED(VERSION, "$VERSION", [Version number of package])])dnl
-
-# Some tools Automake needs.
-AC_REQUIRE([AM_SANITY_CHECK])dnl
-AC_REQUIRE([AC_ARG_PROGRAM])dnl
-AM_MISSING_PROG(ACLOCAL, aclocal-${am__api_version})
-AM_MISSING_PROG(AUTOCONF, autoconf)
-AM_MISSING_PROG(AUTOMAKE, automake-${am__api_version})
-AM_MISSING_PROG(AUTOHEADER, autoheader)
-AM_MISSING_PROG(MAKEINFO, makeinfo)
-AM_MISSING_PROG(AMTAR, tar)
-AM_PROG_INSTALL_SH
-AM_PROG_INSTALL_STRIP
-# We need awk for the "check" target.  The system "awk" is bad on
-# some platforms.
-AC_REQUIRE([AC_PROG_AWK])dnl
-AC_REQUIRE([AC_PROG_MAKE_SET])dnl
-AC_REQUIRE([AM_SET_LEADING_DOT])dnl
-
-_AM_IF_OPTION([no-dependencies],,
-[AC_PROVIDE_IFELSE([AC_PROG_CC],
-                  [_AM_DEPENDENCIES(CC)],
-                  [define([AC_PROG_CC],
-                          defn([AC_PROG_CC])[_AM_DEPENDENCIES(CC)])])dnl
-AC_PROVIDE_IFELSE([AC_PROG_CXX],
-                  [_AM_DEPENDENCIES(CXX)],
-                  [define([AC_PROG_CXX],
-                          defn([AC_PROG_CXX])[_AM_DEPENDENCIES(CXX)])])dnl
-])
-])
-
-
-# When config.status generates a header, we must update the stamp-h file.
-# This file resides in the same directory as the config header
-# that is generated.  The stamp files are numbered to have different names.
-
-# Autoconf calls _AC_AM_CONFIG_HEADER_HOOK (when defined) in the
-# loop where config.status creates the headers, so we can generate
-# our stamp files there.
-AC_DEFUN([_AC_AM_CONFIG_HEADER_HOOK],
-[# Compute $1's index in $config_headers.
-_am_stamp_count=1
-for _am_header in $config_headers :; do
-  case $_am_header in
-    $1 | $1:* )
-      break ;;
-    * )
-      _am_stamp_count=`expr $_am_stamp_count + 1` ;;
-  esac
-done
-echo "timestamp for $1" >`AS_DIRNAME([$1])`/stamp-h[]$_am_stamp_count])
-
-# Copyright 2002  Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-
-# AM_AUTOMAKE_VERSION(VERSION)
-# ----------------------------
-# Automake X.Y traces this macro to ensure aclocal.m4 has been
-# generated from the m4 files accompanying Automake X.Y.
-AC_DEFUN([AM_AUTOMAKE_VERSION],[am__api_version="1.7"])
-
-# AM_SET_CURRENT_AUTOMAKE_VERSION
-# -------------------------------
-# Call AM_AUTOMAKE_VERSION so it can be traced.
-# This function is AC_REQUIREd by AC_INIT_AUTOMAKE.
-AC_DEFUN([AM_SET_CURRENT_AUTOMAKE_VERSION],
-	 [AM_AUTOMAKE_VERSION([1.7.7])])
-
-# Helper functions for option handling.                    -*- Autoconf -*-
-
-# Copyright 2001, 2002  Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
-# serial 2
-
-# _AM_MANGLE_OPTION(NAME)
-# -----------------------
-AC_DEFUN([_AM_MANGLE_OPTION],
-[[_AM_OPTION_]m4_bpatsubst($1, [[^a-zA-Z0-9_]], [_])])
-
-# _AM_SET_OPTION(NAME)
-# ------------------------------
-# Set option NAME.  Presently that only means defining a flag for this option.
-AC_DEFUN([_AM_SET_OPTION],
-[m4_define(_AM_MANGLE_OPTION([$1]), 1)])
-
-# _AM_SET_OPTIONS(OPTIONS)
-# ----------------------------------
-# OPTIONS is a space-separated list of Automake options.
-AC_DEFUN([_AM_SET_OPTIONS],
-[AC_FOREACH([_AM_Option], [$1], [_AM_SET_OPTION(_AM_Option)])])
-
-# _AM_IF_OPTION(OPTION, IF-SET, [IF-NOT-SET])
-# -------------------------------------------
-# Execute IF-SET if OPTION is set, IF-NOT-SET otherwise.
-AC_DEFUN([_AM_IF_OPTION],
-[m4_ifset(_AM_MANGLE_OPTION([$1]), [$2], [$3])])
-
-#
-# Check to make sure that the build environment is sane.
-#
-
-# Copyright 1996, 1997, 2000, 2001 Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
-# serial 3
-
-# AM_SANITY_CHECK
-# ---------------
-AC_DEFUN([AM_SANITY_CHECK],
-[AC_MSG_CHECKING([whether build environment is sane])
-# Just in case
-sleep 1
-echo timestamp > conftest.file
-# Do `set' in a subshell so we don't clobber the current shell's
-# arguments.  Must try -L first in case configure is actually a
-# symlink; some systems play weird games with the mod time of symlinks
-# (eg FreeBSD returns the mod time of the symlink's containing
-# directory).
-if (
-   set X `ls -Lt $srcdir/configure conftest.file 2> /dev/null`
-   if test "$[*]" = "X"; then
-      # -L didn't work.
-      set X `ls -t $srcdir/configure conftest.file`
-   fi
-   rm -f conftest.file
-   if test "$[*]" != "X $srcdir/configure conftest.file" \
-      && test "$[*]" != "X conftest.file $srcdir/configure"; then
-
-      # If neither matched, then we have a broken ls.  This can happen
-      # if, for instance, CONFIG_SHELL is bash and it inherits a
-      # broken ls alias from the environment.  This has actually
-      # happened.  Such a system could not be considered "sane".
-      AC_MSG_ERROR([ls -t appears to fail.  Make sure there is not a broken
-alias in your environment])
-   fi
-
-   test "$[2]" = conftest.file
-   )
-then
-   # Ok.
-   :
-else
-   AC_MSG_ERROR([newly created file is older than distributed files!
-Check your system clock])
-fi
-AC_MSG_RESULT(yes)])
-
-#  -*- Autoconf -*-
-
-
-# Copyright 1997, 1999, 2000, 2001 Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
-# serial 3
-
-# AM_MISSING_PROG(NAME, PROGRAM)
-# ------------------------------
-AC_DEFUN([AM_MISSING_PROG],
-[AC_REQUIRE([AM_MISSING_HAS_RUN])
-$1=${$1-"${am_missing_run}$2"}
-AC_SUBST($1)])
-
-
-# AM_MISSING_HAS_RUN
-# ------------------
-# Define MISSING if not defined so far and test if it supports --run.
-# If it does, set am_missing_run to use it, otherwise, to nothing.
-AC_DEFUN([AM_MISSING_HAS_RUN],
-[AC_REQUIRE([AM_AUX_DIR_EXPAND])dnl
-test x"${MISSING+set}" = xset || MISSING="\${SHELL} $am_aux_dir/missing"
-# Use eval to expand $SHELL
-if eval "$MISSING --run true"; then
-  am_missing_run="$MISSING --run "
-else
-  am_missing_run=
-  AC_MSG_WARN([`missing' script is too old or missing])
-fi
-])
-
-# AM_AUX_DIR_EXPAND
-
-# Copyright 2001 Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
-# For projects using AC_CONFIG_AUX_DIR([foo]), Autoconf sets
-# $ac_aux_dir to `$srcdir/foo'.  In other projects, it is set to
-# `$srcdir', `$srcdir/..', or `$srcdir/../..'.
-#
-# Of course, Automake must honor this variable whenever it calls a
-# tool from the auxiliary directory.  The problem is that $srcdir (and
-# therefore $ac_aux_dir as well) can be either absolute or relative,
-# depending on how configure is run.  This is pretty annoying, since
-# it makes $ac_aux_dir quite unusable in subdirectories: in the top
-# source directory, any form will work fine, but in subdirectories a
-# relative path needs to be adjusted first.
-#
-# $ac_aux_dir/missing
-#    fails when called from a subdirectory if $ac_aux_dir is relative
-# $top_srcdir/$ac_aux_dir/missing
-#    fails if $ac_aux_dir is absolute,
-#    fails when called from a subdirectory in a VPATH build with
-#          a relative $ac_aux_dir
-#
-# The reason of the latter failure is that $top_srcdir and $ac_aux_dir
-# are both prefixed by $srcdir.  In an in-source build this is usually
-# harmless because $srcdir is `.', but things will broke when you
-# start a VPATH build or use an absolute $srcdir.
-#
-# So we could use something similar to $top_srcdir/$ac_aux_dir/missing,
-# iff we strip the leading $srcdir from $ac_aux_dir.  That would be:
-#   am_aux_dir='\$(top_srcdir)/'`expr "$ac_aux_dir" : "$srcdir//*\(.*\)"`
-# and then we would define $MISSING as
-#   MISSING="\${SHELL} $am_aux_dir/missing"
-# This will work as long as MISSING is not called from configure, because
-# unfortunately $(top_srcdir) has no meaning in configure.
-# However there are other variables, like CC, which are often used in
-# configure, and could therefore not use this "fixed" $ac_aux_dir.
-#
-# Another solution, used here, is to always expand $ac_aux_dir to an
-# absolute PATH.  The drawback is that using absolute paths prevent a
-# configured tree to be moved without reconfiguration.
-
-# Rely on autoconf to set up CDPATH properly.
-AC_PREREQ([2.50])
-
-AC_DEFUN([AM_AUX_DIR_EXPAND], [
-# expand $ac_aux_dir to an absolute path
-am_aux_dir=`cd $ac_aux_dir && pwd`
-])
-
-# AM_PROG_INSTALL_SH
-# ------------------
-# Define $install_sh.
-
-# Copyright 2001 Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
-AC_DEFUN([AM_PROG_INSTALL_SH],
-[AC_REQUIRE([AM_AUX_DIR_EXPAND])dnl
-install_sh=${install_sh-"$am_aux_dir/install-sh"}
-AC_SUBST(install_sh)])
-
-# AM_PROG_INSTALL_STRIP
-
-# Copyright 2001 Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
-# One issue with vendor `install' (even GNU) is that you can't
-# specify the program used to strip binaries.  This is especially
-# annoying in cross-compiling environments, where the build's strip
-# is unlikely to handle the host's binaries.
-# Fortunately install-sh will honor a STRIPPROG variable, so we
-# always use install-sh in `make install-strip', and initialize
-# STRIPPROG with the value of the STRIP variable (set by the user).
-AC_DEFUN([AM_PROG_INSTALL_STRIP],
-[AC_REQUIRE([AM_PROG_INSTALL_SH])dnl
-# Installed binaries are usually stripped using `strip' when the user
-# run `make install-strip'.  However `strip' might not be the right
-# tool to use in cross-compilation environments, therefore Automake
-# will honor the `STRIP' environment variable to overrule this program.
-dnl Don't test for $cross_compiling = yes, because it might be `maybe'.
-if test "$cross_compiling" != no; then
-  AC_CHECK_TOOL([STRIP], [strip], :)
-fi
-INSTALL_STRIP_PROGRAM="\${SHELL} \$(install_sh) -c -s"
-AC_SUBST([INSTALL_STRIP_PROGRAM])])
-
-#                                                          -*- Autoconf -*-
-# Copyright (C) 2003  Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
-# serial 1
-
-# Check whether the underlying file-system supports filenames
-# with a leading dot.  For instance MS-DOS doesn't.
-AC_DEFUN([AM_SET_LEADING_DOT],
-[rm -rf .tst 2>/dev/null
-mkdir .tst 2>/dev/null
-if test -d .tst; then
-  am__leading_dot=.
-else
-  am__leading_dot=_
-fi
-rmdir .tst 2>/dev/null
-AC_SUBST([am__leading_dot])])
-
-# serial 5						-*- Autoconf -*-
-
-# Copyright (C) 1999, 2000, 2001, 2002, 2003  Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
-
-# There are a few dirty hacks below to avoid letting `AC_PROG_CC' be
-# written in clear, in which case automake, when reading aclocal.m4,
-# will think it sees a *use*, and therefore will trigger all it's
-# C support machinery.  Also note that it means that autoscan, seeing
-# CC etc. in the Makefile, will ask for an AC_PROG_CC use...
-
-
-
-# _AM_DEPENDENCIES(NAME)
-# ----------------------
-# See how the compiler implements dependency checking.
-# NAME is "CC", "CXX", "GCJ", or "OBJC".
-# We try a few techniques and use that to set a single cache variable.
-#
-# We don't AC_REQUIRE the corresponding AC_PROG_CC since the latter was
-# modified to invoke _AM_DEPENDENCIES(CC); we would have a circular
-# dependency, and given that the user is not expected to run this macro,
-# just rely on AC_PROG_CC.
-AC_DEFUN([_AM_DEPENDENCIES],
-[AC_REQUIRE([AM_SET_DEPDIR])dnl
-AC_REQUIRE([AM_OUTPUT_DEPENDENCY_COMMANDS])dnl
-AC_REQUIRE([AM_MAKE_INCLUDE])dnl
-AC_REQUIRE([AM_DEP_TRACK])dnl
-
-ifelse([$1], CC,   [depcc="$CC"   am_compiler_list=],
-       [$1], CXX,  [depcc="$CXX"  am_compiler_list=],
-       [$1], OBJC, [depcc="$OBJC" am_compiler_list='gcc3 gcc'],
-       [$1], GCJ,  [depcc="$GCJ"  am_compiler_list='gcc3 gcc'],
-                   [depcc="$$1"   am_compiler_list=])
-
-AC_CACHE_CHECK([dependency style of $depcc],
-               [am_cv_$1_dependencies_compiler_type],
-[if test -z "$AMDEP_TRUE" && test -f "$am_depcomp"; then
-  # We make a subdir and do the tests there.  Otherwise we can end up
-  # making bogus files that we don't know about and never remove.  For
-  # instance it was reported that on HP-UX the gcc test will end up
-  # making a dummy file named `D' -- because `-MD' means `put the output
-  # in D'.
-  mkdir conftest.dir
-  # Copy depcomp to subdir because otherwise we won't find it if we're
-  # using a relative directory.
-  cp "$am_depcomp" conftest.dir
-  cd conftest.dir
-  # We will build objects and dependencies in a subdirectory because
-  # it helps to detect inapplicable dependency modes.  For instance
-  # both Tru64's cc and ICC support -MD to output dependencies as a
-  # side effect of compilation, but ICC will put the dependencies in
-  # the current directory while Tru64 will put them in the object
-  # directory.
-  mkdir sub
-
-  am_cv_$1_dependencies_compiler_type=none
-  if test "$am_compiler_list" = ""; then
-     am_compiler_list=`sed -n ['s/^#*\([a-zA-Z0-9]*\))$/\1/p'] < ./depcomp`
-  fi
-  for depmode in $am_compiler_list; do
-    # Setup a source with many dependencies, because some compilers
-    # like to wrap large dependency lists on column 80 (with \), and
-    # we should not choose a depcomp mode which is confused by this.
-    #
-    # We need to recreate these files for each test, as the compiler may
-    # overwrite some of them when testing with obscure command lines.
-    # This happens at least with the AIX C compiler.
-    : > sub/conftest.c
-    for i in 1 2 3 4 5 6; do
-      echo '#include "conftst'$i'.h"' >> sub/conftest.c
-      : > sub/conftst$i.h
-    done
-    echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
-
-    case $depmode in
-    nosideeffect)
-      # after this tag, mechanisms are not by side-effect, so they'll
-      # only be used when explicitly requested
-      if test "x$enable_dependency_tracking" = xyes; then
-	continue
-      else
-	break
-      fi
-      ;;
-    none) break ;;
-    esac
-    # We check with `-c' and `-o' for the sake of the "dashmstdout"
-    # mode.  It turns out that the SunPro C++ compiler does not properly
-    # handle `-M -o', and we need to detect this.
-    if depmode=$depmode \
-       source=sub/conftest.c object=sub/conftest.${OBJEXT-o} \
-       depfile=sub/conftest.Po tmpdepfile=sub/conftest.TPo \
-       $SHELL ./depcomp $depcc -c -o sub/conftest.${OBJEXT-o} sub/conftest.c \
-         >/dev/null 2>conftest.err &&
-       grep sub/conftst6.h sub/conftest.Po > /dev/null 2>&1 &&
-       grep sub/conftest.${OBJEXT-o} sub/conftest.Po > /dev/null 2>&1 &&
-       ${MAKE-make} -s -f confmf > /dev/null 2>&1; then
-      # icc doesn't choke on unknown options, it will just issue warnings
-      # (even with -Werror).  So we grep stderr for any message
-      # that says an option was ignored.
-      if grep 'ignoring option' conftest.err >/dev/null 2>&1; then :; else
-        am_cv_$1_dependencies_compiler_type=$depmode
-        break
-      fi
-    fi
-  done
-
-  cd ..
-  rm -rf conftest.dir
-else
-  am_cv_$1_dependencies_compiler_type=none
-fi
-])
-AC_SUBST([$1DEPMODE], [depmode=$am_cv_$1_dependencies_compiler_type])
-AM_CONDITIONAL([am__fastdep$1], [
-  test "x$enable_dependency_tracking" != xno \
-  && test "$am_cv_$1_dependencies_compiler_type" = gcc3])
-])
-
-
-# AM_SET_DEPDIR
-# -------------
-# Choose a directory name for dependency files.
-# This macro is AC_REQUIREd in _AM_DEPENDENCIES
-AC_DEFUN([AM_SET_DEPDIR],
-[AC_REQUIRE([AM_SET_LEADING_DOT])dnl
-AC_SUBST([DEPDIR], ["${am__leading_dot}deps"])dnl
-])
-
-
-# AM_DEP_TRACK
-# ------------
-AC_DEFUN([AM_DEP_TRACK],
-[AC_ARG_ENABLE(dependency-tracking,
-[  --disable-dependency-tracking Speeds up one-time builds
-  --enable-dependency-tracking  Do not reject slow dependency extractors])
-if test "x$enable_dependency_tracking" != xno; then
-  am_depcomp="$ac_aux_dir/depcomp"
-  AMDEPBACKSLASH='\'
-fi
-AM_CONDITIONAL([AMDEP], [test "x$enable_dependency_tracking" != xno])
-AC_SUBST([AMDEPBACKSLASH])
-])
-
-# Generate code to set up dependency tracking.   -*- Autoconf -*-
-
-# Copyright 1999, 2000, 2001, 2002 Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
-#serial 2
-
-# _AM_OUTPUT_DEPENDENCY_COMMANDS
-# ------------------------------
-AC_DEFUN([_AM_OUTPUT_DEPENDENCY_COMMANDS],
-[for mf in $CONFIG_FILES; do
-  # Strip MF so we end up with the name of the file.
-  mf=`echo "$mf" | sed -e 's/:.*$//'`
-  # Check whether this is an Automake generated Makefile or not.
-  # We used to match only the files named `Makefile.in', but
-  # some people rename them; so instead we look at the file content.
-  # Grep'ing the first line is not enough: some people post-process
-  # each Makefile.in and add a new line on top of each file to say so.
-  # So let's grep whole file.
-  if grep '^#.*generated by automake' $mf > /dev/null 2>&1; then
-    dirpart=`AS_DIRNAME("$mf")`
-  else
-    continue
-  fi
-  grep '^DEP_FILES *= *[[^ @%:@]]' < "$mf" > /dev/null || continue
-  # Extract the definition of DEP_FILES from the Makefile without
-  # running `make'.
-  DEPDIR=`sed -n -e '/^DEPDIR = / s///p' < "$mf"`
-  test -z "$DEPDIR" && continue
-  # When using ansi2knr, U may be empty or an underscore; expand it
-  U=`sed -n -e '/^U = / s///p' < "$mf"`
-  test -d "$dirpart/$DEPDIR" || mkdir "$dirpart/$DEPDIR"
-  # We invoke sed twice because it is the simplest approach to
-  # changing $(DEPDIR) to its actual value in the expansion.
-  for file in `sed -n -e '
-    /^DEP_FILES = .*\\\\$/ {
-      s/^DEP_FILES = //
-      :loop
-	s/\\\\$//
-	p
-	n
-	/\\\\$/ b loop
-      p
-    }
-    /^DEP_FILES = / s/^DEP_FILES = //p' < "$mf" | \
-       sed -e 's/\$(DEPDIR)/'"$DEPDIR"'/g' -e 's/\$U/'"$U"'/g'`; do
-    # Make sure the directory exists.
-    test -f "$dirpart/$file" && continue
-    fdir=`AS_DIRNAME(["$file"])`
-    AS_MKDIR_P([$dirpart/$fdir])
-    # echo "creating $dirpart/$file"
-    echo '# dummy' > "$dirpart/$file"
-  done
-done
-])# _AM_OUTPUT_DEPENDENCY_COMMANDS
-
-
-# AM_OUTPUT_DEPENDENCY_COMMANDS
-# -----------------------------
-# This macro should only be invoked once -- use via AC_REQUIRE.
-#
-# This code is only required when automatic dependency tracking
-# is enabled.  FIXME.  This creates each `.P' file that we will
-# need in order to bootstrap the dependency handling code.
-AC_DEFUN([AM_OUTPUT_DEPENDENCY_COMMANDS],
-[AC_CONFIG_COMMANDS([depfiles],
-     [test x"$AMDEP_TRUE" != x"" || _AM_OUTPUT_DEPENDENCY_COMMANDS],
-     [AMDEP_TRUE="$AMDEP_TRUE" ac_aux_dir="$ac_aux_dir"])
-])
-
-# Check to see how 'make' treats includes.	-*- Autoconf -*-
-
-# Copyright (C) 2001, 2002, 2003 Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
-# serial 2
-
-# AM_MAKE_INCLUDE()
-# -----------------
-# Check to see how make treats includes.
-AC_DEFUN([AM_MAKE_INCLUDE],
-[am_make=${MAKE-make}
-cat > confinc << 'END'
-am__doit:
-	@echo done
-.PHONY: am__doit
-END
-# If we don't find an include directive, just comment out the code.
-AC_MSG_CHECKING([for style of include used by $am_make])
-am__include="#"
-am__quote=
-_am_result=none
-# First try GNU make style include.
-echo "include confinc" > confmf
-# We grep out `Entering directory' and `Leaving directory'
-# messages which can occur if `w' ends up in MAKEFLAGS.
-# In particular we don't look at `^make:' because GNU make might
-# be invoked under some other name (usually "gmake"), in which
-# case it prints its new name instead of `make'.
-if test "`$am_make -s -f confmf 2> /dev/null | grep -v 'ing directory'`" = "done"; then
-   am__include=include
-   am__quote=
-   _am_result=GNU
-fi
-# Now try BSD make style include.
-if test "$am__include" = "#"; then
-   echo '.include "confinc"' > confmf
-   if test "`$am_make -s -f confmf 2> /dev/null`" = "done"; then
-      am__include=.include
-      am__quote="\""
-      _am_result=BSD
-   fi
-fi
-AC_SUBST([am__include])
-AC_SUBST([am__quote])
-AC_MSG_RESULT([$_am_result])
-rm -f confinc confmf
-])
-
-# AM_CONDITIONAL                                              -*- Autoconf -*-
-
-# Copyright 1997, 2000, 2001 Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
-# serial 5
-
-AC_PREREQ(2.52)
-
-# AM_CONDITIONAL(NAME, SHELL-CONDITION)
-# -------------------------------------
-# Define a conditional.
-AC_DEFUN([AM_CONDITIONAL],
-[ifelse([$1], [TRUE],  [AC_FATAL([$0: invalid condition: $1])],
-        [$1], [FALSE], [AC_FATAL([$0: invalid condition: $1])])dnl
-AC_SUBST([$1_TRUE])
-AC_SUBST([$1_FALSE])
-if $2; then
-  $1_TRUE=
-  $1_FALSE='#'
-else
-  $1_TRUE='#'
-  $1_FALSE=
-fi
-AC_CONFIG_COMMANDS_PRE(
-[if test -z "${$1_TRUE}" && test -z "${$1_FALSE}"; then
-  AC_MSG_ERROR([conditional "$1" was never defined.
-Usually this means the macro was only invoked conditionally.])
-fi])])
-
-
-dnl PKG_CHECK_MODULES(GSTUFF, gtk+-2.0 >= 1.3 glib = 1.3.4, action-if, action-not)
-dnl defines GSTUFF_LIBS, GSTUFF_CFLAGS, see pkg-config man page
-dnl also defines GSTUFF_PKG_ERRORS on error
-AC_DEFUN(PKG_CHECK_MODULES, [
-  succeeded=no
-
-  if test -z "$PKG_CONFIG"; then
-    AC_PATH_PROG(PKG_CONFIG, pkg-config, no)
-  fi
-
-  if test "$PKG_CONFIG" = "no" ; then
-     echo "*** The pkg-config script could not be found. Make sure it is"
-     echo "*** in your path, or set the PKG_CONFIG environment variable"
-     echo "*** to the full path to pkg-config."
-     echo "*** Or see http://www.freedesktop.org/software/pkgconfig to get pkg-config."
-  else
-     PKG_CONFIG_MIN_VERSION=0.9.0
-     if $PKG_CONFIG --atleast-pkgconfig-version $PKG_CONFIG_MIN_VERSION; then
-        AC_MSG_CHECKING(for $2)
-
-        if $PKG_CONFIG --exists "$2" ; then
-            AC_MSG_RESULT(yes)
-            succeeded=yes
-
-            AC_MSG_CHECKING($1_CFLAGS)
-            $1_CFLAGS=`$PKG_CONFIG --cflags "$2"`
-            AC_MSG_RESULT($$1_CFLAGS)
-
-            AC_MSG_CHECKING($1_LIBS)
-            $1_LIBS=`$PKG_CONFIG --libs "$2"`
-            AC_MSG_RESULT($$1_LIBS)
-        else
-            $1_CFLAGS=""
-            $1_LIBS=""
-            ## If we have a custom action on failure, don't print errors, but 
-            ## do set a variable so people can do so.
-            $1_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$2"`
-            ifelse([$4], ,echo $$1_PKG_ERRORS,)
-        fi
-
-        AC_SUBST($1_CFLAGS)
-        AC_SUBST($1_LIBS)
-     else
-        echo "*** Your version of pkg-config is too old. You need version $PKG_CONFIG_MIN_VERSION or newer."
-        echo "*** See http://www.freedesktop.org/software/pkgconfig"
-     fi
-  fi
-
-  if test $succeeded = yes; then
-     ifelse([$3], , :, [$3])
-  else
-     ifelse([$4], , AC_MSG_ERROR([Library requirements ($2) not met; consider adjusting the PKG_CONFIG_PATH environment variable if your libraries are in a nonstandard prefix so pkg-config can find them.]), [$4])
-  fi
-])
-
-
-

Modified: tags/windstille-0.2.0/autogen.sh
===================================================================
--- tags/windstille-0.2.0/autogen.sh	2009-09-27 11:38:37 UTC (rev 3266)
+++ tags/windstille-0.2.0/autogen.sh	2009-09-27 11:42:19 UTC (rev 3267)
@@ -1,7 +1,7 @@
 #!/bin/sh
 
 aclocal-1.7
-automake-1.7 --force --copy --add-missing
+automake-1.7 --copy --add-missing
 autoheader
 autoconf
 

Modified: tags/windstille-0.2.0/configure.ac
===================================================================
--- tags/windstille-0.2.0/configure.ac	2009-09-27 11:38:37 UTC (rev 3266)
+++ tags/windstille-0.2.0/configure.ac	2009-09-27 11:42:19 UTC (rev 3267)
@@ -14,7 +14,7 @@
 AC_CHECK_LIB(guile, scm_boot_guile)
 AC_CHECK_HEADER(guile/gh.h)
 
-REQUIRED_CLANLIB_VERSION="0.7.7"
+REQUIRED_CLANLIB_VERSION="0.8.0"
 
 CXXFLAGS="$CXXFLAGS -I\${top_srcdir}/src/"
 
@@ -43,16 +43,16 @@
 
 PKG_CHECK_MODULES(WINDSTILLE,
  [
-  clanCore-0.7           >= $REQUIRED_CLANLIB_VERSION
-  clanApp-0.7            >= $REQUIRED_CLANLIB_VERSION
-  clanDisplay-0.7        >= $REQUIRED_CLANLIB_VERSION
-  clanGL-0.7             >= $REQUIRED_CLANLIB_VERSION
-  clanGUI-0.7            >= $REQUIRED_CLANLIB_VERSION
-  clanGUIStyleSilver-0.7 >= $REQUIRED_CLANLIB_VERSION
+  clanCore-0.8           >= $REQUIRED_CLANLIB_VERSION
+  clanApp-0.8            >= $REQUIRED_CLANLIB_VERSION
+  clanDisplay-0.8        >= $REQUIRED_CLANLIB_VERSION
+  clanGL-0.8             >= $REQUIRED_CLANLIB_VERSION
+  clanGUI-0.8            >= $REQUIRED_CLANLIB_VERSION
+  clanGUIStyleSilver-0.8 >= $REQUIRED_CLANLIB_VERSION
 dnl clanSound   >= $REQUIRED_CLANLIB_VERSION
 dnl clanMikMod  >= $REQUIRED_CLANLIB_VERSION
-  clanSound-0.7  >= $REQUIRED_CLANLIB_VERSION
-  clanVorbis-0.7  >= $REQUIRED_CLANLIB_VERSION
+  clanSound-0.8  >= $REQUIRED_CLANLIB_VERSION
+  clanVorbis-0.8  >= $REQUIRED_CLANLIB_VERSION
   ],
  [])
 


Property changes on: tags/windstille-0.2.0/src
___________________________________________________________________
Name: svn:externals
   - input	svn://clanlib.org/Games/Feuerkraft/trunk/src/input/

   + 


Modified: tags/windstille-0.2.0/src/Makefile.am
===================================================================
--- tags/windstille-0.2.0/src/Makefile.am	2009-09-27 11:38:37 UTC (rev 3266)
+++ tags/windstille-0.2.0/src/Makefile.am	2009-09-27 11:42:19 UTC (rev 3267)
@@ -107,7 +107,7 @@
   editor/libwindstille_editor.a \
   collision/libwindstille_collision.a \
   guistyle/libwindstille_guistyle.a \
-  input/libfeuerkraft_input.a \
+  input/libwindstille_input.a \
   @WINDSTILLE_LIBS@
 
 windstille_CPPFLAGS = \

Modified: tags/windstille-0.2.0/src/collision/collision_mask.cxx
===================================================================
--- tags/windstille-0.2.0/src/collision/collision_mask.cxx	2009-09-27 11:38:37 UTC (rev 3266)
+++ tags/windstille-0.2.0/src/collision/collision_mask.cxx	2009-09-27 11:42:19 UTC (rev 3267)
@@ -57,7 +57,7 @@
   memset(data, ~0, sizeof(cm_uint32) * len);
 }
 
-CollisionMask::CollisionMask(CL_PixelBuffer* provider)
+CollisionMask::CollisionMask(const CL_PixelBuffer& provider)
 {
   create_from(provider);
 }
@@ -74,18 +74,18 @@
 
 CollisionMask::CollisionMask(const std::string filename)
 {
-  CL_PixelBuffer* provider = CL_ProviderFactory::load(filename);
+  CL_PixelBuffer provider = CL_ProviderFactory::load(filename);
   create_from(provider);
-  delete provider;
 }
 
 void
-CollisionMask::create_from(CL_PixelBuffer* provider)
+CollisionMask::create_from(const CL_PixelBuffer& provider_)
 {  
-  provider->lock();
+  CL_PixelBuffer& provider = const_cast<CL_PixelBuffer&>(provider_);
+  provider.lock();
 
-  width  = provider->get_width();
-  height = provider->get_height();
+  width  = provider.get_width();
+  height = provider.get_height();
   pitch  = (width/int_width + (width%int_width == 0 ? 0 : 1));
 
   int len = height * pitch;
@@ -95,13 +95,13 @@
   for (int y = 0; y < height; ++y)
     for (int x = 0; x < width; ++x)
       {
-        if (static_cast<unsigned char*>(provider->get_data())[(y * width + x) * 4] > 50)
+        if (static_cast<unsigned char*>(provider.get_data())[(y * width + x) * 4] > 50)
           put_pixel(x, y, true);
       }
 
   std::cout << width << "x" << height << std::endl;
 
-  provider->unlock(); 
+  provider.unlock(); 
 }
 
 CollisionMask::~CollisionMask()

Modified: tags/windstille-0.2.0/src/collision/collision_mask.hxx
===================================================================
--- tags/windstille-0.2.0/src/collision/collision_mask.hxx	2009-09-27 11:38:37 UTC (rev 3266)
+++ tags/windstille-0.2.0/src/collision/collision_mask.hxx	2009-09-27 11:42:19 UTC (rev 3267)
@@ -47,7 +47,7 @@
   /** Generate a collision mask from a given bitmap */
   CollisionMask(int width, int height, cm_uint32* data);
 
-  CollisionMask(CL_PixelBuffer* provider);
+  CollisionMask(const CL_PixelBuffer& provider);
   
   /** Creates a collision mask from a file */
   CollisionMask(const std::string filename);
@@ -93,7 +93,7 @@
   bool slow_pixel_collides_with(const CollisionMask& mask, int x_of, int y_of) const;
 
 private:
-  void create_from(CL_PixelBuffer* provider);
+  void create_from(const CL_PixelBuffer& provider);
 
   /** Checks pixel precisly if the two collision masks collide */
   bool pixel_collides_with(const CollisionMask& mask, int x_of, int y_of) const;

Modified: tags/windstille-0.2.0/src/editor/editor_tilemap.cxx
===================================================================
--- tags/windstille-0.2.0/src/editor/editor_tilemap.cxx	2009-09-27 11:38:37 UTC (rev 3266)
+++ tags/windstille-0.2.0/src/editor/editor_tilemap.cxx	2009-09-27 11:42:19 UTC (rev 3267)
@@ -186,7 +186,8 @@
   //glScalef(get_zoom(), get_zoom(), 1.0f);
   //glTranslatef(trans_offset.x, trans_offset.y, 0.0f);
 
-  CL_Display::push_translate_offset(int(trans_offset.x), int(trans_offset.y));
+  CL_Display::push_modelview();
+  CL_Display::add_translate(int(trans_offset.x), int(trans_offset.y));
 
   CL_Display::clear(CL_Color(100, 0, 100));
 
@@ -221,7 +222,7 @@
           }
     }
 
-  CL_Display::pop_translate_offset();
+  CL_Display::pop_modelview();
   // glPopMatrix();
 }
 

Modified: tags/windstille-0.2.0/src/editor/tile_selector.cxx
===================================================================
--- tags/windstille-0.2.0/src/editor/tile_selector.cxx	2009-09-27 11:38:37 UTC (rev 3266)
+++ tags/windstille-0.2.0/src/editor/tile_selector.cxx	2009-09-27 11:42:19 UTC (rev 3267)
@@ -96,7 +96,8 @@
 void 
 TileSelector::draw()
 {
-  CL_Display::push_translate_offset(0, -offset);
+  CL_Display::push_modelview();
+  CL_Display::add_translate(0, -offset);
   for(int y = 0; y < /*height FIXME*/ 40; ++y)
     for(int x = 0; x < width; ++x)
       {
@@ -125,7 +126,7 @@
                                   CL_Color(0,0,255, 20));
           }
       }
-  CL_Display::pop_translate_offset();
+  CL_Display::pop_modelview();
 }
 
 /* EOF */


Property changes on: tags/windstille-0.2.0/src/input
___________________________________________________________________
Name: svn:ignore
   + .deps
Makefile
Makefile.in


Modified: tags/windstille-0.2.0/src/player_view.cxx
===================================================================
--- tags/windstille-0.2.0/src/player_view.cxx	2009-09-27 11:38:37 UTC (rev 3266)
+++ tags/windstille-0.2.0/src/player_view.cxx	2009-09-27 11:42:19 UTC (rev 3267)
@@ -32,10 +32,11 @@
 void
 PlayerView::draw ()
 {
-  CL_Display::push_translate_offset(int(-pos.x + CL_Display::get_width ()/2),
-                                    int(-pos.y + CL_Display::get_height ()/2));
+  CL_Display::push_modelview();
+  CL_Display::add_translate(int(-pos.x + CL_Display::get_width ()/2),
+                            int(-pos.y + CL_Display::get_height ()/2));
   world->draw ();
-  CL_Display::pop_translate_offset();
+  CL_Display::pop_modelview();
 }
 
 void

Modified: tags/windstille-0.2.0/src/screenshot.cxx
===================================================================
--- tags/windstille-0.2.0/src/screenshot.cxx	2009-09-27 11:38:37 UTC (rev 3266)
+++ tags/windstille-0.2.0/src/screenshot.cxx	2009-09-27 11:42:19 UTC (rev 3267)
@@ -28,7 +28,7 @@
 void
 Screenshot::write_screenshot_pnm(const std::string& filename)
 {
-  CL_PixelBuffer* buf = take_screen_shot();
+  CL_PixelBuffer buf = take_screen_shot();
 
   FILE* out = fopen(filename.c_str(), "wb");
   
@@ -39,10 +39,10 @@
       return;
     }
 
-  buf->lock();
-  int width  = buf->get_width();
-  int pitch  = buf->get_width()*3;
-  int height = buf->get_height();
+  buf.lock();
+  int width  = buf.get_width();
+  int pitch  = buf.get_width()*3;
+  int height = buf.get_height();
 
   fprintf(out,
 	  "P6\n"
@@ -52,7 +52,7 @@
 	  width,
 	  height);
 
-  unsigned char* data = static_cast<unsigned char*>(buf->get_data());
+  unsigned char* data = static_cast<unsigned char*>(buf.get_data());
   
   for(int i = height-1; i >= 0; --i)
     {
@@ -62,13 +62,11 @@
              out);
     }
 
-  buf->unlock();
+  buf.unlock();
   fclose(out);
-  
-  delete buf;
 }
 
-CL_PixelBuffer*
+CL_PixelBuffer
 Screenshot::take_screen_shot()
 {
   CL_PixelBuffer back_buffer = CL_Display::get_current_window()->get_back_buffer();
@@ -76,7 +74,7 @@
   unsigned short width = back_buffer.get_width();
   unsigned short height = back_buffer.get_height();
 		
-  CL_PixelBuffer *pbuf = new CL_PixelBuffer(width, height, width*3, CL_PixelFormat::bgr888);
+  CL_PixelBuffer pbuf(width, height, width*3, CL_PixelFormat::bgr888);
   back_buffer.convert(pbuf);
   
   return pbuf;

Modified: tags/windstille-0.2.0/src/screenshot.hxx
===================================================================
--- tags/windstille-0.2.0/src/screenshot.hxx	2009-09-27 11:38:37 UTC (rev 3266)
+++ tags/windstille-0.2.0/src/screenshot.hxx	2009-09-27 11:42:19 UTC (rev 3267)
@@ -29,7 +29,7 @@
 {
 private:
 public:
-  static CL_PixelBuffer* take_screen_shot();
+  static CL_PixelBuffer take_screen_shot();
   static void write_screenshot_pnm(const std::string& filename);
 private:
   Screenshot (const Screenshot&);

Modified: tags/windstille-0.2.0/src/tile.cxx
===================================================================
--- tags/windstille-0.2.0/src/tile.cxx	2009-09-27 11:38:37 UTC (rev 3266)
+++ tags/windstille-0.2.0/src/tile.cxx	2009-09-27 11:42:19 UTC (rev 3267)
@@ -17,6 +17,8 @@
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
+#include <string.h>
+
 #include "globals.hxx"
 #include "tile.hxx"
 

Modified: tags/windstille-0.2.0/src/windstille_bonus.cxx
===================================================================
--- tags/windstille-0.2.0/src/windstille_bonus.cxx	2009-09-27 11:38:37 UTC (rev 3266)
+++ tags/windstille-0.2.0/src/windstille_bonus.cxx	2009-09-27 11:42:19 UTC (rev 3267)
@@ -32,7 +32,7 @@
 
 WindstilleBonus::WindstilleBonus()
 {
-  std::list<std::string> llst = resources->get_all_resources("bonus");
+  std::vector<std::string> llst = resources->get_all_resources("bonus");
   std::copy(llst.begin(), llst.end(), std::back_inserter(lst));
   std::random_shuffle(lst.begin(), lst.end());
 

Modified: tags/windstille-0.2.0/src/windstille_main.hxx
===================================================================
--- tags/windstille-0.2.0/src/windstille_main.hxx	2009-09-27 11:38:37 UTC (rev 3266)
+++ tags/windstille-0.2.0/src/windstille_main.hxx	2009-09-27 11:42:19 UTC (rev 3267)
@@ -44,7 +44,7 @@
   WindstilleMain();
   ~WindstilleMain();
 
-  virtual char* get_title() { return "Windstille"; }
+  virtual const char* get_title() { return "Windstille"; }
   virtual int main(int argc, char** argv);
 
 private:



From grumbel at mail.berlios.de  Sun Sep 27 14:07:06 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sun, 27 Sep 2009 14:07:06 +0200
Subject: [Windstille-commit] r3268 - in branches: . windstille-0.1.x
	windstille-0.1.x/data windstille-0.1.x/data/gui
	windstille-0.1.x/data/gui/checkbox windstille-0.1.x/data/gui/fonts
	windstille-0.1.x/data/gui/menu
	windstille-0.1.x/data/gui/radiobutton windstille-0.1.x/src
	windstille-0.1.x/src/editor
Message-ID: <200909271207.n8RC76ZF030455@sheep.berlios.de>

Author: grumbel
Date: 2009-09-27 14:06:38 +0200 (Sun, 27 Sep 2009)
New Revision: 3268

Added:
   branches/windstille-0.1.x/
   branches/windstille-0.1.x/data/Makefile.am
   branches/windstille-0.1.x/data/editor.scm
   branches/windstille-0.1.x/data/game.scm
   branches/windstille-0.1.x/data/gui/
   branches/windstille-0.1.x/data/gui/checkbox/
   branches/windstille-0.1.x/data/gui/checkbox/checked.tga
   branches/windstille-0.1.x/data/gui/checkbox/checked_disabled.tga
   branches/windstille-0.1.x/data/gui/checkbox/unchecked.tga
   branches/windstille-0.1.x/data/gui/checkbox/unchecked_disabled.tga
   branches/windstille-0.1.x/data/gui/fonts/
   branches/windstille-0.1.x/data/gui/fonts/font_black.tga
   branches/windstille-0.1.x/data/gui/fonts/font_gray.tga
   branches/windstille-0.1.x/data/gui/gui.xml
   branches/windstille-0.1.x/data/gui/menu/
   branches/windstille-0.1.x/data/gui/menu/arrow.png
   branches/windstille-0.1.x/data/gui/menu/checked.png
   branches/windstille-0.1.x/data/gui/menu/unchecked.png
   branches/windstille-0.1.x/data/gui/radiobutton/
   branches/windstille-0.1.x/data/gui/radiobutton/checked.tga
   branches/windstille-0.1.x/data/gui/radiobutton/checked_disabled.tga
   branches/windstille-0.1.x/data/gui/radiobutton/unchecked.tga
   branches/windstille-0.1.x/data/gui/radiobutton/unchecked_disabled.tga
   branches/windstille-0.1.x/data/tiles.scm
   branches/windstille-0.1.x/data/tiles.xml
   branches/windstille-0.1.x/data/windstille.scr
   branches/windstille-0.1.x/data/windstille.xml
Modified:
   branches/windstille-0.1.x/INSTALL
   branches/windstille-0.1.x/aclocal.m4
   branches/windstille-0.1.x/configure
   branches/windstille-0.1.x/configure.ac
   branches/windstille-0.1.x/src/display.cxx
   branches/windstille-0.1.x/src/display.hxx
   branches/windstille-0.1.x/src/editor/editor_tile.cxx
   branches/windstille-0.1.x/src/guile_gameobj_factory.cxx
   branches/windstille-0.1.x/src/player_view.cxx
   branches/windstille-0.1.x/src/tile.cxx
   branches/windstille-0.1.x/src/tile.hxx
   branches/windstille-0.1.x/src/windstille_game.cxx
Log:
Some work to get Windstille-0.1.x into a compilable state (doesn't yet run)

Copied: branches/windstille-0.1.x (from rev 3267, tags/windstille-0.1.0)

Modified: branches/windstille-0.1.x/INSTALL
===================================================================
--- tags/windstille-0.1.0/INSTALL	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/INSTALL	2009-09-27 12:06:38 UTC (rev 3268)
@@ -1,30 +1,229 @@
-Windstille Installion
+Copyright (C) 1994, 1995, 1996, 1999, 2000, 2001, 2002 Free Software
+Foundation, Inc.
+
+   This file is free documentation; the Free Software Foundation gives
+unlimited permission to copy, distribute and modify it.
+
+Basic Installation
+==================
+
+   These are generic installation instructions.
+
+   The `configure' shell script attempts to guess correct values for
+various system-dependent variables used during compilation.  It uses
+those values to create a `Makefile' in each directory of the package.
+It may also create one or more `.h' files containing system-dependent
+definitions.  Finally, it creates a shell script `config.status' that
+you can run in the future to recreate the current configuration, and a
+file `config.log' containing compiler output (useful mainly for
+debugging `configure').
+
+   It can also use an optional file (typically called `config.cache'
+and enabled with `--cache-file=config.cache' or simply `-C') that saves
+the results of its tests to speed up reconfiguring.  (Caching is
+disabled by default to prevent problems with accidental use of stale
+cache files.)
+
+   If you need to do unusual things to compile the package, please try
+to figure out how `configure' could check whether to do them, and mail
+diffs or instructions to the address given in the `README' so they can
+be considered for the next release.  If you are using the cache, and at
+some point `config.cache' contains results you don't want to keep, you
+may remove or edit it.
+
+   The file `configure.ac' (or `configure.in') is used to create
+`configure' by a program called `autoconf'.  You only need
+`configure.ac' if you want to change it or regenerate `configure' using
+a newer version of `autoconf'.
+
+The simplest way to compile this package is:
+
+  1. `cd' to the directory containing the package's source code and type
+     `./configure' to configure the package for your system.  If you're
+     using `csh' on an old version of System V, you might need to type
+     `sh ./configure' instead to prevent `csh' from trying to execute
+     `configure' itself.
+
+     Running `configure' takes awhile.  While running, it prints some
+     messages telling which features it is checking for.
+
+  2. Type `make' to compile the package.
+
+  3. Optionally, type `make check' to run any self-tests that come with
+     the package.
+
+  4. Type `make install' to install the programs and any data files and
+     documentation.
+
+  5. You can remove the program binaries and object files from the
+     source code directory by typing `make clean'.  To also remove the
+     files that `configure' created (so you can compile the package for
+     a different kind of computer), type `make distclean'.  There is
+     also a `make maintainer-clean' target, but that is intended mainly
+     for the package's developers.  If you use it, you may have to get
+     all sorts of other programs in order to regenerate files that came
+     with the distribution.
+
+Compilers and Options
 =====================
 
-Binary:
-=======
+   Some systems require unusual options for compilation or linking that
+the `configure' script does not know about.  Run `./configure --help'
+for details on some of the pertinent environment variables.
 
-Simply run the 'windstille' script in the top-level directory, if you
-have OpenGL installed it should work out of the box without any extra
-library requirements. Its important that you run the script, not the
-'windstille.static' binary itself, since it might not work that way.
+   You can give `configure' initial values for configuration parameters
+by setting variables in the command line or in the environment.  Here
+is an example:
 
+     ./configure CC=c89 CFLAGS=-O2 LIBS=-lposix
 
-Source:
-=======
+   *Note Defining Variables::, for more details.
 
-Windstille requires a CVS version of ClanLib-0.7 and a installation of
-Guile 1.6, once you have compiled and installed both a simple:
+Compiling For Multiple Architectures
+====================================
 
- % ./configure
- % make 
+   You can compile the package for more than one kind of computer at the
+same time, by placing the object files for each architecture in their
+own directory.  To do this, you must use a version of `make' that
+supports the `VPATH' variable, such as GNU `make'.  `cd' to the
+directory where you want the object files and executables to go and run
+the `configure' script.  `configure' automatically checks for the
+source code in the directory that `configure' is in and in `..'.
 
-compiles Windstille, you way than run it by:
+   If you have to use a `make' that does not support the `VPATH'
+variable, you have to compile the package for one architecture at a
+time in the source code directory.  After you have installed the
+package for one architecture, use `make distclean' before reconfiguring
+for another architecture.
 
- % cd src/
- % ./windstille
+Installation Names
+==================
 
-Installation is currently not supported.
+   By default, `make install' will install the package's files in
+`/usr/local/bin', `/usr/local/man', etc.  You can specify an
+installation prefix other than `/usr/local' by giving `configure' the
+option `--prefix=PATH'.
 
+   You can specify separate installation prefixes for
+architecture-specific files and architecture-independent files.  If you
+give `configure' the option `--exec-prefix=PATH', the package will use
+PATH as the prefix for installing programs and libraries.
+Documentation and other data files will still use the regular prefix.
 
-# EOF #
+   In addition, if you use an unusual directory layout you can give
+options like `--bindir=PATH' to specify different values for particular
+kinds of files.  Run `configure --help' for a list of the directories
+you can set and what kinds of files go in them.
+
+   If the package supports it, you can cause programs to be installed
+with an extra prefix or suffix on their names by giving `configure' the
+option `--program-prefix=PREFIX' or `--program-suffix=SUFFIX'.
+
+Optional Features
+=================
+
+   Some packages pay attention to `--enable-FEATURE' options to
+`configure', where FEATURE indicates an optional part of the package.
+They may also pay attention to `--with-PACKAGE' options, where PACKAGE
+is something like `gnu-as' or `x' (for the X Window System).  The
+`README' should mention any `--enable-' and `--with-' options that the
+package recognizes.
+
+   For packages that use the X Window System, `configure' can usually
+find the X include and library files automatically, but if it doesn't,
+you can use the `configure' options `--x-includes=DIR' and
+`--x-libraries=DIR' to specify their locations.
+
+Specifying the System Type
+==========================
+
+   There may be some features `configure' cannot figure out
+automatically, but needs to determine by the type of machine the package
+will run on.  Usually, assuming the package is built to be run on the
+_same_ architectures, `configure' can figure that out, but if it prints
+a message saying it cannot guess the machine type, give it the
+`--build=TYPE' option.  TYPE can either be a short name for the system
+type, such as `sun4', or a canonical name which has the form:
+
+     CPU-COMPANY-SYSTEM
+
+where SYSTEM can have one of these forms:
+
+     OS KERNEL-OS
+
+   See the file `config.sub' for the possible values of each field.  If
+`config.sub' isn't included in this package, then this package doesn't
+need to know the machine type.
+
+   If you are _building_ compiler tools for cross-compiling, you should
+use the `--target=TYPE' option to select the type of system they will
+produce code for.
+
+   If you want to _use_ a cross compiler, that generates code for a
+platform different from the build platform, you should specify the
+"host" platform (i.e., that on which the generated programs will
+eventually be run) with `--host=TYPE'.
+
+Sharing Defaults
+================
+
+   If you want to set default values for `configure' scripts to share,
+you can create a site shell script called `config.site' that gives
+default values for variables like `CC', `cache_file', and `prefix'.
+`configure' looks for `PREFIX/share/config.site' if it exists, then
+`PREFIX/etc/config.site' if it exists.  Or, you can set the
+`CONFIG_SITE' environment variable to the location of the site script.
+A warning: not all `configure' scripts look for a site script.
+
+Defining Variables
+==================
+
+   Variables not defined in a site shell script can be set in the
+environment passed to `configure'.  However, some packages may run
+configure again during the build, and the customized values of these
+variables may be lost.  In order to avoid this problem, you should set
+them in the `configure' command line, using `VAR=value'.  For example:
+
+     ./configure CC=/usr/local2/bin/gcc
+
+will cause the specified gcc to be used as the C compiler (unless it is
+overridden in the site shell script).
+
+`configure' Invocation
+======================
+
+   `configure' recognizes the following options to control how it
+operates.
+
+`--help'
+`-h'
+     Print a summary of the options to `configure', and exit.
+
+`--version'
+`-V'
+     Print the version of Autoconf used to generate the `configure'
+     script, and exit.
+
+`--cache-file=FILE'
+     Enable the cache: use and save the results of the tests in FILE,
+     traditionally `config.cache'.  FILE defaults to `/dev/null' to
+     disable caching.
+
+`--config-cache'
+`-C'
+     Alias for `--cache-file=config.cache'.
+
+`--quiet'
+`--silent'
+`-q'
+     Do not print messages saying which checks are being made.  To
+     suppress all normal output, redirect it to `/dev/null' (any error
+     messages will still be shown).
+
+`--srcdir=DIR'
+     Look for the package's source code in directory DIR.  Usually
+     `configure' can determine that directory automatically.
+
+`configure' also accepts some other, not widely useful, options.  Run
+`configure --help' for more details.
+

Modified: branches/windstille-0.1.x/aclocal.m4
===================================================================
--- tags/windstille-0.1.0/aclocal.m4	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/aclocal.m4	2009-09-27 12:06:38 UTC (rev 3268)
@@ -1,4 +1,4 @@
-# generated automatically by aclocal 1.7.3 -*- Autoconf -*-
+# generated automatically by aclocal 1.7.9 -*- Autoconf -*-
 
 # Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002
 # Free Software Foundation, Inc.
@@ -16,7 +16,7 @@
 # This macro actually does too much some checks are only needed if
 # your package does certain things.  But this isn't really a big deal.
 
-# Copyright 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003
+# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003
 # Free Software Foundation, Inc.
 
 # This program is free software; you can redistribute it and/or modify
@@ -34,15 +34,8 @@
 # Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
 # 02111-1307, USA.
 
-# serial 9
+# serial 10
 
-# There are a few dirty hacks below to avoid letting `AC_PROG_CC' be
-# written in clear, in which case automake, when reading aclocal.m4,
-# will think it sees a *use*, and therefore will trigger all it's
-# C support machinery.  Also note that it means that autoscan, seeing
-# CC etc. in the Makefile, will ask for an AC_PROG_CC use...
-
-
 AC_PREREQ([2.54])
 
 # Autoconf 2.50 wants to disallow AM_ names.  We explicitly allow
@@ -170,7 +163,7 @@
 # Call AM_AUTOMAKE_VERSION so it can be traced.
 # This function is AC_REQUIREd by AC_INIT_AUTOMAKE.
 AC_DEFUN([AM_SET_CURRENT_AUTOMAKE_VERSION],
-	 [AM_AUTOMAKE_VERSION([1.7.3])])
+	 [AM_AUTOMAKE_VERSION([1.7.9])])
 
 # Helper functions for option handling.                    -*- Autoconf -*-
 
@@ -552,18 +545,32 @@
   # using a relative directory.
   cp "$am_depcomp" conftest.dir
   cd conftest.dir
+  # We will build objects and dependencies in a subdirectory because
+  # it helps to detect inapplicable dependency modes.  For instance
+  # both Tru64's cc and ICC support -MD to output dependencies as a
+  # side effect of compilation, but ICC will put the dependencies in
+  # the current directory while Tru64 will put them in the object
+  # directory.
+  mkdir sub
 
   am_cv_$1_dependencies_compiler_type=none
   if test "$am_compiler_list" = ""; then
      am_compiler_list=`sed -n ['s/^#*\([a-zA-Z0-9]*\))$/\1/p'] < ./depcomp`
   fi
   for depmode in $am_compiler_list; do
+    # Setup a source with many dependencies, because some compilers
+    # like to wrap large dependency lists on column 80 (with \), and
+    # we should not choose a depcomp mode which is confused by this.
+    #
     # We need to recreate these files for each test, as the compiler may
     # overwrite some of them when testing with obscure command lines.
     # This happens at least with the AIX C compiler.
-    echo '#include "conftest.h"' > conftest.c
-    echo 'int i;' > conftest.h
-    echo "${am__include} ${am__quote}conftest.Po${am__quote}" > confmf
+    : > sub/conftest.c
+    for i in 1 2 3 4 5 6; do
+      echo '#include "conftst'$i'.h"' >> sub/conftest.c
+      : > sub/conftst$i.h
+    done
+    echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
 
     case $depmode in
     nosideeffect)
@@ -581,11 +588,12 @@
     # mode.  It turns out that the SunPro C++ compiler does not properly
     # handle `-M -o', and we need to detect this.
     if depmode=$depmode \
-       source=conftest.c object=conftest.o \
-       depfile=conftest.Po tmpdepfile=conftest.TPo \
-       $SHELL ./depcomp $depcc -c -o conftest.o conftest.c \
+       source=sub/conftest.c object=sub/conftest.${OBJEXT-o} \
+       depfile=sub/conftest.Po tmpdepfile=sub/conftest.TPo \
+       $SHELL ./depcomp $depcc -c -o sub/conftest.${OBJEXT-o} sub/conftest.c \
          >/dev/null 2>conftest.err &&
-       grep conftest.h conftest.Po > /dev/null 2>&1 &&
+       grep sub/conftst6.h sub/conftest.Po > /dev/null 2>&1 &&
+       grep sub/conftest.${OBJEXT-o} sub/conftest.Po > /dev/null 2>&1 &&
        ${MAKE-make} -s -f confmf > /dev/null 2>&1; then
       # icc doesn't choke on unknown options, it will just issue warnings
       # (even with -Werror).  So we grep stderr for any message
@@ -720,7 +728,7 @@
 
 # Check to see how 'make' treats includes.	-*- Autoconf -*-
 
-# Copyright (C) 2001, 2002 Free Software Foundation, Inc.
+# Copyright (C) 2001, 2002, 2003 Free Software Foundation, Inc.
 
 # This program is free software; you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
@@ -745,8 +753,9 @@
 AC_DEFUN([AM_MAKE_INCLUDE],
 [am_make=${MAKE-make}
 cat > confinc << 'END'
-doit:
+am__doit:
 	@echo done
+.PHONY: am__doit
 END
 # If we don't find an include directive, just comment out the code.
 AC_MSG_CHECKING([for style of include used by $am_make])
@@ -774,9 +783,9 @@
       _am_result=BSD
    fi
 fi
-AC_SUBST(am__include)
-AC_SUBST(am__quote)
-AC_MSG_RESULT($_am_result)
+AC_SUBST([am__include])
+AC_SUBST([am__quote])
+AC_MSG_RESULT([$_am_result])
 rm -f confinc confmf
 ])
 
@@ -824,61 +833,161 @@
 Usually this means the macro was only invoked conditionally.])
 fi])])
 
+# pkg.m4 - Macros to locate and utilise pkg-config.            -*- Autoconf -*-
+# 
+# Copyright ? 2004 Scott James Remnant <scott at netsplit.com>.
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+# General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+#
+# As a special exception to the GNU General Public License, if you
+# distribute this file as part of a program that contains a
+# configuration script generated by Autoconf, you may include it under
+# the same distribution terms that you use for the rest of that program.
 
-dnl PKG_CHECK_MODULES(GSTUFF, gtk+-2.0 >= 1.3 glib = 1.3.4, action-if, action-not)
-dnl defines GSTUFF_LIBS, GSTUFF_CFLAGS, see pkg-config man page
-dnl also defines GSTUFF_PKG_ERRORS on error
-AC_DEFUN(PKG_CHECK_MODULES, [
-  succeeded=no
+# PKG_PROG_PKG_CONFIG([MIN-VERSION])
+# ----------------------------------
+AC_DEFUN([PKG_PROG_PKG_CONFIG],
+[m4_pattern_forbid([^_?PKG_[A-Z_]+$])
+m4_pattern_allow([^PKG_CONFIG(_PATH)?$])
+AC_ARG_VAR([PKG_CONFIG], [path to pkg-config utility])dnl
+if test "x$ac_cv_env_PKG_CONFIG_set" != "xset"; then
+	AC_PATH_TOOL([PKG_CONFIG], [pkg-config])
+fi
+if test -n "$PKG_CONFIG"; then
+	_pkg_min_version=m4_default([$1], [0.9.0])
+	AC_MSG_CHECKING([pkg-config is at least version $_pkg_min_version])
+	if $PKG_CONFIG --atleast-pkgconfig-version $_pkg_min_version; then
+		AC_MSG_RESULT([yes])
+	else
+		AC_MSG_RESULT([no])
+		PKG_CONFIG=""
+	fi
+		
+fi[]dnl
+])# PKG_PROG_PKG_CONFIG
 
-  if test -z "$PKG_CONFIG"; then
-    AC_PATH_PROG(PKG_CONFIG, pkg-config, no)
-  fi
+# PKG_CHECK_EXISTS(MODULES, [ACTION-IF-FOUND], [ACTION-IF-NOT-FOUND])
+#
+# Check to see whether a particular set of modules exists.  Similar
+# to PKG_CHECK_MODULES(), but does not set variables or print errors.
+#
+#
+# Similar to PKG_CHECK_MODULES, make sure that the first instance of
+# this or PKG_CHECK_MODULES is called, or make sure to call
+# PKG_CHECK_EXISTS manually
+# --------------------------------------------------------------
+AC_DEFUN([PKG_CHECK_EXISTS],
+[AC_REQUIRE([PKG_PROG_PKG_CONFIG])dnl
+if test -n "$PKG_CONFIG" && \
+    AC_RUN_LOG([$PKG_CONFIG --exists --print-errors "$1"]); then
+  m4_ifval([$2], [$2], [:])
+m4_ifvaln([$3], [else
+  $3])dnl
+fi])
 
-  if test "$PKG_CONFIG" = "no" ; then
-     echo "*** The pkg-config script could not be found. Make sure it is"
-     echo "*** in your path, or set the PKG_CONFIG environment variable"
-     echo "*** to the full path to pkg-config."
-     echo "*** Or see http://www.freedesktop.org/software/pkgconfig to get pkg-config."
-  else
-     PKG_CONFIG_MIN_VERSION=0.9.0
-     if $PKG_CONFIG --atleast-pkgconfig-version $PKG_CONFIG_MIN_VERSION; then
-        AC_MSG_CHECKING(for $2)
 
-        if $PKG_CONFIG --exists "$2" ; then
-            AC_MSG_RESULT(yes)
-            succeeded=yes
+# _PKG_CONFIG([VARIABLE], [COMMAND], [MODULES])
+# ---------------------------------------------
+m4_define([_PKG_CONFIG],
+[if test -n "$PKG_CONFIG"; then
+    if test -n "$$1"; then
+        pkg_cv_[]$1="$$1"
+    else
+        PKG_CHECK_EXISTS([$3],
+                         [pkg_cv_[]$1=`$PKG_CONFIG --[]$2 "$3" 2>/dev/null`],
+			 [pkg_failed=yes])
+    fi
+else
+	pkg_failed=untried
+fi[]dnl
+])# _PKG_CONFIG
 
-            AC_MSG_CHECKING($1_CFLAGS)
-            $1_CFLAGS=`$PKG_CONFIG --cflags "$2"`
-            AC_MSG_RESULT($$1_CFLAGS)
+# _PKG_SHORT_ERRORS_SUPPORTED
+# -----------------------------
+AC_DEFUN([_PKG_SHORT_ERRORS_SUPPORTED],
+[AC_REQUIRE([PKG_PROG_PKG_CONFIG])
+if $PKG_CONFIG --atleast-pkgconfig-version 0.20; then
+        _pkg_short_errors_supported=yes
+else
+        _pkg_short_errors_supported=no
+fi[]dnl
+])# _PKG_SHORT_ERRORS_SUPPORTED
 
-            AC_MSG_CHECKING($1_LIBS)
-            $1_LIBS=`$PKG_CONFIG --libs "$2"`
-            AC_MSG_RESULT($$1_LIBS)
-        else
-            $1_CFLAGS=""
-            $1_LIBS=""
-            ## If we have a custom action on failure, don't print errors, but 
-            ## do set a variable so people can do so.
-            $1_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$2"`
-            ifelse([$4], ,echo $$1_PKG_ERRORS,)
+
+# PKG_CHECK_MODULES(VARIABLE-PREFIX, MODULES, [ACTION-IF-FOUND],
+# [ACTION-IF-NOT-FOUND])
+#
+#
+# Note that if there is a possibility the first call to
+# PKG_CHECK_MODULES might not happen, you should be sure to include an
+# explicit call to PKG_PROG_PKG_CONFIG in your configure.ac
+#
+#
+# --------------------------------------------------------------
+AC_DEFUN([PKG_CHECK_MODULES],
+[AC_REQUIRE([PKG_PROG_PKG_CONFIG])dnl
+AC_ARG_VAR([$1][_CFLAGS], [C compiler flags for $1, overriding pkg-config])dnl
+AC_ARG_VAR([$1][_LIBS], [linker flags for $1, overriding pkg-config])dnl
+
+pkg_failed=no
+AC_MSG_CHECKING([for $1])
+
+_PKG_CONFIG([$1][_CFLAGS], [cflags], [$2])
+_PKG_CONFIG([$1][_LIBS], [libs], [$2])
+
+m4_define([_PKG_TEXT], [Alternatively, you may set the environment variables $1[]_CFLAGS
+and $1[]_LIBS to avoid the need to call pkg-config.
+See the pkg-config man page for more details.])
+
+if test $pkg_failed = yes; then
+        _PKG_SHORT_ERRORS_SUPPORTED
+        if test $_pkg_short_errors_supported = yes; then
+	        $1[]_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "$2"`
+        else 
+	        $1[]_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "$2"`
         fi
+	# Put the nasty error message in config.log where it belongs
+	echo "$$1[]_PKG_ERRORS" >&AS_MESSAGE_LOG_FD
 
-        AC_SUBST($1_CFLAGS)
-        AC_SUBST($1_LIBS)
-     else
-        echo "*** Your version of pkg-config is too old. You need version $PKG_CONFIG_MIN_VERSION or newer."
-        echo "*** See http://www.freedesktop.org/software/pkgconfig"
-     fi
-  fi
+	ifelse([$4], , [AC_MSG_ERROR(dnl
+[Package requirements ($2) were not met:
 
-  if test $succeeded = yes; then
-     ifelse([$3], , :, [$3])
-  else
-     ifelse([$4], , AC_MSG_ERROR([Library requirements ($2) not met; consider adjusting the PKG_CONFIG_PATH environment variable if your libraries are in a nonstandard prefix so pkg-config can find them.]), [$4])
-  fi
-])
+$$1_PKG_ERRORS
 
+Consider adjusting the PKG_CONFIG_PATH environment variable if you
+installed software in a non-standard prefix.
 
+_PKG_TEXT
+])],
+		[AC_MSG_RESULT([no])
+                $4])
+elif test $pkg_failed = untried; then
+	ifelse([$4], , [AC_MSG_FAILURE(dnl
+[The pkg-config script could not be found or is too old.  Make sure it
+is in your PATH or set the PKG_CONFIG environment variable to the full
+path to pkg-config.
 
+_PKG_TEXT
+
+To get pkg-config, see <http://pkg-config.freedesktop.org/>.])],
+		[$4])
+else
+	$1[]_CFLAGS=$pkg_cv_[]$1[]_CFLAGS
+	$1[]_LIBS=$pkg_cv_[]$1[]_LIBS
+        AC_MSG_RESULT([yes])
+	ifelse([$3], , :, [$3])
+fi[]dnl
+])# PKG_CHECK_MODULES
+

Modified: branches/windstille-0.1.x/configure
===================================================================
--- tags/windstille-0.1.0/configure	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/configure	2009-09-27 12:06:38 UTC (rev 3268)
@@ -1,61 +1,145 @@
 #! /bin/sh
 # Guess values for system-dependent variables and create Makefiles.
-# Generated by GNU Autoconf 2.57 for Windstille 0.1.0.
+# Generated by GNU Autoconf 2.63 for Windstille 0.1.0.
 #
-# Copyright 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001, 2002
-# Free Software Foundation, Inc.
+# Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
+# 2002, 2003, 2004, 2005, 2006, 2007, 2008 Free Software Foundation, Inc.
 # This configure script is free software; the Free Software Foundation
 # gives unlimited permission to copy, distribute and modify it.
 ## --------------------- ##
 ## M4sh Initialization.  ##
 ## --------------------- ##
 
-# Be Bourne compatible
+# Be more Bourne compatible
+DUALCASE=1; export DUALCASE # for MKS sh
 if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then
   emulate sh
   NULLCMD=:
-  # Zsh 3.x and 4.x performs word splitting on ${1+"$@"}, which
+  # Pre-4.2 versions of Zsh do word splitting on ${1+"$@"}, which
   # is contrary to our usage.  Disable this feature.
   alias -g '${1+"$@"}'='"$@"'
-elif test -n "${BASH_VERSION+set}" && (set -o posix) >/dev/null 2>&1; then
-  set -o posix
+  setopt NO_GLOB_SUBST
+else
+  case `(set -o) 2>/dev/null` in
+  *posix*) set -o posix ;;
+esac
+
 fi
 
+
+
+
+# PATH needs CR
+# Avoid depending upon Character Ranges.
+as_cr_letters='abcdefghijklmnopqrstuvwxyz'
+as_cr_LETTERS='ABCDEFGHIJKLMNOPQRSTUVWXYZ'
+as_cr_Letters=$as_cr_letters$as_cr_LETTERS
+as_cr_digits='0123456789'
+as_cr_alnum=$as_cr_Letters$as_cr_digits
+
+as_nl='
+'
+export as_nl
+# Printing a long string crashes Solaris 7 /usr/bin/printf.
+as_echo='\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\'
+as_echo=$as_echo$as_echo$as_echo$as_echo$as_echo
+as_echo=$as_echo$as_echo$as_echo$as_echo$as_echo$as_echo
+if (test "X`printf %s $as_echo`" = "X$as_echo") 2>/dev/null; then
+  as_echo='printf %s\n'
+  as_echo_n='printf %s'
+else
+  if test "X`(/usr/ucb/echo -n -n $as_echo) 2>/dev/null`" = "X-n $as_echo"; then
+    as_echo_body='eval /usr/ucb/echo -n "$1$as_nl"'
+    as_echo_n='/usr/ucb/echo -n'
+  else
+    as_echo_body='eval expr "X$1" : "X\\(.*\\)"'
+    as_echo_n_body='eval
+      arg=$1;
+      case $arg in
+      *"$as_nl"*)
+	expr "X$arg" : "X\\(.*\\)$as_nl";
+	arg=`expr "X$arg" : ".*$as_nl\\(.*\\)"`;;
+      esac;
+      expr "X$arg" : "X\\(.*\\)" | tr -d "$as_nl"
+    '
+    export as_echo_n_body
+    as_echo_n='sh -c $as_echo_n_body as_echo'
+  fi
+  export as_echo_body
+  as_echo='sh -c $as_echo_body as_echo'
+fi
+
+# The user is always right.
+if test "${PATH_SEPARATOR+set}" != set; then
+  PATH_SEPARATOR=:
+  (PATH='/bin;/bin'; FPATH=$PATH; sh -c :) >/dev/null 2>&1 && {
+    (PATH='/bin:/bin'; FPATH=$PATH; sh -c :) >/dev/null 2>&1 ||
+      PATH_SEPARATOR=';'
+  }
+fi
+
 # Support unset when possible.
-if (FOO=FOO; unset FOO) >/dev/null 2>&1; then
+if ( (MAIL=60; unset MAIL) || exit) >/dev/null 2>&1; then
   as_unset=unset
 else
   as_unset=false
 fi
 
 
+# IFS
+# We need space, tab and new line, in precisely that order.  Quoting is
+# there to prevent editors from complaining about space-tab.
+# (If _AS_PATH_WALK were called with IFS unset, it would disable word
+# splitting by setting IFS to empty value.)
+IFS=" ""	$as_nl"
+
+# Find who we are.  Look in the path if we contain no directory separator.
+case $0 in
+  *[\\/]* ) as_myself=$0 ;;
+  *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+  test -r "$as_dir/$0" && as_myself=$as_dir/$0 && break
+done
+IFS=$as_save_IFS
+
+     ;;
+esac
+# We did not find ourselves, most probably we were run as `sh COMMAND'
+# in which case we are not to be found in the path.
+if test "x$as_myself" = x; then
+  as_myself=$0
+fi
+if test ! -f "$as_myself"; then
+  $as_echo "$as_myself: error: cannot find myself; rerun with an absolute file name" >&2
+  { (exit 1); exit 1; }
+fi
+
 # Work around bugs in pre-3.0 UWIN ksh.
-$as_unset ENV MAIL MAILPATH
+for as_var in ENV MAIL MAILPATH
+do ($as_unset $as_var) >/dev/null 2>&1 && $as_unset $as_var
+done
 PS1='$ '
 PS2='> '
 PS4='+ '
 
 # NLS nuisances.
-for as_var in \
-  LANG LANGUAGE LC_ADDRESS LC_ALL LC_COLLATE LC_CTYPE LC_IDENTIFICATION \
-  LC_MEASUREMENT LC_MESSAGES LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER \
-  LC_TELEPHONE LC_TIME
-do
-  if (set +x; test -n "`(eval $as_var=C; export $as_var) 2>&1`"); then
-    eval $as_var=C; export $as_var
-  else
-    $as_unset $as_var
-  fi
-done
+LC_ALL=C
+export LC_ALL
+LANGUAGE=C
+export LANGUAGE
 
 # Required to use basename.
-if expr a : '\(a\)' >/dev/null 2>&1; then
+if expr a : '\(a\)' >/dev/null 2>&1 &&
+   test "X`expr 00001 : '.*\(...\)'`" = X001; then
   as_expr=expr
 else
   as_expr=false
 fi
 
-if (basename /) >/dev/null 2>&1 && test "X`basename / 2>&1`" = "X/"; then
+if (basename -- /) >/dev/null 2>&1 && test "X`basename -- / 2>&1`" = "X/"; then
   as_basename=basename
 else
   as_basename=false
@@ -63,206 +147,450 @@
 
 
 # Name of the executable.
-as_me=`$as_basename "$0" ||
+as_me=`$as_basename -- "$0" ||
 $as_expr X/"$0" : '.*/\([^/][^/]*\)/*$' \| \
 	 X"$0" : 'X\(//\)$' \| \
-	 X"$0" : 'X\(/\)$' \| \
-	 .     : '\(.\)' 2>/dev/null ||
-echo X/"$0" |
-    sed '/^.*\/\([^/][^/]*\)\/*$/{ s//\1/; q; }
-  	  /^X\/\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\/\(\/\).*/{ s//\1/; q; }
-  	  s/.*/./; q'`
+	 X"$0" : 'X\(/\)' \| . 2>/dev/null ||
+$as_echo X/"$0" |
+    sed '/^.*\/\([^/][^/]*\)\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\/\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\/\(\/\).*/{
+	    s//\1/
+	    q
+	  }
+	  s/.*/./; q'`
 
+# CDPATH.
+$as_unset CDPATH
 
-# PATH needs CR, and LINENO needs CR and PATH.
-# Avoid depending upon Character Ranges.
-as_cr_letters='abcdefghijklmnopqrstuvwxyz'
-as_cr_LETTERS='ABCDEFGHIJKLMNOPQRSTUVWXYZ'
-as_cr_Letters=$as_cr_letters$as_cr_LETTERS
-as_cr_digits='0123456789'
-as_cr_alnum=$as_cr_Letters$as_cr_digits
 
-# The user is always right.
-if test "${PATH_SEPARATOR+set}" != set; then
-  echo "#! /bin/sh" >conf$$.sh
-  echo  "exit 0"   >>conf$$.sh
-  chmod +x conf$$.sh
-  if (PATH="/nonexistent;."; conf$$.sh) >/dev/null 2>&1; then
-    PATH_SEPARATOR=';'
-  else
-    PATH_SEPARATOR=:
-  fi
-  rm -f conf$$.sh
+if test "x$CONFIG_SHELL" = x; then
+  if (eval ":") 2>/dev/null; then
+  as_have_required=yes
+else
+  as_have_required=no
 fi
 
+  if test $as_have_required = yes &&	 (eval ":
+(as_func_return () {
+  (exit \$1)
+}
+as_func_success () {
+  as_func_return 0
+}
+as_func_failure () {
+  as_func_return 1
+}
+as_func_ret_success () {
+  return 0
+}
+as_func_ret_failure () {
+  return 1
+}
 
-  as_lineno_1=$LINENO
-  as_lineno_2=$LINENO
-  as_lineno_3=`(expr $as_lineno_1 + 1) 2>/dev/null`
-  test "x$as_lineno_1" != "x$as_lineno_2" &&
-  test "x$as_lineno_3"  = "x$as_lineno_2"  || {
-  # Find who we are.  Look in the path if we contain no path at all
-  # relative or not.
-  case $0 in
-    *[\\/]* ) as_myself=$0 ;;
-    *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-  test -r "$as_dir/$0" && as_myself=$as_dir/$0 && break
-done
+exitcode=0
+if as_func_success; then
+  :
+else
+  exitcode=1
+  echo as_func_success failed.
+fi
 
-       ;;
-  esac
-  # We did not find ourselves, most probably we were run as `sh COMMAND'
-  # in which case we are not to be found in the path.
-  if test "x$as_myself" = x; then
-    as_myself=$0
-  fi
-  if test ! -f "$as_myself"; then
-    { echo "$as_me: error: cannot find myself; rerun with an absolute path" >&2
-   { (exit 1); exit 1; }; }
-  fi
-  case $CONFIG_SHELL in
-  '')
+if as_func_failure; then
+  exitcode=1
+  echo as_func_failure succeeded.
+fi
+
+if as_func_ret_success; then
+  :
+else
+  exitcode=1
+  echo as_func_ret_success failed.
+fi
+
+if as_func_ret_failure; then
+  exitcode=1
+  echo as_func_ret_failure succeeded.
+fi
+
+if ( set x; as_func_ret_success y && test x = \"\$1\" ); then
+  :
+else
+  exitcode=1
+  echo positional parameters were not saved.
+fi
+
+test \$exitcode = 0) || { (exit 1); exit 1; }
+
+(
+  as_lineno_1=\$LINENO
+  as_lineno_2=\$LINENO
+  test \"x\$as_lineno_1\" != \"x\$as_lineno_2\" &&
+  test \"x\`expr \$as_lineno_1 + 1\`\" = \"x\$as_lineno_2\") || { (exit 1); exit 1; }
+") 2> /dev/null; then
+  :
+else
+  as_candidate_shells=
     as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in /bin$PATH_SEPARATOR/usr/bin$PATH_SEPARATOR$PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
-  for as_base in sh bash ksh sh5; do
-	 case $as_dir in
+  case $as_dir in
 	 /*)
-	   if ("$as_dir/$as_base" -c '
+	   for as_base in sh bash ksh sh5; do
+	     as_candidate_shells="$as_candidate_shells $as_dir/$as_base"
+	   done;;
+       esac
+done
+IFS=$as_save_IFS
+
+
+      for as_shell in $as_candidate_shells $SHELL; do
+	 # Try only shells that exist, to save several forks.
+	 if { test -f "$as_shell" || test -f "$as_shell.exe"; } &&
+		{ ("$as_shell") 2> /dev/null <<\_ASEOF
+if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then
+  emulate sh
+  NULLCMD=:
+  # Pre-4.2 versions of Zsh do word splitting on ${1+"$@"}, which
+  # is contrary to our usage.  Disable this feature.
+  alias -g '${1+"$@"}'='"$@"'
+  setopt NO_GLOB_SUBST
+else
+  case `(set -o) 2>/dev/null` in
+  *posix*) set -o posix ;;
+esac
+
+fi
+
+
+:
+_ASEOF
+}; then
+  CONFIG_SHELL=$as_shell
+	       as_have_required=yes
+	       if { "$as_shell" 2> /dev/null <<\_ASEOF
+if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then
+  emulate sh
+  NULLCMD=:
+  # Pre-4.2 versions of Zsh do word splitting on ${1+"$@"}, which
+  # is contrary to our usage.  Disable this feature.
+  alias -g '${1+"$@"}'='"$@"'
+  setopt NO_GLOB_SUBST
+else
+  case `(set -o) 2>/dev/null` in
+  *posix*) set -o posix ;;
+esac
+
+fi
+
+
+:
+(as_func_return () {
+  (exit $1)
+}
+as_func_success () {
+  as_func_return 0
+}
+as_func_failure () {
+  as_func_return 1
+}
+as_func_ret_success () {
+  return 0
+}
+as_func_ret_failure () {
+  return 1
+}
+
+exitcode=0
+if as_func_success; then
+  :
+else
+  exitcode=1
+  echo as_func_success failed.
+fi
+
+if as_func_failure; then
+  exitcode=1
+  echo as_func_failure succeeded.
+fi
+
+if as_func_ret_success; then
+  :
+else
+  exitcode=1
+  echo as_func_ret_success failed.
+fi
+
+if as_func_ret_failure; then
+  exitcode=1
+  echo as_func_ret_failure succeeded.
+fi
+
+if ( set x; as_func_ret_success y && test x = "$1" ); then
+  :
+else
+  exitcode=1
+  echo positional parameters were not saved.
+fi
+
+test $exitcode = 0) || { (exit 1); exit 1; }
+
+(
   as_lineno_1=$LINENO
   as_lineno_2=$LINENO
-  as_lineno_3=`(expr $as_lineno_1 + 1) 2>/dev/null`
   test "x$as_lineno_1" != "x$as_lineno_2" &&
-  test "x$as_lineno_3"  = "x$as_lineno_2" ') 2>/dev/null; then
-	     $as_unset BASH_ENV || test "${BASH_ENV+set}" != set || { BASH_ENV=; export BASH_ENV; }
-	     $as_unset ENV || test "${ENV+set}" != set || { ENV=; export ENV; }
-	     CONFIG_SHELL=$as_dir/$as_base
-	     export CONFIG_SHELL
-	     exec "$CONFIG_SHELL" "$0" ${1+"$@"}
-	   fi;;
-	 esac
-       done
-done
-;;
-  esac
+  test "x`expr $as_lineno_1 + 1`" = "x$as_lineno_2") || { (exit 1); exit 1; }
 
+_ASEOF
+}; then
+  break
+fi
+
+fi
+
+      done
+
+      if test "x$CONFIG_SHELL" != x; then
+  for as_var in BASH_ENV ENV
+	do ($as_unset $as_var) >/dev/null 2>&1 && $as_unset $as_var
+	done
+	export CONFIG_SHELL
+	exec "$CONFIG_SHELL" "$as_myself" ${1+"$@"}
+fi
+
+
+    if test $as_have_required = no; then
+  echo This script requires a shell more modern than all the
+      echo shells that I found on your system.  Please install a
+      echo modern shell, or manually run the script under such a
+      echo shell if you do have one.
+      { (exit 1); exit 1; }
+fi
+
+
+fi
+
+fi
+
+
+
+(eval "as_func_return () {
+  (exit \$1)
+}
+as_func_success () {
+  as_func_return 0
+}
+as_func_failure () {
+  as_func_return 1
+}
+as_func_ret_success () {
+  return 0
+}
+as_func_ret_failure () {
+  return 1
+}
+
+exitcode=0
+if as_func_success; then
+  :
+else
+  exitcode=1
+  echo as_func_success failed.
+fi
+
+if as_func_failure; then
+  exitcode=1
+  echo as_func_failure succeeded.
+fi
+
+if as_func_ret_success; then
+  :
+else
+  exitcode=1
+  echo as_func_ret_success failed.
+fi
+
+if as_func_ret_failure; then
+  exitcode=1
+  echo as_func_ret_failure succeeded.
+fi
+
+if ( set x; as_func_ret_success y && test x = \"\$1\" ); then
+  :
+else
+  exitcode=1
+  echo positional parameters were not saved.
+fi
+
+test \$exitcode = 0") || {
+  echo No shell found that supports shell functions.
+  echo Please tell bug-autoconf at gnu.org about your system,
+  echo including any error possibly output before this message.
+  echo This can help us improve future autoconf versions.
+  echo Configuration will now proceed without shell functions.
+}
+
+
+
+  as_lineno_1=$LINENO
+  as_lineno_2=$LINENO
+  test "x$as_lineno_1" != "x$as_lineno_2" &&
+  test "x`expr $as_lineno_1 + 1`" = "x$as_lineno_2" || {
+
   # Create $as_me.lineno as a copy of $as_myself, but with $LINENO
   # uniformly replaced by the line number.  The first 'sed' inserts a
-  # line-number line before each line; the second 'sed' does the real
-  # work.  The second script uses 'N' to pair each line-number line
-  # with the numbered line, and appends trailing '-' during
-  # substitution so that $LINENO is not a special case at line end.
+  # line-number line after each line using $LINENO; the second 'sed'
+  # does the real work.  The second script uses 'N' to pair each
+  # line-number line with the line containing $LINENO, and appends
+  # trailing '-' during substitution so that $LINENO is not a special
+  # case at line end.
   # (Raja R Harinath suggested sed '=', and Paul Eggert wrote the
-  # second 'sed' script.  Blame Lee E. McMahon for sed's syntax.  :-)
-  sed '=' <$as_myself |
+  # scripts with optimization help from Paolo Bonzini.  Blame Lee
+  # E. McMahon (1931-1989) for sed's syntax.  :-)
+  sed -n '
+    p
+    /[$]LINENO/=
+  ' <$as_myself |
     sed '
+      s/[$]LINENO.*/&-/
+      t lineno
+      b
+      :lineno
       N
-      s,$,-,
-      : loop
-      s,^\(['$as_cr_digits']*\)\(.*\)[$]LINENO\([^'$as_cr_alnum'_]\),\1\2\1\3,
+      :loop
+      s/[$]LINENO\([^'$as_cr_alnum'_].*\n\)\(.*\)/\2\1\2/
       t loop
-      s,-$,,
-      s,^['$as_cr_digits']*\n,,
+      s/-\n.*//
     ' >$as_me.lineno &&
-  chmod +x $as_me.lineno ||
-    { echo "$as_me: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&2
+  chmod +x "$as_me.lineno" ||
+    { $as_echo "$as_me: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&2
    { (exit 1); exit 1; }; }
 
   # Don't try to exec as it changes $[0], causing all sort of problems
   # (the dirname of $[0] is not the place where we might find the
-  # original and so on.  Autoconf is especially sensible to this).
-  . ./$as_me.lineno
+  # original and so on.  Autoconf is especially sensitive to this).
+  . "./$as_me.lineno"
   # Exit status is that of the last command.
   exit
 }
 
 
-case `echo "testing\c"; echo 1,2,3`,`echo -n testing; echo 1,2,3` in
-  *c*,-n*) ECHO_N= ECHO_C='
-' ECHO_T='	' ;;
-  *c*,*  ) ECHO_N=-n ECHO_C= ECHO_T= ;;
-  *)       ECHO_N= ECHO_C='\c' ECHO_T= ;;
+if (as_dir=`dirname -- /` && test "X$as_dir" = X/) >/dev/null 2>&1; then
+  as_dirname=dirname
+else
+  as_dirname=false
+fi
+
+ECHO_C= ECHO_N= ECHO_T=
+case `echo -n x` in
+-n*)
+  case `echo 'x\c'` in
+  *c*) ECHO_T='	';;	# ECHO_T is single tab character.
+  *)   ECHO_C='\c';;
+  esac;;
+*)
+  ECHO_N='-n';;
 esac
-
-if expr a : '\(a\)' >/dev/null 2>&1; then
+if expr a : '\(a\)' >/dev/null 2>&1 &&
+   test "X`expr 00001 : '.*\(...\)'`" = X001; then
   as_expr=expr
 else
   as_expr=false
 fi
 
 rm -f conf$$ conf$$.exe conf$$.file
-echo >conf$$.file
-if ln -s conf$$.file conf$$ 2>/dev/null; then
-  # We could just check for DJGPP; but this test a) works b) is more generic
-  # and c) will remain valid once DJGPP supports symlinks (DJGPP 2.04).
-  if test -f conf$$.exe; then
-    # Don't use ln at all; we don't have any links
+if test -d conf$$.dir; then
+  rm -f conf$$.dir/conf$$.file
+else
+  rm -f conf$$.dir
+  mkdir conf$$.dir 2>/dev/null
+fi
+if (echo >conf$$.file) 2>/dev/null; then
+  if ln -s conf$$.file conf$$ 2>/dev/null; then
+    as_ln_s='ln -s'
+    # ... but there are two gotchas:
+    # 1) On MSYS, both `ln -s file dir' and `ln file dir' fail.
+    # 2) DJGPP < 2.04 has no symlinks; `ln -s' creates a wrapper executable.
+    # In both cases, we have to default to `cp -p'.
+    ln -s conf$$.file conf$$.dir 2>/dev/null && test ! -f conf$$.exe ||
+      as_ln_s='cp -p'
+  elif ln conf$$.file conf$$ 2>/dev/null; then
+    as_ln_s=ln
+  else
     as_ln_s='cp -p'
-  else
-    as_ln_s='ln -s'
   fi
-elif ln conf$$.file conf$$ 2>/dev/null; then
-  as_ln_s=ln
 else
   as_ln_s='cp -p'
 fi
-rm -f conf$$ conf$$.exe conf$$.file
+rm -f conf$$ conf$$.exe conf$$.dir/conf$$.file conf$$.file
+rmdir conf$$.dir 2>/dev/null
 
 if mkdir -p . 2>/dev/null; then
   as_mkdir_p=:
 else
+  test -d ./-p && rmdir ./-p
   as_mkdir_p=false
 fi
 
-as_executable_p="test -f"
+if test -x / >/dev/null 2>&1; then
+  as_test_x='test -x'
+else
+  if ls -dL / >/dev/null 2>&1; then
+    as_ls_L_option=L
+  else
+    as_ls_L_option=
+  fi
+  as_test_x='
+    eval sh -c '\''
+      if test -d "$1"; then
+	test -d "$1/.";
+      else
+	case $1 in
+	-*)set "./$1";;
+	esac;
+	case `ls -ld'$as_ls_L_option' "$1" 2>/dev/null` in
+	???[sx]*):;;*)false;;esac;fi
+    '\'' sh
+  '
+fi
+as_executable_p=$as_test_x
 
 # Sed expression to map a string onto a valid CPP name.
-as_tr_cpp="sed y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g"
+as_tr_cpp="eval sed 'y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g'"
 
 # Sed expression to map a string onto a valid variable name.
-as_tr_sh="sed y%*+%pp%;s%[^_$as_cr_alnum]%_%g"
+as_tr_sh="eval sed 'y%*+%pp%;s%[^_$as_cr_alnum]%_%g'"
 
 
-# IFS
-# We need space, tab and new line, in precisely that order.
-as_nl='
-'
-IFS=" 	$as_nl"
 
-# CDPATH.
-$as_unset CDPATH
+exec 7<&0 </dev/null 6>&1
 
-
 # Name of the host.
 # hostname on some systems (SVR3.2, Linux) returns a bogus exit status,
 # so uname gets run too.
 ac_hostname=`(hostname || uname -n) 2>/dev/null | sed 1q`
 
-exec 6>&1
-
 #
 # Initializations.
 #
 ac_default_prefix=/usr/local
+ac_clean_files=
 ac_config_libobj_dir=.
+LIBOBJS=
 cross_compiling=no
 subdirs=
 MFLAGS=
 MAKEFLAGS=
 SHELL=${CONFIG_SHELL-/bin/sh}
 
-# Maximum number of lines to put in a shell here document.
-# This variable seems obsolete.  It should probably be removed, and
-# only ac_max_sed_lines should be used.
-: ${ac_max_here_lines=38}
-
 # Identity of this package.
 PACKAGE_NAME='Windstille'
 PACKAGE_TARNAME='windstille'
@@ -274,46 +602,152 @@
 # Factoring default headers for most tests.
 ac_includes_default="\
 #include <stdio.h>
-#if HAVE_SYS_TYPES_H
+#ifdef HAVE_SYS_TYPES_H
 # include <sys/types.h>
 #endif
-#if HAVE_SYS_STAT_H
+#ifdef HAVE_SYS_STAT_H
 # include <sys/stat.h>
 #endif
-#if STDC_HEADERS
+#ifdef STDC_HEADERS
 # include <stdlib.h>
 # include <stddef.h>
 #else
-# if HAVE_STDLIB_H
+# ifdef HAVE_STDLIB_H
 #  include <stdlib.h>
 # endif
 #endif
-#if HAVE_STRING_H
-# if !STDC_HEADERS && HAVE_MEMORY_H
+#ifdef HAVE_STRING_H
+# if !defined STDC_HEADERS && defined HAVE_MEMORY_H
 #  include <memory.h>
 # endif
 # include <string.h>
 #endif
-#if HAVE_STRINGS_H
+#ifdef HAVE_STRINGS_H
 # include <strings.h>
 #endif
-#if HAVE_INTTYPES_H
+#ifdef HAVE_INTTYPES_H
 # include <inttypes.h>
-#else
-# if HAVE_STDINT_H
-#  include <stdint.h>
-# endif
 #endif
-#if HAVE_UNISTD_H
+#ifdef HAVE_STDINT_H
+# include <stdint.h>
+#endif
+#ifdef HAVE_UNISTD_H
 # include <unistd.h>
 #endif"
 
-ac_subst_vars='SHELL PATH_SEPARATOR PACKAGE_NAME PACKAGE_TARNAME PACKAGE_VERSION PACKAGE_STRING PACKAGE_BUGREPORT exec_prefix prefix program_transform_name bindir sbindir libexecdir datadir sysconfdir sharedstatedir localstatedir libdir includedir oldincludedir infodir mandir build_alias host_alias target_alias DEFS ECHO_C ECHO_N ECHO_T LIBS INSTALL_PROGRAM INSTALL_SCRIPT INSTALL_DATA CYGPATH_W PACKAGE VERSION ACLOCAL AUTOCONF AUTOMAKE AUTOHEADER MAKEINFO AMTAR install_sh STRIP ac_ct_STRIP INSTALL_STRIP_PROGRAM AWK SET_MAKE am__leading_dot CC CFLAGS LDFLAGS CPPFLAGS ac_ct_CC EXEEXT OBJEXT DEPDIR am__include am__quote AMDEP_TRUE AMDEP_FALSE AMDEPBACKSLASH CCDEPMODE am__fastdepCC_TRUE am__fastdepCC_FALSE CXX CXXFLAGS ac_ct_CXX CXXDEPMODE am__fastdepCXX_TRUE am__fastdepCXX_FALSE RANLIB ac_ct_RANLIB CXXCPP EGREP PKG_CONFIG WINDSTILLE_DEPS_CFLAGS WINDSTILLE_DEPS_LIBS LIBOBJS LTLIBOBJS'
+ac_subst_vars='LTLIBOBJS
+LIBOBJS
+WINDSTILLE_DEPS_LIBS
+WINDSTILLE_DEPS_CFLAGS
+PKG_CONFIG
+EGREP
+GREP
+CXXCPP
+RANLIB
+am__fastdepCXX_FALSE
+am__fastdepCXX_TRUE
+CXXDEPMODE
+ac_ct_CXX
+CXXFLAGS
+CXX
+am__fastdepCC_FALSE
+am__fastdepCC_TRUE
+CCDEPMODE
+AMDEPBACKSLASH
+AMDEP_FALSE
+AMDEP_TRUE
+am__quote
+am__include
+DEPDIR
+OBJEXT
+EXEEXT
+ac_ct_CC
+CPPFLAGS
+LDFLAGS
+CFLAGS
+CC
+am__leading_dot
+SET_MAKE
+AWK
+INSTALL_STRIP_PROGRAM
+STRIP
+install_sh
+AMTAR
+MAKEINFO
+AUTOHEADER
+AUTOMAKE
+AUTOCONF
+ACLOCAL
+VERSION
+PACKAGE
+CYGPATH_W
+INSTALL_DATA
+INSTALL_SCRIPT
+INSTALL_PROGRAM
+target_alias
+host_alias
+build_alias
+LIBS
+ECHO_T
+ECHO_N
+ECHO_C
+DEFS
+mandir
+localedir
+libdir
+psdir
+pdfdir
+dvidir
+htmldir
+infodir
+docdir
+oldincludedir
+includedir
+localstatedir
+sharedstatedir
+sysconfdir
+datadir
+datarootdir
+libexecdir
+sbindir
+bindir
+program_transform_name
+prefix
+exec_prefix
+PACKAGE_BUGREPORT
+PACKAGE_STRING
+PACKAGE_VERSION
+PACKAGE_TARNAME
+PACKAGE_NAME
+PATH_SEPARATOR
+SHELL'
 ac_subst_files=''
+ac_user_opts='
+enable_option_checking
+enable_dependency_tracking
+'
+      ac_precious_vars='build_alias
+host_alias
+target_alias
+CC
+CFLAGS
+LDFLAGS
+LIBS
+CPPFLAGS
+CXX
+CXXFLAGS
+CCC
+CXXCPP
+PKG_CONFIG
+WINDSTILLE_DEPS_CFLAGS
+WINDSTILLE_DEPS_LIBS'
 
+
 # Initialize some variables set by options.
 ac_init_help=
 ac_init_version=false
+ac_unrecognized_opts=
+ac_unrecognized_sep=
 # The variables have the same names as the options, with
 # dashes changed to underlines.
 cache_file=/dev/null
@@ -336,34 +770,48 @@
 # and all the variables that are supposed to be based on exec_prefix
 # by default will actually change.
 # Use braces instead of parens because sh, perl, etc. also accept them.
+# (The list follows the same order as the GNU Coding Standards.)
 bindir='${exec_prefix}/bin'
 sbindir='${exec_prefix}/sbin'
 libexecdir='${exec_prefix}/libexec'
-datadir='${prefix}/share'
+datarootdir='${prefix}/share'
+datadir='${datarootdir}'
 sysconfdir='${prefix}/etc'
 sharedstatedir='${prefix}/com'
 localstatedir='${prefix}/var'
-libdir='${exec_prefix}/lib'
 includedir='${prefix}/include'
 oldincludedir='/usr/include'
-infodir='${prefix}/info'
-mandir='${prefix}/man'
+docdir='${datarootdir}/doc/${PACKAGE_TARNAME}'
+infodir='${datarootdir}/info'
+htmldir='${docdir}'
+dvidir='${docdir}'
+pdfdir='${docdir}'
+psdir='${docdir}'
+libdir='${exec_prefix}/lib'
+localedir='${datarootdir}/locale'
+mandir='${datarootdir}/man'
 
 ac_prev=
+ac_dashdash=
 for ac_option
 do
   # If the previous option needs an argument, assign it.
   if test -n "$ac_prev"; then
-    eval "$ac_prev=\$ac_option"
+    eval $ac_prev=\$ac_option
     ac_prev=
     continue
   fi
 
-  ac_optarg=`expr "x$ac_option" : 'x[^=]*=\(.*\)'`
+  case $ac_option in
+  *=*)	ac_optarg=`expr "X$ac_option" : '[^=]*=\(.*\)'` ;;
+  *)	ac_optarg=yes ;;
+  esac
 
   # Accept the important Cygnus configure options, so we can diagnose typos.
 
-  case $ac_option in
+  case $ac_dashdash$ac_option in
+  --)
+    ac_dashdash=yes ;;
 
   -bindir | --bindir | --bindi | --bind | --bin | --bi)
     ac_prev=bindir ;;
@@ -385,33 +833,61 @@
   --config-cache | -C)
     cache_file=config.cache ;;
 
-  -datadir | --datadir | --datadi | --datad | --data | --dat | --da)
+  -datadir | --datadir | --datadi | --datad)
     ac_prev=datadir ;;
-  -datadir=* | --datadir=* | --datadi=* | --datad=* | --data=* | --dat=* \
-  | --da=*)
+  -datadir=* | --datadir=* | --datadi=* | --datad=*)
     datadir=$ac_optarg ;;
 
+  -datarootdir | --datarootdir | --datarootdi | --datarootd | --dataroot \
+  | --dataroo | --dataro | --datar)
+    ac_prev=datarootdir ;;
+  -datarootdir=* | --datarootdir=* | --datarootdi=* | --datarootd=* \
+  | --dataroot=* | --dataroo=* | --dataro=* | --datar=*)
+    datarootdir=$ac_optarg ;;
+
   -disable-* | --disable-*)
-    ac_feature=`expr "x$ac_option" : 'x-*disable-\(.*\)'`
+    ac_useropt=`expr "x$ac_option" : 'x-*disable-\(.*\)'`
     # Reject names that are not valid shell variable names.
-    expr "x$ac_feature" : ".*[^-_$as_cr_alnum]" >/dev/null &&
-      { echo "$as_me: error: invalid feature name: $ac_feature" >&2
+    expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
+      { $as_echo "$as_me: error: invalid feature name: $ac_useropt" >&2
    { (exit 1); exit 1; }; }
-    ac_feature=`echo $ac_feature | sed 's/-/_/g'`
-    eval "enable_$ac_feature=no" ;;
+    ac_useropt_orig=$ac_useropt
+    ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
+    case $ac_user_opts in
+      *"
+"enable_$ac_useropt"
+"*) ;;
+      *) ac_unrecognized_opts="$ac_unrecognized_opts$ac_unrecognized_sep--disable-$ac_useropt_orig"
+	 ac_unrecognized_sep=', ';;
+    esac
+    eval enable_$ac_useropt=no ;;
 
+  -docdir | --docdir | --docdi | --doc | --do)
+    ac_prev=docdir ;;
+  -docdir=* | --docdir=* | --docdi=* | --doc=* | --do=*)
+    docdir=$ac_optarg ;;
+
+  -dvidir | --dvidir | --dvidi | --dvid | --dvi | --dv)
+    ac_prev=dvidir ;;
+  -dvidir=* | --dvidir=* | --dvidi=* | --dvid=* | --dvi=* | --dv=*)
+    dvidir=$ac_optarg ;;
+
   -enable-* | --enable-*)
-    ac_feature=`expr "x$ac_option" : 'x-*enable-\([^=]*\)'`
+    ac_useropt=`expr "x$ac_option" : 'x-*enable-\([^=]*\)'`
     # Reject names that are not valid shell variable names.
-    expr "x$ac_feature" : ".*[^-_$as_cr_alnum]" >/dev/null &&
-      { echo "$as_me: error: invalid feature name: $ac_feature" >&2
+    expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
+      { $as_echo "$as_me: error: invalid feature name: $ac_useropt" >&2
    { (exit 1); exit 1; }; }
-    ac_feature=`echo $ac_feature | sed 's/-/_/g'`
-    case $ac_option in
-      *=*) ac_optarg=`echo "$ac_optarg" | sed "s/'/'\\\\\\\\''/g"`;;
-      *) ac_optarg=yes ;;
+    ac_useropt_orig=$ac_useropt
+    ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
+    case $ac_user_opts in
+      *"
+"enable_$ac_useropt"
+"*) ;;
+      *) ac_unrecognized_opts="$ac_unrecognized_opts$ac_unrecognized_sep--enable-$ac_useropt_orig"
+	 ac_unrecognized_sep=', ';;
     esac
-    eval "enable_$ac_feature='$ac_optarg'" ;;
+    eval enable_$ac_useropt=\$ac_optarg ;;
 
   -exec-prefix | --exec_prefix | --exec-prefix | --exec-prefi \
   | --exec-pref | --exec-pre | --exec-pr | --exec-p | --exec- \
@@ -438,6 +914,12 @@
   -host=* | --host=* | --hos=* | --ho=*)
     host_alias=$ac_optarg ;;
 
+  -htmldir | --htmldir | --htmldi | --htmld | --html | --htm | --ht)
+    ac_prev=htmldir ;;
+  -htmldir=* | --htmldir=* | --htmldi=* | --htmld=* | --html=* | --htm=* \
+  | --ht=*)
+    htmldir=$ac_optarg ;;
+
   -includedir | --includedir | --includedi | --included | --include \
   | --includ | --inclu | --incl | --inc)
     ac_prev=includedir ;;
@@ -462,13 +944,16 @@
   | --libexe=* | --libex=* | --libe=*)
     libexecdir=$ac_optarg ;;
 
+  -localedir | --localedir | --localedi | --localed | --locale)
+    ac_prev=localedir ;;
+  -localedir=* | --localedir=* | --localedi=* | --localed=* | --locale=*)
+    localedir=$ac_optarg ;;
+
   -localstatedir | --localstatedir | --localstatedi | --localstated \
-  | --localstate | --localstat | --localsta | --localst \
-  | --locals | --local | --loca | --loc | --lo)
+  | --localstate | --localstat | --localsta | --localst | --locals)
     ac_prev=localstatedir ;;
   -localstatedir=* | --localstatedir=* | --localstatedi=* | --localstated=* \
-  | --localstate=* | --localstat=* | --localsta=* | --localst=* \
-  | --locals=* | --local=* | --loca=* | --loc=* | --lo=*)
+  | --localstate=* | --localstat=* | --localsta=* | --localst=* | --locals=*)
     localstatedir=$ac_optarg ;;
 
   -mandir | --mandir | --mandi | --mand | --man | --ma | --m)
@@ -533,6 +1018,16 @@
   | --progr-tra=* | --program-tr=* | --program-t=*)
     program_transform_name=$ac_optarg ;;
 
+  -pdfdir | --pdfdir | --pdfdi | --pdfd | --pdf | --pd)
+    ac_prev=pdfdir ;;
+  -pdfdir=* | --pdfdir=* | --pdfdi=* | --pdfd=* | --pdf=* | --pd=*)
+    pdfdir=$ac_optarg ;;
+
+  -psdir | --psdir | --psdi | --psd | --ps)
+    ac_prev=psdir ;;
+  -psdir=* | --psdir=* | --psdi=* | --psd=* | --ps=*)
+    psdir=$ac_optarg ;;
+
   -q | -quiet | --quiet | --quie | --qui | --qu | --q \
   | -silent | --silent | --silen | --sile | --sil)
     silent=yes ;;
@@ -583,26 +1078,38 @@
     ac_init_version=: ;;
 
   -with-* | --with-*)
-    ac_package=`expr "x$ac_option" : 'x-*with-\([^=]*\)'`
+    ac_useropt=`expr "x$ac_option" : 'x-*with-\([^=]*\)'`
     # Reject names that are not valid shell variable names.
-    expr "x$ac_package" : ".*[^-_$as_cr_alnum]" >/dev/null &&
-      { echo "$as_me: error: invalid package name: $ac_package" >&2
+    expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
+      { $as_echo "$as_me: error: invalid package name: $ac_useropt" >&2
    { (exit 1); exit 1; }; }
-    ac_package=`echo $ac_package| sed 's/-/_/g'`
-    case $ac_option in
-      *=*) ac_optarg=`echo "$ac_optarg" | sed "s/'/'\\\\\\\\''/g"`;;
-      *) ac_optarg=yes ;;
+    ac_useropt_orig=$ac_useropt
+    ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
+    case $ac_user_opts in
+      *"
+"with_$ac_useropt"
+"*) ;;
+      *) ac_unrecognized_opts="$ac_unrecognized_opts$ac_unrecognized_sep--with-$ac_useropt_orig"
+	 ac_unrecognized_sep=', ';;
     esac
-    eval "with_$ac_package='$ac_optarg'" ;;
+    eval with_$ac_useropt=\$ac_optarg ;;
 
   -without-* | --without-*)
-    ac_package=`expr "x$ac_option" : 'x-*without-\(.*\)'`
+    ac_useropt=`expr "x$ac_option" : 'x-*without-\(.*\)'`
     # Reject names that are not valid shell variable names.
-    expr "x$ac_package" : ".*[^-_$as_cr_alnum]" >/dev/null &&
-      { echo "$as_me: error: invalid package name: $ac_package" >&2
+    expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
+      { $as_echo "$as_me: error: invalid package name: $ac_useropt" >&2
    { (exit 1); exit 1; }; }
-    ac_package=`echo $ac_package | sed 's/-/_/g'`
-    eval "with_$ac_package=no" ;;
+    ac_useropt_orig=$ac_useropt
+    ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
+    case $ac_user_opts in
+      *"
+"with_$ac_useropt"
+"*) ;;
+      *) ac_unrecognized_opts="$ac_unrecognized_opts$ac_unrecognized_sep--without-$ac_useropt_orig"
+	 ac_unrecognized_sep=', ';;
+    esac
+    eval with_$ac_useropt=no ;;
 
   --x)
     # Obsolete; use --with-x.
@@ -622,7 +1129,7 @@
   | --x-librar=* | --x-libra=* | --x-libr=* | --x-lib=* | --x-li=* | --x-l=*)
     x_libraries=$ac_optarg ;;
 
-  -*) { echo "$as_me: error: unrecognized option: $ac_option
+  -*) { $as_echo "$as_me: error: unrecognized option: $ac_option
 Try \`$0 --help' for more information." >&2
    { (exit 1); exit 1; }; }
     ;;
@@ -631,17 +1138,16 @@
     ac_envvar=`expr "x$ac_option" : 'x\([^=]*\)='`
     # Reject names that are not valid shell variable names.
     expr "x$ac_envvar" : ".*[^_$as_cr_alnum]" >/dev/null &&
-      { echo "$as_me: error: invalid variable name: $ac_envvar" >&2
+      { $as_echo "$as_me: error: invalid variable name: $ac_envvar" >&2
    { (exit 1); exit 1; }; }
-    ac_optarg=`echo "$ac_optarg" | sed "s/'/'\\\\\\\\''/g"`
-    eval "$ac_envvar='$ac_optarg'"
+    eval $ac_envvar=\$ac_optarg
     export $ac_envvar ;;
 
   *)
     # FIXME: should be removed in autoconf 3.0.
-    echo "$as_me: WARNING: you should use --build, --host, --target" >&2
+    $as_echo "$as_me: WARNING: you should use --build, --host, --target" >&2
     expr "x$ac_option" : ".*[^-._$as_cr_alnum]" >/dev/null &&
-      echo "$as_me: WARNING: invalid host type: $ac_option" >&2
+      $as_echo "$as_me: WARNING: invalid host type: $ac_option" >&2
     : ${build_alias=$ac_option} ${host_alias=$ac_option} ${target_alias=$ac_option}
     ;;
 
@@ -650,31 +1156,39 @@
 
 if test -n "$ac_prev"; then
   ac_option=--`echo $ac_prev | sed 's/_/-/g'`
-  { echo "$as_me: error: missing argument to $ac_option" >&2
+  { $as_echo "$as_me: error: missing argument to $ac_option" >&2
    { (exit 1); exit 1; }; }
 fi
 
-# Be sure to have absolute paths.
-for ac_var in exec_prefix prefix
-do
-  eval ac_val=$`echo $ac_var`
-  case $ac_val in
-    [\\/$]* | ?:[\\/]* | NONE | '' ) ;;
-    *)  { echo "$as_me: error: expected an absolute directory name for --$ac_var: $ac_val" >&2
-   { (exit 1); exit 1; }; };;
+if test -n "$ac_unrecognized_opts"; then
+  case $enable_option_checking in
+    no) ;;
+    fatal) { $as_echo "$as_me: error: unrecognized options: $ac_unrecognized_opts" >&2
+   { (exit 1); exit 1; }; } ;;
+    *)     $as_echo "$as_me: WARNING: unrecognized options: $ac_unrecognized_opts" >&2 ;;
   esac
-done
+fi
 
-# Be sure to have absolute paths.
-for ac_var in bindir sbindir libexecdir datadir sysconfdir sharedstatedir \
-              localstatedir libdir includedir oldincludedir infodir mandir
+# Check all directory arguments for consistency.
+for ac_var in	exec_prefix prefix bindir sbindir libexecdir datarootdir \
+		datadir sysconfdir sharedstatedir localstatedir includedir \
+		oldincludedir docdir infodir htmldir dvidir pdfdir psdir \
+		libdir localedir mandir
 do
-  eval ac_val=$`echo $ac_var`
+  eval ac_val=\$$ac_var
+  # Remove trailing slashes.
   case $ac_val in
-    [\\/$]* | ?:[\\/]* ) ;;
-    *)  { echo "$as_me: error: expected an absolute directory name for --$ac_var: $ac_val" >&2
-   { (exit 1); exit 1; }; };;
+    */ )
+      ac_val=`expr "X$ac_val" : 'X\(.*[^/]\)' \| "X$ac_val" : 'X\(.*\)'`
+      eval $ac_var=\$ac_val;;
   esac
+  # Be sure to have absolute directory names.
+  case $ac_val in
+    [\\/$]* | ?:[\\/]* )  continue;;
+    NONE | '' ) case $ac_var in *prefix ) continue;; esac;;
+  esac
+  { $as_echo "$as_me: error: expected an absolute directory name for --$ac_var: $ac_val" >&2
+   { (exit 1); exit 1; }; }
 done
 
 # There might be people who depend on the old broken behavior: `$host'
@@ -688,7 +1202,7 @@
 if test "x$host_alias" != x; then
   if test "x$build_alias" = x; then
     cross_compiling=maybe
-    echo "$as_me: WARNING: If you wanted to set the --build type, don't use --host.
+    $as_echo "$as_me: WARNING: If you wanted to set the --build type, don't use --host.
     If a cross compiler is detected then cross compile mode will be used." >&2
   elif test "x$build_alias" != "x$host_alias"; then
     cross_compiling=yes
@@ -701,82 +1215,76 @@
 test "$silent" = yes && exec 6>/dev/null
 
 
+ac_pwd=`pwd` && test -n "$ac_pwd" &&
+ac_ls_di=`ls -di .` &&
+ac_pwd_ls_di=`cd "$ac_pwd" && ls -di .` ||
+  { $as_echo "$as_me: error: working directory cannot be determined" >&2
+   { (exit 1); exit 1; }; }
+test "X$ac_ls_di" = "X$ac_pwd_ls_di" ||
+  { $as_echo "$as_me: error: pwd does not report name of working directory" >&2
+   { (exit 1); exit 1; }; }
+
+
 # Find the source files, if location was not specified.
 if test -z "$srcdir"; then
   ac_srcdir_defaulted=yes
-  # Try the directory containing this script, then its parent.
-  ac_confdir=`(dirname "$0") 2>/dev/null ||
-$as_expr X"$0" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-         X"$0" : 'X\(//\)[^/]' \| \
-         X"$0" : 'X\(//\)$' \| \
-         X"$0" : 'X\(/\)' \| \
-         .     : '\(.\)' 2>/dev/null ||
-echo X"$0" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{ s//\1/; q; }
-  	  /^X\(\/\/\)[^/].*/{ s//\1/; q; }
-  	  /^X\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\(\/\).*/{ s//\1/; q; }
-  	  s/.*/./; q'`
+  # Try the directory containing this script, then the parent directory.
+  ac_confdir=`$as_dirname -- "$as_myself" ||
+$as_expr X"$as_myself" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
+	 X"$as_myself" : 'X\(//\)[^/]' \| \
+	 X"$as_myself" : 'X\(//\)$' \| \
+	 X"$as_myself" : 'X\(/\)' \| . 2>/dev/null ||
+$as_echo X"$as_myself" |
+    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)[^/].*/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\).*/{
+	    s//\1/
+	    q
+	  }
+	  s/.*/./; q'`
   srcdir=$ac_confdir
-  if test ! -r $srcdir/$ac_unique_file; then
+  if test ! -r "$srcdir/$ac_unique_file"; then
     srcdir=..
   fi
 else
   ac_srcdir_defaulted=no
 fi
-if test ! -r $srcdir/$ac_unique_file; then
-  if test "$ac_srcdir_defaulted" = yes; then
-    { echo "$as_me: error: cannot find sources ($ac_unique_file) in $ac_confdir or .." >&2
+if test ! -r "$srcdir/$ac_unique_file"; then
+  test "$ac_srcdir_defaulted" = yes && srcdir="$ac_confdir or .."
+  { $as_echo "$as_me: error: cannot find sources ($ac_unique_file) in $srcdir" >&2
    { (exit 1); exit 1; }; }
-  else
-    { echo "$as_me: error: cannot find sources ($ac_unique_file) in $srcdir" >&2
+fi
+ac_msg="sources are in $srcdir, but \`cd $srcdir' does not work"
+ac_abs_confdir=`(
+	cd "$srcdir" && test -r "./$ac_unique_file" || { $as_echo "$as_me: error: $ac_msg" >&2
    { (exit 1); exit 1; }; }
-  fi
+	pwd)`
+# When building in place, set srcdir=.
+if test "$ac_abs_confdir" = "$ac_pwd"; then
+  srcdir=.
 fi
-(cd $srcdir && test -r ./$ac_unique_file) 2>/dev/null ||
-  { echo "$as_me: error: sources are in $srcdir, but \`cd $srcdir' does not work" >&2
-   { (exit 1); exit 1; }; }
-srcdir=`echo "$srcdir" | sed 's%\([^\\/]\)[\\/]*$%\1%'`
-ac_env_build_alias_set=${build_alias+set}
-ac_env_build_alias_value=$build_alias
-ac_cv_env_build_alias_set=${build_alias+set}
-ac_cv_env_build_alias_value=$build_alias
-ac_env_host_alias_set=${host_alias+set}
-ac_env_host_alias_value=$host_alias
-ac_cv_env_host_alias_set=${host_alias+set}
-ac_cv_env_host_alias_value=$host_alias
-ac_env_target_alias_set=${target_alias+set}
-ac_env_target_alias_value=$target_alias
-ac_cv_env_target_alias_set=${target_alias+set}
-ac_cv_env_target_alias_value=$target_alias
-ac_env_CC_set=${CC+set}
-ac_env_CC_value=$CC
-ac_cv_env_CC_set=${CC+set}
-ac_cv_env_CC_value=$CC
-ac_env_CFLAGS_set=${CFLAGS+set}
-ac_env_CFLAGS_value=$CFLAGS
-ac_cv_env_CFLAGS_set=${CFLAGS+set}
-ac_cv_env_CFLAGS_value=$CFLAGS
-ac_env_LDFLAGS_set=${LDFLAGS+set}
-ac_env_LDFLAGS_value=$LDFLAGS
-ac_cv_env_LDFLAGS_set=${LDFLAGS+set}
-ac_cv_env_LDFLAGS_value=$LDFLAGS
-ac_env_CPPFLAGS_set=${CPPFLAGS+set}
-ac_env_CPPFLAGS_value=$CPPFLAGS
-ac_cv_env_CPPFLAGS_set=${CPPFLAGS+set}
-ac_cv_env_CPPFLAGS_value=$CPPFLAGS
-ac_env_CXX_set=${CXX+set}
-ac_env_CXX_value=$CXX
-ac_cv_env_CXX_set=${CXX+set}
-ac_cv_env_CXX_value=$CXX
-ac_env_CXXFLAGS_set=${CXXFLAGS+set}
-ac_env_CXXFLAGS_value=$CXXFLAGS
-ac_cv_env_CXXFLAGS_set=${CXXFLAGS+set}
-ac_cv_env_CXXFLAGS_value=$CXXFLAGS
-ac_env_CXXCPP_set=${CXXCPP+set}
-ac_env_CXXCPP_value=$CXXCPP
-ac_cv_env_CXXCPP_set=${CXXCPP+set}
-ac_cv_env_CXXCPP_value=$CXXCPP
+# Remove unnecessary trailing slashes from srcdir.
+# Double slashes in file names in object file debugging info
+# mess up M-x gdb in Emacs.
+case $srcdir in
+*/) srcdir=`expr "X$srcdir" : 'X\(.*[^/]\)' \| "X$srcdir" : 'X\(.*\)'`;;
+esac
+for ac_var in $ac_precious_vars; do
+  eval ac_env_${ac_var}_set=\${${ac_var}+set}
+  eval ac_env_${ac_var}_value=\$${ac_var}
+  eval ac_cv_env_${ac_var}_set=\${${ac_var}+set}
+  eval ac_cv_env_${ac_var}_value=\$${ac_var}
+done
 
 #
 # Report the --help message.
@@ -805,9 +1313,6 @@
   -n, --no-create         do not create output files
       --srcdir=DIR        find the sources in DIR [configure dir or \`..']
 
-_ACEOF
-
-  cat <<_ACEOF
 Installation directories:
   --prefix=PREFIX         install architecture-independent files in PREFIX
                           [$ac_default_prefix]
@@ -822,18 +1327,25 @@
 For better control, use the options below.
 
 Fine tuning of the installation directories:
-  --bindir=DIR           user executables [EPREFIX/bin]
-  --sbindir=DIR          system admin executables [EPREFIX/sbin]
-  --libexecdir=DIR       program executables [EPREFIX/libexec]
-  --datadir=DIR          read-only architecture-independent data [PREFIX/share]
-  --sysconfdir=DIR       read-only single-machine data [PREFIX/etc]
-  --sharedstatedir=DIR   modifiable architecture-independent data [PREFIX/com]
-  --localstatedir=DIR    modifiable single-machine data [PREFIX/var]
-  --libdir=DIR           object code libraries [EPREFIX/lib]
-  --includedir=DIR       C header files [PREFIX/include]
-  --oldincludedir=DIR    C header files for non-gcc [/usr/include]
-  --infodir=DIR          info documentation [PREFIX/info]
-  --mandir=DIR           man documentation [PREFIX/man]
+  --bindir=DIR            user executables [EPREFIX/bin]
+  --sbindir=DIR           system admin executables [EPREFIX/sbin]
+  --libexecdir=DIR        program executables [EPREFIX/libexec]
+  --sysconfdir=DIR        read-only single-machine data [PREFIX/etc]
+  --sharedstatedir=DIR    modifiable architecture-independent data [PREFIX/com]
+  --localstatedir=DIR     modifiable single-machine data [PREFIX/var]
+  --libdir=DIR            object code libraries [EPREFIX/lib]
+  --includedir=DIR        C header files [PREFIX/include]
+  --oldincludedir=DIR     C header files for non-gcc [/usr/include]
+  --datarootdir=DIR       read-only arch.-independent data root [PREFIX/share]
+  --datadir=DIR           read-only architecture-independent data [DATAROOTDIR]
+  --infodir=DIR           info documentation [DATAROOTDIR/info]
+  --localedir=DIR         locale-dependent data [DATAROOTDIR/locale]
+  --mandir=DIR            man documentation [DATAROOTDIR/man]
+  --docdir=DIR            documentation root [DATAROOTDIR/doc/windstille]
+  --htmldir=DIR           html documentation [DOCDIR]
+  --dvidir=DIR            dvi documentation [DOCDIR]
+  --pdfdir=DIR            pdf documentation [DOCDIR]
+  --psdir=DIR             ps documentation [DOCDIR]
 _ACEOF
 
   cat <<\_ACEOF
@@ -852,6 +1364,7 @@
   cat <<\_ACEOF
 
 Optional Features:
+  --disable-option-checking  ignore unrecognized --enable/--with options
   --disable-FEATURE       do not include FEATURE (same as --enable-FEATURE=no)
   --enable-FEATURE[=ARG]  include FEATURE [ARG=yes]
   --disable-dependency-tracking Speeds up one-time builds
@@ -862,98 +1375,104 @@
   CFLAGS      C compiler flags
   LDFLAGS     linker flags, e.g. -L<lib dir> if you have libraries in a
               nonstandard directory <lib dir>
-  CPPFLAGS    C/C++ preprocessor flags, e.g. -I<include dir> if you have
-              headers in a nonstandard directory <include dir>
+  LIBS        libraries to pass to the linker, e.g. -l<library>
+  CPPFLAGS    C/C++/Objective C preprocessor flags, e.g. -I<include dir> if
+              you have headers in a nonstandard directory <include dir>
   CXX         C++ compiler command
   CXXFLAGS    C++ compiler flags
   CXXCPP      C++ preprocessor
+  PKG_CONFIG  path to pkg-config utility
+  WINDSTILLE_DEPS_CFLAGS
+              C compiler flags for WINDSTILLE_DEPS, overriding pkg-config
+  WINDSTILLE_DEPS_LIBS
+              linker flags for WINDSTILLE_DEPS, overriding pkg-config
 
 Use these variables to override the choices made by `configure' or to help
 it to find libraries and programs with nonstandard names/locations.
 
 _ACEOF
+ac_status=$?
 fi
 
 if test "$ac_init_help" = "recursive"; then
   # If there are subdirs, report their specific --help.
-  ac_popdir=`pwd`
   for ac_dir in : $ac_subdirs_all; do test "x$ac_dir" = x: && continue
-    test -d $ac_dir || continue
+    test -d "$ac_dir" ||
+      { cd "$srcdir" && ac_pwd=`pwd` && srcdir=. && test -d "$ac_dir"; } ||
+      continue
     ac_builddir=.
 
-if test "$ac_dir" != .; then
-  ac_dir_suffix=/`echo "$ac_dir" | sed 's,^\.[\\/],,'`
-  # A "../" for each directory in $ac_dir_suffix.
-  ac_top_builddir=`echo "$ac_dir_suffix" | sed 's,/[^\\/]*,../,g'`
-else
-  ac_dir_suffix= ac_top_builddir=
-fi
+case "$ac_dir" in
+.) ac_dir_suffix= ac_top_builddir_sub=. ac_top_build_prefix= ;;
+*)
+  ac_dir_suffix=/`$as_echo "$ac_dir" | sed 's|^\.[\\/]||'`
+  # A ".." for each directory in $ac_dir_suffix.
+  ac_top_builddir_sub=`$as_echo "$ac_dir_suffix" | sed 's|/[^\\/]*|/..|g;s|/||'`
+  case $ac_top_builddir_sub in
+  "") ac_top_builddir_sub=. ac_top_build_prefix= ;;
+  *)  ac_top_build_prefix=$ac_top_builddir_sub/ ;;
+  esac ;;
+esac
+ac_abs_top_builddir=$ac_pwd
+ac_abs_builddir=$ac_pwd$ac_dir_suffix
+# for backward compatibility:
+ac_top_builddir=$ac_top_build_prefix
 
 case $srcdir in
-  .)  # No --srcdir option.  We are building in place.
+  .)  # We are building in place.
     ac_srcdir=.
-    if test -z "$ac_top_builddir"; then
-       ac_top_srcdir=.
-    else
-       ac_top_srcdir=`echo $ac_top_builddir | sed 's,/$,,'`
-    fi ;;
-  [\\/]* | ?:[\\/]* )  # Absolute path.
+    ac_top_srcdir=$ac_top_builddir_sub
+    ac_abs_top_srcdir=$ac_pwd ;;
+  [\\/]* | ?:[\\/]* )  # Absolute name.
     ac_srcdir=$srcdir$ac_dir_suffix;
-    ac_top_srcdir=$srcdir ;;
-  *) # Relative path.
-    ac_srcdir=$ac_top_builddir$srcdir$ac_dir_suffix
-    ac_top_srcdir=$ac_top_builddir$srcdir ;;
+    ac_top_srcdir=$srcdir
+    ac_abs_top_srcdir=$srcdir ;;
+  *) # Relative name.
+    ac_srcdir=$ac_top_build_prefix$srcdir$ac_dir_suffix
+    ac_top_srcdir=$ac_top_build_prefix$srcdir
+    ac_abs_top_srcdir=$ac_pwd/$srcdir ;;
 esac
-# Don't blindly perform a `cd "$ac_dir"/$ac_foo && pwd` since $ac_foo can be
-# absolute.
-ac_abs_builddir=`cd "$ac_dir" && cd $ac_builddir && pwd`
-ac_abs_top_builddir=`cd "$ac_dir" && cd ${ac_top_builddir}. && pwd`
-ac_abs_srcdir=`cd "$ac_dir" && cd $ac_srcdir && pwd`
-ac_abs_top_srcdir=`cd "$ac_dir" && cd $ac_top_srcdir && pwd`
+ac_abs_srcdir=$ac_abs_top_srcdir$ac_dir_suffix
 
-    cd $ac_dir
-    # Check for guested configure; otherwise get Cygnus style configure.
-    if test -f $ac_srcdir/configure.gnu; then
-      echo
-      $SHELL $ac_srcdir/configure.gnu  --help=recursive
-    elif test -f $ac_srcdir/configure; then
-      echo
-      $SHELL $ac_srcdir/configure  --help=recursive
-    elif test -f $ac_srcdir/configure.ac ||
-           test -f $ac_srcdir/configure.in; then
-      echo
-      $ac_configure --help
+    cd "$ac_dir" || { ac_status=$?; continue; }
+    # Check for guested configure.
+    if test -f "$ac_srcdir/configure.gnu"; then
+      echo &&
+      $SHELL "$ac_srcdir/configure.gnu" --help=recursive
+    elif test -f "$ac_srcdir/configure"; then
+      echo &&
+      $SHELL "$ac_srcdir/configure" --help=recursive
     else
-      echo "$as_me: WARNING: no configuration information is in $ac_dir" >&2
-    fi
-    cd $ac_popdir
+      $as_echo "$as_me: WARNING: no configuration information is in $ac_dir" >&2
+    fi || ac_status=$?
+    cd "$ac_pwd" || { ac_status=$?; break; }
   done
 fi
 
-test -n "$ac_init_help" && exit 0
+test -n "$ac_init_help" && exit $ac_status
 if $ac_init_version; then
   cat <<\_ACEOF
 Windstille configure 0.1.0
-generated by GNU Autoconf 2.57
+generated by GNU Autoconf 2.63
 
-Copyright 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001, 2002
-Free Software Foundation, Inc.
+Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
+2002, 2003, 2004, 2005, 2006, 2007, 2008 Free Software Foundation, Inc.
 This configure script is free software; the Free Software Foundation
 gives unlimited permission to copy, distribute and modify it.
 _ACEOF
-  exit 0
+  exit
 fi
-exec 5>config.log
-cat >&5 <<_ACEOF
+cat >config.log <<_ACEOF
 This file contains any messages produced by compilers while
 running configure, to aid debugging if configure makes a mistake.
 
 It was created by Windstille $as_me 0.1.0, which was
-generated by GNU Autoconf 2.57.  Invocation command line was
+generated by GNU Autoconf 2.63.  Invocation command line was
 
   $ $0 $@
 
 _ACEOF
+exec 5>>config.log
 {
 cat <<_ASUNAME
 ## --------- ##
@@ -972,7 +1491,7 @@
 /bin/arch              = `(/bin/arch) 2>/dev/null              || echo unknown`
 /usr/bin/arch -k       = `(/usr/bin/arch -k) 2>/dev/null       || echo unknown`
 /usr/convex/getsysinfo = `(/usr/convex/getsysinfo) 2>/dev/null || echo unknown`
-hostinfo               = `(hostinfo) 2>/dev/null               || echo unknown`
+/usr/bin/hostinfo      = `(/usr/bin/hostinfo) 2>/dev/null      || echo unknown`
 /bin/machine           = `(/bin/machine) 2>/dev/null           || echo unknown`
 /usr/bin/oslevel       = `(/usr/bin/oslevel) 2>/dev/null       || echo unknown`
 /bin/universe          = `(/bin/universe) 2>/dev/null          || echo unknown`
@@ -984,8 +1503,9 @@
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
-  echo "PATH: $as_dir"
+  $as_echo "PATH: $as_dir"
 done
+IFS=$as_save_IFS
 
 } >&5
 
@@ -1007,7 +1527,6 @@
 ac_configure_args=
 ac_configure_args0=
 ac_configure_args1=
-ac_sep=
 ac_must_keep_next=false
 for ac_pass in 1 2
 do
@@ -1018,31 +1537,29 @@
     -q | -quiet | --quiet | --quie | --qui | --qu | --q \
     | -silent | --silent | --silen | --sile | --sil)
       continue ;;
-    *" "*|*"	"*|*[\[\]\~\#\$\^\&\*\(\)\{\}\\\|\;\<\>\?\"\']*)
-      ac_arg=`echo "$ac_arg" | sed "s/'/'\\\\\\\\''/g"` ;;
+    *\'*)
+      ac_arg=`$as_echo "$ac_arg" | sed "s/'/'\\\\\\\\''/g"` ;;
     esac
     case $ac_pass in
     1) ac_configure_args0="$ac_configure_args0 '$ac_arg'" ;;
     2)
       ac_configure_args1="$ac_configure_args1 '$ac_arg'"
       if test $ac_must_keep_next = true; then
-        ac_must_keep_next=false # Got value, back to normal.
+	ac_must_keep_next=false # Got value, back to normal.
       else
-        case $ac_arg in
-          *=* | --config-cache | -C | -disable-* | --disable-* \
-          | -enable-* | --enable-* | -gas | --g* | -nfp | --nf* \
-          | -q | -quiet | --q* | -silent | --sil* | -v | -verb* \
-          | -with-* | --with-* | -without-* | --without-* | --x)
-            case "$ac_configure_args0 " in
-              "$ac_configure_args1"*" '$ac_arg' "* ) continue ;;
-            esac
-            ;;
-          -* ) ac_must_keep_next=true ;;
-        esac
+	case $ac_arg in
+	  *=* | --config-cache | -C | -disable-* | --disable-* \
+	  | -enable-* | --enable-* | -gas | --g* | -nfp | --nf* \
+	  | -q | -quiet | --q* | -silent | --sil* | -v | -verb* \
+	  | -with-* | --with-* | -without-* | --without-* | --x)
+	    case "$ac_configure_args0 " in
+	      "$ac_configure_args1"*" '$ac_arg' "* ) continue ;;
+	    esac
+	    ;;
+	  -* ) ac_must_keep_next=true ;;
+	esac
       fi
-      ac_configure_args="$ac_configure_args$ac_sep'$ac_arg'"
-      # Get rid of the leading space.
-      ac_sep=" "
+      ac_configure_args="$ac_configure_args '$ac_arg'"
       ;;
     esac
   done
@@ -1053,8 +1570,8 @@
 # When interrupted or exit'd, cleanup temporary files, and complete
 # config.log.  We remove comments because anyway the quotes in there
 # would cause problems or look ugly.
-# WARNING: Be sure not to use single quotes in there, as some shells,
-# such as our DU 5.0 friend, will then `close' the trap.
+# WARNING: Use '\'' to represent an apostrophe within the trap.
+# WARNING: Do not start the trap code with a newline, due to a FreeBSD 4.0 bug.
 trap 'exit_status=$?
   # Save into config.log some information that might help in debugging.
   {
@@ -1067,20 +1584,35 @@
 _ASBOX
     echo
     # The following way of writing the cache mishandles newlines in values,
-{
+(
+  for ac_var in `(set) 2>&1 | sed -n '\''s/^\([a-zA-Z_][a-zA-Z0-9_]*\)=.*/\1/p'\''`; do
+    eval ac_val=\$$ac_var
+    case $ac_val in #(
+    *${as_nl}*)
+      case $ac_var in #(
+      *_cv_*) { $as_echo "$as_me:$LINENO: WARNING: cache variable $ac_var contains a newline" >&5
+$as_echo "$as_me: WARNING: cache variable $ac_var contains a newline" >&2;} ;;
+      esac
+      case $ac_var in #(
+      _ | IFS | as_nl) ;; #(
+      BASH_ARGV | BASH_SOURCE) eval $ac_var= ;; #(
+      *) $as_unset $ac_var ;;
+      esac ;;
+    esac
+  done
   (set) 2>&1 |
-    case `(ac_space='"'"' '"'"'; set | grep ac_space) 2>&1` in
-    *ac_space=\ *)
+    case $as_nl`(ac_space='\'' '\''; set) 2>&1` in #(
+    *${as_nl}ac_space=\ *)
       sed -n \
-        "s/'"'"'/'"'"'\\\\'"'"''"'"'/g;
-    	  s/^\\([_$as_cr_alnum]*_cv_[_$as_cr_alnum]*\\)=\\(.*\\)/\\1='"'"'\\2'"'"'/p"
-      ;;
+	"s/'\''/'\''\\\\'\'''\''/g;
+	  s/^\\([_$as_cr_alnum]*_cv_[_$as_cr_alnum]*\\)=\\(.*\\)/\\1='\''\\2'\''/p"
+      ;; #(
     *)
-      sed -n \
-        "s/^\\([_$as_cr_alnum]*_cv_[_$as_cr_alnum]*\\)=\\(.*\\)/\\1=\\2/p"
+      sed -n "/^[_$as_cr_alnum]*_cv_[_$as_cr_alnum]*=/p"
       ;;
-    esac;
-}
+    esac |
+    sort
+)
     echo
 
     cat <<\_ASBOX
@@ -1091,22 +1623,28 @@
     echo
     for ac_var in $ac_subst_vars
     do
-      eval ac_val=$`echo $ac_var`
-      echo "$ac_var='"'"'$ac_val'"'"'"
+      eval ac_val=\$$ac_var
+      case $ac_val in
+      *\'\''*) ac_val=`$as_echo "$ac_val" | sed "s/'\''/'\''\\\\\\\\'\'''\''/g"`;;
+      esac
+      $as_echo "$ac_var='\''$ac_val'\''"
     done | sort
     echo
 
     if test -n "$ac_subst_files"; then
       cat <<\_ASBOX
-## ------------- ##
-## Output files. ##
-## ------------- ##
+## ------------------- ##
+## File substitutions. ##
+## ------------------- ##
 _ASBOX
       echo
       for ac_var in $ac_subst_files
       do
-	eval ac_val=$`echo $ac_var`
-        echo "$ac_var='"'"'$ac_val'"'"'"
+	eval ac_val=\$$ac_var
+	case $ac_val in
+	*\'\''*) ac_val=`$as_echo "$ac_val" | sed "s/'\''/'\''\\\\\\\\'\'''\''/g"`;;
+	esac
+	$as_echo "$ac_var='\''$ac_val'\''"
       done | sort
       echo
     fi
@@ -1118,26 +1656,24 @@
 ## ----------- ##
 _ASBOX
       echo
-      sed "/^$/d" confdefs.h | sort
+      cat confdefs.h
       echo
     fi
     test "$ac_signal" != 0 &&
-      echo "$as_me: caught signal $ac_signal"
-    echo "$as_me: exit $exit_status"
+      $as_echo "$as_me: caught signal $ac_signal"
+    $as_echo "$as_me: exit $exit_status"
   } >&5
-  rm -f core core.* *.core &&
-  rm -rf conftest* confdefs* conf$$* $ac_clean_files &&
+  rm -f core *.core core.conftest.* &&
+    rm -f -r conftest* confdefs* conf$$* $ac_clean_files &&
     exit $exit_status
-     ' 0
+' 0
 for ac_signal in 1 2 13 15; do
   trap 'ac_signal='$ac_signal'; { (exit 1); exit 1; }' $ac_signal
 done
 ac_signal=0
 
 # confdefs.h avoids OS command line length limits that DEFS can exceed.
-rm -rf conftest* confdefs.h
-# AIX cpp loses on an empty file, so make sure it contains at least a newline.
-echo >confdefs.h
+rm -f -r conftest* confdefs.h
 
 # Predefined preprocessor variables.
 
@@ -1167,18 +1703,24 @@
 
 
 # Let the site file select an alternate cache file if it wants to.
-# Prefer explicitly selected file to automatically selected ones.
-if test -z "$CONFIG_SITE"; then
-  if test "x$prefix" != xNONE; then
-    CONFIG_SITE="$prefix/share/config.site $prefix/etc/config.site"
-  else
-    CONFIG_SITE="$ac_default_prefix/share/config.site $ac_default_prefix/etc/config.site"
-  fi
+# Prefer an explicitly selected file to automatically selected ones.
+ac_site_file1=NONE
+ac_site_file2=NONE
+if test -n "$CONFIG_SITE"; then
+  ac_site_file1=$CONFIG_SITE
+elif test "x$prefix" != xNONE; then
+  ac_site_file1=$prefix/share/config.site
+  ac_site_file2=$prefix/etc/config.site
+else
+  ac_site_file1=$ac_default_prefix/share/config.site
+  ac_site_file2=$ac_default_prefix/etc/config.site
 fi
-for ac_site_file in $CONFIG_SITE; do
+for ac_site_file in "$ac_site_file1" "$ac_site_file2"
+do
+  test "x$ac_site_file" = xNONE && continue
   if test -r "$ac_site_file"; then
-    { echo "$as_me:$LINENO: loading site script $ac_site_file" >&5
-echo "$as_me: loading site script $ac_site_file" >&6;}
+    { $as_echo "$as_me:$LINENO: loading site script $ac_site_file" >&5
+$as_echo "$as_me: loading site script $ac_site_file" >&6;}
     sed 's/^/| /' "$ac_site_file" >&5
     . "$ac_site_file"
   fi
@@ -1188,54 +1730,61 @@
   # Some versions of bash will fail to source /dev/null (special
   # files actually), so we avoid doing that.
   if test -f "$cache_file"; then
-    { echo "$as_me:$LINENO: loading cache $cache_file" >&5
-echo "$as_me: loading cache $cache_file" >&6;}
+    { $as_echo "$as_me:$LINENO: loading cache $cache_file" >&5
+$as_echo "$as_me: loading cache $cache_file" >&6;}
     case $cache_file in
-      [\\/]* | ?:[\\/]* ) . $cache_file;;
-      *)                      . ./$cache_file;;
+      [\\/]* | ?:[\\/]* ) . "$cache_file";;
+      *)                      . "./$cache_file";;
     esac
   fi
 else
-  { echo "$as_me:$LINENO: creating cache $cache_file" >&5
-echo "$as_me: creating cache $cache_file" >&6;}
+  { $as_echo "$as_me:$LINENO: creating cache $cache_file" >&5
+$as_echo "$as_me: creating cache $cache_file" >&6;}
   >$cache_file
 fi
 
 # Check that the precious variables saved in the cache have kept the same
 # value.
 ac_cache_corrupted=false
-for ac_var in `(set) 2>&1 |
-               sed -n 's/^ac_env_\([a-zA-Z_0-9]*\)_set=.*/\1/p'`; do
+for ac_var in $ac_precious_vars; do
   eval ac_old_set=\$ac_cv_env_${ac_var}_set
   eval ac_new_set=\$ac_env_${ac_var}_set
-  eval ac_old_val="\$ac_cv_env_${ac_var}_value"
-  eval ac_new_val="\$ac_env_${ac_var}_value"
+  eval ac_old_val=\$ac_cv_env_${ac_var}_value
+  eval ac_new_val=\$ac_env_${ac_var}_value
   case $ac_old_set,$ac_new_set in
     set,)
-      { echo "$as_me:$LINENO: error: \`$ac_var' was set to \`$ac_old_val' in the previous run" >&5
-echo "$as_me: error: \`$ac_var' was set to \`$ac_old_val' in the previous run" >&2;}
+      { $as_echo "$as_me:$LINENO: error: \`$ac_var' was set to \`$ac_old_val' in the previous run" >&5
+$as_echo "$as_me: error: \`$ac_var' was set to \`$ac_old_val' in the previous run" >&2;}
       ac_cache_corrupted=: ;;
     ,set)
-      { echo "$as_me:$LINENO: error: \`$ac_var' was not set in the previous run" >&5
-echo "$as_me: error: \`$ac_var' was not set in the previous run" >&2;}
+      { $as_echo "$as_me:$LINENO: error: \`$ac_var' was not set in the previous run" >&5
+$as_echo "$as_me: error: \`$ac_var' was not set in the previous run" >&2;}
       ac_cache_corrupted=: ;;
     ,);;
     *)
       if test "x$ac_old_val" != "x$ac_new_val"; then
-        { echo "$as_me:$LINENO: error: \`$ac_var' has changed since the previous run:" >&5
-echo "$as_me: error: \`$ac_var' has changed since the previous run:" >&2;}
-        { echo "$as_me:$LINENO:   former value:  $ac_old_val" >&5
-echo "$as_me:   former value:  $ac_old_val" >&2;}
-        { echo "$as_me:$LINENO:   current value: $ac_new_val" >&5
-echo "$as_me:   current value: $ac_new_val" >&2;}
-        ac_cache_corrupted=:
+	# differences in whitespace do not lead to failure.
+	ac_old_val_w=`echo x $ac_old_val`
+	ac_new_val_w=`echo x $ac_new_val`
+	if test "$ac_old_val_w" != "$ac_new_val_w"; then
+	  { $as_echo "$as_me:$LINENO: error: \`$ac_var' has changed since the previous run:" >&5
+$as_echo "$as_me: error: \`$ac_var' has changed since the previous run:" >&2;}
+	  ac_cache_corrupted=:
+	else
+	  { $as_echo "$as_me:$LINENO: warning: ignoring whitespace changes in \`$ac_var' since the previous run:" >&5
+$as_echo "$as_me: warning: ignoring whitespace changes in \`$ac_var' since the previous run:" >&2;}
+	  eval $ac_var=\$ac_old_val
+	fi
+	{ $as_echo "$as_me:$LINENO:   former value:  \`$ac_old_val'" >&5
+$as_echo "$as_me:   former value:  \`$ac_old_val'" >&2;}
+	{ $as_echo "$as_me:$LINENO:   current value: \`$ac_new_val'" >&5
+$as_echo "$as_me:   current value: \`$ac_new_val'" >&2;}
       fi;;
   esac
   # Pass precious variables to config.status.
   if test "$ac_new_set" = set; then
     case $ac_new_val in
-    *" "*|*"	"*|*[\[\]\~\#\$\^\&\*\(\)\{\}\\\|\;\<\>\?\"\']*)
-      ac_arg=$ac_var=`echo "$ac_new_val" | sed "s/'/'\\\\\\\\''/g"` ;;
+    *\'*) ac_arg=$ac_var=`$as_echo "$ac_new_val" | sed "s/'/'\\\\\\\\''/g"` ;;
     *) ac_arg=$ac_var=$ac_new_val ;;
     esac
     case " $ac_configure_args " in
@@ -1245,18 +1794,15 @@
   fi
 done
 if $ac_cache_corrupted; then
-  { echo "$as_me:$LINENO: error: changes in the environment can compromise the build" >&5
-echo "$as_me: error: changes in the environment can compromise the build" >&2;}
-  { { echo "$as_me:$LINENO: error: run \`make distclean' and/or \`rm $cache_file' and start over" >&5
-echo "$as_me: error: run \`make distclean' and/or \`rm $cache_file' and start over" >&2;}
+  { $as_echo "$as_me:$LINENO: error: in \`$ac_pwd':" >&5
+$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+  { $as_echo "$as_me:$LINENO: error: changes in the environment can compromise the build" >&5
+$as_echo "$as_me: error: changes in the environment can compromise the build" >&2;}
+  { { $as_echo "$as_me:$LINENO: error: run \`make distclean' and/or \`rm $cache_file' and start over" >&5
+$as_echo "$as_me: error: run \`make distclean' and/or \`rm $cache_file' and start over" >&2;}
    { (exit 1); exit 1; }; }
 fi
 
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
 
 
 
@@ -1281,38 +1827,48 @@
 
 
 
+ac_ext=c
+ac_cpp='$CPP $CPPFLAGS'
+ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
+ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
+ac_compiler_gnu=$ac_cv_c_compiler_gnu
 
 
+ac_config_headers="$ac_config_headers config.h"
 
-          ac_config_headers="$ac_config_headers config.h"
 
-
 am__api_version="1.7"
 ac_aux_dir=
-for ac_dir in $srcdir $srcdir/.. $srcdir/../..; do
-  if test -f $ac_dir/install-sh; then
+for ac_dir in "$srcdir" "$srcdir/.." "$srcdir/../.."; do
+  if test -f "$ac_dir/install-sh"; then
     ac_aux_dir=$ac_dir
     ac_install_sh="$ac_aux_dir/install-sh -c"
     break
-  elif test -f $ac_dir/install.sh; then
+  elif test -f "$ac_dir/install.sh"; then
     ac_aux_dir=$ac_dir
     ac_install_sh="$ac_aux_dir/install.sh -c"
     break
-  elif test -f $ac_dir/shtool; then
+  elif test -f "$ac_dir/shtool"; then
     ac_aux_dir=$ac_dir
     ac_install_sh="$ac_aux_dir/shtool install -c"
     break
   fi
 done
 if test -z "$ac_aux_dir"; then
-  { { echo "$as_me:$LINENO: error: cannot find install-sh or install.sh in $srcdir $srcdir/.. $srcdir/../.." >&5
-echo "$as_me: error: cannot find install-sh or install.sh in $srcdir $srcdir/.. $srcdir/../.." >&2;}
+  { { $as_echo "$as_me:$LINENO: error: cannot find install-sh or install.sh in \"$srcdir\" \"$srcdir/..\" \"$srcdir/../..\"" >&5
+$as_echo "$as_me: error: cannot find install-sh or install.sh in \"$srcdir\" \"$srcdir/..\" \"$srcdir/../..\"" >&2;}
    { (exit 1); exit 1; }; }
 fi
-ac_config_guess="$SHELL $ac_aux_dir/config.guess"
-ac_config_sub="$SHELL $ac_aux_dir/config.sub"
-ac_configure="$SHELL $ac_aux_dir/configure" # This should be Cygnus configure.
 
+# These three variables are undocumented and unsupported,
+# and are intended to be withdrawn in a future Autoconf release.
+# They can cause serious problems if a builder's source tree is in a directory
+# whose full name contains unusual characters.
+ac_config_guess="$SHELL $ac_aux_dir/config.guess"  # Please don't use this var.
+ac_config_sub="$SHELL $ac_aux_dir/config.sub"  # Please don't use this var.
+ac_configure="$SHELL $ac_aux_dir/configure"  # Please don't use this var.
+
+
 # Find a good install program.  We prefer a C program (faster),
 # so one script is as good as another.  But avoid the broken or
 # incompatible versions:
@@ -1324,12 +1880,14 @@
 # AIX 4 /usr/bin/installbsd, which doesn't work without a -g flag
 # AFS /usr/afsws/bin/install, which mishandles nonexistent args
 # SVR4 /usr/ucb/install, which tries to use the nonexistent group "staff"
+# OS/2's system install, which has a completely different semantic
 # ./install, which can be erroneously created by make from ./install.sh.
-echo "$as_me:$LINENO: checking for a BSD-compatible install" >&5
-echo $ECHO_N "checking for a BSD-compatible install... $ECHO_C" >&6
+# Reject install programs that cannot install multiple files.
+{ $as_echo "$as_me:$LINENO: checking for a BSD-compatible install" >&5
+$as_echo_n "checking for a BSD-compatible install... " >&6; }
 if test -z "$INSTALL"; then
 if test "${ac_cv_path_install+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
@@ -1340,6 +1898,7 @@
 case $as_dir/ in
   ./ | .// | /cC/* | \
   /etc/* | /usr/sbin/* | /usr/etc/* | /sbin/* | /usr/afsws/bin/* | \
+  ?:\\/os2\\/install\\/* | ?:\\/OS2\\/INSTALL\\/* | \
   /usr/ucb/* ) ;;
   *)
     # OSF1 and SCO ODT 3.0 have their own names for install.
@@ -1347,40 +1906,53 @@
     # by default.
     for ac_prog in ginstall scoinst install; do
       for ac_exec_ext in '' $ac_executable_extensions; do
-        if $as_executable_p "$as_dir/$ac_prog$ac_exec_ext"; then
-          if test $ac_prog = install &&
-            grep dspmsg "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
-            # AIX install.  It has an incompatible calling convention.
-            :
-          elif test $ac_prog = install &&
-            grep pwplus "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
-            # program-specific install script used by HP pwplus--don't use.
-            :
-          else
-            ac_cv_path_install="$as_dir/$ac_prog$ac_exec_ext -c"
-            break 3
-          fi
-        fi
+	if { test -f "$as_dir/$ac_prog$ac_exec_ext" && $as_test_x "$as_dir/$ac_prog$ac_exec_ext"; }; then
+	  if test $ac_prog = install &&
+	    grep dspmsg "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
+	    # AIX install.  It has an incompatible calling convention.
+	    :
+	  elif test $ac_prog = install &&
+	    grep pwplus "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
+	    # program-specific install script used by HP pwplus--don't use.
+	    :
+	  else
+	    rm -rf conftest.one conftest.two conftest.dir
+	    echo one > conftest.one
+	    echo two > conftest.two
+	    mkdir conftest.dir
+	    if "$as_dir/$ac_prog$ac_exec_ext" -c conftest.one conftest.two "`pwd`/conftest.dir" &&
+	      test -s conftest.one && test -s conftest.two &&
+	      test -s conftest.dir/conftest.one &&
+	      test -s conftest.dir/conftest.two
+	    then
+	      ac_cv_path_install="$as_dir/$ac_prog$ac_exec_ext -c"
+	      break 3
+	    fi
+	  fi
+	fi
       done
     done
     ;;
 esac
+
 done
+IFS=$as_save_IFS
 
+rm -rf conftest.one conftest.two conftest.dir
 
 fi
   if test "${ac_cv_path_install+set}" = set; then
     INSTALL=$ac_cv_path_install
   else
-    # As a last resort, use the slow shell script.  We don't cache a
-    # path for INSTALL within a source directory, because that will
+    # As a last resort, use the slow shell script.  Don't cache a
+    # value for INSTALL within a source directory, because that will
     # break other packages using the cache if that directory is
-    # removed, or if the path is relative.
+    # removed, or if the value is a relative name.
     INSTALL=$ac_install_sh
   fi
 fi
-echo "$as_me:$LINENO: result: $INSTALL" >&5
-echo "${ECHO_T}$INSTALL" >&6
+{ $as_echo "$as_me:$LINENO: result: $INSTALL" >&5
+$as_echo "$INSTALL" >&6; }
 
 # Use test -z because SunOS4 sh mishandles braces in ${var-val}.
 # It thinks the first close brace ends the variable substitution.
@@ -1390,8 +1962,8 @@
 
 test -z "$INSTALL_DATA" && INSTALL_DATA='${INSTALL} -m 644'
 
-echo "$as_me:$LINENO: checking whether build environment is sane" >&5
-echo $ECHO_N "checking whether build environment is sane... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking whether build environment is sane" >&5
+$as_echo_n "checking whether build environment is sane... " >&6; }
 # Just in case
 sleep 1
 echo timestamp > conftest.file
@@ -1414,9 +1986,9 @@
       # if, for instance, CONFIG_SHELL is bash and it inherits a
       # broken ls alias from the environment.  This has actually
       # happened.  Such a system could not be considered "sane".
-      { { echo "$as_me:$LINENO: error: ls -t appears to fail.  Make sure there is not a broken
+      { { $as_echo "$as_me:$LINENO: error: ls -t appears to fail.  Make sure there is not a broken
 alias in your environment" >&5
-echo "$as_me: error: ls -t appears to fail.  Make sure there is not a broken
+$as_echo "$as_me: error: ls -t appears to fail.  Make sure there is not a broken
 alias in your environment" >&2;}
    { (exit 1); exit 1; }; }
    fi
@@ -1427,26 +1999,23 @@
    # Ok.
    :
 else
-   { { echo "$as_me:$LINENO: error: newly created file is older than distributed files!
+   { { $as_echo "$as_me:$LINENO: error: newly created file is older than distributed files!
 Check your system clock" >&5
-echo "$as_me: error: newly created file is older than distributed files!
+$as_echo "$as_me: error: newly created file is older than distributed files!
 Check your system clock" >&2;}
    { (exit 1); exit 1; }; }
 fi
-echo "$as_me:$LINENO: result: yes" >&5
-echo "${ECHO_T}yes" >&6
+{ $as_echo "$as_me:$LINENO: result: yes" >&5
+$as_echo "yes" >&6; }
 test "$program_prefix" != NONE &&
-  program_transform_name="s,^,$program_prefix,;$program_transform_name"
+  program_transform_name="s&^&$program_prefix&;$program_transform_name"
 # Use a double $ so make ignores it.
 test "$program_suffix" != NONE &&
-  program_transform_name="s,\$,$program_suffix,;$program_transform_name"
-# Double any \ or $.  echo might interpret backslashes.
+  program_transform_name="s&\$&$program_suffix&;$program_transform_name"
+# Double any \ or $.
 # By default was `s,x,x', remove it if useless.
-cat <<\_ACEOF >conftest.sed
-s/[\\$]/&&/g;s/;s,x,x,$//
-_ACEOF
-program_transform_name=`echo $program_transform_name | sed -f conftest.sed`
-rm conftest.sed
+ac_script='s/[\\$]/&&/g;s/;s,x,x,$//'
+program_transform_name=`$as_echo "$program_transform_name" | sed "$ac_script"`
 
 
 # expand $ac_aux_dir to an absolute path
@@ -1458,18 +2027,18 @@
   am_missing_run="$MISSING --run "
 else
   am_missing_run=
-  { echo "$as_me:$LINENO: WARNING: \`missing' script is too old or missing" >&5
-echo "$as_me: WARNING: \`missing' script is too old or missing" >&2;}
+  { $as_echo "$as_me:$LINENO: WARNING: \`missing' script is too old or missing" >&5
+$as_echo "$as_me: WARNING: \`missing' script is too old or missing" >&2;}
 fi
 
 for ac_prog in gawk mawk nawk awk
 do
   # Extract the first word of "$ac_prog", so it can be a program name with args.
 set dummy $ac_prog; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
 if test "${ac_cv_prog_AWK+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   if test -n "$AWK"; then
   ac_cv_prog_AWK="$AWK" # Let the user override the test.
@@ -1480,54 +2049,58 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_AWK="$ac_prog"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
+    $as_echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 fi
 fi
 AWK=$ac_cv_prog_AWK
 if test -n "$AWK"; then
-  echo "$as_me:$LINENO: result: $AWK" >&5
-echo "${ECHO_T}$AWK" >&6
+  { $as_echo "$as_me:$LINENO: result: $AWK" >&5
+$as_echo "$AWK" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
+
   test -n "$AWK" && break
 done
 
-echo "$as_me:$LINENO: checking whether ${MAKE-make} sets \$(MAKE)" >&5
-echo $ECHO_N "checking whether ${MAKE-make} sets \$(MAKE)... $ECHO_C" >&6
-set dummy ${MAKE-make}; ac_make=`echo "$2" | sed 'y,./+-,__p_,'`
-if eval "test \"\${ac_cv_prog_make_${ac_make}_set+set}\" = set"; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking whether ${MAKE-make} sets \$(MAKE)" >&5
+$as_echo_n "checking whether ${MAKE-make} sets \$(MAKE)... " >&6; }
+set x ${MAKE-make}
+ac_make=`$as_echo "$2" | sed 's/+/p/g; s/[^a-zA-Z0-9_]/_/g'`
+if { as_var=ac_cv_prog_make_${ac_make}_set; eval "test \"\${$as_var+set}\" = set"; }; then
+  $as_echo_n "(cached) " >&6
 else
   cat >conftest.make <<\_ACEOF
+SHELL = /bin/sh
 all:
-	@echo 'ac_maketemp="$(MAKE)"'
+	@echo '@@@%%%=$(MAKE)=@@@%%%'
 _ACEOF
 # GNU make sometimes prints "make[1]: Entering...", which would confuse us.
-eval `${MAKE-make} -f conftest.make 2>/dev/null | grep temp=`
-if test -n "$ac_maketemp"; then
-  eval ac_cv_prog_make_${ac_make}_set=yes
-else
-  eval ac_cv_prog_make_${ac_make}_set=no
-fi
+case `${MAKE-make} -f conftest.make 2>/dev/null` in
+  *@@@%%%=?*=@@@%%%*)
+    eval ac_cv_prog_make_${ac_make}_set=yes;;
+  *)
+    eval ac_cv_prog_make_${ac_make}_set=no;;
+esac
 rm -f conftest.make
 fi
-if eval "test \"`echo '$ac_cv_prog_make_'${ac_make}_set`\" = yes"; then
-  echo "$as_me:$LINENO: result: yes" >&5
-echo "${ECHO_T}yes" >&6
+if eval test \$ac_cv_prog_make_${ac_make}_set = yes; then
+  { $as_echo "$as_me:$LINENO: result: yes" >&5
+$as_echo "yes" >&6; }
   SET_MAKE=
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
   SET_MAKE="MAKE=${MAKE-make}"
 fi
 
@@ -1543,8 +2116,8 @@
  # test to see if srcdir already configured
 if test "`cd $srcdir && pwd`" != "`pwd`" &&
    test -f $srcdir/config.status; then
-  { { echo "$as_me:$LINENO: error: source directory already configured; run \"make distclean\" there first" >&5
-echo "$as_me: error: source directory already configured; run \"make distclean\" there first" >&2;}
+  { { $as_echo "$as_me:$LINENO: error: source directory already configured; run \"make distclean\" there first" >&5
+$as_echo "$as_me: error: source directory already configured; run \"make distclean\" there first" >&2;}
    { (exit 1); exit 1; }; }
 fi
 
@@ -1601,10 +2174,10 @@
   if test -n "$ac_tool_prefix"; then
   # Extract the first word of "${ac_tool_prefix}strip", so it can be a program name with args.
 set dummy ${ac_tool_prefix}strip; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
 if test "${ac_cv_prog_STRIP+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   if test -n "$STRIP"; then
   ac_cv_prog_STRIP="$STRIP" # Let the user override the test.
@@ -1615,34 +2188,36 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_STRIP="${ac_tool_prefix}strip"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
+    $as_echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 fi
 fi
 STRIP=$ac_cv_prog_STRIP
 if test -n "$STRIP"; then
-  echo "$as_me:$LINENO: result: $STRIP" >&5
-echo "${ECHO_T}$STRIP" >&6
+  { $as_echo "$as_me:$LINENO: result: $STRIP" >&5
+$as_echo "$STRIP" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
+
 fi
 if test -z "$ac_cv_prog_STRIP"; then
   ac_ct_STRIP=$STRIP
   # Extract the first word of "strip", so it can be a program name with args.
 set dummy strip; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
 if test "${ac_cv_prog_ac_ct_STRIP+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   if test -n "$ac_ct_STRIP"; then
   ac_cv_prog_ac_ct_STRIP="$ac_ct_STRIP" # Let the user override the test.
@@ -1653,27 +2228,37 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_ac_ct_STRIP="strip"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
+    $as_echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
-  test -z "$ac_cv_prog_ac_ct_STRIP" && ac_cv_prog_ac_ct_STRIP=":"
 fi
 fi
 ac_ct_STRIP=$ac_cv_prog_ac_ct_STRIP
 if test -n "$ac_ct_STRIP"; then
-  echo "$as_me:$LINENO: result: $ac_ct_STRIP" >&5
-echo "${ECHO_T}$ac_ct_STRIP" >&6
+  { $as_echo "$as_me:$LINENO: result: $ac_ct_STRIP" >&5
+$as_echo "$ac_ct_STRIP" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
-  STRIP=$ac_ct_STRIP
+  if test "x$ac_ct_STRIP" = x; then
+    STRIP=":"
+  else
+    case $cross_compiling:$ac_tool_warned in
+yes:)
+{ $as_echo "$as_me:$LINENO: WARNING: using cross tools not prefixed with host triplet" >&5
+$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+ac_tool_warned=yes ;;
+esac
+    STRIP=$ac_ct_STRIP
+  fi
 else
   STRIP="$ac_cv_prog_STRIP"
 fi
@@ -1695,10 +2280,10 @@
 if test -n "$ac_tool_prefix"; then
   # Extract the first word of "${ac_tool_prefix}gcc", so it can be a program name with args.
 set dummy ${ac_tool_prefix}gcc; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
 if test "${ac_cv_prog_CC+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   if test -n "$CC"; then
   ac_cv_prog_CC="$CC" # Let the user override the test.
@@ -1709,34 +2294,36 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_CC="${ac_tool_prefix}gcc"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
+    $as_echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 fi
 fi
 CC=$ac_cv_prog_CC
 if test -n "$CC"; then
-  echo "$as_me:$LINENO: result: $CC" >&5
-echo "${ECHO_T}$CC" >&6
+  { $as_echo "$as_me:$LINENO: result: $CC" >&5
+$as_echo "$CC" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
+
 fi
 if test -z "$ac_cv_prog_CC"; then
   ac_ct_CC=$CC
   # Extract the first word of "gcc", so it can be a program name with args.
 set dummy gcc; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
 if test "${ac_cv_prog_ac_ct_CC+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   if test -n "$ac_ct_CC"; then
   ac_cv_prog_ac_ct_CC="$ac_ct_CC" # Let the user override the test.
@@ -1747,38 +2334,49 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_ac_ct_CC="gcc"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
+    $as_echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 fi
 fi
 ac_ct_CC=$ac_cv_prog_ac_ct_CC
 if test -n "$ac_ct_CC"; then
-  echo "$as_me:$LINENO: result: $ac_ct_CC" >&5
-echo "${ECHO_T}$ac_ct_CC" >&6
+  { $as_echo "$as_me:$LINENO: result: $ac_ct_CC" >&5
+$as_echo "$ac_ct_CC" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
-  CC=$ac_ct_CC
+  if test "x$ac_ct_CC" = x; then
+    CC=""
+  else
+    case $cross_compiling:$ac_tool_warned in
+yes:)
+{ $as_echo "$as_me:$LINENO: WARNING: using cross tools not prefixed with host triplet" >&5
+$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+ac_tool_warned=yes ;;
+esac
+    CC=$ac_ct_CC
+  fi
 else
   CC="$ac_cv_prog_CC"
 fi
 
 if test -z "$CC"; then
-  if test -n "$ac_tool_prefix"; then
-  # Extract the first word of "${ac_tool_prefix}cc", so it can be a program name with args.
+          if test -n "$ac_tool_prefix"; then
+    # Extract the first word of "${ac_tool_prefix}cc", so it can be a program name with args.
 set dummy ${ac_tool_prefix}cc; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
 if test "${ac_cv_prog_CC+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   if test -n "$CC"; then
   ac_cv_prog_CC="$CC" # Let the user override the test.
@@ -1789,76 +2387,36 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_CC="${ac_tool_prefix}cc"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
+    $as_echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 fi
 fi
 CC=$ac_cv_prog_CC
 if test -n "$CC"; then
-  echo "$as_me:$LINENO: result: $CC" >&5
-echo "${ECHO_T}$CC" >&6
+  { $as_echo "$as_me:$LINENO: result: $CC" >&5
+$as_echo "$CC" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
-fi
-if test -z "$ac_cv_prog_CC"; then
-  ac_ct_CC=$CC
-  # Extract the first word of "cc", so it can be a program name with args.
-set dummy cc; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
-if test "${ac_cv_prog_ac_ct_CC+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
-else
-  if test -n "$ac_ct_CC"; then
-  ac_cv_prog_ac_ct_CC="$ac_ct_CC" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-  for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
-    ac_cv_prog_ac_ct_CC="cc"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
+
   fi
-done
-done
-
 fi
-fi
-ac_ct_CC=$ac_cv_prog_ac_ct_CC
-if test -n "$ac_ct_CC"; then
-  echo "$as_me:$LINENO: result: $ac_ct_CC" >&5
-echo "${ECHO_T}$ac_ct_CC" >&6
-else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
-fi
-
-  CC=$ac_ct_CC
-else
-  CC="$ac_cv_prog_CC"
-fi
-
-fi
 if test -z "$CC"; then
   # Extract the first word of "cc", so it can be a program name with args.
 set dummy cc; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
 if test "${ac_cv_prog_CC+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   if test -n "$CC"; then
   ac_cv_prog_CC="$CC" # Let the user override the test.
@@ -1870,17 +2428,18 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
     if test "$as_dir/$ac_word$ac_exec_ext" = "/usr/ucb/cc"; then
        ac_prog_rejected=yes
        continue
      fi
     ac_cv_prog_CC="cc"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
+    $as_echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 if test $ac_prog_rejected = yes; then
   # We found a bogon in the path, so make sure we never use it.
@@ -1898,24 +2457,25 @@
 fi
 CC=$ac_cv_prog_CC
 if test -n "$CC"; then
-  echo "$as_me:$LINENO: result: $CC" >&5
-echo "${ECHO_T}$CC" >&6
+  { $as_echo "$as_me:$LINENO: result: $CC" >&5
+$as_echo "$CC" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
+
 fi
 if test -z "$CC"; then
   if test -n "$ac_tool_prefix"; then
-  for ac_prog in cl
+  for ac_prog in cl.exe
   do
     # Extract the first word of "$ac_tool_prefix$ac_prog", so it can be a program name with args.
 set dummy $ac_tool_prefix$ac_prog; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
 if test "${ac_cv_prog_CC+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   if test -n "$CC"; then
   ac_cv_prog_CC="$CC" # Let the user override the test.
@@ -1926,38 +2486,40 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_CC="$ac_tool_prefix$ac_prog"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
+    $as_echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 fi
 fi
 CC=$ac_cv_prog_CC
 if test -n "$CC"; then
-  echo "$as_me:$LINENO: result: $CC" >&5
-echo "${ECHO_T}$CC" >&6
+  { $as_echo "$as_me:$LINENO: result: $CC" >&5
+$as_echo "$CC" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
+
     test -n "$CC" && break
   done
 fi
 if test -z "$CC"; then
   ac_ct_CC=$CC
-  for ac_prog in cl
+  for ac_prog in cl.exe
 do
   # Extract the first word of "$ac_prog", so it can be a program name with args.
 set dummy $ac_prog; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
 if test "${ac_cv_prog_ac_ct_CC+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   if test -n "$ac_ct_CC"; then
   ac_cv_prog_ac_ct_CC="$ac_ct_CC" # Let the user override the test.
@@ -1968,62 +2530,93 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_ac_ct_CC="$ac_prog"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
+    $as_echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 fi
 fi
 ac_ct_CC=$ac_cv_prog_ac_ct_CC
 if test -n "$ac_ct_CC"; then
-  echo "$as_me:$LINENO: result: $ac_ct_CC" >&5
-echo "${ECHO_T}$ac_ct_CC" >&6
+  { $as_echo "$as_me:$LINENO: result: $ac_ct_CC" >&5
+$as_echo "$ac_ct_CC" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
+
   test -n "$ac_ct_CC" && break
 done
 
-  CC=$ac_ct_CC
+  if test "x$ac_ct_CC" = x; then
+    CC=""
+  else
+    case $cross_compiling:$ac_tool_warned in
+yes:)
+{ $as_echo "$as_me:$LINENO: WARNING: using cross tools not prefixed with host triplet" >&5
+$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+ac_tool_warned=yes ;;
+esac
+    CC=$ac_ct_CC
+  fi
 fi
 
 fi
 
 
-test -z "$CC" && { { echo "$as_me:$LINENO: error: no acceptable C compiler found in \$PATH
+test -z "$CC" && { { $as_echo "$as_me:$LINENO: error: in \`$ac_pwd':" >&5
+$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+{ { $as_echo "$as_me:$LINENO: error: no acceptable C compiler found in \$PATH
 See \`config.log' for more details." >&5
-echo "$as_me: error: no acceptable C compiler found in \$PATH
+$as_echo "$as_me: error: no acceptable C compiler found in \$PATH
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; }
+   { (exit 1); exit 1; }; }; }
 
 # Provide some information about the compiler.
-echo "$as_me:$LINENO:" \
-     "checking for C compiler version" >&5
-ac_compiler=`set X $ac_compile; echo $2`
-{ (eval echo "$as_me:$LINENO: \"$ac_compiler --version </dev/null >&5\"") >&5
-  (eval $ac_compiler --version </dev/null >&5) 2>&5
+$as_echo "$as_me:$LINENO: checking for C compiler version" >&5
+set X $ac_compile
+ac_compiler=$2
+{ (ac_try="$ac_compiler --version >&5"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compiler --version >&5") 2>&5
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }
-{ (eval echo "$as_me:$LINENO: \"$ac_compiler -v </dev/null >&5\"") >&5
-  (eval $ac_compiler -v </dev/null >&5) 2>&5
+{ (ac_try="$ac_compiler -v >&5"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compiler -v >&5") 2>&5
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }
-{ (eval echo "$as_me:$LINENO: \"$ac_compiler -V </dev/null >&5\"") >&5
-  (eval $ac_compiler -V </dev/null >&5) 2>&5
+{ (ac_try="$ac_compiler -V >&5"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compiler -V >&5") 2>&5
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }
 
 cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -2039,111 +2632,150 @@
 }
 _ACEOF
 ac_clean_files_save=$ac_clean_files
-ac_clean_files="$ac_clean_files a.out a.exe b.out"
+ac_clean_files="$ac_clean_files a.out a.out.dSYM a.exe b.out"
 # Try to create an executable without -o first, disregard a.out.
 # It will help us diagnose broken compilers, and finding out an intuition
 # of exeext.
-echo "$as_me:$LINENO: checking for C compiler default output" >&5
-echo $ECHO_N "checking for C compiler default output... $ECHO_C" >&6
-ac_link_default=`echo "$ac_link" | sed 's/ -o *conftest[^ ]*//'`
-if { (eval echo "$as_me:$LINENO: \"$ac_link_default\"") >&5
-  (eval $ac_link_default) 2>&5
+{ $as_echo "$as_me:$LINENO: checking for C compiler default output file name" >&5
+$as_echo_n "checking for C compiler default output file name... " >&6; }
+ac_link_default=`$as_echo "$ac_link" | sed 's/ -o *conftest[^ ]*//'`
+
+# The possible output files:
+ac_files="a.out conftest.exe conftest a.exe a_out.exe b.out conftest.*"
+
+ac_rmfiles=
+for ac_file in $ac_files
+do
+  case $ac_file in
+    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.dSYM | *.o | *.obj ) ;;
+    * ) ac_rmfiles="$ac_rmfiles $ac_file";;
+  esac
+done
+rm -f $ac_rmfiles
+
+if { (ac_try="$ac_link_default"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_link_default") 2>&5
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; then
-  # Find the output, starting from the most likely.  This scheme is
-# not robust to junk in `.', hence go to wildcards (a.*) only as a last
-# resort.
-
-# Be careful to initialize this variable, since it used to be cached.
-# Otherwise an old cache value of `no' led to `EXEEXT = no' in a Makefile.
-ac_cv_exeext=
-# b.out is created by i960 compilers.
-for ac_file in a_out.exe a.exe conftest.exe a.out conftest a.* conftest.* b.out
+  # Autoconf-2.13 could set the ac_cv_exeext variable to `no'.
+# So ignore a value of `no', otherwise this would lead to `EXEEXT = no'
+# in a Makefile.  We should not override ac_cv_exeext if it was cached,
+# so that the user can short-circuit this test for compilers unknown to
+# Autoconf.
+for ac_file in $ac_files ''
 do
   test -f "$ac_file" || continue
   case $ac_file in
-    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.o | *.obj )
-        ;;
-    conftest.$ac_ext )
-        # This is the source file.
-        ;;
+    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.dSYM | *.o | *.obj )
+	;;
     [ab].out )
-        # We found the default executable, but exeext='' is most
-        # certainly right.
-        break;;
+	# We found the default executable, but exeext='' is most
+	# certainly right.
+	break;;
     *.* )
-        ac_cv_exeext=`expr "$ac_file" : '[^.]*\(\..*\)'`
-        # FIXME: I believe we export ac_cv_exeext for Libtool,
-        # but it would be cool to find out if it's true.  Does anybody
-        # maintain Libtool? --akim.
-        export ac_cv_exeext
-        break;;
+        if test "${ac_cv_exeext+set}" = set && test "$ac_cv_exeext" != no;
+	then :; else
+	   ac_cv_exeext=`expr "$ac_file" : '[^.]*\(\..*\)'`
+	fi
+	# We set ac_cv_exeext here because the later test for it is not
+	# safe: cross compilers may not add the suffix if given an `-o'
+	# argument, so we may need to know it at that point already.
+	# Even if this section looks crufty: it has the advantage of
+	# actually working.
+	break;;
     * )
-        break;;
+	break;;
   esac
 done
+test "$ac_cv_exeext" = no && ac_cv_exeext=
+
 else
-  echo "$as_me: failed program was:" >&5
+  ac_file=''
+fi
+
+{ $as_echo "$as_me:$LINENO: result: $ac_file" >&5
+$as_echo "$ac_file" >&6; }
+if test -z "$ac_file"; then
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-{ { echo "$as_me:$LINENO: error: C compiler cannot create executables
+{ { $as_echo "$as_me:$LINENO: error: in \`$ac_pwd':" >&5
+$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+{ { $as_echo "$as_me:$LINENO: error: C compiler cannot create executables
 See \`config.log' for more details." >&5
-echo "$as_me: error: C compiler cannot create executables
+$as_echo "$as_me: error: C compiler cannot create executables
 See \`config.log' for more details." >&2;}
-   { (exit 77); exit 77; }; }
+   { (exit 77); exit 77; }; }; }
 fi
 
 ac_exeext=$ac_cv_exeext
-echo "$as_me:$LINENO: result: $ac_file" >&5
-echo "${ECHO_T}$ac_file" >&6
 
-# Check the compiler produces executables we can run.  If not, either
+# Check that the compiler produces executables we can run.  If not, either
 # the compiler is broken, or we cross compile.
-echo "$as_me:$LINENO: checking whether the C compiler works" >&5
-echo $ECHO_N "checking whether the C compiler works... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking whether the C compiler works" >&5
+$as_echo_n "checking whether the C compiler works... " >&6; }
 # FIXME: These cross compiler hacks should be removed for Autoconf 3.0
 # If not cross compiling, check that we can run a simple program.
 if test "$cross_compiling" != yes; then
   if { ac_try='./$ac_file'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
     cross_compiling=no
   else
     if test "$cross_compiling" = maybe; then
 	cross_compiling=yes
     else
-	{ { echo "$as_me:$LINENO: error: cannot run C compiled programs.
+	{ { $as_echo "$as_me:$LINENO: error: in \`$ac_pwd':" >&5
+$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+{ { $as_echo "$as_me:$LINENO: error: cannot run C compiled programs.
 If you meant to cross compile, use \`--host'.
 See \`config.log' for more details." >&5
-echo "$as_me: error: cannot run C compiled programs.
+$as_echo "$as_me: error: cannot run C compiled programs.
 If you meant to cross compile, use \`--host'.
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; }
+   { (exit 1); exit 1; }; }; }
     fi
   fi
 fi
-echo "$as_me:$LINENO: result: yes" >&5
-echo "${ECHO_T}yes" >&6
+{ $as_echo "$as_me:$LINENO: result: yes" >&5
+$as_echo "yes" >&6; }
 
-rm -f a.out a.exe conftest$ac_cv_exeext b.out
+rm -f -r a.out a.out.dSYM a.exe conftest$ac_cv_exeext b.out
 ac_clean_files=$ac_clean_files_save
-# Check the compiler produces executables we can run.  If not, either
+# Check that the compiler produces executables we can run.  If not, either
 # the compiler is broken, or we cross compile.
-echo "$as_me:$LINENO: checking whether we are cross compiling" >&5
-echo $ECHO_N "checking whether we are cross compiling... $ECHO_C" >&6
-echo "$as_me:$LINENO: result: $cross_compiling" >&5
-echo "${ECHO_T}$cross_compiling" >&6
+{ $as_echo "$as_me:$LINENO: checking whether we are cross compiling" >&5
+$as_echo_n "checking whether we are cross compiling... " >&6; }
+{ $as_echo "$as_me:$LINENO: result: $cross_compiling" >&5
+$as_echo "$cross_compiling" >&6; }
 
-echo "$as_me:$LINENO: checking for suffix of executables" >&5
-echo $ECHO_N "checking for suffix of executables... $ECHO_C" >&6
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+{ $as_echo "$as_me:$LINENO: checking for suffix of executables" >&5
+$as_echo_n "checking for suffix of executables... " >&6; }
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; then
   # If both `conftest.exe' and `conftest' are `present' (well, observable)
 # catch `conftest.exe'.  For instance with Cygwin, `ls conftest' will
@@ -2152,35 +2784,35 @@
 for ac_file in conftest.exe conftest conftest.*; do
   test -f "$ac_file" || continue
   case $ac_file in
-    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.o | *.obj ) ;;
+    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.dSYM | *.o | *.obj ) ;;
     *.* ) ac_cv_exeext=`expr "$ac_file" : '[^.]*\(\..*\)'`
-          export ac_cv_exeext
-          break;;
+	  break;;
     * ) break;;
   esac
 done
 else
-  { { echo "$as_me:$LINENO: error: cannot compute suffix of executables: cannot compile and link
+  { { $as_echo "$as_me:$LINENO: error: in \`$ac_pwd':" >&5
+$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+{ { $as_echo "$as_me:$LINENO: error: cannot compute suffix of executables: cannot compile and link
 See \`config.log' for more details." >&5
-echo "$as_me: error: cannot compute suffix of executables: cannot compile and link
+$as_echo "$as_me: error: cannot compute suffix of executables: cannot compile and link
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; }
+   { (exit 1); exit 1; }; }; }
 fi
 
 rm -f conftest$ac_cv_exeext
-echo "$as_me:$LINENO: result: $ac_cv_exeext" >&5
-echo "${ECHO_T}$ac_cv_exeext" >&6
+{ $as_echo "$as_me:$LINENO: result: $ac_cv_exeext" >&5
+$as_echo "$ac_cv_exeext" >&6; }
 
 rm -f conftest.$ac_ext
 EXEEXT=$ac_cv_exeext
 ac_exeext=$EXEEXT
-echo "$as_me:$LINENO: checking for suffix of object files" >&5
-echo $ECHO_N "checking for suffix of object files... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for suffix of object files" >&5
+$as_echo_n "checking for suffix of object files... " >&6; }
 if test "${ac_cv_objext+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -2196,42 +2828,50 @@
 }
 _ACEOF
 rm -f conftest.o conftest.obj
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>&5
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compile") 2>&5
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; then
-  for ac_file in `(ls conftest.o conftest.obj; ls conftest.*) 2>/dev/null`; do
+  for ac_file in conftest.o conftest.obj conftest.*; do
+  test -f "$ac_file" || continue;
   case $ac_file in
-    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg ) ;;
+    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.dSYM ) ;;
     *) ac_cv_objext=`expr "$ac_file" : '.*\.\(.*\)'`
        break;;
   esac
 done
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-{ { echo "$as_me:$LINENO: error: cannot compute suffix of object files: cannot compile
+{ { $as_echo "$as_me:$LINENO: error: in \`$ac_pwd':" >&5
+$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+{ { $as_echo "$as_me:$LINENO: error: cannot compute suffix of object files: cannot compile
 See \`config.log' for more details." >&5
-echo "$as_me: error: cannot compute suffix of object files: cannot compile
+$as_echo "$as_me: error: cannot compute suffix of object files: cannot compile
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; }
+   { (exit 1); exit 1; }; }; }
 fi
 
 rm -f conftest.$ac_cv_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_objext" >&5
-echo "${ECHO_T}$ac_cv_objext" >&6
+{ $as_echo "$as_me:$LINENO: result: $ac_cv_objext" >&5
+$as_echo "$ac_cv_objext" >&6; }
 OBJEXT=$ac_cv_objext
 ac_objext=$OBJEXT
-echo "$as_me:$LINENO: checking whether we are using the GNU C compiler" >&5
-echo $ECHO_N "checking whether we are using the GNU C compiler... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking whether we are using the GNU C compiler" >&5
+$as_echo_n "checking whether we are using the GNU C compiler... " >&6; }
 if test "${ac_cv_c_compiler_gnu+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -2250,41 +2890,54 @@
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>&5
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-         { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && {
+	 test -z "$ac_c_werror_flag" ||
+	 test ! -s conftest.err
+       } && test -s conftest.$ac_objext; then
   ac_compiler_gnu=yes
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_compiler_gnu=no
+	ac_compiler_gnu=no
 fi
-rm -f conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 ac_cv_c_compiler_gnu=$ac_compiler_gnu
 
 fi
-echo "$as_me:$LINENO: result: $ac_cv_c_compiler_gnu" >&5
-echo "${ECHO_T}$ac_cv_c_compiler_gnu" >&6
-GCC=`test $ac_compiler_gnu = yes && echo yes`
+{ $as_echo "$as_me:$LINENO: result: $ac_cv_c_compiler_gnu" >&5
+$as_echo "$ac_cv_c_compiler_gnu" >&6; }
+if test $ac_compiler_gnu = yes; then
+  GCC=yes
+else
+  GCC=
+fi
 ac_test_CFLAGS=${CFLAGS+set}
 ac_save_CFLAGS=$CFLAGS
-CFLAGS="-g"
-echo "$as_me:$LINENO: checking whether $CC accepts -g" >&5
-echo $ECHO_N "checking whether $CC accepts -g... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking whether $CC accepts -g" >&5
+$as_echo_n "checking whether $CC accepts -g... " >&6; }
 if test "${ac_cv_prog_cc_g+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
-  cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
+  ac_save_c_werror_flag=$ac_c_werror_flag
+   ac_c_werror_flag=yes
+   ac_cv_prog_cc_g=no
+   CFLAGS="-g"
+   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -2300,28 +2953,121 @@
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>&5
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-         { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && {
+	 test -z "$ac_c_werror_flag" ||
+	 test ! -s conftest.err
+       } && test -s conftest.$ac_objext; then
+  ac_cv_prog_cc_g=yes
+else
+  $as_echo "$as_me: failed program was:" >&5
+sed 's/^/| /' conftest.$ac_ext >&5
+
+	CFLAGS=""
+      cat >conftest.$ac_ext <<_ACEOF
+/* confdefs.h.  */
+_ACEOF
+cat confdefs.h >>conftest.$ac_ext
+cat >>conftest.$ac_ext <<_ACEOF
+/* end confdefs.h.  */
+
+int
+main ()
+{
+
+  ;
+  return 0;
+}
+_ACEOF
+rm -f conftest.$ac_objext
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && {
+	 test -z "$ac_c_werror_flag" ||
+	 test ! -s conftest.err
+       } && test -s conftest.$ac_objext; then
+  :
+else
+  $as_echo "$as_me: failed program was:" >&5
+sed 's/^/| /' conftest.$ac_ext >&5
+
+	ac_c_werror_flag=$ac_save_c_werror_flag
+	 CFLAGS="-g"
+	 cat >conftest.$ac_ext <<_ACEOF
+/* confdefs.h.  */
+_ACEOF
+cat confdefs.h >>conftest.$ac_ext
+cat >>conftest.$ac_ext <<_ACEOF
+/* end confdefs.h.  */
+
+int
+main ()
+{
+
+  ;
+  return 0;
+}
+_ACEOF
+rm -f conftest.$ac_objext
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compile") 2>conftest.er1
+  ac_status=$?
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && {
+	 test -z "$ac_c_werror_flag" ||
+	 test ! -s conftest.err
+       } && test -s conftest.$ac_objext; then
   ac_cv_prog_cc_g=yes
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_prog_cc_g=no
+
 fi
-rm -f conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: $ac_cv_prog_cc_g" >&5
-echo "${ECHO_T}$ac_cv_prog_cc_g" >&6
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+fi
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+   ac_c_werror_flag=$ac_save_c_werror_flag
+fi
+{ $as_echo "$as_me:$LINENO: result: $ac_cv_prog_cc_g" >&5
+$as_echo "$ac_cv_prog_cc_g" >&6; }
 if test "$ac_test_CFLAGS" = set; then
   CFLAGS=$ac_save_CFLAGS
 elif test $ac_cv_prog_cc_g = yes; then
@@ -2337,15 +3083,14 @@
     CFLAGS=
   fi
 fi
-echo "$as_me:$LINENO: checking for $CC option to accept ANSI C" >&5
-echo $ECHO_N "checking for $CC option to accept ANSI C... $ECHO_C" >&6
-if test "${ac_cv_prog_cc_stdc+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for $CC option to accept ISO C89" >&5
+$as_echo_n "checking for $CC option to accept ISO C89... " >&6; }
+if test "${ac_cv_prog_cc_c89+set}" = set; then
+  $as_echo_n "(cached) " >&6
 else
-  ac_cv_prog_cc_stdc=no
+  ac_cv_prog_cc_c89=no
 ac_save_CC=$CC
 cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -2373,6 +3118,21 @@
   va_end (v);
   return s;
 }
+
+/* OSF 4.0 Compaq cc is some sort of almost-ANSI by default.  It has
+   function prototypes and stuff, but not '\xHH' hex character constants.
+   These don't provoke an error unfortunately, instead are silently treated
+   as 'x'.  The following induces an error, until -std is added to get
+   proper ANSI mode.  Curiously '\x00'!='x' always comes out true, for an
+   array size at least.  It's necessary to write '\x00'==0 to get something
+   that's true only with -std.  */
+int osf4_cc_array ['\x00' == 0 ? 1 : -1];
+
+/* IBM C 6 for AIX is almost-ANSI by default, but it replaces macro parameters
+   inside strings and character constants.  */
+#define FOO(x) 'x'
+int xlc6_cc_array[FOO(a) == 'x' ? 1 : -1];
+
 int test (int i, double x);
 struct s1 {int (*f) (int a);};
 struct s2 {int (*f) (double a);};
@@ -2387,168 +3147,58 @@
   return 0;
 }
 _ACEOF
-# Don't try gcc -ansi; that turns off useful extensions and
-# breaks some systems' header files.
-# AIX			-qlanglvl=ansi
-# Ultrix and OSF/1	-std1
-# HP-UX 10.20 and later	-Ae
-# HP-UX older versions	-Aa -D_HPUX_SOURCE
-# SVR4			-Xc -D__EXTENSIONS__
-for ac_arg in "" -qlanglvl=ansi -std1 -Ae "-Aa -D_HPUX_SOURCE" "-Xc -D__EXTENSIONS__"
+for ac_arg in '' -qlanglvl=extc89 -qlanglvl=ansi -std \
+	-Ae "-Aa -D_HPUX_SOURCE" "-Xc -D__EXTENSIONS__"
 do
   CC="$ac_save_CC $ac_arg"
   rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>&5
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-         { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
-  ac_cv_prog_cc_stdc=$ac_arg
-break
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && {
+	 test -z "$ac_c_werror_flag" ||
+	 test ! -s conftest.err
+       } && test -s conftest.$ac_objext; then
+  ac_cv_prog_cc_c89=$ac_arg
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
+
 fi
-rm -f conftest.$ac_objext
+
+rm -f core conftest.err conftest.$ac_objext
+  test "x$ac_cv_prog_cc_c89" != "xno" && break
 done
-rm -f conftest.$ac_ext conftest.$ac_objext
+rm -f conftest.$ac_ext
 CC=$ac_save_CC
 
 fi
-
-case "x$ac_cv_prog_cc_stdc" in
-  x|xno)
-    echo "$as_me:$LINENO: result: none needed" >&5
-echo "${ECHO_T}none needed" >&6 ;;
+# AC_CACHE_VAL
+case "x$ac_cv_prog_cc_c89" in
+  x)
+    { $as_echo "$as_me:$LINENO: result: none needed" >&5
+$as_echo "none needed" >&6; } ;;
+  xno)
+    { $as_echo "$as_me:$LINENO: result: unsupported" >&5
+$as_echo "unsupported" >&6; } ;;
   *)
-    echo "$as_me:$LINENO: result: $ac_cv_prog_cc_stdc" >&5
-echo "${ECHO_T}$ac_cv_prog_cc_stdc" >&6
-    CC="$CC $ac_cv_prog_cc_stdc" ;;
+    CC="$CC $ac_cv_prog_cc_c89"
+    { $as_echo "$as_me:$LINENO: result: $ac_cv_prog_cc_c89" >&5
+$as_echo "$ac_cv_prog_cc_c89" >&6; } ;;
 esac
 
-# Some people use a C++ compiler to compile C.  Since we use `exit',
-# in C++ we need to declare it.  In case someone uses the same compiler
-# for both compiling C and C++ we need to have the C++ compiler decide
-# the declaration of exit, since it's the most demanding environment.
-cat >conftest.$ac_ext <<_ACEOF
-#ifndef __cplusplus
-  choke me
-#endif
-_ACEOF
-rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-         { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
-  for ac_declaration in \
-   ''\
-   '#include <stdlib.h>' \
-   'extern "C" void std::exit (int) throw (); using std::exit;' \
-   'extern "C" void std::exit (int); using std::exit;' \
-   'extern "C" void exit (int) throw ();' \
-   'extern "C" void exit (int);' \
-   'void exit (int);'
-do
-  cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
-/* confdefs.h.  */
-_ACEOF
-cat confdefs.h >>conftest.$ac_ext
-cat >>conftest.$ac_ext <<_ACEOF
-/* end confdefs.h.  */
-#include <stdlib.h>
-$ac_declaration
-int
-main ()
-{
-exit (42);
-  ;
-  return 0;
-}
-_ACEOF
-rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-         { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
-  :
-else
-  echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
 
-continue
-fi
-rm -f conftest.$ac_objext conftest.$ac_ext
-  cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
-/* confdefs.h.  */
-_ACEOF
-cat confdefs.h >>conftest.$ac_ext
-cat >>conftest.$ac_ext <<_ACEOF
-/* end confdefs.h.  */
-$ac_declaration
-int
-main ()
-{
-exit (42);
-  ;
-  return 0;
-}
-_ACEOF
-rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-         { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
-  break
-else
-  echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-fi
-rm -f conftest.$ac_objext conftest.$ac_ext
-done
-rm -f conftest*
-if test -n "$ac_declaration"; then
-  echo '#ifdef __cplusplus' >>confdefs.h
-  echo $ac_declaration      >>confdefs.h
-  echo '#endif'             >>confdefs.h
-fi
-
-else
-  echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-fi
-rm -f conftest.$ac_objext conftest.$ac_ext
 ac_ext=c
 ac_cpp='$CPP $CPPFLAGS'
 ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
@@ -2556,17 +3206,18 @@
 ac_compiler_gnu=$ac_cv_c_compiler_gnu
 DEPDIR="${am__leading_dot}deps"
 
-          ac_config_commands="$ac_config_commands depfiles"
+ac_config_commands="$ac_config_commands depfiles"
 
 
 am_make=${MAKE-make}
 cat > confinc << 'END'
-doit:
+am__doit:
 	@echo done
+.PHONY: am__doit
 END
 # If we don't find an include directive, just comment out the code.
-echo "$as_me:$LINENO: checking for style of include used by $am_make" >&5
-echo $ECHO_N "checking for style of include used by $am_make... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for style of include used by $am_make" >&5
+$as_echo_n "checking for style of include used by $am_make... " >&6; }
 am__include="#"
 am__quote=
 _am_result=none
@@ -2593,15 +3244,15 @@
 fi
 
 
-echo "$as_me:$LINENO: result: $_am_result" >&5
-echo "${ECHO_T}$_am_result" >&6
+{ $as_echo "$as_me:$LINENO: result: $_am_result" >&5
+$as_echo "$_am_result" >&6; }
 rm -f confinc confmf
 
-# Check whether --enable-dependency-tracking or --disable-dependency-tracking was given.
+# Check whether --enable-dependency-tracking was given.
 if test "${enable_dependency_tracking+set}" = set; then
-  enableval="$enable_dependency_tracking"
+  enableval=$enable_dependency_tracking;
+fi
 
-fi;
 if test "x$enable_dependency_tracking" != xno; then
   am_depcomp="$ac_aux_dir/depcomp"
   AMDEPBACKSLASH='\'
@@ -2621,10 +3272,10 @@
 
 depcc="$CC"   am_compiler_list=
 
-echo "$as_me:$LINENO: checking dependency style of $depcc" >&5
-echo $ECHO_N "checking dependency style of $depcc... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking dependency style of $depcc" >&5
+$as_echo_n "checking dependency style of $depcc... " >&6; }
 if test "${am_cv_CC_dependencies_compiler_type+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   if test -z "$AMDEP_TRUE" && test -f "$am_depcomp"; then
   # We make a subdir and do the tests there.  Otherwise we can end up
@@ -2637,18 +3288,32 @@
   # using a relative directory.
   cp "$am_depcomp" conftest.dir
   cd conftest.dir
+  # We will build objects and dependencies in a subdirectory because
+  # it helps to detect inapplicable dependency modes.  For instance
+  # both Tru64's cc and ICC support -MD to output dependencies as a
+  # side effect of compilation, but ICC will put the dependencies in
+  # the current directory while Tru64 will put them in the object
+  # directory.
+  mkdir sub
 
   am_cv_CC_dependencies_compiler_type=none
   if test "$am_compiler_list" = ""; then
      am_compiler_list=`sed -n 's/^#*\([a-zA-Z0-9]*\))$/\1/p' < ./depcomp`
   fi
   for depmode in $am_compiler_list; do
+    # Setup a source with many dependencies, because some compilers
+    # like to wrap large dependency lists on column 80 (with \), and
+    # we should not choose a depcomp mode which is confused by this.
+    #
     # We need to recreate these files for each test, as the compiler may
     # overwrite some of them when testing with obscure command lines.
     # This happens at least with the AIX C compiler.
-    echo '#include "conftest.h"' > conftest.c
-    echo 'int i;' > conftest.h
-    echo "${am__include} ${am__quote}conftest.Po${am__quote}" > confmf
+    : > sub/conftest.c
+    for i in 1 2 3 4 5 6; do
+      echo '#include "conftst'$i'.h"' >> sub/conftest.c
+      : > sub/conftst$i.h
+    done
+    echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
 
     case $depmode in
     nosideeffect)
@@ -2666,11 +3331,12 @@
     # mode.  It turns out that the SunPro C++ compiler does not properly
     # handle `-M -o', and we need to detect this.
     if depmode=$depmode \
-       source=conftest.c object=conftest.o \
-       depfile=conftest.Po tmpdepfile=conftest.TPo \
-       $SHELL ./depcomp $depcc -c -o conftest.o conftest.c \
+       source=sub/conftest.c object=sub/conftest.${OBJEXT-o} \
+       depfile=sub/conftest.Po tmpdepfile=sub/conftest.TPo \
+       $SHELL ./depcomp $depcc -c -o sub/conftest.${OBJEXT-o} sub/conftest.c \
          >/dev/null 2>conftest.err &&
-       grep conftest.h conftest.Po > /dev/null 2>&1 &&
+       grep sub/conftst6.h sub/conftest.Po > /dev/null 2>&1 &&
+       grep sub/conftest.${OBJEXT-o} sub/conftest.Po > /dev/null 2>&1 &&
        ${MAKE-make} -s -f confmf > /dev/null 2>&1; then
       # icc doesn't choke on unknown options, it will just issue warnings
       # (even with -Werror).  So we grep stderr for any message
@@ -2689,8 +3355,8 @@
 fi
 
 fi
-echo "$as_me:$LINENO: result: $am_cv_CC_dependencies_compiler_type" >&5
-echo "${ECHO_T}$am_cv_CC_dependencies_compiler_type" >&6
+{ $as_echo "$as_me:$LINENO: result: $am_cv_CC_dependencies_compiler_type" >&5
+$as_echo "$am_cv_CC_dependencies_compiler_type" >&6; }
 CCDEPMODE=depmode=$am_cv_CC_dependencies_compiler_type
 
 
@@ -2706,20 +3372,24 @@
 fi
 
 
-ac_ext=cc
+ac_ext=cpp
 ac_cpp='$CXXCPP $CPPFLAGS'
 ac_compile='$CXX -c $CXXFLAGS $CPPFLAGS conftest.$ac_ext >&5'
 ac_link='$CXX -o conftest$ac_exeext $CXXFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
 ac_compiler_gnu=$ac_cv_cxx_compiler_gnu
-if test -n "$ac_tool_prefix"; then
-  for ac_prog in $CCC g++ c++ gpp aCC CC cxx cc++ cl FCC KCC RCC xlC_r xlC
+if test -z "$CXX"; then
+  if test -n "$CCC"; then
+    CXX=$CCC
+  else
+    if test -n "$ac_tool_prefix"; then
+  for ac_prog in g++ c++ gpp aCC CC cxx cc++ cl.exe FCC KCC RCC xlC_r xlC
   do
     # Extract the first word of "$ac_tool_prefix$ac_prog", so it can be a program name with args.
 set dummy $ac_tool_prefix$ac_prog; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
 if test "${ac_cv_prog_CXX+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   if test -n "$CXX"; then
   ac_cv_prog_CXX="$CXX" # Let the user override the test.
@@ -2730,38 +3400,40 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_CXX="$ac_tool_prefix$ac_prog"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
+    $as_echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 fi
 fi
 CXX=$ac_cv_prog_CXX
 if test -n "$CXX"; then
-  echo "$as_me:$LINENO: result: $CXX" >&5
-echo "${ECHO_T}$CXX" >&6
+  { $as_echo "$as_me:$LINENO: result: $CXX" >&5
+$as_echo "$CXX" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
+
     test -n "$CXX" && break
   done
 fi
 if test -z "$CXX"; then
   ac_ct_CXX=$CXX
-  for ac_prog in $CCC g++ c++ gpp aCC CC cxx cc++ cl FCC KCC RCC xlC_r xlC
+  for ac_prog in g++ c++ gpp aCC CC cxx cc++ cl.exe FCC KCC RCC xlC_r xlC
 do
   # Extract the first word of "$ac_prog", so it can be a program name with args.
 set dummy $ac_prog; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
 if test "${ac_cv_prog_ac_ct_CXX+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   if test -n "$ac_ct_CXX"; then
   ac_cv_prog_ac_ct_CXX="$ac_ct_CXX" # Let the user override the test.
@@ -2772,60 +3444,89 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_ac_ct_CXX="$ac_prog"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
+    $as_echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 fi
 fi
 ac_ct_CXX=$ac_cv_prog_ac_ct_CXX
 if test -n "$ac_ct_CXX"; then
-  echo "$as_me:$LINENO: result: $ac_ct_CXX" >&5
-echo "${ECHO_T}$ac_ct_CXX" >&6
+  { $as_echo "$as_me:$LINENO: result: $ac_ct_CXX" >&5
+$as_echo "$ac_ct_CXX" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
+
   test -n "$ac_ct_CXX" && break
 done
-test -n "$ac_ct_CXX" || ac_ct_CXX="g++"
 
-  CXX=$ac_ct_CXX
+  if test "x$ac_ct_CXX" = x; then
+    CXX="g++"
+  else
+    case $cross_compiling:$ac_tool_warned in
+yes:)
+{ $as_echo "$as_me:$LINENO: WARNING: using cross tools not prefixed with host triplet" >&5
+$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+ac_tool_warned=yes ;;
+esac
+    CXX=$ac_ct_CXX
+  fi
 fi
 
-
+  fi
+fi
 # Provide some information about the compiler.
-echo "$as_me:$LINENO:" \
-     "checking for C++ compiler version" >&5
-ac_compiler=`set X $ac_compile; echo $2`
-{ (eval echo "$as_me:$LINENO: \"$ac_compiler --version </dev/null >&5\"") >&5
-  (eval $ac_compiler --version </dev/null >&5) 2>&5
+$as_echo "$as_me:$LINENO: checking for C++ compiler version" >&5
+set X $ac_compile
+ac_compiler=$2
+{ (ac_try="$ac_compiler --version >&5"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compiler --version >&5") 2>&5
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }
-{ (eval echo "$as_me:$LINENO: \"$ac_compiler -v </dev/null >&5\"") >&5
-  (eval $ac_compiler -v </dev/null >&5) 2>&5
+{ (ac_try="$ac_compiler -v >&5"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compiler -v >&5") 2>&5
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }
-{ (eval echo "$as_me:$LINENO: \"$ac_compiler -V </dev/null >&5\"") >&5
-  (eval $ac_compiler -V </dev/null >&5) 2>&5
+{ (ac_try="$ac_compiler -V >&5"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compiler -V >&5") 2>&5
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }
 
-echo "$as_me:$LINENO: checking whether we are using the GNU C++ compiler" >&5
-echo $ECHO_N "checking whether we are using the GNU C++ compiler... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking whether we are using the GNU C++ compiler" >&5
+$as_echo_n "checking whether we are using the GNU C++ compiler... " >&6; }
 if test "${ac_cv_cxx_compiler_gnu+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -2844,41 +3545,54 @@
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>&5
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-         { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && {
+	 test -z "$ac_cxx_werror_flag" ||
+	 test ! -s conftest.err
+       } && test -s conftest.$ac_objext; then
   ac_compiler_gnu=yes
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_compiler_gnu=no
+	ac_compiler_gnu=no
 fi
-rm -f conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 ac_cv_cxx_compiler_gnu=$ac_compiler_gnu
 
 fi
-echo "$as_me:$LINENO: result: $ac_cv_cxx_compiler_gnu" >&5
-echo "${ECHO_T}$ac_cv_cxx_compiler_gnu" >&6
-GXX=`test $ac_compiler_gnu = yes && echo yes`
+{ $as_echo "$as_me:$LINENO: result: $ac_cv_cxx_compiler_gnu" >&5
+$as_echo "$ac_cv_cxx_compiler_gnu" >&6; }
+if test $ac_compiler_gnu = yes; then
+  GXX=yes
+else
+  GXX=
+fi
 ac_test_CXXFLAGS=${CXXFLAGS+set}
 ac_save_CXXFLAGS=$CXXFLAGS
-CXXFLAGS="-g"
-echo "$as_me:$LINENO: checking whether $CXX accepts -g" >&5
-echo $ECHO_N "checking whether $CXX accepts -g... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking whether $CXX accepts -g" >&5
+$as_echo_n "checking whether $CXX accepts -g... " >&6; }
 if test "${ac_cv_prog_cxx_g+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
-  cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
+  ac_save_cxx_werror_flag=$ac_cxx_werror_flag
+   ac_cxx_werror_flag=yes
+   ac_cv_prog_cxx_g=no
+   CXXFLAGS="-g"
+   cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -2894,132 +3608,136 @@
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>&5
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-         { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && {
+	 test -z "$ac_cxx_werror_flag" ||
+	 test ! -s conftest.err
+       } && test -s conftest.$ac_objext; then
   ac_cv_prog_cxx_g=yes
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_prog_cxx_g=no
-fi
-rm -f conftest.$ac_objext conftest.$ac_ext
-fi
-echo "$as_me:$LINENO: result: $ac_cv_prog_cxx_g" >&5
-echo "${ECHO_T}$ac_cv_prog_cxx_g" >&6
-if test "$ac_test_CXXFLAGS" = set; then
-  CXXFLAGS=$ac_save_CXXFLAGS
-elif test $ac_cv_prog_cxx_g = yes; then
-  if test "$GXX" = yes; then
-    CXXFLAGS="-g -O2"
-  else
-    CXXFLAGS="-g"
-  fi
-else
-  if test "$GXX" = yes; then
-    CXXFLAGS="-O2"
-  else
-    CXXFLAGS=
-  fi
-fi
-for ac_declaration in \
-   ''\
-   '#include <stdlib.h>' \
-   'extern "C" void std::exit (int) throw (); using std::exit;' \
-   'extern "C" void std::exit (int); using std::exit;' \
-   'extern "C" void exit (int) throw ();' \
-   'extern "C" void exit (int);' \
-   'void exit (int);'
-do
-  cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
+	CXXFLAGS=""
+      cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
-#include <stdlib.h>
-$ac_declaration
+
 int
 main ()
 {
-exit (42);
+
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>&5
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-         { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && {
+	 test -z "$ac_cxx_werror_flag" ||
+	 test ! -s conftest.err
+       } && test -s conftest.$ac_objext; then
   :
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-continue
-fi
-rm -f conftest.$ac_objext conftest.$ac_ext
-  cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
+	ac_cxx_werror_flag=$ac_save_cxx_werror_flag
+	 CXXFLAGS="-g"
+	 cat >conftest.$ac_ext <<_ACEOF
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
-$ac_declaration
+
 int
 main ()
 {
-exit (42);
+
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>&5
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-         { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
-  break
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && {
+	 test -z "$ac_cxx_werror_flag" ||
+	 test ! -s conftest.err
+       } && test -s conftest.$ac_objext; then
+  ac_cv_prog_cxx_g=yes
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
+
 fi
-rm -f conftest.$ac_objext conftest.$ac_ext
-done
-rm -f conftest*
-if test -n "$ac_declaration"; then
-  echo '#ifdef __cplusplus' >>confdefs.h
-  echo $ac_declaration      >>confdefs.h
-  echo '#endif'             >>confdefs.h
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
 
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+fi
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+   ac_cxx_werror_flag=$ac_save_cxx_werror_flag
+fi
+{ $as_echo "$as_me:$LINENO: result: $ac_cv_prog_cxx_g" >&5
+$as_echo "$ac_cv_prog_cxx_g" >&6; }
+if test "$ac_test_CXXFLAGS" = set; then
+  CXXFLAGS=$ac_save_CXXFLAGS
+elif test $ac_cv_prog_cxx_g = yes; then
+  if test "$GXX" = yes; then
+    CXXFLAGS="-g -O2"
+  else
+    CXXFLAGS="-g"
+  fi
+else
+  if test "$GXX" = yes; then
+    CXXFLAGS="-O2"
+  else
+    CXXFLAGS=
+  fi
+fi
 ac_ext=c
 ac_cpp='$CPP $CPPFLAGS'
 ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
@@ -3028,10 +3746,10 @@
 
 depcc="$CXX"  am_compiler_list=
 
-echo "$as_me:$LINENO: checking dependency style of $depcc" >&5
-echo $ECHO_N "checking dependency style of $depcc... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking dependency style of $depcc" >&5
+$as_echo_n "checking dependency style of $depcc... " >&6; }
 if test "${am_cv_CXX_dependencies_compiler_type+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   if test -z "$AMDEP_TRUE" && test -f "$am_depcomp"; then
   # We make a subdir and do the tests there.  Otherwise we can end up
@@ -3044,18 +3762,32 @@
   # using a relative directory.
   cp "$am_depcomp" conftest.dir
   cd conftest.dir
+  # We will build objects and dependencies in a subdirectory because
+  # it helps to detect inapplicable dependency modes.  For instance
+  # both Tru64's cc and ICC support -MD to output dependencies as a
+  # side effect of compilation, but ICC will put the dependencies in
+  # the current directory while Tru64 will put them in the object
+  # directory.
+  mkdir sub
 
   am_cv_CXX_dependencies_compiler_type=none
   if test "$am_compiler_list" = ""; then
      am_compiler_list=`sed -n 's/^#*\([a-zA-Z0-9]*\))$/\1/p' < ./depcomp`
   fi
   for depmode in $am_compiler_list; do
+    # Setup a source with many dependencies, because some compilers
+    # like to wrap large dependency lists on column 80 (with \), and
+    # we should not choose a depcomp mode which is confused by this.
+    #
     # We need to recreate these files for each test, as the compiler may
     # overwrite some of them when testing with obscure command lines.
     # This happens at least with the AIX C compiler.
-    echo '#include "conftest.h"' > conftest.c
-    echo 'int i;' > conftest.h
-    echo "${am__include} ${am__quote}conftest.Po${am__quote}" > confmf
+    : > sub/conftest.c
+    for i in 1 2 3 4 5 6; do
+      echo '#include "conftst'$i'.h"' >> sub/conftest.c
+      : > sub/conftst$i.h
+    done
+    echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
 
     case $depmode in
     nosideeffect)
@@ -3073,11 +3805,12 @@
     # mode.  It turns out that the SunPro C++ compiler does not properly
     # handle `-M -o', and we need to detect this.
     if depmode=$depmode \
-       source=conftest.c object=conftest.o \
-       depfile=conftest.Po tmpdepfile=conftest.TPo \
-       $SHELL ./depcomp $depcc -c -o conftest.o conftest.c \
+       source=sub/conftest.c object=sub/conftest.${OBJEXT-o} \
+       depfile=sub/conftest.Po tmpdepfile=sub/conftest.TPo \
+       $SHELL ./depcomp $depcc -c -o sub/conftest.${OBJEXT-o} sub/conftest.c \
          >/dev/null 2>conftest.err &&
-       grep conftest.h conftest.Po > /dev/null 2>&1 &&
+       grep sub/conftst6.h sub/conftest.Po > /dev/null 2>&1 &&
+       grep sub/conftest.${OBJEXT-o} sub/conftest.Po > /dev/null 2>&1 &&
        ${MAKE-make} -s -f confmf > /dev/null 2>&1; then
       # icc doesn't choke on unknown options, it will just issue warnings
       # (even with -Werror).  So we grep stderr for any message
@@ -3096,8 +3829,8 @@
 fi
 
 fi
-echo "$as_me:$LINENO: result: $am_cv_CXX_dependencies_compiler_type" >&5
-echo "${ECHO_T}$am_cv_CXX_dependencies_compiler_type" >&6
+{ $as_echo "$as_me:$LINENO: result: $am_cv_CXX_dependencies_compiler_type" >&5
+$as_echo "$am_cv_CXX_dependencies_compiler_type" >&6; }
 CXXDEPMODE=depmode=$am_cv_CXX_dependencies_compiler_type
 
 
@@ -3124,12 +3857,14 @@
 # AIX 4 /usr/bin/installbsd, which doesn't work without a -g flag
 # AFS /usr/afsws/bin/install, which mishandles nonexistent args
 # SVR4 /usr/ucb/install, which tries to use the nonexistent group "staff"
+# OS/2's system install, which has a completely different semantic
 # ./install, which can be erroneously created by make from ./install.sh.
-echo "$as_me:$LINENO: checking for a BSD-compatible install" >&5
-echo $ECHO_N "checking for a BSD-compatible install... $ECHO_C" >&6
+# Reject install programs that cannot install multiple files.
+{ $as_echo "$as_me:$LINENO: checking for a BSD-compatible install" >&5
+$as_echo_n "checking for a BSD-compatible install... " >&6; }
 if test -z "$INSTALL"; then
 if test "${ac_cv_path_install+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
@@ -3140,6 +3875,7 @@
 case $as_dir/ in
   ./ | .// | /cC/* | \
   /etc/* | /usr/sbin/* | /usr/etc/* | /sbin/* | /usr/afsws/bin/* | \
+  ?:\\/os2\\/install\\/* | ?:\\/OS2\\/INSTALL\\/* | \
   /usr/ucb/* ) ;;
   *)
     # OSF1 and SCO ODT 3.0 have their own names for install.
@@ -3147,40 +3883,53 @@
     # by default.
     for ac_prog in ginstall scoinst install; do
       for ac_exec_ext in '' $ac_executable_extensions; do
-        if $as_executable_p "$as_dir/$ac_prog$ac_exec_ext"; then
-          if test $ac_prog = install &&
-            grep dspmsg "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
-            # AIX install.  It has an incompatible calling convention.
-            :
-          elif test $ac_prog = install &&
-            grep pwplus "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
-            # program-specific install script used by HP pwplus--don't use.
-            :
-          else
-            ac_cv_path_install="$as_dir/$ac_prog$ac_exec_ext -c"
-            break 3
-          fi
-        fi
+	if { test -f "$as_dir/$ac_prog$ac_exec_ext" && $as_test_x "$as_dir/$ac_prog$ac_exec_ext"; }; then
+	  if test $ac_prog = install &&
+	    grep dspmsg "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
+	    # AIX install.  It has an incompatible calling convention.
+	    :
+	  elif test $ac_prog = install &&
+	    grep pwplus "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
+	    # program-specific install script used by HP pwplus--don't use.
+	    :
+	  else
+	    rm -rf conftest.one conftest.two conftest.dir
+	    echo one > conftest.one
+	    echo two > conftest.two
+	    mkdir conftest.dir
+	    if "$as_dir/$ac_prog$ac_exec_ext" -c conftest.one conftest.two "`pwd`/conftest.dir" &&
+	      test -s conftest.one && test -s conftest.two &&
+	      test -s conftest.dir/conftest.one &&
+	      test -s conftest.dir/conftest.two
+	    then
+	      ac_cv_path_install="$as_dir/$ac_prog$ac_exec_ext -c"
+	      break 3
+	    fi
+	  fi
+	fi
       done
     done
     ;;
 esac
+
 done
+IFS=$as_save_IFS
 
+rm -rf conftest.one conftest.two conftest.dir
 
 fi
   if test "${ac_cv_path_install+set}" = set; then
     INSTALL=$ac_cv_path_install
   else
-    # As a last resort, use the slow shell script.  We don't cache a
-    # path for INSTALL within a source directory, because that will
+    # As a last resort, use the slow shell script.  Don't cache a
+    # value for INSTALL within a source directory, because that will
     # break other packages using the cache if that directory is
-    # removed, or if the path is relative.
+    # removed, or if the value is a relative name.
     INSTALL=$ac_install_sh
   fi
 fi
-echo "$as_me:$LINENO: result: $INSTALL" >&5
-echo "${ECHO_T}$INSTALL" >&6
+{ $as_echo "$as_me:$LINENO: result: $INSTALL" >&5
+$as_echo "$INSTALL" >&6; }
 
 # Use test -z because SunOS4 sh mishandles braces in ${var-val}.
 # It thinks the first close brace ends the variable substitution.
@@ -3193,10 +3942,10 @@
 if test -n "$ac_tool_prefix"; then
   # Extract the first word of "${ac_tool_prefix}ranlib", so it can be a program name with args.
 set dummy ${ac_tool_prefix}ranlib; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
 if test "${ac_cv_prog_RANLIB+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   if test -n "$RANLIB"; then
   ac_cv_prog_RANLIB="$RANLIB" # Let the user override the test.
@@ -3207,34 +3956,36 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_RANLIB="${ac_tool_prefix}ranlib"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
+    $as_echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
 fi
 fi
 RANLIB=$ac_cv_prog_RANLIB
 if test -n "$RANLIB"; then
-  echo "$as_me:$LINENO: result: $RANLIB" >&5
-echo "${ECHO_T}$RANLIB" >&6
+  { $as_echo "$as_me:$LINENO: result: $RANLIB" >&5
+$as_echo "$RANLIB" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
+
 fi
 if test -z "$ac_cv_prog_RANLIB"; then
   ac_ct_RANLIB=$RANLIB
   # Extract the first word of "ranlib", so it can be a program name with args.
 set dummy ranlib; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
 if test "${ac_cv_prog_ac_ct_RANLIB+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   if test -n "$ac_ct_RANLIB"; then
   ac_cv_prog_ac_ct_RANLIB="$ac_ct_RANLIB" # Let the user override the test.
@@ -3245,32 +3996,42 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_prog_ac_ct_RANLIB="ranlib"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
+    $as_echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
-  test -z "$ac_cv_prog_ac_ct_RANLIB" && ac_cv_prog_ac_ct_RANLIB=":"
 fi
 fi
 ac_ct_RANLIB=$ac_cv_prog_ac_ct_RANLIB
 if test -n "$ac_ct_RANLIB"; then
-  echo "$as_me:$LINENO: result: $ac_ct_RANLIB" >&5
-echo "${ECHO_T}$ac_ct_RANLIB" >&6
+  { $as_echo "$as_me:$LINENO: result: $ac_ct_RANLIB" >&5
+$as_echo "$ac_ct_RANLIB" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
-  RANLIB=$ac_ct_RANLIB
+  if test "x$ac_ct_RANLIB" = x; then
+    RANLIB=":"
+  else
+    case $cross_compiling:$ac_tool_warned in
+yes:)
+{ $as_echo "$as_me:$LINENO: WARNING: using cross tools not prefixed with host triplet" >&5
+$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+ac_tool_warned=yes ;;
+esac
+    RANLIB=$ac_ct_RANLIB
+  fi
 else
   RANLIB="$ac_cv_prog_RANLIB"
 fi
 
-ac_ext=cc
+ac_ext=cpp
 ac_cpp='$CXXCPP $CPPFLAGS'
 ac_compile='$CXX -c $CXXFLAGS $CPPFLAGS conftest.$ac_ext >&5'
 ac_link='$CXX -o conftest$ac_exeext $CXXFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
@@ -3279,15 +4040,14 @@
 
 
 
-echo "$as_me:$LINENO: checking for main in -lqthreads" >&5
-echo $ECHO_N "checking for main in -lqthreads... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for main in -lqthreads" >&5
+$as_echo_n "checking for main in -lqthreads... " >&6; }
 if test "${ac_cv_lib_qthreads_main+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
 LIBS="-lqthreads  $LIBS"
 cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -3298,36 +4058,48 @@
 int
 main ()
 {
-main ();
+return main ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-         { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && {
+	 test -z "$ac_cxx_werror_flag" ||
+	 test ! -s conftest.err
+       } && test -s conftest$ac_exeext && {
+	 test "$cross_compiling" = yes ||
+	 $as_test_x conftest$ac_exeext
+       }; then
   ac_cv_lib_qthreads_main=yes
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_lib_qthreads_main=no
+	ac_cv_lib_qthreads_main=no
 fi
-rm -f conftest.$ac_objext conftest$ac_exeext conftest.$ac_ext
+
+rm -rf conftest.dSYM
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
+      conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-echo "$as_me:$LINENO: result: $ac_cv_lib_qthreads_main" >&5
-echo "${ECHO_T}$ac_cv_lib_qthreads_main" >&6
-if test $ac_cv_lib_qthreads_main = yes; then
+{ $as_echo "$as_me:$LINENO: result: $ac_cv_lib_qthreads_main" >&5
+$as_echo "$ac_cv_lib_qthreads_main" >&6; }
+if test "x$ac_cv_lib_qthreads_main" = x""yes; then
   cat >>confdefs.h <<_ACEOF
 #define HAVE_LIBQTHREADS 1
 _ACEOF
@@ -3337,61 +4109,72 @@
 fi
 
 
-echo "$as_me:$LINENO: checking for scm_boot_guile in -lguile" >&5
-echo $ECHO_N "checking for scm_boot_guile in -lguile... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for scm_boot_guile in -lguile" >&5
+$as_echo_n "checking for scm_boot_guile in -lguile... " >&6; }
 if test "${ac_cv_lib_guile_scm_boot_guile+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
 LIBS="-lguile  $LIBS"
 cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 
-/* Override any gcc2 internal prototype to avoid an error.  */
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
 extern "C"
 #endif
-/* We use char because int might match the return type of a gcc2
-   builtin and then its argument prototype would still apply.  */
 char scm_boot_guile ();
 int
 main ()
 {
-scm_boot_guile ();
+return scm_boot_guile ();
   ;
   return 0;
 }
 _ACEOF
 rm -f conftest.$ac_objext conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_link") 2>conftest.er1
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-         { ac_try='test -s conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && {
+	 test -z "$ac_cxx_werror_flag" ||
+	 test ! -s conftest.err
+       } && test -s conftest$ac_exeext && {
+	 test "$cross_compiling" = yes ||
+	 $as_test_x conftest$ac_exeext
+       }; then
   ac_cv_lib_guile_scm_boot_guile=yes
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_lib_guile_scm_boot_guile=no
+	ac_cv_lib_guile_scm_boot_guile=no
 fi
-rm -f conftest.$ac_objext conftest$ac_exeext conftest.$ac_ext
+
+rm -rf conftest.dSYM
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
+      conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-echo "$as_me:$LINENO: result: $ac_cv_lib_guile_scm_boot_guile" >&5
-echo "${ECHO_T}$ac_cv_lib_guile_scm_boot_guile" >&6
-if test $ac_cv_lib_guile_scm_boot_guile = yes; then
+{ $as_echo "$as_me:$LINENO: result: $ac_cv_lib_guile_scm_boot_guile" >&5
+$as_echo "$ac_cv_lib_guile_scm_boot_guile" >&6; }
+if test "x$ac_cv_lib_guile_scm_boot_guile" = x""yes; then
   cat >>confdefs.h <<_ACEOF
 #define HAVE_LIBGUILE 1
 _ACEOF
@@ -3400,16 +4183,16 @@
 
 fi
 
-ac_ext=cc
+ac_ext=cpp
 ac_cpp='$CXXCPP $CPPFLAGS'
 ac_compile='$CXX -c $CXXFLAGS $CPPFLAGS conftest.$ac_ext >&5'
 ac_link='$CXX -o conftest$ac_exeext $CXXFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
 ac_compiler_gnu=$ac_cv_cxx_compiler_gnu
-echo "$as_me:$LINENO: checking how to run the C++ preprocessor" >&5
-echo $ECHO_N "checking how to run the C++ preprocessor... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking how to run the C++ preprocessor" >&5
+$as_echo_n "checking how to run the C++ preprocessor... " >&6; }
 if test -z "$CXXCPP"; then
   if test "${ac_cv_prog_CXXCPP+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
       # Double quotes because CXXCPP needs to be expanded
     for CXXCPP in "$CXX -E" "/lib/cpp"
@@ -3424,7 +4207,6 @@
   # On the NeXT, cc -E runs the code through the compiler's parser,
   # not just through cpp. "Syntax error" is here to catch this case.
   cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -3435,39 +4217,39 @@
 #else
 # include <assert.h>
 #endif
-                     Syntax error
+		     Syntax error
 _ACEOF
-if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
+if { (ac_try="$ac_cpp conftest.$ac_ext"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } >/dev/null; then
-  if test -s conftest.err; then
-    ac_cpp_err=$ac_cxx_preproc_warn_flag
-  else
-    ac_cpp_err=
-  fi
-else
-  ac_cpp_err=yes
-fi
-if test -z "$ac_cpp_err"; then
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } >/dev/null && {
+	 test -z "$ac_cxx_preproc_warn_flag$ac_cxx_werror_flag" ||
+	 test ! -s conftest.err
+       }; then
   :
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
   # Broken: fails on valid input.
 continue
 fi
+
 rm -f conftest.err conftest.$ac_ext
 
-  # OK, works on sane cases.  Now check whether non-existent headers
+  # OK, works on sane cases.  Now check whether nonexistent headers
   # can be detected and how.
   cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -3475,33 +4257,34 @@
 /* end confdefs.h.  */
 #include <ac_nonexistent.h>
 _ACEOF
-if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
+if { (ac_try="$ac_cpp conftest.$ac_ext"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } >/dev/null; then
-  if test -s conftest.err; then
-    ac_cpp_err=$ac_cxx_preproc_warn_flag
-  else
-    ac_cpp_err=
-  fi
-else
-  ac_cpp_err=yes
-fi
-if test -z "$ac_cpp_err"; then
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } >/dev/null && {
+	 test -z "$ac_cxx_preproc_warn_flag$ac_cxx_werror_flag" ||
+	 test ! -s conftest.err
+       }; then
   # Broken: success on invalid input.
 continue
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
   # Passes both tests.
 ac_preproc_ok=:
 break
 fi
+
 rm -f conftest.err conftest.$ac_ext
 
 done
@@ -3519,8 +4302,8 @@
 else
   ac_cv_prog_CXXCPP=$CXXCPP
 fi
-echo "$as_me:$LINENO: result: $CXXCPP" >&5
-echo "${ECHO_T}$CXXCPP" >&6
+{ $as_echo "$as_me:$LINENO: result: $CXXCPP" >&5
+$as_echo "$CXXCPP" >&6; }
 ac_preproc_ok=false
 for ac_cxx_preproc_warn_flag in '' yes
 do
@@ -3531,7 +4314,6 @@
   # On the NeXT, cc -E runs the code through the compiler's parser,
   # not just through cpp. "Syntax error" is here to catch this case.
   cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -3542,39 +4324,39 @@
 #else
 # include <assert.h>
 #endif
-                     Syntax error
+		     Syntax error
 _ACEOF
-if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
+if { (ac_try="$ac_cpp conftest.$ac_ext"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } >/dev/null; then
-  if test -s conftest.err; then
-    ac_cpp_err=$ac_cxx_preproc_warn_flag
-  else
-    ac_cpp_err=
-  fi
-else
-  ac_cpp_err=yes
-fi
-if test -z "$ac_cpp_err"; then
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } >/dev/null && {
+	 test -z "$ac_cxx_preproc_warn_flag$ac_cxx_werror_flag" ||
+	 test ! -s conftest.err
+       }; then
   :
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
   # Broken: fails on valid input.
 continue
 fi
+
 rm -f conftest.err conftest.$ac_ext
 
-  # OK, works on sane cases.  Now check whether non-existent headers
+  # OK, works on sane cases.  Now check whether nonexistent headers
   # can be detected and how.
   cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -3582,33 +4364,34 @@
 /* end confdefs.h.  */
 #include <ac_nonexistent.h>
 _ACEOF
-if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
+if { (ac_try="$ac_cpp conftest.$ac_ext"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } >/dev/null; then
-  if test -s conftest.err; then
-    ac_cpp_err=$ac_cxx_preproc_warn_flag
-  else
-    ac_cpp_err=
-  fi
-else
-  ac_cpp_err=yes
-fi
-if test -z "$ac_cpp_err"; then
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } >/dev/null && {
+	 test -z "$ac_cxx_preproc_warn_flag$ac_cxx_werror_flag" ||
+	 test ! -s conftest.err
+       }; then
   # Broken: success on invalid input.
 continue
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
   # Passes both tests.
 ac_preproc_ok=:
 break
 fi
+
 rm -f conftest.err conftest.$ac_ext
 
 done
@@ -3617,42 +4400,162 @@
 if $ac_preproc_ok; then
   :
 else
-  { { echo "$as_me:$LINENO: error: C++ preprocessor \"$CXXCPP\" fails sanity check
+  { { $as_echo "$as_me:$LINENO: error: in \`$ac_pwd':" >&5
+$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+{ { $as_echo "$as_me:$LINENO: error: C++ preprocessor \"$CXXCPP\" fails sanity check
 See \`config.log' for more details." >&5
-echo "$as_me: error: C++ preprocessor \"$CXXCPP\" fails sanity check
+$as_echo "$as_me: error: C++ preprocessor \"$CXXCPP\" fails sanity check
 See \`config.log' for more details." >&2;}
-   { (exit 1); exit 1; }; }
+   { (exit 1); exit 1; }; }; }
 fi
 
-ac_ext=cc
+ac_ext=cpp
 ac_cpp='$CXXCPP $CPPFLAGS'
 ac_compile='$CXX -c $CXXFLAGS $CPPFLAGS conftest.$ac_ext >&5'
 ac_link='$CXX -o conftest$ac_exeext $CXXFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
 ac_compiler_gnu=$ac_cv_cxx_compiler_gnu
 
 
-echo "$as_me:$LINENO: checking for egrep" >&5
-echo $ECHO_N "checking for egrep... $ECHO_C" >&6
-if test "${ac_cv_prog_egrep+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for grep that handles long lines and -e" >&5
+$as_echo_n "checking for grep that handles long lines and -e... " >&6; }
+if test "${ac_cv_path_GREP+set}" = set; then
+  $as_echo_n "(cached) " >&6
 else
-  if echo a | (grep -E '(a|b)') >/dev/null 2>&1
-    then ac_cv_prog_egrep='grep -E'
-    else ac_cv_prog_egrep='egrep'
+  if test -z "$GREP"; then
+  ac_path_GREP_found=false
+  # Loop through the user's path and test for each of PROGNAME-LIST
+  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH$PATH_SEPARATOR/usr/xpg4/bin
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+  for ac_prog in grep ggrep; do
+    for ac_exec_ext in '' $ac_executable_extensions; do
+      ac_path_GREP="$as_dir/$ac_prog$ac_exec_ext"
+      { test -f "$ac_path_GREP" && $as_test_x "$ac_path_GREP"; } || continue
+# Check for GNU ac_path_GREP and select it if it is found.
+  # Check for GNU $ac_path_GREP
+case `"$ac_path_GREP" --version 2>&1` in
+*GNU*)
+  ac_cv_path_GREP="$ac_path_GREP" ac_path_GREP_found=:;;
+*)
+  ac_count=0
+  $as_echo_n 0123456789 >"conftest.in"
+  while :
+  do
+    cat "conftest.in" "conftest.in" >"conftest.tmp"
+    mv "conftest.tmp" "conftest.in"
+    cp "conftest.in" "conftest.nl"
+    $as_echo 'GREP' >> "conftest.nl"
+    "$ac_path_GREP" -e 'GREP$' -e '-(cannot match)-' < "conftest.nl" >"conftest.out" 2>/dev/null || break
+    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
+    ac_count=`expr $ac_count + 1`
+    if test $ac_count -gt ${ac_path_GREP_max-0}; then
+      # Best one so far, save it but keep looking for a better one
+      ac_cv_path_GREP="$ac_path_GREP"
+      ac_path_GREP_max=$ac_count
     fi
+    # 10*(2^10) chars as input seems more than enough
+    test $ac_count -gt 10 && break
+  done
+  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
+esac
+
+      $ac_path_GREP_found && break 3
+    done
+  done
+done
+IFS=$as_save_IFS
+  if test -z "$ac_cv_path_GREP"; then
+    { { $as_echo "$as_me:$LINENO: error: no acceptable grep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" >&5
+$as_echo "$as_me: error: no acceptable grep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" >&2;}
+   { (exit 1); exit 1; }; }
+  fi
+else
+  ac_cv_path_GREP=$GREP
 fi
-echo "$as_me:$LINENO: result: $ac_cv_prog_egrep" >&5
-echo "${ECHO_T}$ac_cv_prog_egrep" >&6
- EGREP=$ac_cv_prog_egrep
 
+fi
+{ $as_echo "$as_me:$LINENO: result: $ac_cv_path_GREP" >&5
+$as_echo "$ac_cv_path_GREP" >&6; }
+ GREP="$ac_cv_path_GREP"
 
-echo "$as_me:$LINENO: checking for ANSI C header files" >&5
-echo $ECHO_N "checking for ANSI C header files... $ECHO_C" >&6
+
+{ $as_echo "$as_me:$LINENO: checking for egrep" >&5
+$as_echo_n "checking for egrep... " >&6; }
+if test "${ac_cv_path_EGREP+set}" = set; then
+  $as_echo_n "(cached) " >&6
+else
+  if echo a | $GREP -E '(a|b)' >/dev/null 2>&1
+   then ac_cv_path_EGREP="$GREP -E"
+   else
+     if test -z "$EGREP"; then
+  ac_path_EGREP_found=false
+  # Loop through the user's path and test for each of PROGNAME-LIST
+  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH$PATH_SEPARATOR/usr/xpg4/bin
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+  for ac_prog in egrep; do
+    for ac_exec_ext in '' $ac_executable_extensions; do
+      ac_path_EGREP="$as_dir/$ac_prog$ac_exec_ext"
+      { test -f "$ac_path_EGREP" && $as_test_x "$ac_path_EGREP"; } || continue
+# Check for GNU ac_path_EGREP and select it if it is found.
+  # Check for GNU $ac_path_EGREP
+case `"$ac_path_EGREP" --version 2>&1` in
+*GNU*)
+  ac_cv_path_EGREP="$ac_path_EGREP" ac_path_EGREP_found=:;;
+*)
+  ac_count=0
+  $as_echo_n 0123456789 >"conftest.in"
+  while :
+  do
+    cat "conftest.in" "conftest.in" >"conftest.tmp"
+    mv "conftest.tmp" "conftest.in"
+    cp "conftest.in" "conftest.nl"
+    $as_echo 'EGREP' >> "conftest.nl"
+    "$ac_path_EGREP" 'EGREP$' < "conftest.nl" >"conftest.out" 2>/dev/null || break
+    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
+    ac_count=`expr $ac_count + 1`
+    if test $ac_count -gt ${ac_path_EGREP_max-0}; then
+      # Best one so far, save it but keep looking for a better one
+      ac_cv_path_EGREP="$ac_path_EGREP"
+      ac_path_EGREP_max=$ac_count
+    fi
+    # 10*(2^10) chars as input seems more than enough
+    test $ac_count -gt 10 && break
+  done
+  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
+esac
+
+      $ac_path_EGREP_found && break 3
+    done
+  done
+done
+IFS=$as_save_IFS
+  if test -z "$ac_cv_path_EGREP"; then
+    { { $as_echo "$as_me:$LINENO: error: no acceptable egrep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" >&5
+$as_echo "$as_me: error: no acceptable egrep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" >&2;}
+   { (exit 1); exit 1; }; }
+  fi
+else
+  ac_cv_path_EGREP=$EGREP
+fi
+
+   fi
+fi
+{ $as_echo "$as_me:$LINENO: result: $ac_cv_path_EGREP" >&5
+$as_echo "$ac_cv_path_EGREP" >&6; }
+ EGREP="$ac_cv_path_EGREP"
+
+
+{ $as_echo "$as_me:$LINENO: checking for ANSI C header files" >&5
+$as_echo_n "checking for ANSI C header files... " >&6; }
 if test "${ac_cv_header_stdc+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -3672,30 +4575,36 @@
 }
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>&5
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-         { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && {
+	 test -z "$ac_cxx_werror_flag" ||
+	 test ! -s conftest.err
+       } && test -s conftest.$ac_objext; then
   ac_cv_header_stdc=yes
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_cv_header_stdc=no
+	ac_cv_header_stdc=no
 fi
-rm -f conftest.$ac_objext conftest.$ac_ext
 
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+
 if test $ac_cv_header_stdc = yes; then
   # SunOS 4.x string.h does not declare mem*, contrary to ANSI.
   cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -3717,7 +4626,6 @@
 if test $ac_cv_header_stdc = yes; then
   # ISC 2.0.2 stdlib.h does not declare free, contrary to ANSI.
   cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -3742,21 +4650,21 @@
   :
 else
   cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
 cat >>conftest.$ac_ext <<_ACEOF
 /* end confdefs.h.  */
 #include <ctype.h>
+#include <stdlib.h>
 #if ((' ' & 0x0FF) == 0x020)
 # define ISLOWER(c) ('a' <= (c) && (c) <= 'z')
 # define TOUPPER(c) (ISLOWER(c) ? 'A' + ((c) - 'a') : (c))
 #else
 # define ISLOWER(c) \
-                   (('a' <= (c) && (c) <= 'i') \
-                     || ('j' <= (c) && (c) <= 'r') \
-                     || ('s' <= (c) && (c) <= 'z'))
+		   (('a' <= (c) && (c) <= 'i') \
+		     || ('j' <= (c) && (c) <= 'r') \
+		     || ('s' <= (c) && (c) <= 'z'))
 # define TOUPPER(c) (ISLOWER(c) ? ((c) | 0x40) : (c))
 #endif
 
@@ -3767,37 +4675,51 @@
   int i;
   for (i = 0; i < 256; i++)
     if (XOR (islower (i), ISLOWER (i))
-        || toupper (i) != TOUPPER (i))
-      exit(2);
-  exit (0);
+	|| toupper (i) != TOUPPER (i))
+      return 2;
+  return 0;
 }
 _ACEOF
 rm -f conftest$ac_exeext
-if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
-  (eval $ac_link) 2>&5
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_link") 2>&5
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); } && { ac_try='./conftest$ac_exeext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
+  { (case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_try") 2>&5
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
   (exit $ac_status); }; }; then
   :
 else
-  echo "$as_me: program exited with status $ac_status" >&5
-echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: program exited with status $ac_status" >&5
+$as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
 ( exit $ac_status )
 ac_cv_header_stdc=no
 fi
-rm -f core core.* *.core gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
+rm -rf conftest.dSYM
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext conftest.$ac_objext conftest.$ac_ext
 fi
+
+
 fi
 fi
-echo "$as_me:$LINENO: result: $ac_cv_header_stdc" >&5
-echo "${ECHO_T}$ac_cv_header_stdc" >&6
+{ $as_echo "$as_me:$LINENO: result: $ac_cv_header_stdc" >&5
+$as_echo "$ac_cv_header_stdc" >&6; }
 if test $ac_cv_header_stdc = yes; then
 
 cat >>confdefs.h <<\_ACEOF
@@ -3817,16 +4739,15 @@
 
 
 for ac_header in sys/types.h sys/stat.h stdlib.h string.h memory.h strings.h \
-                  inttypes.h stdint.h unistd.h
+		  inttypes.h stdint.h unistd.h
 do
-as_ac_Header=`echo "ac_cv_header_$ac_header" | $as_tr_sh`
-echo "$as_me:$LINENO: checking for $ac_header" >&5
-echo $ECHO_N "checking for $ac_header... $ECHO_C" >&6
-if eval "test \"\${$as_ac_Header+set}\" = set"; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+as_ac_Header=`$as_echo "ac_cv_header_$ac_header" | $as_tr_sh`
+{ $as_echo "$as_me:$LINENO: checking for $ac_header" >&5
+$as_echo_n "checking for $ac_header... " >&6; }
+if { as_var=$as_ac_Header; eval "test \"\${$as_var+set}\" = set"; }; then
+  $as_echo_n "(cached) " >&6
 else
   cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -3837,31 +4758,42 @@
 #include <$ac_header>
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>&5
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-         { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && {
+	 test -z "$ac_cxx_werror_flag" ||
+	 test ! -s conftest.err
+       } && test -s conftest.$ac_objext; then
   eval "$as_ac_Header=yes"
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-eval "$as_ac_Header=no"
+	eval "$as_ac_Header=no"
 fi
-rm -f conftest.$ac_objext conftest.$ac_ext
+
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-echo "$as_me:$LINENO: result: `eval echo '${'$as_ac_Header'}'`" >&5
-echo "${ECHO_T}`eval echo '${'$as_ac_Header'}'`" >&6
-if test `eval echo '${'$as_ac_Header'}'` = yes; then
+ac_res=`eval 'as_val=${'$as_ac_Header'}
+		 $as_echo "$as_val"'`
+	       { $as_echo "$as_me:$LINENO: result: $ac_res" >&5
+$as_echo "$ac_res" >&6; }
+as_val=`eval 'as_val=${'$as_ac_Header'}
+		 $as_echo "$as_val"'`
+   if test "x$as_val" = x""yes; then
   cat >>confdefs.h <<_ACEOF
-#define `echo "HAVE_$ac_header" | $as_tr_cpp` 1
+#define `$as_echo "HAVE_$ac_header" | $as_tr_cpp` 1
 _ACEOF
 
 fi
@@ -3870,19 +4802,18 @@
 
 
 if test "${ac_cv_header_guile_gh_h+set}" = set; then
-  echo "$as_me:$LINENO: checking for guile/gh.h" >&5
-echo $ECHO_N "checking for guile/gh.h... $ECHO_C" >&6
+  { $as_echo "$as_me:$LINENO: checking for guile/gh.h" >&5
+$as_echo_n "checking for guile/gh.h... " >&6; }
 if test "${ac_cv_header_guile_gh_h+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 fi
-echo "$as_me:$LINENO: result: $ac_cv_header_guile_gh_h" >&5
-echo "${ECHO_T}$ac_cv_header_guile_gh_h" >&6
+{ $as_echo "$as_me:$LINENO: result: $ac_cv_header_guile_gh_h" >&5
+$as_echo "$ac_cv_header_guile_gh_h" >&6; }
 else
   # Is the header compilable?
-echo "$as_me:$LINENO: checking guile/gh.h usability" >&5
-echo $ECHO_N "checking guile/gh.h usability... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking guile/gh.h usability" >&5
+$as_echo_n "checking guile/gh.h usability... " >&6; }
 cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -3892,33 +4823,39 @@
 #include <guile/gh.h>
 _ACEOF
 rm -f conftest.$ac_objext
-if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
-  (eval $ac_compile) 2>&5
+if { (ac_try="$ac_compile"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_compile") 2>conftest.er1
   ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } &&
-         { ac_try='test -s conftest.$ac_objext'
-  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
-  (eval $ac_try) 2>&5
-  ac_status=$?
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); }; }; then
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && {
+	 test -z "$ac_cxx_werror_flag" ||
+	 test ! -s conftest.err
+       } && test -s conftest.$ac_objext; then
   ac_header_compiler=yes
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
-ac_header_compiler=no
+	ac_header_compiler=no
 fi
-rm -f conftest.$ac_objext conftest.$ac_ext
-echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
-echo "${ECHO_T}$ac_header_compiler" >&6
 
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+{ $as_echo "$as_me:$LINENO: result: $ac_header_compiler" >&5
+$as_echo "$ac_header_compiler" >&6; }
+
 # Is the header present?
-echo "$as_me:$LINENO: checking guile/gh.h presence" >&5
-echo $ECHO_N "checking guile/gh.h presence... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking guile/gh.h presence" >&5
+$as_echo_n "checking guile/gh.h presence... " >&6; }
 cat >conftest.$ac_ext <<_ACEOF
-#line $LINENO "configure"
 /* confdefs.h.  */
 _ACEOF
 cat confdefs.h >>conftest.$ac_ext
@@ -3926,93 +4863,86 @@
 /* end confdefs.h.  */
 #include <guile/gh.h>
 _ACEOF
-if { (eval echo "$as_me:$LINENO: \"$ac_cpp conftest.$ac_ext\"") >&5
-  (eval $ac_cpp conftest.$ac_ext) 2>conftest.er1
+if { (ac_try="$ac_cpp conftest.$ac_ext"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval ac_try_echo="\"\$as_me:$LINENO: $ac_try_echo\""
+$as_echo "$ac_try_echo") >&5
+  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.er1
   ac_status=$?
   grep -v '^ *+' conftest.er1 >conftest.err
   rm -f conftest.er1
   cat conftest.err >&5
-  echo "$as_me:$LINENO: \$? = $ac_status" >&5
-  (exit $ac_status); } >/dev/null; then
-  if test -s conftest.err; then
-    ac_cpp_err=$ac_cxx_preproc_warn_flag
-  else
-    ac_cpp_err=
-  fi
-else
-  ac_cpp_err=yes
-fi
-if test -z "$ac_cpp_err"; then
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } >/dev/null && {
+	 test -z "$ac_cxx_preproc_warn_flag$ac_cxx_werror_flag" ||
+	 test ! -s conftest.err
+       }; then
   ac_header_preproc=yes
 else
-  echo "$as_me: failed program was:" >&5
+  $as_echo "$as_me: failed program was:" >&5
 sed 's/^/| /' conftest.$ac_ext >&5
 
   ac_header_preproc=no
 fi
+
 rm -f conftest.err conftest.$ac_ext
-echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
-echo "${ECHO_T}$ac_header_preproc" >&6
+{ $as_echo "$as_me:$LINENO: result: $ac_header_preproc" >&5
+$as_echo "$ac_header_preproc" >&6; }
 
 # So?  What about this header?
-case $ac_header_compiler:$ac_header_preproc in
-  yes:no )
-    { echo "$as_me:$LINENO: WARNING: guile/gh.h: accepted by the compiler, rejected by the preprocessor!" >&5
-echo "$as_me: WARNING: guile/gh.h: accepted by the compiler, rejected by the preprocessor!" >&2;}
-    { echo "$as_me:$LINENO: WARNING: guile/gh.h: proceeding with the preprocessor's result" >&5
-echo "$as_me: WARNING: guile/gh.h: proceeding with the preprocessor's result" >&2;}
-    (
-      cat <<\_ASBOX
-## ------------------------------------ ##
-## Report this to bug-autoconf at gnu.org. ##
-## ------------------------------------ ##
-_ASBOX
-    ) |
-      sed "s/^/$as_me: WARNING:     /" >&2
+case $ac_header_compiler:$ac_header_preproc:$ac_cxx_preproc_warn_flag in
+  yes:no: )
+    { $as_echo "$as_me:$LINENO: WARNING: guile/gh.h: accepted by the compiler, rejected by the preprocessor!" >&5
+$as_echo "$as_me: WARNING: guile/gh.h: accepted by the compiler, rejected by the preprocessor!" >&2;}
+    { $as_echo "$as_me:$LINENO: WARNING: guile/gh.h: proceeding with the compiler's result" >&5
+$as_echo "$as_me: WARNING: guile/gh.h: proceeding with the compiler's result" >&2;}
+    ac_header_preproc=yes
     ;;
-  no:yes )
-    { echo "$as_me:$LINENO: WARNING: guile/gh.h: present but cannot be compiled" >&5
-echo "$as_me: WARNING: guile/gh.h: present but cannot be compiled" >&2;}
-    { echo "$as_me:$LINENO: WARNING: guile/gh.h: check for missing prerequisite headers?" >&5
-echo "$as_me: WARNING: guile/gh.h: check for missing prerequisite headers?" >&2;}
-    { echo "$as_me:$LINENO: WARNING: guile/gh.h: proceeding with the preprocessor's result" >&5
-echo "$as_me: WARNING: guile/gh.h: proceeding with the preprocessor's result" >&2;}
-    (
-      cat <<\_ASBOX
-## ------------------------------------ ##
-## Report this to bug-autoconf at gnu.org. ##
-## ------------------------------------ ##
-_ASBOX
-    ) |
-      sed "s/^/$as_me: WARNING:     /" >&2
+  no:yes:* )
+    { $as_echo "$as_me:$LINENO: WARNING: guile/gh.h: present but cannot be compiled" >&5
+$as_echo "$as_me: WARNING: guile/gh.h: present but cannot be compiled" >&2;}
+    { $as_echo "$as_me:$LINENO: WARNING: guile/gh.h:     check for missing prerequisite headers?" >&5
+$as_echo "$as_me: WARNING: guile/gh.h:     check for missing prerequisite headers?" >&2;}
+    { $as_echo "$as_me:$LINENO: WARNING: guile/gh.h: see the Autoconf documentation" >&5
+$as_echo "$as_me: WARNING: guile/gh.h: see the Autoconf documentation" >&2;}
+    { $as_echo "$as_me:$LINENO: WARNING: guile/gh.h:     section \"Present But Cannot Be Compiled\"" >&5
+$as_echo "$as_me: WARNING: guile/gh.h:     section \"Present But Cannot Be Compiled\"" >&2;}
+    { $as_echo "$as_me:$LINENO: WARNING: guile/gh.h: proceeding with the preprocessor's result" >&5
+$as_echo "$as_me: WARNING: guile/gh.h: proceeding with the preprocessor's result" >&2;}
+    { $as_echo "$as_me:$LINENO: WARNING: guile/gh.h: in the future, the compiler will take precedence" >&5
+$as_echo "$as_me: WARNING: guile/gh.h: in the future, the compiler will take precedence" >&2;}
+
     ;;
 esac
-echo "$as_me:$LINENO: checking for guile/gh.h" >&5
-echo $ECHO_N "checking for guile/gh.h... $ECHO_C" >&6
+{ $as_echo "$as_me:$LINENO: checking for guile/gh.h" >&5
+$as_echo_n "checking for guile/gh.h... " >&6; }
 if test "${ac_cv_header_guile_gh_h+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   ac_cv_header_guile_gh_h=$ac_header_preproc
 fi
-echo "$as_me:$LINENO: result: $ac_cv_header_guile_gh_h" >&5
-echo "${ECHO_T}$ac_cv_header_guile_gh_h" >&6
+{ $as_echo "$as_me:$LINENO: result: $ac_cv_header_guile_gh_h" >&5
+$as_echo "$ac_cv_header_guile_gh_h" >&6; }
 
 fi
 
 
 
-REQUIRED_CLANLIB_VERSION="0.7.3"
+REQUIRED_CLANLIB_VERSION="0.8.0"
 
 
-  succeeded=no
 
-  if test -z "$PKG_CONFIG"; then
-    # Extract the first word of "pkg-config", so it can be a program name with args.
-set dummy pkg-config; ac_word=$2
-echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
+if test "x$ac_cv_env_PKG_CONFIG_set" != "xset"; then
+	if test -n "$ac_tool_prefix"; then
+  # Extract the first word of "${ac_tool_prefix}pkg-config", so it can be a program name with args.
+set dummy ${ac_tool_prefix}pkg-config; ac_word=$2
+{ $as_echo "$as_me:$LINENO: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
 if test "${ac_cv_path_PKG_CONFIG+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
+  $as_echo_n "(cached) " >&6
 else
   case $PKG_CONFIG in
   [\\/]* | ?:[\\/]*)
@@ -4025,126 +4955,267 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
   for ac_exec_ext in '' $ac_executable_extensions; do
-  if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
     ac_cv_path_PKG_CONFIG="$as_dir/$ac_word$ac_exec_ext"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
+    $as_echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
 done
 done
+IFS=$as_save_IFS
 
-  test -z "$ac_cv_path_PKG_CONFIG" && ac_cv_path_PKG_CONFIG="no"
   ;;
 esac
 fi
 PKG_CONFIG=$ac_cv_path_PKG_CONFIG
-
 if test -n "$PKG_CONFIG"; then
-  echo "$as_me:$LINENO: result: $PKG_CONFIG" >&5
-echo "${ECHO_T}$PKG_CONFIG" >&6
+  { $as_echo "$as_me:$LINENO: result: $PKG_CONFIG" >&5
+$as_echo "$PKG_CONFIG" >&6; }
 else
-  echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
+
+fi
+if test -z "$ac_cv_path_PKG_CONFIG"; then
+  ac_pt_PKG_CONFIG=$PKG_CONFIG
+  # Extract the first word of "pkg-config", so it can be a program name with args.
+set dummy pkg-config; ac_word=$2
+{ $as_echo "$as_me:$LINENO: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if test "${ac_cv_path_ac_pt_PKG_CONFIG+set}" = set; then
+  $as_echo_n "(cached) " >&6
+else
+  case $ac_pt_PKG_CONFIG in
+  [\\/]* | ?:[\\/]*)
+  ac_cv_path_ac_pt_PKG_CONFIG="$ac_pt_PKG_CONFIG" # Let the user override the test with a path.
+  ;;
+  *)
+  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+  for ac_exec_ext in '' $ac_executable_extensions; do
+  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+    ac_cv_path_ac_pt_PKG_CONFIG="$as_dir/$ac_word$ac_exec_ext"
+    $as_echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
+    break 2
   fi
+done
+done
+IFS=$as_save_IFS
 
-  if test "$PKG_CONFIG" = "no" ; then
-     echo "*** The pkg-config script could not be found. Make sure it is"
-     echo "*** in your path, or set the PKG_CONFIG environment variable"
-     echo "*** to the full path to pkg-config."
-     echo "*** Or see http://www.freedesktop.org/software/pkgconfig to get pkg-config."
+  ;;
+esac
+fi
+ac_pt_PKG_CONFIG=$ac_cv_path_ac_pt_PKG_CONFIG
+if test -n "$ac_pt_PKG_CONFIG"; then
+  { $as_echo "$as_me:$LINENO: result: $ac_pt_PKG_CONFIG" >&5
+$as_echo "$ac_pt_PKG_CONFIG" >&6; }
+else
+  { $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
+fi
+
+  if test "x$ac_pt_PKG_CONFIG" = x; then
+    PKG_CONFIG=""
   else
-     PKG_CONFIG_MIN_VERSION=0.9.0
-     if $PKG_CONFIG --atleast-pkgconfig-version $PKG_CONFIG_MIN_VERSION; then
-        echo "$as_me:$LINENO: checking for
-  clanCore    >= $REQUIRED_CLANLIB_VERSION
-  clanApp     >= $REQUIRED_CLANLIB_VERSION
-  clanDisplay >= $REQUIRED_CLANLIB_VERSION
-  clanGL      >= $REQUIRED_CLANLIB_VERSION
-  " >&5
-echo $ECHO_N "checking for
-  clanCore    >= $REQUIRED_CLANLIB_VERSION
-  clanApp     >= $REQUIRED_CLANLIB_VERSION
-  clanDisplay >= $REQUIRED_CLANLIB_VERSION
-  clanGL      >= $REQUIRED_CLANLIB_VERSION
-  ... $ECHO_C" >&6
+    case $cross_compiling:$ac_tool_warned in
+yes:)
+{ $as_echo "$as_me:$LINENO: WARNING: using cross tools not prefixed with host triplet" >&5
+$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+ac_tool_warned=yes ;;
+esac
+    PKG_CONFIG=$ac_pt_PKG_CONFIG
+  fi
+else
+  PKG_CONFIG="$ac_cv_path_PKG_CONFIG"
+fi
 
-        if $PKG_CONFIG --exists "
-  clanCore    >= $REQUIRED_CLANLIB_VERSION
-  clanApp     >= $REQUIRED_CLANLIB_VERSION
-  clanDisplay >= $REQUIRED_CLANLIB_VERSION
-  clanGL      >= $REQUIRED_CLANLIB_VERSION
-  " ; then
-            echo "$as_me:$LINENO: result: yes" >&5
-echo "${ECHO_T}yes" >&6
-            succeeded=yes
+fi
+if test -n "$PKG_CONFIG"; then
+	_pkg_min_version=0.9.0
+	{ $as_echo "$as_me:$LINENO: checking pkg-config is at least version $_pkg_min_version" >&5
+$as_echo_n "checking pkg-config is at least version $_pkg_min_version... " >&6; }
+	if $PKG_CONFIG --atleast-pkgconfig-version $_pkg_min_version; then
+		{ $as_echo "$as_me:$LINENO: result: yes" >&5
+$as_echo "yes" >&6; }
+	else
+		{ $as_echo "$as_me:$LINENO: result: no" >&5
+$as_echo "no" >&6; }
+		PKG_CONFIG=""
+	fi
 
-            echo "$as_me:$LINENO: checking WINDSTILLE_DEPS_CFLAGS" >&5
-echo $ECHO_N "checking WINDSTILLE_DEPS_CFLAGS... $ECHO_C" >&6
-            WINDSTILLE_DEPS_CFLAGS=`$PKG_CONFIG --cflags "
-  clanCore    >= $REQUIRED_CLANLIB_VERSION
-  clanApp     >= $REQUIRED_CLANLIB_VERSION
-  clanDisplay >= $REQUIRED_CLANLIB_VERSION
-  clanGL      >= $REQUIRED_CLANLIB_VERSION
-  "`
-            echo "$as_me:$LINENO: result: $WINDSTILLE_DEPS_CFLAGS" >&5
-echo "${ECHO_T}$WINDSTILLE_DEPS_CFLAGS" >&6
+fi
 
-            echo "$as_me:$LINENO: checking WINDSTILLE_DEPS_LIBS" >&5
-echo $ECHO_N "checking WINDSTILLE_DEPS_LIBS... $ECHO_C" >&6
-            WINDSTILLE_DEPS_LIBS=`$PKG_CONFIG --libs "
-  clanCore    >= $REQUIRED_CLANLIB_VERSION
-  clanApp     >= $REQUIRED_CLANLIB_VERSION
-  clanDisplay >= $REQUIRED_CLANLIB_VERSION
-  clanGL      >= $REQUIRED_CLANLIB_VERSION
+pkg_failed=no
+{ $as_echo "$as_me:$LINENO: checking for WINDSTILLE_DEPS" >&5
+$as_echo_n "checking for WINDSTILLE_DEPS... " >&6; }
+
+if test -n "$PKG_CONFIG"; then
+    if test -n "$WINDSTILLE_DEPS_CFLAGS"; then
+        pkg_cv_WINDSTILLE_DEPS_CFLAGS="$WINDSTILLE_DEPS_CFLAGS"
+    else
+        if test -n "$PKG_CONFIG" && \
+    { ($as_echo "$as_me:$LINENO: \$PKG_CONFIG --exists --print-errors \"
+  clanCore-0.8    >= \$REQUIRED_CLANLIB_VERSION
+  clanApp-0.8     >= \$REQUIRED_CLANLIB_VERSION
+  clanDisplay-0.8 >= \$REQUIRED_CLANLIB_VERSION
+  clanGL-0.8      >= \$REQUIRED_CLANLIB_VERSION
+  \"") >&5
+  ($PKG_CONFIG --exists --print-errors "
+  clanCore-0.8    >= $REQUIRED_CLANLIB_VERSION
+  clanApp-0.8     >= $REQUIRED_CLANLIB_VERSION
+  clanDisplay-0.8 >= $REQUIRED_CLANLIB_VERSION
+  clanGL-0.8      >= $REQUIRED_CLANLIB_VERSION
+  ") 2>&5
+  ac_status=$?
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; then
+  pkg_cv_WINDSTILLE_DEPS_CFLAGS=`$PKG_CONFIG --cflags "
+  clanCore-0.8    >= $REQUIRED_CLANLIB_VERSION
+  clanApp-0.8     >= $REQUIRED_CLANLIB_VERSION
+  clanDisplay-0.8 >= $REQUIRED_CLANLIB_VERSION
+  clanGL-0.8      >= $REQUIRED_CLANLIB_VERSION
+  " 2>/dev/null`
+else
+  pkg_failed=yes
+fi
+    fi
+else
+	pkg_failed=untried
+fi
+if test -n "$PKG_CONFIG"; then
+    if test -n "$WINDSTILLE_DEPS_LIBS"; then
+        pkg_cv_WINDSTILLE_DEPS_LIBS="$WINDSTILLE_DEPS_LIBS"
+    else
+        if test -n "$PKG_CONFIG" && \
+    { ($as_echo "$as_me:$LINENO: \$PKG_CONFIG --exists --print-errors \"
+  clanCore-0.8    >= \$REQUIRED_CLANLIB_VERSION
+  clanApp-0.8     >= \$REQUIRED_CLANLIB_VERSION
+  clanDisplay-0.8 >= \$REQUIRED_CLANLIB_VERSION
+  clanGL-0.8      >= \$REQUIRED_CLANLIB_VERSION
+  \"") >&5
+  ($PKG_CONFIG --exists --print-errors "
+  clanCore-0.8    >= $REQUIRED_CLANLIB_VERSION
+  clanApp-0.8     >= $REQUIRED_CLANLIB_VERSION
+  clanDisplay-0.8 >= $REQUIRED_CLANLIB_VERSION
+  clanGL-0.8      >= $REQUIRED_CLANLIB_VERSION
+  ") 2>&5
+  ac_status=$?
+  $as_echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; then
+  pkg_cv_WINDSTILLE_DEPS_LIBS=`$PKG_CONFIG --libs "
+  clanCore-0.8    >= $REQUIRED_CLANLIB_VERSION
+  clanApp-0.8     >= $REQUIRED_CLANLIB_VERSION
+  clanDisplay-0.8 >= $REQUIRED_CLANLIB_VERSION
+  clanGL-0.8      >= $REQUIRED_CLANLIB_VERSION
+  " 2>/dev/null`
+else
+  pkg_failed=yes
+fi
+    fi
+else
+	pkg_failed=untried
+fi
+
+
+
+if test $pkg_failed = yes; then
+
+if $PKG_CONFIG --atleast-pkgconfig-version 0.20; then
+        _pkg_short_errors_supported=yes
+else
+        _pkg_short_errors_supported=no
+fi
+        if test $_pkg_short_errors_supported = yes; then
+	        WINDSTILLE_DEPS_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors "
+  clanCore-0.8    >= $REQUIRED_CLANLIB_VERSION
+  clanApp-0.8     >= $REQUIRED_CLANLIB_VERSION
+  clanDisplay-0.8 >= $REQUIRED_CLANLIB_VERSION
+  clanGL-0.8      >= $REQUIRED_CLANLIB_VERSION
   "`
-            echo "$as_me:$LINENO: result: $WINDSTILLE_DEPS_LIBS" >&5
-echo "${ECHO_T}$WINDSTILLE_DEPS_LIBS" >&6
         else
-            WINDSTILLE_DEPS_CFLAGS=""
-            WINDSTILLE_DEPS_LIBS=""
-            ## If we have a custom action on failure, don't print errors, but
-            ## do set a variable so people can do so.
-            WINDSTILLE_DEPS_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "
-  clanCore    >= $REQUIRED_CLANLIB_VERSION
-  clanApp     >= $REQUIRED_CLANLIB_VERSION
-  clanDisplay >= $REQUIRED_CLANLIB_VERSION
-  clanGL      >= $REQUIRED_CLANLIB_VERSION
+	        WINDSTILLE_DEPS_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors "
+  clanCore-0.8    >= $REQUIRED_CLANLIB_VERSION
+  clanApp-0.8     >= $REQUIRED_CLANLIB_VERSION
+  clanDisplay-0.8 >= $REQUIRED_CLANLIB_VERSION
+  clanGL-0.8      >= $REQUIRED_CLANLIB_VERSION
   "`
-            echo $WINDSTILLE_DEPS_PKG_ERRORS
         fi
+	# Put the nasty error message in config.log where it belongs
+	echo "$WINDSTILLE_DEPS_PKG_ERRORS" >&5
 
+	{ { $as_echo "$as_me:$LINENO: error: Package requirements (
+  clanCore-0.8    >= $REQUIRED_CLANLIB_VERSION
+  clanApp-0.8     >= $REQUIRED_CLANLIB_VERSION
+  clanDisplay-0.8 >= $REQUIRED_CLANLIB_VERSION
+  clanGL-0.8      >= $REQUIRED_CLANLIB_VERSION
+  ) were not met:
 
+$WINDSTILLE_DEPS_PKG_ERRORS
 
-     else
-        echo "*** Your version of pkg-config is too old. You need version $PKG_CONFIG_MIN_VERSION or newer."
-        echo "*** See http://www.freedesktop.org/software/pkgconfig"
-     fi
-  fi
+Consider adjusting the PKG_CONFIG_PATH environment variable if you
+installed software in a non-standard prefix.
 
-  if test $succeeded = yes; then
-     CXXFLAGS="$CXXFLAGS $WINDSTILLE_DEPS_CFLAGS"
-  LIBS="$LIBS $WINDSTILLE_DEPS_LIBS"
-  else
-     { { echo "$as_me:$LINENO: error: Library requirements (
-  clanCore    >= $REQUIRED_CLANLIB_VERSION
-  clanApp     >= $REQUIRED_CLANLIB_VERSION
-  clanDisplay >= $REQUIRED_CLANLIB_VERSION
-  clanGL      >= $REQUIRED_CLANLIB_VERSION
-  ) not met; consider adjusting the PKG_CONFIG_PATH environment variable if your libraries are in a nonstandard prefix so pkg-config can find them." >&5
-echo "$as_me: error: Library requirements (
-  clanCore    >= $REQUIRED_CLANLIB_VERSION
-  clanApp     >= $REQUIRED_CLANLIB_VERSION
-  clanDisplay >= $REQUIRED_CLANLIB_VERSION
-  clanGL      >= $REQUIRED_CLANLIB_VERSION
-  ) not met; consider adjusting the PKG_CONFIG_PATH environment variable if your libraries are in a nonstandard prefix so pkg-config can find them." >&2;}
+Alternatively, you may set the environment variables WINDSTILLE_DEPS_CFLAGS
+and WINDSTILLE_DEPS_LIBS to avoid the need to call pkg-config.
+See the pkg-config man page for more details.
+" >&5
+$as_echo "$as_me: error: Package requirements (
+  clanCore-0.8    >= $REQUIRED_CLANLIB_VERSION
+  clanApp-0.8     >= $REQUIRED_CLANLIB_VERSION
+  clanDisplay-0.8 >= $REQUIRED_CLANLIB_VERSION
+  clanGL-0.8      >= $REQUIRED_CLANLIB_VERSION
+  ) were not met:
+
+$WINDSTILLE_DEPS_PKG_ERRORS
+
+Consider adjusting the PKG_CONFIG_PATH environment variable if you
+installed software in a non-standard prefix.
+
+Alternatively, you may set the environment variables WINDSTILLE_DEPS_CFLAGS
+and WINDSTILLE_DEPS_LIBS to avoid the need to call pkg-config.
+See the pkg-config man page for more details.
+" >&2;}
    { (exit 1); exit 1; }; }
-  fi
+elif test $pkg_failed = untried; then
+	{ { $as_echo "$as_me:$LINENO: error: in \`$ac_pwd':" >&5
+$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+{ { $as_echo "$as_me:$LINENO: error: The pkg-config script could not be found or is too old.  Make sure it
+is in your PATH or set the PKG_CONFIG environment variable to the full
+path to pkg-config.
 
+Alternatively, you may set the environment variables WINDSTILLE_DEPS_CFLAGS
+and WINDSTILLE_DEPS_LIBS to avoid the need to call pkg-config.
+See the pkg-config man page for more details.
 
-                                                  ac_config_files="$ac_config_files Makefile data/Makefile src/Makefile src/guile/Makefile src/editor/Makefile"
+To get pkg-config, see <http://pkg-config.freedesktop.org/>.
+See \`config.log' for more details." >&5
+$as_echo "$as_me: error: The pkg-config script could not be found or is too old.  Make sure it
+is in your PATH or set the PKG_CONFIG environment variable to the full
+path to pkg-config.
 
+Alternatively, you may set the environment variables WINDSTILLE_DEPS_CFLAGS
+and WINDSTILLE_DEPS_LIBS to avoid the need to call pkg-config.
+See the pkg-config man page for more details.
+
+To get pkg-config, see <http://pkg-config.freedesktop.org/>.
+See \`config.log' for more details." >&2;}
+   { (exit 1); exit 1; }; }; }
+else
+	WINDSTILLE_DEPS_CFLAGS=$pkg_cv_WINDSTILLE_DEPS_CFLAGS
+	WINDSTILLE_DEPS_LIBS=$pkg_cv_WINDSTILLE_DEPS_LIBS
+        { $as_echo "$as_me:$LINENO: result: yes" >&5
+$as_echo "yes" >&6; }
+	CXXFLAGS="$CXXFLAGS $WINDSTILLE_DEPS_CFLAGS"
+  LIBS="$LIBS $WINDSTILLE_DEPS_LIBS"
+fi
+
+ac_config_files="$ac_config_files Makefile data/Makefile src/Makefile src/guile/Makefile src/editor/Makefile"
+
 cat >confcache <<\_ACEOF
 # This file is a shell script that caches the results of configure
 # tests run on this system so they can be shared between configure
@@ -4163,39 +5234,59 @@
 
 # The following way of writing the cache mishandles newlines in values,
 # but we know of no workaround that is simple, portable, and efficient.
-# So, don't put newlines in cache variables' values.
+# So, we kill variables containing newlines.
 # Ultrix sh set writes to stderr and can't be redirected directly,
 # and sets the high bit in the cache file unless we assign to the vars.
-{
+(
+  for ac_var in `(set) 2>&1 | sed -n 's/^\([a-zA-Z_][a-zA-Z0-9_]*\)=.*/\1/p'`; do
+    eval ac_val=\$$ac_var
+    case $ac_val in #(
+    *${as_nl}*)
+      case $ac_var in #(
+      *_cv_*) { $as_echo "$as_me:$LINENO: WARNING: cache variable $ac_var contains a newline" >&5
+$as_echo "$as_me: WARNING: cache variable $ac_var contains a newline" >&2;} ;;
+      esac
+      case $ac_var in #(
+      _ | IFS | as_nl) ;; #(
+      BASH_ARGV | BASH_SOURCE) eval $ac_var= ;; #(
+      *) $as_unset $ac_var ;;
+      esac ;;
+    esac
+  done
+
   (set) 2>&1 |
-    case `(ac_space=' '; set | grep ac_space) 2>&1` in
-    *ac_space=\ *)
+    case $as_nl`(ac_space=' '; set) 2>&1` in #(
+    *${as_nl}ac_space=\ *)
       # `set' does not quote correctly, so add quotes (double-quote
       # substitution turns \\\\ into \\, and sed turns \\ into \).
       sed -n \
-        "s/'/'\\\\''/g;
-    	  s/^\\([_$as_cr_alnum]*_cv_[_$as_cr_alnum]*\\)=\\(.*\\)/\\1='\\2'/p"
-      ;;
+	"s/'/'\\\\''/g;
+	  s/^\\([_$as_cr_alnum]*_cv_[_$as_cr_alnum]*\\)=\\(.*\\)/\\1='\\2'/p"
+      ;; #(
     *)
       # `set' quotes correctly as required by POSIX, so do not add quotes.
-      sed -n \
-        "s/^\\([_$as_cr_alnum]*_cv_[_$as_cr_alnum]*\\)=\\(.*\\)/\\1=\\2/p"
+      sed -n "/^[_$as_cr_alnum]*_cv_[_$as_cr_alnum]*=/p"
       ;;
-    esac;
-} |
+    esac |
+    sort
+) |
   sed '
+     /^ac_cv_env_/b end
      t clear
-     : clear
+     :clear
      s/^\([^=]*\)=\(.*[{}].*\)$/test "${\1+set}" = set || &/
      t end
-     /^ac_cv_env/!s/^\([^=]*\)=\(.*\)$/\1=${\1=\2}/
-     : end' >>confcache
-if diff $cache_file confcache >/dev/null 2>&1; then :; else
-  if test -w $cache_file; then
-    test "x$cache_file" != "x/dev/null" && echo "updating cache $cache_file"
+     s/^\([^=]*\)=\(.*\)$/\1=${\1=\2}/
+     :end' >>confcache
+if diff "$cache_file" confcache >/dev/null 2>&1; then :; else
+  if test -w "$cache_file"; then
+    test "x$cache_file" != "x/dev/null" &&
+      { $as_echo "$as_me:$LINENO: updating cache $cache_file" >&5
+$as_echo "$as_me: updating cache $cache_file" >&6;}
     cat confcache >$cache_file
   else
-    echo "not updating unwritable cache $cache_file"
+    { $as_echo "$as_me:$LINENO: not updating unwritable cache $cache_file" >&5
+$as_echo "$as_me: not updating unwritable cache $cache_file" >&6;}
   fi
 fi
 rm -f confcache
@@ -4204,32 +5295,18 @@
 # Let make expand exec_prefix.
 test "x$exec_prefix" = xNONE && exec_prefix='${prefix}'
 
-# VPATH may cause trouble with some makes, so we remove $(srcdir),
-# ${srcdir} and @srcdir@ from VPATH if srcdir is ".", strip leading and
-# trailing colons and then remove the whole line if VPATH becomes empty
-# (actually we leave an empty line to preserve line numbers).
-if test "x$srcdir" = x.; then
-  ac_vpsub='/^[ 	]*VPATH[ 	]*=/{
-s/:*\$(srcdir):*/:/;
-s/:*\${srcdir}:*/:/;
-s/:*@srcdir@:*/:/;
-s/^\([^=]*=[ 	]*\):*/\1/;
-s/:*$//;
-s/^[^=]*=[ 	]*$//;
-}'
-fi
-
 DEFS=-DHAVE_CONFIG_H
 
 ac_libobjs=
 ac_ltlibobjs=
 for ac_i in : $LIBOBJS; do test "x$ac_i" = x: && continue
   # 1. Remove the extension, and $U if already installed.
-  ac_i=`echo "$ac_i" |
-         sed 's/\$U\././;s/\.o$//;s/\.obj$//'`
-  # 2. Add them.
-  ac_libobjs="$ac_libobjs $ac_i\$U.$ac_objext"
-  ac_ltlibobjs="$ac_ltlibobjs $ac_i"'$U.lo'
+  ac_script='s/\$U\././;s/\.o$//;s/\.obj$//'
+  ac_i=`$as_echo "$ac_i" | sed "$ac_script"`
+  # 2. Prepend LIBOBJDIR.  When used with automake>=1.10 LIBOBJDIR
+  #    will be set to the directory where LIBOBJS objects are built.
+  ac_libobjs="$ac_libobjs \${LIBOBJDIR}$ac_i\$U.$ac_objext"
+  ac_ltlibobjs="$ac_ltlibobjs \${LIBOBJDIR}$ac_i"'$U.lo'
 done
 LIBOBJS=$ac_libobjs
 
@@ -4237,33 +5314,34 @@
 
 
 if test -z "${AMDEP_TRUE}" && test -z "${AMDEP_FALSE}"; then
-  { { echo "$as_me:$LINENO: error: conditional \"AMDEP\" was never defined.
+  { { $as_echo "$as_me:$LINENO: error: conditional \"AMDEP\" was never defined.
 Usually this means the macro was only invoked conditionally." >&5
-echo "$as_me: error: conditional \"AMDEP\" was never defined.
+$as_echo "$as_me: error: conditional \"AMDEP\" was never defined.
 Usually this means the macro was only invoked conditionally." >&2;}
    { (exit 1); exit 1; }; }
 fi
 if test -z "${am__fastdepCC_TRUE}" && test -z "${am__fastdepCC_FALSE}"; then
-  { { echo "$as_me:$LINENO: error: conditional \"am__fastdepCC\" was never defined.
+  { { $as_echo "$as_me:$LINENO: error: conditional \"am__fastdepCC\" was never defined.
 Usually this means the macro was only invoked conditionally." >&5
-echo "$as_me: error: conditional \"am__fastdepCC\" was never defined.
+$as_echo "$as_me: error: conditional \"am__fastdepCC\" was never defined.
 Usually this means the macro was only invoked conditionally." >&2;}
    { (exit 1); exit 1; }; }
 fi
 if test -z "${am__fastdepCXX_TRUE}" && test -z "${am__fastdepCXX_FALSE}"; then
-  { { echo "$as_me:$LINENO: error: conditional \"am__fastdepCXX\" was never defined.
+  { { $as_echo "$as_me:$LINENO: error: conditional \"am__fastdepCXX\" was never defined.
 Usually this means the macro was only invoked conditionally." >&5
-echo "$as_me: error: conditional \"am__fastdepCXX\" was never defined.
+$as_echo "$as_me: error: conditional \"am__fastdepCXX\" was never defined.
 Usually this means the macro was only invoked conditionally." >&2;}
    { (exit 1); exit 1; }; }
 fi
 
 : ${CONFIG_STATUS=./config.status}
+ac_write_fail=0
 ac_clean_files_save=$ac_clean_files
 ac_clean_files="$ac_clean_files $CONFIG_STATUS"
-{ echo "$as_me:$LINENO: creating $CONFIG_STATUS" >&5
-echo "$as_me: creating $CONFIG_STATUS" >&6;}
-cat >$CONFIG_STATUS <<_ACEOF
+{ $as_echo "$as_me:$LINENO: creating $CONFIG_STATUS" >&5
+$as_echo "$as_me: creating $CONFIG_STATUS" >&6;}
+cat >$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
 #! $SHELL
 # Generated by $as_me.
 # Run this file to recreate the current configuration.
@@ -4276,57 +5354,141 @@
 SHELL=\${CONFIG_SHELL-$SHELL}
 _ACEOF
 
-cat >>$CONFIG_STATUS <<\_ACEOF
+cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
 ## --------------------- ##
 ## M4sh Initialization.  ##
 ## --------------------- ##
 
-# Be Bourne compatible
+# Be more Bourne compatible
+DUALCASE=1; export DUALCASE # for MKS sh
 if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then
   emulate sh
   NULLCMD=:
-  # Zsh 3.x and 4.x performs word splitting on ${1+"$@"}, which
+  # Pre-4.2 versions of Zsh do word splitting on ${1+"$@"}, which
   # is contrary to our usage.  Disable this feature.
   alias -g '${1+"$@"}'='"$@"'
-elif test -n "${BASH_VERSION+set}" && (set -o posix) >/dev/null 2>&1; then
-  set -o posix
+  setopt NO_GLOB_SUBST
+else
+  case `(set -o) 2>/dev/null` in
+  *posix*) set -o posix ;;
+esac
+
 fi
 
+
+
+
+# PATH needs CR
+# Avoid depending upon Character Ranges.
+as_cr_letters='abcdefghijklmnopqrstuvwxyz'
+as_cr_LETTERS='ABCDEFGHIJKLMNOPQRSTUVWXYZ'
+as_cr_Letters=$as_cr_letters$as_cr_LETTERS
+as_cr_digits='0123456789'
+as_cr_alnum=$as_cr_Letters$as_cr_digits
+
+as_nl='
+'
+export as_nl
+# Printing a long string crashes Solaris 7 /usr/bin/printf.
+as_echo='\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\'
+as_echo=$as_echo$as_echo$as_echo$as_echo$as_echo
+as_echo=$as_echo$as_echo$as_echo$as_echo$as_echo$as_echo
+if (test "X`printf %s $as_echo`" = "X$as_echo") 2>/dev/null; then
+  as_echo='printf %s\n'
+  as_echo_n='printf %s'
+else
+  if test "X`(/usr/ucb/echo -n -n $as_echo) 2>/dev/null`" = "X-n $as_echo"; then
+    as_echo_body='eval /usr/ucb/echo -n "$1$as_nl"'
+    as_echo_n='/usr/ucb/echo -n'
+  else
+    as_echo_body='eval expr "X$1" : "X\\(.*\\)"'
+    as_echo_n_body='eval
+      arg=$1;
+      case $arg in
+      *"$as_nl"*)
+	expr "X$arg" : "X\\(.*\\)$as_nl";
+	arg=`expr "X$arg" : ".*$as_nl\\(.*\\)"`;;
+      esac;
+      expr "X$arg" : "X\\(.*\\)" | tr -d "$as_nl"
+    '
+    export as_echo_n_body
+    as_echo_n='sh -c $as_echo_n_body as_echo'
+  fi
+  export as_echo_body
+  as_echo='sh -c $as_echo_body as_echo'
+fi
+
+# The user is always right.
+if test "${PATH_SEPARATOR+set}" != set; then
+  PATH_SEPARATOR=:
+  (PATH='/bin;/bin'; FPATH=$PATH; sh -c :) >/dev/null 2>&1 && {
+    (PATH='/bin:/bin'; FPATH=$PATH; sh -c :) >/dev/null 2>&1 ||
+      PATH_SEPARATOR=';'
+  }
+fi
+
 # Support unset when possible.
-if (FOO=FOO; unset FOO) >/dev/null 2>&1; then
+if ( (MAIL=60; unset MAIL) || exit) >/dev/null 2>&1; then
   as_unset=unset
 else
   as_unset=false
 fi
 
 
+# IFS
+# We need space, tab and new line, in precisely that order.  Quoting is
+# there to prevent editors from complaining about space-tab.
+# (If _AS_PATH_WALK were called with IFS unset, it would disable word
+# splitting by setting IFS to empty value.)
+IFS=" ""	$as_nl"
+
+# Find who we are.  Look in the path if we contain no directory separator.
+case $0 in
+  *[\\/]* ) as_myself=$0 ;;
+  *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+  test -r "$as_dir/$0" && as_myself=$as_dir/$0 && break
+done
+IFS=$as_save_IFS
+
+     ;;
+esac
+# We did not find ourselves, most probably we were run as `sh COMMAND'
+# in which case we are not to be found in the path.
+if test "x$as_myself" = x; then
+  as_myself=$0
+fi
+if test ! -f "$as_myself"; then
+  $as_echo "$as_myself: error: cannot find myself; rerun with an absolute file name" >&2
+  { (exit 1); exit 1; }
+fi
+
 # Work around bugs in pre-3.0 UWIN ksh.
-$as_unset ENV MAIL MAILPATH
+for as_var in ENV MAIL MAILPATH
+do ($as_unset $as_var) >/dev/null 2>&1 && $as_unset $as_var
+done
 PS1='$ '
 PS2='> '
 PS4='+ '
 
 # NLS nuisances.
-for as_var in \
-  LANG LANGUAGE LC_ADDRESS LC_ALL LC_COLLATE LC_CTYPE LC_IDENTIFICATION \
-  LC_MEASUREMENT LC_MESSAGES LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER \
-  LC_TELEPHONE LC_TIME
-do
-  if (set +x; test -n "`(eval $as_var=C; export $as_var) 2>&1`"); then
-    eval $as_var=C; export $as_var
-  else
-    $as_unset $as_var
-  fi
-done
+LC_ALL=C
+export LC_ALL
+LANGUAGE=C
+export LANGUAGE
 
 # Required to use basename.
-if expr a : '\(a\)' >/dev/null 2>&1; then
+if expr a : '\(a\)' >/dev/null 2>&1 &&
+   test "X`expr 00001 : '.*\(...\)'`" = X001; then
   as_expr=expr
 else
   as_expr=false
 fi
 
-if (basename /) >/dev/null 2>&1 && test "X`basename / 2>&1`" = "X/"; then
+if (basename -- /) >/dev/null 2>&1 && test "X`basename -- / 2>&1`" = "X/"; then
   as_basename=basename
 else
   as_basename=false
@@ -4334,200 +5496,168 @@
 
 
 # Name of the executable.
-as_me=`$as_basename "$0" ||
+as_me=`$as_basename -- "$0" ||
 $as_expr X/"$0" : '.*/\([^/][^/]*\)/*$' \| \
 	 X"$0" : 'X\(//\)$' \| \
-	 X"$0" : 'X\(/\)$' \| \
-	 .     : '\(.\)' 2>/dev/null ||
-echo X/"$0" |
-    sed '/^.*\/\([^/][^/]*\)\/*$/{ s//\1/; q; }
-  	  /^X\/\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\/\(\/\).*/{ s//\1/; q; }
-  	  s/.*/./; q'`
+	 X"$0" : 'X\(/\)' \| . 2>/dev/null ||
+$as_echo X/"$0" |
+    sed '/^.*\/\([^/][^/]*\)\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\/\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\/\(\/\).*/{
+	    s//\1/
+	    q
+	  }
+	  s/.*/./; q'`
 
+# CDPATH.
+$as_unset CDPATH
 
-# PATH needs CR, and LINENO needs CR and PATH.
-# Avoid depending upon Character Ranges.
-as_cr_letters='abcdefghijklmnopqrstuvwxyz'
-as_cr_LETTERS='ABCDEFGHIJKLMNOPQRSTUVWXYZ'
-as_cr_Letters=$as_cr_letters$as_cr_LETTERS
-as_cr_digits='0123456789'
-as_cr_alnum=$as_cr_Letters$as_cr_digits
 
-# The user is always right.
-if test "${PATH_SEPARATOR+set}" != set; then
-  echo "#! /bin/sh" >conf$$.sh
-  echo  "exit 0"   >>conf$$.sh
-  chmod +x conf$$.sh
-  if (PATH="/nonexistent;."; conf$$.sh) >/dev/null 2>&1; then
-    PATH_SEPARATOR=';'
-  else
-    PATH_SEPARATOR=:
-  fi
-  rm -f conf$$.sh
-fi
 
-
   as_lineno_1=$LINENO
   as_lineno_2=$LINENO
-  as_lineno_3=`(expr $as_lineno_1 + 1) 2>/dev/null`
   test "x$as_lineno_1" != "x$as_lineno_2" &&
-  test "x$as_lineno_3"  = "x$as_lineno_2"  || {
-  # Find who we are.  Look in the path if we contain no path at all
-  # relative or not.
-  case $0 in
-    *[\\/]* ) as_myself=$0 ;;
-    *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-  test -r "$as_dir/$0" && as_myself=$as_dir/$0 && break
-done
+  test "x`expr $as_lineno_1 + 1`" = "x$as_lineno_2" || {
 
-       ;;
-  esac
-  # We did not find ourselves, most probably we were run as `sh COMMAND'
-  # in which case we are not to be found in the path.
-  if test "x$as_myself" = x; then
-    as_myself=$0
-  fi
-  if test ! -f "$as_myself"; then
-    { { echo "$as_me:$LINENO: error: cannot find myself; rerun with an absolute path" >&5
-echo "$as_me: error: cannot find myself; rerun with an absolute path" >&2;}
-   { (exit 1); exit 1; }; }
-  fi
-  case $CONFIG_SHELL in
-  '')
-    as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in /bin$PATH_SEPARATOR/usr/bin$PATH_SEPARATOR$PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-  for as_base in sh bash ksh sh5; do
-	 case $as_dir in
-	 /*)
-	   if ("$as_dir/$as_base" -c '
-  as_lineno_1=$LINENO
-  as_lineno_2=$LINENO
-  as_lineno_3=`(expr $as_lineno_1 + 1) 2>/dev/null`
-  test "x$as_lineno_1" != "x$as_lineno_2" &&
-  test "x$as_lineno_3"  = "x$as_lineno_2" ') 2>/dev/null; then
-	     $as_unset BASH_ENV || test "${BASH_ENV+set}" != set || { BASH_ENV=; export BASH_ENV; }
-	     $as_unset ENV || test "${ENV+set}" != set || { ENV=; export ENV; }
-	     CONFIG_SHELL=$as_dir/$as_base
-	     export CONFIG_SHELL
-	     exec "$CONFIG_SHELL" "$0" ${1+"$@"}
-	   fi;;
-	 esac
-       done
-done
-;;
-  esac
-
   # Create $as_me.lineno as a copy of $as_myself, but with $LINENO
   # uniformly replaced by the line number.  The first 'sed' inserts a
-  # line-number line before each line; the second 'sed' does the real
-  # work.  The second script uses 'N' to pair each line-number line
-  # with the numbered line, and appends trailing '-' during
-  # substitution so that $LINENO is not a special case at line end.
+  # line-number line after each line using $LINENO; the second 'sed'
+  # does the real work.  The second script uses 'N' to pair each
+  # line-number line with the line containing $LINENO, and appends
+  # trailing '-' during substitution so that $LINENO is not a special
+  # case at line end.
   # (Raja R Harinath suggested sed '=', and Paul Eggert wrote the
-  # second 'sed' script.  Blame Lee E. McMahon for sed's syntax.  :-)
-  sed '=' <$as_myself |
+  # scripts with optimization help from Paolo Bonzini.  Blame Lee
+  # E. McMahon (1931-1989) for sed's syntax.  :-)
+  sed -n '
+    p
+    /[$]LINENO/=
+  ' <$as_myself |
     sed '
+      s/[$]LINENO.*/&-/
+      t lineno
+      b
+      :lineno
       N
-      s,$,-,
-      : loop
-      s,^\(['$as_cr_digits']*\)\(.*\)[$]LINENO\([^'$as_cr_alnum'_]\),\1\2\1\3,
+      :loop
+      s/[$]LINENO\([^'$as_cr_alnum'_].*\n\)\(.*\)/\2\1\2/
       t loop
-      s,-$,,
-      s,^['$as_cr_digits']*\n,,
+      s/-\n.*//
     ' >$as_me.lineno &&
-  chmod +x $as_me.lineno ||
-    { { echo "$as_me:$LINENO: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&5
-echo "$as_me: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&2;}
+  chmod +x "$as_me.lineno" ||
+    { $as_echo "$as_me: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&2
    { (exit 1); exit 1; }; }
 
   # Don't try to exec as it changes $[0], causing all sort of problems
   # (the dirname of $[0] is not the place where we might find the
-  # original and so on.  Autoconf is especially sensible to this).
-  . ./$as_me.lineno
+  # original and so on.  Autoconf is especially sensitive to this).
+  . "./$as_me.lineno"
   # Exit status is that of the last command.
   exit
 }
 
 
-case `echo "testing\c"; echo 1,2,3`,`echo -n testing; echo 1,2,3` in
-  *c*,-n*) ECHO_N= ECHO_C='
-' ECHO_T='	' ;;
-  *c*,*  ) ECHO_N=-n ECHO_C= ECHO_T= ;;
-  *)       ECHO_N= ECHO_C='\c' ECHO_T= ;;
+if (as_dir=`dirname -- /` && test "X$as_dir" = X/) >/dev/null 2>&1; then
+  as_dirname=dirname
+else
+  as_dirname=false
+fi
+
+ECHO_C= ECHO_N= ECHO_T=
+case `echo -n x` in
+-n*)
+  case `echo 'x\c'` in
+  *c*) ECHO_T='	';;	# ECHO_T is single tab character.
+  *)   ECHO_C='\c';;
+  esac;;
+*)
+  ECHO_N='-n';;
 esac
-
-if expr a : '\(a\)' >/dev/null 2>&1; then
+if expr a : '\(a\)' >/dev/null 2>&1 &&
+   test "X`expr 00001 : '.*\(...\)'`" = X001; then
   as_expr=expr
 else
   as_expr=false
 fi
 
 rm -f conf$$ conf$$.exe conf$$.file
-echo >conf$$.file
-if ln -s conf$$.file conf$$ 2>/dev/null; then
-  # We could just check for DJGPP; but this test a) works b) is more generic
-  # and c) will remain valid once DJGPP supports symlinks (DJGPP 2.04).
-  if test -f conf$$.exe; then
-    # Don't use ln at all; we don't have any links
+if test -d conf$$.dir; then
+  rm -f conf$$.dir/conf$$.file
+else
+  rm -f conf$$.dir
+  mkdir conf$$.dir 2>/dev/null
+fi
+if (echo >conf$$.file) 2>/dev/null; then
+  if ln -s conf$$.file conf$$ 2>/dev/null; then
+    as_ln_s='ln -s'
+    # ... but there are two gotchas:
+    # 1) On MSYS, both `ln -s file dir' and `ln file dir' fail.
+    # 2) DJGPP < 2.04 has no symlinks; `ln -s' creates a wrapper executable.
+    # In both cases, we have to default to `cp -p'.
+    ln -s conf$$.file conf$$.dir 2>/dev/null && test ! -f conf$$.exe ||
+      as_ln_s='cp -p'
+  elif ln conf$$.file conf$$ 2>/dev/null; then
+    as_ln_s=ln
+  else
     as_ln_s='cp -p'
-  else
-    as_ln_s='ln -s'
   fi
-elif ln conf$$.file conf$$ 2>/dev/null; then
-  as_ln_s=ln
 else
   as_ln_s='cp -p'
 fi
-rm -f conf$$ conf$$.exe conf$$.file
+rm -f conf$$ conf$$.exe conf$$.dir/conf$$.file conf$$.file
+rmdir conf$$.dir 2>/dev/null
 
 if mkdir -p . 2>/dev/null; then
   as_mkdir_p=:
 else
+  test -d ./-p && rmdir ./-p
   as_mkdir_p=false
 fi
 
-as_executable_p="test -f"
+if test -x / >/dev/null 2>&1; then
+  as_test_x='test -x'
+else
+  if ls -dL / >/dev/null 2>&1; then
+    as_ls_L_option=L
+  else
+    as_ls_L_option=
+  fi
+  as_test_x='
+    eval sh -c '\''
+      if test -d "$1"; then
+	test -d "$1/.";
+      else
+	case $1 in
+	-*)set "./$1";;
+	esac;
+	case `ls -ld'$as_ls_L_option' "$1" 2>/dev/null` in
+	???[sx]*):;;*)false;;esac;fi
+    '\'' sh
+  '
+fi
+as_executable_p=$as_test_x
 
 # Sed expression to map a string onto a valid CPP name.
-as_tr_cpp="sed y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g"
+as_tr_cpp="eval sed 'y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g'"
 
 # Sed expression to map a string onto a valid variable name.
-as_tr_sh="sed y%*+%pp%;s%[^_$as_cr_alnum]%_%g"
+as_tr_sh="eval sed 'y%*+%pp%;s%[^_$as_cr_alnum]%_%g'"
 
 
-# IFS
-# We need space, tab and new line, in precisely that order.
-as_nl='
-'
-IFS=" 	$as_nl"
-
-# CDPATH.
-$as_unset CDPATH
-
 exec 6>&1
 
-# Open the log real soon, to keep \$[0] and so on meaningful, and to
+# Save the log message, to keep $[0] and so on meaningful, and to
 # report actual input values of CONFIG_FILES etc. instead of their
-# values after options handling.  Logging --version etc. is OK.
-exec 5>>config.log
-{
-  echo
-  sed 'h;s/./-/g;s/^.../## /;s/...$/ ##/;p;x;p;x' <<_ASBOX
-## Running $as_me. ##
-_ASBOX
-} >&5
-cat >&5 <<_CSEOF
-
+# values after options handling.
+ac_log="
 This file was extended by Windstille $as_me 0.1.0, which was
-generated by GNU Autoconf 2.57.  Invocation command line was
+generated by GNU Autoconf 2.63.  Invocation command line was
 
   CONFIG_FILES    = $CONFIG_FILES
   CONFIG_HEADERS  = $CONFIG_HEADERS
@@ -4535,44 +5665,44 @@
   CONFIG_COMMANDS = $CONFIG_COMMANDS
   $ $0 $@
 
-_CSEOF
-echo "on `(hostname || uname -n) 2>/dev/null | sed 1q`" >&5
-echo >&5
+on `(hostname || uname -n) 2>/dev/null | sed 1q`
+"
+
 _ACEOF
 
-# Files that config.status was made for.
-if test -n "$ac_config_files"; then
-  echo "config_files=\"$ac_config_files\"" >>$CONFIG_STATUS
-fi
+case $ac_config_files in *"
+"*) set x $ac_config_files; shift; ac_config_files=$*;;
+esac
 
-if test -n "$ac_config_headers"; then
-  echo "config_headers=\"$ac_config_headers\"" >>$CONFIG_STATUS
-fi
+case $ac_config_headers in *"
+"*) set x $ac_config_headers; shift; ac_config_headers=$*;;
+esac
 
-if test -n "$ac_config_links"; then
-  echo "config_links=\"$ac_config_links\"" >>$CONFIG_STATUS
-fi
 
-if test -n "$ac_config_commands"; then
-  echo "config_commands=\"$ac_config_commands\"" >>$CONFIG_STATUS
-fi
+cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
+# Files that config.status was made for.
+config_files="$ac_config_files"
+config_headers="$ac_config_headers"
+config_commands="$ac_config_commands"
 
-cat >>$CONFIG_STATUS <<\_ACEOF
+_ACEOF
 
+cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
 ac_cs_usage="\
 \`$as_me' instantiates files from templates according to the
 current configuration.
 
-Usage: $0 [OPTIONS] [FILE]...
+Usage: $0 [OPTION]... [FILE]...
 
   -h, --help       print this help, then exit
-  -V, --version    print version number, then exit
-  -q, --quiet      do not print progress messages
+  -V, --version    print version number and configuration settings, then exit
+  -q, --quiet, --silent
+                   do not print progress messages
   -d, --debug      don't remove temporary files
       --recheck    update $as_me by reconfiguring in the same conditions
-  --file=FILE[:TEMPLATE]
+      --file=FILE[:TEMPLATE]
                    instantiate the configuration file FILE
-  --header=FILE[:TEMPLATE]
+      --header=FILE[:TEMPLATE]
                    instantiate the configuration header FILE
 
 Configuration files:
@@ -4585,84 +5715,83 @@
 $config_commands
 
 Report bugs to <bug-autoconf at gnu.org>."
+
 _ACEOF
-
-cat >>$CONFIG_STATUS <<_ACEOF
+cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
 ac_cs_version="\\
 Windstille config.status 0.1.0
-configured by $0, generated by GNU Autoconf 2.57,
-  with options \\"`echo "$ac_configure_args" | sed 's/[\\""\`\$]/\\\\&/g'`\\"
+configured by $0, generated by GNU Autoconf 2.63,
+  with options \\"`$as_echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`\\"
 
-Copyright 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001
-Free Software Foundation, Inc.
+Copyright (C) 2008 Free Software Foundation, Inc.
 This config.status script is free software; the Free Software Foundation
 gives unlimited permission to copy, distribute and modify it."
-srcdir=$srcdir
-INSTALL="$INSTALL"
+
+ac_pwd='$ac_pwd'
+srcdir='$srcdir'
+INSTALL='$INSTALL'
+AWK='$AWK'
+test -n "\$AWK" || AWK=awk
 _ACEOF
 
-cat >>$CONFIG_STATUS <<\_ACEOF
-# If no file are specified by the user, then we need to provide default
-# value.  By we need to know if files were specified by the user.
+cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
+# The default lists apply if the user does not specify any file.
 ac_need_defaults=:
 while test $# != 0
 do
   case $1 in
   --*=*)
-    ac_option=`expr "x$1" : 'x\([^=]*\)='`
-    ac_optarg=`expr "x$1" : 'x[^=]*=\(.*\)'`
+    ac_option=`expr "X$1" : 'X\([^=]*\)='`
+    ac_optarg=`expr "X$1" : 'X[^=]*=\(.*\)'`
     ac_shift=:
     ;;
-  -*)
+  *)
     ac_option=$1
     ac_optarg=$2
     ac_shift=shift
     ;;
-  *) # This is not an option, so the user has probably given explicit
-     # arguments.
-     ac_option=$1
-     ac_need_defaults=false;;
   esac
 
   case $ac_option in
   # Handling of the options.
-_ACEOF
-cat >>$CONFIG_STATUS <<\_ACEOF
   -recheck | --recheck | --rechec | --reche | --rech | --rec | --re | --r)
     ac_cs_recheck=: ;;
-  --version | --vers* | -V )
-    echo "$ac_cs_version"; exit 0 ;;
-  --he | --h)
-    # Conflict between --help and --header
-    { { echo "$as_me:$LINENO: error: ambiguous option: $1
-Try \`$0 --help' for more information." >&5
-echo "$as_me: error: ambiguous option: $1
-Try \`$0 --help' for more information." >&2;}
-   { (exit 1); exit 1; }; };;
-  --help | --hel | -h )
-    echo "$ac_cs_usage"; exit 0 ;;
-  --debug | --d* | -d )
+  --version | --versio | --versi | --vers | --ver | --ve | --v | -V )
+    $as_echo "$ac_cs_version"; exit ;;
+  --debug | --debu | --deb | --de | --d | -d )
     debug=: ;;
   --file | --fil | --fi | --f )
     $ac_shift
-    CONFIG_FILES="$CONFIG_FILES $ac_optarg"
+    case $ac_optarg in
+    *\'*) ac_optarg=`$as_echo "$ac_optarg" | sed "s/'/'\\\\\\\\''/g"` ;;
+    esac
+    CONFIG_FILES="$CONFIG_FILES '$ac_optarg'"
     ac_need_defaults=false;;
   --header | --heade | --head | --hea )
     $ac_shift
-    CONFIG_HEADERS="$CONFIG_HEADERS $ac_optarg"
+    case $ac_optarg in
+    *\'*) ac_optarg=`$as_echo "$ac_optarg" | sed "s/'/'\\\\\\\\''/g"` ;;
+    esac
+    CONFIG_HEADERS="$CONFIG_HEADERS '$ac_optarg'"
     ac_need_defaults=false;;
+  --he | --h)
+    # Conflict between --help and --header
+    { $as_echo "$as_me: error: ambiguous option: $1
+Try \`$0 --help' for more information." >&2
+   { (exit 1); exit 1; }; };;
+  --help | --hel | -h )
+    $as_echo "$ac_cs_usage"; exit ;;
   -q | -quiet | --quiet | --quie | --qui | --qu | --q \
   | -silent | --silent | --silen | --sile | --sil | --si | --s)
     ac_cs_silent=: ;;
 
   # This is an error.
-  -*) { { echo "$as_me:$LINENO: error: unrecognized option: $1
-Try \`$0 --help' for more information." >&5
-echo "$as_me: error: unrecognized option: $1
-Try \`$0 --help' for more information." >&2;}
+  -*) { $as_echo "$as_me: error: unrecognized option: $1
+Try \`$0 --help' for more information." >&2
    { (exit 1); exit 1; }; } ;;
 
-  *) ac_config_targets="$ac_config_targets $1" ;;
+  *) ac_config_targets="$ac_config_targets $1"
+     ac_need_defaults=false ;;
 
   esac
   shift
@@ -4676,43 +5805,57 @@
 fi
 
 _ACEOF
-cat >>$CONFIG_STATUS <<_ACEOF
+cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
 if \$ac_cs_recheck; then
-  echo "running $SHELL $0 " $ac_configure_args \$ac_configure_extra_args " --no-create --no-recursion" >&6
-  exec $SHELL $0 $ac_configure_args \$ac_configure_extra_args --no-create --no-recursion
+  set X '$SHELL' '$0' $ac_configure_args \$ac_configure_extra_args --no-create --no-recursion
+  shift
+  \$as_echo "running CONFIG_SHELL=$SHELL \$*" >&6
+  CONFIG_SHELL='$SHELL'
+  export CONFIG_SHELL
+  exec "\$@"
 fi
 
 _ACEOF
+cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
+exec 5>>config.log
+{
+  echo
+  sed 'h;s/./-/g;s/^.../## /;s/...$/ ##/;p;x;p;x' <<_ASBOX
+## Running $as_me. ##
+_ASBOX
+  $as_echo "$ac_log"
+} >&5
 
-cat >>$CONFIG_STATUS <<_ACEOF
+_ACEOF
+cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
 #
-# INIT-COMMANDS section.
+# INIT-COMMANDS
 #
-
 AMDEP_TRUE="$AMDEP_TRUE" ac_aux_dir="$ac_aux_dir"
 
 _ACEOF
 
+cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
 
-
-cat >>$CONFIG_STATUS <<\_ACEOF
+# Handling of arguments.
 for ac_config_target in $ac_config_targets
 do
-  case "$ac_config_target" in
-  # Handling of arguments.
-  "Makefile" ) CONFIG_FILES="$CONFIG_FILES Makefile" ;;
-  "data/Makefile" ) CONFIG_FILES="$CONFIG_FILES data/Makefile" ;;
-  "src/Makefile" ) CONFIG_FILES="$CONFIG_FILES src/Makefile" ;;
-  "src/guile/Makefile" ) CONFIG_FILES="$CONFIG_FILES src/guile/Makefile" ;;
-  "src/editor/Makefile" ) CONFIG_FILES="$CONFIG_FILES src/editor/Makefile" ;;
-  "depfiles" ) CONFIG_COMMANDS="$CONFIG_COMMANDS depfiles" ;;
-  "config.h" ) CONFIG_HEADERS="$CONFIG_HEADERS config.h" ;;
-  *) { { echo "$as_me:$LINENO: error: invalid argument: $ac_config_target" >&5
-echo "$as_me: error: invalid argument: $ac_config_target" >&2;}
+  case $ac_config_target in
+    "config.h") CONFIG_HEADERS="$CONFIG_HEADERS config.h" ;;
+    "depfiles") CONFIG_COMMANDS="$CONFIG_COMMANDS depfiles" ;;
+    "Makefile") CONFIG_FILES="$CONFIG_FILES Makefile" ;;
+    "data/Makefile") CONFIG_FILES="$CONFIG_FILES data/Makefile" ;;
+    "src/Makefile") CONFIG_FILES="$CONFIG_FILES src/Makefile" ;;
+    "src/guile/Makefile") CONFIG_FILES="$CONFIG_FILES src/guile/Makefile" ;;
+    "src/editor/Makefile") CONFIG_FILES="$CONFIG_FILES src/editor/Makefile" ;;
+
+  *) { { $as_echo "$as_me:$LINENO: error: invalid argument: $ac_config_target" >&5
+$as_echo "$as_me: error: invalid argument: $ac_config_target" >&2;}
    { (exit 1); exit 1; }; };;
   esac
 done
 
+
 # If the user did not use the arguments to specify the items to instantiate,
 # then the envvar interface is used.  Set only those that are not.
 # We use the long form for the default assignment because of an extremely
@@ -4724,630 +5867,635 @@
 fi
 
 # Have a temporary directory for convenience.  Make it in the build tree
-# simply because there is no reason to put it here, and in addition,
+# simply because there is no reason against having it here, and in addition,
 # creating and moving files from /tmp can sometimes cause problems.
-# Create a temporary directory, and hook for its removal unless debugging.
+# Hook for its removal unless debugging.
+# Note that there is a small window in which the directory will not be cleaned:
+# after its creation but before its name has been assigned to `$tmp'.
 $debug ||
 {
-  trap 'exit_status=$?; rm -rf $tmp && exit $exit_status' 0
+  tmp=
+  trap 'exit_status=$?
+  { test -z "$tmp" || test ! -d "$tmp" || rm -fr "$tmp"; } && exit $exit_status
+' 0
   trap '{ (exit 1); exit 1; }' 1 2 13 15
 }
-
 # Create a (secure) tmp directory for tmp files.
 
 {
-  tmp=`(umask 077 && mktemp -d -q "./confstatXXXXXX") 2>/dev/null` &&
+  tmp=`(umask 077 && mktemp -d "./confXXXXXX") 2>/dev/null` &&
   test -n "$tmp" && test -d "$tmp"
 }  ||
 {
-  tmp=./confstat$$-$RANDOM
-  (umask 077 && mkdir $tmp)
+  tmp=./conf$$-$RANDOM
+  (umask 077 && mkdir "$tmp")
 } ||
 {
-   echo "$me: cannot create a temporary directory in ." >&2
+   $as_echo "$as_me: cannot create a temporary directory in ." >&2
    { (exit 1); exit 1; }
 }
 
+# Set up the scripts for CONFIG_FILES section.
+# No need to generate them if there are no CONFIG_FILES.
+# This happens for instance with `./config.status config.h'.
+if test -n "$CONFIG_FILES"; then
+
+
+ac_cr='
'
+ac_cs_awk_cr=`$AWK 'BEGIN { print "a\rb" }' </dev/null 2>/dev/null`
+if test "$ac_cs_awk_cr" = "a${ac_cr}b"; then
+  ac_cs_awk_cr='\\r'
+else
+  ac_cs_awk_cr=$ac_cr
+fi
+
+echo 'BEGIN {' >"$tmp/subs1.awk" &&
 _ACEOF
 
-cat >>$CONFIG_STATUS <<_ACEOF
 
-#
-# CONFIG_FILES section.
-#
+{
+  echo "cat >conf$$subs.awk <<_ACEOF" &&
+  echo "$ac_subst_vars" | sed 's/.*/&!$&$ac_delim/' &&
+  echo "_ACEOF"
+} >conf$$subs.sh ||
+  { { $as_echo "$as_me:$LINENO: error: could not make $CONFIG_STATUS" >&5
+$as_echo "$as_me: error: could not make $CONFIG_STATUS" >&2;}
+   { (exit 1); exit 1; }; }
+ac_delim_num=`echo "$ac_subst_vars" | grep -c '$'`
+ac_delim='%!_!# '
+for ac_last_try in false false false false false :; do
+  . ./conf$$subs.sh ||
+    { { $as_echo "$as_me:$LINENO: error: could not make $CONFIG_STATUS" >&5
+$as_echo "$as_me: error: could not make $CONFIG_STATUS" >&2;}
+   { (exit 1); exit 1; }; }
 
-# No need to generate the scripts if there are no CONFIG_FILES.
-# This happens for instance when ./config.status config.h
-if test -n "\$CONFIG_FILES"; then
-  # Protect against being on the right side of a sed subst in config.status.
-  sed 's/,@/@@/; s/@,/@@/; s/,;t t\$/@;t t/; /@;t t\$/s/[\\\\&,]/\\\\&/g;
-   s/@@/,@/; s/@@/@,/; s/@;t t\$/,;t t/' >\$tmp/subs.sed <<\\CEOF
-s, at SHELL@,$SHELL,;t t
-s, at PATH_SEPARATOR@,$PATH_SEPARATOR,;t t
-s, at PACKAGE_NAME@,$PACKAGE_NAME,;t t
-s, at PACKAGE_TARNAME@,$PACKAGE_TARNAME,;t t
-s, at PACKAGE_VERSION@,$PACKAGE_VERSION,;t t
-s, at PACKAGE_STRING@,$PACKAGE_STRING,;t t
-s, at PACKAGE_BUGREPORT@,$PACKAGE_BUGREPORT,;t t
-s, at exec_prefix@,$exec_prefix,;t t
-s, at prefix@,$prefix,;t t
-s, at program_transform_name@,$program_transform_name,;t t
-s, at bindir@,$bindir,;t t
-s, at sbindir@,$sbindir,;t t
-s, at libexecdir@,$libexecdir,;t t
-s, at datadir@,$datadir,;t t
-s, at sysconfdir@,$sysconfdir,;t t
-s, at sharedstatedir@,$sharedstatedir,;t t
-s, at localstatedir@,$localstatedir,;t t
-s, at libdir@,$libdir,;t t
-s, at includedir@,$includedir,;t t
-s, at oldincludedir@,$oldincludedir,;t t
-s, at infodir@,$infodir,;t t
-s, at mandir@,$mandir,;t t
-s, at build_alias@,$build_alias,;t t
-s, at host_alias@,$host_alias,;t t
-s, at target_alias@,$target_alias,;t t
-s, at DEFS@,$DEFS,;t t
-s, at ECHO_C@,$ECHO_C,;t t
-s, at ECHO_N@,$ECHO_N,;t t
-s, at ECHO_T@,$ECHO_T,;t t
-s, at LIBS@,$LIBS,;t t
-s, at INSTALL_PROGRAM@,$INSTALL_PROGRAM,;t t
-s, at INSTALL_SCRIPT@,$INSTALL_SCRIPT,;t t
-s, at INSTALL_DATA@,$INSTALL_DATA,;t t
-s, at CYGPATH_W@,$CYGPATH_W,;t t
-s, at PACKAGE@,$PACKAGE,;t t
-s, at VERSION@,$VERSION,;t t
-s, at ACLOCAL@,$ACLOCAL,;t t
-s, at AUTOCONF@,$AUTOCONF,;t t
-s, at AUTOMAKE@,$AUTOMAKE,;t t
-s, at AUTOHEADER@,$AUTOHEADER,;t t
-s, at MAKEINFO@,$MAKEINFO,;t t
-s, at AMTAR@,$AMTAR,;t t
-s, at install_sh@,$install_sh,;t t
-s, at STRIP@,$STRIP,;t t
-s, at ac_ct_STRIP@,$ac_ct_STRIP,;t t
-s, at INSTALL_STRIP_PROGRAM@,$INSTALL_STRIP_PROGRAM,;t t
-s, at AWK@,$AWK,;t t
-s, at SET_MAKE@,$SET_MAKE,;t t
-s, at am__leading_dot@,$am__leading_dot,;t t
-s, at CC@,$CC,;t t
-s, at CFLAGS@,$CFLAGS,;t t
-s, at LDFLAGS@,$LDFLAGS,;t t
-s, at CPPFLAGS@,$CPPFLAGS,;t t
-s, at ac_ct_CC@,$ac_ct_CC,;t t
-s, at EXEEXT@,$EXEEXT,;t t
-s, at OBJEXT@,$OBJEXT,;t t
-s, at DEPDIR@,$DEPDIR,;t t
-s, at am__include@,$am__include,;t t
-s, at am__quote@,$am__quote,;t t
-s, at AMDEP_TRUE@,$AMDEP_TRUE,;t t
-s, at AMDEP_FALSE@,$AMDEP_FALSE,;t t
-s, at AMDEPBACKSLASH@,$AMDEPBACKSLASH,;t t
-s, at CCDEPMODE@,$CCDEPMODE,;t t
-s, at am__fastdepCC_TRUE@,$am__fastdepCC_TRUE,;t t
-s, at am__fastdepCC_FALSE@,$am__fastdepCC_FALSE,;t t
-s, at CXX@,$CXX,;t t
-s, at CXXFLAGS@,$CXXFLAGS,;t t
-s, at ac_ct_CXX@,$ac_ct_CXX,;t t
-s, at CXXDEPMODE@,$CXXDEPMODE,;t t
-s, at am__fastdepCXX_TRUE@,$am__fastdepCXX_TRUE,;t t
-s, at am__fastdepCXX_FALSE@,$am__fastdepCXX_FALSE,;t t
-s, at RANLIB@,$RANLIB,;t t
-s, at ac_ct_RANLIB@,$ac_ct_RANLIB,;t t
-s, at CXXCPP@,$CXXCPP,;t t
-s, at EGREP@,$EGREP,;t t
-s, at PKG_CONFIG@,$PKG_CONFIG,;t t
-s, at WINDSTILLE_DEPS_CFLAGS@,$WINDSTILLE_DEPS_CFLAGS,;t t
-s, at WINDSTILLE_DEPS_LIBS@,$WINDSTILLE_DEPS_LIBS,;t t
-s, at LIBOBJS@,$LIBOBJS,;t t
-s, at LTLIBOBJS@,$LTLIBOBJS,;t t
-CEOF
+  ac_delim_n=`sed -n "s/.*$ac_delim\$/X/p" conf$$subs.awk | grep -c X`
+  if test $ac_delim_n = $ac_delim_num; then
+    break
+  elif $ac_last_try; then
+    { { $as_echo "$as_me:$LINENO: error: could not make $CONFIG_STATUS" >&5
+$as_echo "$as_me: error: could not make $CONFIG_STATUS" >&2;}
+   { (exit 1); exit 1; }; }
+  else
+    ac_delim="$ac_delim!$ac_delim _$ac_delim!! "
+  fi
+done
+rm -f conf$$subs.sh
 
+cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
+cat >>"\$tmp/subs1.awk" <<\\_ACAWK &&
 _ACEOF
+sed -n '
+h
+s/^/S["/; s/!.*/"]=/
+p
+g
+s/^[^!]*!//
+:repl
+t repl
+s/'"$ac_delim"'$//
+t delim
+:nl
+h
+s/\(.\{148\}\).*/\1/
+t more1
+s/["\\]/\\&/g; s/^/"/; s/$/\\n"\\/
+p
+n
+b repl
+:more1
+s/["\\]/\\&/g; s/^/"/; s/$/"\\/
+p
+g
+s/.\{148\}//
+t nl
+:delim
+h
+s/\(.\{148\}\).*/\1/
+t more2
+s/["\\]/\\&/g; s/^/"/; s/$/"/
+p
+b
+:more2
+s/["\\]/\\&/g; s/^/"/; s/$/"\\/
+p
+g
+s/.\{148\}//
+t delim
+' <conf$$subs.awk | sed '
+/^[^""]/{
+  N
+  s/\n//
+}
+' >>$CONFIG_STATUS || ac_write_fail=1
+rm -f conf$$subs.awk
+cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
+_ACAWK
+cat >>"\$tmp/subs1.awk" <<_ACAWK &&
+  for (key in S) S_is_set[key] = 1
+  FS = ""
 
-  cat >>$CONFIG_STATUS <<\_ACEOF
-  # Split the substitutions into bite-sized pieces for seds with
-  # small command number limits, like on Digital OSF/1 and HP-UX.
-  ac_max_sed_lines=48
-  ac_sed_frag=1 # Number of current file.
-  ac_beg=1 # First line for current file.
-  ac_end=$ac_max_sed_lines # Line after last line for current file.
-  ac_more_lines=:
-  ac_sed_cmds=
-  while $ac_more_lines; do
-    if test $ac_beg -gt 1; then
-      sed "1,${ac_beg}d; ${ac_end}q" $tmp/subs.sed >$tmp/subs.frag
-    else
-      sed "${ac_end}q" $tmp/subs.sed >$tmp/subs.frag
-    fi
-    if test ! -s $tmp/subs.frag; then
-      ac_more_lines=false
-    else
-      # The purpose of the label and of the branching condition is to
-      # speed up the sed processing (if there are no `@' at all, there
-      # is no need to browse any of the substitutions).
-      # These are the two extra sed commands mentioned above.
-      (echo ':t
-  /@[a-zA-Z_][a-zA-Z_0-9]*@/!b' && cat $tmp/subs.frag) >$tmp/subs-$ac_sed_frag.sed
-      if test -z "$ac_sed_cmds"; then
-  	ac_sed_cmds="sed -f $tmp/subs-$ac_sed_frag.sed"
-      else
-  	ac_sed_cmds="$ac_sed_cmds | sed -f $tmp/subs-$ac_sed_frag.sed"
-      fi
-      ac_sed_frag=`expr $ac_sed_frag + 1`
-      ac_beg=$ac_end
-      ac_end=`expr $ac_end + $ac_max_sed_lines`
-    fi
-  done
-  if test -z "$ac_sed_cmds"; then
-    ac_sed_cmds=cat
-  fi
+}
+{
+  line = $ 0
+  nfields = split(line, field, "@")
+  substed = 0
+  len = length(field[1])
+  for (i = 2; i < nfields; i++) {
+    key = field[i]
+    keylen = length(key)
+    if (S_is_set[key]) {
+      value = S[key]
+      line = substr(line, 1, len) "" value "" substr(line, len + keylen + 3)
+      len += length(value) + length(field[++i])
+      substed = 1
+    } else
+      len += 1 + keylen
+  }
+
+  print line
+}
+
+_ACAWK
+_ACEOF
+cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
+if sed "s/$ac_cr//" < /dev/null > /dev/null 2>&1; then
+  sed "s/$ac_cr\$//; s/$ac_cr/$ac_cs_awk_cr/g"
+else
+  cat
+fi < "$tmp/subs1.awk" > "$tmp/subs.awk" \
+  || { { $as_echo "$as_me:$LINENO: error: could not setup config files machinery" >&5
+$as_echo "$as_me: error: could not setup config files machinery" >&2;}
+   { (exit 1); exit 1; }; }
+_ACEOF
+
+# VPATH may cause trouble with some makes, so we remove $(srcdir),
+# ${srcdir} and @srcdir@ from VPATH if srcdir is ".", strip leading and
+# trailing colons and then remove the whole line if VPATH becomes empty
+# (actually we leave an empty line to preserve line numbers).
+if test "x$srcdir" = x.; then
+  ac_vpsub='/^[	 ]*VPATH[	 ]*=/{
+s/:*\$(srcdir):*/:/
+s/:*\${srcdir}:*/:/
+s/:*@srcdir@:*/:/
+s/^\([^=]*=[	 ]*\):*/\1/
+s/:*$//
+s/^[^=]*=[	 ]*$//
+}'
+fi
+
+cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
 fi # test -n "$CONFIG_FILES"
 
+# Set up the scripts for CONFIG_HEADERS section.
+# No need to generate them if there are no CONFIG_HEADERS.
+# This happens for instance with `./config.status Makefile'.
+if test -n "$CONFIG_HEADERS"; then
+cat >"$tmp/defines.awk" <<\_ACAWK ||
+BEGIN {
 _ACEOF
-cat >>$CONFIG_STATUS <<\_ACEOF
-for ac_file in : $CONFIG_FILES; do test "x$ac_file" = x: && continue
-  # Support "outfile[:infile[:infile...]]", defaulting infile="outfile.in".
-  case $ac_file in
-  - | *:- | *:-:* ) # input from stdin
-        cat >$tmp/stdin
-        ac_file_in=`echo "$ac_file" | sed 's,[^:]*:,,'`
-        ac_file=`echo "$ac_file" | sed 's,:.*,,'` ;;
-  *:* ) ac_file_in=`echo "$ac_file" | sed 's,[^:]*:,,'`
-        ac_file=`echo "$ac_file" | sed 's,:.*,,'` ;;
-  * )   ac_file_in=$ac_file.in ;;
+
+# Transform confdefs.h into an awk script `defines.awk', embedded as
+# here-document in config.status, that substitutes the proper values into
+# config.h.in to produce config.h.
+
+# Create a delimiter string that does not exist in confdefs.h, to ease
+# handling of long lines.
+ac_delim='%!_!# '
+for ac_last_try in false false :; do
+  ac_t=`sed -n "/$ac_delim/p" confdefs.h`
+  if test -z "$ac_t"; then
+    break
+  elif $ac_last_try; then
+    { { $as_echo "$as_me:$LINENO: error: could not make $CONFIG_HEADERS" >&5
+$as_echo "$as_me: error: could not make $CONFIG_HEADERS" >&2;}
+   { (exit 1); exit 1; }; }
+  else
+    ac_delim="$ac_delim!$ac_delim _$ac_delim!! "
+  fi
+done
+
+# For the awk script, D is an array of macro values keyed by name,
+# likewise P contains macro parameters if any.  Preserve backslash
+# newline sequences.
+
+ac_word_re=[_$as_cr_Letters][_$as_cr_alnum]*
+sed -n '
+s/.\{148\}/&'"$ac_delim"'/g
+t rset
+:rset
+s/^[	 ]*#[	 ]*define[	 ][	 ]*/ /
+t def
+d
+:def
+s/\\$//
+t bsnl
+s/["\\]/\\&/g
+s/^ \('"$ac_word_re"'\)\(([^()]*)\)[	 ]*\(.*\)/P["\1"]="\2"\
+D["\1"]=" \3"/p
+s/^ \('"$ac_word_re"'\)[	 ]*\(.*\)/D["\1"]=" \2"/p
+d
+:bsnl
+s/["\\]/\\&/g
+s/^ \('"$ac_word_re"'\)\(([^()]*)\)[	 ]*\(.*\)/P["\1"]="\2"\
+D["\1"]=" \3\\\\\\n"\\/p
+t cont
+s/^ \('"$ac_word_re"'\)[	 ]*\(.*\)/D["\1"]=" \2\\\\\\n"\\/p
+t cont
+d
+:cont
+n
+s/.\{148\}/&'"$ac_delim"'/g
+t clear
+:clear
+s/\\$//
+t bsnlc
+s/["\\]/\\&/g; s/^/"/; s/$/"/p
+d
+:bsnlc
+s/["\\]/\\&/g; s/^/"/; s/$/\\\\\\n"\\/p
+b cont
+' <confdefs.h | sed '
+s/'"$ac_delim"'/"\\\
+"/g' >>$CONFIG_STATUS || ac_write_fail=1
+
+cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
+  for (key in D) D_is_set[key] = 1
+  FS = ""
+}
+/^[\t ]*#[\t ]*(define|undef)[\t ]+$ac_word_re([\t (]|\$)/ {
+  line = \$ 0
+  split(line, arg, " ")
+  if (arg[1] == "#") {
+    defundef = arg[2]
+    mac1 = arg[3]
+  } else {
+    defundef = substr(arg[1], 2)
+    mac1 = arg[2]
+  }
+  split(mac1, mac2, "(") #)
+  macro = mac2[1]
+  prefix = substr(line, 1, index(line, defundef) - 1)
+  if (D_is_set[macro]) {
+    # Preserve the white space surrounding the "#".
+    print prefix "define", macro P[macro] D[macro]
+    next
+  } else {
+    # Replace #undef with comments.  This is necessary, for example,
+    # in the case of _POSIX_SOURCE, which is predefined and required
+    # on some systems where configure will not decide to define it.
+    if (defundef == "undef") {
+      print "/*", prefix defundef, macro, "*/"
+      next
+    }
+  }
+}
+{ print }
+_ACAWK
+_ACEOF
+cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
+  { { $as_echo "$as_me:$LINENO: error: could not setup config headers machinery" >&5
+$as_echo "$as_me: error: could not setup config headers machinery" >&2;}
+   { (exit 1); exit 1; }; }
+fi # test -n "$CONFIG_HEADERS"
+
+
+eval set X "  :F $CONFIG_FILES  :H $CONFIG_HEADERS    :C $CONFIG_COMMANDS"
+shift
+for ac_tag
+do
+  case $ac_tag in
+  :[FHLC]) ac_mode=$ac_tag; continue;;
   esac
+  case $ac_mode$ac_tag in
+  :[FHL]*:*);;
+  :L* | :C*:*) { { $as_echo "$as_me:$LINENO: error: invalid tag $ac_tag" >&5
+$as_echo "$as_me: error: invalid tag $ac_tag" >&2;}
+   { (exit 1); exit 1; }; };;
+  :[FH]-) ac_tag=-:-;;
+  :[FH]*) ac_tag=$ac_tag:$ac_tag.in;;
+  esac
+  ac_save_IFS=$IFS
+  IFS=:
+  set x $ac_tag
+  IFS=$ac_save_IFS
+  shift
+  ac_file=$1
+  shift
 
-  # Compute @srcdir@, @top_srcdir@, and @INSTALL@ for subdirectories.
-  ac_dir=`(dirname "$ac_file") 2>/dev/null ||
+  case $ac_mode in
+  :L) ac_source=$1;;
+  :[FH])
+    ac_file_inputs=
+    for ac_f
+    do
+      case $ac_f in
+      -) ac_f="$tmp/stdin";;
+      *) # Look for the file first in the build tree, then in the source tree
+	 # (if the path is not absolute).  The absolute path cannot be DOS-style,
+	 # because $ac_f cannot contain `:'.
+	 test -f "$ac_f" ||
+	   case $ac_f in
+	   [\\/$]*) false;;
+	   *) test -f "$srcdir/$ac_f" && ac_f="$srcdir/$ac_f";;
+	   esac ||
+	   { { $as_echo "$as_me:$LINENO: error: cannot find input file: $ac_f" >&5
+$as_echo "$as_me: error: cannot find input file: $ac_f" >&2;}
+   { (exit 1); exit 1; }; };;
+      esac
+      case $ac_f in *\'*) ac_f=`$as_echo "$ac_f" | sed "s/'/'\\\\\\\\''/g"`;; esac
+      ac_file_inputs="$ac_file_inputs '$ac_f'"
+    done
+
+    # Let's still pretend it is `configure' which instantiates (i.e., don't
+    # use $as_me), people would be surprised to read:
+    #    /* config.h.  Generated by config.status.  */
+    configure_input='Generated from '`
+	  $as_echo "$*" | sed 's|^[^:]*/||;s|:[^:]*/|, |g'
+	`' by configure.'
+    if test x"$ac_file" != x-; then
+      configure_input="$ac_file.  $configure_input"
+      { $as_echo "$as_me:$LINENO: creating $ac_file" >&5
+$as_echo "$as_me: creating $ac_file" >&6;}
+    fi
+    # Neutralize special characters interpreted by sed in replacement strings.
+    case $configure_input in #(
+    *\&* | *\|* | *\\* )
+       ac_sed_conf_input=`$as_echo "$configure_input" |
+       sed 's/[\\\\&|]/\\\\&/g'`;; #(
+    *) ac_sed_conf_input=$configure_input;;
+    esac
+
+    case $ac_tag in
+    *:-:* | *:-) cat >"$tmp/stdin" \
+      || { { $as_echo "$as_me:$LINENO: error: could not create $ac_file" >&5
+$as_echo "$as_me: error: could not create $ac_file" >&2;}
+   { (exit 1); exit 1; }; } ;;
+    esac
+    ;;
+  esac
+
+  ac_dir=`$as_dirname -- "$ac_file" ||
 $as_expr X"$ac_file" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-         X"$ac_file" : 'X\(//\)[^/]' \| \
-         X"$ac_file" : 'X\(//\)$' \| \
-         X"$ac_file" : 'X\(/\)' \| \
-         .     : '\(.\)' 2>/dev/null ||
-echo X"$ac_file" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{ s//\1/; q; }
-  	  /^X\(\/\/\)[^/].*/{ s//\1/; q; }
-  	  /^X\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\(\/\).*/{ s//\1/; q; }
-  	  s/.*/./; q'`
-  { if $as_mkdir_p; then
-    mkdir -p "$ac_dir"
-  else
-    as_dir="$ac_dir"
+	 X"$ac_file" : 'X\(//\)[^/]' \| \
+	 X"$ac_file" : 'X\(//\)$' \| \
+	 X"$ac_file" : 'X\(/\)' \| . 2>/dev/null ||
+$as_echo X"$ac_file" |
+    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)[^/].*/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\).*/{
+	    s//\1/
+	    q
+	  }
+	  s/.*/./; q'`
+  { as_dir="$ac_dir"
+  case $as_dir in #(
+  -*) as_dir=./$as_dir;;
+  esac
+  test -d "$as_dir" || { $as_mkdir_p && mkdir -p "$as_dir"; } || {
     as_dirs=
-    while test ! -d "$as_dir"; do
-      as_dirs="$as_dir $as_dirs"
-      as_dir=`(dirname "$as_dir") 2>/dev/null ||
+    while :; do
+      case $as_dir in #(
+      *\'*) as_qdir=`$as_echo "$as_dir" | sed "s/'/'\\\\\\\\''/g"`;; #'(
+      *) as_qdir=$as_dir;;
+      esac
+      as_dirs="'$as_qdir' $as_dirs"
+      as_dir=`$as_dirname -- "$as_dir" ||
 $as_expr X"$as_dir" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-         X"$as_dir" : 'X\(//\)[^/]' \| \
-         X"$as_dir" : 'X\(//\)$' \| \
-         X"$as_dir" : 'X\(/\)' \| \
-         .     : '\(.\)' 2>/dev/null ||
-echo X"$as_dir" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{ s//\1/; q; }
-  	  /^X\(\/\/\)[^/].*/{ s//\1/; q; }
-  	  /^X\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\(\/\).*/{ s//\1/; q; }
-  	  s/.*/./; q'`
+	 X"$as_dir" : 'X\(//\)[^/]' \| \
+	 X"$as_dir" : 'X\(//\)$' \| \
+	 X"$as_dir" : 'X\(/\)' \| . 2>/dev/null ||
+$as_echo X"$as_dir" |
+    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)[^/].*/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\).*/{
+	    s//\1/
+	    q
+	  }
+	  s/.*/./; q'`
+      test -d "$as_dir" && break
     done
-    test ! -n "$as_dirs" || mkdir $as_dirs
-  fi || { { echo "$as_me:$LINENO: error: cannot create directory \"$ac_dir\"" >&5
-echo "$as_me: error: cannot create directory \"$ac_dir\"" >&2;}
+    test -z "$as_dirs" || eval "mkdir $as_dirs"
+  } || test -d "$as_dir" || { { $as_echo "$as_me:$LINENO: error: cannot create directory $as_dir" >&5
+$as_echo "$as_me: error: cannot create directory $as_dir" >&2;}
    { (exit 1); exit 1; }; }; }
-
   ac_builddir=.
 
-if test "$ac_dir" != .; then
-  ac_dir_suffix=/`echo "$ac_dir" | sed 's,^\.[\\/],,'`
-  # A "../" for each directory in $ac_dir_suffix.
-  ac_top_builddir=`echo "$ac_dir_suffix" | sed 's,/[^\\/]*,../,g'`
-else
-  ac_dir_suffix= ac_top_builddir=
-fi
+case "$ac_dir" in
+.) ac_dir_suffix= ac_top_builddir_sub=. ac_top_build_prefix= ;;
+*)
+  ac_dir_suffix=/`$as_echo "$ac_dir" | sed 's|^\.[\\/]||'`
+  # A ".." for each directory in $ac_dir_suffix.
+  ac_top_builddir_sub=`$as_echo "$ac_dir_suffix" | sed 's|/[^\\/]*|/..|g;s|/||'`
+  case $ac_top_builddir_sub in
+  "") ac_top_builddir_sub=. ac_top_build_prefix= ;;
+  *)  ac_top_build_prefix=$ac_top_builddir_sub/ ;;
+  esac ;;
+esac
+ac_abs_top_builddir=$ac_pwd
+ac_abs_builddir=$ac_pwd$ac_dir_suffix
+# for backward compatibility:
+ac_top_builddir=$ac_top_build_prefix
 
 case $srcdir in
-  .)  # No --srcdir option.  We are building in place.
+  .)  # We are building in place.
     ac_srcdir=.
-    if test -z "$ac_top_builddir"; then
-       ac_top_srcdir=.
-    else
-       ac_top_srcdir=`echo $ac_top_builddir | sed 's,/$,,'`
-    fi ;;
-  [\\/]* | ?:[\\/]* )  # Absolute path.
+    ac_top_srcdir=$ac_top_builddir_sub
+    ac_abs_top_srcdir=$ac_pwd ;;
+  [\\/]* | ?:[\\/]* )  # Absolute name.
     ac_srcdir=$srcdir$ac_dir_suffix;
-    ac_top_srcdir=$srcdir ;;
-  *) # Relative path.
-    ac_srcdir=$ac_top_builddir$srcdir$ac_dir_suffix
-    ac_top_srcdir=$ac_top_builddir$srcdir ;;
+    ac_top_srcdir=$srcdir
+    ac_abs_top_srcdir=$srcdir ;;
+  *) # Relative name.
+    ac_srcdir=$ac_top_build_prefix$srcdir$ac_dir_suffix
+    ac_top_srcdir=$ac_top_build_prefix$srcdir
+    ac_abs_top_srcdir=$ac_pwd/$srcdir ;;
 esac
-# Don't blindly perform a `cd "$ac_dir"/$ac_foo && pwd` since $ac_foo can be
-# absolute.
-ac_abs_builddir=`cd "$ac_dir" && cd $ac_builddir && pwd`
-ac_abs_top_builddir=`cd "$ac_dir" && cd ${ac_top_builddir}. && pwd`
-ac_abs_srcdir=`cd "$ac_dir" && cd $ac_srcdir && pwd`
-ac_abs_top_srcdir=`cd "$ac_dir" && cd $ac_top_srcdir && pwd`
+ac_abs_srcdir=$ac_abs_top_srcdir$ac_dir_suffix
 
 
+  case $ac_mode in
+  :F)
+  #
+  # CONFIG_FILE
+  #
+
   case $INSTALL in
   [\\/$]* | ?:[\\/]* ) ac_INSTALL=$INSTALL ;;
-  *) ac_INSTALL=$ac_top_builddir$INSTALL ;;
+  *) ac_INSTALL=$ac_top_build_prefix$INSTALL ;;
   esac
+_ACEOF
 
-  if test x"$ac_file" != x-; then
-    { echo "$as_me:$LINENO: creating $ac_file" >&5
-echo "$as_me: creating $ac_file" >&6;}
-    rm -f "$ac_file"
-  fi
-  # Let's still pretend it is `configure' which instantiates (i.e., don't
-  # use $as_me), people would be surprised to read:
-  #    /* config.h.  Generated by config.status.  */
-  if test x"$ac_file" = x-; then
-    configure_input=
-  else
-    configure_input="$ac_file.  "
-  fi
-  configure_input=$configure_input"Generated from `echo $ac_file_in |
-                                     sed 's,.*/,,'` by configure."
+cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
+# If the template does not know about datarootdir, expand it.
+# FIXME: This hack should be removed a few years after 2.60.
+ac_datarootdir_hack=; ac_datarootdir_seen=
 
-  # First look for the input files in the build tree, otherwise in the
-  # src tree.
-  ac_file_inputs=`IFS=:
-    for f in $ac_file_in; do
-      case $f in
-      -) echo $tmp/stdin ;;
-      [\\/$]*)
-         # Absolute (can't be DOS-style, as IFS=:)
-         test -f "$f" || { { echo "$as_me:$LINENO: error: cannot find input file: $f" >&5
-echo "$as_me: error: cannot find input file: $f" >&2;}
-   { (exit 1); exit 1; }; }
-         echo $f;;
-      *) # Relative
-         if test -f "$f"; then
-           # Build tree
-           echo $f
-         elif test -f "$srcdir/$f"; then
-           # Source tree
-           echo $srcdir/$f
-         else
-           # /dev/null tree
-           { { echo "$as_me:$LINENO: error: cannot find input file: $f" >&5
-echo "$as_me: error: cannot find input file: $f" >&2;}
-   { (exit 1); exit 1; }; }
-         fi;;
-      esac
-    done` || { (exit 1); exit 1; }
+ac_sed_dataroot='
+/datarootdir/ {
+  p
+  q
+}
+/@datadir@/p
+/@docdir@/p
+/@infodir@/p
+/@localedir@/p
+/@mandir@/p
+'
+case `eval "sed -n \"\$ac_sed_dataroot\" $ac_file_inputs"` in
+*datarootdir*) ac_datarootdir_seen=yes;;
+*@datadir@*|*@docdir@*|*@infodir@*|*@localedir@*|*@mandir@*)
+  { $as_echo "$as_me:$LINENO: WARNING: $ac_file_inputs seems to ignore the --datarootdir setting" >&5
+$as_echo "$as_me: WARNING: $ac_file_inputs seems to ignore the --datarootdir setting" >&2;}
 _ACEOF
-cat >>$CONFIG_STATUS <<_ACEOF
-  sed "$ac_vpsub
+cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
+  ac_datarootdir_hack='
+  s&@datadir@&$datadir&g
+  s&@docdir@&$docdir&g
+  s&@infodir@&$infodir&g
+  s&@localedir@&$localedir&g
+  s&@mandir@&$mandir&g
+    s&\\\${datarootdir}&$datarootdir&g' ;;
+esac
+_ACEOF
+
+# Neutralize VPATH when `$srcdir' = `.'.
+# Shell code in configure.ac might set extrasub.
+# FIXME: do we really want to maintain this feature?
+cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
+ac_sed_extra="$ac_vpsub
 $extrasub
 _ACEOF
-cat >>$CONFIG_STATUS <<\_ACEOF
+cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
 :t
 /@[a-zA-Z_][a-zA-Z_0-9]*@/!b
-s, at configure_input@,$configure_input,;t t
-s, at srcdir@,$ac_srcdir,;t t
-s, at abs_srcdir@,$ac_abs_srcdir,;t t
-s, at top_srcdir@,$ac_top_srcdir,;t t
-s, at abs_top_srcdir@,$ac_abs_top_srcdir,;t t
-s, at builddir@,$ac_builddir,;t t
-s, at abs_builddir@,$ac_abs_builddir,;t t
-s, at top_builddir@,$ac_top_builddir,;t t
-s, at abs_top_builddir@,$ac_abs_top_builddir,;t t
-s, at INSTALL@,$ac_INSTALL,;t t
-" $ac_file_inputs | (eval "$ac_sed_cmds") >$tmp/out
-  rm -f $tmp/stdin
-  if test x"$ac_file" != x-; then
-    mv $tmp/out $ac_file
-  else
-    cat $tmp/out
-    rm -f $tmp/out
-  fi
+s|@configure_input@|$ac_sed_conf_input|;t t
+s&@top_builddir@&$ac_top_builddir_sub&;t t
+s&@top_build_prefix@&$ac_top_build_prefix&;t t
+s&@srcdir@&$ac_srcdir&;t t
+s&@abs_srcdir@&$ac_abs_srcdir&;t t
+s&@top_srcdir@&$ac_top_srcdir&;t t
+s&@abs_top_srcdir@&$ac_abs_top_srcdir&;t t
+s&@builddir@&$ac_builddir&;t t
+s&@abs_builddir@&$ac_abs_builddir&;t t
+s&@abs_top_builddir@&$ac_abs_top_builddir&;t t
+s&@INSTALL@&$ac_INSTALL&;t t
+$ac_datarootdir_hack
+"
+eval sed \"\$ac_sed_extra\" "$ac_file_inputs" | $AWK -f "$tmp/subs.awk" >$tmp/out \
+  || { { $as_echo "$as_me:$LINENO: error: could not create $ac_file" >&5
+$as_echo "$as_me: error: could not create $ac_file" >&2;}
+   { (exit 1); exit 1; }; }
 
-done
-_ACEOF
-cat >>$CONFIG_STATUS <<\_ACEOF
+test -z "$ac_datarootdir_hack$ac_datarootdir_seen" &&
+  { ac_out=`sed -n '/\${datarootdir}/p' "$tmp/out"`; test -n "$ac_out"; } &&
+  { ac_out=`sed -n '/^[	 ]*datarootdir[	 ]*:*=/p' "$tmp/out"`; test -z "$ac_out"; } &&
+  { $as_echo "$as_me:$LINENO: WARNING: $ac_file contains a reference to the variable \`datarootdir'
+which seems to be undefined.  Please make sure it is defined." >&5
+$as_echo "$as_me: WARNING: $ac_file contains a reference to the variable \`datarootdir'
+which seems to be undefined.  Please make sure it is defined." >&2;}
 
-#
-# CONFIG_HEADER section.
-#
-
-# These sed commands are passed to sed as "A NAME B NAME C VALUE D", where
-# NAME is the cpp macro being defined and VALUE is the value it is being given.
-#
-# ac_d sets the value in "#define NAME VALUE" lines.
-ac_dA='s,^\([ 	]*\)#\([ 	]*define[ 	][ 	]*\)'
-ac_dB='[ 	].*$,\1#\2'
-ac_dC=' '
-ac_dD=',;t'
-# ac_u turns "#undef NAME" without trailing blanks into "#define NAME VALUE".
-ac_uA='s,^\([ 	]*\)#\([ 	]*\)undef\([ 	][ 	]*\)'
-ac_uB='$,\1#\2define\3'
-ac_uC=' '
-ac_uD=',;t'
-
-for ac_file in : $CONFIG_HEADERS; do test "x$ac_file" = x: && continue
-  # Support "outfile[:infile[:infile...]]", defaulting infile="outfile.in".
+  rm -f "$tmp/stdin"
   case $ac_file in
-  - | *:- | *:-:* ) # input from stdin
-        cat >$tmp/stdin
-        ac_file_in=`echo "$ac_file" | sed 's,[^:]*:,,'`
-        ac_file=`echo "$ac_file" | sed 's,:.*,,'` ;;
-  *:* ) ac_file_in=`echo "$ac_file" | sed 's,[^:]*:,,'`
-        ac_file=`echo "$ac_file" | sed 's,:.*,,'` ;;
-  * )   ac_file_in=$ac_file.in ;;
-  esac
-
-  test x"$ac_file" != x- && { echo "$as_me:$LINENO: creating $ac_file" >&5
-echo "$as_me: creating $ac_file" >&6;}
-
-  # First look for the input files in the build tree, otherwise in the
-  # src tree.
-  ac_file_inputs=`IFS=:
-    for f in $ac_file_in; do
-      case $f in
-      -) echo $tmp/stdin ;;
-      [\\/$]*)
-         # Absolute (can't be DOS-style, as IFS=:)
-         test -f "$f" || { { echo "$as_me:$LINENO: error: cannot find input file: $f" >&5
-echo "$as_me: error: cannot find input file: $f" >&2;}
+  -) cat "$tmp/out" && rm -f "$tmp/out";;
+  *) rm -f "$ac_file" && mv "$tmp/out" "$ac_file";;
+  esac \
+  || { { $as_echo "$as_me:$LINENO: error: could not create $ac_file" >&5
+$as_echo "$as_me: error: could not create $ac_file" >&2;}
    { (exit 1); exit 1; }; }
-         echo $f;;
-      *) # Relative
-         if test -f "$f"; then
-           # Build tree
-           echo $f
-         elif test -f "$srcdir/$f"; then
-           # Source tree
-           echo $srcdir/$f
-         else
-           # /dev/null tree
-           { { echo "$as_me:$LINENO: error: cannot find input file: $f" >&5
-echo "$as_me: error: cannot find input file: $f" >&2;}
+ ;;
+  :H)
+  #
+  # CONFIG_HEADER
+  #
+  if test x"$ac_file" != x-; then
+    {
+      $as_echo "/* $configure_input  */" \
+      && eval '$AWK -f "$tmp/defines.awk"' "$ac_file_inputs"
+    } >"$tmp/config.h" \
+      || { { $as_echo "$as_me:$LINENO: error: could not create $ac_file" >&5
+$as_echo "$as_me: error: could not create $ac_file" >&2;}
    { (exit 1); exit 1; }; }
-         fi;;
-      esac
-    done` || { (exit 1); exit 1; }
-  # Remove the trailing spaces.
-  sed 's/[ 	]*$//' $ac_file_inputs >$tmp/in
-
-_ACEOF
-
-# Transform confdefs.h into two sed scripts, `conftest.defines' and
-# `conftest.undefs', that substitutes the proper values into
-# config.h.in to produce config.h.  The first handles `#define'
-# templates, and the second `#undef' templates.
-# And first: Protect against being on the right side of a sed subst in
-# config.status.  Protect against being in an unquoted here document
-# in config.status.
-rm -f conftest.defines conftest.undefs
-# Using a here document instead of a string reduces the quoting nightmare.
-# Putting comments in sed scripts is not portable.
-#
-# `end' is used to avoid that the second main sed command (meant for
-# 0-ary CPP macros) applies to n-ary macro definitions.
-# See the Autoconf documentation for `clear'.
-cat >confdef2sed.sed <<\_ACEOF
-s/[\\&,]/\\&/g
-s,[\\$`],\\&,g
-t clear
-: clear
-s,^[ 	]*#[ 	]*define[ 	][ 	]*\([^ 	(][^ 	(]*\)\(([^)]*)\)[ 	]*\(.*\)$,${ac_dA}\1${ac_dB}\1\2${ac_dC}\3${ac_dD},gp
-t end
-s,^[ 	]*#[ 	]*define[ 	][ 	]*\([^ 	][^ 	]*\)[ 	]*\(.*\)$,${ac_dA}\1${ac_dB}\1${ac_dC}\2${ac_dD},gp
-: end
-_ACEOF
-# If some macros were called several times there might be several times
-# the same #defines, which is useless.  Nevertheless, we may not want to
-# sort them, since we want the *last* AC-DEFINE to be honored.
-uniq confdefs.h | sed -n -f confdef2sed.sed >conftest.defines
-sed 's/ac_d/ac_u/g' conftest.defines >conftest.undefs
-rm -f confdef2sed.sed
-
-# This sed command replaces #undef with comments.  This is necessary, for
-# example, in the case of _POSIX_SOURCE, which is predefined and required
-# on some systems where configure will not decide to define it.
-cat >>conftest.undefs <<\_ACEOF
-s,^[ 	]*#[ 	]*undef[ 	][ 	]*[a-zA-Z_][a-zA-Z_0-9]*,/* & */,
-_ACEOF
-
-# Break up conftest.defines because some shells have a limit on the size
-# of here documents, and old seds have small limits too (100 cmds).
-echo '  # Handle all the #define templates only if necessary.' >>$CONFIG_STATUS
-echo '  if grep "^[ 	]*#[ 	]*define" $tmp/in >/dev/null; then' >>$CONFIG_STATUS
-echo '  # If there are no defines, we may have an empty if/fi' >>$CONFIG_STATUS
-echo '  :' >>$CONFIG_STATUS
-rm -f conftest.tail
-while grep . conftest.defines >/dev/null
-do
-  # Write a limited-size here document to $tmp/defines.sed.
-  echo '  cat >$tmp/defines.sed <<CEOF' >>$CONFIG_STATUS
-  # Speed up: don't consider the non `#define' lines.
-  echo '/^[ 	]*#[ 	]*define/!b' >>$CONFIG_STATUS
-  # Work around the forget-to-reset-the-flag bug.
-  echo 't clr' >>$CONFIG_STATUS
-  echo ': clr' >>$CONFIG_STATUS
-  sed ${ac_max_here_lines}q conftest.defines >>$CONFIG_STATUS
-  echo 'CEOF
-  sed -f $tmp/defines.sed $tmp/in >$tmp/out
-  rm -f $tmp/in
-  mv $tmp/out $tmp/in
-' >>$CONFIG_STATUS
-  sed 1,${ac_max_here_lines}d conftest.defines >conftest.tail
-  rm -f conftest.defines
-  mv conftest.tail conftest.defines
-done
-rm -f conftest.defines
-echo '  fi # grep' >>$CONFIG_STATUS
-echo >>$CONFIG_STATUS
-
-# Break up conftest.undefs because some shells have a limit on the size
-# of here documents, and old seds have small limits too (100 cmds).
-echo '  # Handle all the #undef templates' >>$CONFIG_STATUS
-rm -f conftest.tail
-while grep . conftest.undefs >/dev/null
-do
-  # Write a limited-size here document to $tmp/undefs.sed.
-  echo '  cat >$tmp/undefs.sed <<CEOF' >>$CONFIG_STATUS
-  # Speed up: don't consider the non `#undef'
-  echo '/^[ 	]*#[ 	]*undef/!b' >>$CONFIG_STATUS
-  # Work around the forget-to-reset-the-flag bug.
-  echo 't clr' >>$CONFIG_STATUS
-  echo ': clr' >>$CONFIG_STATUS
-  sed ${ac_max_here_lines}q conftest.undefs >>$CONFIG_STATUS
-  echo 'CEOF
-  sed -f $tmp/undefs.sed $tmp/in >$tmp/out
-  rm -f $tmp/in
-  mv $tmp/out $tmp/in
-' >>$CONFIG_STATUS
-  sed 1,${ac_max_here_lines}d conftest.undefs >conftest.tail
-  rm -f conftest.undefs
-  mv conftest.tail conftest.undefs
-done
-rm -f conftest.undefs
-
-cat >>$CONFIG_STATUS <<\_ACEOF
-  # Let's still pretend it is `configure' which instantiates (i.e., don't
-  # use $as_me), people would be surprised to read:
-  #    /* config.h.  Generated by config.status.  */
-  if test x"$ac_file" = x-; then
-    echo "/* Generated by configure.  */" >$tmp/config.h
-  else
-    echo "/* $ac_file.  Generated by configure.  */" >$tmp/config.h
-  fi
-  cat $tmp/in >>$tmp/config.h
-  rm -f $tmp/in
-  if test x"$ac_file" != x-; then
-    if diff $ac_file $tmp/config.h >/dev/null 2>&1; then
-      { echo "$as_me:$LINENO: $ac_file is unchanged" >&5
-echo "$as_me: $ac_file is unchanged" >&6;}
+    if diff "$ac_file" "$tmp/config.h" >/dev/null 2>&1; then
+      { $as_echo "$as_me:$LINENO: $ac_file is unchanged" >&5
+$as_echo "$as_me: $ac_file is unchanged" >&6;}
     else
-      ac_dir=`(dirname "$ac_file") 2>/dev/null ||
-$as_expr X"$ac_file" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-         X"$ac_file" : 'X\(//\)[^/]' \| \
-         X"$ac_file" : 'X\(//\)$' \| \
-         X"$ac_file" : 'X\(/\)' \| \
-         .     : '\(.\)' 2>/dev/null ||
-echo X"$ac_file" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{ s//\1/; q; }
-  	  /^X\(\/\/\)[^/].*/{ s//\1/; q; }
-  	  /^X\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\(\/\).*/{ s//\1/; q; }
-  	  s/.*/./; q'`
-      { if $as_mkdir_p; then
-    mkdir -p "$ac_dir"
-  else
-    as_dir="$ac_dir"
-    as_dirs=
-    while test ! -d "$as_dir"; do
-      as_dirs="$as_dir $as_dirs"
-      as_dir=`(dirname "$as_dir") 2>/dev/null ||
-$as_expr X"$as_dir" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-         X"$as_dir" : 'X\(//\)[^/]' \| \
-         X"$as_dir" : 'X\(//\)$' \| \
-         X"$as_dir" : 'X\(/\)' \| \
-         .     : '\(.\)' 2>/dev/null ||
-echo X"$as_dir" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{ s//\1/; q; }
-  	  /^X\(\/\/\)[^/].*/{ s//\1/; q; }
-  	  /^X\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\(\/\).*/{ s//\1/; q; }
-  	  s/.*/./; q'`
-    done
-    test ! -n "$as_dirs" || mkdir $as_dirs
-  fi || { { echo "$as_me:$LINENO: error: cannot create directory \"$ac_dir\"" >&5
-echo "$as_me: error: cannot create directory \"$ac_dir\"" >&2;}
-   { (exit 1); exit 1; }; }; }
-
-      rm -f $ac_file
-      mv $tmp/config.h $ac_file
+      rm -f "$ac_file"
+      mv "$tmp/config.h" "$ac_file" \
+	|| { { $as_echo "$as_me:$LINENO: error: could not create $ac_file" >&5
+$as_echo "$as_me: error: could not create $ac_file" >&2;}
+   { (exit 1); exit 1; }; }
     fi
   else
-    cat $tmp/config.h
-    rm -f $tmp/config.h
+    $as_echo "/* $configure_input  */" \
+      && eval '$AWK -f "$tmp/defines.awk"' "$ac_file_inputs" \
+      || { { $as_echo "$as_me:$LINENO: error: could not create -" >&5
+$as_echo "$as_me: error: could not create -" >&2;}
+   { (exit 1); exit 1; }; }
   fi
-# Compute $ac_file's index in $config_headers.
+# Compute "$ac_file"'s index in $config_headers.
 _am_stamp_count=1
 for _am_header in $config_headers :; do
   case $_am_header in
-    $ac_file | $ac_file:* )
+    "$ac_file" | "$ac_file":* )
       break ;;
     * )
       _am_stamp_count=`expr $_am_stamp_count + 1` ;;
   esac
 done
-echo "timestamp for $ac_file" >`(dirname $ac_file) 2>/dev/null ||
-$as_expr X$ac_file : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-         X$ac_file : 'X\(//\)[^/]' \| \
-         X$ac_file : 'X\(//\)$' \| \
-         X$ac_file : 'X\(/\)' \| \
-         .     : '\(.\)' 2>/dev/null ||
-echo X$ac_file |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{ s//\1/; q; }
-  	  /^X\(\/\/\)[^/].*/{ s//\1/; q; }
-  	  /^X\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\(\/\).*/{ s//\1/; q; }
-  	  s/.*/./; q'`/stamp-h$_am_stamp_count
-done
-_ACEOF
-cat >>$CONFIG_STATUS <<\_ACEOF
+echo "timestamp for "$ac_file"" >`$as_dirname -- "$ac_file" ||
+$as_expr X"$ac_file" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
+	 X"$ac_file" : 'X\(//\)[^/]' \| \
+	 X"$ac_file" : 'X\(//\)$' \| \
+	 X"$ac_file" : 'X\(/\)' \| . 2>/dev/null ||
+$as_echo X"$ac_file" |
+    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)[^/].*/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\).*/{
+	    s//\1/
+	    q
+	  }
+	  s/.*/./; q'`/stamp-h$_am_stamp_count
+ ;;
 
-#
-# CONFIG_COMMANDS section.
-#
-for ac_file in : $CONFIG_COMMANDS; do test "x$ac_file" = x: && continue
-  ac_dest=`echo "$ac_file" | sed 's,:.*,,'`
-  ac_source=`echo "$ac_file" | sed 's,[^:]*:,,'`
-  ac_dir=`(dirname "$ac_dest") 2>/dev/null ||
-$as_expr X"$ac_dest" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-         X"$ac_dest" : 'X\(//\)[^/]' \| \
-         X"$ac_dest" : 'X\(//\)$' \| \
-         X"$ac_dest" : 'X\(/\)' \| \
-         .     : '\(.\)' 2>/dev/null ||
-echo X"$ac_dest" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{ s//\1/; q; }
-  	  /^X\(\/\/\)[^/].*/{ s//\1/; q; }
-  	  /^X\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\(\/\).*/{ s//\1/; q; }
-  	  s/.*/./; q'`
-  ac_builddir=.
+  :C)  { $as_echo "$as_me:$LINENO: executing $ac_file commands" >&5
+$as_echo "$as_me: executing $ac_file commands" >&6;}
+ ;;
+  esac
 
-if test "$ac_dir" != .; then
-  ac_dir_suffix=/`echo "$ac_dir" | sed 's,^\.[\\/],,'`
-  # A "../" for each directory in $ac_dir_suffix.
-  ac_top_builddir=`echo "$ac_dir_suffix" | sed 's,/[^\\/]*,../,g'`
-else
-  ac_dir_suffix= ac_top_builddir=
-fi
 
-case $srcdir in
-  .)  # No --srcdir option.  We are building in place.
-    ac_srcdir=.
-    if test -z "$ac_top_builddir"; then
-       ac_top_srcdir=.
-    else
-       ac_top_srcdir=`echo $ac_top_builddir | sed 's,/$,,'`
-    fi ;;
-  [\\/]* | ?:[\\/]* )  # Absolute path.
-    ac_srcdir=$srcdir$ac_dir_suffix;
-    ac_top_srcdir=$srcdir ;;
-  *) # Relative path.
-    ac_srcdir=$ac_top_builddir$srcdir$ac_dir_suffix
-    ac_top_srcdir=$ac_top_builddir$srcdir ;;
-esac
-# Don't blindly perform a `cd "$ac_dir"/$ac_foo && pwd` since $ac_foo can be
-# absolute.
-ac_abs_builddir=`cd "$ac_dir" && cd $ac_builddir && pwd`
-ac_abs_top_builddir=`cd "$ac_dir" && cd ${ac_top_builddir}. && pwd`
-ac_abs_srcdir=`cd "$ac_dir" && cd $ac_srcdir && pwd`
-ac_abs_top_srcdir=`cd "$ac_dir" && cd $ac_top_srcdir && pwd`
-
-
-  { echo "$as_me:$LINENO: executing $ac_dest commands" >&5
-echo "$as_me: executing $ac_dest commands" >&6;}
-  case $ac_dest in
-    depfiles ) test x"$AMDEP_TRUE" != x"" || for mf in $CONFIG_FILES; do
+  case $ac_file$ac_mode in
+    "depfiles":C) test x"$AMDEP_TRUE" != x"" || for mf in $CONFIG_FILES; do
   # Strip MF so we end up with the name of the file.
   mf=`echo "$mf" | sed -e 's/:.*$//'`
   # Check whether this is an Automake generated Makefile or not.
@@ -5357,18 +6505,29 @@
   # each Makefile.in and add a new line on top of each file to say so.
   # So let's grep whole file.
   if grep '^#.*generated by automake' $mf > /dev/null 2>&1; then
-    dirpart=`(dirname "$mf") 2>/dev/null ||
+    dirpart=`$as_dirname -- "$mf" ||
 $as_expr X"$mf" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-         X"$mf" : 'X\(//\)[^/]' \| \
-         X"$mf" : 'X\(//\)$' \| \
-         X"$mf" : 'X\(/\)' \| \
-         .     : '\(.\)' 2>/dev/null ||
-echo X"$mf" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{ s//\1/; q; }
-  	  /^X\(\/\/\)[^/].*/{ s//\1/; q; }
-  	  /^X\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\(\/\).*/{ s//\1/; q; }
-  	  s/.*/./; q'`
+	 X"$mf" : 'X\(//\)[^/]' \| \
+	 X"$mf" : 'X\(//\)$' \| \
+	 X"$mf" : 'X\(/\)' \| . 2>/dev/null ||
+$as_echo X"$mf" |
+    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)[^/].*/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\).*/{
+	    s//\1/
+	    q
+	  }
+	  s/.*/./; q'`
   else
     continue
   fi
@@ -5396,60 +6555,91 @@
        sed -e 's/\$(DEPDIR)/'"$DEPDIR"'/g' -e 's/\$U/'"$U"'/g'`; do
     # Make sure the directory exists.
     test -f "$dirpart/$file" && continue
-    fdir=`(dirname "$file") 2>/dev/null ||
+    fdir=`$as_dirname -- "$file" ||
 $as_expr X"$file" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-         X"$file" : 'X\(//\)[^/]' \| \
-         X"$file" : 'X\(//\)$' \| \
-         X"$file" : 'X\(/\)' \| \
-         .     : '\(.\)' 2>/dev/null ||
-echo X"$file" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{ s//\1/; q; }
-  	  /^X\(\/\/\)[^/].*/{ s//\1/; q; }
-  	  /^X\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\(\/\).*/{ s//\1/; q; }
-  	  s/.*/./; q'`
-    { if $as_mkdir_p; then
-    mkdir -p $dirpart/$fdir
-  else
-    as_dir=$dirpart/$fdir
+	 X"$file" : 'X\(//\)[^/]' \| \
+	 X"$file" : 'X\(//\)$' \| \
+	 X"$file" : 'X\(/\)' \| . 2>/dev/null ||
+$as_echo X"$file" |
+    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)[^/].*/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\).*/{
+	    s//\1/
+	    q
+	  }
+	  s/.*/./; q'`
+    { as_dir=$dirpart/$fdir
+  case $as_dir in #(
+  -*) as_dir=./$as_dir;;
+  esac
+  test -d "$as_dir" || { $as_mkdir_p && mkdir -p "$as_dir"; } || {
     as_dirs=
-    while test ! -d "$as_dir"; do
-      as_dirs="$as_dir $as_dirs"
-      as_dir=`(dirname "$as_dir") 2>/dev/null ||
+    while :; do
+      case $as_dir in #(
+      *\'*) as_qdir=`$as_echo "$as_dir" | sed "s/'/'\\\\\\\\''/g"`;; #'(
+      *) as_qdir=$as_dir;;
+      esac
+      as_dirs="'$as_qdir' $as_dirs"
+      as_dir=`$as_dirname -- "$as_dir" ||
 $as_expr X"$as_dir" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-         X"$as_dir" : 'X\(//\)[^/]' \| \
-         X"$as_dir" : 'X\(//\)$' \| \
-         X"$as_dir" : 'X\(/\)' \| \
-         .     : '\(.\)' 2>/dev/null ||
-echo X"$as_dir" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{ s//\1/; q; }
-  	  /^X\(\/\/\)[^/].*/{ s//\1/; q; }
-  	  /^X\(\/\/\)$/{ s//\1/; q; }
-  	  /^X\(\/\).*/{ s//\1/; q; }
-  	  s/.*/./; q'`
+	 X"$as_dir" : 'X\(//\)[^/]' \| \
+	 X"$as_dir" : 'X\(//\)$' \| \
+	 X"$as_dir" : 'X\(/\)' \| . 2>/dev/null ||
+$as_echo X"$as_dir" |
+    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)[^/].*/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\).*/{
+	    s//\1/
+	    q
+	  }
+	  s/.*/./; q'`
+      test -d "$as_dir" && break
     done
-    test ! -n "$as_dirs" || mkdir $as_dirs
-  fi || { { echo "$as_me:$LINENO: error: cannot create directory $dirpart/$fdir" >&5
-echo "$as_me: error: cannot create directory $dirpart/$fdir" >&2;}
+    test -z "$as_dirs" || eval "mkdir $as_dirs"
+  } || test -d "$as_dir" || { { $as_echo "$as_me:$LINENO: error: cannot create directory $as_dir" >&5
+$as_echo "$as_me: error: cannot create directory $as_dir" >&2;}
    { (exit 1); exit 1; }; }; }
-
     # echo "creating $dirpart/$file"
     echo '# dummy' > "$dirpart/$file"
   done
 done
  ;;
+
   esac
-done
-_ACEOF
+done # for ac_tag
 
-cat >>$CONFIG_STATUS <<\_ACEOF
 
 { (exit 0); exit 0; }
 _ACEOF
 chmod +x $CONFIG_STATUS
 ac_clean_files=$ac_clean_files_save
 
+test $ac_write_fail = 0 ||
+  { { $as_echo "$as_me:$LINENO: error: write failure creating $CONFIG_STATUS" >&5
+$as_echo "$as_me: error: write failure creating $CONFIG_STATUS" >&2;}
+   { (exit 1); exit 1; }; }
 
+
 # configure is writing to config.log, and then calls config.status.
 # config.status does its own redirection, appending to config.log.
 # Unfortunately, on DOS this fails, as config.log is still kept open
@@ -5470,5 +6660,9 @@
   # would make configure fail if this is the last instruction.
   $ac_cs_success || { (exit 1); exit 1; }
 fi
+if test -n "$ac_unrecognized_opts" && test "$enable_option_checking" != no; then
+  { $as_echo "$as_me:$LINENO: WARNING: unrecognized options: $ac_unrecognized_opts" >&5
+$as_echo "$as_me: WARNING: unrecognized options: $ac_unrecognized_opts" >&2;}
+fi
 
 

Modified: branches/windstille-0.1.x/configure.ac
===================================================================
--- tags/windstille-0.1.0/configure.ac	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/configure.ac	2009-09-27 12:06:38 UTC (rev 3268)
@@ -14,14 +14,14 @@
 AC_CHECK_LIB(guile, scm_boot_guile)
 AC_CHECK_HEADER(guile/gh.h)
 
-REQUIRED_CLANLIB_VERSION="0.7.3"
+REQUIRED_CLANLIB_VERSION="0.8.0"
 
 PKG_CHECK_MODULES(WINDSTILLE_DEPS,
  [
-  clanCore    >= $REQUIRED_CLANLIB_VERSION
-  clanApp     >= $REQUIRED_CLANLIB_VERSION
-  clanDisplay >= $REQUIRED_CLANLIB_VERSION
-  clanGL      >= $REQUIRED_CLANLIB_VERSION
+  clanCore-0.8    >= $REQUIRED_CLANLIB_VERSION
+  clanApp-0.8     >= $REQUIRED_CLANLIB_VERSION
+  clanDisplay-0.8 >= $REQUIRED_CLANLIB_VERSION
+  clanGL-0.8      >= $REQUIRED_CLANLIB_VERSION
 dnl clanSound   >= $REQUIRED_CLANLIB_VERSION
 dnl clanMikMod  >= $REQUIRED_CLANLIB_VERSION
 dnl clanVorbis  >= $REQUIRED_CLANLIB_VERSION

Added: branches/windstille-0.1.x/data/Makefile.am
===================================================================
--- tags/windstille-0.1.0/data/Makefile.am	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/data/Makefile.am	2009-09-27 12:06:38 UTC (rev 3268)
@@ -0,0 +1,55 @@
+##  $Id: Makefile.am,v 1.6 2003/12/02 16:50:41 grumbel Exp $
+## 
+##  Windstille - A free Lemmings clone
+##  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+##
+##  This program is free software; you can redistribute it and/or
+##  modify it under the terms of the GNU General Public License
+##  as published by the Free Software Foundation; either version 2
+##  of the License, or (at your option) any later version.
+##
+##  This program is distributed in the hope that it will be useful,
+##  but WITHOUT ANY WARRANTY; without even the implied warranty of
+##  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+##  GNU General Public License for more details.
+## 
+##  You should have received a copy of the GNU General Public License
+##  along with this program; if not, write to the Free Software
+##  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+EXTRA_DIST = \
+  windstille.xml \
+  tiles.scm \
+  tiles.xml \
+  game.scm \
+  editor.scm \
+  gui/gui.xml \
+  gui/*/*.tga \
+  gui/*/*.png \
+  $(wildcard music/*.ogg) \
+  $(wildcard levels/*.scm) \
+  $(wildcard controller/*.scm) \
+  $(wildcard *.scm) \
+  $(wildcard images/*.png images/*.jpg) \
+  $(wildcard images/tiles/*.png) \
+  $(wildcard images/bonus/*.jpg) \
+  $(wildcard images/diamond/*.png) \
+  $(wildcard images/hero_run/*.png) \
+  $(wildcard images/hero_dead/*.png)
+
+nobase_pkgdata_DATA = $(EXTRA_DIST)
+
+tiles.xml:
+	echo "<resources>" >  $@
+	echo "  <section name=\"tiles\">" >> $@
+	for i in images/tiles/*.png; do \
+		echo "    <sprite name=\""`basename $${i%%.png}`"\">"; \
+		echo "      <image file=\"$$i\" />"; \
+		echo "    </sprite>"; \
+	done  >> $@;
+	echo "  </section>" >> $@
+	echo "</resources>" >> $@
+
+.PHONY: tiles.xml
+
+# EOF #

Added: branches/windstille-0.1.x/data/editor.scm
===================================================================
--- tags/windstille-0.1.0/data/editor.scm	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/data/editor.scm	2009-09-27 12:06:38 UTC (rev 3268)
@@ -0,0 +1,229 @@
+(use-modules (ice-9 pretty-print))
+
+(load "helper.scm")
+
+(define screen-width  (screen-get-width))
+(define screen-height (screen-get-height))
+(define empty (lambda () #f))
+(define *tileeditor* #f)
+(define *tileeditor-window* #f)
+(define *tileselector-window* #f)
+(define last-files (list *windstille-levelfile*))
+(define datadir  *windstille-datadir*)
+
+(define (push-last-file filename)
+  (cond ((not (string=? filename (get-last-file)))
+         (set! last-files (cons filename last-files)))))
+
+(define (get-last-file)
+  (car last-files))
+
+(define (serialize-level)
+  `(windstille-level
+    (properties
+     (name "Hello World")
+     (width  ,(map-get-width))
+     (height ,(map-get-height)))
+    (scripts ,@(map-get-scripts))
+    (tilemap
+     (data ,@(map-get-data 1)))
+    (background-tilemap
+     (data ,@(map-get-data 0)))
+    (diamond-map
+     ,@(diamond-map-get-data)
+     )))
+
+(define (save-map filename)
+  (let ((level (serialize-level)))
+    (with-output-to-file filename
+      (lambda ()
+        (pretty-print level)
+        (newline)))))
+
+(gui-create-button-func 0 0
+                        50 25 "New" 
+                        (lambda () 
+                          (show-new-level-dialog)))
+(gui-create-button-func 0 25
+                        50 25 "Load" 
+                        (lambda ()
+                          (simple-file-dialog "Load a level..." (get-last-file)
+                                              (lambda (filename)
+                                                (editor-load filename)
+                                                (push-last-file filename)))))
+(gui-create-button-func 0 50
+                        50 25 "Save" 
+                        (lambda () 
+                          (simple-file-dialog "Save a level..." (get-last-file)
+                                              (lambda (filename) 
+                                                (save-map filename)
+                                                (push-last-file filename)))))
+
+(gui-create-button-func 0 75 50 25 "Play" 
+                        (lambda ()
+                          (let ((file (tmpnam)))
+                            (save-map file)
+                            (game-play file)
+                            (delete-file file))))
+
+(gui-create-button-func 0 100 50 25 "Quit" 
+                        (lambda ()
+                          (gui-quit)))
+
+(gui-create-button-func 100 0
+                        80 25 "Background" 
+                        (lambda () (tilemap-set-active-layer 0)))
+
+(gui-create-button-func 180 0
+                        80 25 "Foreground" 
+                        (lambda () (tilemap-set-active-layer 1)))
+
+(gui-create-button-func 260 0
+                        80 25 "Diamonds" 
+                        (lambda ()
+                          (tilemap-set-active-layer 1)))
+
+
+(gui-create-button-func (- screen-width 80)
+                        (- screen-height 25)
+                        80 25 "Shell" 
+                        windstille:repl)
+
+(gui-create-button-func 0
+                        (- screen-height 25)
+                        100 25 "Tile" 
+                        (lambda ()
+                          (editor-set-tool 0)))
+
+(gui-create-button-func (+ 100)
+                        (- screen-height 25)
+                        100 25 "Diamond" 
+                        (lambda ()
+                          (editor-set-tool 2)))
+
+(gui-create-button-func (+ 200)
+                        (- screen-height 25)
+                        100 25 "Objects" 
+                        (lambda ()
+                          (editor-set-brush-tile 0)))
+
+(gui-create-button-func (+ 300)
+                        (- screen-height 25)
+                        100 25 "Select"
+                        (lambda ()
+                          (editor-set-tool 1)))
+
+(gui-create-button-func (+ 450)
+                        (- screen-height 25)
+                        80 25 "Tile Editor"
+                        (lambda ()
+                          (gui-component-toggle-visibility *tileeditor-window*)))
+
+(gui-create-button-func (+ 570)
+                        (- screen-height 25)
+                        80 25 "Tile Selector"
+                        (lambda ()
+                          (gui-component-toggle-visibility *tileselector-window*)))
+
+(define (show-new-level-dialog)
+  (let ((window (gui-create-window 200 200 200 160 "Property Window")))
+    (gui-push-component (gui-window-get-client-area window))
+
+    (gui-create-label 10 10 "Width: ")
+    (gui-create-label 10 30 "Height: ")
+
+    (let ((width  (gui-create-inputbox 100 10 50 25 "50"))
+          (height (gui-create-inputbox 100 30 50 25 "50"))
+
+          (ok     (gui-create-button 90 100 50 25 "Ok"))
+          (cancel (gui-create-button 140 100 50 25 "Cancel")))
+      
+      (gui-component-on-click ok 
+                              (lambda ()   
+                                (editor-new (string->number (gui-inputbox-get-text width))
+                                            (string->number (gui-inputbox-get-text height)))
+                                (gui-hide-component window)))
+
+      (gui-component-on-click cancel
+                              (lambda () 
+                                (gui-hide-component window)))
+      (gui-pop-component))))
+
+(define (simple-file-dialog title filename func)
+  (let ((window (gui-create-window 200 200 250 160 title)))
+    (gui-push-component (gui-window-get-client-area window))
+    (gui-create-label 10 10 "Filename: ")
+    (let ((ok       (gui-create-button 90 100 50 25 "Ok"))
+          (cancel   (gui-create-button 140 100 50 25 "Cancel"))
+          (filename (gui-create-inputbox 10 30 180 30 filename))
+          (browse   (gui-create-button 190 30 50 20 "Browse...")))
+
+      (gui-component-on-click ok 
+                              (lambda ()   
+                                (func (gui-inputbox-get-text filename))
+                                (gui-hide-component window)))
+
+      (gui-component-on-click cancel
+                              (lambda () 
+                                (gui-hide-component window)))
+
+      (gui-component-on-click browse
+                              (lambda ()
+                                (gui-file-dialog (gui-inputbox-get-text filename)
+                                                 (lambda (filename)
+                                                   (gui-inputbox-set-text filename)))))
+
+      (gui-pop-component)
+      window)))
+
+(define (dump-tile-definitions filename)
+  (with-output-to-file filename
+    (lambda ()
+      (pretty-print (get-tile-defs))
+      (newline)
+      (display ";; EOF ;;\n"))))
+
+
+(let ((window (gui-create-window 200 200 250 180 "Tile Editor")))
+  (gui-push-component (gui-window-get-client-area window))
+  (set! *tileeditor* (editor-add-tileeditor 10 10))
+  (let ((gettile (gui-create-button 148 10 75 25 "Get Tile"))
+        (dump    (gui-create-button 148 95 75 25 "Dump")))
+    
+    (gui-component-on-click gettile
+                            (lambda ()
+                              (tileeditor-set-tile *tileeditor* (editor-get-brush-tile))))
+    (gui-component-on-click dump
+                            (lambda () 
+                              (dump-tile-definitions (string-append datadir "tiles.scm"))))
+
+    (gui-component-on-close window (lambda ()
+                                     (gui-hide-component window)))
+
+    (set! *tileeditor-window* window))
+  (gui-pop-component))
+
+
+(let ((window (gui-create-window 200 200 300 130 "Disclaimer")))
+  (gui-push-component (gui-window-get-client-area window))
+  (gui-create-label 10 10
+                    (string-append "This editor is buggy and might crash quite a bit,\n"
+                                   "it isn't really end user ready at the moment. \n"
+                                   "It is included here for those who might find it usefull\n"
+                                   "anyway, but don't complain when it locks your system"))
+  (gui-create-button-func 210 70 75 25 "Ok"
+                          (lambda ()
+                            (gui-hide-component window)))
+  (gui-pop-component))
+
+(let ((window (gui-create-window 600 0 200 400 "TileSelector")))
+  (gui-push-component (gui-window-get-client-area window))
+  (tile-selector-create (- screen-width (* 3 64)) 0 3 8)
+  (gui-component-on-close window (lambda ()
+                                   (gui-hide-component window)))
+  (set! *tileselector-window* window)
+  (gui-pop-component))
+
+(gui-hide-component *tileeditor-window*)
+
+;; EOF ;;

Added: branches/windstille-0.1.x/data/game.scm
===================================================================
--- tags/windstille-0.1.0/data/game.scm	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/data/game.scm	2009-09-27 12:06:38 UTC (rev 3268)
@@ -0,0 +1,140 @@
+(use-modules (ice-9 format))
+(load "helper.scm")
+
+(define (*key-down-handler* key)
+  (display "Keydown: ")
+  (display key)
+  (newline)
+  (cond ((string=? key "i")
+         (game-add-igel (+ (player-get-x) 0)
+                        (- (player-get-y) 300)))
+        ((string=? key "s")
+         (windstille:repl))
+
+        ((string=? key "p")
+         (toggle-pause))
+        
+        ((string=? key "d")
+         (dialog-show))
+
+        ((string=? key "1")
+         (set-game-speed 1.0))
+
+        ((string=? key "2")
+         (set-game-speed 2.0))
+
+        ((string=? key "3")
+         (set-game-speed .5))
+
+        ((string=? key "4")
+         (set-game-speed .25))
+
+        ((string=? key "5")
+         (set-game-speed .1))
+
+        ((string=? key "h")
+         (dialog-hide))
+        ))
+
+(define (*mouse-up-handler* x y)
+  #f)
+
+(define (*mouse-down-handler* x y)
+  (display (inexact->exact x))
+  (display " ")
+  (display (inexact->exact y))
+  (newline)
+
+  (cond (#t
+         (player-set-pos x y))
+        (else
+         (display "(game-add-igel ")
+         (display (inexact->exact x))
+         (display " ")
+         (display (inexact->exact y))
+         (display ")")
+         
+         (game-add-igel (inexact->exact x)
+                        (inexact->exact y))
+         (newline))))
+
+(define (toggle-pause)
+  (game-set-pause (not (game-get-pause))))
+
+(define (game-get-time-str)
+  (let* ((t (inexact->exact (game-get-time)))
+         (minutes (quotient  t 60))
+         (seconds (remainder t 60)))
+    (string-append (number->string minutes) 
+                   ":"
+                   (if (< seconds 10)
+                       "0" "")
+                   (number->string seconds))))
+
+
+(define save-player-position #f)
+(let ((x 10)
+      (y 45)
+      (buttons '())
+      (window (gui-create-window 20 20 300 200 "Position Save GUI")))
+
+  (gui-push-component (gui-window-get-client-area window))
+  (gui-create-button-func 10 10 100 25 "Save Position"
+                          (lambda () (save-player-position (inexact->exact (player-get-pos-x))
+                                                           (inexact->exact (player-get-pos-y)))))
+  (gui-create-button-func 115 10 100 25 "Clear"
+                          (lambda () 
+                            (for-each gui-remove-component buttons)
+                            (set! buttons '())
+                            (set! x 10)
+                            (set! y 45)))
+  (gui-pop-component)
+
+  (set! save-player-position
+        (lambda (player-x player-y)
+          (gui-push-component (gui-window-get-client-area window))
+          (set! buttons
+                (cons (gui-create-button-func x y 70 25 (format #f "~d, ~d" player-x player-y)
+                                              (lambda ()
+                                                (player-set-pos player-x player-y)))
+                      buttons))
+          (set! x (+ x 75))
+          (cond ((> x 220)
+                 (set! y (+ y 30))
+                 (set! x 10)))
+          (gui-pop-component))))
+
+(save-player-position 258 607)
+(save-player-position 3989 703)
+(save-player-position 7635 3391)
+(save-player-position 969 3263)
+
+(let ((window (gui-create-window 20 320 310 100 "Eval Scheme")))
+  (gui-push-component (gui-window-get-client-area window))
+  (let ((input  (gui-create-inputbox 10 10 240 30 ""))
+        (button (gui-create-button 255 10 50 25 "eval")))
+    (gui-component-on-click button
+                            (lambda ()
+                              (catch #t
+                                     (lambda () 
+                                       (eval-string (gui-inputbox-get-text input)))
+                                     (lambda err
+                                       (display "Error: ")(display err)(newline))))))
+  (gui-pop-component))
+
+(gui-create-button-func 0 0 100 25 "Hide Debug GUI"
+                        (lambda () (gui-hide)))
+
+;; Default to non-debug mode
+(gui-hide)
+
+;; (define array
+;;   (let ((data '(1 2 3 4 5)))
+;;     (make-procedure-with-setter 
+;;      (lambda (i)
+;;        (list-ref data i))
+;;      (lambda (i val)
+;;        (list-set! data i val))
+;;      )))
+
+;; EOF ;;

Added: branches/windstille-0.1.x/data/gui/checkbox/checked.tga
===================================================================
(Binary files differ)


Property changes on: branches/windstille-0.1.x/data/gui/checkbox/checked.tga
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/windstille-0.1.x/data/gui/checkbox/checked_disabled.tga
===================================================================
(Binary files differ)


Property changes on: branches/windstille-0.1.x/data/gui/checkbox/checked_disabled.tga
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/windstille-0.1.x/data/gui/checkbox/unchecked.tga
===================================================================
(Binary files differ)


Property changes on: branches/windstille-0.1.x/data/gui/checkbox/unchecked.tga
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/windstille-0.1.x/data/gui/checkbox/unchecked_disabled.tga
===================================================================
(Binary files differ)


Property changes on: branches/windstille-0.1.x/data/gui/checkbox/unchecked_disabled.tga
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/windstille-0.1.x/data/gui/fonts/font_black.tga
===================================================================
(Binary files differ)


Property changes on: branches/windstille-0.1.x/data/gui/fonts/font_black.tga
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/windstille-0.1.x/data/gui/fonts/font_gray.tga
===================================================================
(Binary files differ)


Property changes on: branches/windstille-0.1.x/data/gui/fonts/font_gray.tga
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/windstille-0.1.x/data/gui/gui.xml
===================================================================
--- tags/windstille-0.1.0/data/gui/gui.xml	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/data/gui/gui.xml	2009-09-27 12:06:38 UTC (rev 3268)
@@ -0,0 +1,111 @@
+<?xml version="1.0" encoding="latin-1" ?>
+<resources>
+	<section name="FontGlyphs">
+		<sprite name="font_black">
+			<image file="fonts/font_black.tga">
+				<alpha />
+			</image>
+		</sprite>
+		<sprite name="font_gray">
+			<image file="fonts/font_gray.tga">
+				<alpha />
+			</image>
+		</sprite>
+	</section>
+	<section name="Window">
+		<font name="font">
+			<bitmap glyphs="FontGlyphs/font_black" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~" />
+ 		</font>
+		<font name="font_disabled">
+			<bitmap glyphs="FontGlyphs/font_gray" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~" />
+		</font>
+	</section>
+	<section name="Button">
+		<font name="font">
+			<bitmap glyphs="FontGlyphs/font_black" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~" />
+		</font>
+		<font name="font_disabled">
+			<bitmap glyphs="FontGlyphs/font_gray" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~" />
+		</font>
+	</section>
+	<section name="InputBox">
+		<font name="font">
+			<bitmap glyphs="FontGlyphs/font_black" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~" />
+		</font>
+		<font name="font_disabled">
+			<bitmap glyphs="FontGlyphs/font_gray" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~" />
+		</font>
+	</section>
+	<section name="Label">
+		<font name="font">
+			<bitmap glyphs="FontGlyphs/font_black" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~" />
+		</font>
+	</section>
+	<section name="ListBox">
+		<font name="font">
+			<bitmap glyphs="FontGlyphs/font_black" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~" />
+		</font>
+	</section>
+	<section name="CheckBox">
+		<font name="font">
+			<bitmap glyphs="FontGlyphs/font_black" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~"/>
+		</font>
+		<font name="font_disabled">
+			<bitmap glyphs="FontGlyphs/font_gray" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~"/>
+		</bitmap>
+		<surface name="surface_checked" file="checkbox/checked.tga" />
+		<surface name="surface_unchecked" file="checkbox/unchecked.tga" />
+		<surface name="surface_checked_disabled" file="checkbox/checked_disabled.tga" />
+		<surface name="surface_unchecked_disabled" file="checkbox/unchecked_disabled.tga" />
+	</section>
+	<section name="RadioButton">
+		<font name="font">
+			<bitmap glyphs="FontGlyphs/font_black" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~"/>
+		</font>
+		<surface name="surface_checked" file="radiobutton/checked.tga" />
+		<surface name="surface_unchecked" file="radiobutton/unchecked.tga" />
+		<surface name="surface_checked_disabled" file="radiobutton/checked_disabled.tga" />
+		<surface name="surface_unchecked_disabled" file="radiobutton/unchecked_disabled.tga" />
+	</section>
+	<section name="TreeView">
+		<font name="font">
+			<bitmap glyphs="FontGlyphs/font_black" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~" />
+		</font>
+	</section>
+	<section name="TreeViewItem">
+		<font name="font">
+			<bitmap glyphs="FontGlyphs/font_black" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~" />
+		</font>
+	</section>
+	<section name="MessageBox">
+		<font name="font">
+			<bitmap glyphs="FontGlyphs/font_black" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~" />
+		</font>
+		<integer name="min_width" value="200" />
+		<boolean name="fixed_size_buttons" value="true" />
+		<integer name="min_button_width" value="80" />
+		<integer name="min_button_height" value="20" />
+	</section>
+	<section name="InputDialog">
+		<integer name="min_width" value="50" />
+		<boolean name="fixed_size_buttons" value="true" />
+		<integer name="min_button_width" value="80" />
+		<integer name="min_button_height" value="20" />
+	</section>
+
+	<section name="Menu">
+		<surface name="submenu_arrow" file="menu/arrow.png" />
+	</section>
+
+	<section name="MenuItem">
+		<font name="font">
+			<bitmap glyphs="FontGlyphs/font_black" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~" />
+ 		</font>
+		<font name="font_disabled">
+			<bitmap glyphs="FontGlyphs/font_gray" spacelen="4" letters="!'#$%&amp;'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_'abcdefghijklmnopqrstuvwxyz{|}~" />
+		</font>
+
+		<surface name="checked" file="menu/checked.png" />
+		<surface name="unchecked" file="menu/unchecked.png" />
+	</section>
+</resources>

Added: branches/windstille-0.1.x/data/gui/menu/arrow.png
===================================================================
(Binary files differ)


Property changes on: branches/windstille-0.1.x/data/gui/menu/arrow.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: branches/windstille-0.1.x/data/gui/menu/checked.png
===================================================================
(Binary files differ)


Property changes on: branches/windstille-0.1.x/data/gui/menu/checked.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: branches/windstille-0.1.x/data/gui/menu/unchecked.png
===================================================================
(Binary files differ)


Property changes on: branches/windstille-0.1.x/data/gui/menu/unchecked.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: branches/windstille-0.1.x/data/gui/radiobutton/checked.tga
===================================================================
(Binary files differ)


Property changes on: branches/windstille-0.1.x/data/gui/radiobutton/checked.tga
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/windstille-0.1.x/data/gui/radiobutton/checked_disabled.tga
===================================================================
(Binary files differ)


Property changes on: branches/windstille-0.1.x/data/gui/radiobutton/checked_disabled.tga
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/windstille-0.1.x/data/gui/radiobutton/unchecked.tga
===================================================================
(Binary files differ)


Property changes on: branches/windstille-0.1.x/data/gui/radiobutton/unchecked.tga
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/windstille-0.1.x/data/gui/radiobutton/unchecked_disabled.tga
===================================================================
(Binary files differ)


Property changes on: branches/windstille-0.1.x/data/gui/radiobutton/unchecked_disabled.tga
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: branches/windstille-0.1.x/data/tiles.scm
===================================================================
--- tags/windstille-0.1.0/data/tiles.scm	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/data/tiles.scm	2009-09-27 12:06:38 UTC (rev 3268)
@@ -0,0 +1,219 @@
+(windstille-tiles
+  (tile (id 1)
+        (image "tiles/tile1")
+        (colmap 255 255 255 255 255 255 255 255))
+  (tile (id 2)
+        (image "tiles/tile2")
+        (colmap 0 0 0 0 255 255 255 255))
+  (tile (id 3)
+        (image "tiles/tile3")
+        (colmap 0 0 0 0 1 3 31 255))
+  (tile (id 4)
+        (image "tiles/tile4")
+        (colmap 0 0 0 0 128 224 248 255))
+  (tile (id 5)
+        (image "tiles/tile5")
+        (colmap 0 0 255 255 255 255 0 0))
+  (tile (id 6)
+        (image "tiles/tile6")
+        (colmap 0 0 0 0 0 0 255 255))
+  (tile (id 7)
+        (image "tiles/tile7")
+        (colmap 0 0 0 15 15 15 255 255))
+  (tile (id 8)
+        (image "tiles/tile8")
+        (colmap 0 0 0 0 255 255 255 255))
+  (tile (id 9)
+        (image "tiles/tile9")
+        (colmap 0 0 240 240 192 192 0 0))
+  (tile (id 10)
+        (image "tiles/tile10")
+        (colmap 0 0 15 15 3 3 0 0))
+  (tile (id 11)
+        (image "tiles/tile11")
+        (colmap 0 0 0 0 0 0 0 0))
+  (tile (id 12)
+        (image "tiles/tile12")
+        (colmap 0 0 0 0 0 0 0 0))
+  (tile (id 13)
+        (image "tiles/tile13")
+        (colmap 0 0 0 0 0 0 0 0))
+  (tile (id 14)
+        (image "tiles/tile14")
+        (colmap 0 0 255 255 255 255 0 0))
+  (tile (id 15)
+        (image "tiles/tile15")
+        (colmap 0 0 3 7 31 127 255 255))
+  (tile (id 16)
+        (image "tiles/tile16")
+        (colmap 0 0 255 255 255 255 255 255))
+  (tile (id 17)
+        (image "tiles/tile17")
+        (colmap 0 0 192 224 248 254 255 255))
+  (tile (id 18)
+        (image "tiles/tile18")
+        (colmap 15 31 255 255 255 255 255 255))
+  (tile (id 19)
+        (image "tiles/tile19")
+        (colmap 240 248 255 255 255 255 255 255))
+  (tile (id 20)
+        (image "tiles/tile20")
+        (colmap 0 0 0 0 0 0 224 224))
+  (tile (id 21)
+        (image "tiles/tile21")
+        (colmap 0 0 0 0 0 0 1 7))
+  (tile (id 22)
+        (image "tiles/tile22")
+        (colmap 0 0 0 0 0 0 0 0))
+  (tile (id 23)
+        (image "tiles/tile23")
+        (colmap 0 0 0 0 126 126 60 0))
+  (tile (id 24)
+        (image "tiles/tile24")
+        (colmap 60 60 60 60 124 126 255 255))
+  (tile (id 25)
+        (image "tiles/tile25")
+        (colmap 255 255 255 255 255 255 255 0))
+  (tile (id 26)
+        (image "tiles/tile25")
+        (colmap 248 248 248 248 248 248 248 248))
+  (tile (id 27)
+        (image "tiles/tile27")
+        (colmap 248 248 248 248 252 252 255 255))
+  (tile (id 28)
+        (image "tiles/tile28")
+        (colmap 255 255 255 255 255 255 255 240))
+  (tile (id 29)
+        (image "tiles/tile29")
+        (colmap 0 0 0 0 0 0 255 255))
+  (tile (id 30)
+        (image "tiles/tile30")
+        (colmap 129 129 129 129 129 129 129 129))
+  (tile (id 31)
+        (image "tiles/tile31")
+        (colmap 0 0 0 0 0 0 129 129))
+  (tile (id 32)
+        (image "tiles/tile32")
+        (colmap 0 0 0 0 0 0 0 0))
+  (tile (id 33)
+        (image "tiles/tile33")
+        (colmap 129 129 129 129 129 129 0 0))
+  (tile (id 34)
+        (image "tiles/tile34")
+        (colmap 255 255 255 255 255 255 0 0))
+  (tile (id 35)
+        (image "tiles/tile35")
+        (colmap 0 0 0 0 0 0 240 252))
+  (tile (id 36)
+        (image "tiles/tile36")
+        (colmap 252 252 254 255 255 255 255 255))
+  (tile (id 37)
+        (image "tiles/tile36")
+        (colmap 0 0 0 0 255 255 255 255))
+  (tile (id 38)
+        (image "tiles/tile38")
+        (colmap 0 0 0 0 128 224 255 255))
+  (tile (id 39)
+        (image "tiles/air_air_brwn_brwn_1")
+        (colmap 0 0 0 0 255 255 255 255))
+  (tile (id 40)
+        (image "tiles/air_brwn_brwn_brwn_1")
+        (colmap 15 15 15 15 255 255 255 255))
+  (tile (id 41)
+        (image "tiles/air_brwn_brwn_air_1")
+        (colmap 15 15 15 15 15 15 15 15))
+  (tile (id 42)
+        (image "tiles/brwn_brwn_brwn_air_1")
+        (colmap 255 255 255 255 15 15 15 15))
+  (tile (id 43)
+        (image "tiles/brwn_brwn_air_air_1")
+        (colmap 255 255 255 255 0 0 0 0))
+  (tile (id 44)
+        (image "tiles/brwn_air_brwn_brwn_1")
+        (colmap 240 240 240 240 255 255 255 255))
+  (tile (id 45)
+        (image "tiles/brwn_brwn_air_brwn_1")
+        (colmap 255 255 255 255 240 240 240 240))
+  (tile (id 46)
+        (image "tiles/brwn_air_air_brwn_1")
+        (colmap 240 240 240 240 240 240 240 240))
+  (tile (id 47)
+        (image "tiles/brwn_brwn_brwn_air_1")
+        (colmap 15 15 15 15 255 255 255 255))
+  (tile (id 48)
+        (image "tiles/air_air_air_brwn_1")
+        (colmap 0 0 0 0 240 240 240 240))
+  (tile (id 49)
+        (image "tiles/brwn_air_air_air_1")
+        (colmap 240 240 240 240 0 0 0 0))
+  (tile (id 50)
+        (image "tiles/air_air_brwn_air_1")
+        (colmap 0 0 0 0 15 15 15 14))
+  (tile (id 51)
+        (image "tiles/air_brwn_air_air_1")
+        (colmap 15 15 15 15 0 0 0 0))
+  (tile (id 52)
+        (image "tiles/brwn_brwn_brwn_dbrw_1")
+        (colmap 255 255 255 255 255 255 255 255))
+  (tile (id 53)
+        (image "tiles/brwn_brwn_dbrw_brwn_1")
+        (colmap 255 255 255 255 255 255 255 255))
+  (tile (id 54)
+        (image "tiles/brwn_brwn_dbrw_dbrw_1")
+        (colmap 255 255 255 255 255 255 255 255))
+  (tile (id 55)
+        (image "tiles/brwn_dbrw_brwn_brwn_1")
+        (colmap 255 255 255 255 255 255 255 255))
+  (tile (id 56)
+        (image "tiles/brwn_dbrw_brwn_dbrw_1")
+        (colmap 255 255 255 255 255 255 255 255))
+  (tile (id 57)
+        (image "tiles/brwn_dbrw_dbrw_brwn_1")
+        (colmap 255 255 255 255 255 255 255 255))
+  (tile (id 58)
+        (image "tiles/brwn_dbrw_dbrw_dbrw_1")
+        (colmap 255 255 255 255 255 255 255 255))
+  (tile (id 59)
+        (image "tiles/dbrw_brwn_brwn_brwn_1")
+        (colmap 255 255 255 255 255 255 255 255))
+  (tile (id 60)
+        (image "tiles/dbrw_brwn_brwn_dbrw_1")
+        (colmap 255 255 255 255 255 255 255 255))
+  (tile (id 61)
+        (image "tiles/dbrw_brwn_dbrw_brwn_1")
+        (colmap 255 255 255 255 255 255 255 255))
+  (tile (id 62)
+        (image "tiles/dbrw_brwn_dbrw_dbrw_1")
+        (colmap 255 255 255 255 255 255 255 255))
+  (tile (id 63)
+        (image "tiles/dbrw_dbrw_brwn_brwn_1")
+        (colmap 255 255 255 255 255 255 255 255))
+  (tile (id 64)
+        (image "tiles/dbrw_dbrw_brwn_dbrw_1")
+        (colmap 255 255 255 255 255 255 255 255))
+  (tile (id 65)
+        (image "tiles/brwn_air_air_air_2")
+        (colmap 240 224 128 128 0 0 0 0))
+  (tile (id 66)
+        (image "tiles/air_brwn_air_air_2")
+        (colmap 15 15 7 7 0 0 0 0))
+  (tile (id 67)
+        (image "tiles/air_brwn_brwn_air_2")
+        (colmap 15 15 15 63 63 31 15 15))
+  (tile (id 68)
+        (image "tiles/brwn_brwn_air_brwn_2")
+        (colmap 255 255 255 255 254 252 248 240))
+  (tile (id 69)
+        (image "tiles/dbrw_dbrw_dbrw_brwn_1")
+        (colmap 255 255 255 255 254 252 248 240))
+  (tile (id 70)
+        (image "tiles/tree1")
+        (colmap 255 255 255 255 254 252 248 240))
+  (tile (id 71)
+        (image "tiles/dbrw_air_air_dbrw_1")
+        (colmap 240 240 240 240 240 240 240 240))
+  (tile (id 72)
+        (image "tiles/air_dbrw_dbrw_air_1")
+        (colmap 15 15 15 15 15 15 15 15)))
+
+;; EOF ;;

Added: branches/windstille-0.1.x/data/tiles.xml
===================================================================
--- tags/windstille-0.1.0/data/tiles.xml	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/data/tiles.xml	2009-09-27 12:06:38 UTC (rev 3268)
@@ -0,0 +1,7 @@
+<resources>
+  <section name="tiles">
+    <sprite name="level1">
+      <image file="images/tiles/*.png" />
+    </sprite>
+  </section>
+</resources>

Added: branches/windstille-0.1.x/data/windstille.scr
===================================================================
--- tags/windstille-0.1.0/data/windstille.scr	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/data/windstille.scr	2009-09-27 12:06:38 UTC (rev 3268)
@@ -0,0 +1,234 @@
+section powerup {
+	flash   = (type=sprite, image1 = images/powerup/flash.png);
+	laser   = (type=sprite, image1 = images/powerup/laser.png);
+	powerup = (type=sprite,	image1 = images/powerup/powerup.png);
+	shild   = (type=sprite, image1 = images/powerup/shild.png);
+	spread  = (type=sprite, image1 = images/powerup/spread.png);
+}
+
+bonusflyer = (type=sprite,
+	image1 = images/bonusflyer.png);
+
+section lights {
+	light1 = (type=sprite, image1 = images/light1.png);
+	light2 = (type=sprite, image1 = images/light2.png);
+	light3 = (type=sprite, image1 = images/light3.png);
+}
+
+nebular = (type=sprite, image1 = images/nebular.png);
+
+dog = (type=sprite,
+	play_speed = 500,
+
+	translation_hotspot = (top_left, 24, 42),
+
+	image1 = images/dog/frame1.png,
+	image2 = images/dog/frame2.png,
+	image3 = images/dog/frame3.png,
+	image4 = images/dog/frame4.png);
+
+section turrican {
+	jump = (type=sprite,
+		translation_hotspot = (top_left, 29, 82),
+		image1 = images/sprite_jump_east.png);
+
+//		frame1 = images/turrican_jump_east.png (type=surface);
+
+	walk = (type=sprite,
+		translation_hotspot = (top_left, 29, 85),
+		image1 = images/turrican_jump_east.png);
+
+	shild = (type=sprite, 
+		play_speed = 50,
+		image1 = images/shild/frame1.png,
+		image2 = images/shild/frame2.png);
+
+	sit = (type=sprite,
+		translation_hotspot = (top_left, 29, 90),
+		image1 = images/turrican_sit.png);
+
+	roll = (type=sprite,
+		translation_hotspot = (top_left, 29, 82),
+
+		image1 = images/turrican_roll/frame1.png,
+		image2 = images/turrican_roll/frame2.png,
+		image3 = images/turrican_roll/frame3.png,
+		image4 = images/turrican_roll/frame4.png);
+
+	stand = (type=sprite,
+		translation_hotspot = (top_left, 29, 82),
+		image1 = images/turrican_stand_east.png);
+	
+	walk = (type=sprite,
+		translation_hotspot = (top_left, 32, 74),
+
+		image1 = images/turrican_walk/frame1.png,
+		image2 = images/turrican_walk/frame2.png,
+		image3 = images/turrican_walk/frame3.png,
+		image4 = images/turrican_walk/frame4.png,
+		image5 = images/turrican_walk/frame5.png,
+		image6 = images/turrican_walk/frame6.png,
+		image7 = images/turrican_walk/frame7.png,
+		image8 = images/turrican_walk/frame8.png,
+		image9 = images/turrican_walk/frame9.png,
+		image10 = images/turrican_walk/frame10.png,
+		image11 = images/turrican_walk/frame11.png,
+		image12 = images/turrican_walk/frame12.png,
+		image13 = images/turrican_walk/frame13.png,
+		image14 = images/turrican_walk/frame14.png);
+
+	surround = (type=sprite,
+		translation_hotspot = (top_left, 39, 86),
+
+		image1 = images/turrican_surround/frame1.png,
+		image2 = images/turrican_surround/frame2.png,
+		image3 = images/turrican_surround/frame3.png,
+		image4 = images/turrican_surround/frame4.png,
+		image5 = images/turrican_surround/frame5.png,
+		image6 = images/turrican_surround/frame6.png,
+		image7 = images/turrican_surround/frame7.png,
+		image8 = images/turrican_surround/frame8.png,
+		image9 = images/turrican_surround/frame9.png,
+
+		image10 = images/turrican_surround/frame10.png,
+		image11 = images/turrican_surround/frame11.png,
+		image12 = images/turrican_surround/frame12.png,
+		image13 = images/turrican_surround/frame13.png,
+		image14 = images/turrican_surround/frame14.png,
+		image15 = images/turrican_surround/frame15.png,
+		image16 = images/turrican_surround/frame16.png,
+		image17 = images/turrican_surround/frame17.png,
+		image18 = images/turrican_surround/frame18.png,
+		image19 = images/turrican_surround/frame19.png,
+
+		image20 = images/turrican_surround/frame20.png,
+		image21 = images/turrican_surround/frame21.png,
+		image22 = images/turrican_surround/frame22.png,
+		image23 = images/turrican_surround/frame23.png,
+		image24 = images/turrican_surround/frame24.png,
+		image25 = images/turrican_surround/frame25.png,
+		image26 = images/turrican_surround/frame26.png,
+		image27 = images/turrican_surround/frame27.png,
+		image28 = images/turrican_surround/frame28.png,
+		image29 = images/turrican_surround/frame29.png,
+
+		image30 = images/turrican_surround/frame30.png);
+}
+
+section shoot {
+	explosion = (
+		type=sprite,
+		image1 = images/shoot/explosion/frame1.png,
+		image2 = images/shoot/explosion/frame2.png,
+		image3 = images/shoot/explosion/frame3.png,
+		image4 = images/shoot/explosion/frame4.png,
+		image5 = images/shoot/explosion/frame5.png,
+		image6 = images/shoot/explosion/frame6.png,
+		image7 = images/shoot/explosion/frame7.png
+	);
+
+	default = (type=sprite,
+		   image1 = images/shoot_default.png);
+	
+	section laser {
+		stage1 = (type=sprite,image1 = images/shoot/laser/stage1.png);
+		stage2 = (type=sprite, image1 = images/shoot/laser/stage2.png);
+		stage3 = (type=sprite, image1 = images/shoot/laser/stage3.png);
+		stage4 = (type=sprite, image1 = images/shoot/laser/stage4.png);
+		stage5 = (type=sprite, image1 = images/shoot/laser/stage5.png);
+	}
+
+	bounce = (type=sprite, image1=images/shoot/bounce/stage2.png);
+}
+
+
+// for i in images/tiles/level1/*.png;
+// do     j=${i##images/tiles/level1/};
+// echo "section ${j%%.png} { image1 = $i);"; 
+//done > /tmp/tiles
+
+section tiles {
+green1 = (type=sprite, image1 = images/tiles/level1/green1.png);
+tile1 = (type=sprite, image1 = images/tiles/level1/tile1.png);
+tile10 = (type=sprite, image1 = images/tiles/level1/tile10.png);
+tile11 = (type=sprite, image1 = images/tiles/level1/tile11.png);
+tile12 = (type=sprite, image1 = images/tiles/level1/tile12.png);
+tile13 = (type=sprite, image1 = images/tiles/level1/tile13.png);
+tile14 = (type=sprite, image1 = images/tiles/level1/tile14.png);
+tile15 = (type=sprite, image1 = images/tiles/level1/tile15.png);
+tile16 = (type=sprite, image1 = images/tiles/level1/tile16.png);
+tile17 = (type=sprite, image1 = images/tiles/level1/tile17.png);
+tile18 = (type=sprite, image1 = images/tiles/level1/tile18.png);
+tile19 = (type=sprite, image1 = images/tiles/level1/tile19.png);
+tile2 = (type=sprite, image1 = images/tiles/level1/tile2.png);
+tile20 = (type=sprite, image1 = images/tiles/level1/tile20.png);
+tile21 = (type=sprite, image1 = images/tiles/level1/tile21.png);
+tile22 = (type=sprite, image1 = images/tiles/level1/tile22.png);
+tile23 = (type=sprite, image1 = images/tiles/level1/tile23.png);
+tile24 = (type=sprite, image1 = images/tiles/level1/tile24.png);
+tile25 = (type=sprite, image1 = images/tiles/level1/tile25.png);
+tile26 = (type=sprite, image1 = images/tiles/level1/tile26.png);
+tile27 = (type=sprite, image1 = images/tiles/level1/tile27.png);
+tile29 = (type=sprite, image1 = images/tiles/level1/tile29.png);
+tile3 = (type=sprite, image1 = images/tiles/level1/tile3.png);
+tile30 = (type=sprite, image1 = images/tiles/level1/tile30.png);
+tile31 = (type=sprite, image1 = images/tiles/level1/tile31.png);
+tile32 = (type=sprite, image1 = images/tiles/level1/tile32.png);
+tile33 = (type=sprite, image1 = images/tiles/level1/tile33.png);
+tile34 = (type=sprite, image1 = images/tiles/level1/tile34.png);
+tile35 = (type=sprite, image1 = images/tiles/level1/tile35.png);
+tile36 = (type=sprite, image1 = images/tiles/level1/tile36.png);
+tile38 = (type=sprite, image1 = images/tiles/level1/tile38.png);
+tile39 = (type=sprite, image1 = images/tiles/level1/tile39.png);
+tile4 = (type=sprite, image1 = images/tiles/level1/tile4.png);
+tile40 = (type=sprite, image1 = images/tiles/level1/tile40.png);
+tile41 = (type=sprite, image1 = images/tiles/level1/tile41.png);
+tile42 = (type=sprite, image1 = images/tiles/level1/tile42.png);
+tile43 = (type=sprite, image1 = images/tiles/level1/tile43.png);
+tile44 = (type=sprite, image1 = images/tiles/level1/tile44.png);
+tile45 = (type=sprite, image1 = images/tiles/level1/tile45.png);
+tile46 = (type=sprite, image1 = images/tiles/level1/tile46.png);
+tile47 = (type=sprite, image1 = images/tiles/level1/tile47.png);
+tile48 = (type=sprite, image1 = images/tiles/level1/tile48.png);
+tile49 = (type=sprite, image1 = images/tiles/level1/tile49.png);
+tile5 = (type=sprite, image1 = images/tiles/level1/tile5.png);
+tile50 = (type=sprite, image1 = images/tiles/level1/tile50.png);
+tile51 = (type=sprite, image1 = images/tiles/level1/tile51.png);
+tile52 = (type=sprite, image1 = images/tiles/level1/tile52.png);
+tile53 = (type=sprite, image1 = images/tiles/level1/tile53.png);
+tile54 = (type=sprite, image1 = images/tiles/level1/tile54.png);
+tile55 = (type=sprite, image1 = images/tiles/level1/tile55.png);
+tile56 = (type=sprite, image1 = images/tiles/level1/tile56.png);
+tile57 = (type=sprite, image1 = images/tiles/level1/tile57.png);
+tile58 = (type=sprite, image1 = images/tiles/level1/tile58.png);
+tile59 = (type=sprite, image1 = images/tiles/level1/tile59.png);
+tile6 = (type=sprite, image1 = images/tiles/level1/tile6.png);
+tile60 = (type=sprite, image1 = images/tiles/level1/tile60.png);
+tile61 = (type=sprite, image1 = images/tiles/level1/tile61.png);
+tile62 = (type=sprite, image1 = images/tiles/level1/tile62.png);
+tile63 = (type=sprite, image1 = images/tiles/level1/tile63.png);
+tile64 = (type=sprite, image1 = images/tiles/level1/tile64.png);
+tile65 = (type=sprite, image1 = images/tiles/level1/tile65.png);
+tile66 = (type=sprite, image1 = images/tiles/level1/tile66.png);
+tile67 = (type=sprite, image1 = images/tiles/level1/tile67.png);
+tile68 = (type=sprite, image1 = images/tiles/level1/tile68.png);
+tile69 = (type=sprite, image1 = images/tiles/level1/tile69.png);
+tile7 = (type=sprite, image1 = images/tiles/level1/tile7.png);
+tile71 = (type=sprite, image1 = images/tiles/level1/tile71.png);
+tile72 = (type=sprite, image1 = images/tiles/level1/tile72.png);
+tile73 = (type=sprite, image1 = images/tiles/level1/tile73.png);
+tile75 = (type=sprite, image1 = images/tiles/level1/tile75.png);
+tile76 = (type=sprite, image1 = images/tiles/level1/tile76.png);
+tile77 = (type=sprite, image1 = images/tiles/level1/tile77.png);
+tile8 = (type=sprite, image1 = images/tiles/level1/tile8.png);
+tile9 = (type=sprite, image1 = images/tiles/level1/tile9.png);
+water1 = (type=sprite, image1 = images/tiles/level1/water1.png);
+water2 = (type=sprite, image1 = images/tiles/level1/water2.png);
+water3 = (type=sprite, image1 = images/tiles/level1/water3.png);
+water4 = (type=sprite, image1 = images/tiles/level1/water4.png);
+waterfall = (type=sprite, image1 = images/tiles/level1/waterfall.png);
+waterfall2 = (type=sprite, image1 = images/tiles/level1/waterfall2.png);
+waterfall3 = (type=sprite, image1 = images/tiles/level1/waterfall3.png);
+}
+
+// EOF //
\ No newline at end of file

Added: branches/windstille-0.1.x/data/windstille.xml
===================================================================
--- tags/windstille-0.1.0/data/windstille.xml	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/data/windstille.xml	2009-09-27 12:06:38 UTC (rev 3268)
@@ -0,0 +1,743 @@
+<resources>
+  <sprite name="font_glyphs">
+    <image name="image1" file="images/verdana32_blue.png"><alpha /></image>
+  </sprite>
+
+  <sprite name="font_glyphsh">
+    <image name="image1" file="images/verdana32_blueh.png"><alpha /></image>
+  </sprite>
+
+  <font name="font">
+    <bitmap glyphs="font_glyphs" letters="!_#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz{|}~" />
+  </font>
+
+  <font name="font_h">
+    <bitmap glyphs="font_glyphsh" letters="!_#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz{|}~" />
+  </font>
+
+  <sprite name="menu_glyphs">
+    <image file="images/verdana48_blue.png"><alpha /></image>
+  </sprite>
+
+  <sprite name="menu_glyphsh">
+    <image file="images/verdana48_blueh.png"><alpha /></image>
+  </sprite>
+
+  <font name="menu">
+    <bitmap glyphs="menu_glyphs" letters="!_#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz{|}~" />
+  </font>
+
+  <font name="menu_h">
+    <bitmap glyphs="menu_glyphsh" letters="!_#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz{|}~" />
+  </font>
+
+  <section name="brush">
+    <sprite name="light">
+      <image file="images/light.png" />
+      <translation origin="bottom_center" />
+    </sprite>
+    <sprite name="exit">
+      <image file="images/exit.png" />
+    </sprite>
+  </section>
+
+  <sprite name="copyright_glyphs">
+    <image file="images/verdana11_blue.png"><alpha /></image>
+  </sprite>
+
+  <font name="copyright">
+    <bitmap glyphs="copyright_glyphs" letters="!_#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz{|}~" />
+  </font>
+
+  <sprite name="door">
+    <image file="images/door.png"></image>
+  </sprite>
+
+  <section name="powerup">
+    <sprite name="flash">
+      <image file="images/powerup/flash.png" name="image1" />
+    </sprite>
+    <sprite name="laser">
+      <image file="images/powerup/laser.png" name="image1" />
+    </sprite>
+    <sprite name="powerup">
+      <image file="images/powerup/powerup.png" name="image1" />
+    </sprite>
+    <sprite name="shild">
+      <image file="images/powerup/shild.png" name="image1" />
+    </sprite>
+    <sprite name="spread">
+      <image file="images/powerup/spread.png" name="image1" />
+    </sprite>
+  </section>
+  <section name="lights">
+    <sprite name="light1">
+      <image file="images/light1.png" name="image1" />
+    </sprite>
+    <sprite name="light2">
+      <image file="images/light2.png" name="image1" />
+    </sprite>
+    <sprite name="light3">
+      <image file="images/light3.png" name="image1" />
+    </sprite>
+  </section>
+
+  <sprite name="energiebar">
+    <image file="images/energiebar.png" name="image1" />
+  </sprite>
+
+  <sprite name="igel_die">
+    <animation speed="70" loop="no" />
+    <translation origin="bottom_center" />
+
+    <image file="images/igel_die1.png" />
+    <image file="images/igel_die2.png" />
+    <image file="images/igel_die3.png" />
+    <image file="images/igel_die4.png" />
+    <image file="images/igel_die5.png" />
+  </sprite>
+
+  <sprite name="igel">
+    <animation speed="100" />
+    <image file="images/igel.png" name="image1" />
+    <image file="images/igel1.png" name="image2" />
+    <translation origin="bottom_center" />
+  </sprite>
+
+  <sprite name="watersplash">
+    <image file="images/watersplash.png" name="image1" />
+    <translation origin="bottom_center" />
+  </sprite>
+
+  <sprite name="diamond">
+    <animation
+      speed="50"
+      loop="yes"
+      pingpong="yes" />
+
+    <image file="images/diamond/diamond1.png"  name="image1" />
+    <image file="images/diamond/diamond2.png"  name="image2" />
+    <image file="images/diamond/diamond3.png"  name="image3" />
+    <image file="images/diamond/diamond4.png"  name="image4" />
+    <image file="images/diamond/diamond5.png"  name="image5" />
+    <image file="images/diamond/diamond6.png"  name="image6" />
+    <image file="images/diamond/diamond7.png"  name="image7" />
+    <image file="images/diamond/diamond8.png"  name="image8" />
+    <image file="images/diamond/diamond9.png"  name="image9" />
+    <image file="images/diamond/diamond10.png" name="image10" />
+    <image file="images/diamond/diamond11.png" name="image11" />
+  </sprite>
+  
+  <section name="hero">
+    <description name="run1" play_speed="30">
+      <image file="images/hero_run/hero-9.png" name="image1" />
+      <image file="images/hero_run/hero-8.png" name="image2" />
+      <image file="images/hero_run/hero-7.png" name="image3" />
+      <image file="images/hero_run/hero-6.png" name="image4" />
+      <image file="images/hero_run/hero-5.png" name="image5" />
+      <image file="images/hero_run/hero-4.png" name="image6" />
+      <image file="images/hero_run/hero-3.png" name="image7" />
+      <image file="images/hero_run/hero-2.png" name="image8" />
+      <image file="images/hero_run/hero-1.png" name="image9" />
+      <image file="images/hero_run/hero-0.png" name="image10" />
+    </description>
+    
+    <sprite name="dead">
+      <translation origin="top_left" x="-200" y="120"/>
+      <image file="images/hero_dead/0032.png" />
+    </sprite>
+    
+    <sprite name="kill">
+      <animation speed="35" loop="no" />
+      <translation origin="top_left" x="-200" y="120"/>
+      <image file="images/hero_dead/0001.png" />
+      <image file="images/hero_dead/0001.png" />
+      <image file="images/hero_dead/0002.png" />
+      <image file="images/hero_dead/0003.png" />
+      <image file="images/hero_dead/0004.png" />
+      <image file="images/hero_dead/0005.png" />
+      <image file="images/hero_dead/0006.png" />
+      <image file="images/hero_dead/0007.png" />
+      <image file="images/hero_dead/0008.png" />
+      <image file="images/hero_dead/0009.png" />
+      <image file="images/hero_dead/0010.png" />
+      <image file="images/hero_dead/0011.png" />
+      <image file="images/hero_dead/0012.png" />
+      <image file="images/hero_dead/0013.png" />
+      <image file="images/hero_dead/0014.png" />
+      <image file="images/hero_dead/0015.png" />
+      <image file="images/hero_dead/0016.png" />
+      <image file="images/hero_dead/0017.png" />
+      <image file="images/hero_dead/0018.png" />
+      <image file="images/hero_dead/0019.png" />
+      <image file="images/hero_dead/0020.png" />
+      <image file="images/hero_dead/0021.png" />
+      <image file="images/hero_dead/0022.png" />
+      <image file="images/hero_dead/0023.png" />
+      <image file="images/hero_dead/0024.png" />
+      <image file="images/hero_dead/0025.png" />
+      <image file="images/hero_dead/0026.png" />
+      <image file="images/hero_dead/0027.png" />
+      <image file="images/hero_dead/0028.png" />
+      <image file="images/hero_dead/0029.png" />
+      <image file="images/hero_dead/0030.png" />
+      <image file="images/hero_dead/0031.png" />
+      <image file="images/hero_dead/0032.png" />
+    </sprite>
+
+    <sprite name="run" play_speed="30">
+      <image file="images/hero_run/hero-9.png" name="image1" />
+      <image file="images/hero_run/hero-8.png" name="image2" />
+      <image file="images/hero_run/hero-7.png" name="image3" />
+      <image file="images/hero_run/hero-6.png" name="image4" />
+      <image file="images/hero_run/hero-5.png" name="image5" />
+      <image file="images/hero_run/hero-4.png" name="image6" />
+      <image file="images/hero_run/hero-3.png" name="image7" />
+      <image file="images/hero_run/hero-2.png" name="image8" />
+      <image file="images/hero_run/hero-1.png" name="image9" />
+      <image file="images/hero_run/hero-0.png" name="image10" />
+    </sprite>
+
+    <sprite name="portrait">
+      <image file="images/portrait.png" name="image1" /> 
+    </sprite>
+
+    <sprite name="sit">
+      <image file="images/hero_sit.png" name="image1" /> 
+      <translation origin="bottom_center" x="0"  y="5" />
+    </sprite>
+
+    <sprite name="jump">
+      <image file="images/hero_jump.png" name="image1" /> 
+    </sprite>
+
+    <sprite name="stand">
+      <image file="images/hero_stand.png" name="image1" />
+    </sprite>
+  </section>
+
+  <sprite name="bomb">
+    <animation speed="200" />
+    <translation origin="bottom_center" />
+    <image file="images/bomb.png" name="image1" />
+    <image file="images/bomb1.png" name="image2" />
+  </sprite>
+
+  <sprite name="explo">
+    <animation speed="60" loop="no" />
+    <translation origin="bottom_center" />
+    <image file="images/explosion.png" name="image1">
+      <grid array="6,1" size="64,98" />
+    </image>
+  </sprite>
+
+  <section name="turrican">
+    <sprite name="jump">
+      <image file="images/sprite_jump_east.png" name="image1" translation_hotspot="top_left,29,82" />
+    </sprite>
+    <sprite name="walk">
+      <image file="images/turrican_jump_east.png" name="image1" />
+    </sprite>
+    <sprite name="shild" play_speed="50">
+      <image file="images/shild/frame1.png" name="image1" />
+      <image file="images/shild/frame2.png" name="image2" />
+    </sprite>
+    <sprite name="sit" translation_hotspot="top_left,29,90">
+      <image file="images/hero_sit.png" name="image1" />
+    </sprite>
+    <sprite name="roll" translation_hotspot="top_left,29,82">
+      <image file="images/turrican_roll/frame1.png"
+        name="image1" />
+      <image file="images/turrican_roll/frame2.png"
+        name="image2" />
+      <image file="images/turrican_roll/frame3.png"
+        name="image3" />
+      <image file="images/turrican_roll/frame4.png"
+        name="image4" />
+    </sprite>
+    <sprite name="stand" translation_hotspot="top_left,29,82">
+      <image file="images/turrican_stand_east.png" name="image1" />
+    </sprite>
+    <sprite name="walk" translation_hotspot="top_left,32,74">
+      <image file="images/turrican_walk/frame1.png"
+        name="image1" />
+      <image file="images/turrican_walk/frame2.png"
+        name="image2" />
+      <image file="images/turrican_walk/frame3.png"
+        name="image3" />
+      <image file="images/turrican_walk/frame4.png"
+        name="image4" />
+      <image file="images/turrican_walk/frame5.png"
+        name="image5" />
+      <image file="images/turrican_walk/frame6.png"
+        name="image6" />
+      <image file="images/turrican_walk/frame7.png"
+        name="image7" />
+      <image file="images/turrican_walk/frame8.png"
+        name="image8" />
+      <image file="images/turrican_walk/frame9.png"
+        name="image9" />
+      <image file="images/turrican_walk/frame10.png"
+        name="image10" />
+      <image file="images/turrican_walk/frame11.png"
+        name="image11" />
+      <image file="images/turrican_walk/frame12.png"
+        name="image12" />
+      <image file="images/turrican_walk/frame13.png"
+        name="image13" />
+      <image file="images/turrican_walk/frame14.png"
+        name="image14" />
+    </sprite>
+    <sprite name="surround" translation_hotspot="top_left,39,86">
+      <image file="images/turrican_surround/frame1.png"
+        name="image1" />
+      <image file="images/turrican_surround/frame2.png"
+        name="image2" />
+      <image file="images/turrican_surround/frame3.png"
+        name="image3" />
+      <image file="images/turrican_surround/frame4.png"
+        name="image4" />
+      <image file="images/turrican_surround/frame5.png"
+        name="image5" />
+      <image file="images/turrican_surround/frame6.png"
+        name="image6" />
+      <image file="images/turrican_surround/frame7.png"
+        name="image7" />
+      <image file="images/turrican_surround/frame8.png"
+        name="image8" />
+      <image file="images/turrican_surround/frame9.png"
+        name="image9" />
+      <image file="images/turrican_surround/frame10.png"
+        name="image10" />
+      <image file="images/turrican_surround/frame11.png"
+        name="image11" />
+      <image file="images/turrican_surround/frame12.png"
+        name="image12" />
+      <image file="images/turrican_surround/frame13.png"
+        name="image13" />
+      <image file="images/turrican_surround/frame14.png"
+        name="image14" />
+      <image file="images/turrican_surround/frame15.png"
+        name="image15" />
+      <image file="images/turrican_surround/frame16.png"
+        name="image16" />
+      <image file="images/turrican_surround/frame17.png"
+        name="image17" />
+      <image file="images/turrican_surround/frame18.png"
+        name="image18" />
+      <image file="images/turrican_surround/frame19.png"
+        name="image19" />
+      <image file="images/turrican_surround/frame20.png"
+        name="image20" />
+      <image file="images/turrican_surround/frame21.png"
+        name="image21" />
+      <image file="images/turrican_surround/frame22.png"
+        name="image22" />
+      <image file="images/turrican_surround/frame23.png"
+        name="image23" />
+      <image file="images/turrican_surround/frame24.png"
+        name="image24" />
+      <image file="images/turrican_surround/frame25.png"
+        name="image25" />
+      <image file="images/turrican_surround/frame26.png"
+        name="image26" />
+      <image file="images/turrican_surround/frame27.png"
+        name="image27" />
+      <image file="images/turrican_surround/frame28.png"
+        name="image28" />
+      <image file="images/turrican_surround/frame29.png"
+        name="image29" />
+      <image file="images/turrican_surround/frame30.png"
+        name="image30" />
+    </sprite>
+  </section>
+  <section name="shoot">
+    <section name="laser">
+      <sprite name="stage1">
+        <image file="images/shoot/laser/stage1.png"
+          name="image1" />
+      </sprite>
+      <sprite name="stage2">
+        <image file="images/shoot/laser/stage2.png"
+          name="image1" />
+      </sprite>
+      <sprite name="stage3">
+        <image file="images/shoot/laser/stage3.png"
+          name="image1" />
+      </sprite>
+      <sprite name="stage4">
+        <image file="images/shoot/laser/stage4.png"
+          name="image1" />
+      </sprite>
+      <sprite name="stage5">
+        <image file="images/shoot/laser/stage5.png"
+          name="image1" />
+      </sprite>
+    </section>
+    <sprite name="explosion">
+      <image file="images/shoot/explosion/frame1.png"
+        name="image1" />
+      <image file="images/shoot/explosion/frame2.png"
+        name="image2" />
+      <image file="images/shoot/explosion/frame3.png"
+        name="image3" />
+      <image file="images/shoot/explosion/frame4.png"
+        name="image4" />
+      <image file="images/shoot/explosion/frame5.png"
+        name="image5" />
+      <image file="images/shoot/explosion/frame6.png"
+        name="image6" />
+      <image file="images/shoot/explosion/frame7.png"
+        name="image7" />
+    </sprite>
+    <sprite name="default">
+      <image file="images/shoot_default.png" name="image1" />
+    </sprite>
+    <sprite name="bounce">
+      <image file="images/shoot/bounce/stage2.png" name="image1" />
+    </sprite>
+  </section>
+  <section name="tiles">
+
+    <sprite name="tile10">
+      <image file="images/tiles/tile10.png" name="image1" />
+    </sprite>
+    <sprite name="tile11">
+      <image file="images/tiles/tile11.png" name="image1" />
+    </sprite>
+    <sprite name="tile12">
+      <image file="images/tiles/tile12.png" name="image1" />
+    </sprite>
+    <sprite name="tile13">
+      <image file="images/tiles/tile13.png" name="image1" />
+    </sprite>
+    <sprite name="tile14">
+      <image file="images/tiles/tile14.png" name="image1" />
+    </sprite>
+    <sprite name="tile15">
+      <image file="images/tiles/tile15.png" name="image1" />
+    </sprite>
+    <sprite name="tile16">
+      <image file="images/tiles/tile16.png" name="image1" />
+    </sprite>
+    <sprite name="tile17">
+      <image file="images/tiles/tile17.png" name="image1" />
+    </sprite>
+    <sprite name="tile18">
+      <image file="images/tiles/tile18.png" name="image1" />
+    </sprite>
+    <sprite name="tile19">
+      <image file="images/tiles/tile19.png" name="image1" />
+    </sprite>
+    <sprite name="tile2">
+      <image file="images/tiles/tile2.png" name="image1" />
+    </sprite>
+    <sprite name="tile20">
+      <image file="images/tiles/tile20.png" name="image1" />
+    </sprite>
+    <sprite name="tile21">
+      <image file="images/tiles/tile21.png" name="image1" />
+    </sprite>
+    <sprite name="tile22">
+      <image file="images/tiles/tile22.png" name="image1" />
+    </sprite>
+    <sprite name="tile23">
+      <image file="images/tiles/tile23.png" name="image1" />
+    </sprite>
+    <sprite name="tile24">
+      <image file="images/tiles/tile24.png" name="image1" />
+    </sprite>
+    <sprite name="tile25">
+      <image file="images/tiles/tile25.png" name="image1" />
+    </sprite>
+    <sprite name="tile26">
+      <image file="images/tiles/tile26.png" name="image1" />
+    </sprite>
+    <sprite name="tile27">
+      <image file="images/tiles/tile27.png" name="image1" />
+    </sprite>
+    <sprite name="tile28">
+      <image file="images/tiles/tile28.png" name="image1" />
+    </sprite>
+    <sprite name="tile29">
+      <image file="images/tiles/tile29.png" name="image1" />
+    </sprite>
+    <sprite name="tile3">
+      <image file="images/tiles/tile3.png" name="image1" />
+    </sprite>
+    <sprite name="tile30">
+      <image file="images/tiles/tile30.png" name="image1" />
+    </sprite>
+    <sprite name="tile31">
+      <image file="images/tiles/tile31.png" name="image1" />
+    </sprite>
+    <sprite name="tile32">
+      <image file="images/tiles/tile32.png" name="image1" />
+    </sprite>
+    <sprite name="tile33">
+      <image file="images/tiles/tile33.png" name="image1" />
+    </sprite>
+    <sprite name="tile34">
+      <image file="images/tiles/tile34.png" name="image1" />
+    </sprite>
+    <sprite name="tile35">
+      <image file="images/tiles/tile35.png" name="image1" />
+    </sprite>
+    <sprite name="tile36">
+      <image file="images/tiles/tile36.png" name="image1" />
+    </sprite>
+    <sprite name="air_air_brwn_brwn_1">
+      <image file="images/tiles/air_air_brwn_brwn_1.png" name="image1" />
+    </sprite>
+    <sprite name="tile38">
+      <image file="images/tiles/tile38.png" />
+    </sprite>
+    <sprite name="tile39">
+      <image file="images/tiles/tile39.png" name="image1" />
+    </sprite>
+    <sprite name="tile4">
+      <image file="images/tiles/tile4.png" name="image1" />
+    </sprite>
+    <sprite name="tile40">
+      <image file="images/tiles/level1/tile40.png" name="image1" />
+    </sprite>
+    <sprite name="tile41">
+      <image file="images/tiles/level1/tile41.png" name="image1" />
+    </sprite>
+    <sprite name="tile42">
+      <image file="images/tiles/level1/tile42.png" name="image1" />
+    </sprite>
+    <sprite name="tile43">
+      <image file="images/tiles/level1/tile43.png" name="image1" />
+    </sprite>
+    <sprite name="tile44">
+      <image file="images/tiles/level1/tile44.png" name="image1" />
+    </sprite>
+    <sprite name="tile45">
+      <image file="images/tiles/level1/tile45.png" name="image1" />
+    </sprite>
+    <sprite name="tile46">
+      <image file="images/tiles/level1/tile46.png" name="image1" />
+    </sprite>
+    <sprite name="tile47">
+      <image file="images/tiles/level1/tile47.png" name="image1" />
+    </sprite>
+    <sprite name="tile48">
+      <image file="images/tiles/level1/tile48.png" name="image1" />
+    </sprite>
+    <sprite name="tile49">
+      <image file="images/tiles/level1/tile49.png" name="image1" />
+    </sprite>
+    <sprite name="tile5">
+      <image file="images/tiles/tile5.png" name="image1" />
+    </sprite>
+    <sprite name="tile50">
+      <image file="images/tiles/level1/tile50.png" name="image1" />
+    </sprite>
+    <sprite name="tile51">
+      <image file="images/tiles/level1/tile51.png" name="image1" />
+    </sprite>
+    <sprite name="tile52">
+      <image file="images/tiles/level1/tile52.png" name="image1" />
+    </sprite>
+    <sprite name="tile53">
+      <image file="images/tiles/level1/tile53.png" name="image1" />
+    </sprite>
+    <sprite name="tile54">
+      <image file="images/tiles/level1/tile54.png" name="image1" />
+    </sprite>
+    <sprite name="tile55">
+      <image file="images/tiles/level1/tile55.png" name="image1" />
+    </sprite>
+    <sprite name="tile56">
+      <image file="images/tiles/level1/tile56.png" name="image1" />
+    </sprite>
+    <sprite name="tile57">
+      <image file="images/tiles/level1/tile57.png" name="image1" />
+    </sprite>
+    <sprite name="tile58">
+      <image file="images/tiles/level1/tile58.png" name="image1" />
+    </sprite>
+    <sprite name="tile59">
+      <image file="images/tiles/level1/tile59.png" name="image1" />
+    </sprite>
+    <sprite name="tile6">
+      <image file="images/tiles/tile6.png" name="image1" />
+    </sprite>
+    <sprite name="tile60">
+      <image file="images/tiles/level1/tile60.png" name="image1" />
+    </sprite>
+    <sprite name="tile61">
+      <image file="images/tiles/level1/tile61.png" name="image1" />
+    </sprite>
+    <sprite name="tile62">
+      <image file="images/tiles/level1/tile62.png" name="image1" />
+    </sprite>
+    <sprite name="tile63">
+      <image file="images/tiles/level1/tile63.png" name="image1" />
+    </sprite>
+    <sprite name="tile64">
+      <image file="images/tiles/level1/tile64.png" name="image1" />
+    </sprite>
+    <sprite name="tile65">
+      <image file="images/tiles/level1/tile65.png" name="image1" />
+    </sprite>
+    <sprite name="tile66">
+      <image file="images/tiles/level1/tile66.png" name="image1" />
+    </sprite>
+    <sprite name="tile67">
+      <image file="images/tiles/level1/tile67.png" name="image1" />
+    </sprite>
+    <sprite name="tile68">
+      <image file="images/tiles/level1/tile68.png" name="image1" />
+    </sprite>
+    <sprite name="tile69">
+      <image file="images/tiles/level1/tile69.png" name="image1" />
+    </sprite>
+    <sprite name="tile7">
+      <image file="images/tiles/tile7.png" name="image1" />
+    </sprite>
+    <sprite name="tile71">
+      <image file="images/tiles/level1/tile71.png" name="image1" />
+    </sprite>
+    <sprite name="tile72">
+      <image file="images/tiles/level1/tile72.png" name="image1" />
+    </sprite>
+    <sprite name="tile73">
+      <image file="images/tiles/level1/tile73.png" name="image1" />
+    </sprite>
+    <sprite name="tile75">
+      <image file="images/tiles/level1/tile75.png" name="image1" />
+    </sprite>
+    <sprite name="tile76">
+      <image file="images/tiles/level1/tile76.png" name="image1" />
+    </sprite>
+    <sprite name="tile77">
+      <image file="images/tiles/level1/tile77.png" name="image1" />
+    </sprite>
+    <sprite name="tile8">
+      <image file="images/tiles/tile8.png" name="image1" />
+    </sprite>
+    <sprite name="tile9">
+      <image file="images/tiles/tile9.png" name="image1" />
+    </sprite>
+    <sprite name="water1">
+      <image file="images/tiles/level1/water1.png" name="image1" />
+    </sprite>
+    <sprite name="water2">
+      <image file="images/tiles/level1/water2.png" name="image1" />
+    </sprite>
+    <sprite name="water3">
+      <image file="images/tiles/level1/water3.png" name="image1" />
+    </sprite>
+    <sprite name="water4">
+      <image file="images/tiles/level1/water4.png" name="image1" />
+    </sprite>
+    <sprite name="waterfall">
+      <image file="images/tiles/level1/waterfall.png"
+        name="image1" />
+    </sprite>
+    <sprite name="waterfall2">
+      <image file="images/tiles/level1/waterfall2.png"
+        name="image1" />
+    </sprite>
+    <sprite name="waterfall3">
+      <image file="images/tiles/level1/waterfall3.png"
+        name="image1" />
+    </sprite>
+  </section>
+
+  <sprite name="bonusflyer">
+    <image file="images/bonusflyer.png" name="image1" />
+  </sprite>
+  <sprite name="nebular">
+    <image file="images/nebular.png" name="image1" />
+  </sprite>
+  <sprite name="dog" play_speed="500"
+    translation_hotspot="top_left,24,42">
+    <image file="images/dog/frame1.png" name="image1" />
+    <image file="images/dog/frame2.png" name="image2" />
+    <image file="images/dog/frame3.png" name="image3" />
+    <image file="images/dog/frame4.png" name="image4" />
+  </sprite>
+
+  <sprite name="logo_large">
+    <image file="images/logo_large.png" />
+  </sprite>
+
+  <sprite name="menu_background">
+    <image file="images/menu_background.jpg" />
+  </sprite>
+
+  <sprite name="logo">
+    <image file="images/logo.png" name="image1" />
+  </sprite>
+  <sprite name="logo_black">
+    <image file="images/logo_black.png" name="image1" />
+  </sprite>
+
+  <section name="bonus">
+    <sprite name="atspider"><image file="images/bonus/atspider.jpg" /></sprite>
+    <sprite name="attack"><image file="images/bonus/attack.jpg" /></sprite>
+    <sprite name="ball"><image file="images/bonus/ball.jpg" /></sprite>
+    <sprite name="beamtrap"><image file="images/bonus/beamtrap.jpg" /></sprite>
+    <sprite name="bike"><image file="images/bonus/bike.jpg" /></sprite>
+    <sprite name="bla"><image file="images/bonus/bla.jpg" /></sprite>
+    <sprite name="brokencapsule"><image file="images/bonus/brokencapsule.jpg" /></sprite>
+    <sprite name="buoy"><image file="images/bonus/buoy.jpg" /></sprite>
+    <sprite name="butterfly"><image file="images/bonus/butterfly.jpg" /></sprite>
+    <sprite name="canon"><image file="images/bonus/canon.jpg" /></sprite>
+    <sprite name="crab"><image file="images/bonus/crab.jpg" /></sprite>
+    <sprite name="dingo"><image file="images/bonus/dingo.jpg" /></sprite>
+    <sprite name="dog"><image file="images/bonus/dog.jpg" /></sprite>
+    <sprite name="dogs"><image file="images/bonus/dogs.jpg" /></sprite>
+    <sprite name="droid"><image file="images/bonus/droid.jpg" /></sprite>
+    <sprite name="droid2"><image file="images/bonus/droid2.jpg" /></sprite>
+    <sprite name="endo"><image file="images/bonus/endo.jpg" /></sprite>
+    <sprite name="enemy1"><image file="images/bonus/enemy1.jpg" /></sprite>
+    <sprite name="enemy2"><image file="images/bonus/enemy2.jpg" /></sprite>
+    <sprite name="enemy3"><image file="images/bonus/enemy3.jpg" /></sprite>
+    <sprite name="enemy4"><image file="images/bonus/enemy4.jpg" /></sprite>
+    <sprite name="enemy5"><image file="images/bonus/enemy5.jpg" /></sprite>
+    <sprite name="enemy6"><image file="images/bonus/enemy6.jpg" /></sprite>
+    <sprite name="enemy7"><image file="images/bonus/enemy7.jpg" /></sprite>
+    <sprite name="fish"><image file="images/bonus/fish.jpg" /></sprite>
+    <sprite name="flyby"><image file="images/bonus/flyby.jpg" /></sprite>
+    <sprite name="gun"><image file="images/bonus/gun.jpg" /></sprite>
+    <sprite name="gun2"><image file="images/bonus/gun2.jpg" /></sprite>
+    <sprite name="jolly"><image file="images/bonus/jolly.jpg" /></sprite>
+    <sprite name="lava"><image file="images/bonus/lava.jpg" /></sprite>
+    <sprite name="mech"><image file="images/bonus/mech.jpg" /></sprite>
+    <sprite name="mech2"><image file="images/bonus/mech2.jpg" /></sprite>
+    <sprite name="mech3"><image file="images/bonus/mech3.jpg" /></sprite>
+    <sprite name="morph"><image file="images/bonus/morph.jpg" /></sprite>
+    <sprite name="morph2"><image file="images/bonus/morph2.jpg" /></sprite>
+    <sprite name="plant"><image file="images/bonus/plant.jpg" /></sprite>
+    <sprite name="plant2"><image file="images/bonus/plant2.jpg" /></sprite>
+    <sprite name="plant3"><image file="images/bonus/plant3.jpg" /></sprite>
+    <sprite name="plant4"><image file="images/bonus/plant4.jpg" /></sprite>
+    <sprite name="plant5"><image file="images/bonus/plant5.jpg" /></sprite>
+    <sprite name="pod"><image file="images/bonus/pod.jpg" /></sprite>
+    <sprite name="qual"><image file="images/bonus/qual.jpg" /></sprite>
+    <sprite name="robo"><image file="images/bonus/robo.jpg" /></sprite>
+    <sprite name="rollbot"><image file="images/bonus/rollbot.jpg" /></sprite>
+    <sprite name="room"><image file="images/bonus/room.jpg" /></sprite>
+    <sprite name="roto"><image file="images/bonus/roto.jpg" /></sprite>
+    <sprite name="runner"><image file="images/bonus/runner.jpg" /></sprite>
+    <sprite name="skeleton"><image file="images/bonus/skeleton.jpg" /></sprite>
+    <sprite name="spike"><image file="images/bonus/spike.jpg" /></sprite>
+    <sprite name="starter"><image file="images/bonus/starter.jpg" /></sprite>
+    <sprite name="steam"><image file="images/bonus/steam.jpg" /></sprite>
+    <sprite name="steam2"><image file="images/bonus/steam2.jpg" /></sprite>
+    <sprite name="stone"><image file="images/bonus/stone.jpg" /></sprite>
+    <sprite name="turtle"><image file="images/bonus/turtle.jpg" /></sprite>
+    <sprite name="turtle1"><image file="images/bonus/turtle1.jpg" /></sprite>
+    <sprite name="walker"><image file="images/bonus/walker.jpg" /></sprite>
+    <sprite name="walkinggun"><image file="images/bonus/walkinggun.jpg" /></sprite>
+    <sprite name="wallgen"><image file="images/bonus/wallgen.jpg" /></sprite>
+    <sprite name="waterrunner"><image file="images/bonus/waterrunner.jpg" /></sprite>
+  </section>  
+
+  <sprite name="bonus_end"><image file="images/bonus/bonus_end.jpg" /></sprite>
+
+</resources>

Modified: branches/windstille-0.1.x/src/display.cxx
===================================================================
--- tags/windstille-0.1.0/src/display.cxx	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/src/display.cxx	2009-09-27 12:06:38 UTC (rev 3268)
@@ -22,21 +22,22 @@
 #include "display.hxx"
 
 void
-Display::begin_gl()
+Display_::begin_gl()
 {
   int viewport[4];
   glGetIntegerv(GL_VIEWPORT, viewport);
 
-  CL_Display::begin_3d();
+  //CL_Display::begin_3d();
+  CL_Display::flush();
   glMatrixMode(GL_MODELVIEW);
   glLoadIdentity();
   gluOrtho2D (0, viewport[2], viewport[3], 0);
 }
 
 void
-Display::end_gl()
+Display_::end_gl()
 {
-  CL_Display::end_3d();
+  //CL_Display::end_3d();
 }
 
 /* EOF */

Modified: branches/windstille-0.1.x/src/display.hxx
===================================================================
--- tags/windstille-0.1.0/src/display.hxx	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/src/display.hxx	2009-09-27 12:06:38 UTC (rev 3268)
@@ -21,7 +21,7 @@
 #define HEADER_DISPLAY_HXX
 
 /** */
-class Display
+class Display_ // renamed from Display, due to conflict with X11 headers 
 {
 private:
 public:

Modified: branches/windstille-0.1.x/src/editor/editor_tile.cxx
===================================================================
--- tags/windstille-0.1.0/src/editor/editor_tile.cxx	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/src/editor/editor_tile.cxx	2009-09-27 12:06:38 UTC (rev 3268)
@@ -18,6 +18,7 @@
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
 #include <string>
+#include <assert.h>
 #include "../globals.hxx"
 #include "editor_tile.hxx"
 

Modified: branches/windstille-0.1.x/src/guile_gameobj_factory.cxx
===================================================================
--- tags/windstille-0.1.0/src/guile_gameobj_factory.cxx	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/src/guile_gameobj_factory.cxx	2009-09-27 12:06:38 UTC (rev 3268)
@@ -17,6 +17,7 @@
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
+#include <assert.h>
 #include "guile_gameobj_factory.hxx"
 
 GuileGameObjFactory::Descr GuileGameObjFactory::descriptions;

Modified: branches/windstille-0.1.x/src/player_view.cxx
===================================================================
--- tags/windstille-0.1.0/src/player_view.cxx	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/src/player_view.cxx	2009-09-27 12:06:38 UTC (rev 3268)
@@ -34,10 +34,11 @@
 {
   //glPushMatrix ();
   //glTranslatef (-pos.x + CL_Display::get_width ()/2, -pos.y + CL_Display::get_height ()/2, 0.0);
-  CL_Display::push_translate_offset(int(-pos.x + CL_Display::get_width ()/2),
-                                    int(-pos.y + CL_Display::get_height ()/2));
+  CL_Display::push_modelview();
+  CL_Display::add_translate(int(-pos.x + CL_Display::get_width ()/2),
+                            int(-pos.y + CL_Display::get_height ()/2));
   world->draw ();
-  CL_Display::pop_translate_offset();
+  CL_Display::pop_modelview();
   //glPopMatrix ();
 }
 

Modified: branches/windstille-0.1.x/src/tile.cxx
===================================================================
--- tags/windstille-0.1.0/src/tile.cxx	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/src/tile.cxx	2009-09-27 12:06:38 UTC (rev 3268)
@@ -17,6 +17,7 @@
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
+#include <string.h>
 #include "tile.hxx"
 
 Tile::Tile(CL_Sprite arg_sur, unsigned char arg_colmap[])

Modified: branches/windstille-0.1.x/src/tile.hxx
===================================================================
--- tags/windstille-0.1.0/src/tile.hxx	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/src/tile.hxx	2009-09-27 12:06:38 UTC (rev 3268)
@@ -21,6 +21,7 @@
 #define HEADER_TILE_HXX
 
 #include <ClanLib/Display/sprite.h>
+#include <assert.h>
 
 /** A Tile is a surface or sprite together with information for
  *  collision detection (aka colmap). The collision map is at a

Modified: branches/windstille-0.1.x/src/windstille_game.cxx
===================================================================
--- tags/windstille-0.1.0/src/windstille_game.cxx	2009-09-27 11:42:19 UTC (rev 3267)
+++ branches/windstille-0.1.x/src/windstille_game.cxx	2009-09-27 12:06:38 UTC (rev 3268)
@@ -100,7 +100,7 @@
       float delta = delta_manager.getset ();
       CL_System::sleep (1);
       
-      Display::begin_gl();
+      Display_::begin_gl();
       {
         glBlendFunc(GL_ONE, GL_ZERO);
 
@@ -124,7 +124,7 @@
      
         glEnd();
       }
-      Display::end_gl();
+      Display_::end_gl();
 
       view.draw ();
       view.update (delta);
@@ -133,7 +133,7 @@
 
       if (0) // Water
         {
-          Display::begin_gl();
+          Display_::begin_gl();
           {
             glEnable (GL_BLEND);
             glBlendFunc( GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA );
@@ -157,12 +157,12 @@
             }
             glEnd();
           }
-          Display::end_gl();
+          Display_::end_gl();
         }
 
       if (0) // Laser
         {
-          Display::begin_gl();
+          Display_::begin_gl();
           
           glBlendFunc( GL_SRC_ALPHA, GL_ONE );
 
@@ -178,7 +178,7 @@
           }
           glEnd();
 
-          Display::end_gl();
+          Display_::end_gl();
         }
       
       {
@@ -188,7 +188,7 @@
         float bottom = 350;
         float alpha  = .2f;
 
-        Display::begin_gl();
+        Display_::begin_gl();
         glEnable (GL_BLEND);
         glBlendFunc( GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA );
         glBegin(GL_QUADS);
@@ -224,7 +224,7 @@
         glVertex2f(right, bottom);
 
         glEnd();
-        Display::end_gl();
+        Display_::end_gl();
       }
 
       if (1)



From grumbel at mail.berlios.de  Mon Sep 28 18:49:16 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 28 Sep 2009 18:49:16 +0200
Subject: [Windstille-commit] r3269 - in trunk/windstille/external: . miniswig
Message-ID: <200909281649.n8SGnGMU016939@sheep.berlios.de>

Author: grumbel
Date: 2009-09-28 18:49:13 +0200 (Mon, 28 Sep 2009)
New Revision: 3269

Added:
   trunk/windstille/external/miniswig/
   trunk/windstille/external/miniswig/CMakeLists.txt
   trunk/windstille/external/miniswig/create_docu.cpp
   trunk/windstille/external/miniswig/create_docu.hpp
   trunk/windstille/external/miniswig/create_wrapper.cpp
   trunk/windstille/external/miniswig/create_wrapper.hpp
   trunk/windstille/external/miniswig/globals.hpp
   trunk/windstille/external/miniswig/lexer.ll
   trunk/windstille/external/miniswig/main.cpp
   trunk/windstille/external/miniswig/parser.yy
   trunk/windstille/external/miniswig/tree.cpp
   trunk/windstille/external/miniswig/tree.hpp
   trunk/windstille/external/miniswig/xmlwriter.cpp
   trunk/windstille/external/miniswig/xmlwriter.hpp
Modified:
   trunk/windstille/external/
   trunk/windstille/external/README
Log:
Removed svn:external on miniswig, made it an internal part of the tree


Property changes on: trunk/windstille/external
___________________________________________________________________
Name: svn:externals
   - miniswig http://supertux.lethargik.org/svn/supertux/trunk/supertux/tools/miniswig

   + 


Modified: trunk/windstille/external/README
===================================================================
--- trunk/windstille/external/README	2009-09-27 12:06:38 UTC (rev 3268)
+++ trunk/windstille/external/README	2009-09-28 16:49:13 UTC (rev 3269)
@@ -9,7 +9,9 @@
 
 miniswig/ - Squirrel Wrapper Generator
 --------------------------------------
-    uses svn:externals should update automatically
+  Created by doing:
+  
+  svn export http://supertux.lethargik.org/svn/supertux/trunk/supertux/tools/miniswig
 
 
 binreloc-2.0/

Added: trunk/windstille/external/miniswig/CMakeLists.txt
===================================================================
--- trunk/windstille/external/miniswig/CMakeLists.txt	2009-09-27 12:06:38 UTC (rev 3268)
+++ trunk/windstille/external/miniswig/CMakeLists.txt	2009-09-28 16:49:13 UTC (rev 3269)
@@ -0,0 +1,68 @@
+#
+# SuperTux - miniswig build script
+# Copyright (C) 2007 Timothy Goya <tuxdev103 at gmail.com>
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+# 
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+# 
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+#
+
+## Project name to use as command prefix
+
+PROJECT(MINISWIG)
+
+## add additional compiler switches
+
+ADD_DEFINITIONS(-include ${CMAKE_BINARY_DIR}/config.h)
+# the autogenerated bison/flex is not warning free usually
+REMOVE_DEFINITIONS(-Wall -W)
+
+## Include paths to make generated files work
+
+INCLUDE_DIRECTORIES (${MINISWIG_SOURCE_DIR})
+
+## build list of source files
+
+FILE(GLOB MINISWIG_SOURCES RELATIVE ${MINISWIG_SOURCE_DIR} create_docu.cpp create_wrapper.cpp main.cpp tree.cpp xmlwriter.cpp)
+
+## Add target for bison parser generation
+
+MARK_AS_ADVANCED(BISON_EXECUTABLE)
+FIND_PROGRAM(BISON_EXECUTABLE bison)
+IF (NOT BISON_EXECUTABLE)
+  MESSAGE(FATAL_ERROR "bison not found - aborting")
+ENDIF (NOT BISON_EXECUTABLE)
+ADD_CUSTOM_COMMAND(
+  OUTPUT ${MINISWIG_BINARY_DIR}/parser.cpp ${MINISWIG_BINARY_DIR}/parser.hpp
+  COMMAND ${BISON_EXECUTABLE}
+  ARGS -d -o ${MINISWIG_BINARY_DIR}/parser.cpp ${MINISWIG_SOURCE_DIR}/parser.yy
+  DEPENDS parser.yy
+)
+
+## Add target for flex lexical analyzer generation
+
+MARK_AS_ADVANCED(FLEX_EXECUTABLE)
+FIND_PROGRAM(FLEX_EXECUTABLE flex)
+IF (NOT FLEX_EXECUTABLE)
+  MESSAGE(FATAL_ERROR "flex not found - aborting")
+ENDIF (NOT FLEX_EXECUTABLE)
+ADD_CUSTOM_COMMAND(
+  OUTPUT ${MINISWIG_BINARY_DIR}/lexer.cpp
+  COMMAND ${FLEX_EXECUTABLE}
+  ARGS -o ${MINISWIG_BINARY_DIR}/lexer.cpp ${MINISWIG_SOURCE_DIR}/lexer.ll
+  DEPENDS lexer.ll ${MINISWIG_BINARY_DIR}/parser.hpp
+)
+
+## Add target for miniswig binary
+
+ADD_EXECUTABLE(miniswig ${MINISWIG_SOURCES} ${MINISWIG_BINARY_DIR}/parser.cpp ${MINISWIG_BINARY_DIR}/lexer.cpp)


Property changes on: trunk/windstille/external/miniswig/CMakeLists.txt
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/external/miniswig/create_docu.cpp
===================================================================
--- trunk/windstille/external/miniswig/create_docu.cpp	2009-09-27 12:06:38 UTC (rev 3268)
+++ trunk/windstille/external/miniswig/create_docu.cpp	2009-09-28 16:49:13 UTC (rev 3269)
@@ -0,0 +1,112 @@
+#include <config.h>
+
+#include "tree.hpp"
+#include <iostream>
+#include <sstream>
+#include <stdexcept>
+#include "create_docu.hpp"
+#include "globals.hpp"
+
+void
+DocuCreator::create_docu(Namespace* ns)
+{
+    std::string fromfile = original_file != "" ? original_file : inputfile;
+
+    writer.openTag("documentation");
+    writer.openTag("namespace");
+    writer.writeAttribute("name", ns->name);
+
+    for(std::vector<AtomicType*>::iterator i = ns->types.begin();
+            i != ns->types.end(); ++i) {
+        AtomicType* type = *i;
+        Class* _class = dynamic_cast<Class*> (type);
+        if(_class != 0)
+            create_class_docu(_class);
+    }
+    for(std::vector<Function*>::iterator i = ns->functions.begin();
+            i != ns->functions.end(); ++i) {
+        create_function_docu(0, *i);
+    }
+
+    writer.closeTag("namespace");
+    writer.closeTag("documentation");
+}
+
+void
+DocuCreator::create_class_docu(Class* _class)
+{
+    writer.openTag("class");
+    writer.writeAttribute("name", _class->name);
+
+    if(_class->docu_comment != "") {
+        writer.writeTag("documentation");
+        writer.write(_class->docu_comment);
+    }
+
+    for(std::vector<ClassMember*>::iterator i = _class->members.begin();
+            i != _class->members.end(); ++i) {
+        ClassMember* member = *i;
+        if(member->visibility != ClassMember::PUBLIC)
+            continue;
+        Function* function = dynamic_cast<Function*> (member);
+        if(!function)
+            continue;
+        if(function->type != Function::FUNCTION)
+            continue;
+        create_function_docu(_class, function);
+    }
+
+    writer.closeTag("class");
+}
+
+void
+DocuCreator::create_function_docu(Class* _class, Function* function)
+{
+    writer.openTag("function");
+
+    writer.writeAttribute("return_type",
+            get_type(function->return_type));
+    writer.writeAttribute("name", function->name);
+
+    if(function->docu_comment != "") {
+        writer.writeTag("documentation");
+        writer.write(function->docu_comment);
+    }
+
+    for(std::vector<Parameter>::iterator p = function->parameters.begin();
+            p != function->parameters.end(); ++p) {
+        if(p == function->parameters.begin()
+                && p->type.atomic_type == HSQUIRRELVMType::instance())
+            continue;
+
+        writer.writeTag("param");
+        writer.writeAttribute("type", get_type(p->type));
+        writer.writeAttribute("name", p->name);
+    }
+
+    writer.closeTag("function");
+}
+
+std::string
+DocuCreator::get_type(const Type& type)
+{
+    if(type.ref > 0 && type.atomic_type != StringType::instance())
+        throw std::runtime_error("References not handled yet");
+    if(type.pointer > 0)
+        throw std::runtime_error("Pointers not handled yet");
+    if(type.atomic_type == &BasicType::VOID) {
+        return "void";
+    } else if(type.atomic_type == &BasicType::INT) {
+        return "int";
+    } else if(type.atomic_type == &BasicType::FLOAT) {
+        return "float";
+    } else if(type.atomic_type == &BasicType::BOOL) {
+        return "bool";
+    } else if(type.atomic_type == StringType::instance()) {
+        return "string";
+    }
+
+    std::ostringstream msg;
+    msg << "Type '" << type.atomic_type->name << "' not supported yet.";
+    throw std::runtime_error(msg.str());
+}


Property changes on: trunk/windstille/external/miniswig/create_docu.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/external/miniswig/create_docu.hpp
===================================================================
--- trunk/windstille/external/miniswig/create_docu.hpp	2009-09-27 12:06:38 UTC (rev 3268)
+++ trunk/windstille/external/miniswig/create_docu.hpp	2009-09-28 16:49:13 UTC (rev 3269)
@@ -0,0 +1,26 @@
+#ifndef __CREATE_DOCU_H__
+#define __CREATE_DOCU_H__
+
+#include "tree.hpp"
+#include "xmlwriter.hpp"
+
+class DocuCreator
+{
+public:
+    const char* ind;
+    std::ostream& out;
+    XmlWriter writer;
+
+    DocuCreator(std::ostream& _out = std::cout)
+        : out(_out), writer(out)
+    {
+        ind = "  ";
+    }
+
+    void create_docu(Namespace* ns);
+    void create_class_docu(Class* _class);
+    void create_function_docu(Class* _class, Function* function);
+    std::string get_type(const Type& type);
+};
+
+#endif


Property changes on: trunk/windstille/external/miniswig/create_docu.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/external/miniswig/create_wrapper.cpp
===================================================================
--- trunk/windstille/external/miniswig/create_wrapper.cpp	2009-09-27 12:06:38 UTC (rev 3268)
+++ trunk/windstille/external/miniswig/create_wrapper.cpp	2009-09-28 16:49:13 UTC (rev 3269)
@@ -0,0 +1,569 @@
+#include <config.h>
+
+#include "tree.hpp"
+#include "create_wrapper.hpp"
+#include "globals.hpp"
+
+#include <stdio.h>
+#include <iostream>
+#include <sstream>
+#include <stdexcept>
+
+void
+WrapperCreator::create_wrapper(Namespace* ns)
+{
+    std::string fromfile = original_file != "" ? original_file : inputfile;
+
+    if(selected_namespace != "") {
+        ns_prefix = selected_namespace;
+        ns_prefix += "::";
+    }
+
+    // hpp file
+    hppout
+        << "/**\n"
+        << " * WARNING: This file is automatically generated from:\n"
+        << " *  '" << fromfile << "'\n"
+        << " * DO NOT CHANGE\n"
+        << " */\n"
+        << "#ifndef __" << modulename << "_WRAPPER_H__\n"
+        << "#define __" << modulename << "_WRAPPER_H__\n"
+        << "\n"
+        << "#include <squirrel.h>\n"
+        << "\n"
+        << "namespace Scripting\n"
+        << "{\n"
+        << "\n";
+
+    hppout << "void register_" << modulename << "_wrapper(HSQUIRRELVM v);\n"
+           << "\n";
+
+    for(std::vector<AtomicType*>::iterator i = ns->types.begin();
+            i != ns->types.end(); ++i) {
+        AtomicType* type = *i;
+        Class* _class = dynamic_cast<Class*> (type);
+        if(_class == 0)
+            continue;
+
+        hppout << "class " << _class->name << ";\n";
+        hppout << "void create_squirrel_instance(HSQUIRRELVM v, "
+               << ns_prefix << _class->name
+               << "* object, bool setup_releasehook = false);\n";
+    }
+    hppout <<"\n"
+           << "}\n"
+           << "\n"
+           << "#endif\n";
+
+    // cpp header
+    out << "/**\n"
+        << " * WARNING: This file is automatically generated from:\n"
+        << " *  '" << fromfile << "'\n"
+        << " * DO NOT CHANGE\n"
+        << " */\n"
+        << "#include <config.h>\n"
+        << "\n"
+        << "#include <new>\n"
+        << "#include <assert.h>\n"
+        << "#include <string>\n"
+        << "#include <sstream>\n"
+        << "#include <squirrel.h>\n"
+        << "#include \"squirrel_error.hpp\"\n"
+        << "#include \"wrapper.interface.hpp\"\n"
+        << "\n"
+        << "namespace Scripting\n"
+        << "{\n"
+        << "namespace Wrapper\n"
+        << "{\n"
+        << "\n";
+
+    for(std::vector<AtomicType*>::iterator i = ns->types.begin();
+            i != ns->types.end(); ++i) {
+        AtomicType* type = *i;
+        Class* _class = dynamic_cast<Class*> (type);
+        if(_class != 0)
+            create_class_wrapper(_class);
+    }
+    for(std::vector<Function*>::iterator i = ns->functions.begin();
+            i != ns->functions.end(); ++i) {
+        create_function_wrapper(0, *i);
+    }
+
+    out << "} // end of namespace Wrapper\n";
+
+    for(std::vector<AtomicType*>::iterator i = ns->types.begin();
+            i != ns->types.end(); ++i) {
+        AtomicType* type = *i;
+        Class* _class = dynamic_cast<Class*> (type);
+        if(_class != 0)
+            create_squirrel_instance(_class);
+    }
+
+    out << "void register_" << modulename << "_wrapper(HSQUIRRELVM v)\n"
+        << "{\n"
+        << ind << "using namespace Wrapper;\n"
+        << "\n";
+
+    create_register_constants_code(ns);
+    create_register_functions_code(ns);
+    create_register_classes_code(ns);
+
+    out << "}\n"
+        << "\n"
+        << "} // end of namespace Scripting\n";
+}
+
+void
+WrapperCreator::create_register_function_code(Function* function, Class* _class)
+{
+    if(function->type == Function::DESTRUCTOR)
+        return;
+
+    out << ind << "sq_pushstring(v, \"" << function->name << "\", -1);\n";
+    out << ind << "sq_newclosure(v, &"
+        << (_class != 0 ? _class->name + "_" : "") << function->name
+        << "_wrapper, 0);\n";
+
+    if(function->custom) {
+      out << ind << "sq_setparamscheck(v, SQ_MATCHTYPEMASKSTRING, " << function->parameter_spec << ");\n";
+    } else {
+      out << ind << "sq_setparamscheck(v, SQ_MATCHTYPEMASKSTRING, \"";
+
+      out << "x|t";
+
+      if(!function->parameters.empty())
+        {
+          std::vector<Parameter>::iterator p = function->parameters.begin();
+          
+          // Skip the first parameter since its a HSQUIRRELVM that is
+          // handled internally
+          if (function->suspend) {
+            ++p;
+          } else if (p->type.atomic_type == HSQUIRRELVMType::instance()) {
+            ++p;
+          }
+
+          for(; p != function->parameters.end(); ++p) {
+            if(p->type.atomic_type == &BasicType::INT) {
+              out << "i";
+            } else if(p->type.atomic_type == &BasicType::FLOAT) {
+              out << "n";
+            } else if(p->type.atomic_type == &BasicType::BOOL) {
+              out << "b";
+            } else if(p->type.atomic_type == StringType::instance()) {
+              out << "s";
+            } else {
+              out << ".";
+            }
+          }
+      }
+      out << "\");\n";
+    }
+
+    create_register_slot_code("function", function->name);
+    out << "\n";
+}
+
+void
+WrapperCreator::create_register_functions_code(Namespace* ns)
+{
+    for(std::vector<Function*>::iterator i = ns->functions.begin();
+            i != ns->functions.end(); ++i) {
+        Function* function = *i;
+        create_register_function_code(function, 0);
+    }
+}
+
+void
+WrapperCreator::create_register_classes_code(Namespace* ns)
+{
+    for(std::vector<AtomicType*>::iterator i = ns->types.begin();
+            i != ns->types.end(); ++i) {
+        AtomicType* type = *i;
+        Class* _class = dynamic_cast<Class*> (type);
+        if(_class == 0)
+            continue;
+        if(_class->super_classes.size() > 0)
+            continue;
+
+        create_register_class_code(_class);
+    }
+}
+
+void
+WrapperCreator::create_register_class_code(Class* _class)
+{
+    out << ind << "// Register class " << _class->name << "\n";
+    out << ind << "sq_pushstring(v, \""
+        << _class->name << "\", -1);\n";
+
+    if(_class->super_classes.size() > 0) {
+        if(_class->super_classes.size() > 1) {
+            std::ostringstream msg;
+            msg << "Multiple inheritance not supported (at class '"
+                << _class->name << "')";
+            throw std::runtime_error(msg.str());
+        }
+
+        out << ind << "sq_pushstring(v, \""
+            << _class->super_classes[0]->name << "\", -1);\n";
+        out << ind << "sq_get(v, -3);\n";
+    }
+    out << ind << "if(sq_newclass(v, "
+        << (_class->super_classes.size() > 0 ? "SQTrue" : "SQFalse")
+        << ") < 0) {\n";
+    out << ind << ind << "std::ostringstream msg;\n";
+    out << ind << ind << "msg << \"Couldn't create new class '"
+        << _class->name << "'\";\n";
+    out << ind << ind << "throw SquirrelError(v, msg.str());\n";
+    out << ind << "}\n";
+
+    for(std::vector<ClassMember*>::iterator i = _class->members.begin();
+            i != _class->members.end(); ++i) {
+        ClassMember* member = *i;
+        if(member->visibility != ClassMember::PUBLIC)
+            continue;
+        Function* function = dynamic_cast<Function*> (member);
+        if(function) {
+            create_register_function_code(function, _class);
+        }
+        Field* field = dynamic_cast<Field*> (member);
+        if(field) {
+            create_register_constant_code(field);
+        }
+    }
+
+    create_register_slot_code("class", _class->name);
+    out << "\n";
+
+    for(std::vector<Class*>::iterator i = _class->sub_classes.begin();
+            i != _class->sub_classes.end(); ++i) {
+        Class* _class = *i;
+        create_register_class_code(_class);
+    }
+}
+
+void
+WrapperCreator::create_register_constants_code(Namespace* ns)
+{
+    for(std::vector<Field*>::iterator i = ns->fields.begin();
+            i != ns->fields.end(); ++i) {
+        Field* field = *i;
+        create_register_constant_code(field);
+    }
+}
+
+void
+WrapperCreator::create_register_constant_code(Field* field)
+{
+    if(!field->has_const_value)
+        return;
+    out << ind << "sq_pushstring(v, \"" << field->name << "\", -1);\n";
+    if(field->type->atomic_type == &BasicType::INT) {
+        out << ind << "sq_pushinteger(v, " << field->const_int_value << ");\n";
+    } else if(field->type->atomic_type == &BasicType::FLOAT) {
+        out << ind << "sq_pushfloat(v, " << field->const_float_value << ");\n";
+    } else if(field->type->atomic_type == StringType::instance()) {
+        out << ind << "sq_pushstring(v, \""
+            << field->const_string_value << "\", -1);\n";
+    } else {
+      throw std::runtime_error("Constant is not int, float or string");
+    }
+    create_register_slot_code("constant", field->name);
+    out << "\n";
+}
+
+void
+WrapperCreator::create_register_slot_code(const std::string& what,
+                                          const std::string& name)
+{
+    out << ind << "if(SQ_FAILED(sq_createslot(v, -3))) {\n";
+    out << ind << ind << "throw SquirrelError(v, \""
+        << "Couldn't register " << what << " '" << name << "'\");\n";
+    out << ind << "}\n";
+}
+
+void
+WrapperCreator::create_function_wrapper(Class* _class, Function* function)
+{
+    if(function->type == Function::DESTRUCTOR)
+        assert(false);
+
+    std::string ns_prefix;
+    if(selected_namespace != "")
+        ns_prefix = selected_namespace + "::";
+    if(function->type == Function::CONSTRUCTOR)
+        function->name = "constructor";
+
+    out << "static SQInteger ";
+    if(_class != 0) {
+        out << _class->name << "_";
+    }
+    out << function->name << "_wrapper(HSQUIRRELVM vm)\n"
+        << "{\n";
+    // avoid warning...
+    if(_class == 0 && function->parameters.empty()
+            && function->return_type.is_void()
+            && function->type != Function::CONSTRUCTOR) {
+        out << ind << "(void) vm;\n";
+    }
+
+    // retrieve pointer to class instance
+    if(_class != 0 && function->type != Function::CONSTRUCTOR) {
+        out << ind << "SQUserPointer data;\n";
+        out << ind << "if(SQ_FAILED(sq_getinstanceup(vm, 1, &data, 0)) || !data) {\n";
+        out << ind << ind << "sq_throwerror(vm, _SC(\"'" << function->name << "' called without instance\"));\n";
+        out << ind << ind << "return SQ_ERROR;\n";
+        out << ind << "}\n";
+        out << ind << ns_prefix <<  _class->name << "* _this = reinterpret_cast<" << ns_prefix << _class->name << "*> (data);\n";
+    }
+
+    // custom function?
+    if(function->custom) {
+        if(function->type != Function::FUNCTION) 
+            throw std::runtime_error(
+                    "custom not allow constructor+destructor yet");
+        if(function->return_type.atomic_type != SQIntegerType::instance())
+            throw std::runtime_error("custom function '" + function->name + "' has to return SQInteger");
+        if(function->parameters.size() != 1)
+            throw std::runtime_error(
+                    "custom function '" + function->name + "' must have 1 HSQUIRRELVM parameter");
+
+        out << ind << "return ";
+        if(_class != 0)
+            out << "_this->";
+        else
+            out << ns_prefix;
+        out << function->name << "(vm);\n";
+        out << "}\n";
+        out << "\n";
+        return;
+    }
+
+    // declare and retrieve arguments
+    int i = 0;
+    int arg_offset = 2;
+    for(std::vector<Parameter>::iterator p = function->parameters.begin();
+            p != function->parameters.end(); ++p) {
+        if(i == 0 && p->type.atomic_type == HSQUIRRELVMType::instance()) {
+            out << ind << "HSQUIRRELVM arg0 = vm;\n";
+            arg_offset--;
+        } else {
+            char argname[64];
+            snprintf(argname, sizeof(argname), "arg%d", i);
+            prepare_argument(p->type, i + arg_offset, argname);
+        }
+        ++i;
+    }
+
+    // call function
+    out << "\n";
+    out << ind << "try {\n";
+    out << ind << ind;
+    if(!function->return_type.is_void()) {
+        function->return_type.write_c_type(out);
+        out << " return_value = ";
+    }
+    if(_class != 0) {
+        if(function->type == Function::CONSTRUCTOR) {
+            out << ns_prefix << _class->name << "* _this = new " << ns_prefix;
+        } else {
+            out << "_this->";
+        }
+    } else {
+        out << ns_prefix;
+    }
+    if(function->type == Function::CONSTRUCTOR) {
+        out << _class->name << "(";
+    } else {
+        out << function->name << "(";
+    }
+    for(size_t i = 0; i < function->parameters.size(); ++i) {
+        if(i != 0)
+            out << ", ";
+        const Parameter param = function->parameters[i];
+        if(param.type.ref == 0 && param.type.pointer == 0) {
+            if(param.type.atomic_type == &BasicType::INT)
+                out << "static_cast<int> (arg" << i << ")";
+            else if(param.type.atomic_type == &BasicType::FLOAT)
+                out << "static_cast<float> (arg" << i << ")";
+            else if(param.type.atomic_type == &BasicType::BOOL)
+                out << "arg" << i << " == SQTrue";
+            else
+                out << "arg" << i;
+        } else {
+            out << "arg" << i;
+        }
+    }
+    out << ");\n";
+    if(function->type == Function::CONSTRUCTOR) {
+        out << ind << "if(SQ_FAILED(sq_setinstanceup(vm, 1, _this))) {\n";
+        out << ind << ind << "sq_throwerror(vm, _SC(\"Couldn't setup instance of '" << _class->name << "' class\"));\n";
+        out << ind << ind << "return SQ_ERROR;\n";
+        out << ind << "}\n";
+        out << ind << "sq_setreleasehook(vm, 1, "
+            << _class->name << "_release_hook);\n";
+    }
+    out << "\n";
+    // push return value back on stack and return
+    if(function->suspend) {
+        if(!function->return_type.is_void()) {
+            std::stringstream msg;
+            msg << "Function '" << function->name << "' declared as suspend"
+                << " but has a return value.";
+            throw std::runtime_error(msg.str());
+        }
+        out << ind << ind << "return sq_suspendvm(vm);\n";
+    } else if(function->return_type.is_void()) {
+        out << ind << ind << "return 0;\n";
+    } else {
+        push_to_stack(function->return_type, "return_value");
+        out << ind << ind << "return 1;\n";
+    }
+
+    out << "\n";
+    out << ind << "} catch(std::exception& e) {\n";
+    out << ind << ind << "sq_throwerror(vm, e.what());\n";
+    out << ind << ind << "return SQ_ERROR;\n";
+    out << ind << "} catch(...) {\n";
+    out << ind << ind << "sq_throwerror(vm, _SC(\"Unexpected exception while executing function '" << function->name << "'\"));\n";
+    out << ind << ind << "return SQ_ERROR;\n";
+    out << ind << "}\n";
+    out << "\n";
+
+    out << "}\n";
+    out << "\n";
+}
+
+void
+WrapperCreator::prepare_argument(const Type& type, size_t index,
+        const std::string& var)
+{
+    if(type.ref > 0 && type.atomic_type != StringType::instance())
+        throw std::runtime_error("References not handled yet");
+    if(type.pointer > 0)
+        throw std::runtime_error("Pointers not handled yet");
+    if(type.atomic_type == &BasicType::INT) {
+        out << ind << "SQInteger " << var << ";\n";
+        out << ind << "if(SQ_FAILED(sq_getinteger(vm, " << index << ", &" << var << "))) {\n";
+        out << ind << ind << "sq_throwerror(vm, _SC(\"Argument " << (index-1) << " not an integer\"));\n";
+        out << ind << ind << "return SQ_ERROR;\n";
+        out << ind << "}\n";
+    } else if(type.atomic_type == &BasicType::FLOAT) {
+        out << ind << "SQFloat " << var << ";\n";
+        out << ind << "if(SQ_FAILED(sq_getfloat(vm, " << index << ", &" << var << "))) {\n";
+        out << ind << ind << "sq_throwerror(vm, _SC(\"Argument " << (index-1) << " not a float\"));\n";
+        out << ind << ind << "return SQ_ERROR;\n";
+        out << ind << "}\n";
+    } else if(type.atomic_type == &BasicType::BOOL) {
+        out << ind << "SQBool " << var << ";\n";
+        out << ind << "if(SQ_FAILED(sq_getbool(vm, " << index << ", &" << var << "))) {\n";
+        out << ind << ind << "sq_throwerror(vm, _SC(\"Argument " << (index-1) << " not a bool\"));\n";
+        out << ind << ind << "return SQ_ERROR;\n";
+        out << ind << "}\n";
+    } else if(type.atomic_type == StringType::instance()) {
+        out << ind << "const SQChar* " << var << ";\n";
+        out << ind << "if(SQ_FAILED(sq_getstring(vm, " << index << ", &" << var << "))) {\n";
+        out << ind << ind << "sq_throwerror(vm, _SC(\"Argument " << (index-1) << " not a string\"));\n";
+        out << ind << ind << "return SQ_ERROR;\n";
+        out << ind << "}\n";
+    } else {
+        std::ostringstream msg;
+        msg << "Type '" << type.atomic_type->name << "' not supported yet.";
+        throw std::runtime_error(msg.str());
+    }
+}
+
+void
+WrapperCreator::push_to_stack(const Type& type, const std::string& var)
+{
+    if(type.ref > 0 && type.atomic_type != StringType::instance())
+        throw std::runtime_error("References not handled yet");
+    if(type.pointer > 0)
+        throw std::runtime_error("Pointers not handled yet");
+    out << ind << ind;
+    if(type.atomic_type == &BasicType::INT) {
+        out << "sq_pushinteger(vm, " << var << ");\n";
+    } else if(type.atomic_type == &BasicType::FLOAT) {
+        out << "sq_pushfloat(vm, " << var << ");\n";
+    } else if(type.atomic_type == &BasicType::BOOL) {
+        out << "sq_pushbool(vm, " << var << ");\n";
+    } else if(type.atomic_type == StringType::instance()) {
+        out << "sq_pushstring(vm, " << var << ".c_str(), "
+            << var << ".size());\n";
+    } else {
+        std::ostringstream msg;
+        msg << "Type '" << type.atomic_type->name << "' not supported yet.";
+        throw std::runtime_error(msg.str());
+    }
+}
+
+void
+WrapperCreator::create_class_wrapper(Class* _class)
+{
+    create_class_release_hook(_class);
+    for(std::vector<ClassMember*>::iterator i = _class->members.begin();
+            i != _class->members.end(); ++i) {
+        ClassMember* member = *i;
+        if(member->visibility != ClassMember::PUBLIC)
+            continue;
+        Function* function = dynamic_cast<Function*> (member);
+        if(!function)
+            continue;
+        // don't wrap destructors
+        if(function->type == Function::DESTRUCTOR)
+            continue;
+        create_function_wrapper(_class, function);
+    }
+}
+
+void
+WrapperCreator::create_squirrel_instance(Class* _class)
+{
+    out << "void create_squirrel_instance(HSQUIRRELVM v, "
+        << ns_prefix << _class->name
+        << "* object, bool setup_releasehook)\n"
+        << "{\n"
+        << ind << "using namespace Wrapper;\n"
+        << "\n"
+        << ind << "sq_pushroottable(v);\n"
+        << ind << "sq_pushstring(v, \"" << _class->name << "\", -1);\n"
+        << ind << "if(SQ_FAILED(sq_get(v, -2))) {\n"
+        << ind << ind << "std::ostringstream msg;\n"
+        << ind << ind << "msg << \"Couldn't resolved squirrel type '"
+        << _class->name << "'\";\n"
+        << ind << ind << "throw SquirrelError(v, msg.str());\n"
+        << ind << "}\n"
+        << "\n"
+        << ind << "if(SQ_FAILED(sq_createinstance(v, -1)) || "
+        << "SQ_FAILED(sq_setinstanceup(v, -1, object))) {\n"
+        << ind << ind << "std::ostringstream msg;\n"
+        << ind << ind << "msg << \"Couldn't setup squirrel instance for "
+        << "object of type '" << _class->name << "'\";\n"
+        << ind << ind << "throw SquirrelError(v, msg.str());\n"
+        << ind << "}\n"
+        << ind << "sq_remove(v, -2); // remove object name\n"
+        << "\n"
+        << ind << "if(setup_releasehook) {\n"
+        << ind << ind << "sq_setreleasehook(v, -1, "
+        << _class->name << "_release_hook);\n"
+        << ind << "}\n"
+        << "\n"
+        << ind << "sq_remove(v, -2); // remove root table\n"
+        << "}\n"
+        << "\n";
+}
+
+void
+WrapperCreator::create_class_release_hook(Class* _class)
+{
+    out << "static SQInteger " << _class->name << "_release_hook(SQUserPointer ptr, SQInteger )\n"
+        << "{\n"
+        << ind << ns_prefix << _class->name
+        << "* _this = reinterpret_cast<" << ns_prefix << _class->name
+        << "*> (ptr);\n"
+        << ind << "delete _this;\n"
+        << ind << "return 0;\n"
+        << "}\n"
+        << "\n";
+}


Property changes on: trunk/windstille/external/miniswig/create_wrapper.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/external/miniswig/create_wrapper.hpp
===================================================================
--- trunk/windstille/external/miniswig/create_wrapper.hpp	2009-09-27 12:06:38 UTC (rev 3268)
+++ trunk/windstille/external/miniswig/create_wrapper.hpp	2009-09-28 16:49:13 UTC (rev 3269)
@@ -0,0 +1,46 @@
+#ifndef __CREATE_WRAPPER_H__
+#define __CREATE_WRAPPER_H__
+
+#include "tree.hpp"
+
+class WrapperCreator
+{
+public:
+    /// this is used for indentation
+    const char* ind;
+    // output stream
+    std::ostream& out;
+    std::ostream& hppout;
+
+    WrapperCreator(std::ostream& _out = std::cout, std::ostream& _hppout = std::cout)
+        : out(_out), hppout(_hppout)
+    {
+        ind = "  ";
+    }
+
+    void create_wrapper(Namespace* ns);
+
+private:
+    std::string ns_prefix;
+
+    void create_register_functions_code(Namespace* ns);
+    void create_register_function_code(Function* function, Class* _class);
+    void create_register_classes_code(Namespace* ns);
+    void create_register_class_code(Class* _class);
+    void create_register_constant_code(Field* field);
+    void create_register_constants_code(Namespace* ns);
+    void create_register_slot_code(const std::string& what,
+                                   const std::string& name);
+
+    void create_function_list(Namespace* ns);
+    void create_const_lists(Namespace* ns);
+    void create_class_const_lists(Class* _class);
+    void create_class_wrapper(Class* _class);
+    void create_class_release_hook(Class* _class);
+    void create_squirrel_instance(Class* _class);
+    void create_function_wrapper(Class* _class, Function* function);
+    void prepare_argument(const Type& type, size_t idx, const std::string& var);
+    void push_to_stack(const Type& type, const std::string& var);
+};
+
+#endif


Property changes on: trunk/windstille/external/miniswig/create_wrapper.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/external/miniswig/globals.hpp
===================================================================
--- trunk/windstille/external/miniswig/globals.hpp	2009-09-27 12:06:38 UTC (rev 3268)
+++ trunk/windstille/external/miniswig/globals.hpp	2009-09-28 16:49:13 UTC (rev 3269)
@@ -0,0 +1,29 @@
+#ifndef __GLOBALS_H__
+#define __GLOBALS_H__
+
+#include "tree.hpp"
+#include <iostream>
+
+// parsing
+extern CompilationUnit* unit;
+extern bool search_down;
+extern Namespace* search_namespace;
+extern Namespace* current_namespace;
+extern std::string last_docucomment;
+// the first file indicated by # 1 "..."
+// (this is what the C preprocessor outputs so that you know which was the
+// original file before preprocessing
+extern std::string original_file;
+// the filename where the current fragment came from (before it was included by
+// the preprocessor)
+extern std::string current_file;
+// get line number inside the current_file
+int getCurrentLine();
+
+// config/output
+extern std::istream* input;
+extern std::string inputfile;
+extern std::string modulename;
+extern std::string selected_namespace;
+
+#endif


Property changes on: trunk/windstille/external/miniswig/globals.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/external/miniswig/lexer.ll
===================================================================
--- trunk/windstille/external/miniswig/lexer.ll	2009-09-27 12:06:38 UTC (rev 3268)
+++ trunk/windstille/external/miniswig/lexer.ll	2009-09-28 16:49:13 UTC (rev 3269)
@@ -0,0 +1,139 @@
+%{
+#include <config.h>
+  
+#include <math.h>
+#include <stdlib.h>
+#include <string.h>
+#include <iostream>
+#include "tree.hpp"
+#include "parser.hpp"
+#include "globals.hpp"
+
+// there seems to be a bug in flex that adds some ECHO directives
+// in some rules, we don't need debug output
+#define ECHO  {}
+
+#define YY_NEVER_INTERACTIVE 1
+#define YY_DECL int yylex(YYSTYPE* yylval)
+
+#define YY_INPUT(buf, result, max_size)                     \
+{                                                           \
+    input->read(buf, max_size);                             \
+    result = input->gcount();                               \
+}
+
+std::string last_docucomment;
+std::string original_file;
+std::string current_file;
+std::string comm;
+int offset_lnum;
+
+int getCurrentLine()
+{
+    return yylineno - offset_lnum;
+}
+    
+%}
+
+%option noyywrap
+%option yylineno
+/* %option never-interactive */
+
+%x comment
+%%
+
+#[ \t]+[0-9]+[ \t]+.*                         {
+    int lnum;
+    char file[1024];
+    if(sscanf(yytext, "# %d \"%1023[^\"]\"", &lnum, file) == 2) {
+        offset_lnum = yylineno - lnum + 1;
+        current_file = file;
+        if(original_file == "")
+            original_file = file;
+    } else {
+        std::cerr << "Warning: Parse error in processor info directive.\n";
+    }
+}
+#.*                                     /* ignore preprocessor directives */
+[[:space:]]+                            /* eat spaces */
+"/*"                                    { BEGIN(comment); comm = ""; }
+<comment>[^*\n]*                        { comm += yytext; }
+<comment>"*"+[^*/]*                     { comm += yytext; }
+<comment>"*/"                    {
+    BEGIN(INITIAL);
+    if(comm[0] == '*') { // It's a docu comment...
+        last_docucomment = "";
+        bool linestart = true;
+        for(size_t i = 1; i < comm.size(); ++i) {
+            if(linestart && (comm[i] == '*' || isspace(comm[i]))) {
+                continue;
+            } else if(comm[i] == '\n') {
+                linestart = true;
+            } else {
+                linestart = false;
+            }
+            last_docucomment += comm[i];
+        }
+    }
+}
+\/\/[^\n]*\n                            {
+    if(yytext[2] == '/') { // it's a docu comment...
+        last_docucomment = std::string(yytext+3, strlen(yytext)-4);
+    }
+}
+class                                   { return T_CLASS; }
+struct                                  { return T_STRUCT; }
+static                                  { return T_STATIC; }
+virtual                                 { }
+const                                   { return T_CONST; }
+unsigned                                { return T_UNSIGNED; }
+signed                                  { return T_SIGNED; }
+void                                    { return T_VOID; }
+bool                                    { return T_BOOL; }
+char                                    { return T_CHAR; }
+short                                   { return T_SHORT; }
+int                                     { return T_INT; }
+long                                    { return T_LONG; }
+float                                   { return T_FLOAT; }
+double                                  { return T_DOUBLE; }
+public                                  { return T_PUBLIC; }
+protected                               { return T_PROTECTED; }
+private                                 { return T_PRIVATE; }
+namespace                               { return T_NAMESPACE; }
+__suspend                               { return T_SUSPEND; }
+__custom                                { return T_CUSTOM; }
+[a-zA-Z_][a-zA-Z_0-9]*                  {
+        Namespace* ns = search_namespace;
+        if(ns == 0)
+            ns = current_namespace;          
+        // is it a type?
+        yylval->atomic_type = ns->_findType(yytext, search_down);
+        if(yylval->atomic_type) {
+            return T_ATOMIC_TYPE;
+        }
+        // or a namespace? (hack for now...)
+        yylval->_namespace = ns->_findNamespace(yytext, search_down);
+        if(yylval->_namespace) {
+            return T_NAMESPACEREF;
+        }
+        // a new ID
+        yylval->str = strdup(yytext);
+        return T_ID;
+}
+\:\:                                    { return T_DDCOL; }
+(0x)?[0-9]+ {
+        sscanf(yytext, "%i", &(yylval->ival));
+        return T_INT;
+}
+[0-9]*\.[0-9]+(e[0-9]+)? { 
+        sscanf(yytext, "%f", &(yylval->fval));
+        return T_FLOAT;
+}
+\".*\" {
+        yylval->str = strdup(yytext);
+        return T_STRING;
+}
+.                                       { return yytext[0]; }
+
+%%
+

Added: trunk/windstille/external/miniswig/main.cpp
===================================================================
--- trunk/windstille/external/miniswig/main.cpp	2009-09-27 12:06:38 UTC (rev 3268)
+++ trunk/windstille/external/miniswig/main.cpp	2009-09-28 16:49:13 UTC (rev 3269)
@@ -0,0 +1,146 @@
+#include <config.h>
+
+#include <iostream>
+#include <fstream>
+#include <vector>
+#include <string>
+#include <cstring>
+#include "tree.hpp"
+#include "globals.hpp"
+#include "create_wrapper.hpp"
+#include "create_docu.hpp"
+
+extern int yyparse();
+extern int yylex();
+
+CompilationUnit* unit = 0;
+std::istream* input = 0;
+std::string inputfile;
+std::string selected_namespace;
+std::string modulename = "wrapper";
+
+void usage()
+{
+    std::cout << "Usage: miniswig --input FILE --output-cpp FILE --output-hpp FILE [--module NAME] [--select-namespace NAME]\n";
+    std::cout << "\n";
+}
+
+int main(int argc, char** argv)
+{
+    std::string outputcpp;
+    std::string outputhpp;
+    std::string output_doc;
+    for(int i = 0; i < argc; ++i) {
+        if(strcmp(argv[i], "--module") == 0) {
+            if(i+1 >= argc) {
+                std::cerr << "Need to specify a module name.\n";
+                usage();
+                return 1;
+            }
+            modulename = argv[++i];
+        } else if(strcmp(argv[i], "--input") == 0) {
+            if(i+1 >= argc) {
+                std::cerr << "Need to specify input file name.\n";
+                usage();
+                return 1;
+            }
+            inputfile = argv[++i];
+        } else if(strcmp(argv[i], "--output-cpp") == 0) {
+            if(i+1 >= argc) {
+                std::cerr << "Need to specify output cpp name.\n";
+                usage();
+                return 1;
+            }
+            outputcpp = argv[++i];
+        } else if(strcmp(argv[i], "--output-hpp") == 0) {
+            if(i+1 >= argc) {
+                std::cerr << "Need to specify output hpp name.\n";
+                usage();
+                return 1;
+            }
+            outputhpp = argv[++i];
+        } else if(strcmp(argv[i], "--select-namespace") == 0) {
+            if(i+1 >= argc) {
+                std::cerr << "Need to specify a namespace.\n";
+                usage();
+                return 1;
+            }
+            selected_namespace = argv[++i];
+        } else if(strcmp(argv[i], "--output-doc") == 0) {
+          if(i+1 >= argc) {
+            std::cerr << "Need to specify document xml file.\n";
+            usage();
+            return 1;
+          }
+          output_doc = argv[++i];
+        } else if(argv[i][0] == '-') {
+            std::cerr << "Unknown option '" << argv[i] << "'.\n";
+            usage();
+            return 1;
+        } else {
+        }
+    }
+    if( inputfile == "" || (
+            (outputcpp == "" || outputhpp == "") && output_doc == "")) {
+        std::cerr << "Not all options specified.\n";
+        usage();
+        return 1;
+    }
+
+    try {
+        input = new std::ifstream(inputfile.c_str());
+        if(!input->good()) {
+            std::cerr << "Couldn't open file '" << input << "' for reading.\n";
+            return 1;
+        }
+        current_file = inputfile;
+        unit = new CompilationUnit();
+        Namespace* std_namespace = new Namespace();
+        std_namespace->name = "std";
+        std_namespace->types.push_back(new StringType());
+        unit->namespaces.push_back(std_namespace);
+        unit->types.push_back(new HSQUIRRELVMType());
+        unit->types.push_back(new SQIntegerType());
+
+        yyparse();
+
+        Namespace* ns = unit;
+        if(selected_namespace != "") {
+            ns = ns->findNamespace(selected_namespace);
+        }
+
+        if(outputcpp != "") {
+            std::ofstream cppout(outputcpp.c_str());
+            if(!cppout.good()) {
+                std::cerr << "Couldn't open file '"
+                          << outputcpp << "' for writing.\n";
+                return 1;
+            }
+            std::ofstream hppout(outputhpp.c_str());
+            if(!hppout.good()) {
+                std::cerr << "Couldn't open file '" << outputhpp
+                          << "' for writing.\n";
+                return 1;
+            }
+
+            WrapperCreator creator(cppout, hppout);
+            creator.create_wrapper(ns);
+        }
+
+        if(output_doc != "") {
+            std::ofstream dout(output_doc.c_str());
+            if(!dout.good()) {
+                std::cerr << "Couldn't open file '"
+                    << output_doc << "' for writing.\n";
+                return 1;
+            }
+            DocuCreator creator(dout);
+            creator.create_docu(ns);
+        }
+    } catch(std::exception& e) {
+        std::cerr << "Exception: " << e.what() << "\n";
+        return 1;
+    }
+
+    return 0;
+}


Property changes on: trunk/windstille/external/miniswig/main.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/external/miniswig/parser.yy
===================================================================
--- trunk/windstille/external/miniswig/parser.yy	2009-09-27 12:06:38 UTC (rev 3268)
+++ trunk/windstille/external/miniswig/parser.yy	2009-09-28 16:49:13 UTC (rev 3269)
@@ -0,0 +1,448 @@
+%{
+#include <config.h>
+
+#include <iostream>
+#include <sstream>
+#include <stdexcept>
+#include "tree.hpp"
+#include "globals.hpp"
+
+%}
+
+%pure_parser
+%union {
+    char*       str;
+    int         ival;
+    float       fval;
+    Class*      _class;
+    Function*   function;
+    Field*      field;
+    Type*       type;
+    AtomicType* atomic_type;
+    Namespace*  _namespace;
+}
+
+%{
+
+extern int yylex(YYSTYPE* yylval);
+void yyerror(const char* s);
+extern int yylineno;
+
+bool search_down = true;
+Namespace* search_namespace = 0;
+Namespace* current_namespace = 0;
+static Class* current_class = 0;
+static Function* current_function = 0;
+static Type* current_type = 0;
+static Field* current_field = 0;
+static ClassMember::Visibility current_visibility;
+
+class ParseError : public std::exception
+{
+public:
+    ParseError(const std::string& message) throw()
+    {
+        std::ostringstream msg;
+        msg << "Parse error in '" << current_file
+            << "' line " << getCurrentLine() << ": "
+            << message;
+        this->message = msg.str();
+    }
+    virtual ~ParseError() throw()
+    {}
+    const char* what() const throw()
+    {
+        return message.c_str();
+    }
+
+private:
+    std::string message;
+};
+
+%}
+
+%token <ival> T_INT
+%token <fval> T_FLOAT
+%token <str>  T_STRING
+%token <str>  T_ID
+%token <atomic_type> T_ATOMIC_TYPE
+%token <_namespace> T_NAMESPACEREF
+%token T_CLASS
+%token T_STRUCT
+%token T_STATIC
+%token T_SUSPEND
+%token T_CUSTOM
+%token T_CONST
+%token T_UNSIGNED
+%token T_SIGNED
+%token T_VOID
+%token T_BOOL
+%token T_CHAR
+%token T_SHORT
+%token T_LONG
+%token T_DOUBLE
+%token T_PUBLIC
+%token T_PROTECTED
+%token T_PRIVATE
+%token T_NAMESPACE
+%token T_DDCOL "::"
+
+%type <_class> class_declaration
+%type <function> function_declaration
+%type <function> constructor_declaration;
+%type <function> destructor_declaration;
+%type <field> field_declaration;
+%type <type>   type
+%type <atomic_type> type_identifier
+
+%%
+
+input:
+        {
+            current_namespace = unit;
+        }
+    namespace_members
+;
+
+namespace_members: /* empty */
+    | namespace_members namespace_member
+;
+
+namespace_declaration:
+    T_NAMESPACE T_ID '{' 
+        {
+            Namespace* newNamespace = new Namespace();
+            newNamespace->name = $2;
+            free($2);
+            current_namespace->add_namespace(newNamespace);
+            current_namespace = newNamespace;
+        }
+    namespace_members '}'
+        {
+            current_namespace = current_namespace->parent;
+        }
+    | T_NAMESPACE T_NAMESPACEREF '{'
+        {
+            current_namespace = $2;
+        }
+    namespace_members '}'
+        {
+            current_namespace = current_namespace->parent;
+        }
+;
+
+namespace_member:
+    class_declaration
+        { current_namespace->add_type($1); }
+    | function_declaration
+        { current_namespace->functions.push_back($1); }
+    | namespace_declaration
+    | field_declaration
+        { current_namespace->fields.push_back($1); }
+;  
+
+class_declaration:
+    T_CLASS T_ID 
+        {
+            current_class = new Class();
+            current_class->name = $2;
+            free($2);
+            current_class->docu_comment = last_docucomment;
+            last_docucomment = "";
+            current_visibility = ClassMember::PROTECTED;
+        }
+    superclass_list '{' class_body '}' ';'
+        {
+            $$ = current_class;
+        }
+;
+
+superclass_list:
+    /* empty */
+    | ':' superclasses
+;
+
+superclasses:
+      superclass
+    | superclasses ',' superclass
+;
+
+superclass:
+    superclass_visibility type_identifier
+        {
+            Class* superclass = dynamic_cast<Class*> ($2);
+            if(superclass == 0)
+                throw ParseError("SuperClass is not a Class type");
+            current_class->super_classes.push_back(superclass);
+            superclass->sub_classes.push_back(current_class);
+        }
+;
+
+superclass_visibility:
+    T_PUBLIC
+    | T_PROTECTED
+    | T_PRIVATE
+;
+
+class_body: /* empty */
+        | class_body class_body_element
+;
+
+class_body_element:
+        visibility_change
+        | constructor_declaration
+            { 
+                $1->visibility = current_visibility;
+                current_class->members.push_back($1);
+            }
+        | destructor_declaration
+            {
+                $1->visibility = current_visibility;
+                current_class->members.push_back($1);
+            }
+        | function_declaration
+            {
+                $1->visibility = current_visibility;
+                current_class->members.push_back($1);
+            }
+        | field_declaration
+            {
+                $1->visibility = current_visibility;
+                current_class->members.push_back($1);
+            }
+;
+
+visibility_change:
+    T_PUBLIC ':'
+        { current_visibility = ClassMember::PUBLIC; }
+    |   T_PROTECTED ':'
+        { current_visibility = ClassMember::PROTECTED; }
+    |   T_PRIVATE ':'
+        { current_visibility = ClassMember::PRIVATE; }
+;
+
+constructor_declaration:    
+    T_ID '('
+        {
+            current_function = new Function();
+            current_function->type = Function::CONSTRUCTOR;
+            current_function->docu_comment = last_docucomment;
+            last_docucomment = "";
+            free($1);
+        }
+    parameter_list ')' ';'
+        {
+            $$ = current_function;
+        }
+;
+
+destructor_declaration:
+    '~' T_ID '(' ')' abstract_declaration ';'
+        {
+            current_function = new Function();
+            current_function->type = Function::DESTRUCTOR;
+            current_function->docu_comment = last_docucomment;
+            last_docucomment = "";
+            free($2);
+            $$ = current_function;
+        }
+;
+
+field_declaration:
+    type T_ID 
+        {
+            current_field = new Field();
+            current_field->type = $1;
+            current_field->docu_comment = last_docucomment;
+            last_docucomment = "";
+            current_field->name = $2;
+            free($2);
+        }
+    maybe_const_initialisation ';'
+        {
+            $$ = current_field;
+        }
+;
+
+maybe_const_initialisation:
+    /* empty */
+    | '=' T_INT
+        {
+            if(current_field->type->atomic_type == &BasicType::FLOAT) {
+                current_field->const_float_value = (float) $2;
+            } else {
+                current_field->const_int_value = $2;
+            }
+            current_field->has_const_value = true;
+        }
+    | '=' T_FLOAT
+        {
+            current_field->const_float_value = $2;
+            current_field->has_const_value = true;
+        }
+    | '=' T_STRING
+        {
+            current_field->const_string_value = $2;
+            current_field->has_const_value = true;
+        }
+;          
+
+function_declaration:
+    type T_ID '(' 
+        {
+            current_function = new Function();
+            current_function->type = Function::FUNCTION;
+            current_function->return_type = *($1);
+            delete $1;
+            current_function->name = $2;
+            free($2);
+            current_function->docu_comment = last_docucomment;
+            last_docucomment = "";
+        }                           
+    parameter_list ')' function_attributes abstract_declaration ';'
+        {
+            $$ = current_function;
+        }
+;
+
+function_attributes:
+    /* empty */
+    | T_CONST function_attributes
+    | T_CUSTOM '(' T_STRING ')' function_attributes
+      {
+        current_function->parameter_spec = $3;
+        current_function->custom = true;
+      }
+    | T_SUSPEND function_attributes
+      {
+        current_function->suspend = true;
+      }
+;
+
+abstract_declaration:
+    /* empty */
+    | '=' T_INT
+;
+
+parameter_list:
+    /* empty */
+    | parameters
+;
+
+parameters:
+    parameter
+    | parameters ',' parameter
+;
+
+parameter:
+    type
+        {
+            Parameter parameter;
+            parameter.type = *($1);
+            delete $1;
+            current_function->parameters.push_back(parameter);
+        }
+    | type T_ID
+        {
+            Parameter parameter;
+            parameter.type = *($1);
+            delete $1;
+            parameter.name = $2;
+            free($2);
+            current_function->parameters.push_back(parameter);
+        }
+;
+
+type:
+        {
+            current_type = new Type();
+        }
+    prefix_type_modifiers atomic_type postfix_type_modifiers 
+        {
+            $$ = current_type;
+        }
+;
+
+prefix_type_modifiers:
+    /* empty */
+    | prefix_type_modifiers prefix_type_modifier
+;
+
+prefix_type_modifier:
+    T_UNSIGNED
+        { current_type->_unsigned = true; }
+    | T_SIGNED
+        { current_type->_unsigned = false; }
+    | T_STATIC
+        { current_type->_static = true; }
+    | T_CONST
+        { current_type->_const = true; }
+;
+
+postfix_type_modifiers:
+    /* empty */
+    | postfix_type_modifiers postfix_type_modifier
+;
+
+postfix_type_modifier:
+    T_CONST
+        { current_type->_const = true; }
+    |   '*'
+        { current_type->pointer++; }
+    |   '&'
+        { current_type->ref++; }
+;
+
+atomic_type:
+    T_VOID
+        { current_type->atomic_type = &BasicType::VOID; }
+    | T_BOOL
+        { current_type->atomic_type = &BasicType::BOOL; }
+    | T_CHAR
+        { current_type->atomic_type = &BasicType::CHAR; }
+    | T_SHORT
+        { current_type->atomic_type = &BasicType::SHORT; }
+    | T_INT
+        { current_type->atomic_type = &BasicType::INT; }
+    | T_LONG
+        { current_type->atomic_type = &BasicType::LONG; }
+    | T_FLOAT
+        { current_type->atomic_type = &BasicType::FLOAT; }
+    | T_DOUBLE
+        { current_type->atomic_type = &BasicType::DOUBLE; }
+    | type_identifier
+        { current_type->atomic_type = $1; }
+;
+
+type_identifier:
+    T_ATOMIC_TYPE
+        {
+            $$ = $1;
+        }
+    | namespace_refs "::" T_ATOMIC_TYPE
+        {
+            $$ = $3;
+            search_namespace = 0;
+            search_down = true;
+        }
+;
+
+namespace_refs:
+    T_NAMESPACEREF
+        {
+            search_namespace = $1;
+            search_down = false;
+        }
+    | namespace_refs "::" T_NAMESPACEREF
+        {
+            search_namespace = $3;
+        }
+;
+
+%%
+
+void yyerror(const char* error)
+{
+    throw ParseError(error);
+}
+

Added: trunk/windstille/external/miniswig/tree.cpp
===================================================================
--- trunk/windstille/external/miniswig/tree.cpp	2009-09-27 12:06:38 UTC (rev 3268)
+++ trunk/windstille/external/miniswig/tree.cpp	2009-09-28 16:49:13 UTC (rev 3269)
@@ -0,0 +1,15 @@
+#include <config.h>
+#include "tree.hpp"
+
+BasicType BasicType::VOID("void");
+BasicType BasicType::BOOL("bool");
+BasicType BasicType::CHAR("char");
+BasicType BasicType::SHORT("short");
+BasicType BasicType::INT("int");
+BasicType BasicType::LONG("long");
+BasicType BasicType::FLOAT("float");
+BasicType BasicType::DOUBLE("double");
+
+StringType* StringType::_instance = NULL;
+HSQUIRRELVMType* HSQUIRRELVMType::_instance = NULL;
+SQIntegerType* SQIntegerType::_instance = NULL;


Property changes on: trunk/windstille/external/miniswig/tree.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/external/miniswig/tree.hpp
===================================================================
--- trunk/windstille/external/miniswig/tree.hpp	2009-09-27 12:06:38 UTC (rev 3268)
+++ trunk/windstille/external/miniswig/tree.hpp	2009-09-28 16:49:13 UTC (rev 3269)
@@ -0,0 +1,312 @@
+#ifndef __TREE_H__
+#define __TREE_H__
+
+#include <vector>
+#include <string>
+#include <iostream>
+#include <sstream>
+#include <stdexcept>
+#include <assert.h>
+
+class Namespace;
+
+class AtomicType {
+public:
+    AtomicType()
+        : parent(0)
+    { }
+    virtual ~AtomicType()
+    { }
+
+    virtual void write_c(std::ostream& out)
+    {
+        out << name;
+    }
+
+    std::string name;
+    Namespace* parent;
+};
+
+class BasicType : public AtomicType {
+public:
+    static BasicType VOID;
+    static BasicType BOOL;
+    static BasicType CHAR;
+    static BasicType SHORT;
+    static BasicType INT;
+    static BasicType LONG;
+    static BasicType FLOAT;
+    static BasicType DOUBLE;
+
+private:
+    BasicType(const std::string& name)
+    {
+        this->name = name;
+    }
+};
+
+class Type {
+public:
+    Type()
+        : atomic_type(0), _unsigned(false), _const(false), _static(false),
+        pointer(0), ref(0)
+    { }
+
+    void write_c_type(std::ostream& out)
+    {
+        if(_static)
+            out << "static ";
+        if(_const)
+            out << "const ";
+        atomic_type->write_c(out);
+        for(int i = 0; i < pointer; ++i)
+            out << "*";
+        for(int i = 0; i < ref; ++i)
+            out << "&";
+    }
+
+    bool is_void() const
+    {
+        if(atomic_type == 0)
+            return true;
+        if(atomic_type == &BasicType::VOID && pointer == 0)
+            return true;
+        return false;
+    }
+
+    AtomicType* atomic_type;
+    bool _unsigned;
+    bool _const;
+    bool _static;
+    // number of '*' in the type declaration...
+    int pointer;
+    // number of '&' in the type declaration...
+    int ref;
+};
+
+class SQIntegerType : public AtomicType {
+public:
+    SQIntegerType()
+    {
+        this->name = "SQInteger";
+        assert(_instance == 0);
+        _instance = this;
+    }
+    virtual ~SQIntegerType()
+    {
+        assert(_instance == this);
+        _instance = NULL;
+    }
+
+    static SQIntegerType* instance()
+    {
+        return _instance;
+    }
+private:
+    static SQIntegerType* _instance;
+};
+
+class HSQUIRRELVMType : public AtomicType {
+public:
+    HSQUIRRELVMType()
+    {
+        this->name = "HSQUIRRELVM";
+        assert(_instance == 0);
+        _instance = this;
+    }
+    virtual ~HSQUIRRELVMType()
+    {
+        assert(_instance == this);
+        _instance = NULL;
+    }
+
+    static HSQUIRRELVMType* instance()
+    {
+        return _instance;
+    }
+private:
+    static HSQUIRRELVMType* _instance;
+};
+
+class StringType : public AtomicType {
+public:
+    StringType()
+    {
+        this->name = "string";
+        assert(_instance == 0);
+        _instance = this;
+    }
+    virtual ~StringType()
+    {
+        assert(_instance == this);
+        _instance = 0;
+    }
+
+    static StringType* instance()
+    {
+        return _instance;
+    }
+
+    virtual void write_c(std::ostream& out)
+    {
+        out << "std::string";
+    }
+
+private:
+    static StringType* _instance;
+};
+
+class Parameter {
+public:
+    std::string name;
+    Type type;
+};
+
+class ClassMember {
+public:
+    virtual ~ClassMember()
+    { }
+
+    enum Visibility {
+        PUBLIC,
+        PROTECTED,
+        PRIVATE
+    };
+    Visibility visibility;
+};
+
+class Function : public ClassMember {
+public:
+    Function() {
+      type = FUNCTION;
+      suspend = false;
+      custom = false;
+    }
+
+    enum FuncType {
+        FUNCTION,
+        CONSTRUCTOR,
+        DESTRUCTOR
+    };
+    FuncType type;
+    /// function should suspend squirrel VM after execution
+    bool suspend;
+    /// a custom wrapper (just pass along HSQUIRRELVM)
+    bool custom;
+    std::string parameter_spec;
+    std::string docu_comment;
+    std::string name;
+    Type return_type;
+    std::vector<Parameter> parameters;
+};
+
+class Field : public ClassMember {
+public:
+    Field()
+    {
+        has_const_value = false;
+    }
+
+    Type* type;
+    std::string docu_comment;
+    std::string name;
+    bool has_const_value;
+
+    union {
+        float const_float_value;
+        int const_int_value;
+    };
+    std::string const_string_value;
+};
+
+class Class : public AtomicType {
+public:
+    ~Class() {
+        for(std::vector<ClassMember*>::iterator i = members.begin();
+                i != members.end(); ++i)
+            delete *i;
+    }
+
+    std::vector<ClassMember*> members;
+    std::vector<Class*> super_classes;
+    std::vector<Class*> sub_classes;
+    std::string docu_comment;
+};
+
+class Namespace {
+public:
+    Namespace() {
+        parent = 0;
+    }
+    virtual ~Namespace() {
+        for(std::vector<Function*>::iterator i = functions.begin();
+                i != functions.end(); ++i)
+            delete *i;
+        for(std::vector<AtomicType*>::iterator i = types.begin();
+                i != types.end(); ++i)
+            delete *i;
+        for(std::vector<Namespace*>::iterator i = namespaces.begin();
+                i != namespaces.end(); ++i)
+            delete *i;
+    }
+    void add_type(AtomicType* type)
+    {
+        types.push_back(type);
+        type->parent = this;
+    }
+    void add_namespace(Namespace* ns)
+    {
+        namespaces.push_back(ns);
+        ns->parent = this;
+    }
+    AtomicType* _findType(const std::string& name, bool godown = false) {
+        for(std::vector<AtomicType*>::iterator i = types.begin();
+                i != types.end(); ++i) {
+            AtomicType* type = *i;
+            if(type->name == name)
+                return type;
+        }
+        if(godown && parent)
+            return parent->_findType(name, true);
+
+        return 0;
+    }
+
+    Namespace* _findNamespace(const std::string& name, bool godown = false) {
+        for(std::vector<Namespace*>::iterator i = namespaces.begin();
+                i != namespaces.end(); ++i) {
+            Namespace* ns = *i;
+            if(ns->name == name)
+                return ns;
+        }
+        if(godown && parent)
+            return parent->_findNamespace(name, true);
+
+        return 0;
+    }
+
+    Namespace* findNamespace(const std::string& name, bool godown = false) {
+        Namespace* ret = _findNamespace(name, godown);
+        if(!ret) {
+            std::ostringstream msg;
+            msg << "Couldn't find namespace '" << name << "'.";
+            throw std::runtime_error(msg.str());
+        }
+
+        return ret;
+    }
+
+    std::vector<Function*> functions;
+    std::vector<Field*> fields;
+    std::vector<AtomicType*> types;
+    std::vector<Namespace*> namespaces;
+
+    Namespace* parent;
+    std::string name;
+};
+
+class CompilationUnit : public Namespace {
+public:
+};
+
+#endif


Property changes on: trunk/windstille/external/miniswig/tree.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/external/miniswig/xmlwriter.cpp
===================================================================
--- trunk/windstille/external/miniswig/xmlwriter.cpp	2009-09-27 12:06:38 UTC (rev 3268)
+++ trunk/windstille/external/miniswig/xmlwriter.cpp	2009-09-28 16:49:13 UTC (rev 3269)
@@ -0,0 +1,77 @@
+#include <config.h>
+
+#include <stdexcept>
+#include <sstream>
+#include "xmlwriter.hpp"
+
+XmlWriter::XmlWriter(std::ostream& outstream)
+    : out(outstream), indent(0)
+{
+}
+
+XmlWriter::~XmlWriter()
+{
+    if(sections.size() > 0) {
+        std::cerr << "WARNING: NOT CLOSED: ";
+        for(std::vector<std::string>::iterator i = sections.begin();
+                i != sections.end(); ++i)
+            std::cerr << *i << " ";
+        std::cerr << "\n";
+    }
+
+    closeTag();
+}
+
+void XmlWriter::openTag(const char* name)
+{
+    newLine();
+    out << "<" << name;
+    closetag = ">";
+    indent++;
+
+    sections.push_back(name);
+}
+
+void XmlWriter::closeTag(const char* name)
+{
+    if(sections.size() == 0)
+	throw std::runtime_error("got closeSection without prior openSection.");
+
+    const std::string& lastsection = sections.back();
+    if (lastsection != name) {
+        std::ostringstream msg;
+        msg << "mismatch in open/closeSection. Expected '"
+            << lastsection << "' got '" << name << "'";
+        throw std::runtime_error(msg.str());
+    }
+    sections.pop_back();
+
+    indent--;
+    newLine();
+    // XXX: We should check for consistency here
+    out << "</" << name;
+    closetag = ">" ;
+}
+
+void XmlWriter::writeTag(const char* name)
+{
+    newLine();
+    out << "<" << name;
+    closetag = "/>";
+    lasttag = name;
+}
+
+void XmlWriter::newLine()
+{
+    if(closetag != "") {
+        closeTag();
+        for (int i=0;i<indent;i++)
+            out << "\t";
+    }
+}
+
+void XmlWriter::closeTag()
+{
+    if (closetag != "")
+	out << closetag << "\n";
+}


Property changes on: trunk/windstille/external/miniswig/xmlwriter.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/external/miniswig/xmlwriter.hpp
===================================================================
--- trunk/windstille/external/miniswig/xmlwriter.hpp	2009-09-27 12:06:38 UTC (rev 3268)
+++ trunk/windstille/external/miniswig/xmlwriter.hpp	2009-09-28 16:49:13 UTC (rev 3269)
@@ -0,0 +1,78 @@
+#ifndef __XMLWRITER_H__
+#define __XMLWRITER_H__
+
+#include <iostream>
+#include <vector>
+#include <string>
+
+/** This class is a class which helps printing formated xml output.
+ * Example:
+ *  This sequence:
+ *   xml.openTag("world");
+ *   xml.writeAttribute("name", "foo");
+ *   xml.writeTag("bar");
+ *   xml.writeTag("baz");
+ *   xml.writeAttribute("name", "boo");
+ *   xml.writeAttribute("style", "old");
+ *   xml.write("text");
+ *   xml.closeTag("world");
+ *  results in this output:
+ *   <world name="foo">
+ *     <bar/>
+ *     <baz name="boo" style="old">text</baz>
+ *   </world>
+ */
+class XmlWriter {
+public:
+    XmlWriter(std::ostream& out);
+    ~XmlWriter();
+
+    /** Start a xml tag which contains subtags */
+    void openTag(const char* name);
+    /** Closes an xml tag with subtags */
+    void closeTag(const char* name);
+
+    void writeTag(const char* name);
+
+    template <class T>
+      void comment(const T& outp)
+      {   // This routine writes just about anything as an XML comment.
+	newLine();
+	out << "<!-- " << outp ;
+	closetag = " -->";
+      }
+
+
+    template<class T>
+    void write(const T& text)
+    {
+        if (closetag[0]=='>') {
+            out << ">";
+            closetag = "";
+        } else if (closetag[0]=='/') {
+      	    out << ">"; // eventually we should place a \n here
+	    closetag = "</";
+	    closetag += lasttag;
+	    closetag += ">";
+	}
+	out << text;
+    }
+
+    template<class T>
+    void writeAttribute(const char* name, T value)
+    {
+	out << " " << name << "=\"" << value << "\"";
+    }
+
+private:
+    void newLine();
+    void closeTag();
+
+    std::ostream& out;
+    int indent;
+    std::string closetag;
+    std::string lasttag;
+    std::vector<std::string> sections;
+};
+
+#endif


Property changes on: trunk/windstille/external/miniswig/xmlwriter.hpp
___________________________________________________________________
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Mon Sep 28 19:09:24 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 28 Sep 2009 19:09:24 +0200
Subject: [Windstille-commit] r3270 - trunk/windstille/src/editor
Message-ID: <200909281709.n8SH9OEF001965@sheep.berlios.de>

Author: grumbel
Date: 2009-09-28 19:09:21 +0200 (Mon, 28 Sep 2009)
New Revision: 3270

Added:
   trunk/windstille/src/editor/timeline_object_layer.cpp
   trunk/windstille/src/editor/timeline_object_layer.hpp
   trunk/windstille/src/editor/timeline_properties.hpp
Modified:
   trunk/windstille/src/editor/decal_object_model.cpp
   trunk/windstille/src/editor/object_model.cpp
   trunk/windstille/src/editor/object_model.hpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
   trunk/windstille/src/editor/timeline.cpp
   trunk/windstille/src/editor/timeline.hpp
   trunk/windstille/src/editor/timeline_keyframe_object.hpp
   trunk/windstille/src/editor/timeline_layer.hpp
   trunk/windstille/src/editor/timeline_widget.cpp
Log:
Some more work on the Timeline stuff

Modified: trunk/windstille/src/editor/decal_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.cpp	2009-09-28 16:49:13 UTC (rev 3269)
+++ trunk/windstille/src/editor/decal_object_model.cpp	2009-09-28 17:09:21 UTC (rev 3270)
@@ -16,7 +16,10 @@
 **  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
 
+#include "editor/decal_object_model.hpp"
+
 #include <iostream>
+#include <boost/bind.hpp>
 
 #include "display/drawing_parameters.hpp"
 #include "display/scene_context.hpp"
@@ -28,8 +31,6 @@
 #include "scenegraph/scene_graph.hpp"
 #include "scenegraph/surface_drawable.hpp"
 #include "util/file_reader.hpp"
-
-#include "editor/decal_object_model.hpp"
 
 ObjectModelHandle
 DecalObjectModel::create(const std::string& name, const Vector2f& pos,

Modified: trunk/windstille/src/editor/object_model.cpp
===================================================================
--- trunk/windstille/src/editor/object_model.cpp	2009-09-28 16:49:13 UTC (rev 3269)
+++ trunk/windstille/src/editor/object_model.cpp	2009-09-28 17:09:21 UTC (rev 3270)
@@ -334,5 +334,39 @@
 
   return snap;
 }
+
+void
+ObjectModel::get_property(TimelineProperty property, float& value_out) const
+{
+}
+
+void
+ObjectModel::get_property(TimelineProperty property, const Vector2f& value_out) const
+{
+  switch(property)
+  {
+    case kPosition:
+      return rel_pos;
+  }
+}
+
+void
+ObjectModel::set_property(TimelineProperty property, float value)
+{
+}
+
+void
+ObjectModel::set_property(TimelineProperty property, const Vector2f& value)
+{
+  switch(property)
+  {
+    case kPosition:
+      rel_pos = value;
+      break;
+
+    default:
+      break;
+  }
+}
 
 /* EOF */

Modified: trunk/windstille/src/editor/object_model.hpp
===================================================================
--- trunk/windstille/src/editor/object_model.hpp	2009-09-28 16:49:13 UTC (rev 3269)
+++ trunk/windstille/src/editor/object_model.hpp	2009-09-28 17:09:21 UTC (rev 3270)
@@ -20,17 +20,20 @@
 #define HEADER_WINDSTILLE_EDITOR_OBJECT_MODEL_HPP
 
 #include <boost/weak_ptr.hpp>
+#include <boost/function.hpp>
 
 #include "editor/select_mask.hpp"
 #include "util/file_writer.hpp"
 #include "editor/control_point.hpp"
 #include "editor/snap_data.hpp"
+#include "editor/timeline_properties.hpp"
 
 class ObjectModel;
 class FileReader;
 class SceneContext;
 class SectorModel;
 class SceneGraph;
+class Vector2f;
 
 typedef boost::shared_ptr<ObjectModel> ObjectModelHandle;
 typedef boost::weak_ptr<ObjectModel>   ObjectModelPtr;
@@ -92,6 +95,12 @@
 
   virtual void add_control_points(std::vector<ControlPointHandle>& control_points) {}
   
+  virtual void get_property(TimelineProperty property, float& value_out) const;
+  virtual void get_property(TimelineProperty property, const Vector2f& value_out) const;
+
+  virtual void set_property(TimelineProperty property, float value);
+  virtual void set_property(TimelineProperty property, const Vector2f& value);
+
   /** This lets the object add things to the SceneGraph or do other
       things needed to make it properly visible in the SectorModel */
   virtual void add_to_scenegraph(SceneGraph& sg) =0;

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-28 16:49:13 UTC (rev 3269)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-28 17:09:21 UTC (rev 3270)
@@ -40,10 +40,10 @@
 
 LayerManagerColumns* LayerManagerColumns::instance_ = 0;
 
-
 SectorModel::SectorModel(const std::string& filename)
   : nav_graph(new NavigationGraphModel(*this)),
     layer_tree(Gtk::ListStore::create(LayerManagerColumns::instance())),
+    m_timeline(new Timeline()),
     ambient_color()
 {
   register_callbacks();
@@ -53,6 +53,7 @@
 SectorModel::SectorModel()
   : nav_graph(new NavigationGraphModel(*this)),
     layer_tree(Gtk::ListStore::create(LayerManagerColumns::instance())),
+    m_timeline(new Timeline()),
     ambient_color()
 {
   register_callbacks();

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-28 16:49:13 UTC (rev 3269)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-28 17:09:21 UTC (rev 3270)
@@ -29,6 +29,7 @@
 #include "editor/layer.hpp"
 #include "editor/object_model.hpp"
 #include "editor/selection.hpp"
+#include "editor/timeline.hpp"
 #include "math/vector2f.hpp"
 
 class NavigationGraphModel;
@@ -42,6 +43,7 @@
 private:
   boost::scoped_ptr<NavigationGraphModel> nav_graph;
   Glib::RefPtr<Gtk::ListStore> layer_tree;
+  TimelineHandle m_timeline;
   Color ambient_color;
   
 public:
@@ -95,6 +97,7 @@
   void write(FileWriter& writer) const;
 
   NavigationGraphModel& get_nav_graph() const { return *nav_graph; }
+  TimelineHandle get_timeline() const { return m_timeline; }
 
   void delete_navgraph_edges(NavGraphNodeObjectModel& node);
 

Modified: trunk/windstille/src/editor/timeline.cpp
===================================================================
--- trunk/windstille/src/editor/timeline.cpp	2009-09-28 16:49:13 UTC (rev 3269)
+++ trunk/windstille/src/editor/timeline.cpp	2009-09-28 17:09:21 UTC (rev 3270)
@@ -18,6 +18,7 @@
 
 #include "editor/timeline.hpp"
 
+#include "editor/timeline_object_layer.hpp"
 #include "editor/timeline_layer.hpp"
 
 Timeline::Timeline()
@@ -47,4 +48,10 @@
   return m_layers.back();
 }
 
+TimelineLayerHandle
+Timeline::add_object_layer(ObjectModelHandle object, TimelineProperty property)
+{
+  return TimelineLayerHandle(new TimelineObjectLayer(object, property));
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/timeline.hpp
===================================================================
--- trunk/windstille/src/editor/timeline.hpp	2009-09-28 16:49:13 UTC (rev 3269)
+++ trunk/windstille/src/editor/timeline.hpp	2009-09-28 17:09:21 UTC (rev 3270)
@@ -21,6 +21,8 @@
 
 #include "editor/timeline_object.hpp"
 #include "editor/timeline_layer.hpp"
+#include "editor/timeline_properties.hpp"
+#include "editor/object_model.hpp"
 
 class Vector2f;
 
@@ -47,6 +49,7 @@
   
   TimelineLayerHandle get_layer(int n) const;
   TimelineLayerHandle add_layer(const std::string& name);
+  TimelineLayerHandle add_object_layer(ObjectModelHandle object, TimelineProperty property);
 
 private:
   Timeline(const Timeline&);

Modified: trunk/windstille/src/editor/timeline_keyframe_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_keyframe_object.hpp	2009-09-28 16:49:13 UTC (rev 3269)
+++ trunk/windstille/src/editor/timeline_keyframe_object.hpp	2009-09-28 17:09:21 UTC (rev 3270)
@@ -40,6 +40,26 @@
   TimelineKeyframeObject& operator=(const TimelineKeyframeObject&);
 };
 
+template<typename C>
+class TimelineKeyframeDataObject : public TimelineObject
+{
+private:
+  C m_data;
+
+public:
+  TimelineKeyframeDataObject(float pos, const C& data)
+    : TimelineKeyframeDataObject(pos),
+      m_data(data)
+  {}
+
+  const C& get_data() const { return m_data; }
+  void     set_data(const C& data) { m_data = data; }
+
+private:
+  TimelineKeyframeDataObject(const TimelineKeyframeDataObject&);
+  TimelineKeyframeDataObject& operator=(const TimelineKeyframeDataObject&);
+};
+
 #endif
 
 /* EOF */

Modified: trunk/windstille/src/editor/timeline_layer.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer.hpp	2009-09-28 16:49:13 UTC (rev 3269)
+++ trunk/windstille/src/editor/timeline_layer.hpp	2009-09-28 17:09:21 UTC (rev 3270)
@@ -38,6 +38,7 @@
 
 public:
   TimelineLayer(const std::string& name);
+  virtual ~TimelineLayer() {}
 
   iterator begin() { return m_objects.begin(); }
   iterator end()   { return m_objects.end();   }

Added: trunk/windstille/src/editor/timeline_object_layer.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_object_layer.cpp	2009-09-28 16:49:13 UTC (rev 3269)
+++ trunk/windstille/src/editor/timeline_object_layer.cpp	2009-09-28 17:09:21 UTC (rev 3270)
@@ -0,0 +1,28 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#include "timeline_object_layer.hpp"
+
+TimelineObjectLayer::TimelineObjectLayer(ObjectModelHandle object, TimelineProperty property)
+  : TimelineLayer("TimelineObjectLayer"),
+    m_object(object),
+    m_property(property)
+{
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline_object_layer.cpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/timeline_object_layer.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_object_layer.hpp	2009-09-28 16:49:13 UTC (rev 3269)
+++ trunk/windstille/src/editor/timeline_object_layer.hpp	2009-09-28 17:09:21 UTC (rev 3270)
@@ -0,0 +1,55 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_TIMELINE_OBJECT_LAYER_HPP
+#define HEADER_WINDSTILLE_TIMELINE_OBJECT_LAYER_HPP
+
+#include "editor/timeline_layer.hpp"
+#include "editor/object_model.hpp"
+
+class TimelineObjectLayer : public TimelineLayer
+{
+private:
+  ObjectModelHandle m_object;
+  TimelineProperty  m_property;
+
+public:
+  TimelineObjectLayer(ObjectModelHandle object, TimelineProperty property);
+
+private:
+  TimelineObjectLayer(const TimelineObjectLayer&);
+  TimelineObjectLayer& operator=(const TimelineObjectLayer&);
+};
+
+template<typename C>
+class TimelineObjectDataLayer : public TimelineObjectLayer
+{
+public:
+  TimelineObjectDataLayer(ObjectModelHandle object, TimelineProperty property)
+    : TimelineObjectLayer(object, property)
+  {}
+
+  void apply(float pos)
+  {
+    //object->set_property(property, value);
+  }
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline_object_layer.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Added: trunk/windstille/src/editor/timeline_properties.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_properties.hpp	2009-09-28 16:49:13 UTC (rev 3269)
+++ trunk/windstille/src/editor/timeline_properties.hpp	2009-09-28 17:09:21 UTC (rev 3270)
@@ -0,0 +1,32 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_TIMELINE_PROPERTIES_HPP
+#define HEADER_WINDSTILLE_TIMELINE_PROPERTIES_HPP
+
+enum TimelineProperty
+{
+  kPosition,
+  kColor,
+  kRotation,
+  kScale
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline_properties.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/editor/timeline_widget.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_widget.cpp	2009-09-28 16:49:13 UTC (rev 3269)
+++ trunk/windstille/src/editor/timeline_widget.cpp	2009-09-28 17:09:21 UTC (rev 3270)
@@ -290,7 +290,7 @@
     bool in_selection = m_selection.find(*i) != m_selection.end();
 
     if (boost::shared_ptr<TimelineKeyframeObject> keyframe =
-        boost::dynamic_pointer_cast<TimelineKeyframeObject>(*i))
+        boost::dynamic_pointer_cast<TimelineKeyframeObject>(*i)) //FIXME:
     {
       cr->save();
         



From grumbel at mail.berlios.de  Mon Sep 28 19:31:29 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 28 Sep 2009 19:31:29 +0200
Subject: [Windstille-commit] r3271 - trunk/windstille/external/miniswig
Message-ID: <200909281731.n8SHVTXc031536@sheep.berlios.de>

Author: grumbel
Date: 2009-09-28 19:31:29 +0200 (Mon, 28 Sep 2009)
New Revision: 3271

Modified:
   trunk/windstille/external/miniswig/lexer.ll
Log:
Changed include filename to work properly with the scons build script

Modified: trunk/windstille/external/miniswig/lexer.ll
===================================================================
--- trunk/windstille/external/miniswig/lexer.ll	2009-09-28 17:09:21 UTC (rev 3270)
+++ trunk/windstille/external/miniswig/lexer.ll	2009-09-28 17:31:29 UTC (rev 3271)
@@ -6,7 +6,7 @@
 #include <string.h>
 #include <iostream>
 #include "tree.hpp"
-#include "parser.hpp"
+#include "parser.cc.hpp"
 #include "globals.hpp"
 
 // there seems to be a bug in flex that adds some ECHO directives



From grumbel at mail.berlios.de  Tue Sep 29 01:59:56 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 29 Sep 2009 01:59:56 +0200
Subject: [Windstille-commit] r3272 - trunk/windstille/src/editor
Message-ID: <200909282359.n8SNxuo1008545@sheep.berlios.de>

Author: grumbel
Date: 2009-09-29 01:59:54 +0200 (Tue, 29 Sep 2009)
New Revision: 3272

Added:
   trunk/windstille/src/editor/timeline_commands.hpp
Modified:
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/document.hpp
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/object_model.cpp
   trunk/windstille/src/editor/object_model.hpp
   trunk/windstille/src/editor/timeline.cpp
   trunk/windstille/src/editor/timeline.hpp
   trunk/windstille/src/editor/timeline_keyframe_object.hpp
   trunk/windstille/src/editor/timeline_layer.cpp
   trunk/windstille/src/editor/timeline_layer.hpp
   trunk/windstille/src/editor/timeline_object_layer.hpp
   trunk/windstille/src/editor/timeline_widget.cpp
   trunk/windstille/src/editor/windstille_widget.cpp
Log:
Basic creation of keyframes is now working on the code side, interface still lacking

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-28 17:31:29 UTC (rev 3271)
+++ trunk/windstille/src/editor/document.cpp	2009-09-28 23:59:54 UTC (rev 3272)
@@ -34,6 +34,7 @@
 #include "editor/layer_commands.hpp"
 #include "editor/navgraph_commands.hpp"
 #include "editor/object_commands.hpp"
+#include "editor/timeline_commands.hpp"
 
 Document::Document()
   : m_undo_manager(new UndoManager()),
@@ -242,6 +243,13 @@
 }
 
 void
+Document::timeline_add_keyframe(ObjectModelHandle object, TimelineProperty property, float pos)
+{
+  std::cout << object << " " << property << " " << pos << std::endl;
+  execute(CommandHandle(new TimelineAddKeyframeCommand(*m_sector_model, object, property, pos)));
+}
+
+void
 Document::selection_raise()
 {
   for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)

Modified: trunk/windstille/src/editor/document.hpp
===================================================================
--- trunk/windstille/src/editor/document.hpp	2009-09-28 17:31:29 UTC (rev 3271)
+++ trunk/windstille/src/editor/document.hpp	2009-09-28 23:59:54 UTC (rev 3272)
@@ -26,6 +26,7 @@
 #include "editor/selection.hpp"
 #include "editor/command.hpp"
 #include "editor/layer.hpp"
+#include "editor/timeline_properties.hpp"
 
 class UndoManager;
 class SectorModel;
@@ -37,7 +38,7 @@
  *  provides data and functions for editing that are not part of the
  *  central data, such as Selections and ControlPoints.
  */
-class Document // FIXME: name is not so great
+class Document
 {
 private:
   boost::scoped_ptr<UndoManager> m_undo_manager;
@@ -98,6 +99,11 @@
   void object_set_pos(ObjectModelHandle object, const Vector2f& new_pos);
   /** @} */
 
+  /* Timeline Commands
+   * @{*/
+  void timeline_add_keyframe(ObjectModelHandle object, TimelineProperty property, float pos);
+  /** @} */
+
   /* Selection Commands
    * @{*/
   void selection_raise();

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-28 17:31:29 UTC (rev 3271)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-28 23:59:54 UTC (rev 3272)
@@ -467,7 +467,7 @@
   paned->set_position(600);
 
   { // FIXME: some random data for testing
-    boost::shared_ptr<Timeline> timeline(new Timeline);
+    boost::shared_ptr<Timeline> timeline = wst->get_document().get_sector_model().get_timeline();   
 
     TimelineLayerHandle layer1 = timeline->add_layer("Layer1");
     TimelineLayerHandle layer2 = timeline->add_layer("Layer2");

Modified: trunk/windstille/src/editor/object_model.cpp
===================================================================
--- trunk/windstille/src/editor/object_model.cpp	2009-09-28 17:31:29 UTC (rev 3271)
+++ trunk/windstille/src/editor/object_model.cpp	2009-09-28 23:59:54 UTC (rev 3272)
@@ -341,12 +341,13 @@
 }
 
 void
-ObjectModel::get_property(TimelineProperty property, const Vector2f& value_out) const
+ObjectModel::get_property(TimelineProperty property, Vector2f& value_out) const
 {
   switch(property)
   {
     case kPosition:
-      return rel_pos;
+      value_out = rel_pos;
+      break;
   }
 }
 

Modified: trunk/windstille/src/editor/object_model.hpp
===================================================================
--- trunk/windstille/src/editor/object_model.hpp	2009-09-28 17:31:29 UTC (rev 3271)
+++ trunk/windstille/src/editor/object_model.hpp	2009-09-28 23:59:54 UTC (rev 3272)
@@ -96,7 +96,7 @@
   virtual void add_control_points(std::vector<ControlPointHandle>& control_points) {}
   
   virtual void get_property(TimelineProperty property, float& value_out) const;
-  virtual void get_property(TimelineProperty property, const Vector2f& value_out) const;
+  virtual void get_property(TimelineProperty property, Vector2f& value_out) const;
 
   virtual void set_property(TimelineProperty property, float value);
   virtual void set_property(TimelineProperty property, const Vector2f& value);

Modified: trunk/windstille/src/editor/timeline.cpp
===================================================================
--- trunk/windstille/src/editor/timeline.cpp	2009-09-28 17:31:29 UTC (rev 3271)
+++ trunk/windstille/src/editor/timeline.cpp	2009-09-28 23:59:54 UTC (rev 3272)
@@ -48,10 +48,29 @@
   return m_layers.back();
 }
 
-TimelineLayerHandle
-Timeline::add_object_layer(ObjectModelHandle object, TimelineProperty property)
+TimelineObjectLayerHandle 
+Timeline::create_object_layer(ObjectModelHandle object, TimelineProperty property)
 {
-  return TimelineLayerHandle(new TimelineObjectLayer(object, property));
+  switch(property)
+  {
+    case kPosition:
+      return TimelineObjectLayerHandle(new TimelineObjectDataLayer<Vector2f>(object, property));
+      
+    default:
+      throw std::runtime_error("Timeline::create_object_layer: unknown property given");
+  }
 }
 
+void
+Timeline::add_layer(TimelineLayerHandle layer)
+{
+  m_layers.push_back(layer);
+}
+
+void
+Timeline::remove_layer(TimelineLayerHandle layer)
+{
+  m_layers.erase(std::remove(m_layers.begin(), m_layers.end(), layer), m_layers.end());
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/timeline.hpp
===================================================================
--- trunk/windstille/src/editor/timeline.hpp	2009-09-28 17:31:29 UTC (rev 3271)
+++ trunk/windstille/src/editor/timeline.hpp	2009-09-28 23:59:54 UTC (rev 3272)
@@ -21,6 +21,7 @@
 
 #include "editor/timeline_object.hpp"
 #include "editor/timeline_layer.hpp"
+#include "editor/timeline_object_layer.hpp"
 #include "editor/timeline_properties.hpp"
 #include "editor/object_model.hpp"
 
@@ -48,9 +49,13 @@
   int size() const { return static_cast<int>(m_layers.size()); }
   
   TimelineLayerHandle get_layer(int n) const;
+
   TimelineLayerHandle add_layer(const std::string& name);
-  TimelineLayerHandle add_object_layer(ObjectModelHandle object, TimelineProperty property);
+  TimelineObjectLayerHandle create_object_layer(ObjectModelHandle object, TimelineProperty property);
 
+  void add_layer(TimelineLayerHandle layer);
+  void remove_layer(TimelineLayerHandle layer);
+
 private:
   Timeline(const Timeline&);
   Timeline& operator=(const Timeline&);

Added: trunk/windstille/src/editor/timeline_commands.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_commands.hpp	2009-09-28 17:31:29 UTC (rev 3271)
+++ trunk/windstille/src/editor/timeline_commands.hpp	2009-09-28 23:59:54 UTC (rev 3272)
@@ -0,0 +1,68 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_TIMELINE_COMMANDS_HPP
+#define HEADER_WINDSTILLE_TIMELINE_COMMANDS_HPP
+
+#include <boost/function.hpp>
+
+#include "editor/layer.hpp"
+#include "editor/object_model.hpp"
+#include "editor/command.hpp"
+#include "editor/timeline_properties.hpp"
+
+class TimelineAddKeyframeCommand : public Command
+{
+private:
+  SectorModel&         m_sector;
+  TimelineObjectLayerHandle m_layer;
+  ObjectModelHandle    m_object;
+  TimelineProperty     m_property;
+  TimelineObjectHandle m_keyframe;
+
+public:
+  TimelineAddKeyframeCommand(SectorModel& sector, ObjectModelHandle object, TimelineProperty property, float pos) :
+    m_sector(sector),
+    m_layer(),
+    m_object(object),
+    m_property(property)
+  {
+    m_layer    = m_sector.get_timeline()->create_object_layer(m_object, m_property);
+    m_keyframe = m_layer->create_keyframe(pos);
+  }
+  
+  void redo() 
+  {
+    m_sector.get_timeline()->add_layer(m_layer);
+    m_layer->add_object(m_keyframe);
+  }
+
+  void undo() 
+  {
+    m_layer->remove_object(m_keyframe);
+
+    if (m_layer->empty())
+    {
+      m_sector.get_timeline()->remove_layer(m_layer);
+    }
+  }
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline_commands.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/editor/timeline_keyframe_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_keyframe_object.hpp	2009-09-28 17:31:29 UTC (rev 3271)
+++ trunk/windstille/src/editor/timeline_keyframe_object.hpp	2009-09-28 23:59:54 UTC (rev 3272)
@@ -23,7 +23,7 @@
 
 class TimelineKeyframeObject : public TimelineObject
 {
-private:
+protected:
   float m_pos; 
 
 public:
@@ -33,7 +33,7 @@
 
   void  set_pos(float pos) { m_pos = pos; }
   float get_pos()   const { return m_pos; }
-  float get_width() const { return 1.0f; }
+  float get_width() const { return 0.0f; }
 
 private:
   TimelineKeyframeObject(const TimelineKeyframeObject&);
@@ -41,14 +41,14 @@
 };
 
 template<typename C>
-class TimelineKeyframeDataObject : public TimelineObject
+class TimelineKeyframeDataObject : public TimelineKeyframeObject
 {
 private:
   C m_data;
 
 public:
   TimelineKeyframeDataObject(float pos, const C& data)
-    : TimelineKeyframeDataObject(pos),
+    : TimelineKeyframeObject(pos),
       m_data(data)
   {}
 

Modified: trunk/windstille/src/editor/timeline_layer.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer.cpp	2009-09-28 17:31:29 UTC (rev 3271)
+++ trunk/windstille/src/editor/timeline_layer.cpp	2009-09-28 23:59:54 UTC (rev 3272)
@@ -32,13 +32,19 @@
   m_objects.push_back(object);
 }
 
+void
+TimelineLayer::remove_object(TimelineObjectHandle object)
+{
+  m_objects.erase(std::remove(m_objects.begin(), m_objects.end(), object), m_objects.end());
+}
+
 TimelineObjectHandle
 TimelineLayer::get_object(float pos) const
 {
   for(const_iterator i = begin(); i != end(); ++i)
   {
     if (pos >= (*i)->get_pos() &&
-        pos <  (*i)->get_pos() + (*i)->get_width())
+        pos <  (*i)->get_pos() + ((*i)->get_width() == 0 ? 1 : (*i)->get_width()))
     {
       return *i;
     }

Modified: trunk/windstille/src/editor/timeline_layer.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer.hpp	2009-09-28 17:31:29 UTC (rev 3271)
+++ trunk/windstille/src/editor/timeline_layer.hpp	2009-09-28 23:59:54 UTC (rev 3272)
@@ -46,7 +46,10 @@
   const_iterator begin() const { return m_objects.begin(); }
   const_iterator end()   const { return m_objects.end();   }
 
+  bool empty() const { return m_objects.empty(); }
+
   void add_object(TimelineObjectHandle object);
+  void remove_object(TimelineObjectHandle object);
 
   Objects get_objects(float start, float end) const;
   TimelineObjectHandle get_object(float pos) const;

Modified: trunk/windstille/src/editor/timeline_object_layer.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_object_layer.hpp	2009-09-28 17:31:29 UTC (rev 3271)
+++ trunk/windstille/src/editor/timeline_object_layer.hpp	2009-09-28 23:59:54 UTC (rev 3272)
@@ -19,18 +19,23 @@
 #ifndef HEADER_WINDSTILLE_TIMELINE_OBJECT_LAYER_HPP
 #define HEADER_WINDSTILLE_TIMELINE_OBJECT_LAYER_HPP
 
+#include <boost/shared_ptr.hpp>
+
 #include "editor/timeline_layer.hpp"
+#include "editor/timeline_keyframe_object.hpp"
 #include "editor/object_model.hpp"
 
 class TimelineObjectLayer : public TimelineLayer
 {
-private:
+protected:
   ObjectModelHandle m_object;
   TimelineProperty  m_property;
 
 public:
   TimelineObjectLayer(ObjectModelHandle object, TimelineProperty property);
 
+  virtual TimelineObjectHandle create_keyframe(float pos) =0;
+
 private:
   TimelineObjectLayer(const TimelineObjectLayer&);
   TimelineObjectLayer& operator=(const TimelineObjectLayer&);
@@ -44,12 +49,26 @@
     : TimelineObjectLayer(object, property)
   {}
 
+  C get_value(float pos)
+  {
+    return C();
+  }
+
   void apply(float pos)
   {
-    //object->set_property(property, value);
+    m_object->set_property(m_property, get_value(pos));
   }
+
+  TimelineObjectHandle create_keyframe(float pos)
+  {
+    C data;
+    m_object->get_property(m_property, data);
+    return TimelineObjectHandle(new TimelineKeyframeDataObject<C>(pos, data));
+  }
 };
 
+typedef boost::shared_ptr<TimelineObjectLayer> TimelineObjectLayerHandle;
+
 #endif
 
 /* EOF */

Modified: trunk/windstille/src/editor/timeline_widget.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_widget.cpp	2009-09-28 17:31:29 UTC (rev 3271)
+++ trunk/windstille/src/editor/timeline_widget.cpp	2009-09-28 23:59:54 UTC (rev 3272)
@@ -290,7 +290,7 @@
     bool in_selection = m_selection.find(*i) != m_selection.end();
 
     if (boost::shared_ptr<TimelineKeyframeObject> keyframe =
-        boost::dynamic_pointer_cast<TimelineKeyframeObject>(*i)) //FIXME:
+        boost::dynamic_pointer_cast<TimelineKeyframeObject>(*i))
     {
       cr->save();
         

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-28 17:31:29 UTC (rev 3271)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-28 23:59:54 UTC (rev 3272)
@@ -407,6 +407,16 @@
       EditorWindow::current()->on_select_all();
       break;
 
+    case GDK_i:
+    {
+      SelectionHandle selection = m_document->get_selection();
+      for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
+      {
+        m_document->timeline_add_keyframe(*i, kPosition, 0.5f);
+      }
+      break;
+    }
+
     case GDK_d:
       m_document->selection_duplicate();
       break;



From grumbel at mail.berlios.de  Tue Sep 29 02:42:59 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 29 Sep 2009 02:42:59 +0200
Subject: [Windstille-commit] r3273 - trunk/windstille/src/editor
Message-ID: <200909290042.n8T0gxRe017579@sheep.berlios.de>

Author: grumbel
Date: 2009-09-29 02:42:57 +0200 (Tue, 29 Sep 2009)
New Revision: 3273

Modified:
   trunk/windstille/src/editor/timeline.cpp
   trunk/windstille/src/editor/timeline.hpp
   trunk/windstille/src/editor/timeline_commands.hpp
   trunk/windstille/src/editor/timeline_object_layer.hpp
Log:
Reuse existing layer if it already exists

Modified: trunk/windstille/src/editor/timeline.cpp
===================================================================
--- trunk/windstille/src/editor/timeline.cpp	2009-09-28 23:59:54 UTC (rev 3272)
+++ trunk/windstille/src/editor/timeline.cpp	2009-09-29 00:42:57 UTC (rev 3273)
@@ -73,4 +73,21 @@
   m_layers.erase(std::remove(m_layers.begin(), m_layers.end(), layer), m_layers.end());
 }
 
+TimelineObjectLayerHandle
+Timeline::get_object_layer(ObjectModelHandle object, TimelineProperty property)
+{
+  for(iterator i = begin(); i != end(); ++i)
+  {
+    TimelineObjectLayerHandle layer = boost::dynamic_pointer_cast<TimelineObjectLayer>(*i);
+
+    if (layer && 
+        layer->get_property() == property &&
+        layer->get_object()   == object)
+    {
+      return layer;
+    }
+  }
+  return TimelineObjectLayerHandle();
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/timeline.hpp
===================================================================
--- trunk/windstille/src/editor/timeline.hpp	2009-09-28 23:59:54 UTC (rev 3272)
+++ trunk/windstille/src/editor/timeline.hpp	2009-09-29 00:42:57 UTC (rev 3273)
@@ -52,6 +52,7 @@
 
   TimelineLayerHandle add_layer(const std::string& name);
   TimelineObjectLayerHandle create_object_layer(ObjectModelHandle object, TimelineProperty property);
+  TimelineObjectLayerHandle get_object_layer(ObjectModelHandle object, TimelineProperty property);
 
   void add_layer(TimelineLayerHandle layer);
   void remove_layer(TimelineLayerHandle layer);

Modified: trunk/windstille/src/editor/timeline_commands.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_commands.hpp	2009-09-28 23:59:54 UTC (rev 3272)
+++ trunk/windstille/src/editor/timeline_commands.hpp	2009-09-29 00:42:57 UTC (rev 3273)
@@ -34,27 +34,38 @@
   ObjectModelHandle    m_object;
   TimelineProperty     m_property;
   TimelineObjectHandle m_keyframe;
+  bool m_add_layer;
 
 public:
   TimelineAddKeyframeCommand(SectorModel& sector, ObjectModelHandle object, TimelineProperty property, float pos) :
     m_sector(sector),
     m_layer(),
     m_object(object),
-    m_property(property)
+    m_property(property),
+    m_add_layer(false)
   {
-    m_layer    = m_sector.get_timeline()->create_object_layer(m_object, m_property);
+    m_layer = m_sector.get_timeline()->get_object_layer(m_object, m_property);
+    if (!m_layer)
+    {
+      m_layer = m_sector.get_timeline()->create_object_layer(m_object, m_property);
+      m_add_layer = true;
+    }
+
     m_keyframe = m_layer->create_keyframe(pos);
   }
   
   void redo() 
   {
-    m_sector.get_timeline()->add_layer(m_layer);
+    if (m_add_layer)
+      m_sector.get_timeline()->add_layer(m_layer);
+
     m_layer->add_object(m_keyframe);
   }
 
   void undo() 
-  {
-    m_layer->remove_object(m_keyframe);
+  {    
+    if (m_add_layer)
+      m_layer->remove_object(m_keyframe);
 
     if (m_layer->empty())
     {

Modified: trunk/windstille/src/editor/timeline_object_layer.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_object_layer.hpp	2009-09-28 23:59:54 UTC (rev 3272)
+++ trunk/windstille/src/editor/timeline_object_layer.hpp	2009-09-29 00:42:57 UTC (rev 3273)
@@ -36,6 +36,9 @@
 
   virtual TimelineObjectHandle create_keyframe(float pos) =0;
 
+  TimelineProperty  get_property() const { return m_property; }
+  ObjectModelHandle get_object()   const { return m_object; }
+
 private:
   TimelineObjectLayer(const TimelineObjectLayer&);
   TimelineObjectLayer& operator=(const TimelineObjectLayer&);



From grumbel at mail.berlios.de  Tue Sep 29 18:41:18 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 29 Sep 2009 18:41:18 +0200
Subject: [Windstille-commit] r3274 - trunk/windstille/src/editor
Message-ID: <200909291641.n8TGfIrT015728@sheep.berlios.de>

Author: grumbel
Date: 2009-09-29 18:41:16 +0200 (Tue, 29 Sep 2009)
New Revision: 3274

Added:
   trunk/windstille/src/editor/timeline_handles.hpp
Modified:
   trunk/windstille/src/editor/animation_widget.cpp
   trunk/windstille/src/editor/animation_widget.hpp
   trunk/windstille/src/editor/decal_object_model.cpp
   trunk/windstille/src/editor/document.cpp
   trunk/windstille/src/editor/document.hpp
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/editor_window.hpp
   trunk/windstille/src/editor/object_model.cpp
   trunk/windstille/src/editor/object_model.hpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/sector_model.hpp
   trunk/windstille/src/editor/timeline.cpp
   trunk/windstille/src/editor/timeline.hpp
   trunk/windstille/src/editor/timeline_commands.hpp
   trunk/windstille/src/editor/timeline_layer.cpp
   trunk/windstille/src/editor/timeline_layer.hpp
   trunk/windstille/src/editor/timeline_layer_widget.cpp
   trunk/windstille/src/editor/timeline_object.hpp
   trunk/windstille/src/editor/timeline_object_layer.hpp
   trunk/windstille/src/editor/timeline_widget.cpp
   trunk/windstille/src/editor/timeline_widget.hpp
   trunk/windstille/src/editor/windstille_widget.cpp
Log:
Very basic positional animation is now working (use 'i' to insert keyframe)

Modified: trunk/windstille/src/editor/animation_widget.cpp
===================================================================
--- trunk/windstille/src/editor/animation_widget.cpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/animation_widget.cpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -18,15 +18,20 @@
 
 #include "editor/animation_widget.hpp"
 
+#include <gtkmm/toolbar.h>
+#include <gtkmm/stock.h>
+#include <gtkmm/label.h>
+#include <gtkmm/uimanager.h>
 #include <boost/shared_ptr.hpp>
 
+#include "editor/editor_window.hpp"
 #include "editor/timeline_widget.hpp"
 #include "editor/timeline_object.hpp"
 #include "editor/timeline_anim_object.hpp"
 #include "editor/timeline_sound_object.hpp"
 #include "editor/timeline_keyframe_object.hpp"
 
-AnimationWidget::AnimationWidget() :
+AnimationWidget::AnimationWidget(EditorWindow& editor) :
   hadjustment(50, 0, 100),
   vadjustment(50, 0, 100),
   hruler(),
@@ -39,6 +44,43 @@
   m_timeline_layer_widget(),
   m_timeline()
 {
+  Glib::RefPtr<Gtk::UIManager>   ui_manager   = editor.get_ui_manager();
+  Glib::RefPtr<Gtk::ActionGroup> action_group = Gtk::ActionGroup::create();
+
+  action_group->add(Gtk::Action::create("MenuAnimation",   "_Animation"));
+  action_group->add(Gtk::Action::create("NewAnimation", Gtk::Stock::NEW),
+                    sigc::mem_fun(editor, &EditorWindow::on_animation_new));
+  action_group->add(Gtk::Action::create("ExportAnimation", Gtk::Stock::SAVE_AS),
+                    sigc::mem_fun(editor, &EditorWindow::on_animation_export));
+  action_group->add(Gtk::Action::create("DeleteAnimation", Gtk::Stock::DELETE),
+                    sigc::mem_fun(editor, &EditorWindow::on_animation_delete));
+
+  action_group->add(Gtk::Action::create("NewLayerAnimation", Gtk::Stock::NEW),
+                    sigc::mem_fun(editor, &EditorWindow::on_animation_layer_new));
+
+  action_group->add(Gtk::Action::create("FrameForwardAnimation", Gtk::Stock::GO_FORWARD),
+                    sigc::mem_fun(editor, &EditorWindow::on_animation_frame_forward));
+  action_group->add(Gtk::Action::create("FrameBackwardAnimation", Gtk::Stock::GO_BACK),
+                    sigc::mem_fun(editor, &EditorWindow::on_animation_frame_backward));
+
+  ui_manager->insert_action_group(action_group);
+
+  ui_manager->add_ui_from_string("<ui>"
+                                 "  <toolbar  name='AnimationToolBar'>"
+                                 "    <toolitem action='NewAnimation'/>"
+                                 "    <toolitem action='ExportAnimation'/>"
+                                 "    <toolitem action='DeleteAnimation'/>"
+                                 "    <separator />"
+                                 "    <toolitem action='NewLayerAnimation'/>"
+                                 "    <separator />"
+                                 "    <toolitem action='FrameBackwardAnimation'/>"
+                                 "    <toolitem action='FrameForwardAnimation'/>"
+                                 "    <separator />"
+                                 "  </toolbar>"
+                                 "</ui>");
+  
+  Gtk::Toolbar& toolbar = dynamic_cast<Gtk::Toolbar&>(*ui_manager->get_widget("/AnimationToolBar"));
+  
   hruler.set_range(0, 100, 50, 100);
 
   table.attach(hruler, 1, 2, 0, 1, Gtk::FILL, Gtk::FILL);
@@ -53,7 +95,13 @@
   table.attach(hscroll, 1, 2, 2, 3, Gtk::FILL, Gtk::FILL);
   table.attach(vscroll, 2, 3, 1, 2, Gtk::FILL, Gtk::FILL);
 
-  add(table);
+  m_hbox.pack_start(toolbar, Gtk::PACK_EXPAND_WIDGET);
+
+  //toolbar.set_icon_size(Gtk::ICON_SIZE_MENU);
+  pack_start(m_hbox, Gtk::PACK_SHRINK);
+  pack_start(table, Gtk::PACK_EXPAND_WIDGET);
+
+  show_all();
 }
 
 void
@@ -107,7 +155,7 @@
   win.set_title("Timeline Test");
   win.set_default_size(800, 400);
 
-  AnimationWidget animation_widget;
+  AnimationWidget animation_widget();
   animation_widget.set_timeline(timeline);
   win.add(animation_widget);
   win.show_all();

Modified: trunk/windstille/src/editor/animation_widget.hpp
===================================================================
--- trunk/windstille/src/editor/animation_widget.hpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/animation_widget.hpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -31,16 +31,19 @@
 #include <gtkmm/window.h>
 #include <gtkmm/scrolledwindow.h>
 
-#include "editor/timeline.hpp"
+#include "editor/timeline_handles.hpp"
 #include "editor/timeline_widget.hpp"
 #include "editor/timeline_layer_widget.hpp"
 
+class EditorWindow;
+
 class AnimationWidget : public Gtk::VBox
 {
 private:
   Gtk::Adjustment hadjustment;
   Gtk::Adjustment vadjustment;
 
+  Gtk::HBox       m_hbox;
   Gtk::HRuler     hruler;
   Gtk::ScrolledWindow scrolled;
   Gtk::TreeView   treeview;
@@ -53,9 +56,10 @@
   TimelineHandle m_timeline;
 
 public:
-  AnimationWidget();
+  AnimationWidget(EditorWindow& editor);
 
   void set_timeline(TimelineHandle timeline);
+  TimelineWidget& get_timeline_widget() { return m_timeline_widget; }
 
 private:
   AnimationWidget(const AnimationWidget&);

Modified: trunk/windstille/src/editor/decal_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.cpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/decal_object_model.cpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -306,6 +306,8 @@
 void
 DecalObjectModel::sync()
 {
+  ObjectModel::sync();
+
   if (m_drawable)
   {
     Vector2f center_offset(-surface.get_width() /2,

Modified: trunk/windstille/src/editor/document.cpp
===================================================================
--- trunk/windstille/src/editor/document.cpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/document.cpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -245,11 +245,16 @@
 void
 Document::timeline_add_keyframe(ObjectModelHandle object, TimelineProperty property, float pos)
 {
-  std::cout << object << " " << property << " " << pos << std::endl;
   execute(CommandHandle(new TimelineAddKeyframeCommand(*m_sector_model, object, property, pos)));
 }
 
 void
+Document::timeline_add_layer(const std::string& name)
+{
+  execute(CommandHandle(new TimelineAddLayerCommand(*m_sector_model, name)));
+}
+
+void
 Document::selection_raise()
 {
   for(Selection::iterator i = m_selection->begin(); i != m_selection->end(); ++i)

Modified: trunk/windstille/src/editor/document.hpp
===================================================================
--- trunk/windstille/src/editor/document.hpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/document.hpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -102,6 +102,7 @@
   /* Timeline Commands
    * @{*/
   void timeline_add_keyframe(ObjectModelHandle object, TimelineProperty property, float pos);
+  void timeline_add_layer(const std::string& name);
   /** @} */
 
   /* Selection Commands

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -45,13 +45,14 @@
 #include "editor/layer_widget.hpp"
 #include "editor/document.hpp"
 
+#include "editor/animation_widget.hpp"
 #include "editor/timeline.hpp"
-#include "editor/animation_widget.hpp"
-#include "editor/timeline_widget.hpp"
+#include "editor/timeline_anim_object.hpp"
+#include "editor/timeline_keyframe_object.hpp"
+#include "editor/timeline_layer.hpp"
 #include "editor/timeline_object.hpp"
-#include "editor/timeline_anim_object.hpp"
 #include "editor/timeline_sound_object.hpp"
-#include "editor/timeline_keyframe_object.hpp"
+#include "editor/timeline_widget.hpp"
 
 EditorWindow::EditorWindow(const Glib::RefPtr<const Gdk::GL::Config>& glconfig_)
   : vbox(),
@@ -460,7 +461,7 @@
   // FIXME: We abuse the minimap as our root GLContext
   Gtk::VPaned* paned = Gtk::manage(new Gtk::VPaned);
   WindstilleWidget* wst = Gtk::manage(new WindstilleWidget(*this, glconfig, minimap_widget.get_gl_context()));
-  AnimationWidget* animation_widget = Gtk::manage(new AnimationWidget());
+  AnimationWidget* animation_widget = Gtk::manage(new AnimationWidget(*this));
 
   paned->pack1(*wst, Gtk::FILL|Gtk::EXPAND);
   paned->pack2(*animation_widget, Gtk::FILL|Gtk::EXPAND);
@@ -470,24 +471,11 @@
     boost::shared_ptr<Timeline> timeline = wst->get_document().get_sector_model().get_timeline();   
 
     TimelineLayerHandle layer1 = timeline->add_layer("Layer1");
-    TimelineLayerHandle layer2 = timeline->add_layer("Layer2");
-    TimelineLayerHandle layer3 = timeline->add_layer("Layer3");
-    TimelineLayerHandle layer4 = timeline->add_layer("Layer4");
 
-    layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(20.0f, 30.0f, "anim1.anim")));
-    layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(60.0f, 30.0f, "anim2.anim")));
+    layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(10.0f, 15.0f, "anim1.anim")));
+    layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(60.0f, 12.0f, "anim2.anim")));
+    layer1->add_object(TimelineObjectHandle(new TimelineSoundObject(30.0f, 15.0f, "sound.wav")));
 
-    layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(8.0f)));
-    layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(10.0f)));
-    layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(11.0f)));
-    layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(15.0f)));
-    layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(20.0f)));
-    layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(35.0f)));
-    layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(40.0f)));
-
-    layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(10.0f, 10.0f, "sound1.wav")));
-    layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(30.0f, 40.0f, "sound.wav")));
-
     animation_widget->set_timeline(timeline);
   }
 
@@ -766,6 +754,60 @@
 }
 
 void
+EditorWindow::on_animation_new()
+{
+}
+
+void
+EditorWindow::on_animation_export()
+{
+}
+void
+EditorWindow::on_animation_delete()
+{
+}
+
+void
+EditorWindow::on_animation_frame_forward()
+{
+}
+
+void 
+EditorWindow::on_animation_frame_backward()
+{
+}
+
+void
+EditorWindow::on_animation_layer_new()
+{
+  if (Document* document = get_document())
+  {
+    document->timeline_add_layer("AnimLayer");
+    queue_draw();
+  }
+}
+
+void
+EditorWindow::on_animation_add_keyframe()
+{
+  std::cout << "EditorWindow::on_animation_add_keyframe()" << std::endl;
+  if (Document* document = get_document())
+  {
+    std::cout << "Document" << std::endl;
+    if (TimelineWidget* timeline_widget = get_timeline_widget())
+    {
+      std::cout << "EditorWindow::on_animation_add_keyframe(): doing" << std::endl;
+      SelectionHandle selection = document->get_selection();
+      for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
+      {
+        document->timeline_add_keyframe(*i, kPosition, timeline_widget->get_cursor_pos());
+      }
+      queue_draw();
+    }
+  }
+}
+
+void
 EditorWindow::toggle_render_layer(Glib::RefPtr<Gtk::ToggleAction> action, unsigned int mask)
 {
   if (WindstilleWidget* wst = get_windstille_widget())
@@ -828,6 +870,47 @@
   return scroll_tool.get();
 }
 
+TimelineWidget*
+EditorWindow::get_timeline_widget()
+{
+  int page = notebook.get_current_page();
+  if (page == -1)
+  {
+    return 0;
+  }
+  else
+  {
+    if (Gtk::VPaned* paned = dynamic_cast<Gtk::VPaned*>(notebook.get_nth_page(page)))
+    {
+      if (AnimationWidget* animation_widget = dynamic_cast<AnimationWidget*>(paned->get_child2()))
+      {
+        return &animation_widget->get_timeline_widget();
+      }
+      else
+      {
+        return 0;
+      }
+    }
+    else
+    {
+      return 0;
+    }
+  }
+}
+
+Document*
+EditorWindow::get_document()
+{
+  if (WindstilleWidget* wst = get_windstille_widget())
+  {
+    return &wst->get_document();
+  }
+  else
+  {
+    return 0;
+  }
+}
+
 WindstilleWidget*
 EditorWindow::get_windstille_widget()
 {

Modified: trunk/windstille/src/editor/editor_window.hpp
===================================================================
--- trunk/windstille/src/editor/editor_window.hpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/editor_window.hpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -36,13 +36,15 @@
 #include "editor/layer_manager.hpp"
 #include "editor/document.hpp"
 
+class Document;
+class LayerWidget;
+class NavgraphInsertTool;
+class ScrollTool;
+class SelectTool;
+class TimelineWidget;
 class Tool;
 class WindstilleWidget;
-class SelectTool;
 class ZoomTool;
-class ScrollTool;
-class LayerWidget;
-class NavgraphInsertTool;
 
 class EditorWindow : public Gtk::Window,
                      public Currenton<EditorWindow>
@@ -126,14 +128,28 @@
   void on_cut();
   void on_copy();
   void on_paste();
-  
+
   void on_layer_toggle(int layer, bool status);
 
   void on_switch_page(GtkNotebookPage* page, guint page_num);
   void on_tool_select(Glib::RefPtr<Gtk::RadioAction> action, Tool*);
 
   void on_select_all();
+  
+  /** Animation Callbacks
+   * @{*/  
+  void on_animation_new();
+  void on_animation_export();
+  void on_animation_delete();
 
+  void on_animation_frame_forward();
+  void on_animation_frame_backward();
+
+  void on_animation_layer_new();
+
+  void on_animation_add_keyframe();
+  /** @} */
+
   void toggle_render_layer(Glib::RefPtr<Gtk::ToggleAction> action, unsigned int mask);
   void toggle_background_layer(Glib::RefPtr<Gtk::ToggleAction> action);
   void toggle_draw_only_active_layer(Glib::RefPtr<Gtk::ToggleAction> action);
@@ -148,6 +164,8 @@
 
   LayerManager& get_layer_manager() { return layer_manager; }
   WindstilleWidget* get_windstille_widget();
+  TimelineWidget*   get_timeline_widget();
+  Document* get_document();
   
   void load_file(const std::string& filename);
 

Modified: trunk/windstille/src/editor/object_model.cpp
===================================================================
--- trunk/windstille/src/editor/object_model.cpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/object_model.cpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -363,6 +363,7 @@
   {
     case kPosition:
       rel_pos = value;
+      sync();
       break;
 
     default:

Modified: trunk/windstille/src/editor/object_model.hpp
===================================================================
--- trunk/windstille/src/editor/object_model.hpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/object_model.hpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -76,6 +76,8 @@
   virtual void set_hflip(bool) { }
   virtual void set_vflip(bool) { }
 
+  virtual void sync() {}
+
   /** Reset scale and rotation to default values */
   virtual void reset();
 

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -33,6 +33,7 @@
 #include "editor/object_model_factory.hpp"
 #include "editor/sector_model.hpp"
 #include "editor/sector_model_builder.hpp"
+#include "editor/timeline.hpp"
 #include "editor/windstille_widget.hpp"
 #include "navigation/node.hpp"
 #include "scenegraph/scene_graph.hpp"

Modified: trunk/windstille/src/editor/sector_model.hpp
===================================================================
--- trunk/windstille/src/editor/sector_model.hpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/sector_model.hpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -29,7 +29,7 @@
 #include "editor/layer.hpp"
 #include "editor/object_model.hpp"
 #include "editor/selection.hpp"
-#include "editor/timeline.hpp"
+#include "editor/timeline_handles.hpp"
 #include "math/vector2f.hpp"
 
 class NavigationGraphModel;

Modified: trunk/windstille/src/editor/timeline.cpp
===================================================================
--- trunk/windstille/src/editor/timeline.cpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/timeline.cpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -41,6 +41,12 @@
 }
 
 TimelineLayerHandle
+Timeline::create_layer(const std::string& name)
+{
+  return TimelineLayerHandle(new TimelineLayer(name));
+}
+
+TimelineLayerHandle
 Timeline::add_layer(const std::string& name)
 {
   m_layers.push_back(TimelineLayerHandle(new TimelineLayer(name)));
@@ -90,4 +96,13 @@
   return TimelineObjectLayerHandle();
 }
 
+void
+Timeline::apply(float pos)
+{
+  for(iterator i = begin(); i != end(); ++i)
+  {
+    (*i)->apply(pos);
+  }  
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/timeline.hpp
===================================================================
--- trunk/windstille/src/editor/timeline.hpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/timeline.hpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -19,9 +19,7 @@
 #ifndef HEADER_WINDSTILLE_EDITOR_TIMELINE_HPP
 #define HEADER_WINDSTILLE_EDITOR_TIMELINE_HPP
 
-#include "editor/timeline_object.hpp"
-#include "editor/timeline_layer.hpp"
-#include "editor/timeline_object_layer.hpp"
+#include "editor/timeline_handles.hpp"
 #include "editor/timeline_properties.hpp"
 #include "editor/object_model.hpp"
 
@@ -51,19 +49,20 @@
   TimelineLayerHandle get_layer(int n) const;
 
   TimelineLayerHandle add_layer(const std::string& name);
+  TimelineLayerHandle create_layer(const std::string& name);
   TimelineObjectLayerHandle create_object_layer(ObjectModelHandle object, TimelineProperty property);
   TimelineObjectLayerHandle get_object_layer(ObjectModelHandle object, TimelineProperty property);
 
   void add_layer(TimelineLayerHandle layer);
   void remove_layer(TimelineLayerHandle layer);
 
+  void apply(float pos);
+
 private:
   Timeline(const Timeline&);
   Timeline& operator=(const Timeline&);
 };
 
-typedef boost::shared_ptr<Timeline> TimelineHandle;
-
 #endif
 
 /* EOF */

Modified: trunk/windstille/src/editor/timeline_commands.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_commands.hpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/timeline_commands.hpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -24,8 +24,10 @@
 #include "editor/layer.hpp"
 #include "editor/object_model.hpp"
 #include "editor/command.hpp"
+#include "editor/timeline.hpp"
+#include "editor/timeline_object_layer.hpp"
 #include "editor/timeline_properties.hpp"
-
+
 class TimelineAddKeyframeCommand : public Command
 {
 private:
@@ -73,7 +75,31 @@
     }
   }
 };
+
+class TimelineAddLayerCommand : public Command
+{
+private:
+  SectorModel&        m_sector;
+  TimelineLayerHandle m_layer;
 
+public:
+  TimelineAddLayerCommand(SectorModel& sector, const std::string& name)
+    : m_sector(sector)
+  {
+    m_layer = m_sector.get_timeline()->create_layer(name);
+  }
+
+  void redo() 
+  {
+    m_sector.get_timeline()->add_layer(m_layer);
+  }
+
+  void undo() 
+  { 
+    m_sector.get_timeline()->remove_layer(m_layer);
+  }
+};
+
 #endif
 
 /* EOF */

Added: trunk/windstille/src/editor/timeline_handles.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_handles.hpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/timeline_handles.hpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -0,0 +1,36 @@
+/*
+**  Windstille - A Sci-Fi Action-Adventure Game
+**  Copyright (C) 2009 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software: you can redistribute it and/or modify
+**  it under the terms of the GNU General Public License as published by
+**  the Free Software Foundation, either version 3 of the License, or
+**  (at your option) any later version.
+**  
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+**  
+**  You should have received a copy of the GNU General Public License
+**  along with this program.  If not, see <http://www.gnu.org/licenses/>.
+*/
+
+#ifndef HEADER_WINDSTILLE_TIMELINE_HANDLES_HPP
+#define HEADER_WINDSTILLE_TIMELINE_HANDLES_HPP
+
+#include <boost/shared_ptr.hpp>
+
+class Timeline;
+class TimelineLayer;
+class TimelineObject;
+class TimelineObjectLayer;
+
+typedef boost::shared_ptr<Timeline>            TimelineHandle;
+typedef boost::shared_ptr<TimelineLayer>       TimelineLayerHandle;
+typedef boost::shared_ptr<TimelineObject>      TimelineObjectHandle;
+typedef boost::shared_ptr<TimelineObjectLayer> TimelineObjectLayerHandle;
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/editor/timeline_handles.hpp
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/editor/timeline_layer.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer.cpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/timeline_layer.cpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -20,6 +20,8 @@
 
 #include <assert.h>
 
+#include "editor/timeline_object.hpp"
+
 TimelineLayer::TimelineLayer(const std::string& name)
   : m_name(name),
     m_objects()

Modified: trunk/windstille/src/editor/timeline_layer.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer.hpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/timeline_layer.hpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -23,7 +23,7 @@
 #include <string>
 #include <boost/shared_ptr.hpp>
 
-#include "timeline_object.hpp"
+#include "timeline_handles.hpp"
 
 class TimelineLayer
 {
@@ -46,6 +46,8 @@
   const_iterator begin() const { return m_objects.begin(); }
   const_iterator end()   const { return m_objects.end();   }
 
+  int size() const { return static_cast<int>(m_objects.size()); }
+
   bool empty() const { return m_objects.empty(); }
 
   void add_object(TimelineObjectHandle object);
@@ -55,14 +57,13 @@
   TimelineObjectHandle get_object(float pos) const;
 
   std::string get_name() const { return m_name; }
+  virtual void apply(float pos) {}
 
 private:
   TimelineLayer(const TimelineLayer&);
   TimelineLayer& operator=(const TimelineLayer&);
 };
 
-typedef boost::shared_ptr<TimelineLayer> TimelineLayerHandle;
-
 #endif
 
 /* EOF */

Modified: trunk/windstille/src/editor/timeline_layer_widget.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer_widget.cpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/timeline_layer_widget.cpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -18,6 +18,8 @@
 
 #include "timeline_layer_widget.hpp"
 
+#include "timeline_layer.hpp"
+
 TimelineLayerWidget::TimelineLayerWidget() :
   m_timeline()
 {

Modified: trunk/windstille/src/editor/timeline_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_object.hpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/timeline_object.hpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -37,8 +37,6 @@
   TimelineObject& operator=(const TimelineObject&);
 };
 
-typedef boost::shared_ptr<TimelineObject> TimelineObjectHandle;
-
 #endif
 
 /* EOF */

Modified: trunk/windstille/src/editor/timeline_object_layer.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_object_layer.hpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/timeline_object_layer.hpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -20,6 +20,7 @@
 #define HEADER_WINDSTILLE_TIMELINE_OBJECT_LAYER_HPP
 
 #include <boost/shared_ptr.hpp>
+#include <iostream>
 
 #include "editor/timeline_layer.hpp"
 #include "editor/timeline_keyframe_object.hpp"
@@ -43,7 +44,7 @@
   TimelineObjectLayer(const TimelineObjectLayer&);
   TimelineObjectLayer& operator=(const TimelineObjectLayer&);
 };
-
+
 template<typename C>
 class TimelineObjectDataLayer : public TimelineObjectLayer
 {
@@ -54,11 +55,110 @@
 
   C get_value(float pos)
   {
-    return C();
+    if (empty())
+    {
+      return C();
+    }
+    else if (size() == 1)
+    {
+      boost::shared_ptr<TimelineKeyframeDataObject<C> > keyframe = 
+        boost::dynamic_pointer_cast<TimelineKeyframeDataObject<C> >(*begin());
+      return keyframe->get_data();
+    }
+    else
+    {
+      boost::shared_ptr<TimelineKeyframeDataObject<C> > lhs; 
+      boost::shared_ptr<TimelineKeyframeDataObject<C> > rhs;
+
+      for(iterator i = begin(); i != end(); ++i)
+      {
+        //std::cout << size() << " - " << (i - begin()) << std::endl;
+
+        boost::shared_ptr<TimelineKeyframeDataObject<C> > keyframe = 
+          boost::dynamic_pointer_cast<TimelineKeyframeDataObject<C> >(*i);
+        
+        assert(keyframe);
+
+        //std::cout << "keyframe: " << keyframe.get() << std::endl;
+
+        if (!lhs && keyframe->get_pos() <= pos)
+        {
+          //std::cout << "crash1" << std::endl;
+          lhs = keyframe;
+        }
+        else if (lhs)
+        {
+          //std::cout << "lhs: " << lhs->get_pos() << " " << keyframe->get_pos() << std::endl;
+          
+          if (keyframe->get_pos() >= lhs->get_pos() &&
+              keyframe->get_pos() <= pos)
+          {
+            lhs = keyframe;
+          }
+        }
+
+        //std::cout << "snip: " << lhs.get() << " " << rhs.get() << " " << keyframe.get() << std::endl;
+        
+        if (!rhs && keyframe->get_pos() >= pos)
+        {
+          //std::cout << "crash2" << std::endl;
+          rhs = keyframe;
+        }
+        else if (rhs)
+        {
+          //std::cout << "rhs: " << rhs->get_pos() << " " << keyframe->get_pos() << std::endl;
+
+          if (keyframe->get_pos() <= rhs->get_pos() &&
+              keyframe->get_pos() >= pos)
+          {
+            rhs = keyframe;
+          }
+        }
+
+        //std::cout << "Loop exit: " << lhs.get() << " " << rhs.get() << std::endl;
+      }
+
+      //std::cout << "PTR: " << lhs.get() << " " << rhs.get() << std::endl;
+
+      if (rhs && lhs)
+      {
+        if (lhs == rhs)
+        {
+          return lhs->get_data();
+        }
+        else
+        {
+          //std::cout << "POS: " << pos << " " << lhs->get_pos() << " " << rhs->get_pos() << std::endl;
+          //std::cout << size() << " " << lhs->get_data() << " " << rhs->get_data() << std::endl;
+
+          float rel_pos = pos - lhs->get_pos();
+          float range   = rhs->get_pos() - lhs->get_pos();
+          float alpha   = rel_pos / range;
+
+          //std::cout << range << " " << rel_pos << " " << alpha <<   std::endl;
+
+          return ((1.0f - alpha) * lhs->get_data()) + (alpha * rhs->get_data());
+        }
+      }
+      else if (rhs)
+      {
+        return rhs->get_data();
+      }
+      else if (lhs)
+      {
+        return lhs->get_data();
+      }
+      else
+      {
+        std::cout << "Error: TimelineObjectDataLayer" << std::endl;
+        return C();
+      }
+    }
   }
 
   void apply(float pos)
   {
+    //std::cout << "apply: " << pos << " " << get_value(pos) << std::endl;
     m_object->set_property(m_property, get_value(pos));
   }
 

Modified: trunk/windstille/src/editor/timeline_widget.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_widget.cpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/timeline_widget.cpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -22,7 +22,9 @@
 #include <sstream>
 
 #include "math/rect.hpp"
+#include "editor/editor_window.hpp"
 #include "editor/timeline.hpp"
+#include "editor/timeline_layer.hpp"
 #include "editor/timeline_object.hpp"
 #include "editor/timeline_anim_object.hpp"
 #include "editor/timeline_sound_object.hpp"
@@ -33,7 +35,8 @@
   m_selection(),
   m_mode(kNoMode),
   down_pos(),
-  move_pos()
+  move_pos(),
+  m_cursor_pos(0.0f)
 {
   signal_button_release_event().connect(sigc::mem_fun(this, &TimelineWidget::mouse_up));
   signal_button_press_event().connect(sigc::mem_fun(this, &TimelineWidget::mouse_down));
@@ -89,6 +92,16 @@
       m_mode = kSelectMode;
     }
   }
+  else if (ev->button == 2)
+  { // scroll
+    
+  }
+  else if (ev->button == 3)
+  { // set cursor
+    set_cursor_pos(floorf(static_cast<float>(ev->x / 8)));
+    m_mode = kCursorSetMode;
+    queue_draw();
+  }
   return false;
 }
 
@@ -118,9 +131,13 @@
         (*i)->set_pos((*i)->get_pos() + (move_pos.x - down_pos.x)/8);
       }
     }
-
     queue_draw();
   }
+  else if (ev->button == 3)
+  {
+    m_mode = kNoMode;
+  }
+
   return false;
 }
 
@@ -140,6 +157,12 @@
 
     queue_draw();
   }
+  else if (m_mode == kCursorSetMode)
+  {
+    set_cursor_pos(floorf(static_cast<float>(ev->x / 8)));
+    queue_draw();
+  }
+
   return false;
 }
 
@@ -245,8 +268,8 @@
   cr->set_source_rgb(0.75, 0.75, 0.75);
   for(int x = 0; x < allocation.get_width(); x += 8)
   {
-      cr->move_to(x, 0);
-      cr->line_to(x, height);
+    cr->move_to(x, 0);
+    cr->line_to(x, height);
   }
   cr->stroke();
 
@@ -274,6 +297,14 @@
   }
   cr->restore();
 
+  cr->rectangle(m_cursor_pos * 8, 0,
+                8, m_timeline->size() * 32);
+  cr->set_source_rgba(1,1,0,0.5);
+  cr->fill_preserve();
+  cr->set_line_width(1.0f);
+  cr->set_source_rgb(0,0,0);
+  cr->stroke();
+
   cr->restore();
 }
 
@@ -428,9 +459,29 @@
 }
 
 void
+TimelineWidget::delete_selection()
+{
+  
+}
+
+void
 TimelineWidget::set_timeline(boost::shared_ptr<Timeline> timeline)
 {
   m_timeline = timeline;
 }
 
+void
+TimelineWidget::set_cursor_pos(float p) 
+{
+  m_cursor_pos = p; 
+  m_timeline->apply(p);
+  EditorWindow::current()->queue_draw();
+}
+
+float
+TimelineWidget::get_cursor_pos() const 
+{ 
+  return m_cursor_pos; 
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/timeline_widget.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_widget.hpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/timeline_widget.hpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -23,8 +23,7 @@
 #include <boost/shared_ptr.hpp>
 #include <set>
 
-#include "editor/timeline.hpp"
-#include "editor/timeline_layer.hpp"
+#include "editor/timeline_handles.hpp"
 #include "math/vector2f.hpp"
 
 class Timeline;
@@ -33,13 +32,21 @@
 class TimelineWidget : public Gtk::DrawingArea
 {
 private:
-  boost::shared_ptr<Timeline> m_timeline;
+  boost::shared_ptr<Timeline>    m_timeline;
   std::set<TimelineObjectHandle> m_selection;
 
-  enum { kNoMode, kSelectMode, kDragMode } m_mode;
+  enum {
+    kNoMode, 
+    kSelectMode, 
+    kDragMode,
+    kCursorSetMode
+  } m_mode;
+
   Vector2f down_pos;
   Vector2f move_pos;
 
+  float m_cursor_pos;
+
 public:
   TimelineWidget();
   ~TimelineWidget();
@@ -50,6 +57,11 @@
   bool mouse_up(GdkEventButton* ev);
   bool mouse_move(GdkEventMotion* ev);
 
+  void  set_cursor_pos(float p);
+  float get_cursor_pos() const;
+
+  void delete_selection();
+
 protected:
   //Override default signal handler:
   virtual bool on_expose_event(GdkEventExpose* event);

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-29 00:42:57 UTC (rev 3273)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-29 16:41:16 UTC (rev 3274)
@@ -408,15 +408,9 @@
       break;
 
     case GDK_i:
-    {
-      SelectionHandle selection = m_document->get_selection();
-      for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
-      {
-        m_document->timeline_add_keyframe(*i, kPosition, 0.5f);
-      }
+      EditorWindow::current()->on_animation_add_keyframe();
       break;
-    }
-
+      
     case GDK_d:
       m_document->selection_duplicate();
       break;



From grumbel at mail.berlios.de  Tue Sep 29 18:43:07 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 29 Sep 2009 18:43:07 +0200
Subject: [Windstille-commit] r3275 - trunk/windstille/data/images
Message-ID: <200909291643.n8TGh7Dw017727@sheep.berlios.de>

Author: grumbel
Date: 2009-09-29 18:43:06 +0200 (Tue, 29 Sep 2009)
New Revision: 3275

Added:
   trunk/windstille/data/images/vignetting.png
Log:
Vignetting image

Added: trunk/windstille/data/images/vignetting.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/vignetting.png
___________________________________________________________________
Name: svn:mime-type
   + image/png



From grumbel at mail.berlios.de  Tue Sep 29 18:45:09 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 29 Sep 2009 18:45:09 +0200
Subject: [Windstille-commit] r3276 - trunk/windstille
Message-ID: <200909291645.n8TGj9oc021379@sheep.berlios.de>

Author: grumbel
Date: 2009-09-29 18:45:09 +0200 (Tue, 29 Sep 2009)
New Revision: 3276

Modified:
   trunk/windstille/COPYING
Log:
minor corrections

Modified: trunk/windstille/COPYING
===================================================================
--- trunk/windstille/COPYING	2009-09-29 16:43:06 UTC (rev 3275)
+++ trunk/windstille/COPYING	2009-09-29 16:45:09 UTC (rev 3276)
@@ -6,7 +6,7 @@
 "GPLv3 or (at your option) any later version", as indicated at the top
 of the files. You can find the full license text of the GPLv3 at:
 
- * http://www.gnu.org/copyleft/gpl.html
+ * http://www.gnu.org/licenses/gpl.html
 
 Graphics, story, levels and other data files in Windstille are
 dual-licensed and covered under both the "GPLv3 or (at your option) any
@@ -44,7 +44,7 @@
 
  * While not required under the "Creative Commons Attribution-
    ShareAlike 3.0", you should include "source code" (.blend, .xcf,
-   ...)  for the graphics and other datafiles whenever possible.
+   ...) for the graphics and other datafiles whenever possible.
 
  * The source files (.xcf, .blend) for data are located in the media/
    subdirectory of the SVN repository, however not every data file has



From grumbel at mail.berlios.de  Tue Sep 29 18:49:23 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 29 Sep 2009 18:49:23 +0200
Subject: [Windstille-commit] r3277 -
	trunk/windstille/data/sectors/trainstation
Message-ID: <200909291649.n8TGnNVe024317@sheep.berlios.de>

Author: grumbel
Date: 2009-09-29 18:49:10 +0200 (Tue, 29 Sep 2009)
New Revision: 3277

Modified:
   trunk/windstille/data/sectors/trainstation/bar.wst
   trunk/windstille/data/sectors/trainstation/bathroom.wst
   trunk/windstille/data/sectors/trainstation/blendtiles.wst
   trunk/windstille/data/sectors/trainstation/boxstack_test.wst
   trunk/windstille/data/sectors/trainstation/cave.wst
   trunk/windstille/data/sectors/trainstation/city.wst
   trunk/windstille/data/sectors/trainstation/container.wst
   trunk/windstille/data/sectors/trainstation/elevator.wst
   trunk/windstille/data/sectors/trainstation/greenstuff.wst
   trunk/windstille/data/sectors/trainstation/house1.wst
   trunk/windstille/data/sectors/trainstation/mine.wst
   trunk/windstille/data/sectors/trainstation/office.wst
   trunk/windstille/data/sectors/trainstation/stairtest.wst
   trunk/windstille/data/sectors/trainstation/steelplatetest.wst
   trunk/windstille/data/sectors/trainstation/toilet.wst
   trunk/windstille/data/sectors/trainstation/train.wst
   trunk/windstille/data/sectors/trainstation/trainstation.wst
Log:
Misc updates to the test sectors

Modified: trunk/windstille/data/sectors/trainstation/bar.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/bar.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/bar.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -8,7 +8,7 @@
   (navigation
     (nodes)
     (edges))
-  (objects
+  (layers
     (layer
       (name "Background")
       (visible #t)

Modified: trunk/windstille/data/sectors/trainstation/bathroom.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/bathroom.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/bathroom.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -36,7 +36,7 @@
         (node1 4)
         (node2 1)
         (properties 0))))
-  (objects
+  (layers
     (layer
       (name "Background")
       (visible #t)

Modified: trunk/windstille/data/sectors/trainstation/blendtiles.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/blendtiles.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/blendtiles.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -8,7 +8,7 @@
   (navigation
     (nodes)
     (edges))
-  (objects
+  (layers
     (layer
       (name "New Layer")
       (visible #f)

Modified: trunk/windstille/data/sectors/trainstation/boxstack_test.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/boxstack_test.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/boxstack_test.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -216,7 +216,7 @@
         (node1 28)
         (node2 26)
         (properties 0))))
-  (objects
+  (layers
     (layer
       (name "Scene")
       (visible #t)

Modified: trunk/windstille/data/sectors/trainstation/cave.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/cave.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/cave.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -8,7 +8,7 @@
   (navigation
     (nodes)
     (edges))
-  (objects
+  (layers
     (layer
       (name "BackgroundBG")
       (visible #t)

Modified: trunk/windstille/data/sectors/trainstation/city.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/city.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/city.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -21,7 +21,7 @@
         (node1 2)
         (node2 3)
         (properties 0))))
-  (objects
+  (layers
     (layer
       (name "Background")
       (visible #t)

Modified: trunk/windstille/data/sectors/trainstation/container.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/container.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/container.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -6,16 +6,184 @@
   (ambient-color 0 0 0 1)
   (init-script "init.nut")
   (navigation
-    (nodes)
-    (edges))
-  (objects
+    (nodes
+      (navgraph-node
+        (id "0x8b618f8")
+        (pos -647 384)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x8c68130")
+        (pos -418.562 385.883)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x8c7f118")
+        (pos -417.312 765.883)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x8c89e90")
+        (pos -647.312 180.883)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x8c9a320")
+        (pos -414.812 180.883)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x8c9a610")
+        (pos -418.562 73.3828)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x8c68240")
+        (pos -302.312 -61.6171)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x8c7f2d0")
+        (pos 1227.69 -60.3672)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x8b61888")
+        (pos 1358.94 75.8828)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x8c9a698")
+        (pos 1355 719)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x8c9a268")
+        (pos 1241 896)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x9a5f740")
+        (pos -293 896)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x9e12818")
+        (pos 128 896)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x98fc680")
+        (pos -378 384)
+        (parent "")
+        (select-mask -1)))
+    (edges
+      (navgraph-edge
+        (id "0x8c899f8")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x8b618f8")
+        (rhs-node "0x8c89e90"))
+      (navgraph-edge
+        (id "0x8c87068")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x8c68130")
+        (rhs-node "0x8b618f8"))
+      (navgraph-edge
+        (id "0x8c6f1e0")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x8c68130")
+        (rhs-node "0x98fc680"))
+      (navgraph-edge
+        (id "0x8c81370")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x8c68130")
+        (rhs-node "0x8c7f118"))
+      (navgraph-edge
+        (id "0x8c8a430")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x9a5f740")
+        (rhs-node "0x8c7f118"))
+      (navgraph-edge
+        (id "0x9e133e8")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x8c9a320")
+        (rhs-node "0x8c89e90"))
+      (navgraph-edge
+        (id "0x8c8b700")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x8c9a610")
+        (rhs-node "0x8c9a320"))
+      (navgraph-edge
+        (id "0x9e13488")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x8c9a610")
+        (rhs-node "0x8c68240"))
+      (navgraph-edge
+        (id "0x8c8a1b8")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x8c68240")
+        (rhs-node "0x8c7f2d0"))
+      (navgraph-edge
+        (id "0x8c7f298")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x8c9a698")
+        (rhs-node "0x8b61888"))
+      (navgraph-edge
+        (id "0x9c54e48")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x8c9a698")
+        (rhs-node "0x8c9a268"))
+      (navgraph-edge
+        (id "0x9c84fb8")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x9e12818")
+        (rhs-node "0x8c9a268"))
+      (navgraph-edge
+        (id "0x9e12a00")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x9e12818")
+        (rhs-node "0x9a5f740"))
+      (navgraph-edge
+        (id "0x8c99cb8")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x9e12818")
+        (rhs-node "0x98fc680"))))
+  (layers
     (layer
       (name "Background")
       (visible #t)
       (locked #t)
       (objects
         (decal
-          (id "0xd67bf78")
+          (id "0x96aeb20")
           (pos -15 424)
           (parent "")
           (select-mask 1)
@@ -26,7 +194,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67c300")
+          (id "0x9794a80")
           (pos 973 427)
           (parent "")
           (select-mask 1)
@@ -37,7 +205,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67ba10")
+          (id "0x9791bb8")
           (pos 549 839)
           (parent "")
           (select-mask 1)
@@ -48,7 +216,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdd394f8")
+          (id "0x9791e88")
           (pos -181 185)
           (parent "")
           (select-mask 1)
@@ -59,7 +227,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67bbe8")
+          (id "0x98fc590")
           (pos 1267 845)
           (parent "")
           (select-mask 1)
@@ -70,7 +238,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdd395b0")
+          (id "0x99c25b0")
           (pos 1209 472)
           (parent "")
           (select-mask 1)
@@ -81,7 +249,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdd396d0")
+          (id "0x99c2448")
           (pos 1192 578)
           (parent "")
           (select-mask 1)
@@ -92,7 +260,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdd377f8")
+          (id "0x99c2668")
           (pos 1206 450)
           (parent "")
           (select-mask 1)
@@ -103,7 +271,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdd375e8")
+          (id "0x99c26e0")
           (pos 1241 553)
           (parent "")
           (select-mask 1)
@@ -114,7 +282,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdd37390")
+          (id "0x96ac158")
           (pos 1206 435)
           (parent "")
           (select-mask 1)
@@ -125,7 +293,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdd39280")
+          (id "0x9a655b8")
           (pos 316 286)
           (parent "")
           (select-mask 1)
@@ -136,7 +304,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdd39320")
+          (id "0x99c1e70")
           (pos 201 525)
           (parent "")
           (select-mask 1)
@@ -147,7 +315,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdd390e8")
+          (id "0x96aba10")
           (pos 203 453)
           (parent "")
           (select-mask 1)
@@ -158,7 +326,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdd39028")
+          (id "0x96ab750")
           (pos 194 437)
           (parent "")
           (select-mask 1)
@@ -169,7 +337,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdd37ef8")
+          (id "0x9a5f470")
           (pos 515 537)
           (parent "")
           (select-mask 1)
@@ -180,7 +348,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdd38018")
+          (id "0x9a5f558")
           (pos 486 454)
           (parent "")
           (select-mask 1)
@@ -191,7 +359,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdd37a68")
+          (id "0x9a5faf0")
           (pos 504 443)
           (parent "")
           (select-mask 1)
@@ -207,7 +375,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0xdd0d390")
+          (id "0x9795e28")
           (pos 338 745)
           (parent "")
           (select-mask 1)
@@ -223,7 +391,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0xd940dd8")
+          (id "0x9792438")
           (pos 429 -18)
           (parent "")
           (select-mask 1)
@@ -234,7 +402,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd940ed0")
+          (id "0x8f98e70")
           (pos -264 91)
           (parent "")
           (select-mask 1)
@@ -245,7 +413,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdd1d578")
+          (id "0x9792500")
           (pos 1200 36)
           (parent "")
           (select-mask 1)
@@ -256,7 +424,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdd1d5f8")
+          (id "0x9792250")
           (pos 481 562)
           (parent "")
           (select-mask 1)
@@ -267,7 +435,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdc24c80")
+          (id "0x97965d8")
           (pos 804 479)
           (parent "")
           (select-mask 1)
@@ -278,7 +446,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdb023a8")
+          (id "0x9792088")
           (pos 821 347)
           (parent "")
           (select-mask 1)
@@ -289,7 +457,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdb02470")
+          (id "0x97963f8")
           (pos 854 439)
           (parent "")
           (select-mask 1)
@@ -300,7 +468,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd692890")
+          (id "0x9796278")
           (pos 713 859)
           (parent "")
           (select-mask 1)
@@ -311,7 +479,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd692ab0")
+          (id "0x9795a88")
           (pos 976 842)
           (parent "")
           (select-mask 1)
@@ -322,7 +490,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67acd8")
+          (id "0x9795b20")
           (pos 818 723)
           (parent "")
           (select-mask 1)
@@ -338,7 +506,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0xd67e990")
+          (id "0x8f96ba8")
           (pos -389 447)
           (parent "")
           (select-mask 1)
@@ -349,7 +517,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67d680")
+          (id "0x8c85870")
           (pos -261 409)
           (parent "")
           (select-mask 1)
@@ -360,7 +528,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdc24e40")
+          (id "0x9661680")
           (pos -261 575)
           (parent "")
           (select-mask 1)
@@ -371,7 +539,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd941028")
+          (id "0x96af158")
           (pos -133 537)
           (parent "")
           (select-mask 1)
@@ -382,7 +550,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdb02738")
+          (id "0x96af4e8")
           (pos -133 703)
           (parent "")
           (select-mask 1)
@@ -393,7 +561,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdb02888")
+          (id "0x8f98c88")
           (pos -5 665)
           (parent "")
           (select-mask 1)
@@ -404,7 +572,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdb029a0")
+          (id "0x96af340")
           (pos -5 831)
           (parent "")
           (select-mask 1)
@@ -415,7 +583,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xdb02308")
+          (id "0x8f98fa8")
           (pos 123 793)
           (parent "")
           (select-mask 1)
@@ -431,7 +599,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0xd67eab0")
+          (id "0x8e9b718")
           (pos 663 -121)
           (parent "")
           (select-mask 1)
@@ -442,7 +610,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd7decf0")
+          (id "0x8ecc4a0")
           (pos 1047 -121)
           (parent "")
           (select-mask 1)
@@ -453,7 +621,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd7e0310")
+          (id "0x8ecc630")
           (pos -105 -121)
           (parent "")
           (select-mask 1)
@@ -464,7 +632,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd77ec50")
+          (id "0x8ecc740")
           (pos 1484 135)
           (parent "")
           (select-mask 1)
@@ -475,7 +643,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd77ed70")
+          (id "0x8ecaf20")
           (pos 1484 263)
           (parent "")
           (select-mask 1)
@@ -486,7 +654,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd810850")
+          (id "0x8ecad90")
           (pos 1484 391)
           (parent "")
           (select-mask 1)
@@ -497,7 +665,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd7e01a8")
+          (id "0x91ffef0")
           (pos 1480 519)
           (parent "")
           (select-mask 1)
@@ -508,7 +676,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd7e00c8")
+          (id "0x9200958")
           (pos 1480 647)
           (parent "")
           (select-mask 1)
@@ -519,7 +687,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd7dfed0")
+          (id "0x9200070")
           (pos 1367 -57)
           (parent "")
           (select-mask 1)
@@ -530,7 +698,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd9009d8")
+          (id "0x9200848")
           (pos -540 127)
           (parent "")
           (select-mask 1)
@@ -541,7 +709,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd900b68")
+          (id "0x91fe6b0")
           (pos 1373 903)
           (parent "")
           (select-mask 1)
@@ -552,7 +720,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd7dfbf0")
+          (id "0x91fea98")
           (pos -540 475)
           (parent "")
           (select-mask 1)
@@ -563,7 +731,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd7dfcd0")
+          (id "0x91fe820")
           (pos -540 591)
           (parent "")
           (select-mask 1)
@@ -574,7 +742,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd9e1248")
+          (id "0x91ff1d8")
           (pos -540 707)
           (parent "")
           (select-mask 1)
@@ -585,7 +753,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd9e1328")
+          (id "0x91fec70")
           (pos -425 -57)
           (parent "")
           (select-mask 1)
@@ -596,7 +764,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd9e1490")
+          (id "0x91feff8")
           (pos -419 905)
           (parent "")
           (select-mask 1)
@@ -607,7 +775,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xda41610")
+          (id "0x91fedf0")
           (pos -104 954)
           (parent "")
           (select-mask 1)
@@ -618,7 +786,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xda416c8")
+          (id "0x91fee90")
           (pos 280 954)
           (parent "")
           (select-mask 1)
@@ -629,7 +797,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xda81a48")
+          (id "0x91ff588")
           (pos 661 954)
           (parent "")
           (select-mask 1)
@@ -640,7 +808,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xda81c00")
+          (id "0x91ff268")
           (pos 1045 954)
           (parent "")
           (select-mask 1)
@@ -651,7 +819,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd8103d8")
+          (id "0x91ffbc8")
           (pos -544 401)
           (parent "")
           (select-mask 1)
@@ -662,7 +830,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd7df748")
+          (id "0x91ff988")
           (pos 279 -97)
           (parent "")
           (select-mask 1)
@@ -674,11 +842,11 @@
           (vflip #f))))
     (layer
       (name "Lights")
-      (visible #f)
+      (visible #t)
       (locked #t)
       (objects
         (decal
-          (id "0xd7469a8")
+          (id "0x8cb20c8")
           (pos 1087 797)
           (parent "")
           (select-mask 1)
@@ -689,7 +857,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd769610")
+          (id "0x8e53480")
           (pos -147 797)
           (parent "")
           (select-mask 1)
@@ -700,7 +868,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd746a60")
+          (id "0x8cb37a8")
           (pos 1082 782)
           (parent "")
           (select-mask 1)
@@ -711,7 +879,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd71cbe0")
+          (id "0x8e62aa0")
           (pos -148 782)
           (parent "")
           (select-mask 1)
@@ -722,7 +890,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd757e20")
+          (id "0x8da5278")
           (pos -109 755)
           (parent "")
           (select-mask 1)
@@ -733,7 +901,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd7aea98")
+          (id "0x8e9bb10")
           (pos 1091 786)
           (parent "")
           (select-mask 1)
@@ -744,7 +912,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd7aebc8")
+          (id "0x8e9af18")
           (pos 617 244)
           (parent "")
           (select-mask 1)
@@ -755,7 +923,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd77eb60")
+          (id "0x8e9b590")
           (pos 1101 779)
           (parent "")
           (select-mask 1)
@@ -766,7 +934,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd7467a8")
+          (id "0x8e9b1b8")
           (pos -128 779)
           (parent "")
           (select-mask 1)
@@ -782,7 +950,7 @@
       (locked #f)
       (objects
         (decal
-          (id "0xbd19eb8")
+          (id "0x8c85998")
           (pos 521 777)
           (parent "")
           (select-mask 1)
@@ -793,7 +961,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67ce68")
+          (id "0x8c84f98")
           (pos 539 200)
           (parent "")
           (select-mask 1)
@@ -804,7 +972,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67cf48")
+          (id "0x8cb95c8")
           (pos 789 826)
           (parent "")
           (select-mask 1)
@@ -815,7 +983,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67cc08")
+          (id "0x8cb3978")
           (pos 917 826)
           (parent "")
           (select-mask 1)
@@ -826,7 +994,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67d948")
+          (id "0x8cb1ba0")
           (pos 789 698)
           (parent "")
           (select-mask 1)
@@ -837,7 +1005,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67dda8")
+          (id "0x8ccda80")
           (pos 917 698)
           (parent "")
           (select-mask 1)
@@ -848,7 +1016,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67dac0")
+          (id "0x8ccdba8")
           (pos 805 601)
           (parent "")
           (select-mask 1)
@@ -859,7 +1027,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67dc50")
+          (id "0x8d4a508")
           (pos 693 858)
           (parent "")
           (select-mask 1)
@@ -870,7 +1038,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67e820")
+          (id "0x8d00010")
           (pos 1113 783)
           (parent "")
           (select-mask 1)
@@ -881,7 +1049,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67e168")
+          (id "0x8d058e8")
           (pos 1053 761)
           (parent "")
           (select-mask 1)
@@ -892,7 +1060,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67e4c0")
+          (id "0x8d00238")
           (pos 1155 761)
           (parent "")
           (select-mask 1)
@@ -903,7 +1071,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd67df50")
+          (id "0x8d05d90")
           (pos 1067 776)
           (parent "")
           (select-mask 1)
@@ -914,7 +1082,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd6e8fb8")
+          (id "0x8da5d88")
           (pos 1147 769)
           (parent "")
           (select-mask 1)
@@ -925,7 +1093,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xd743cb8")
+          (id "0x8da5c00")
           (pos 1042 828)
           (parent "")
           (select-mask 1)
@@ -939,6 +1107,39 @@
       (name "Scene")
       (visible #t)
       (locked #t)
-      (objects))))
+      (objects))
+    (layer
+      (name "NavGraph")
+      (visible #t)
+      (locked #f)
+      (objects
+        (navgraph-edge-ref
+          (edge "0x8c99cb8"))
+        (navgraph-edge-ref
+          (edge "0x9e12a00"))
+        (navgraph-edge-ref
+          (edge "0x9c84fb8"))
+        (navgraph-edge-ref
+          (edge "0x9c54e48"))
+        (navgraph-edge-ref
+          (edge "0x8c7f298"))
+        (navgraph-edge-ref
+          (edge "0x8c8a1b8"))
+        (navgraph-edge-ref
+          (edge "0x9e13488"))
+        (navgraph-edge-ref
+          (edge "0x8c8b700"))
+        (navgraph-edge-ref
+          (edge "0x9e133e8"))
+        (navgraph-edge-ref
+          (edge "0x8c8a430"))
+        (navgraph-edge-ref
+          (edge "0x8c81370"))
+        (navgraph-edge-ref
+          (edge "0x8c6f1e0"))
+        (navgraph-edge-ref
+          (edge "0x8c87068"))
+        (navgraph-edge-ref
+          (edge "0x8c899f8"))))))
 
 ;; EOF ;;

Modified: trunk/windstille/data/sectors/trainstation/elevator.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/elevator.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/elevator.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -8,7 +8,7 @@
   (navigation
     (nodes)
     (edges))
-  (objects
+  (layers
     (layer
       (name "Elevator")
       (visible #t)

Modified: trunk/windstille/data/sectors/trainstation/greenstuff.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/greenstuff.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/greenstuff.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -8,7 +8,7 @@
   (navigation
     (nodes)
     (edges))
-  (objects
+  (layers
     (layer
       (name "Trees")
       (visible #t)

Modified: trunk/windstille/data/sectors/trainstation/house1.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/house1.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/house1.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -8,7 +8,7 @@
   (navigation
     (nodes)
     (edges))
-  (objects
+  (layers
     (layer
       (name "Sky")
       (visible #t)

Modified: trunk/windstille/data/sectors/trainstation/mine.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/mine.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/mine.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -8,7 +8,7 @@
   (navigation
     (nodes)
     (edges))
-  (objects
+  (layers
     (layer
       (name "Wall")
       (visible #t)

Modified: trunk/windstille/data/sectors/trainstation/office.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/office.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/office.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -6,17 +6,34 @@
   (ambient-color 0 0 0 1)
   (init-script "init.nut")
   (navigation
-    (nodes)
-    (edges))
-  (objects
+    (nodes
+      (navgraph-node
+        (id "0x9a80728")
+        (pos -1454 1170)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0x9a7f5c0")
+        (pos 1864 1170)
+        (parent "")
+        (select-mask -1)))
+    (edges
+      (navgraph-edge
+        (id "0x9a831f8")
+        (pos 77 596)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0x9a7f5c0")
+        (rhs-node "0x9a80728"))))
+  (layers
     (layer
       (name "BackgroundWall")
       (visible #t)
       (locked #f)
       (objects
         (decal
-          (id "0x11fc1388")
-          (pos 578 380)
+          (id "0xa2bd9d8")
+          (pos 655 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall2.png")
@@ -26,8 +43,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11fc1410")
-          (pos 962 380)
+          (id "0xa2bdfe8")
+          (pos 1039 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall3.png")
@@ -37,8 +54,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a7ff30")
-          (pos 450 380)
+          (id "0xa2bf300")
+          (pos 527 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall1.png")
@@ -48,8 +65,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a75558")
-          (pos 66 380)
+          (id "0xa2bc288")
+          (pos 143 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall1.png")
@@ -59,8 +76,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a75608")
-          (pos 322 380)
+          (id "0xa2bc310")
+          (pos 399 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall3.png")
@@ -70,8 +87,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a80068")
-          (pos 194 380)
+          (id "0xa2bcab8")
+          (pos 271 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall2.png")
@@ -81,8 +98,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a80400")
-          (pos -190 380)
+          (id "0xa2bc430")
+          (pos -113 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall2.png")
@@ -92,8 +109,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a80230")
-          (pos -62 380)
+          (id "0xa2bc5e0")
+          (pos 15 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall3.png")
@@ -103,8 +120,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a80bb8")
-          (pos -318 380)
+          (id "0xa2bc8e0")
+          (pos -241 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall1.png")
@@ -114,8 +131,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a80a28")
-          (pos -702 380)
+          (id "0xa2bc7a8")
+          (pos -625 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall1.png")
@@ -125,8 +142,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a80f28")
-          (pos -446 380)
+          (id "0xa16aa70")
+          (pos -369 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall3.png")
@@ -136,8 +153,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a80d78")
-          (pos -574 380)
+          (id "0xa16acd0")
+          (pos -497 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall2.png")
@@ -147,8 +164,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a80e68")
-          (pos -958 380)
+          (id "0xa16ae28")
+          (pos -881 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall2.png")
@@ -158,8 +175,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a816e8")
-          (pos -830 380)
+          (id "0xa16b400")
+          (pos -753 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall3.png")
@@ -169,8 +186,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a80538")
-          (pos -1086 380)
+          (id "0xa16b498")
+          (pos -1009 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall1.png")
@@ -180,8 +197,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a81838")
-          (pos -1470 380)
+          (id "0xa16b950")
+          (pos -1393 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall1.png")
@@ -191,8 +208,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a806c8")
-          (pos -1214 380)
+          (id "0xa16b818")
+          (pos -1137 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall3.png")
@@ -202,8 +219,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a81d30")
-          (pos -1342 380)
+          (id "0xa16b5e8")
+          (pos -1265 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall2.png")
@@ -213,8 +230,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a81da0")
-          (pos 834 380)
+          (id "0xa16af80")
+          (pos 911 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall2.png")
@@ -224,8 +241,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x1230b130")
-          (pos 1090 380)
+          (id "0xa16b328")
+          (pos 1167 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall3.png")
@@ -235,8 +252,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x1230b230")
-          (pos 706 380)
+          (id "0xa166780")
+          (pos 783 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall1.png")
@@ -246,8 +263,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a81398")
-          (pos 1474 380)
+          (id "0xa16b128")
+          (pos 1551 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall3.png")
@@ -257,8 +274,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x122bd400")
-          (pos 1346 380)
+          (id "0xa1688c8")
+          (pos 1423 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall2.png")
@@ -268,8 +285,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x123806b8")
-          (pos 1602 380)
+          (id "0xa1689b0")
+          (pos 1679 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall3.png")
@@ -279,8 +296,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x123b0900")
-          (pos 1218 380)
+          (id "0xa168d90")
+          (pos 1295 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall1.png")
@@ -290,8 +307,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x123b0990")
-          (pos 1730 380)
+          (id "0xa168df0")
+          (pos 1807 976)
           (parent "")
           (select-mask 1)
           (path "images/decal/wall3.png")
@@ -306,8 +323,8 @@
       (locked #f)
       (objects
         (decal
-          (id "0x11ccb238")
-          (pos 253.75 47.375)
+          (id "0x9fa3768")
+          (pos 331 643)
           (parent "")
           (select-mask 1)
           (path "images/decal/dark.png")
@@ -317,8 +334,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11ef2878")
-          (pos 238.125 713)
+          (id "0x9fa39c0")
+          (pos 315 1309)
           (parent "")
           (select-mask 1)
           (path "images/decal/dark.png")
@@ -328,8 +345,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11f9e598")
-          (pos 563.125 702.062)
+          (id "0x9b7ff68")
+          (pos 640 1298)
           (parent "")
           (select-mask 1)
           (path "images/decal/dark.png")
@@ -339,8 +356,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11f9e8a0")
-          (pos 255.313 430)
+          (id "0x9b80258")
+          (pos 332 1026)
           (parent "")
           (select-mask 1)
           (path "images/decal/train_door.png")
@@ -350,8 +367,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11f59a30")
-          (pos -175 635)
+          (id "0x9fa8c50")
+          (pos -98 1231)
           (parent "")
           (select-mask 1)
           (path "images/decal/dark.png")
@@ -361,8 +378,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11f598d8")
-          (pos -702.376 610.672)
+          (id "0x9fa8f58")
+          (pos -625 1206)
           (parent "")
           (select-mask 1)
           (path "images/decal/dark.png")
@@ -372,8 +389,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11fee038")
-          (pos -1181.38 644.672)
+          (id "0x9fa8e50")
+          (pos -1104 1240)
           (parent "")
           (select-mask 1)
           (path "images/decal/dark.png")
@@ -388,8 +405,8 @@
       (locked #f)
       (objects
         (decal
-          (id "0x11e4daf0")
-          (pos 546.349 496)
+          (id "0x9b791e8")
+          (pos 623 1092)
           (parent "")
           (select-mask 1)
           (path "images/decal/bench.png")
@@ -399,8 +416,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11e4d8a8")
-          (pos -21.9375 496)
+          (id "0x9b79ce0")
+          (pos 55 1092)
           (parent "")
           (select-mask 1)
           (path "images/decal/bench.png")
@@ -410,8 +427,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11e4d580")
-          (pos -435.526 496)
+          (id "0x9fa9e58")
+          (pos -359 1092)
           (parent "")
           (select-mask 1)
           (path "images/decal/bench.png")
@@ -421,8 +438,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11ec23d8")
-          (pos -965.526 496)
+          (id "0x9b80598")
+          (pos -889 1092)
           (parent "")
           (select-mask 1)
           (path "images/decal/bench.png")
@@ -432,8 +449,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11ccb300")
-          (pos 956.427 496)
+          (id "0x9fa9c50")
+          (pos 1033 1092)
           (parent "")
           (select-mask 1)
           (path "images/decal/bench.png")
@@ -453,8 +470,8 @@
       (locked #f)
       (objects
         (decal
-          (id "0x11d1b748")
-          (pos -185.687 478)
+          (id "0x9b7baa0")
+          (pos -109 1074)
           (parent "")
           (select-mask 1)
           (path "images/decal/lamp1.png")
@@ -464,8 +481,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a631b8")
-          (pos -186.087 454.328)
+          (id "0x9a873d8")
+          (pos -109 1050)
           (parent "")
           (select-mask 1)
           (path "images/decal/lamp1_highlight.png")
@@ -475,8 +492,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a62230")
-          (pos -697.391 478)
+          (id "0x9b88690")
+          (pos -620 1074)
           (parent "")
           (select-mask 1)
           (path "images/decal/lamp1.png")
@@ -486,8 +503,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11d1b648")
-          (pos -697.791 454.328)
+          (id "0x9b85fe8")
+          (pos -621 1050)
           (parent "")
           (select-mask 1)
           (path "images/decal/lamp1_highlight.png")
@@ -497,8 +514,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a61650")
-          (pos -1218 458.328)
+          (id "0x9b85e20")
+          (pos -1141 1054)
           (parent "")
           (select-mask 1)
           (path "images/decal/lamp1_highlight.png")
@@ -508,8 +525,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a61838")
-          (pos -1218.6 478)
+          (id "0x9b85ec0")
+          (pos -1142 1074)
           (parent "")
           (select-mask 1)
           (path "images/decal/lamp1.png")
@@ -519,8 +536,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11d1b868")
-          (pos 143.113 478)
+          (id "0x9f5c240")
+          (pos 220 1074)
           (parent "")
           (select-mask 1)
           (path "images/decal/lamp1.png")
@@ -530,8 +547,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11d9e790")
-          (pos 142.713 454.328)
+          (id "0x9f5c2f0")
+          (pos 220 1050)
           (parent "")
           (select-mask 1)
           (path "images/decal/lamp1_highlight.png")
@@ -541,8 +558,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a63600")
-          (pos 370.625 454.328)
+          (id "0x9b78ee8")
+          (pos 448 1050)
           (parent "")
           (select-mask 1)
           (path "images/decal/lamp1_highlight.png")
@@ -552,8 +569,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11d9ebd0")
-          (pos 371.025 478)
+          (id "0x9b794d0")
+          (pos 448 1074)
           (parent "")
           (select-mask 1)
           (path "images/decal/lamp1.png")
@@ -563,8 +580,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11d9ed50")
-          (pos 721.247 478)
+          (id "0x9b78ff8")
+          (pos 798 1074)
           (parent "")
           (select-mask 1)
           (path "images/decal/lamp1.png")
@@ -574,8 +591,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11d9e808")
-          (pos 720.847 454.328)
+          (id "0x9b79060")
+          (pos 798 1050)
           (parent "")
           (select-mask 1)
           (path "images/decal/lamp1_highlight.png")
@@ -590,8 +607,8 @@
       (locked #f)
       (objects
         (decal
-          (id "0x11a63800")
-          (pos 130 636)
+          (id "0x9a853d0")
+          (pos 207 1232)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -601,8 +618,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a63d20")
-          (pos 386 636)
+          (id "0x9b20730")
+          (pos 463 1232)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -612,8 +629,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a60030")
-          (pos 642 636)
+          (id "0x9b20618")
+          (pos 719 1232)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -623,8 +640,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a822b8")
-          (pos 130 124)
+          (id "0x9b204a0")
+          (pos 207 720)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -634,8 +651,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a82048")
-          (pos 386 124)
+          (id "0x9b7d340")
+          (pos 463 720)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -645,8 +662,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a60250")
-          (pos 642 124)
+          (id "0x9b78838")
+          (pos 719 720)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -656,8 +673,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a60ff0")
-          (pos -638 636)
+          (id "0x9b78900")
+          (pos -561 1232)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -667,8 +684,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a60490")
-          (pos -382 636)
+          (id "0x9b7d8d0")
+          (pos -305 1232)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -678,8 +695,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a605a0")
-          (pos -126 636)
+          (id "0x9b7dbc8")
+          (pos -49 1232)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -689,8 +706,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a61360")
-          (pos -638 124)
+          (id "0x9b7dfb8")
+          (pos -561 720)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -700,8 +717,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a611a8")
-          (pos -382 124)
+          (id "0x9b7de00")
+          (pos -305 720)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -711,8 +728,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a61f78")
-          (pos -126 124)
+          (id "0x9b7d178")
+          (pos -49 720)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -722,8 +739,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a61da0")
-          (pos -1406 636)
+          (id "0x9b7cfa0")
+          (pos -1329 1232)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -733,8 +750,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a60c30")
-          (pos -1150 636)
+          (id "0x9b7d020")
+          (pos -1073 1232)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -744,8 +761,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a61b08")
-          (pos -894 636)
+          (id "0x9b7d500")
+          (pos -817 1232)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -755,8 +772,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11c22408")
-          (pos -1406 124)
+          (id "0x9b7b2a0")
+          (pos -1329 720)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -766,8 +783,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11c22518")
-          (pos -1150 124)
+          (id "0x9b7d628")
+          (pos -1073 720)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -777,8 +794,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11c225d0")
-          (pos -894 124)
+          (id "0x9b7b190")
+          (pos -817 720)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -788,8 +805,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a60860")
-          (pos 898 636)
+          (id "0x9b7abb8")
+          (pos 975 1232)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -799,8 +816,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a608e8")
-          (pos 898 124)
+          (id "0x9b7af20")
+          (pos 975 720)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -810,8 +827,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11c52ab0")
-          (pos 1410 636)
+          (id "0x9b7acb8")
+          (pos 1487 1232)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -821,8 +838,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11c52b60")
-          (pos 1154 636)
+          (id "0x9b7b478")
+          (pos 1231 1232)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -832,8 +849,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11c3a770")
-          (pos 1154 124)
+          (id "0x9b7be20")
+          (pos 1231 720)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -843,8 +860,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11c3a878")
-          (pos 1410 124)
+          (id "0x9b7bf08")
+          (pos 1487 720)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -854,8 +871,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11cb30e0")
-          (pos 1666 124)
+          (id "0x9b7b6b0")
+          (pos 1743 720)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueroof.png")
@@ -865,8 +882,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11cb2ef8")
-          (pos 1666 636)
+          (id "0x9b7b518")
+          (pos 1743 1232)
           (parent "")
           (select-mask 1)
           (path "images/objects/blueground.png")
@@ -881,8 +898,8 @@
       (locked #f)
       (objects
         (decal
-          (id "0x11a62528")
-          (pos -176.66 473.947)
+          (id "0x9a9f208")
+          (pos -100 1069)
           (parent "")
           (select-mask 1)
           (path "images/decal/light.png")
@@ -892,8 +909,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a625a0")
-          (pos 359.466 456.262)
+          (id "0x9a83a90")
+          (pos 436 1052)
           (parent "")
           (select-mask 1)
           (path "images/decal/light.png")
@@ -903,8 +920,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a62cb0")
-          (pos -739.878 477.707)
+          (id "0x9a83c20")
+          (pos -663 1073)
           (parent "")
           (select-mask 1)
           (path "images/decal/light.png")
@@ -914,8 +931,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a62ac8")
-          (pos -1203.21 476.314)
+          (id "0x9a83cf0")
+          (pos -1126 1072)
           (parent "")
           (select-mask 1)
           (path "images/decal/light.png")
@@ -925,8 +942,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a62ba0")
-          (pos 838.744 503.93)
+          (id "0x9ab5768")
+          (pos 916 1099)
           (parent "")
           (select-mask 1)
           (path "images/decal/light.png")
@@ -936,8 +953,8 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x11a63348")
-          (pos 241.479 454.773)
+          (id "0x9a83db0")
+          (pos 318 1050)
           (parent "")
           (select-mask 1)
           (path "images/decal/light.png")
@@ -952,8 +969,8 @@
       (locked #f)
       (objects
         (decal
-          (id "0x103ebda8")
-          (pos 24 457)
+          (id "0x9a85b90")
+          (pos 101 1053)
           (parent "")
           (select-mask 1)
           (path "images/decal/humanreference.png")
@@ -966,6 +983,13 @@
       (name "Scene")
       (visible #t)
       (locked #f)
-      (objects))))
+      (objects))
+    (layer
+      (name "NavGraph")
+      (visible #t)
+      (locked #f)
+      (objects
+        (navgraph-edge-ref
+          (edge "0x9a831f8"))))))
 
 ;; EOF ;;

Modified: trunk/windstille/data/sectors/trainstation/stairtest.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/stairtest.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/stairtest.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -8,7 +8,7 @@
   (navigation
     (nodes)
     (edges))
-  (objects
+  (layers
     (layer
       (name "New Layer")
       (visible #t)

Modified: trunk/windstille/data/sectors/trainstation/steelplatetest.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/steelplatetest.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/steelplatetest.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -8,7 +8,7 @@
   (navigation
     (nodes)
     (edges))
-  (objects
+  (layers
     (layer
       (name "Scene")
       (visible #t)

Modified: trunk/windstille/data/sectors/trainstation/toilet.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/toilet.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/toilet.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -3,7 +3,7 @@
 (windstille-sector
   (version 3)
   (name "")
-  (ambient-color 0.5 0.5 0.5 1)
+  (ambient-color 0.2 0.2 0.2 1)
   (init-script "init.nut")
   (navigation
     (nodes
@@ -36,7 +36,22 @@
         (node1 4)
         (node2 1)
         (properties 0))))
-  (objects
+  (layers
+
+ (background-gradient
+        (name "BackgroundGradient")
+(z-pos -100)
+(colors 
+0.000000 0.101798 0.203595 1.000000 1.000000 1.000000 1.000000 0.948165 0.969697 0.812122 1.000000 0 0
+0.203595 0.379143 0.487479 0.948165 0.969697 0.812122 1.000000 1.000000 0.552632 0.270000 1.000000 0 0
+0.487479 0.503577 0.529137 1.000000 0.552632 0.270000 1.000000 0.581721 0.096155 0.170043 1.000000 0 0
+0.529137 0.545165 0.562604 0.581721 0.096155 0.170043 1.000000 0.287879 0.155229 0.049835 1.000000 0 0
+0.562604 0.609349 0.697830 0.287879 0.155229 0.049835 1.000000 0.336000 0.425966 0.800000 1.000000 0 0
+0.697830 0.845064 1.000000 0.336000 0.425966 0.800000 1.000000 0.852165 0.985930 1.000000 1.000000 0 0
+
+
+)
+        )
     (layer
       (name "New Layer")
       (visible #t)

Modified: trunk/windstille/data/sectors/trainstation/train.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/train.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/train.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -8,7 +8,7 @@
   (navigation
     (nodes)
     (edges))
-  (objects
+  (layers
     (layer
       (name "New Layer")
       (visible #t)

Modified: trunk/windstille/data/sectors/trainstation/trainstation.wst
===================================================================
--- trunk/windstille/data/sectors/trainstation/trainstation.wst	2009-09-29 16:45:09 UTC (rev 3276)
+++ trunk/windstille/data/sectors/trainstation/trainstation.wst	2009-09-29 16:49:10 UTC (rev 3277)
@@ -7,81 +7,128 @@
   (init-script "init.nut")
   (navigation
     (nodes
-      (node
-        (id 1)
-        (pos -1648.56 171.625))
-      (node
-        (id 2)
-        (pos -787.625 1063.81))
-      (node
-        (id 3)
-        (pos -1532.94 1063.81))
-      (node
-        (id 4)
-        (pos -1526.69 338.813))
-      (node
-        (id 5)
-        (pos 2232.69 1062.25))
-      (node
-        (id 6)
-        (pos 2251.44 370.063))
-      (node
-        (id 7)
-        (pos -390.75 371.625))
-      (node
-        (id 8)
-        (pos -514.187 563.812))
-      (node
-        (id 9)
-        (pos -567.312 562.25))
-      (node
-        (id 10)
-        (pos -903.25 331)))
+      (navgraph-node
+        (id "0xa6057a0")
+        (pos 2264.28 1062.27)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0xa605698")
+        (pos -1524.72 1062.27)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0xa605618")
+        (pos -1524.72 338.268)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0xa605598")
+        (pos -899.716 338.268)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0xa605410")
+        (pos -565.716 557.268)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0xa6054c0")
+        (pos -517.716 557.268)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0xa605458")
+        (pos -382.716 363.268)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0xa6550e0")
+        (pos 2351.28 363.268)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0xa64e310")
+        (pos -770.966 1062.27)
+        (parent "")
+        (select-mask -1))
+      (navgraph-node
+        (id "0xa4ec890")
+        (pos -1649.87 184.003)
+        (parent "")
+        (select-mask -1)))
     (edges
-      (edge
-        (node1 1)
-        (node2 2)
-        (properties 0))
-      (edge
-        (node1 2)
-        (node2 3)
-        (properties 0))
-      (edge
-        (node1 3)
-        (node2 4)
-        (properties 0))
-      (edge
-        (node1 2)
-        (node2 5)
-        (properties 0))
-      (edge
-        (node1 6)
-        (node2 7)
-        (properties 0))
-      (edge
-        (node1 7)
-        (node2 8)
-        (properties 0))
-      (edge
-        (node1 8)
-        (node2 9)
-        (properties 0))
-      (edge
-        (node1 9)
-        (node2 10)
-        (properties 0))
-      (edge
-        (node1 10)
-        (node2 4)
-        (properties 0))))
-  (objects
+      (navgraph-edge
+        (id "0xa4ec7d0")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0xa4ec890")
+        (rhs-node "0xa64e310"))
+      (navgraph-edge
+        (id "0xa605c80")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0xa605618")
+        (rhs-node "0xa605698"))
+      (navgraph-edge
+        (id "0xa605bc8")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0xa605598")
+        (rhs-node "0xa605618"))
+      (navgraph-edge
+        (id "0xa605b38")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0xa605410")
+        (rhs-node "0xa605598"))
+      (navgraph-edge
+        (id "0xa605a80")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0xa6054c0")
+        (rhs-node "0xa605410"))
+      (navgraph-edge
+        (id "0xa6059e0")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0xa605458")
+        (rhs-node "0xa6054c0"))
+      (navgraph-edge
+        (id "0xa605900")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0xa605458")
+        (rhs-node "0xa6550e0"))
+      (navgraph-edge
+        (id "0xa605848")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0xa64e310")
+        (rhs-node "0xa605698"))
+      (navgraph-edge
+        (id "0xa64df10")
+        (pos 0 0)
+        (parent "")
+        (select-mask -1)
+        (lhs-node "0xa64e310")
+        (rhs-node "0xa6057a0"))))
+  (layers
     (layer
       (name "Tunnel Wall")
       (visible #t)
       (locked #t)
       (objects
         (decal
-          (id "0xa355cd0")
+          (id "0xc46fc28")
           (pos 1790.43 900.717)
           (parent "")
           (select-mask 1)
@@ -92,7 +139,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2ef618")
+          (id "0xc6a43a0")
           (pos 2046.43 900.717)
           (parent "")
           (select-mask 1)
@@ -103,7 +150,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2766e8")
+          (id "0xc6a9fb0")
           (pos 1278.43 900.717)
           (parent "")
           (select-mask 1)
@@ -114,7 +161,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa276558")
+          (id "0xc6a96a0")
           (pos 1534.43 900.717)
           (parent "")
           (select-mask 1)
@@ -125,7 +172,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa3e84d8")
+          (id "0xc6aa938")
           (pos 1022.43 900.717)
           (parent "")
           (select-mask 1)
@@ -136,7 +183,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa3e8a78")
+          (id "0xc6a94e8")
           (pos 2165.35 656.717)
           (parent "")
           (select-mask 1)
@@ -147,7 +194,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa4f6d68")
+          (id "0xc6a9ac0")
           (pos 2101.35 464.717)
           (parent "")
           (select-mask 1)
@@ -158,7 +205,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa276820")
+          (id "0xc4706e8")
           (pos 2037.34 656.717)
           (parent "")
           (select-mask 1)
@@ -169,7 +216,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa276900")
+          (id "0xc4707f8")
           (pos 1781.34 656.717)
           (parent "")
           (select-mask 1)
@@ -180,7 +227,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa60b578")
+          (id "0xc470920")
           (pos 1845.35 464.717)
           (parent "")
           (select-mask 1)
@@ -191,7 +238,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa276b40")
+          (id "0xc6a8bb0")
           (pos 1909.34 656.717)
           (parent "")
           (select-mask 1)
@@ -202,7 +249,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa60b6e8")
+          (id "0xc6a89c8")
           (pos 1397.34 656.717)
           (parent "")
           (select-mask 1)
@@ -213,7 +260,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa66b960")
+          (id "0xc46dc70")
           (pos 1333.35 464.717)
           (parent "")
           (select-mask 1)
@@ -224,7 +271,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa66bbb8")
+          (id "0xc46dd70")
           (pos 1269.34 656.717)
           (parent "")
           (select-mask 1)
@@ -235,7 +282,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa6cbdb8")
+          (id "0xc46dfa8")
           (pos 1525.34 656.717)
           (parent "")
           (select-mask 1)
@@ -246,7 +293,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa6cc058")
+          (id "0xc46e200")
           (pos 1589.35 464.717)
           (parent "")
           (select-mask 1)
@@ -257,7 +304,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa6cbf50")
+          (id "0xc46e0f0")
           (pos 1653.34 656.717)
           (parent "")
           (select-mask 1)
@@ -268,7 +315,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa60b7f8")
+          (id "0xc46e540")
           (pos 629.352 656.717)
           (parent "")
           (select-mask 1)
@@ -279,7 +326,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa3e8920")
+          (id "0xc46e788")
           (pos 565.354 464.717)
           (parent "")
           (select-mask 1)
@@ -290,7 +337,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa3e85e8")
+          (id "0xc46e628")
           (pos 501.352 656.717)
           (parent "")
           (select-mask 1)
@@ -301,7 +348,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa77c650")
+          (id "0xc46eaa0")
           (pos 245.352 656.717)
           (parent "")
           (select-mask 1)
@@ -312,7 +359,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa77c728")
+          (id "0xc46ed18")
           (pos 309.354 464.717)
           (parent "")
           (select-mask 1)
@@ -323,7 +370,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa72c228")
+          (id "0xc46ef98")
           (pos 373.352 656.717)
           (parent "")
           (select-mask 1)
@@ -334,7 +381,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa7dcfe8")
+          (id "0xc46f4f8")
           (pos 885.352 656.717)
           (parent "")
           (select-mask 1)
@@ -345,7 +392,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa7ed408")
+          (id "0xc46f5b8")
           (pos 821.354 464.717)
           (parent "")
           (select-mask 1)
@@ -356,7 +403,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa7ed0d8")
+          (id "0xc46f060")
           (pos 757.352 656.717)
           (parent "")
           (select-mask 1)
@@ -367,7 +414,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa7cccf0")
+          (id "0xc46f120")
           (pos 1013.35 656.717)
           (parent "")
           (select-mask 1)
@@ -378,7 +425,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa84d568")
+          (id "0xc46f1d0")
           (pos 1077.35 464.717)
           (parent "")
           (select-mask 1)
@@ -389,7 +436,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa89dab8")
+          (id "0xc478f48")
           (pos 1141.34 656.717)
           (parent "")
           (select-mask 1)
@@ -400,7 +447,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa89d9c0")
+          (id "0xc479118")
           (pos -394.638 656.717)
           (parent "")
           (select-mask 1)
@@ -411,7 +458,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa72c3b0")
+          (id "0xc479390")
           (pos -138.648 656.717)
           (parent "")
           (select-mask 1)
@@ -422,7 +469,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa78cbb8")
+          (id "0xc4795f8")
           (pos -202.646 464.717)
           (parent "")
           (select-mask 1)
@@ -433,7 +480,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa78ca50")
+          (id "0xc47a770")
           (pos -266.648 656.717)
           (parent "")
           (select-mask 1)
@@ -444,7 +491,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa84d680")
+          (id "0xc47a890")
           (pos -10.6475 656.717)
           (parent "")
           (select-mask 1)
@@ -455,7 +502,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa84d760")
+          (id "0xc479720")
           (pos 53.3544 464.717)
           (parent "")
           (select-mask 1)
@@ -466,7 +513,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa96e450")
+          (id "0xc479818")
           (pos 117.352 656.717)
           (parent "")
           (select-mask 1)
@@ -477,7 +524,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa97e958")
+          (id "0xd0a33c0")
           (pos 766.427 900.717)
           (parent "")
           (select-mask 1)
@@ -488,7 +535,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa97e5d0")
+          (id "0xc479cf8")
           (pos 510.427 900.717)
           (parent "")
           (select-mask 1)
@@ -499,7 +546,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa97e728")
+          (id "0xc479b90")
           (pos 254.427 900.717)
           (parent "")
           (select-mask 1)
@@ -510,7 +557,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa9cea58")
+          (id "0xd0a3078")
           (pos -458.636 464.717)
           (parent "")
           (select-mask 1)
@@ -521,7 +568,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa9ced78")
+          (id "0xd0a31d8")
           (pos -522.638 656.717)
           (parent "")
           (select-mask 1)
@@ -532,7 +579,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa9ceb68")
+          (id "0xd0f3470")
           (pos -1.57263 900.717)
           (parent "")
           (select-mask 1)
@@ -543,7 +590,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa8adb60")
+          (id "0xd0f3548")
           (pos -257.573 900.717)
           (parent "")
           (select-mask 1)
@@ -554,7 +601,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xaa29178")
+          (id "0xd0f3620")
           (pos -513.573 900.717)
           (parent "")
           (select-mask 1)
@@ -570,9 +617,9 @@
       (locked #t)
       (objects
         (decal
-          (id "0x9c972a8")
+          (id "0xc6a2a20")
           (pos -752 0)
-          (parent "0xa25d958")
+          (parent "0xc0e2fe8")
           (select-mask 1)
           (path "images/decal/train_front.png")
           (type 0)
@@ -581,9 +628,9 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9c97550")
+          (id "0xc1ed1e8")
           (pos 696 0)
-          (parent "0xa25d958")
+          (parent "0xc0e2fe8")
           (select-mask 1)
           (path "images/decal/train_back.png")
           (type 0)
@@ -592,7 +639,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa25d958")
+          (id "0xc0e2fe8")
           (pos 1705.54 939.785)
           (parent "")
           (select-mask 1)
@@ -603,9 +650,9 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa22d578")
+          (id "0xc6a3870")
           (pos -586.991 241.125)
-          (parent "0xa25d958")
+          (parent "0xc0e2fe8")
           (select-mask 1)
           (path "images/decal/train_engine_front.png")
           (type 0)
@@ -614,9 +661,9 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa184938")
+          (id "0xc6a5e00")
           (pos 593.009 242.125)
-          (parent "0xa25d958")
+          (parent "0xc0e2fe8")
           (select-mask 1)
           (path "images/decal/train_engine_back.png")
           (type 0)
@@ -625,9 +672,9 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9fdf480")
+          (id "0xc6a5c78")
           (pos -206.991 241.125)
-          (parent "0xa25d958")
+          (parent "0xc0e2fe8")
           (select-mask 1)
           (path "images/decal/train_engine_middle.png")
           (type 0)
@@ -636,9 +683,9 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa276410")
+          (id "0xc6a6218")
           (pos 249.009 241.125)
-          (parent "0xa25d958")
+          (parent "0xc0e2fe8")
           (select-mask 1)
           (path "images/decal/train_engine_middle.png")
           (type 0)
@@ -647,9 +694,9 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa2ef118")
+          (id "0xc6a6430")
           (pos 0.719482 -14.875)
-          (parent "0xa25d958")
+          (parent "0xc0e2fe8")
           (select-mask 1)
           (path "images/decal/train_door.png")
           (type 0)
@@ -663,7 +710,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0xa25d878")
+          (id "0xb6d5f48")
           (pos -498.687 804.29)
           (parent "")
           (select-mask 1)
@@ -674,7 +721,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9b7f850")
+          (id "0xc6a3a60")
           (pos -418.187 492.016)
           (parent "")
           (select-mask 1)
@@ -684,28 +731,18 @@
           (angle 0)
           (hflip #f)
           (vflip #f))))
-  (particle-systems     
-      (name "particlesystems/water.particles")
-      (pos -100 300))
-  (particle-systems     
-      (name "particlesystems/fire.particles")
-      (pos -200 550))
-  (particle-systems     
-      (name "particlesystems/fire.particles")
-      (pos -100 550))
-  (particle-systems     
-      (name "particlesystems/fire.particles")
-      (pos -50 550))
-  (particle-systems     
-      (name "particlesystems/water.particles")
-      (pos -100 300))
     (layer
+      (name "Fire")
+      (visible #t)
+      (locked #t)
+      (objects))
+    (layer
       (name "StairWall")
       (visible #t)
       (locked #t)
       (objects
         (decal
-          (id "0x9ecc0b0")
+          (id "0xc1f0388")
           (pos -658.251 306.508)
           (parent "")
           (select-mask 1)
@@ -716,7 +753,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9edc758")
+          (id "0xc47dda0")
           (pos -658.251 434.508)
           (parent "")
           (select-mask 1)
@@ -727,7 +764,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9cd63d8")
+          (id "0xc47df18")
           (pos -656.688 690.508)
           (parent "")
           (select-mask 1)
@@ -738,7 +775,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9f4eca8")
+          (id "0xc47e678")
           (pos -656.688 562.508)
           (parent "")
           (select-mask 1)
@@ -749,7 +786,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9f4eb60")
+          (id "0xc47e768")
           (pos -1425 307)
           (parent "")
           (select-mask 1)
@@ -760,7 +797,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9f7ed50")
+          (id "0xc46bd98")
           (pos -656.462 935.117)
           (parent "")
           (select-mask 1)
@@ -771,7 +808,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9d49548")
+          (id "0xc47e3c8")
           (pos -656.688 818.508)
           (parent "")
           (select-mask 1)
@@ -782,7 +819,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9f4e960")
+          (id "0xc46d6c8")
           (pos -657 946)
           (parent "")
           (select-mask 1)
@@ -793,7 +830,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9d493f8")
+          (id "0xc472248")
           (pos -657 1074)
           (parent "")
           (select-mask 1)
@@ -804,7 +841,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9fdfad0")
+          (id "0xc471f98")
           (pos -1424.46 563.117)
           (parent "")
           (select-mask 1)
@@ -815,7 +852,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9f4e730")
+          (id "0xc471e50")
           (pos -1424.46 691.117)
           (parent "")
           (select-mask 1)
@@ -826,7 +863,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9faf088")
+          (id "0xc4720b8")
           (pos -1424.46 435.117)
           (parent "")
           (select-mask 1)
@@ -837,7 +874,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa0f41e8")
+          (id "0xc472638")
           (pos -1424.46 819.117)
           (parent "")
           (select-mask 1)
@@ -848,7 +885,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9faf1f0")
+          (id "0xc472350")
           (pos -1168.46 819.117)
           (parent "")
           (select-mask 1)
@@ -859,7 +896,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa0f3f40")
+          (id "0xc6a2d18")
           (pos -1168.46 435.117)
           (parent "")
           (select-mask 1)
@@ -870,7 +907,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa124258")
+          (id "0xc6a2f20")
           (pos -1168.46 691.117)
           (parent "")
           (select-mask 1)
@@ -881,7 +918,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa124300")
+          (id "0xc6a30f0")
           (pos -1168.46 563.117)
           (parent "")
           (select-mask 1)
@@ -892,7 +929,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa0dbcd8")
+          (id "0xc6a32e0")
           (pos -1169 307)
           (parent "")
           (select-mask 1)
@@ -903,7 +940,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9fdf398")
+          (id "0xc6a34c0")
           (pos -912.462 307.117)
           (parent "")
           (select-mask 1)
@@ -914,7 +951,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa1545a0")
+          (id "0xc6a3650")
           (pos -912.462 563.117)
           (parent "")
           (select-mask 1)
@@ -925,7 +962,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa154688")
+          (id "0xc6a3da0")
           (pos -912.462 691.117)
           (parent "")
           (select-mask 1)
@@ -936,7 +973,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9fdf810")
+          (id "0xc6a3bc8")
           (pos -912.462 435.117)
           (parent "")
           (select-mask 1)
@@ -947,7 +984,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa1b50a0")
+          (id "0xc6a3f58")
           (pos -912.462 819.117)
           (parent "")
           (select-mask 1)
@@ -958,7 +995,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa19cbf0")
+          (id "0xc6a4108")
           (pos -1169 947)
           (parent "")
           (select-mask 1)
@@ -969,7 +1006,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa1fd3d8")
+          (id "0xc6a2bd0")
           (pos -913 946)
           (parent "")
           (select-mask 1)
@@ -980,7 +1017,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0xa1b4f18")
+          (id "0xc4724c0")
           (pos -913 1074)
           (parent "")
           (select-mask 1)
@@ -991,12 +1028,19 @@
           (hflip #f)
           (vflip #f))))
     (layer
-      (name "Stairs")
+      (name "NavGraphStairs")
       (visible #t)
       (locked #t)
       (objects
+        (navgraph-edge-ref
+          (edge "0xa4ec7d0"))))
+    (layer
+      (name "Stairs")
+      (visible #t)
+      (locked #f)
+      (objects
         (decal
-          (id "0x9cfc8e8")
+          (id "0xbc49010")
           (pos -1040 739)
           (parent "")
           (select-mask 1)
@@ -1007,7 +1051,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9d497a0")
+          (id "0xc0e31a8")
           (pos -1358 869)
           (parent "")
           (select-mask 1)
@@ -1018,7 +1062,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9d59910")
+          (id "0xc155598")
           (pos -849 997)
           (parent "")
           (select-mask 1)
@@ -1029,7 +1073,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9d89d60")
+          (id "0xc143760")
           (pos -974 997)
           (parent "")
           (select-mask 1)
@@ -1040,7 +1084,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9d69a68")
+          (id "0xc143b70")
           (pos -974 869)
           (parent "")
           (select-mask 1)
@@ -1051,7 +1095,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9d99f40")
+          (id "0xbc3ffe0")
           (pos -1102 997)
           (parent "")
           (select-mask 1)
@@ -1062,7 +1106,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9daa258")
+          (id "0xbc40108")
           (pos -1102 869)
           (parent "")
           (select-mask 1)
@@ -1073,7 +1117,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9dba420")
+          (id "0xbc408c8")
           (pos -1102 741)
           (parent "")
           (select-mask 1)
@@ -1084,7 +1128,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9dda518")
+          (id "0xbc403d8")
           (pos -1230 613)
           (parent "")
           (select-mask 1)
@@ -1095,7 +1139,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9dea770")
+          (id "0xbc40258")
           (pos -1358 613)
           (parent "")
           (select-mask 1)
@@ -1106,7 +1150,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9dba338")
+          (id "0xbc409d8")
           (pos -1358 485)
           (parent "")
           (select-mask 1)
@@ -1117,7 +1161,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9dfaad0")
+          (id "0xbc40540")
           (pos -1486 613)
           (parent "")
           (select-mask 1)
@@ -1128,7 +1172,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9dfa9e8")
+          (id "0xbc41170")
           (pos -1486 485)
           (parent "")
           (select-mask 1)
@@ -1139,7 +1183,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9e1ae98")
+          (id "0xbc40678")
           (pos -1486 357)
           (parent "")
           (select-mask 1)
@@ -1150,7 +1194,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9e3afc8")
+          (id "0xbc41320")
           (pos -1358 741)
           (parent "")
           (select-mask 1)
@@ -1161,7 +1205,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9e4b2c0")
+          (id "0xbc414d8")
           (pos -1486 741)
           (parent "")
           (select-mask 1)
@@ -1172,7 +1216,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9e1adb8")
+          (id "0xbc415d8")
           (pos -1230 741)
           (parent "")
           (select-mask 1)
@@ -1183,7 +1227,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9e5b580")
+          (id "0xbc40ea0")
           (pos -1486 869)
           (parent "")
           (select-mask 1)
@@ -1194,7 +1238,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9e5b498")
+          (id "0xbc40f98")
           (pos -1230 869)
           (parent "")
           (select-mask 1)
@@ -1205,7 +1249,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9e7b948")
+          (id "0xbc41c70")
           (pos -1358 997)
           (parent "")
           (select-mask 1)
@@ -1216,7 +1260,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9e9ba78")
+          (id "0xbc40cc8")
           (pos -1486 997)
           (parent "")
           (select-mask 1)
@@ -1227,7 +1271,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9eabcb0")
+          (id "0xbc418c8")
           (pos -1230 997)
           (parent "")
           (select-mask 1)
@@ -1238,7 +1282,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9e7b868")
+          (id "0xbc419a0")
           (pos -1347 917)
           (parent "")
           (select-mask 1)
@@ -1251,10 +1295,10 @@
     (layer
       (name "StairHandle")
       (visible #t)
-      (locked #f)
+      (locked #t)
       (objects
         (decal
-          (id "0x9c96d50")
+          (id "0xb6d6070")
           (pos -964 844)
           (parent "")
           (select-mask 1)
@@ -1265,7 +1309,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9c96a00")
+          (id "0xbc30290")
           (pos -1058 746)
           (parent "")
           (select-mask 1)
@@ -1276,7 +1320,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9c97860")
+          (id "0xbbfbf08")
           (pos -1155 652)
           (parent "")
           (select-mask 1)
@@ -1287,7 +1331,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9c96828")
+          (id "0xbc49ed8")
           (pos -1250 547)
           (parent "")
           (select-mask 1)
@@ -1298,7 +1342,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9cb3380")
+          (id "0xbbfbcf0")
           (pos -1347 456)
           (parent "")
           (select-mask 1)
@@ -1309,7 +1353,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9cb3460")
+          (id "0xbbfc408")
           (pos -1440 363)
           (parent "")
           (select-mask 1)
@@ -1320,7 +1364,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9cba3d0")
+          (id "0xbbfc5c8")
           (pos -863 930)
           (parent "")
           (select-mask 1)
@@ -1331,7 +1375,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9cc13a0")
+          (id "0xbbfc060")
           (pos -1537 273)
           (parent "")
           (select-mask 1)
@@ -1342,7 +1386,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9cc8348")
+          (id "0xbbfc1d8")
           (pos -841 864)
           (parent "")
           (select-mask 1)
@@ -1353,7 +1397,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9c97380")
+          (id "0xbbfcb30")
           (pos -969 736)
           (parent "")
           (select-mask 1)
@@ -1364,7 +1408,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9ce9758")
+          (id "0xbbfce40")
           (pos -1097 608)
           (parent "")
           (select-mask 1)
@@ -1375,7 +1419,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9cac3d8")
+          (id "0xc0e3498")
           (pos -1225 480)
           (parent "")
           (select-mask 1)
@@ -1386,7 +1430,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9cac450")
+          (id "0xc0e3528")
           (pos -1353 352)
           (parent "")
           (select-mask 1)
@@ -1402,7 +1446,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0x9a1ce08")
+          (id "0xb6cb410")
           (pos -1672.24 1055.45)
           (parent "")
           (select-mask 1)
@@ -1413,7 +1457,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9b332d0")
+          (id "0xb239c38")
           (pos -1529 861)
           (parent "")
           (select-mask 1)
@@ -1424,7 +1468,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9b7f710")
+          (id "0xbc4a728")
           (pos -1557 564)
           (parent "")
           (select-mask 1)
@@ -1435,7 +1479,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9112f50")
+          (id "0xb6d5ba8")
           (pos -1484.44 1141.69)
           (parent "")
           (select-mask 1)
@@ -1446,7 +1490,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9c17a40")
+          (id "0xb6d63b8")
           (pos -937.569 1133.87)
           (parent "")
           (select-mask 1)
@@ -1457,17 +1501,12 @@
           (hflip #f)
           (vflip #f))))
     (layer
-      (name "Stairs")
-      (visible #t)
-      (locked #t)
-      (objects))
-    (layer
       (name "Ground")
       (visible #t)
       (locked #t)
       (objects
         (decal
-          (id "0x9a1ced0")
+          (id "0xb6cb4d8")
           (pos 1836.13 1103.44)
           (parent "")
           (select-mask 1)
@@ -1478,7 +1517,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x97f1050")
+          (id "0xb4575f8")
           (pos 2144.13 1103.44)
           (parent "")
           (select-mask 1)
@@ -1489,7 +1528,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9717a90")
+          (id "0xb6d53f0")
           (pos -1551.87 1103.44)
           (parent "")
           (select-mask 1)
@@ -1500,7 +1539,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9717b98")
+          (id "0xbc4ad98")
           (pos -1243.87 1103.44)
           (parent "")
           (select-mask 1)
@@ -1511,7 +1550,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x97f0d70")
+          (id "0xbbfd140")
           (pos -935.87 1103.44)
           (parent "")
           (select-mask 1)
@@ -1522,7 +1561,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x97f0e48")
+          (id "0xbbfd498")
           (pos -627.87 1103.44)
           (parent "")
           (select-mask 1)
@@ -1533,7 +1572,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x97f1388")
+          (id "0xbbfd390")
           (pos -319.87 1103.44)
           (parent "")
           (select-mask 1)
@@ -1544,7 +1583,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9b333a8")
+          (id "0xbc4a988")
           (pos -11.87 1103.44)
           (parent "")
           (select-mask 1)
@@ -1555,7 +1594,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9b334f8")
+          (id "0xbc4aa70")
           (pos 296.13 1103.44)
           (parent "")
           (select-mask 1)
@@ -1566,7 +1605,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9b33708")
+          (id "0xbc4ab80")
           (pos 604.13 1103.44)
           (parent "")
           (select-mask 1)
@@ -1577,7 +1616,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9bcb858")
+          (id "0xb6d55b8")
           (pos 912.13 1103.44)
           (parent "")
           (select-mask 1)
@@ -1588,7 +1627,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9bcb920")
+          (id "0xb6d59e8")
           (pos 1220.13 1103.44)
           (parent "")
           (select-mask 1)
@@ -1599,7 +1638,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9bcba08")
+          (id "0xb6d5858")
           (pos 1528.13 1103.44)
           (parent "")
           (select-mask 1)
@@ -1610,12 +1649,33 @@
           (hflip #f)
           (vflip #f))))
     (layer
+      (name "NavigationGraph")
+      (visible #t)
+      (locked #t)
+      (objects
+        (navgraph-edge-ref
+          (edge "0xa605c80"))
+        (navgraph-edge-ref
+          (edge "0xa605bc8"))
+        (navgraph-edge-ref
+          (edge "0xa605b38"))
+        (navgraph-edge-ref
+          (edge "0xa605a80"))
+        (navgraph-edge-ref
+          (edge "0xa6059e0"))
+        (navgraph-edge-ref
+          (edge "0xa605900"))
+        (navgraph-edge-ref
+          (edge "0xa605848"))
+        (navgraph-edge-ref
+          (edge "0xa64df10"))))
+    (layer
       (name "Endwall")
       (visible #t)
       (locked #t)
       (objects
         (decal
-          (id "0x9717a48")
+          (id "0xb456308")
           (pos -1539 508)
           (parent "")
           (select-mask 1)
@@ -1626,7 +1686,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x90ec6b8")
+          (id "0xa961b88")
           (pos -1539 380)
           (parent "")
           (select-mask 1)
@@ -1637,7 +1697,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x90e00f0")
+          (id "0xb458198")
           (pos -1539 1020)
           (parent "")
           (select-mask 1)
@@ -1648,7 +1708,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b39eb0")
+          (id "0xb6caab0")
           (pos -1539 892)
           (parent "")
           (select-mask 1)
@@ -1659,7 +1719,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b35170")
+          (id "0xb4582e0")
           (pos -1539 636)
           (parent "")
           (select-mask 1)
@@ -1670,7 +1730,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9717d50")
+          (id "0xb6c8a80")
           (pos -1539 764)
           (parent "")
           (select-mask 1)
@@ -1681,7 +1741,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x97182a0")
+          (id "0xad4ad50")
           (pos -1539 1148)
           (parent "")
           (select-mask 1)
@@ -1692,7 +1752,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbb0d0")
+          (id "0xb6c8c40")
           (pos -1741 1084)
           (parent "")
           (select-mask 1)
@@ -1703,7 +1763,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9718400")
+          (id "0xb6cc7e0")
           (pos -2111 1084)
           (parent "")
           (select-mask 1)
@@ -1714,7 +1774,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x97188f0")
+          (id "0xb6cc988")
           (pos -2111 824)
           (parent "")
           (select-mask 1)
@@ -1725,7 +1785,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x96ed0c0")
+          (id "0xb6cca60")
           (pos -1741 824)
           (parent "")
           (select-mask 1)
@@ -1736,7 +1796,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x96ecf30")
+          (id "0xb457a40")
           (pos -2111 568)
           (parent "")
           (select-mask 1)
@@ -1747,7 +1807,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9906ee8")
+          (id "0xb457b68")
           (pos -1741 568)
           (parent "")
           (select-mask 1)
@@ -1758,7 +1818,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9907138")
+          (id "0xb6ccd00")
           (pos -2109 312)
           (parent "")
           (select-mask 1)
@@ -1769,7 +1829,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9907240")
+          (id "0xb6ccb18")
           (pos -1739 312)
           (parent "")
           (select-mask 1)
@@ -1780,7 +1840,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x97185d0")
+          (id "0xb6cd3b8")
           (pos -1763.88 1198.81)
           (parent "")
           (select-mask 1)
@@ -1791,7 +1851,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x97186a0")
+          (id "0xb6cd638")
           (pos -2080.29 1241.78)
           (parent "")
           (select-mask 1)
@@ -1802,7 +1862,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9718758")
+          (id "0xb6cd4a8")
           (pos -2400.6 1212.48)
           (parent "")
           (select-mask 1)
@@ -1813,7 +1873,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x97f0b28")
+          (id "0xb6cd288")
           (pos -2239 276)
           (parent "")
           (select-mask 1)
@@ -1824,7 +1884,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9a1cc90")
+          (id "0xb6ccf28")
           (pos -1976 368)
           (parent "")
           (select-mask 1)
@@ -1835,7 +1895,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9a1cf98")
+          (id "0xb456d58")
           (pos -1717 263)
           (parent "")
           (select-mask 1)
@@ -1851,7 +1911,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0x90ef918")
+          (id "0xb00e820")
           (pos -249.032 1380.44)
           (parent "")
           (select-mask 1)
@@ -1862,7 +1922,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x90efa48")
+          (id "0xb239130")
           (pos -761.032 1380.44)
           (parent "")
           (select-mask 1)
@@ -1873,7 +1933,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9028db8")
+          (id "0xad84130")
           (pos -2297.03 1380.44)
           (parent "")
           (select-mask 1)
@@ -1884,7 +1944,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9124d58")
+          (id "0xad84488")
           (pos -1785.03 1380.44)
           (parent "")
           (select-mask 1)
@@ -1895,7 +1955,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9126fe8")
+          (id "0xad84318")
           (pos -1273.03 1380.44)
           (parent "")
           (select-mask 1)
@@ -1906,7 +1966,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbc418")
+          (id "0xb43f200")
           (pos 262.968 1380.44)
           (parent "")
           (select-mask 1)
@@ -1917,7 +1977,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbc4f8")
+          (id "0xb440138")
           (pos 774.968 1380.44)
           (parent "")
           (select-mask 1)
@@ -1928,7 +1988,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbc5c8")
+          (id "0xb43f390")
           (pos 1798.97 1380.44)
           (parent "")
           (select-mask 1)
@@ -1939,7 +1999,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbc738")
+          (id "0xb440290")
           (pos 1286.97 1380.44)
           (parent "")
           (select-mask 1)
@@ -1950,7 +2010,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbcdc8")
+          (id "0xb4409a0")
           (pos 1670.97 1273.44)
           (parent "")
           (select-mask 1)
@@ -1961,7 +2021,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbcae0")
+          (id "0xb440820")
           (pos 1926.97 1273.44)
           (parent "")
           (select-mask 1)
@@ -1972,7 +2032,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbcc00")
+          (id "0xb359730")
           (pos 1414.97 1273.44)
           (parent "")
           (select-mask 1)
@@ -1983,7 +2043,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbcc80")
+          (id "0xb43fb30")
           (pos 1158.97 1273.44)
           (parent "")
           (select-mask 1)
@@ -1994,7 +2054,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbb5d0")
+          (id "0xb359270")
           (pos 2214.14 1187.44)
           (parent "")
           (select-mask 1)
@@ -2005,7 +2065,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbb758")
+          (id "0xb238468")
           (pos 1702.14 1187.44)
           (parent "")
           (select-mask 1)
@@ -2016,7 +2076,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbc020")
+          (id "0xb2385f8")
           (pos 1958.14 1187.44)
           (parent "")
           (select-mask 1)
@@ -2027,7 +2087,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x93a7620")
+          (id "0xb238770")
           (pos 1446.14 1187.44)
           (parent "")
           (select-mask 1)
@@ -2038,7 +2098,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbc130")
+          (id "0xb238808")
           (pos -121.032 1273.44)
           (parent "")
           (select-mask 1)
@@ -2049,7 +2109,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbba28")
+          (id "0xb238988")
           (pos -377.032 1273.44)
           (parent "")
           (select-mask 1)
@@ -2060,7 +2120,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x93a74d0")
+          (id "0xb238eb0")
           (pos 646.968 1273.44)
           (parent "")
           (select-mask 1)
@@ -2071,7 +2131,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbb8c0")
+          (id "0xb238dc0")
           (pos 902.968 1273.44)
           (parent "")
           (select-mask 1)
@@ -2082,7 +2142,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbbbb8")
+          (id "0xb238ba8")
           (pos 390.968 1273.44)
           (parent "")
           (select-mask 1)
@@ -2093,7 +2153,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8dbbd78")
+          (id "0xb238c08")
           (pos 134.968 1273.44)
           (parent "")
           (select-mask 1)
@@ -2104,7 +2164,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x91252e0")
+          (id "0xb358c50")
           (pos 1190.13 1187.44)
           (parent "")
           (select-mask 1)
@@ -2115,7 +2175,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9125410")
+          (id "0xb358740")
           (pos 934.13 1187.44)
           (parent "")
           (select-mask 1)
@@ -2126,7 +2186,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9125648")
+          (id "0xb358820")
           (pos 422.13 1187.44)
           (parent "")
           (select-mask 1)
@@ -2137,7 +2197,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9125778")
+          (id "0xb358ae0")
           (pos 166.13 1187.44)
           (parent "")
           (select-mask 1)
@@ -2148,7 +2208,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x91259b0")
+          (id "0xb358b78")
           (pos 678.13 1187.44)
           (parent "")
           (select-mask 1)
@@ -2159,7 +2219,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9125ae0")
+          (id "0xb3581a0")
           (pos -89.87 1187.44)
           (parent "")
           (select-mask 1)
@@ -2170,7 +2230,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9125d18")
+          (id "0xb3584b8")
           (pos -889.032 1273.44)
           (parent "")
           (select-mask 1)
@@ -2181,7 +2241,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9125e48")
+          (id "0xb458550")
           (pos -633.032 1273.44)
           (parent "")
           (select-mask 1)
@@ -2192,7 +2252,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9126080")
+          (id "0xb458e68")
           (pos -345.87 1187.44)
           (parent "")
           (select-mask 1)
@@ -2203,7 +2263,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x91261b0")
+          (id "0xb358350")
           (pos -601.87 1187.44)
           (parent "")
           (select-mask 1)
@@ -2214,7 +2274,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x91263e8")
+          (id "0xb358e20")
           (pos -1369.87 1187.44)
           (parent "")
           (select-mask 1)
@@ -2225,7 +2285,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x91266b0")
+          (id "0xb458b98")
           (pos -1881.87 1187.44)
           (parent "")
           (select-mask 1)
@@ -2236,7 +2296,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x93a72f8")
+          (id "0xb458d50")
           (pos -1625.87 1187.44)
           (parent "")
           (select-mask 1)
@@ -2247,7 +2307,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x95eac18")
+          (id "0xb4597d0")
           (pos -1113.87 1187.44)
           (parent "")
           (select-mask 1)
@@ -2258,7 +2318,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x91250a8")
+          (id "0xb458720")
           (pos -857.872 1187.44)
           (parent "")
           (select-mask 1)
@@ -2269,7 +2329,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9126e90")
+          (id "0xb458938")
           (pos -1145.03 1273.44)
           (parent "")
           (select-mask 1)
@@ -2280,7 +2340,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9126c78")
+          (id "0xb45a1a0")
           (pos -1657.03 1273.44)
           (parent "")
           (select-mask 1)
@@ -2291,7 +2351,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x96156a8")
+          (id "0xb459438")
           (pos -1401.03 1273.44)
           (parent "")
           (select-mask 1)
@@ -2302,7 +2362,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9615578")
+          (id "0xb4595c0")
           (pos -1913.03 1273.44)
           (parent "")
           (select-mask 1)
@@ -2313,7 +2373,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9615720")
+          (id "0xb45a038")
           (pos -2169.03 1273.44)
           (parent "")
           (select-mask 1)
@@ -2324,7 +2384,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9640428")
+          (id "0xb4591b8")
           (pos -3193.03 1273.44)
           (parent "")
           (select-mask 1)
@@ -2335,7 +2395,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9640280")
+          (id "0xb459070")
           (pos -2937.03 1273.44)
           (parent "")
           (select-mask 1)
@@ -2346,7 +2406,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9680df8")
+          (id "0xb459ce8")
           (pos -2681.03 1273.44)
           (parent "")
           (select-mask 1)
@@ -2357,7 +2417,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9680fb8")
+          (id "0xb459e98")
           (pos -2649.87 1187.44)
           (parent "")
           (select-mask 1)
@@ -2368,7 +2428,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x96ac178")
+          (id "0xb4599f8")
           (pos -2905.87 1187.44)
           (parent "")
           (select-mask 1)
@@ -2379,7 +2439,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x96ac4c0")
+          (id "0xb6cab58")
           (pos -2809.03 1380.44)
           (parent "")
           (select-mask 1)
@@ -2390,7 +2450,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x96ece10")
+          (id "0xb4598d0")
           (pos -3321.03 1380.44)
           (parent "")
           (select-mask 1)
@@ -2401,7 +2461,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x95eaa78")
+          (id "0xb6cae98")
           (pos -2393.87 1187.44)
           (parent "")
           (select-mask 1)
@@ -2412,7 +2472,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x96ac358")
+          (id "0xb6cac90")
           (pos -2137.87 1187.44)
           (parent "")
           (select-mask 1)
@@ -2423,7 +2483,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x9126750")
+          (id "0xb6cb048")
           (pos -2425.03 1273.44)
           (parent "")
           (select-mask 1)
@@ -2439,7 +2499,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0x8b39f60")
+          (id "0xad4ac28")
           (pos 240.218 886.438)
           (parent "")
           (select-mask 1)
@@ -2450,7 +2510,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b384a8")
+          (id "0xa961ee0")
           (pos 934.407 913.438)
           (parent "")
           (select-mask 1)
@@ -2461,7 +2521,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b38a30")
+          (id "0xad4a200")
           (pos -163.625 985.44)
           (parent "")
           (select-mask 1)
@@ -2472,7 +2532,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b38d50")
+          (id "0xae44620")
           (pos 578.562 985.44)
           (parent "")
           (select-mask 1)
@@ -2483,7 +2543,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8e711d8")
+          (id "0xae43f28")
           (pos 1244.19 985.44)
           (parent "")
           (select-mask 1)
@@ -2494,7 +2554,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b38e68")
+          (id "0xae443c0")
           (pos 1689.49 985.44)
           (parent "")
           (select-mask 1)
@@ -2505,7 +2565,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b38f10")
+          (id "0xae44238")
           (pos 2006.69 985.44)
           (parent "")
           (select-mask 1)
@@ -2516,7 +2576,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b39178")
+          (id "0xad86f48")
           (pos 424.131 1013.44)
           (parent "")
           (select-mask 1)
@@ -2527,7 +2587,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8e70898")
+          (id "0xad87408")
           (pos -1002.18 1013.44)
           (parent "")
           (select-mask 1)
@@ -2538,7 +2598,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8e709e8")
+          (id "0xad7e740")
           (pos -914.086 1013.44)
           (parent "")
           (select-mask 1)
@@ -2549,7 +2609,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x904b6c0")
+          (id "0xad7e5e0")
           (pos -832.618 1013.44)
           (parent "")
           (select-mask 1)
@@ -2560,7 +2620,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x904b5e0")
+          (id "0xad7e8d0")
           (pos 1064.43 1014.67)
           (parent "")
           (select-mask 1)
@@ -2571,7 +2631,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x90d0a58")
+          (id "0xad86a38")
           (pos 676.954 1029.44)
           (parent "")
           (select-mask 1)
@@ -2582,7 +2642,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8e70d88")
+          (id "0xad87b50")
           (pos 612.954 1029.44)
           (parent "")
           (select-mask 1)
@@ -2593,7 +2653,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x90d9c80")
+          (id "0xad7f6f0")
           (pos 648.954 965.44)
           (parent "")
           (select-mask 1)
@@ -2604,7 +2664,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x90d9d38")
+          (id "0xad7f858")
           (pos 740.954 1029.44)
           (parent "")
           (select-mask 1)
@@ -2615,7 +2675,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x90dce58")
+          (id "0xad7f2d8")
           (pos 584.954 965.44)
           (parent "")
           (select-mask 1)
@@ -2626,7 +2686,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x90ca7c8")
+          (id "0xad7f4f8")
           (pos 548.954 1029.44)
           (parent "")
           (select-mask 1)
@@ -2637,7 +2697,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x90e6308")
+          (id "0xad7f5b0")
           (pos 706.554 965.44)
           (parent "")
           (select-mask 1)
@@ -2648,7 +2708,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x90e6398")
+          (id "0xb2399b0")
           (pos 28.218 973.438)
           (parent "")
           (select-mask 1)
@@ -2659,7 +2719,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x90efb70")
+          (id "0xb239a90")
           (pos 1448.12 973.44)
           (parent "")
           (select-mask 1)
@@ -2670,12 +2730,17 @@
           (hflip #f)
           (vflip #f))))
     (layer
+      (name "Fire2")
+      (visible #t)
+      (locked #t)
+      (objects))
+    (layer
       (name "Lamps")
       (visible #t)
       (locked #t)
       (objects
         (decal
-          (id "0x8b351c8")
+          (id "0xaaac070")
           (pos 266.7 554.465)
           (parent "")
           (select-mask 1)
@@ -2686,7 +2751,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b35668")
+          (id "0xaaad128")
           (pos 999.122 579.855)
           (parent "")
           (select-mask 1)
@@ -2697,7 +2762,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b361f8")
+          (id "0xaaad698")
           (pos 1651.47 577.902)
           (parent "")
           (select-mask 1)
@@ -2708,7 +2773,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b36068")
+          (id "0xa963760")
           (pos 1660.56 541.188)
           (parent "")
           (select-mask 1)
@@ -2719,7 +2784,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b39908")
+          (id "0xaaad898")
           (pos 998.057 533.375)
           (parent "")
           (select-mask 1)
@@ -2730,7 +2795,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b396f0")
+          (id "0xaaad940")
           (pos 237.12 549)
           (parent "")
           (select-mask 1)
@@ -2741,7 +2806,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b393a8")
+          (id "0xaaada38")
           (pos 1642.66 434.301)
           (parent "")
           (select-mask 1)
@@ -2752,7 +2817,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b39c88")
+          (id "0xa9631c8")
           (pos 982.958 428.895)
           (parent "")
           (select-mask 1)
@@ -2763,7 +2828,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b399d0")
+          (id "0xad88610")
           (pos 231.267 426.715)
           (parent "")
           (select-mask 1)
@@ -2779,7 +2844,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0x8db8848")
+          (id "0xa959e00")
           (pos -132.297 329.766)
           (parent "")
           (select-mask 1)
@@ -2790,7 +2855,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8db8150")
+          (id "0xa972320")
           (pos 378.703 329.766)
           (parent "")
           (select-mask 1)
@@ -2801,7 +2866,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8db83c0")
+          (id "0xa971b10")
           (pos 1400.7 331.719)
           (parent "")
           (select-mask 1)
@@ -2812,7 +2877,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b3a8b0")
+          (id "0xa971ca8")
           (pos 889.703 331.719)
           (parent "")
           (select-mask 1)
@@ -2823,7 +2888,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8db81c0")
+          (id "0xaaaefe8")
           (pos 2422.7 331.719)
           (parent "")
           (select-mask 1)
@@ -2834,7 +2899,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8db8278")
+          (id "0xaaaf158")
           (pos 1911.7 331.719)
           (parent "")
           (select-mask 1)
@@ -2845,7 +2910,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b3a2f8")
+          (id "0xaaaf2d0")
           (pos -1652.53 298.683)
           (parent "")
           (select-mask 1)
@@ -2856,7 +2921,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b36710")
+          (id "0xa9719d8")
           (pos -771.438 410.719)
           (parent "")
           (select-mask 1)
@@ -2867,7 +2932,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b36998")
+          (id "0xaaab968")
           (pos -1141.53 298.683)
           (parent "")
           (select-mask 1)
@@ -2878,7 +2943,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b36468")
+          (id "0xaaabb10")
           (pos -2163.53 298.683)
           (parent "")
           (select-mask 1)
@@ -2889,7 +2954,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b362f8")
+          (id "0xaaabca0")
           (pos -2674.53 298.683)
           (parent "")
           (select-mask 1)
@@ -2905,7 +2970,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0x8c92c30")
+          (id "0xa674f10")
           (pos -2249.87 1060.44)
           (parent "")
           (select-mask 1)
@@ -2916,7 +2981,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8c2c470")
+          (id "0xa959fa0")
           (pos -2244.5 972.452)
           (parent "")
           (select-mask 1)
@@ -2927,7 +2992,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8c2c618")
+          (id "0xa95b150")
           (pos -2151.95 1070.86)
           (parent "")
           (select-mask 1)
@@ -2938,7 +3003,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8c92a58")
+          (id "0xa972d48")
           (pos -2223.31 378.014)
           (parent "")
           (select-mask 1)
@@ -2949,7 +3014,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8c92bd0")
+          (id "0xa972de0")
           (pos -2222.56 441.264)
           (parent "")
           (select-mask 1)
@@ -2960,7 +3025,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b3b688")
+          (id "0xa972a98")
           (pos -2231.18 652.952)
           (parent "")
           (select-mask 1)
@@ -2971,7 +3036,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8c928f0")
+          (id "0xa973508")
           (pos -2231.93 589.702)
           (parent "")
           (select-mask 1)
@@ -2982,7 +3047,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b3b510")
+          (id "0xa973360")
           (pos -2223.79 825.967)
           (parent "")
           (select-mask 1)
@@ -2993,7 +3058,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b3b988")
+          (id "0xa9730c8")
           (pos -2016.48 1029.67)
           (parent "")
           (select-mask 1)
@@ -3004,7 +3069,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b3b850")
+          (id "0xa972f50")
           (pos -2047.33 560.924)
           (parent "")
           (select-mask 1)
@@ -3015,7 +3080,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8db85f0")
+          (id "0xa970948")
           (pos -2080.6 782.737)
           (parent "")
           (select-mask 1)
@@ -3031,9 +3096,9 @@
       (locked #t)
       (objects
         (decal
-          (id "0x8b379f0")
+          (id "0xa674178")
           (pos -752 0)
-          (parent "0x8ae7da0")
+          (parent "0xa66ef38")
           (select-mask 1)
           (path "images/decal/train_front.png")
           (type 0)
@@ -3042,9 +3107,9 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8ae7978")
+          (id "0xa673190")
           (pos 696 0)
-          (parent "0x8ae7da0")
+          (parent "0xa66ef38")
           (select-mask 1)
           (path "images/decal/train_back.png")
           (type 0)
@@ -3053,7 +3118,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8ae7da0")
+          (id "0xa66ef38")
           (pos -2098.65 942.97)
           (parent "")
           (select-mask 1)
@@ -3064,9 +3129,9 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b3b1f0")
+          (id "0xa712640")
           (pos -586.991 241.125)
-          (parent "0x8ae7da0")
+          (parent "0xa66ef38")
           (select-mask 1)
           (path "images/decal/train_engine_front.png")
           (type 0)
@@ -3075,9 +3140,9 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b3b160")
+          (id "0xa718a60")
           (pos 593.009 242.125)
-          (parent "0x8ae7da0")
+          (parent "0xa66ef38")
           (select-mask 1)
           (path "images/decal/train_engine_back.png")
           (type 0)
@@ -3086,9 +3151,9 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b3ae50")
+          (id "0xa71d510")
           (pos -206.991 241.125)
-          (parent "0x8ae7da0")
+          (parent "0xa66ef38")
           (select-mask 1)
           (path "images/decal/train_engine_middle.png")
           (type 0)
@@ -3097,9 +3162,9 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8bf81c8")
+          (id "0xa86b468")
           (pos 249.009 241.125)
-          (parent "0x8ae7da0")
+          (parent "0xa66ef38")
           (select-mask 1)
           (path "images/decal/train_engine_middle.png")
           (type 0)
@@ -3108,9 +3173,9 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8bf8358")
+          (id "0xa86bc00")
           (pos 0.719482 -14.875)
-          (parent "0x8ae7da0")
+          (parent "0xa66ef38")
           (select-mask 1)
           (path "images/decal/train_door.png")
           (type 0)
@@ -3124,7 +3189,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0x8b37a50")
+          (id "0xa6712d0")
           (pos -402.054 1017.24)
           (parent "")
           (select-mask 1)
@@ -3135,7 +3200,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8ae96a0")
+          (id "0xa675290")
           (pos 161.91 1097.81)
           (parent "")
           (select-mask 1)
@@ -3146,7 +3211,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8ae85b0")
+          (id "0xa674648")
           (pos 860.719 704.086)
           (parent "")
           (select-mask 1)
@@ -3157,7 +3222,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8ae9530")
+          (id "0xa6748f8")
           (pos 208.559 708.054)
           (parent "")
           (select-mask 1)
@@ -3168,7 +3233,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8ae91b8")
+          (id "0xa673aa0")
           (pos -845.605 1035.11)
           (parent "")
           (select-mask 1)
@@ -3179,7 +3244,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8ae8668")
+          (id "0xa673930")
           (pos -332.91 1098.59)
           (parent "")
           (select-mask 1)
@@ -3190,7 +3255,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8ae8780")
+          (id "0xa673c70")
           (pos -1151.04 1059.27)
           (parent "")
           (select-mask 1)
@@ -3201,7 +3266,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8ae88c8")
+          (id "0xa673e00")
           (pos -1663.74 995.791)
           (parent "")
           (select-mask 1)
@@ -3212,7 +3277,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8ae8c78")
+          (id "0xa674510")
           (pos 943.16 1149.08)
           (parent "")
           (select-mask 1)
@@ -3228,7 +3293,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0x8b36c50")
+          (id "0xa671360")
           (pos 1630.08 1070.32)
           (parent "")
           (select-mask 1)
@@ -3239,7 +3304,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b36f80")
+          (id "0xa671430")
           (pos 983.756 904.953)
           (parent "")
           (select-mask 1)
@@ -3250,7 +3315,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b36d50")
+          (id "0xa6708d0")
           (pos 315.072 868.593)
           (parent "")
           (select-mask 1)
@@ -3261,7 +3326,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b375e8")
+          (id "0xa670b58")
           (pos -1636 909.933)
           (parent "")
           (select-mask 1)
@@ -3272,7 +3337,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b373e8")
+          (id "0xa670a88")
           (pos -810.844 849.183)
           (parent "")
           (select-mask 1)
@@ -3283,7 +3348,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b37b48")
+          (id "0xa6715c8")
           (pos 1559.83 804.374)
           (parent "")
           (select-mask 1)
@@ -3294,7 +3359,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b37c20")
+          (id "0xa6707d0")
           (pos -259.112 903.761)
           (parent "")
           (select-mask 1)
@@ -3305,7 +3370,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b377b0")
+          (id "0xa6705d0")
           (pos -477.046 760.753)
           (parent "")
           (select-mask 1)
@@ -3316,7 +3381,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b378b0")
+          (id "0xa670670")
           (pos -1553.29 729.292)
           (parent "")
           (select-mask 1)
@@ -3327,7 +3392,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8ae8ed0")
+          (id "0xa675158")
           (pos -1169.49 799.75)
           (parent "")
           (select-mask 1)
@@ -3343,7 +3408,7 @@
       (locked #t)
       (objects
         (decal
-          (id "0x8ae9e18")
+          (id "0xa6086b8")
           (pos -855.442 319.354)
           (parent "")
           (select-mask 1)
@@ -3354,7 +3419,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8aeaa08")
+          (id "0xa607238")
           (pos -1297.52 365.776)
           (parent "")
           (select-mask 1)
@@ -3365,7 +3430,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8ae71b0")
+          (id "0xa607e88")
           (pos -1402.7 340.058)
           (parent "")
           (select-mask 1)
@@ -3376,7 +3441,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8ae7390")
+          (id "0xa608058")
           (pos -1099.97 336.543)
           (parent "")
           (select-mask 1)
@@ -3387,7 +3452,7 @@
           (hflip #f)
           (vflip #f))
         (decal
-          (id "0x8b37df8")
+          (id "0xa66ba30")
           (pos -1569.48 329.078)
           (parent "")
           (select-mask 1)
@@ -3398,10 +3463,14 @@
           (hflip #f)
           (vflip #f))))
     (layer
+      (name "Snow")
+      (visible #t)
+      (locked #t)
+      (objects))
+    (layer
       (name "Trainstation")
       (visible #t)
       (locked #t)
-      (objects))
-))
+      (objects))))
 
 ;; EOF ;;



From grumbel at mail.berlios.de  Wed Sep 30 00:27:12 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 30 Sep 2009 00:27:12 +0200
Subject: [Windstille-commit] r3278 - trunk/windstille/src/editor
Message-ID: <200909292227.n8TMRC38025921@sheep.berlios.de>

Author: grumbel
Date: 2009-09-30 00:27:10 +0200 (Wed, 30 Sep 2009)
New Revision: 3278

Modified:
   trunk/windstille/src/editor/animation_widget.cpp
   trunk/windstille/src/editor/animation_widget.hpp
   trunk/windstille/src/editor/decal_object_model.cpp
   trunk/windstille/src/editor/decal_object_model.hpp
   trunk/windstille/src/editor/editor_window.cpp
   trunk/windstille/src/editor/editor_window.hpp
   trunk/windstille/src/editor/sector_model.cpp
   trunk/windstille/src/editor/timeline.cpp
   trunk/windstille/src/editor/timeline.hpp
   trunk/windstille/src/editor/timeline_anim_object.hpp
   trunk/windstille/src/editor/timeline_keyframe_object.hpp
   trunk/windstille/src/editor/timeline_layer.cpp
   trunk/windstille/src/editor/timeline_layer.hpp
   trunk/windstille/src/editor/timeline_layer_widget.cpp
   trunk/windstille/src/editor/timeline_layer_widget.hpp
   trunk/windstille/src/editor/timeline_object.hpp
   trunk/windstille/src/editor/timeline_object_layer.hpp
   trunk/windstille/src/editor/timeline_properties.hpp
   trunk/windstille/src/editor/timeline_sound_object.hpp
   trunk/windstille/src/editor/timeline_widget.cpp
   trunk/windstille/src/editor/timeline_widget.hpp
   trunk/windstille/src/editor/windstille_widget.cpp
Log:
Implemented save for the timeline

Modified: trunk/windstille/src/editor/animation_widget.cpp
===================================================================
--- trunk/windstille/src/editor/animation_widget.cpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/animation_widget.cpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -42,7 +42,10 @@
   hscroll(hadjustment),
   m_timeline_widget(),
   m_timeline_layer_widget(),
-  m_timeline()
+  m_timeline(),
+  m_timeout_connection(),
+  m_playing(false),
+  m_anim_pos(0.0f)
 {
   Glib::RefPtr<Gtk::UIManager>   ui_manager   = editor.get_ui_manager();
   Glib::RefPtr<Gtk::ActionGroup> action_group = Gtk::ActionGroup::create();
@@ -63,6 +66,18 @@
   action_group->add(Gtk::Action::create("FrameBackwardAnimation", Gtk::Stock::GO_BACK),
                     sigc::mem_fun(editor, &EditorWindow::on_animation_frame_backward));
 
+  action_group->add(Gtk::Action::create("AnimationZoomIn",  Gtk::Stock::ZOOM_IN),
+                    sigc::mem_fun(m_timeline_widget, &TimelineWidget::zoom_in));
+  action_group->add(Gtk::Action::create("AnimationZoomOut", Gtk::Stock::ZOOM_OUT),
+                    sigc::mem_fun(m_timeline_widget, &TimelineWidget::zoom_out));
+
+  action_group->add(Gtk::Action::create("AnimationForward", Gtk::Stock::MEDIA_FORWARD));
+  action_group->add(Gtk::Action::create("AnimationNext", Gtk::Stock::MEDIA_NEXT));
+  action_group->add(Gtk::Action::create("AnimationPrevious", Gtk::Stock::MEDIA_PREVIOUS));
+  action_group->add(Gtk::Action::create("AnimationRewind", Gtk::Stock::MEDIA_REWIND));
+  action_group->add(Gtk::Action::create("AnimationPlay", Gtk::Stock::MEDIA_PLAY),
+                    sigc::mem_fun(*this, &AnimationWidget::on_play));
+
   ui_manager->insert_action_group(action_group);
 
   ui_manager->add_ui_from_string("<ui>"
@@ -73,9 +88,19 @@
                                  "    <separator />"
                                  "    <toolitem action='NewLayerAnimation'/>"
                                  "    <separator />"
+                                 "    <toolitem action='AnimationZoomIn'/>"
+                                 "    <toolitem action='AnimationZoomOut'/>"
+                                 "    <separator />"
                                  "    <toolitem action='FrameBackwardAnimation'/>"
                                  "    <toolitem action='FrameForwardAnimation'/>"
                                  "    <separator />"
+                                 "    <toolitem action='AnimationPlay'/>"
+                                 "    <separator />"
+                                 "    <toolitem action='AnimationPrevious'/>"
+                                 "    <toolitem action='AnimationNext'/>"
+                                 "    <separator />"
+                                 "    <toolitem action='AnimationRewind'/>"
+                                 "    <toolitem action='AnimationForward'/>"
                                  "  </toolbar>"
                                  "</ui>");
   
@@ -105,6 +130,35 @@
 }
 
 void
+AnimationWidget::on_play()
+{
+  if (!m_playing)
+  {
+    std::cout << "Play" << std::endl;
+    m_playing = true;
+    m_anim_pos = 0.0f;
+    m_timeout_connection = Glib::signal_timeout().connect(sigc::mem_fun(*this, &AnimationWidget::on_timeout),
+                                                          50,
+                                                          Glib::PRIORITY_DEFAULT);
+  }
+  else
+  {
+    std::cout << "Stop" << std::endl;
+    m_playing = false;
+    m_timeout_connection.disconnect();
+  }
+}
+
+bool
+AnimationWidget::on_timeout()
+{
+  m_anim_pos += 0.5f;
+  m_timeline->apply(m_anim_pos);
+  EditorWindow::current()->queue_draw();
+  return true;
+}
+
+void
 AnimationWidget::set_timeline(TimelineHandle timeline)
 {
   m_timeline = timeline;
@@ -112,59 +166,4 @@
   m_timeline_layer_widget.set_timeline(timeline);
 }
 
-#ifdef __TEST__
-
-#include <gtkmm/main.h>
-#include <gtkmm/window.h>
-#include <gtkmm/liststore.h>
-#include <gtkmm/treeview.h>
-#include <gtkmm/box.h>
-#include <gtkmm/adjustment.h>
-#include <gtkmm/table.h>
-#include <gtkmm/ruler.h>
-#include <gtkmm/scrollbar.h>
-
-int main(int argc, char** argv)
-{
-  Gtk::Main kit(argc, argv);
-
-  // create test timeline  
-  boost::shared_ptr<Timeline> timeline(new Timeline());
-
-  TimelineLayerHandle layer1 = timeline->add_layer("DoorLeft:pos");
-  TimelineLayerHandle layer2 = timeline->add_layer("DoorRight:pos");
-  TimelineLayerHandle layer3 = timeline->add_layer("AnimaitonLayer1");
-  TimelineLayerHandle layer4 = timeline->add_layer("SoundLayer2");
-
-  layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(20.0f, 30.0f, "anim1.anim")));
-  layer1->add_object(TimelineObjectHandle(new TimelineAnimObject(60.0f, 30.0f, "anim2.anim")));
-
-  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(8.0f)));
-  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(10.0f)));
-  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(11.0f)));
-  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(15.0f)));
-  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(20.0f)));
-  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(35.0f)));
-  layer2->add_object(TimelineObjectHandle(new TimelineKeyframeObject(40.0f)));
-
-  layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(10.0f, 10.0f, "sound1.wav")));
-  layer3->add_object(TimelineObjectHandle(new TimelineSoundObject(30.0f, 40.0f, "sound.wav")));
-
-  // create the window
-  Gtk::Window win;
-  win.set_title("Timeline Test");
-  win.set_default_size(800, 400);
-
-  AnimationWidget animation_widget();
-  animation_widget.set_timeline(timeline);
-  win.add(animation_widget);
-  win.show_all();
-
-  Gtk::Main::run(win);
-
-  return 0;
-}
-
-#endif
-
 /* EOF */

Modified: trunk/windstille/src/editor/animation_widget.hpp
===================================================================
--- trunk/windstille/src/editor/animation_widget.hpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/animation_widget.hpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -54,12 +54,17 @@
   TimelineLayerWidget  m_timeline_layer_widget;
 
   TimelineHandle m_timeline;
+  sigc::connection m_timeout_connection;
+  bool m_playing;
+  float m_anim_pos;
 
 public:
   AnimationWidget(EditorWindow& editor);
 
   void set_timeline(TimelineHandle timeline);
   TimelineWidget& get_timeline_widget() { return m_timeline_widget; }
+  void on_play();
+  bool on_timeout();
 
 private:
   AnimationWidget(const AnimationWidget&);

Modified: trunk/windstille/src/editor/decal_object_model.cpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.cpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/decal_object_model.cpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -326,6 +326,66 @@
 }
 
 void
+DecalObjectModel::get_property(TimelineProperty property, float& value_out) const
+{
+  switch(property)
+  {
+    case kRotation:
+      value_out = get_angle();
+      break;
+
+    default:
+      ObjectModel::get_property(property, value_out);
+      break;
+  }
+}
+
+void
+DecalObjectModel::get_property(TimelineProperty property, Vector2f& value_out) const
+{
+  switch(property)
+  {
+    case kScale:
+      value_out = get_scale();
+      break;
+
+    default:
+      ObjectModel::get_property(property, value_out);
+      break;
+  }
+}
+
+void
+DecalObjectModel::set_property(TimelineProperty property, float value)
+{
+  switch(property)
+  {
+    case kRotation:
+      set_angle(value);
+      break;
+
+    default:
+      ObjectModel::set_property(property, value);
+      break;
+  }
+}
+
+void
+DecalObjectModel::set_property(TimelineProperty property, const Vector2f& value)
+{
+  switch(property)
+  {
+    case kScale:
+      set_scale(value);
+      break;
+
+    default:
+      ObjectModel::set_property(property, value);
+      break;
+  }
+}
+
+void
 DecalObjectModel::set_world_pos(const Vector2f& p)
 {
   ObjectModel::set_world_pos(p);

Modified: trunk/windstille/src/editor/decal_object_model.hpp
===================================================================
--- trunk/windstille/src/editor/decal_object_model.hpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/decal_object_model.hpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -90,6 +90,12 @@
   void set_world_pos(const Vector2f& p);
   void set_rel_pos(const Vector2f& rel_pos_);
   void set_select_mask(const SelectMask& select_mask_);
+
+  void get_property(TimelineProperty property, float& value_out) const;
+  void get_property(TimelineProperty property, Vector2f& value_out) const;
+  
+  void set_property(TimelineProperty property, float value);
+  void set_property(TimelineProperty property, const Vector2f& value);
 };
 
 #endif

Modified: trunk/windstille/src/editor/editor_window.cpp
===================================================================
--- trunk/windstille/src/editor/editor_window.cpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/editor_window.cpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -495,10 +495,13 @@
   {
     on_new();
     WindstilleWidget* wst = get_windstille_widget();
+    AnimationWidget*  animation_widget = get_animation_widget();
+      
     wst->load_file(filename);
     wst->set_filename(filename);
     notebook.set_tab_label_text(*notebook.get_nth_page(notebook.get_current_page()), Glib::path_get_basename(filename));
     layer_manager.set_model(&wst->get_document().get_sector_model());
+    animation_widget->set_timeline(wst->get_document().get_sector_model().get_timeline());
     print("Loaded: " + filename);
   }
   catch(std::exception& err)
@@ -564,13 +567,8 @@
 void
 EditorWindow::on_save_as()
 {
-  int page = notebook.get_current_page();
-  if (page == -1)
+  if (WindstilleWidget* wst = get_windstille_widget())
   {
-    // do nothing;
-  }
-  else
-  {
     Gtk::FileChooserDialog dialog("Save File",
                                   Gtk::FILE_CHOOSER_ACTION_SAVE);
     dialog.set_transient_for(*this);
@@ -579,8 +577,6 @@
     dialog.add_button(Gtk::Stock::CANCEL, Gtk::RESPONSE_CANCEL);
     dialog.add_button(Gtk::Stock::SAVE,   Gtk::RESPONSE_OK);
 
-    WindstilleWidget* wst = static_cast<WindstilleWidget*>(notebook.get_nth_page(page));
- 
     if (wst->get_filename().empty())
       dialog.set_current_folder("data/sectors/");
     else
@@ -601,6 +597,7 @@
         wst->get_document().get_sector_model().write(writer);
         wst->set_filename(filename);
 
+        int page = notebook.get_current_page();
         notebook.set_tab_label_text(*notebook.get_nth_page(page), Glib::path_get_basename(filename));
         add_recent_file(filename);
         print("Wrote: " + filename);
@@ -788,7 +785,7 @@
 }
 
 void
-EditorWindow::on_animation_add_keyframe()
+EditorWindow::on_animation_add_keyframe(TimelineProperty property)
 {
   std::cout << "EditorWindow::on_animation_add_keyframe()" << std::endl;
   if (Document* document = get_document())
@@ -800,7 +797,7 @@
       SelectionHandle selection = document->get_selection();
       for(Selection::iterator i = selection->begin(); i != selection->end(); ++i)
       {
-        document->timeline_add_keyframe(*i, kPosition, timeline_widget->get_cursor_pos());
+        document->timeline_add_keyframe(*i, property, timeline_widget->get_cursor_pos());
       }
       queue_draw();
     }
@@ -898,6 +895,27 @@
   }
 }
 
+AnimationWidget*
+EditorWindow::get_animation_widget()
+{
+  int page = notebook.get_current_page();
+  if (page == -1)
+  {
+    return 0;
+  }
+  else
+  {
+    if (Gtk::VPaned* paned = dynamic_cast<Gtk::VPaned*>(notebook.get_nth_page(page)))
+    {
+      return dynamic_cast<AnimationWidget*>(paned->get_child2());
+    }
+    else
+    {
+      return 0;
+    }
+  }
+}
+
 Document*
 EditorWindow::get_document()
 {

Modified: trunk/windstille/src/editor/editor_window.hpp
===================================================================
--- trunk/windstille/src/editor/editor_window.hpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/editor_window.hpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -36,6 +36,7 @@
 #include "editor/layer_manager.hpp"
 #include "editor/document.hpp"
 
+class AnimationWidget;
 class Document;
 class LayerWidget;
 class NavgraphInsertTool;
@@ -147,7 +148,7 @@
 
   void on_animation_layer_new();
 
-  void on_animation_add_keyframe();
+  void on_animation_add_keyframe(TimelineProperty property);
   /** @} */
 
   void toggle_render_layer(Glib::RefPtr<Gtk::ToggleAction> action, unsigned int mask);
@@ -165,6 +166,7 @@
   LayerManager& get_layer_manager() { return layer_manager; }
   WindstilleWidget* get_windstille_widget();
   TimelineWidget*   get_timeline_widget();
+  AnimationWidget*   get_animation_widget();
   Document* get_document();
   
   void load_file(const std::string& filename);

Modified: trunk/windstille/src/editor/sector_model.cpp
===================================================================
--- trunk/windstille/src/editor/sector_model.cpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/sector_model.cpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -364,6 +364,10 @@
   writer.write("ambient-color", ambient_color);
   writer.write("init-script", "init.nut");
 
+  writer.start_section("timeline");
+  m_timeline->write(writer);
+  writer.end_section();
+
   writer.start_section("navigation");
   nav_graph->write(writer);
   writer.end_section();

Modified: trunk/windstille/src/editor/timeline.cpp
===================================================================
--- trunk/windstille/src/editor/timeline.cpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/timeline.cpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -62,6 +62,12 @@
     case kPosition:
       return TimelineObjectLayerHandle(new TimelineObjectDataLayer<Vector2f>(object, property));
       
+    case kRotation:
+      return TimelineObjectLayerHandle(new TimelineObjectDataLayer<float>(object, property));
+
+    case kScale:
+      return TimelineObjectLayerHandle(new TimelineObjectDataLayer<Vector2f>(object, property));
+      
     default:
       throw std::runtime_error("Timeline::create_object_layer: unknown property given");
   }
@@ -105,4 +111,15 @@
   }  
 }
 
+void
+Timeline::write(FileWriter& writer) const
+{
+  writer.start_section("layers");
+  for(const_iterator i = begin(); i != end(); ++i)
+  {
+    (*i)->write(writer);
+  }  
+  writer.end_section();
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/timeline.hpp
===================================================================
--- trunk/windstille/src/editor/timeline.hpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/timeline.hpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -24,6 +24,7 @@
 #include "editor/object_model.hpp"
 
 class Vector2f;
+class FileWriter;
 
 class Timeline
 {
@@ -58,6 +59,8 @@
 
   void apply(float pos);
 
+  void write(FileWriter& writer) const;
+
 private:
   Timeline(const Timeline&);
   Timeline& operator=(const Timeline&);

Modified: trunk/windstille/src/editor/timeline_anim_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_anim_object.hpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/timeline_anim_object.hpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -41,6 +41,13 @@
   void  set_pos(float pos) { m_pos = pos; }
   float get_width() const { return m_width; }
   std::string get_name() const { return m_name; }
+  void write(FileWriter& writer) const 
+  {
+    writer.start_section("animation");
+    writer.write("pos",  m_pos);
+    writer.write("name", m_name);
+    writer.end_section();
+  }
 
 private:
   TimelineAnimObject(const TimelineAnimObject&);

Modified: trunk/windstille/src/editor/timeline_keyframe_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_keyframe_object.hpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/timeline_keyframe_object.hpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -21,6 +21,8 @@
 
 #include "editor/timeline_object.hpp"
 
+#include "util/file_writer.hpp"
+
 class TimelineKeyframeObject : public TimelineObject
 {
 protected:
@@ -54,6 +56,13 @@
 
   const C& get_data() const { return m_data; }
   void     set_data(const C& data) { m_data = data; }
+  void write(FileWriter& writer) const 
+  {
+    writer.start_section("keyframe");
+    writer.write("pos",  m_pos);
+    writer.write("data", m_data);
+    writer.end_section();
+  }
 
 private:
   TimelineKeyframeDataObject(const TimelineKeyframeDataObject&);

Modified: trunk/windstille/src/editor/timeline_layer.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer.cpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/timeline_layer.cpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -20,6 +20,7 @@
 
 #include <assert.h>
 
+#include "util/file_writer.hpp"
 #include "editor/timeline_object.hpp"
 
 TimelineLayer::TimelineLayer(const std::string& name)
@@ -74,4 +75,17 @@
   return objects;
 }
 
+void
+TimelineLayer::write(FileWriter& writer) const
+{
+  writer.start_section("layer");
+  writer.start_section("objects");
+  for(const_iterator i = begin(); i != end(); ++i)
+  {
+    (*i)->write(writer);
+  }
+  writer.end_section();
+  writer.end_section();
+}
+
 /* EOF */

Modified: trunk/windstille/src/editor/timeline_layer.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer.hpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/timeline_layer.hpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -25,6 +25,8 @@
 
 #include "timeline_handles.hpp"
 
+class FileWriter;
+
 class TimelineLayer
 {
 public:
@@ -59,6 +61,8 @@
   std::string get_name() const { return m_name; }
   virtual void apply(float pos) {}
 
+  virtual void write(FileWriter& writer) const;
+
 private:
   TimelineLayer(const TimelineLayer&);
   TimelineLayer& operator=(const TimelineLayer&);

Modified: trunk/windstille/src/editor/timeline_layer_widget.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer_widget.cpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/timeline_layer_widget.cpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -21,7 +21,8 @@
 #include "timeline_layer.hpp"
 
 TimelineLayerWidget::TimelineLayerWidget() :
-  m_timeline()
+  m_timeline(),
+  m_column_height(32)
 {
 }
 
@@ -57,19 +58,19 @@
       cr->get_text_extents((*i)->get_name(), extents);
 
       cr->set_source_rgb(1,1,1);
-      cr->rectangle(0, 32 * (i - m_timeline->begin()),
-                    allocation.get_width(), 32);
+      cr->rectangle(0, m_column_height * (i - m_timeline->begin()),
+                    allocation.get_width(), m_column_height);
       cr->fill();
 
       // draw text
       cr->set_source_rgb(0,0,0);
-      cr->move_to(8, 10 + 32 * (i - m_timeline->begin()) - extents.y_bearing);
+      cr->move_to(8, 10 + m_column_height * (i - m_timeline->begin()) - extents.y_bearing);
       cr->show_text((*i)->get_name());
 
       // draw line
       cr->set_source_rgb(0,0,0);
-      cr->move_to(0, 32 + 32 * (i - m_timeline->begin()));
-      cr->line_to(allocation.get_width(), 32+ 32 * (i - m_timeline->begin()));
+      cr->move_to(0, m_column_height + m_column_height * (i - m_timeline->begin()));
+      cr->line_to(allocation.get_width(), m_column_height+ m_column_height * (i - m_timeline->begin()));
       cr->stroke();
     }
   }

Modified: trunk/windstille/src/editor/timeline_layer_widget.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_layer_widget.hpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/timeline_layer_widget.hpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -27,6 +27,7 @@
 {
 private:
   TimelineHandle m_timeline;
+  int m_column_height;
 
 public:
   TimelineLayerWidget();

Modified: trunk/windstille/src/editor/timeline_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_object.hpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/timeline_object.hpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -32,6 +32,8 @@
   virtual float get_width() const =0;
   virtual void  set_pos(float pos) =0;
 
+  virtual void write(FileWriter& writer) const =0;
+
 private:
   TimelineObject(const TimelineObject&);
   TimelineObject& operator=(const TimelineObject&);

Modified: trunk/windstille/src/editor/timeline_object_layer.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_object_layer.hpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/timeline_object_layer.hpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -40,6 +40,20 @@
   TimelineProperty  get_property() const { return m_property; }
   ObjectModelHandle get_object()   const { return m_object; }
 
+  virtual void write(FileWriter& writer) const
+  {
+    writer.start_section("object-layer");
+    writer.write("object",   m_object->get_id());
+    writer.write("property", m_property); // FIXME: convert property to string
+    writer.start_section("objects");
+    for(const_iterator i = begin(); i != end(); ++i)
+    {
+      (*i)->write(writer);
+    }
+    writer.end_section();
+    writer.end_section();
+  }
+
 private:
   TimelineObjectLayer(const TimelineObjectLayer&);
   TimelineObjectLayer& operator=(const TimelineObjectLayer&);

Modified: trunk/windstille/src/editor/timeline_properties.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_properties.hpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/timeline_properties.hpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -21,10 +21,10 @@
 
 enum TimelineProperty
 {
-  kPosition,
-  kColor,
-  kRotation,
-  kScale
+  kPosition, // Vector2f
+  kColor,    // Color
+  kRotation, // float
+  kScale     // Vector2f
 };
 
 #endif

Modified: trunk/windstille/src/editor/timeline_sound_object.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_sound_object.hpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/timeline_sound_object.hpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -40,6 +40,14 @@
   float get_width() const { return m_width; }
   std::string get_name() const { return m_name; }
 
+  void write(FileWriter& writer) const 
+  {
+    writer.start_section("sound");
+    writer.write("pos",  m_pos);
+    writer.write("name", m_name);
+    writer.end_section();
+  }
+
 private:
   TimelineSoundObject(const TimelineSoundObject&);
   TimelineSoundObject& operator=(const TimelineSoundObject&);

Modified: trunk/windstille/src/editor/timeline_widget.cpp
===================================================================
--- trunk/windstille/src/editor/timeline_widget.cpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/timeline_widget.cpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -36,7 +36,9 @@
   m_mode(kNoMode),
   down_pos(),
   move_pos(),
-  m_cursor_pos(0.0f)
+  m_cursor_pos(0.0f),
+  m_column_width(8),
+  m_column_height(32)
 {
   signal_button_release_event().connect(sigc::mem_fun(this, &TimelineWidget::mouse_up));
   signal_button_press_event().connect(sigc::mem_fun(this, &TimelineWidget::mouse_down));
@@ -61,10 +63,10 @@
     move_pos.x = static_cast<float>(ev->x);
     move_pos.y = static_cast<float>(ev->y);
 
-    TimelineLayerHandle layer = m_timeline->get_layer(static_cast<int>(ev->y / 32));
+    TimelineLayerHandle layer = m_timeline->get_layer(static_cast<int>(ev->y / m_column_height));
     if (layer)
     {
-      TimelineObjectHandle obj = layer->get_object(static_cast<float>(ev->x / 8));
+      TimelineObjectHandle obj = layer->get_object(static_cast<float>(ev->x / m_column_width));
       if (obj)
       {
         m_mode = kDragMode;
@@ -98,7 +100,7 @@
   }
   else if (ev->button == 3)
   { // set cursor
-    set_cursor_pos(floorf(static_cast<float>(ev->x / 8)));
+    set_cursor_pos(floorf(static_cast<float>(ev->x / m_column_width)));
     m_mode = kCursorSetMode;
     queue_draw();
   }
@@ -128,7 +130,7 @@
       for (std::set<TimelineObjectHandle>::iterator i = m_selection.begin(); 
            i != m_selection.end(); ++i)
       {
-        (*i)->set_pos((*i)->get_pos() + (move_pos.x - down_pos.x)/8);
+        (*i)->set_pos((*i)->get_pos() + (move_pos.x - down_pos.x)/m_column_width);
       }
     }
     queue_draw();
@@ -159,7 +161,7 @@
   }
   else if (m_mode == kCursorSetMode)
   {
-    set_cursor_pos(floorf(static_cast<float>(ev->x / 8)));
+    set_cursor_pos(floorf(static_cast<float>(ev->x / m_column_width)));
     queue_draw();
   }
 
@@ -169,12 +171,14 @@
 void
 TimelineWidget::add_to_selection(const Rectf& selection)
 {
-  Timeline::iterator start = m_timeline->begin() + std::max(0, std::min(m_timeline->size(), static_cast<int>((selection.top+16)    / 32)));
-  Timeline::iterator end   = m_timeline->begin() + std::max(0, std::min(m_timeline->size(), static_cast<int>((selection.bottom+16) / 32)));
+  Timeline::iterator start = m_timeline->begin() + 
+    std::max(0, std::min(m_timeline->size(), static_cast<int>((selection.top + m_column_height/2)    / m_column_height)));
+  Timeline::iterator end   = m_timeline->begin() + 
+    std::max(0, std::min(m_timeline->size(), static_cast<int>((selection.bottom + m_column_height/2) / m_column_height)));
 
   for(Timeline::iterator i = start; i != end; ++i)
   {
-    const TimelineLayer::Objects& objects = (*i)->get_objects(selection.left / 8.0f, selection.right / 8.0f);
+    const TimelineLayer::Objects& objects = (*i)->get_objects(selection.left / m_column_width, selection.right / m_column_width);
     m_selection.insert(objects.begin(), objects.end());
   }
 }
@@ -240,15 +244,15 @@
 
   cr->save();
   
-  int height = m_timeline->size() * 32;
+  int height = m_timeline->size() * m_column_height;
 
   // draw vertical lines
   cr->set_source_rgb(0.875, 0.875, 0.875);
-  for(int x = 0; x < allocation.get_width(); x += 8)
+  for(int x = 0; x < allocation.get_width(); x += m_column_width)
   {
-    if (x % 80 == 0)
+    if (x % (m_column_width * 10) == 0)
     {
-      cr->rectangle(x, 0, 8, height);
+      cr->rectangle(x, 0, m_column_width, height);
     }
   }
   cr->fill();
@@ -257,7 +261,7 @@
 
   // draw horizontal lines
   cr->set_source_rgb(0.5, 0.5, 0.5);
-  for(int y = 0; y <= height; y += 32)
+  for(int y = 0; y <= height; y += m_column_height)
   {
     cr->move_to(0, y);
     cr->line_to(allocation.get_width(), y);
@@ -266,7 +270,7 @@
 
   // draw vertical lines
   cr->set_source_rgb(0.75, 0.75, 0.75);
-  for(int x = 0; x < allocation.get_width(); x += 8)
+  for(int x = 0; x < allocation.get_width(); x += m_column_width)
   {
     cr->move_to(x, 0);
     cr->line_to(x, height);
@@ -284,7 +288,7 @@
   cr->save();
 
   cr->set_source_rgb(1,1,1);
-  cr->rectangle(0, 0, allocation.get_width(), 32 * m_timeline->size());
+  cr->rectangle(0, 0, allocation.get_width(), m_column_height * m_timeline->size());
   cr->fill();
   
   draw_grid(cr);
@@ -293,12 +297,12 @@
   for(Timeline::iterator i = m_timeline->begin(); i != m_timeline->end(); ++i)
   {
     draw_timeline_layer(cr, *i);
-    cr->translate(0, 32);
+    cr->translate(0, m_column_height);
   }
   cr->restore();
 
-  cr->rectangle(m_cursor_pos * 8, 0,
-                8, m_timeline->size() * 32);
+  cr->rectangle(m_cursor_pos * m_column_width, 0,
+                m_column_width, m_timeline->size() * m_column_height);
   cr->set_source_rgba(1,1,0,0.5);
   cr->fill_preserve();
   cr->set_line_width(1.0f);
@@ -336,7 +340,7 @@
         cr->set_source_rgb(0.5, 0.75, 0.0);
       }
       
-      cr->rectangle(keyframe->get_pos()*8, 4, 8, 24);
+      cr->rectangle(keyframe->get_pos() * m_column_width, 4, m_column_width, m_column_height - 8);
       cr->fill();
 
       if (in_selection)
@@ -344,7 +348,7 @@
       else
         cr->set_source_rgb(0, 0, 0);
 
-      cr->rectangle(keyframe->get_pos()*8, 4, 8, 24);
+      cr->rectangle(keyframe->get_pos() * m_column_width, 4, m_column_width, m_column_height - 8);
       cr->stroke();  
       
       cr->restore();
@@ -381,8 +385,8 @@
         cr->set_source_rgb(0.0, 0.5, 0.75);
       }
 
-      cr->rectangle(anim->get_pos()*8,  4,
-                    anim->get_width()*8, 24);
+      cr->rectangle(anim->get_pos()   * m_column_width,  4,
+                    anim->get_width() * m_column_width, m_column_height - 8);
       cr->fill();
 
       if (in_selection)
@@ -394,13 +398,13 @@
         cr->set_source_rgb(0, 0, 0);
       }
 
-      cr->rectangle(anim->get_pos()*8, 4,
-                    anim->get_width()*8, 24);
+      cr->rectangle(anim->get_pos()   * m_column_width, 4,
+                    anim->get_width() * m_column_width, m_column_height - 8);
       cr->stroke();
 
       cr->set_source_rgb(1,1,1);
-      cr->move_to((anim->get_pos() + anim->get_width()/2)*8 - extents.width/2, 
-                  20);
+      cr->move_to((anim->get_pos() + anim->get_width()/2) * m_column_width - extents.width/2, 
+                  m_column_height / 2 + 4);
       cr->show_text(anim->get_name());
 
       cr->restore();
@@ -430,6 +434,7 @@
       {
         if (m_mode == kDragMode)
           cr->translate(move_pos.x - down_pos.x, 0.0);
+
         cr->set_source_rgb(1.0, 0.0, 0.75);
       }
       else
@@ -437,18 +442,18 @@
         cr->set_source_rgb(0.75, 0.0, 0.5);
       }
 
-      cr->rectangle(sound->get_pos()*8,  4,
-                    sound->get_width()*8, 24);
+      cr->rectangle(sound->get_pos()   * m_column_width,  4,
+                    sound->get_width() * m_column_width, m_column_height - 8);
       cr->fill();
 
       cr->set_source_rgb(0, 0, 0);
-      cr->rectangle(sound->get_pos()*8, 4,
-                    sound->get_width()*8, 24);
+      cr->rectangle(sound->get_pos()   * m_column_width, 4,
+                    sound->get_width() * m_column_width, m_column_height - 8);
       cr->stroke();
 
-      cr->set_source_rgb(1,1,1);
-      cr->move_to((sound->get_pos() + sound->get_width()/2)*8 - extents.width/2, 
-                  20);
+      cr->set_source_rgb(1,1,0);
+      cr->move_to((sound->get_pos() + sound->get_width()/2) * m_column_width - extents.width/2, 
+                  m_column_height / 2 + 4);
       cr->show_text(sound->get_name());
 
       cr->restore();
@@ -465,6 +470,23 @@
 }
 
 void
+TimelineWidget::zoom_in()
+{
+  m_column_width += 1;
+  queue_draw();
+}
+
+void
+TimelineWidget::zoom_out()
+{
+  if (m_column_width > 2)
+  {
+    m_column_width -= 1;
+    queue_draw();
+  }
+}
+
+void
 TimelineWidget::set_timeline(boost::shared_ptr<Timeline> timeline)
 {
   m_timeline = timeline;

Modified: trunk/windstille/src/editor/timeline_widget.hpp
===================================================================
--- trunk/windstille/src/editor/timeline_widget.hpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/timeline_widget.hpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -46,7 +46,9 @@
   Vector2f move_pos;
 
   float m_cursor_pos;
-
+  int m_column_width;
+  int m_column_height;
+  
 public:
   TimelineWidget();
   ~TimelineWidget();
@@ -62,6 +64,9 @@
 
   void delete_selection();
 
+  void zoom_in();
+  void zoom_out();
+
 protected:
   //Override default signal handler:
   virtual bool on_expose_event(GdkEventExpose* event);

Modified: trunk/windstille/src/editor/windstille_widget.cpp
===================================================================
--- trunk/windstille/src/editor/windstille_widget.cpp	2009-09-29 16:49:10 UTC (rev 3277)
+++ trunk/windstille/src/editor/windstille_widget.cpp	2009-09-29 22:27:10 UTC (rev 3278)
@@ -408,8 +408,19 @@
       break;
 
     case GDK_i:
-      EditorWindow::current()->on_animation_add_keyframe();
+      std::cout << "Position Keyframe" << std::endl;
+      EditorWindow::current()->on_animation_add_keyframe(kPosition);
       break;
+
+    case GDK_k:
+      std::cout << "Position Scale" << std::endl;
+      EditorWindow::current()->on_animation_add_keyframe(kScale);
+      break;
+
+    case GDK_u:
+      std::cout << "Position Rotation" << std::endl;
+      EditorWindow::current()->on_animation_add_keyframe(kRotation);
+      break;
       
     case GDK_d:
       m_document->selection_duplicate();



From grumbel at mail.berlios.de  Wed Sep 30 00:46:18 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 30 Sep 2009 00:46:18 +0200
Subject: [Windstille-commit] r3279 - trunk/windstille
Message-ID: <200909292246.n8TMkIQM007651@sheep.berlios.de>

Author: grumbel
Date: 2009-09-30 00:46:17 +0200 (Wed, 30 Sep 2009)
New Revision: 3279

Modified:
   trunk/windstille/CODINGSTYLE
Log:
added node about m_ prefix

Modified: trunk/windstille/CODINGSTYLE
===================================================================
--- trunk/windstille/CODINGSTYLE	2009-09-29 22:27:10 UTC (rev 3278)
+++ trunk/windstille/CODINGSTYLE	2009-09-29 22:46:17 UTC (rev 3279)
@@ -39,6 +39,8 @@
 
 * g_ prefix for global variables
 
+* m_ prefix for member variables
+
 * class names are CamelCase
 
 * variables are lower_case



From grumbel at mail.berlios.de  Wed Sep 30 00:46:33 2009
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 30 Sep 2009 00:46:33 +0200
Subject: [Windstille-commit] r3280 - trunk/windstille
Message-ID: <200909292246.n8TMkXdu007695@sheep.berlios.de>

Author: grumbel
Date: 2009-09-30 00:46:33 +0200 (Wed, 30 Sep 2009)
New Revision: 3280

Modified:
   trunk/windstille/SConscript
Log:
Test hack is no longer needed

Modified: trunk/windstille/SConscript
===================================================================
--- trunk/windstille/SConscript	2009-09-29 22:46:17 UTC (rev 3279)
+++ trunk/windstille/SConscript	2009-09-29 22:46:33 UTC (rev 3280)
@@ -326,6 +326,12 @@
 
         editor_env.Program('windstille-editor', Glob('src/editor/*.cpp'))
 
+        # FIXME: temporary dirty hack
+        # test_editor_env = editor_env.Clone(OBJPREFIX="test_")
+        # test_editor_env.Append(CPPDEFINES=["__TEST__"])
+        # test_editor_env.Program('test_animation_widget',
+        #                        [f for f in Glob('src/editor/*.cpp') if f.get_path() != "src/editor/main.cpp"])
+
     def build_testapps(self):
         env = self.env.Clone()
         env.Append(OBJPREFIX="test__",



