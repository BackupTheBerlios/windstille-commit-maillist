<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Windstille-commit] r1090 - in trunk: data/3dsprites docs src src/collision src/display src/gui src/input src/math src/sprite3d tools
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/windstille-commit/2005-September/index.html" >
   <LINK REL="made" HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r1090%20-%20in%20trunk%3A%20data/3dsprites%20docs%20src%20src/collision%20src/display%20src/gui%20src/input%20src/math%20src/sprite3d%20tools&In-Reply-To=%3C200509221107.j8MB7D9S003070%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000746.html">
   <LINK REL="Next"  HREF="000748.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Windstille-commit] r1090 - in trunk: data/3dsprites docs src src/collision src/display src/gui src/input src/math src/sprite3d tools</H1>
    <B>Matthias Braun at BerliOS</B> 
    <A HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r1090%20-%20in%20trunk%3A%20data/3dsprites%20docs%20src%20src/collision%20src/display%20src/gui%20src/input%20src/math%20src/sprite3d%20tools&In-Reply-To=%3C200509221107.j8MB7D9S003070%40sheep.berlios.de%3E"
       TITLE="[Windstille-commit] r1090 - in trunk: data/3dsprites docs src src/collision src/display src/gui src/input src/math src/sprite3d tools">matzebraun at berlios.de
       </A><BR>
    <I>Thu Sep 22 13:07:13 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000746.html">[Windstille-commit] r1089 - trunk/data/images/objects
</A></li>
        <LI>Next message: <A HREF="000748.html">[Windstille-commit] r1091 - in trunk/data/models: . objects objects/pistol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#747">[ date ]</a>
              <a href="thread.html#747">[ thread ]</a>
              <a href="subject.html#747">[ subject ]</a>
              <a href="author.html#747">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: matzebraun
Date: 2005-09-22 13:06:50 +0200 (Thu, 22 Sep 2005)
New Revision: 1090

Added:
   trunk/src/math/quaternion.cpp
   trunk/src/math/quaternion.hpp
   trunk/src/math/vector3.hpp
   trunk/src/pistol.cpp
   trunk/src/pistol.hpp
   trunk/src/weapon.hpp
Modified:
   trunk/data/3dsprites/heroken.wsprite
   trunk/docs/models.txt
   trunk/docs/wsprite_fileformat.txt
   trunk/src/Jamfile
   trunk/src/collision/stair_contact.cpp
   trunk/src/controller_help_window.cpp
   trunk/src/display/display.cpp
   trunk/src/display/drawing_context.cpp
   trunk/src/display/drawing_context.hpp
   trunk/src/display/scene_context.cpp
   trunk/src/display/scene_context.hpp
   trunk/src/energy_bar.cpp
   trunk/src/game_object.hpp
   trunk/src/game_session.cpp
   trunk/src/gui/button.cpp
   trunk/src/gui/list_view.cpp
   trunk/src/gui/tab_component.cpp
   trunk/src/input/input_configurator.cpp
   trunk/src/laser_pointer.cpp
   trunk/src/laser_pointer.hpp
   trunk/src/math/Jamfile
   trunk/src/math/vector.cpp
   trunk/src/math/vector.hpp
   trunk/src/physics.cpp
   trunk/src/player.cpp
   trunk/src/player.hpp
   trunk/src/screen_manager.cpp
   trunk/src/sprite3d/data.cpp
   trunk/src/sprite3d/data.hpp
   trunk/src/sprite3d/sprite3d.cpp
   trunk/tools/windstille_export.py
Log:
- Fixed exporter to export attachement-points correctly
- Fixed coordinate system inconsistencies in exporter and windstille
- added a new quaternion class that does slerp correctly now
- added a weapon class and tried to attach a pistol to the hero,
    works in principle but the rotation is 180degrees of for some reason...



Modified: trunk/data/3dsprites/heroken.wsprite
===================================================================
(Binary files differ)

Modified: trunk/docs/models.txt
===================================================================
--- trunk/docs/models.txt	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/docs/models.txt	2005-09-22 11:06:50 UTC (rev 1090)
@@ -10,20 +10,15 @@
 - When looking at a character turned left from the side, coordinate axes are:
     z -&gt; up
     y -&gt; right
-    x -&gt; back
+    x -&gt; front
   (the exporter will convert these to windstille coordinates which are
    x-&gt;right, y -&gt; down, z -&gt; back)
-- Each blender object should use exactly 1 texture on all it's faces.
+- Each blender object should use the same texture on all it's faces.
+   (you can have multiple objects per model of course)
 - You should animate your models with armatures. The exporter will grab all
   defined actions for the armature and export these. You are only allowed to
-  have 1 armature object in the scene at the moment (but this armature can have
-  multiple bones of course)
-- Only for information you don't have to care about this: UVs in blender are
-    u -&gt; right
-    v -&gt; up
-  UVs in windstille are
-    u -&gt; right
-    v -&gt; down
+  have 1 armature object in the scene at the moment
+- Empty Objects whose names start with A: are exported as attachement points
 - Take a look at the console output to see warnings and errors from the script
 - You should specify additional attributes for the actions by creating a blender
   textobject with name &quot;actionconfig&quot;. You can then specify lines like this
@@ -52,3 +47,10 @@
 
     So you can easily zoom in and watch your animation in slow motion with
     these keys.
+
+(- Only for information you don't have to care about this: UVs in blender are
+    u -&gt; right
+    v -&gt; up
+  UVs in windstille are
+    u -&gt; right
+    v -&gt; down)

Modified: trunk/docs/wsprite_fileformat.txt
===================================================================
--- trunk/docs/wsprite_fileformat.txt	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/docs/wsprite_fileformat.txt	2005-09-22 11:06:50 UTC (rev 1090)
@@ -1,39 +1,39 @@
 Header
-char magic[4] (= W3DS)
-uint16_t format_version      (=2 at the moment)
-uint16_t mesh_count
-uint16_t attachement_point_count
-uint16_t action_count
+    char magic[4] (= W3DS)
+    uint16_t format_version      (=2 at the moment)
+    uint16_t mesh_count
+    uint16_t attachement_point_count
+    uint16_t action_count
 
 Mesh Header
-char texturename[64]
-uint16_t triangle_count
-uint16_t vertex_count
+    char texturename[64]
+    uint16_t triangle_count
+    uint16_t vertex_count
 
 Data after mesh header:
-uint16_t vertexnum, edge per triangle
-float normal[3] per triangle
-float texcoord[2] per vertex
+    uint16_t vertexnum, edge per triangle
+    float normal[3] per triangle
+    float texcoord[2] per vertex
 
 Attachement Point Header
-char name[64]
+    char name[64]
 
 Action Header
-char name[64]
-float speed
-uint16_t marker_count
-uint16_t frame_count
+    char name[64]
+    float speed
+    uint16_t marker_count
+    uint16_t frame_count
 
 Data per marker:
-char name[64]
-uint16_t frame
+    char name[64]
+    uint16_t frame
 
 Data per action:
-for all frames:
-  for all meshes:
-    for all vertices:
-      float x, y, z
-  for all attachement points:
-    float locX, locY, locZ
-    float rotW, rotX, rotY, rotZ (it's a quaternion)
+    for all frames:
+      for all meshes:
+        for all vertices:
+          float x, y, z
+      for all attachement points:
+        float locX, locY, locZ
+        float rotW, rotX, rotY, rotZ (it's a quaternion)
 

Modified: trunk/src/Jamfile
===================================================================
--- trunk/src/Jamfile	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/Jamfile	2005-09-22 11:06:50 UTC (rev 1090)
@@ -76,6 +76,8 @@
         physics.hpp
         pda.cpp
         pda.hpp
+        pistol.cpp
+        pistol.hpp
         player.cpp
         player.hpp
         random.cpp

Modified: trunk/src/collision/stair_contact.cpp
===================================================================
--- trunk/src/collision/stair_contact.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/collision/stair_contact.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -39,7 +39,7 @@
 }
 
 void
-StairContact::update(float delta)
+StairContact::update(float )
 {
   // shouldn't be needed!?
 }

Modified: trunk/src/controller_help_window.cpp
===================================================================
--- trunk/src/controller_help_window.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/controller_help_window.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -107,7 +107,7 @@
 }
 
 void
-ControllerHelpWindow::update(float delta, const Controller&amp; controller)
+ControllerHelpWindow::update(float delta, const Controller&amp; )
 {
   impl-&gt;text_area-&gt;update(delta);
 }

Modified: trunk/src/display/display.cpp
===================================================================
--- trunk/src/display/display.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/display/display.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -29,6 +29,7 @@
 #include &quot;gameconfig.hpp&quot;
 #include &quot;glutil/opengl_state.hpp&quot;
 #include &quot;display.hpp&quot;
+#include &quot;util.hpp&quot;
 #include &lt;GL/glext.h&gt;
 
 SDL_Surface* Display::window       = 0;
@@ -231,7 +232,7 @@
 #define cl_pixelcenter_constant 0.375
 
   //glOrtho(0.0, window-&gt;w, window-&gt;h, 0.0, -1000.0, 1000.0);
-  glOrtho(0.0, 800, 600, 0.0, -1000.0, 1000.0);
+  glOrtho(0.0, 800, 600, 0.0, 1000.0, -1000.0);
   glMatrixMode(GL_MODELVIEW);
   glLoadIdentity();
   glTranslated(cl_pixelcenter_constant, cl_pixelcenter_constant, 0.0);
@@ -239,6 +240,8 @@
   if (config-&gt;antialiasing)
     glEnable(GL_MULTISAMPLE_ARB); 
 
+  assert_gl(&quot;setup projection&quot;);
+
   OpenGLState::init();
 }
 

Modified: trunk/src/display/drawing_context.cpp
===================================================================
--- trunk/src/display/drawing_context.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/display/drawing_context.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -21,7 +21,7 @@
 #include &lt;iostream&gt;
 #include &lt;iosfwd&gt;
 #include &lt;GL/gl.h&gt;
-#include &quot;fonts.hpp&quot;
+#include &quot;font/fonts.hpp&quot;
 #include &quot;sprite2d/sprite.hpp&quot;
 #include &quot;drawing_context.hpp&quot;
 #include &quot;glutil/opengl_state.hpp&quot;
@@ -157,7 +157,7 @@
 }
 
 void
-DrawingContext::draw(Surface surface, float x, float y, float z, float a)
+DrawingContext::draw(Surface surface, float x, float y, float z, float )
 {
   draw(new SurfaceDrawingRequest(surface,
                                  SurfaceDrawingParameters().set_pos(Vector(x, y)),
@@ -230,6 +230,12 @@
 }
 
 void
+DrawingContext::mult(const Matrix&amp; matrix)
+{
+  modelview_stack.back() = modelview_stack.back().multiply(matrix);
+}
+
+void
 DrawingContext::push_modelview()
 {
   modelview_stack.push_back(modelview_stack.back());

Modified: trunk/src/display/drawing_context.hpp
===================================================================
--- trunk/src/display/drawing_context.hpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/display/drawing_context.hpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -82,6 +82,9 @@
   /** Set the scaling of the drawing context */
   void scale(float x, float y, float z = 1.0f);
 
+  /** multiply the modelview of the context */
+  void mult(const Matrix&amp; matrix);
+
   void push_modelview();
   void pop_modelview();
   void reset_modelview();

Modified: trunk/src/display/scene_context.cpp
===================================================================
--- trunk/src/display/scene_context.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/display/scene_context.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -102,6 +102,14 @@
 }
 
 void
+SceneContext::mult_modelview(const Matrix&amp; matrix)
+{
+  impl-&gt;color.mult(matrix);
+  impl-&gt;light.mult(matrix);
+  impl-&gt;highlight.mult(matrix);
+}
+
+void
 SceneContext::push_modelview()
 {
   impl-&gt;color.push_modelview();

Modified: trunk/src/display/scene_context.hpp
===================================================================
--- trunk/src/display/scene_context.hpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/display/scene_context.hpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -63,6 +63,8 @@
   /** Set the scaling of the drawing context */
   void scale(float x, float y);
 
+  void mult_modelview(const Matrix&amp; matrix);
+
   void push_modelview();
   void pop_modelview();
   void reset_modelview();

Modified: trunk/src/energy_bar.cpp
===================================================================
--- trunk/src/energy_bar.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/energy_bar.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -53,7 +53,7 @@
 }
 
 void
-EnergyBar::update(float delta, const Controller&amp; controller)
+EnergyBar::update(float delta, const Controller&amp; )
 {
   bar.update(delta);
 }

Modified: trunk/src/game_object.hpp
===================================================================
--- trunk/src/game_object.hpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/game_object.hpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -26,13 +26,17 @@
 
 class Sector;
 
+/**
+ * This is the base class for all in-game objects. The sector class keeps a list
+ * of all GameObject and periodically calls draw() and update() for them.
+ */
 class GameObject : public RefCounter
 {
 private:
   static Sector* world;
   
 protected:
-  bool removable;
+  bool remove_flag;
 
   /**
    * name of the GameObject. Note: You should not change it anymore once the
@@ -43,28 +47,55 @@
   /** If a object is 'active = false' it will neither be drawn or updated */
   bool active;
 public:
-  GameObject() : removable(false), active(true) {}
+  GameObject() : remove_flag(false), active(true) {}
   virtual ~GameObject() {}
 
-
+  /**
+   * Set the remove flag to true which will result in the object being removed
+   * from the world till the next frame
+   */
   void remove()
   {
-    removable = true;
+    remove_flag = true;
   }
+  /**
+   * Returns the state of the remove flag
+   */
   bool is_removable() const
   {
-    return removable;
+    return remove_flag;
   }
 
+  /**
+   * return the name of the object
+   * The name is guaranteed to stay the same during the whole lifetime of
+   * the object
+   */
   const std::string&amp; get_name() const
   {
     return name;
   }
 
+  /**
+   * Activate or Deactivate an object. A deactivated object is not updated
+   * or drawn until it is activated again
+   */
   void set_active(bool a) { active = a; }
+  /**
+   * Returns true if the object is active, false if it is inactive
+   */
   bool is_active() const { return active; }
 
+  /**
+   * The object should draw itself when this function is called
+   */
   virtual void draw (SceneContext&amp; context) = 0;
+  /**
+   * This function is called from time to time to give the object a chance to
+   * update it's state. elapsed_time is the time that elapsed since the last
+   * update call in seconds. It is possible that there are multiple objects
+   * between 2 draw() calls or multiple draw() calls between 2 updates
+   */
   virtual void update (float elapsed_time) = 0;
     
   static void set_world (Sector* w) { world = w; }

Modified: trunk/src/game_session.cpp
===================================================================
--- trunk/src/game_session.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/game_session.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -276,7 +276,7 @@
 }
 
 void
-GameSession::set_sector(const std::string&amp; arg_filename)
+GameSession::set_sector(const std::string&amp; )
 {
   delete impl-&gt;sector;
   impl-&gt;sector = new Sector(impl-&gt;filename);

Modified: trunk/src/gui/button.cpp
===================================================================
--- trunk/src/gui/button.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/gui/button.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -24,7 +24,7 @@
 */
 
 #include &quot;display/display.hpp&quot;
-#include &quot;fonts.hpp&quot;
+#include &quot;font/fonts.hpp&quot;
 #include &quot;input/controller.hpp&quot;
 #include &quot;button.hpp&quot;
 
@@ -53,7 +53,7 @@
 }
 
 void
-Button::update(float delta, const Controller&amp; controller)
+Button::update(float , const Controller&amp; controller)
 {
   for(InputEventLst::const_iterator i = controller.get_events().begin(); i != controller.get_events().end(); ++i) 
     {

Modified: trunk/src/gui/list_view.cpp
===================================================================
--- trunk/src/gui/list_view.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/gui/list_view.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -25,7 +25,7 @@
 
 #include &quot;display/display.hpp&quot;
 #include &quot;input/controller.hpp&quot;
-#include &quot;fonts.hpp&quot;
+#include &quot;font/fonts.hpp&quot;
 #include &quot;list_view.hpp&quot;
 
 namespace GUI {
@@ -81,7 +81,7 @@
 }
 
 void
-ListView::update(float delta, const Controller&amp; controller)
+ListView::update(float , const Controller&amp; controller)
 {
    for(InputEventLst::const_iterator i = controller.get_events().begin(); 
        i != controller.get_events().end(); ++i) 

Modified: trunk/src/gui/tab_component.cpp
===================================================================
--- trunk/src/gui/tab_component.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/gui/tab_component.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -24,7 +24,7 @@
 */
 
 #include &quot;input/controller.hpp&quot;
-#include &quot;fonts.hpp&quot;
+#include &quot;font/fonts.hpp&quot;
 #include &quot;display/display.hpp&quot;
 #include &quot;tab_component.hpp&quot;
 

Modified: trunk/src/input/input_configurator.cpp
===================================================================
--- trunk/src/input/input_configurator.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/input/input_configurator.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -26,7 +26,7 @@
 #include &quot;display/display.hpp&quot;
 #include &quot;math/rect.hpp&quot;
 #include &quot;controller_def.hpp&quot;
-#include &quot;fonts.hpp&quot;
+#include &quot;font/fonts.hpp&quot;
 #include &quot;screen_manager.hpp&quot;
 #include &quot;input/input_manager_sdl.hpp&quot;
 #include &quot;input_configurator.hpp&quot;
@@ -90,7 +90,7 @@
 }
 
 void
-InputConfigurator::update(float delta, const Controller&amp; controller)
+InputConfigurator::update(float , const Controller&amp; )
 {
   
 }

Modified: trunk/src/laser_pointer.cpp
===================================================================
--- trunk/src/laser_pointer.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/laser_pointer.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -125,7 +125,7 @@
   array-&gt;vertex(pos.x, pos.y);
 
   array-&gt;color(Color(1.0f, 0.0f, 0.0f, 1.0f));
-  array-&gt;texcoord((target - pos).norm()/256.0f, progress);
+  array-&gt;texcoord((target - pos).magnitude()/256.0f, progress);
   array-&gt;vertex(target.x, target.y);
 
   sc.highlight().draw(array);

Modified: trunk/src/laser_pointer.hpp
===================================================================
--- trunk/src/laser_pointer.hpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/laser_pointer.hpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -26,6 +26,8 @@
 #ifndef HEADER_WINDSTILLE_LASER_POINTER_HPP
 #define HEADER_WINDSTILLE_LASER_POINTER_HPP
 
+#include &quot;sprite2d/sprite.hpp&quot;
+#include &quot;glutil/texture.hpp&quot;
 #include &quot;game_object.hpp&quot;
 
 /** Simple class that generates a laser for pointing at objects */

Modified: trunk/src/math/Jamfile
===================================================================
--- trunk/src/math/Jamfile	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/math/Jamfile	2005-09-22 11:06:50 UTC (rev 1090)
@@ -10,6 +10,8 @@
           origin.hpp
           origin.cpp
           point.hpp
+          quaternion.hpp
+          quaternion.cpp
 ;
 
 TRANSLATABLE_SOURCES = [ SearchSource $(sources) ] ;

Added: trunk/src/math/quaternion.cpp
===================================================================
--- trunk/src/math/quaternion.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/math/quaternion.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -0,0 +1,105 @@
+//  $Id$
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2005 Matthias Braun &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">matze at braunis.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+#include &lt;config.h&gt;
+
+#include &quot;quaternion.hpp&quot;
+
+#include &lt;math.h&gt;
+
+float
+Quaternion::magnitude() const
+{
+  return sqrt(w*w + x*x + y*y + z*z);
+}
+
+void
+Quaternion::normalize()
+{
+  float mag = magnitude();
+  w /= mag;
+  x /= mag;
+  y /= mag;
+  z /= mag;
+}
+
+Matrix
+Quaternion::to_matrix() const
+{
+  Matrix r;
+  r.matrix[0]  = 1.0f - 2.0f * (y*y + z*z);
+  r.matrix[4]  =        2.0f * (x*y - z*w);
+  r.matrix[8]  =        2.0f * (x*z + y*w);
+  r.matrix[12] = 0.0f;
+
+  r.matrix[1]  =        2.0f * (x*y + z*w);
+  r.matrix[5]  = 1.0f - 2.0f * (x*x + z*z);
+  r.matrix[9]  =        2.0f * (y*z - x*w);
+  r.matrix[13] = 0.0f;
+  
+  r.matrix[2]  =        2.0f * (x*z - y*w);
+  r.matrix[6]  =        2.0f * (y*z + x*w);
+  r.matrix[10] = 1.0f - 2.0f * (x*x + y*y);
+  r.matrix[14] = 0.0f;
+
+  r.matrix[3]  = 0.0f;
+  r.matrix[7]  = 0.0f;
+  r.matrix[11] = 0.0f;
+  r.matrix[15] = 1.0f;
+
+  return r;
+}
+
+static float clamp(float val, float min, float max)
+{
+  if(val &lt; min)
+    val = min;
+  else if(val &gt; max)
+    val = max;
+
+  return val;
+}
+
+Quaternion
+Quaternion::slerp(const Quaternion&amp; o, float t) const
+{
+  /** Matze: I don't understand this code :-/ It's from
+   * <A HREF="http://number-none.com/product/Understanding%20Slerp,%20Then%20Not%20Using%20It/">http://number-none.com/product/Understanding%20Slerp,%20Then%20Not%20Using%20It/</A>
+   * Though the article recommends not to use slerp I see no code for the other
+   * methods so I'll use slerp anyway
+   */
+  float dot = dot_product(o);
+
+  const float DOT_THRESHOLD = 0.995;
+  if(dot &gt; DOT_THRESHOLD) {
+    // quaternions are too close, lineary interpolate them
+    Quaternion result = *this + (o - *this)*t;
+    result.normalize();
+    return result;
+  }
+  
+  dot = clamp(dot, -1 ,1); // robustness
+  float theta_O = acos(dot);
+  float theta = theta_O * t;
+
+  Quaternion v2 = o - (*this * dot);
+  v2.normalize();
+
+  return (*this * cos(theta)) + (v2 * sin(theta));
+}
+

Added: trunk/src/math/quaternion.hpp
===================================================================
--- trunk/src/math/quaternion.hpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/math/quaternion.hpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -0,0 +1,82 @@
+//  $Id$
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2005 Matthias Braun &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">matze at braunis.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+#ifndef __QUATERNION_HPP__
+#define __QUATERNION_HPP__
+
+#include &quot;matrix.hpp&quot;
+
+class Quaternion
+{
+public:
+  float w;
+  float x;
+  float y;
+  float z;
+
+  Quaternion()
+    : w(0), x(0), y(0), z(0)
+  {}
+
+  Quaternion(float w, float x, float y, float z)
+    : w(w), x(x), y(y), z(z)
+  {}
+
+  float magnitude() const;
+  void normalize();
+
+  Quaternion operator* (const Quaternion&amp; o) const
+  {
+    return Quaternion(
+      w*o.w - x*o.x - y*o.y - z*o.z,
+      w*o.x + x*o.w + y*o.z - z*o.y,
+      w*o.y + y*o.w + z*o.x - x*o.z,
+      w*o.z + z*o.w + x*o.y - y*o.x);
+  }
+
+  Quaternion operator- (const Quaternion&amp; o) const
+  {
+    return Quaternion(w-o.w, x-o.x, y-o.y, z-o.z);
+  }
+
+  Quaternion operator+ (const Quaternion&amp; o) const
+  {
+    return Quaternion(w+o.w, x+o.x, y+o.y, z+o.z);
+  }
+
+  Quaternion operator* (float s) const
+  {
+    return Quaternion(w*s, x*s, y*s, z*s);
+  }
+
+  float dot_product(const Quaternion&amp; o) const
+  {
+    return x*o.x + y*o.y + z*o.z + w*o.w;
+  }
+
+  Matrix to_matrix() const;
+  /**
+   * spherical linear interpolation
+   * Returns this quaternion rotation added with t* the way from this quaternion
+   * to the o quaternion (so t should be between 0 and 1 usually)
+   */
+  Quaternion slerp(const Quaternion&amp; o, float t) const;
+};
+
+#endif
+

Modified: trunk/src/math/vector.cpp
===================================================================
--- trunk/src/math/vector.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/math/vector.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -22,12 +22,21 @@
 #include &lt;iostream&gt;
 #include &quot;math/vector.hpp&quot;
 
+void
+Vector::normalize()
+{
+  float mag = magnitude();
+  x /= mag;
+  y /= mag;
+}
+
 Vector Vector::unit() const
 {
-  return *this / norm();
+  return *this / magnitude();
 }
 
-float Vector::norm() const
+float
+Vector::magnitude() const
 {
   return sqrt(x*x + y*y);
 }
@@ -41,7 +50,7 @@
 Vector
 Vector::rotate(float angle) const
 {
-  float len = norm();
+  float len = magnitude();
   return Vector(len * cos(angle), len * sin(angle));
 }
 

Modified: trunk/src/math/vector.hpp
===================================================================
--- trunk/src/math/vector.hpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/math/vector.hpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -116,8 +116,9 @@
       return x*other.x + y*other.y;
     }
 
-  float norm() const;
+  float magnitude() const;
   Vector unit() const;
+  void normalize();
 
   // ... add the other operators as needed, I'm too lazy now ...
 

Added: trunk/src/math/vector3.hpp
===================================================================
--- trunk/src/math/vector3.hpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/math/vector3.hpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -0,0 +1,107 @@
+//  $Id$
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2005 Matthias Braun &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">matze at braunis.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+#ifndef __VECTOR3_HPP__
+#define __VECTOR3_HPP__
+
+#include &quot;math/matrix.hpp&quot;
+
+/**
+ * A 3-dimensional vector
+ */
+class Vector3
+{
+public:
+  float x;
+  float y;
+  float z;
+
+  Vector3()
+    : x(0), y(0), z(0)
+  {}
+
+  Vector3(float x, float y, float z)
+    : x(x), y(y), z(z)
+  {}
+
+  bool operator== (const Vector3&amp; o) const
+  {
+    return x == o.x &amp;&amp; y == o.y &amp;&amp; z == o.z;
+  }
+
+  bool operator !=(const Vector3&amp; o) const
+  {
+    return x != o.x || y != o.y || z != o.z;
+  }
+
+  Vector3 operator- () const
+  {
+    return Vector3(-x, -y, -z);
+  }
+
+  Vector3 operator+ (const Vector3&amp; o) const
+  {
+    return Vector3( x+o.x, y+o.y, z+o.z );
+  }
+
+  Vector3 operator- (const Vector3&amp; o) const
+  {
+    return Vector3( x-o.x, y-o.y, z-o.z );
+  }
+
+  Vector3 operator* (float s) const
+  {
+    return Vector3(x * s, y * s, z * s);
+  }
+
+  const Vector3&amp; operator+= (const Vector3&amp; o)
+  {
+    x += o.x;
+    y += o.y;
+    z += o.z;
+    return *this;
+  }
+
+  const Vector3&amp; operator-= (const Vector3&amp; o)
+  {
+    x -= o.x;
+    y -= o.y;
+    z -= o.z;
+    return *this;
+  }
+
+  const Vector3&amp; operator*= (const Vector3&amp; o)
+  {
+    x *= o.x;
+    y *= o.y;
+    z *= o.z;
+    return *this;
+  }
+
+  Matrix to_matrix() const
+  {
+    Matrix result = Matrix::identity();
+    result.matrix[12] = x;
+    result.matrix[13] = y;
+    result.matrix[14] = z;
+    return result;
+  }
+};
+
+#endif
+

Modified: trunk/src/physics.cpp
===================================================================
--- trunk/src/physics.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/physics.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -5,8 +5,8 @@
 Physics::Physics(Entity* entity)
   : entity(entity)
 {
-  mass = 1.0;
-  bounciness = 0.0;
+  mass = 200.0;
+  bounciness = 1.0;
   air_friction = 0.0;
   contact_friction = 0.0;
 }
@@ -18,7 +18,6 @@
 void
 Physics::register_collobj(CollisionObject&amp; object)
 {
-  printf(&quot;RegisterObject: %p\n&quot;, &amp;object);
   slots.push_back(object.sig_collision().connect(this, &amp;Physics::collision));
 }
 
@@ -81,7 +80,7 @@
   // add gravity force (TODO make it configurable per Sector)
   force += Vector(0, 9.81 * mass);
 
-  force -= velocity() * air_friction;
+  //force -= velocity() * air_friction;
   
   Vector acceleration = force / mass;
   velocity() += acceleration * elapsed_time;

Added: trunk/src/pistol.cpp
===================================================================
--- trunk/src/pistol.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/pistol.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -0,0 +1,56 @@
+//  $Id$
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2005 Matthias Braun &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">matze at braunis.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+#include &lt;config.h&gt;
+
+#include &quot;laser_pointer.hpp&quot;
+#include &quot;pistol.hpp&quot;
+
+Pistol::Pistol()
+  : laser_pointer(0)
+{
+  laser_pointer = new LaserPointer();
+  sprite = Sprite3D(&quot;models/objects/pistol/pistol.wsprite&quot;);
+}
+
+Pistol::~Pistol()
+{
+  delete laser_pointer;
+}
+
+void
+Pistol::draw(SceneContext&amp; sc)
+{
+  sprite.draw(sc.color(), Vector(0, 0), 1000);
+  if(laser_pointer)
+    laser_pointer-&gt;draw(sc);
+}
+
+void
+Pistol::update(float elapsed_time)
+{
+  if(laser_pointer)
+    laser_pointer-&gt;update(elapsed_time);
+
+  sprite.update(elapsed_time);
+}
+
+void
+Pistol::fire(bool )
+{
+}

Added: trunk/src/pistol.hpp
===================================================================
--- trunk/src/pistol.hpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/pistol.hpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -0,0 +1,46 @@
+//  $Id$
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2005 Matthias Braun &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">matze at braunis.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+#ifndef PISTOL_HPP
+#define PISTOL_HPP
+
+#include &quot;sprite3d/sprite3d.hpp&quot;
+#include &quot;weapon.hpp&quot;
+
+class LaserPointer;
+
+class Pistol : public Weapon
+{
+private:
+  Sprite3D sprite;
+  //LaserPointer* laser_pointer;
+
+public:
+  LaserPointer* laser_pointer;
+  
+  Pistol();
+  virtual ~Pistol();
+  
+  void draw(SceneContext&amp; context);
+  void update(float elapsed_time);
+
+  void fire(bool enable);
+};
+
+#endif
+

Modified: trunk/src/player.cpp
===================================================================
--- trunk/src/player.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/player.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -16,6 +16,7 @@
 //  You should have received a copy of the GNU General Public License
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+#include &lt;config.h&gt;
 
 #include &quot;tile_map.hpp&quot;
 #include &quot;sector.hpp&quot;
@@ -36,6 +37,7 @@
 #include &quot;game_session.hpp&quot;
 #include &quot;console.hpp&quot;
 #include &quot;grenade.hpp&quot;
+#include &quot;pistol.hpp&quot;
 
 static const int MAX_ENERGY = 16;
 static const float WALK_SPEED = 128.0;
@@ -47,11 +49,9 @@
   light(&quot;images/light3.sprite&quot;),
   flashlight(&quot;images/flashlightlight.sprite&quot;),
   flashlighthighlight(&quot;images/flashlighthighlight.sprite&quot;),
-  //sprite (&quot;3dsprites/heroken.wsprite&quot;),
-  grenade(&quot;3dsprites/grenade.wsprite&quot;),
   state(STAND)
 {
-  laser_pointer = new LaserPointer();
+  //laser_pointer = new LaserPointer();
   sprite = Sprite3D(&quot;3dsprites/heroken.wsprite&quot;);
   pos.x = 320;
   pos.y = 200;
@@ -77,11 +77,13 @@
   z_pos = 100.0f;
 
   contact = 0;
+  weapon = new Pistol();
+  laser_pointer = ((Pistol*) weapon)-&gt;laser_pointer;
 }
 
 Player::~Player()
 {
-  delete laser_pointer;
+  //delete laser_pointer;
 }
 
 void
@@ -114,9 +116,14 @@
       sc.highlight().draw(use_str, obj-&gt;get_pos().x, obj-&gt;get_pos().y - 150, 1000);
     }
   
-  //BoneID id = sprite.get_bone_id(&quot;Hand.R&quot;);
-  //grenade-&gt;draw(sc, sprite.get_bone_matrix(id));
-  laser_pointer-&gt;draw(sc);
+  Sprite3D::PointID id = sprite.get_attachement_point_id(&quot;Weapon&quot;);
+  sc.push_modelview();
+  sc.translate(pos.x, pos.y);
+  sc.mult_modelview(sprite.get_attachement_point_matrix(id));
+
+  weapon-&gt;draw(sc);
+
+  sc.pop_modelview();
 }
 
 void
@@ -140,6 +147,7 @@
 void 
 Player::update(float delta)
 {
+  weapon-&gt;update(delta);
   laser_pointer-&gt;update(delta);
 
   controller = InputManager::get_controller();
@@ -206,7 +214,6 @@
   velocity.y += GRAVITY * delta;
 
   sprite.update(delta);
-  grenade.update(delta);
 
   c_object-&gt;set_velocity (velocity);
 

Modified: trunk/src/player.hpp
===================================================================
--- trunk/src/player.hpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/player.hpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -16,7 +16,6 @@
 //  You should have received a copy of the GNU General Public License
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
 #ifndef PLAYER_HXX
 #define PLAYER_HXX
 
@@ -32,6 +31,7 @@
 class Controller;
 class Contact;
 class LaserPointer;
+class Weapon;
 
 class Player : public Entity
 {
@@ -42,7 +42,6 @@
   Sprite   flashlight;
   Sprite   flashlighthighlight;
   Sprite3D sprite;
-  Sprite3D grenade;
 
   bool jumping;
   bool bomb_placed;
@@ -54,6 +53,7 @@
 
   LaserPointer* laser_pointer;
   Contact* contact;
+  Weapon* weapon;
 
 public:
   enum State

Modified: trunk/src/screen_manager.cpp
===================================================================
--- trunk/src/screen_manager.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/screen_manager.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -70,7 +70,7 @@
     {
       /// Amount of time the world moves forward each update(), this is
       /// independed of the number of frames and always constant
-      static const float step = 10/1000.0f;
+      static const float step = .001;
 
       Uint32 now = SDL_GetTicks();
       float delta = static_cast&lt;float&gt;(now - ticks) / 1000.0f + overlap_delta;

Modified: trunk/src/sprite3d/data.cpp
===================================================================
--- trunk/src/sprite3d/data.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/sprite3d/data.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -156,10 +156,16 @@
           = new AttachementPointPosition[attachement_point_count];
         for(uint16_t a = 0; a &lt; attachement_point_count; ++a) {
           AttachementPointPosition&amp; point = frame.attachement_points[a];
-          for(int i = 0; i &lt; 3; ++i)
-            point.pos[i] = read_float(file);
-          for(int i = 0; i &lt; 4; ++i)
-            point.quat[i] = read_float(file);
+
+          point.pos.x = read_float(file);
+          point.pos.y = read_float(file);
+          point.pos.z = read_float(file);
+
+          point.quat.w = -read_float(file);
+          point.quat.x = read_float(file);
+          point.quat.y = read_float(file);
+          point.quat.z = read_float(file);
+          point.quat.normalize();
         }
       }
     }

Modified: trunk/src/sprite3d/data.hpp
===================================================================
--- trunk/src/sprite3d/data.hpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/sprite3d/data.hpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -23,6 +23,8 @@
 #include &lt;GL/gl.h&gt;
 #include &quot;ref.hpp&quot;
 #include &quot;glutil/texture.hpp&quot;
+#include &quot;math/vector3.hpp&quot;
+#include &quot;math/quaternion.hpp&quot;
 
 namespace sprite3d
 {
@@ -88,8 +90,8 @@
 
 struct AttachementPointPosition
 {
-  float pos[3]; // x, y, z
-  float quat[4]; // w, x, y, z
+  Vector3 pos; // x, y, z
+  Quaternion quat; // w, x, y, z
 };
 
 struct ActionFrame

Modified: trunk/src/sprite3d/sprite3d.cpp
===================================================================
--- trunk/src/sprite3d/sprite3d.cpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/sprite3d/sprite3d.cpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -15,8 +15,8 @@
 //  You should have received a copy of the GNU General Public License
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
 #include &lt;config.h&gt;
+
 #include &quot;sprite3d/sprite3d.hpp&quot;
 
 #include &lt;vector&gt;
@@ -182,72 +182,21 @@
   return data-&gt;get_attachement_point_id(name); 
 }
 
-static inline void set_matrix_from_quat(Matrix&amp; m, float w,
-    float x, float y, float z)
-{
-  //row1
-  m.matrix[0] = 1.0f - 2*y*y - 2*z*z;
-  m.matrix[4] = 2*x*y - 2*w*z;
-  m.matrix[8] = 2*x*z + 2*w*y;
-  m.matrix[12] = 0.0f;
-
-  //row2
-  m.matrix[1] = 2*x*y + 2*w*z;
-  m.matrix[5] = 1.0f - 2*x*x - 2*z*z;
-  m.matrix[9] = 2*y*z - 2*w*x;
-  m.matrix[13] = 0.0f;
-
-  //row3
-  m.matrix[2] = 2*x*z - 2*w*y;
-  m.matrix[6] = 2*y*z + 2*w*x;
-  m.matrix[10] = 1.0f - 2*x*x - 2*y*y;
-  m.matrix[14] = 0.0f;
-
-  //row4
-  m.matrix[3] = 0.0f;
-  m.matrix[7] = 0.0f;
-  m.matrix[11] = 0.0f;
-  m.matrix[15] = 1.0f;
-}
-
 Matrix
 Sprite3D::get_attachement_point_matrix(PointID id) const
 {
-  float t_1 = 1.0 - blend_time;
   const AttachementPointPosition&amp; point1 
 	  = frame1.action-&gt;frames[frame1.frame].attachement_points[id];
   const AttachementPointPosition&amp; point2 
 	  = frame2.action-&gt;frames[frame2.frame].attachement_points[id];
 
-  float pos[3];
-  float quat[4];
-  if(frame1.rot) {
-    pos[0] = -point1.pos[0] * t_1;
-    pos[1] = point1.pos[1] * t_1;
-    pos[2] = -point1.pos[2] * t_1;   
-  } else {
-    for(int i = 0; i &lt; 3; ++i)
-      pos[i] = point1.pos[i] * t_1;
-    for(int i = 0; i &lt; 4; ++i)
-      quat[i] = point1.quat[i] * t_1;
-  }
-  if(frame2.rot) {
-    pos[0] += -point2.pos[0] * blend_time;
-    pos[1] += point2.pos[1] * blend_time;
-    pos[2] += -point2.pos[2] * blend_time;
-  } else {
-    for(int i = 0; i &lt; 3; ++i)
-      pos[i] += point2.pos[i] * blend_time;
-    for(int i = 0; i &lt; 4; ++i)
-      quat[i] += point2.quat[i] * blend_time;
-  }
+  Vector3 pos = point1.pos + (point2.pos - point1.pos) * blend_time;
+  Quaternion quat = point1.quat.slerp(point2.quat, blend_time);
+  
+  Matrix result = pos.to_matrix();
+  result = result.multiply(quat.to_matrix());
 
-  Matrix m      = Matrix::identity();
-  m.matrix[12] += pos[0];
-  m.matrix[13] += pos[1];
-  m.matrix[14] += pos[2];
-
-  return m;
+  return result;
 }
 
 class Sprite3DDrawingRequest : public DrawingRequest
@@ -324,11 +273,16 @@
 }
 
 void
-Sprite3D::draw(DrawingContext&amp; dc, const Matrix&amp; matrix, float z_pos) const
+Sprite3D::draw(DrawingContext&amp; dc, const Matrix&amp; , float ) const
 {
   dc.draw(new Sprite3DDrawingRequest(this, Vector(0, 0), 0.0f, dc.get_modelview()));
 }
 
+static inline float interpolate(float v1, float v2, float t)
+{
+  return v1 + (v2 - v1) * t;
+}
+
 void
 Sprite3D::draw(const Vector&amp; pos, const Matrix&amp; modelview) const
 {
@@ -362,7 +316,6 @@
   const ActionFrame&amp; aframe1 = frame1.action-&gt;frames[frame1.frame];
   const ActionFrame&amp; aframe2 = frame2.action-&gt;frames[frame2.frame];
   
-  float t_1 = 1.0 - blend_time;
   for(uint16_t m = 0; m &lt; data-&gt;mesh_count; ++m) 
     {
       const Mesh&amp; mesh = data-&gt;meshs[m];
@@ -376,22 +329,26 @@
       float verts[mesh.vertex_count * 3];
       if(frame1.rot == frame2.rot) {
         for(uint16_t v = 0; v &lt; mesh.vertex_count*3; ++v) {
-          verts[v] 
-            = vertices1.vertices[v] * t_1 + vertices2.vertices[v] * blend_time;
+          float v1 = vertices1.vertices[v];
+          float v2 = vertices2.vertices[v];
+          verts[v] = interpolate(v1, v2, blend_time);
         }
       } else {
         // need to manually rotate 180 degree here because frames have different
         // rot values (=&gt; x=-x, y=y, z=-z)
-        for(uint16_t v = 0; v &lt; mesh.vertex_count; ++v) {
-          verts[v*3] 
-            = vertices1.vertices[v*3] * t_1 
-            - vertices2.vertices[v*3] * blend_time;
-          verts[v*3+1]
-            = vertices1.vertices[v*3+1] * t_1 
-            + vertices2.vertices[v*3+1] * blend_time;
-          verts[v*3+2]
-            = vertices1.vertices[v*3+2] * t_1
-            - vertices2.vertices[v*3+2] * blend_time;
+        for(uint16_t v = 0; v &lt; mesh.vertex_count*3; ) {
+          // X coord
+          float v1 = vertices1.vertices[v];
+          float v2 = -vertices2.vertices[v];
+          verts[v++] = interpolate(v1, v2, blend_time);
+          // Y coord
+          v1 = vertices1.vertices[v];
+          v2 = vertices2.vertices[v];
+          verts[v++] = interpolate(v1, v2, blend_time);
+          // Z coord
+          v1 = vertices1.vertices[v];
+          v2 = -vertices2.vertices[v];                            
+          verts[v++] = interpolate(v1, v2, blend_time);          
         }
       }
 

Added: trunk/src/weapon.hpp
===================================================================
--- trunk/src/weapon.hpp	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/src/weapon.hpp	2005-09-22 11:06:50 UTC (rev 1090)
@@ -0,0 +1,39 @@
+//  $Id$
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2005 Matthias Braun &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">matze at braunis.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+#ifndef WEAPON_HPP
+#define WEAPON_HPP
+
+/**
+ * Base class for all weapons. This is not a GameObject because it will be
+ * attached and handled by the Player object, not by the sector
+ */
+class Weapon
+{
+public:
+  virtual ~Weapon()
+  {}
+  
+  virtual void draw(SceneContext&amp; context) = 0;
+  virtual void update(float elapsed_time) = 0;
+
+  virtual void fire(bool enable) = 0;
+};
+
+#endif
+

Modified: trunk/tools/windstille_export.py
===================================================================
--- trunk/tools/windstille_export.py	2005-09-17 23:07:24 UTC (rev 1089)
+++ trunk/tools/windstille_export.py	2005-09-22 11:06:50 UTC (rev 1090)
@@ -47,19 +47,37 @@
 FORMAT_VERSION = 2
 
 def matrix2quaternion(m):
-  s = math.sqrt(abs(m[0][0] + m[1][1] + m[2][2] + m[3][3]))
-  if s == 0.0:
-    x = abs(m[2][1] - m[1][2])
-    y = abs(m[0][2] - m[2][0])
-    z = abs(m[1][0] - m[0][1])
-    if   (x &gt;= y) and (x &gt;= z): return 1.0, 0.0, 0.0, 0.0
-    elif (y &gt;= x) and (y &gt;= z): return 0.0, 1.0, 0.0, 0.0
-    else:                       return 0.0, 0.0, 1.0, 0.0
-  return quaternion_normalize([
-    -(m[2][1] - m[1][2]) / (2.0 * s),     -(m[0][2] - m[2][0]) / (2.0 * s),
-    -(m[1][0] - m[0][1]) / (2.0 * s),
-    0.5 * s,
-    ])
+  tr = 1.0 + m[0][0] + m[1][1] + m[2][2]
+  if tr &gt; .00001:
+    s = math.sqrt(tr)
+    w = s / 2.0
+    s = 0.5 / s
+    x = (m[1][2] - m[2][1]) * s
+    y = (m[2][0] - m[0][2]) * s
+    z = (m[0][1] - m[1][0]) * s
+  elif m[0][0] &gt; m[1][1] and m[0][0] &gt; m[2][2]:
+    s = math.sqrt(1.0 + m[0][0] - m[1][1] - m[2][2])
+    x = s / 2.0
+    s = 0.5 / s
+    y = (m[0][1] + m[1][0]) * s
+    z = (m[2][0] + m[0][2]) * s
+    w = (m[1][2] - m[2][1]) * s
+  elif m[1][1] &gt; m[2][2]:
+    s = math.sqrt(1.0 + m[1][1] - m[0][0] - m[2][2])
+    y = s / 2.0
+    s = 0.5 / s
+    x = (m[0][1] + m[1][0]) * s
+    z = (m[1][2] + m[2][1]) * s
+    w = (m[2][0] - m[0][2]) * s
+  else:
+    s = math.sqrt(1.0 + m[2][2] - m[0][0] - m[1][1])
+    z = s / 2.0
+    s = 0.5 / s
+    x = (m[2][0] + m[0][2]) * s
+    y = (m[1][2] + m[2][1]) * s
+    w = (m[0][1] - m[1][0]) * s
+    
+  return w, x, y, z
 
 def quaternion_normalize(q):
   l = math.sqrt(q[0] * q[0] + q[1] * q[1] + q[2] * q[2] + q[3] * q[3])
@@ -211,13 +229,13 @@
           t[0] *= ZOOM
           t[1] *= ZOOM
           t[2] *= ZOOM
-          self.file.write(struct.pack(&quot;=fff&quot;, t[1], -t[2], t[0]))
+          self.file.write(struct.pack(&quot;=fff&quot;, t[1], -t[2], -t[0]))
 
       # attachement points
       for obj in self.attachement_objects:
         m = obj.matrixWorld
         loc = (m[3][0] * ZOOM, m[3][1] * ZOOM, m[3][2] * ZOOM)
-        self.file.write(struct.pack(&quot;=fff&quot;, loc[0], loc[1], loc[2]))
+        self.file.write(struct.pack(&quot;=fff&quot;, loc[1], -loc[2], -loc[0]))
         quat = matrix2quaternion(m)
         self.file.write(struct.pack(&quot;=ffff&quot;, quat[0], quat[1], quat[2], quat[3]))
 
@@ -313,9 +331,9 @@
 
     # normals
     for face in data.faces:
-      bodydata += struct.pack(&quot;=fff&quot;, face.normal[1], -face.normal[2], face.normal[0])
+      bodydata += struct.pack(&quot;=fff&quot;, face.normal[1], -face.normal[2], -face.normal[0])
       if len(face.v) == 4:
-        bodydata += struct.pack(&quot;=fff&quot;, face.normal[1], -face.normal[2], face.normal[0])
+        bodydata += struct.pack(&quot;=fff&quot;, face.normal[1], -face.normal[2], -face.normal[0])
 
     # uv coords per vertex
     for uv in uvs:


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000746.html">[Windstille-commit] r1089 - trunk/data/images/objects
</A></li>
	<LI>Next message: <A HREF="000748.html">[Windstille-commit] r1091 - in trunk/data/models: . objects objects/pistol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#747">[ date ]</a>
              <a href="thread.html#747">[ thread ]</a>
              <a href="subject.html#747">[ subject ]</a>
              <a href="author.html#747">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/windstille-commit">More information about the Windstille-commit
mailing list</a><br>
</body></html>
