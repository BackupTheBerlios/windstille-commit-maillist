From grumbel at mail.berlios.de  Sat Jun  9 23:05:20 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 9 Jun 2007 23:05:20 +0200
Subject: [Windstille-commit] r1378 - trunk/windstille/src
Message-ID: <200706092105.l59L5KjX012902@sheep.berlios.de>

Author: grumbel
Date: 2007-06-09 23:05:19 +0200 (Sat, 09 Jun 2007)
New Revision: 1378

Modified:
   trunk/windstille/src/console.cpp
Log:
- added space after > on console echo

Modified: trunk/windstille/src/console.cpp
===================================================================
--- trunk/windstille/src/console.cpp	2007-04-26 18:41:49 UTC (rev 1377)
+++ trunk/windstille/src/console.cpp	2007-06-09 21:05:19 UTC (rev 1378)
@@ -416,7 +416,7 @@
     }
   else 
     {
-      console << ">" << command_line << std::endl;
+      console << "> " << command_line << std::endl;
       for(std::vector<std::string>::iterator i = completions.begin(); i != completions.end(); ++i)
         {
           console << *i << " ";



From grumbel at mail.berlios.de  Sat Jun  9 23:05:36 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 9 Jun 2007 23:05:36 +0200
Subject: [Windstille-commit] r1379 - in trunk/windstille/src: . font gui
Message-ID: <200706092105.l59L5aaK012958@sheep.berlios.de>

Author: grumbel
Date: 2007-06-09 23:05:36 +0200 (Sat, 09 Jun 2007)
New Revision: 1379

Modified:
   trunk/windstille/src/SConscript
   trunk/windstille/src/font/fonts.cpp
   trunk/windstille/src/font/fonts.hpp
   trunk/windstille/src/font/ttf_font.hpp
   trunk/windstille/src/gui/tab_component.cpp
   trunk/windstille/src/screen_manager.cpp
   trunk/windstille/src/windstille_main.cpp
Log:
- added menu component

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-09 21:05:19 UTC (rev 1378)
+++ trunk/windstille/src/SConscript	2007-06-09 21:05:36 UTC (rev 1379)
@@ -119,6 +119,7 @@
 'font/ttf_font.cpp',
 'gui/automap.cpp',
 'gui/button.cpp',
+'gui/menu_component.cpp',
 'gui/label.cpp',
 'gui/component.cpp',
 'gui/component_factory.cpp',

Modified: trunk/windstille/src/font/fonts.cpp
===================================================================
--- trunk/windstille/src/font/fonts.cpp	2007-06-09 21:05:19 UTC (rev 1378)
+++ trunk/windstille/src/font/fonts.cpp	2007-06-09 21:05:36 UTC (rev 1379)
@@ -29,6 +29,7 @@
 
 TTFFont* Fonts::ttffont   = 0;
 TTFFont* Fonts::vera12    = 0;
+TTFFont* Fonts::vera16    = 0;
 TTFFont* Fonts::ttfdialog = 0;
 
 void
@@ -37,7 +38,8 @@
   BorderFontEffect* border_effect = new BorderFontEffect(1);
 
   ttffont   = new TTFFont("fonts/VeraMono.ttf", 12);
-  vera12      = new TTFFont("fonts/Vera.ttf", 12);
+  vera12    = new TTFFont("fonts/Vera.ttf", 12);
+  vera16    = new TTFFont("fonts/Vera.ttf", 16);
   ttfdialog = new TTFFont("fonts/Vera.ttf", 20);
 
   delete border_effect;
@@ -48,6 +50,7 @@
 {
   delete ttffont;
   delete vera12;
+  delete vera16;
   delete ttfdialog;
 }
 

Modified: trunk/windstille/src/font/fonts.hpp
===================================================================
--- trunk/windstille/src/font/fonts.hpp	2007-06-09 21:05:19 UTC (rev 1378)
+++ trunk/windstille/src/font/fonts.hpp	2007-06-09 21:05:36 UTC (rev 1379)
@@ -32,6 +32,7 @@
 
 extern TTFFont* ttffont;
 extern TTFFont* vera12;
+extern TTFFont* vera16;
 extern TTFFont* ttfdialog;
 
 void init();

Modified: trunk/windstille/src/font/ttf_font.hpp
===================================================================
--- trunk/windstille/src/font/ttf_font.hpp	2007-06-09 21:05:19 UTC (rev 1378)
+++ trunk/windstille/src/font/ttf_font.hpp	2007-06-09 21:05:36 UTC (rev 1379)
@@ -82,6 +82,7 @@
   const TTFCharacter& get_character(int c) const;
   void draw(float x_pos, float y_pos, const std::string& str, const Color& color = Color(1.0f, 1.0f, 1.0f));
   void draw_center(float x_pos, float y_pos, const std::string& str, const Color& color = Color(1.0f, 1.0f, 1.0f));
+
 private:
   TTFFontImpl* impl;
 };

Modified: trunk/windstille/src/gui/tab_component.cpp
===================================================================
--- trunk/windstille/src/gui/tab_component.cpp	2007-06-09 21:05:19 UTC (rev 1378)
+++ trunk/windstille/src/gui/tab_component.cpp	2007-06-09 21:05:36 UTC (rev 1379)
@@ -59,11 +59,11 @@
                      Sizef(tab_width - 20, Fonts::ttfdialog->get_height() + 6));
 
       if (i == current_tab)
-        Display::fill_rect(tab_rect, Color(1.0f, 1.0f, 1.0f, 0.5f));
+        Display::fill_rounded_rect(tab_rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 0.5f));
       else
-        Display::fill_rect(tab_rect, Color(0.0f, 0.0f, 0.0f, 0.5f));
+        Display::fill_rounded_rect(tab_rect, 5.0f, Color(0.0f, 0.0f, 0.0f, 0.5f));
 
-      Display::draw_rect(tab_rect, Color(1.0f, 1.0f, 1.0f, 0.5f));
+      Display::draw_rounded_rect(tab_rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 0.5f));
 
       Fonts::ttfdialog->draw_center(rect.left + tab_width * i + tab_width/2,
                                     rect.top + Fonts::ttfdialog->get_height(),
@@ -129,6 +129,7 @@
                     }
                   else if (i->axis.pos > 0)
                     {
+                      tabs[current_tab].component->set_active(true); 
                     }
                 }
             }

Modified: trunk/windstille/src/screen_manager.cpp
===================================================================
--- trunk/windstille/src/screen_manager.cpp	2007-06-09 21:05:19 UTC (rev 1378)
+++ trunk/windstille/src/screen_manager.cpp	2007-06-09 21:05:36 UTC (rev 1379)
@@ -44,6 +44,7 @@
 #include "gui/slider.hpp"
 #include "gui/root_component.hpp"
 #include "gui/grid_component.hpp"
+#include "gui/menu_component.hpp"
 #include "gui/tab_component.hpp"
 #include "gui/list_view.hpp"
 #include "gui/text_view.hpp"
@@ -216,6 +217,12 @@
                     grid->pack(new Button("0",  grid), 1, 3);
                     grid->pack(new Button("Ok", grid), 2, 3);
 
+                    MenuComponent* menu = new MenuComponent(Rectf(100, 130, 700, 500), tab);
+                    menu->add_item("Volume");
+                    menu->add_item("Sound");
+                    menu->add_item("Aspect Ratio");
+
+                    tab->pack("Menu", menu);
                     tab->pack("Auto Map",  new Automap(Rectf(100, 130, 700, 500), tab));
                     tab->pack("Grid Test", grid);
 

Modified: trunk/windstille/src/windstille_main.cpp
===================================================================
--- trunk/windstille/src/windstille_main.cpp	2007-06-09 21:05:19 UTC (rev 1378)
+++ trunk/windstille/src/windstille_main.cpp	2007-06-09 21:05:36 UTC (rev 1379)
@@ -163,7 +163,13 @@
           }
       }
         
-    console << "Press F1 to open the console" << std::endl;
+    console << "F1 - open the console" << std::endl;
+    console << "F6 - mouse release" << std::endl;
+    console << "F7 - mouse grap" << std::endl;;
+    console << "F8 - run gui test" << std::endl;;
+    console << "F9 - configure input" << std::endl;
+    console << "F11 - toggle fullscreen" << std::endl;
+    console << "F12 - do a screenshot" << std::endl;
     screen_manager.run();
     
     TileFactory::deinit();
@@ -211,6 +217,7 @@
   sprite3d_manager = new sprite3d::Manager();
 
   script_manager->run_script_file("scripts/windstille.nut");
+  script_manager->run_script_file("scripts/init.nut");
 }
 
 void



From grumbel at mail.berlios.de  Sun Jun 10 02:25:31 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sun, 10 Jun 2007 02:25:31 +0200
Subject: [Windstille-commit] r1380 - in trunk/windstille/src: . gui
Message-ID: <200706100025.l5A0PVB0020562@sheep.berlios.de>

Author: grumbel
Date: 2007-06-10 02:25:29 +0200 (Sun, 10 Jun 2007)
New Revision: 1380

Added:
   trunk/windstille/src/gui/menu_component.cpp
   trunk/windstille/src/gui/menu_component.hpp
Modified:
   trunk/windstille/src/
   trunk/windstille/src/screen_manager.cpp
Log:
- added menu component and slidermenuitem, use f8 to test


Property changes on: trunk/windstille/src
___________________________________________________________________
Name: svn:ignore
   - 
baby_xml
ctest
.deps
editor
Makefile
Makefile.in
old/
ptest
random
response_curve
.sconsign
semantic.cache
windstille

   + 
baby_xml
BROWSE
ctest
.deps
editor
Makefile
Makefile.in
old/
ptest
random
response_curve
.sconsign
semantic.cache
windstille


Added: trunk/windstille/src/gui/menu_component.cpp
===================================================================
--- trunk/windstille/src/gui/menu_component.cpp	2007-06-09 21:05:36 UTC (rev 1379)
+++ trunk/windstille/src/gui/menu_component.cpp	2007-06-10 00:25:29 UTC (rev 1380)
@@ -0,0 +1,272 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include <iostream>
+#include "input/controller.hpp"
+#include "menu_component.hpp"
+#include "display/display.hpp"
+#include "math.hpp"
+
+namespace GUI {
+
+MenuItem::MenuItem(MenuComponent* parent_, const std::string& label_)
+  : parent(parent_),
+    label(label_)
+{}
+
+void
+MenuItem::draw(const Rectf& rect, bool is_active)
+{
+  Color font_color;
+  TTFFont* font = Fonts::vera16;
+  
+  if (is_active) {
+    Display::fill_rounded_rect(rect, 5.0f, Color(0.5f, 0.5f, 0.5f, 0.75f));
+    Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 1.0f));
+    font_color = Color(1.0f, 1.0f, 1.0f);
+  } else {
+    Display::fill_rounded_rect(rect, 5.0f, Color(0.3f, 0.3f, 0.3f, 0.75f));
+    Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 0.75f));
+    font_color = Color(0.75f, 0.75f, 0.75f, 1.0f);
+  }
+
+  font->draw(rect.left + font->get_height(), rect.top + font->get_height()/2.0f + rect.get_height()/2.0f - 2.0f,
+             label, font_color);
+      
+}
+
+void
+MenuItem::update(float delta)
+{
+}
+
+BoolMenuItem::BoolMenuItem(MenuComponent* parent_, 
+                           const std::string& label_, bool value_, 
+                           const std::string& true_label_, const std::string& false_label_)
+  : MenuItem(parent_, label_),
+    value(value_),
+    true_label(true_label_),
+    false_label(false_label_)
+{
+}
+
+void
+BoolMenuItem::incr()
+{
+  value = !value;
+}
+
+void
+BoolMenuItem::decr()
+{
+  value = !value;
+}
+
+void 
+BoolMenuItem::draw(const Rectf& rect, bool is_active)
+{
+  MenuItem::draw(rect, is_active);
+  TTFFont* font = Fonts::vera16;
+  Color font_color;
+  if (is_active)
+    {
+      font_color = Color(1.0f, 1.0f, 1.0f);
+    }
+  else
+    {
+      font_color = Color(0.75f, 0.75f, 0.75f, 1.0f);
+    }
+
+  font->draw(rect.right - font->get_height() - font->get_width(value ? true_label : false_label), 
+             rect.top + font->get_height()/2.0f + rect.get_height()/2.0f - 2.0f,
+             (value ? true_label : false_label), 
+             font_color);
+}
+
+void 
+BoolMenuItem::update(float delta)
+{
+  MenuItem::update(delta);
+}
+
+SliderMenuItem::SliderMenuItem(MenuComponent* parent_, 
+                               const std::string& label_,
+                               int value_, int min_value_, int max_value_, int step_) 
+  : MenuItem(parent_, label_),
+    value(value_),
+    min_value(min_value_),
+    max_value(max_value_),
+    step(step_)
+{  
+}
+
+void
+SliderMenuItem::incr()
+{
+  value += step;
+  if (value > max_value)
+    value = max_value;
+}
+
+void
+SliderMenuItem::decr()
+{
+  value -= step;
+  if (value < min_value)
+    value = min_value;
+}
+
+void
+SliderMenuItem::draw(const Rectf& rect, bool is_active)
+{
+  MenuItem::draw(rect, is_active);
+  int total_width = 200;
+  int width = total_width * value / (max_value - min_value);
+
+  Color color;
+  if (is_active)
+    {
+      color = Color(1.0f, 1.0f, 1.0f);
+    }
+  else
+    {
+      color = Color(0.75f, 0.75f, 0.75f, 1.0f);
+    }
+
+  Display::fill_rounded_rect(Rectf(Vector(rect.right - 4 - width, rect.top + 4),
+                                   Sizef(width, rect.get_height() - 8)), 
+                             5.0f,
+                             color);
+
+
+  Display::draw_rounded_rect(Rectf(Vector(rect.right - 4 - total_width, rect.top + 4),
+                                   Sizef(total_width, rect.get_height() - 8)), 
+                             5.0f,
+                             color);
+}
+
+void
+SliderMenuItem::update(float delta)
+{
+  MenuItem::update(delta);
+}
+
+MenuComponent::MenuComponent(const Rectf& rect, Component* parent)
+  : Component(rect, parent),
+    current_item(0)
+{
+}
+
+MenuComponent::~MenuComponent()
+{
+  for(Items::iterator i = items.begin(); i != items.end(); ++i)
+    {
+      delete *i;
+    }
+}
+
+void
+MenuComponent::add_item(MenuItem* item)
+{
+  items.push_back(item);
+}
+
+void
+MenuComponent::add_item(const std::string& label)
+{
+  MenuItem* item = new BoolMenuItem(this, label, true, "on", "off");
+  items.push_back(item);
+}
+
+void
+MenuComponent::draw()
+{
+  float spacing = 10.0f;
+  float step = Fonts::vera16->get_height() + spacing*2.0f;
+
+  for(Items::size_type i = 0; i < items.size(); ++i)
+    {
+      items[i]->draw(Rectf(rect.left, rect.top + i * step + 2.0f, 
+                           rect.right, rect.top + (i+1) * step - 2.0f), 
+                     is_active() && (int(i) == current_item));
+    }
+}
+
+void
+MenuComponent::update(float delta, const Controller& controller)
+{
+  for(InputEventLst::const_iterator i = controller.get_events().begin(); 
+      i != controller.get_events().end(); 
+      ++i)
+    {
+      if (i->type == BUTTON_EVENT && i->button.down)
+        {
+          if (i->button.name == OK_BUTTON)
+            {
+              
+            }
+          else if (i->button.name == CANCEL_BUTTON)
+            {
+              set_active(false);
+            }
+        }
+      else if (i->type == AXIS_EVENT)
+        {
+          if (i->axis.name == X_AXIS)
+            {
+              if (i->axis.pos < 0)
+                {
+                  items[current_item]->incr();
+                  // insert callback here
+                }
+              else if (i->axis.pos > 0)
+                {
+                  items[current_item]->decr();
+                  // insert callback here
+                }
+            }
+          else if (i->axis.name == Y_AXIS)
+            {
+              if (i->axis.pos < 0)
+                {
+                  current_item = current_item - 1;
+                  if (current_item < 0)
+                    {
+                      current_item = 0;
+                      set_active(false);
+                    }
+                }
+              else if (i->axis.pos > 0)
+                {
+                  current_item = Math::mid(0, current_item + 1, static_cast<int>(items.size()-1)); 
+                }
+            }
+        }
+    }
+}
+
+} // namespace GUI
+
+/* EOF */


Property changes on: trunk/windstille/src/gui/menu_component.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/gui/menu_component.hpp
===================================================================
--- trunk/windstille/src/gui/menu_component.hpp	2007-06-09 21:05:36 UTC (rev 1379)
+++ trunk/windstille/src/gui/menu_component.hpp	2007-06-10 00:25:29 UTC (rev 1380)
@@ -0,0 +1,111 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_WINDSTILLE_GUI_MENU_COMPONENT_HPP
+#define HEADER_WINDSTILLE_GUI_MENU_COMPONENT_HPP
+
+#include <string>
+#include <vector>
+#include "font/fonts.hpp"
+#include "component.hpp"
+
+namespace GUI {
+
+class MenuComponent;
+
+class MenuItem {
+public:
+  MenuComponent* parent;
+  std::string label;
+
+  MenuItem(MenuComponent* parent_, const std::string& label_);
+  virtual ~MenuItem() {}
+  virtual void incr() =0;
+  virtual void decr() =0;
+  virtual void draw(const Rectf& rect, bool is_active);
+  virtual void update(float delta);
+};
+
+class BoolMenuItem : public MenuItem {
+private: // FIXME: Convert this into a generic enum/value slider
+  bool value;
+  std::string true_label;
+  std::string false_label;
+
+public:  
+  BoolMenuItem(MenuComponent* parent_, 
+               const std::string& label_, bool value_, 
+               const std::string& true_label_ = "on", const std::string& false_label_ = "off");
+  void incr();
+  void decr();
+  void draw(const Rectf& rect, bool is_active);
+  void update(float);
+};
+
+/** A slider widget for use in volume controls, gamma controls and
+    things like that */
+class SliderMenuItem : public MenuItem {
+public:
+  int value;
+  int min_value;
+  int max_value;
+  int step;
+
+public:  
+  SliderMenuItem(MenuComponent* parent_, 
+                 const std::string& label_, int value_, int mix_value_ = 0, int max_value_ = 100, int step = 10);
+  void incr();
+  void decr();
+  void draw(const Rectf& rect, bool is_active);
+  void update(float);
+};
+
+/** */
+class MenuComponent : public Component
+{
+private:
+  typedef std::vector<MenuItem* > Items;
+  Items items;
+  int   current_item;
+  
+public:
+  MenuComponent(const Rectf& rect, Component* parent);
+  virtual ~MenuComponent();
+
+  void add_item(const std::string& label);
+  void add_item(MenuItem* item);
+  void draw();
+  void update(float delta, const Controller& controller);
+
+private:
+  MenuComponent (const MenuComponent&);
+  MenuComponent& operator= (const MenuComponent&);
+};
+
+} // namespace GUI
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/gui/menu_component.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/screen_manager.cpp
===================================================================
--- trunk/windstille/src/screen_manager.cpp	2007-06-09 21:05:36 UTC (rev 1379)
+++ trunk/windstille/src/screen_manager.cpp	2007-06-10 00:25:29 UTC (rev 1380)
@@ -221,6 +221,7 @@
                     menu->add_item("Volume");
                     menu->add_item("Sound");
                     menu->add_item("Aspect Ratio");
+                    menu->add_item(new SliderMenuItem(menu, "Volume", 50, 0, 100, 5));
 
                     tab->pack("Menu", menu);
                     tab->pack("Auto Map",  new Automap(Rectf(100, 130, 700, 500), tab));
@@ -252,7 +253,7 @@
                   break;
 
                 case SDLK_F10:
-                  config.set_bool("show-fps", !config.get_bool("show_fps"));
+                  config.set_bool("show-fps", !config.get_bool("show-fps"));
                   break;
               
                 case SDLK_F11:



From grumbel at mail.berlios.de  Sun Jun 10 06:04:18 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sun, 10 Jun 2007 06:04:18 +0200
Subject: [Windstille-commit] r1381 - in trunk/windstille: data/scripts src
	src/gui
Message-ID: <200706100404.l5A44IkR001365@sheep.berlios.de>

Author: grumbel
Date: 2007-06-10 06:04:17 +0200 (Sun, 10 Jun 2007)
New Revision: 1381

Modified:
   trunk/windstille/data/scripts/windstille.nut
   trunk/windstille/src/gui/menu_component.cpp
   trunk/windstille/src/gui/menu_component.hpp
   trunk/windstille/src/screen_manager.cpp
Log:
- turned BoolMenuItem into a more flexible EnumMenuItem, press F8 for testing

Modified: trunk/windstille/data/scripts/windstille.nut
===================================================================
--- trunk/windstille/data/scripts/windstille.nut	2007-06-10 00:25:29 UTC (rev 1380)
+++ trunk/windstille/data/scripts/windstille.nut	2007-06-10 04:04:17 UTC (rev 1381)
@@ -25,10 +25,11 @@
 
 /**
  * This script is read on Windstille startup, add all helper functions
- * that should be available in the console all the time here 
+ * that should be available in the console all the time go here. Use
+ * the init.nut file for non-function stuff that should be evaluated
+ * (startup messages and such).
  */
 
-
 /**
  * Constants from display/scene_context.hpp, manually copied here so
  * you have to sync manually in case stuff changes

Modified: trunk/windstille/src/gui/menu_component.cpp
===================================================================
--- trunk/windstille/src/gui/menu_component.cpp	2007-06-10 00:25:29 UTC (rev 1380)
+++ trunk/windstille/src/gui/menu_component.cpp	2007-06-10 04:04:17 UTC (rev 1381)
@@ -62,30 +62,40 @@
 {
 }
 
-BoolMenuItem::BoolMenuItem(MenuComponent* parent_, 
-                           const std::string& label_, bool value_, 
-                           const std::string& true_label_, const std::string& false_label_)
+EnumMenuItem::EnumMenuItem(MenuComponent* parent_, 
+                           const std::string& label_, int index_)
   : MenuItem(parent_, label_),
-    value(value_),
-    true_label(true_label_),
-    false_label(false_label_)
+    index(index_)
 {
 }
 
 void
-BoolMenuItem::incr()
+EnumMenuItem::add_pair(int value, const std::string& label)
 {
-  value = !value;
+  EnumValue enum_value;
+  enum_value.value = value;
+  enum_value.label = label;
+  labels.push_back(enum_value);
 }
 
 void
-BoolMenuItem::decr()
+EnumMenuItem::incr()
 {
-  value = !value;
+  index -= 1;
+  if (index < 0)
+    index = labels.size()-1;
 }
 
+void
+EnumMenuItem::decr()
+{
+  index += 1;
+  if (index >= static_cast<int>(labels.size()))
+    index = 0;
+}
+
 void 
-BoolMenuItem::draw(const Rectf& rect, bool is_active)
+EnumMenuItem::draw(const Rectf& rect, bool is_active)
 {
   MenuItem::draw(rect, is_active);
   TTFFont* font = Fonts::vera16;
@@ -99,14 +109,14 @@
       font_color = Color(0.75f, 0.75f, 0.75f, 1.0f);
     }
 
-  font->draw(rect.right - font->get_height() - font->get_width(value ? true_label : false_label), 
+  font->draw(rect.right - font->get_height() - font->get_width("< " + labels[index].label + " >"),
              rect.top + font->get_height()/2.0f + rect.get_height()/2.0f - 2.0f,
-             (value ? true_label : false_label), 
+             "< " + labels[index].label + " >",
              font_color);
 }
 
 void 
-BoolMenuItem::update(float delta)
+EnumMenuItem::update(float delta)
 {
   MenuItem::update(delta);
 }
@@ -158,7 +168,7 @@
   Display::fill_rounded_rect(Rectf(Vector(rect.right - 4 - width, rect.top + 4),
                                    Sizef(width, rect.get_height() - 8)), 
                              5.0f,
-                             color);
+                             Color(0.75f*color.r, 0.75f*color.g, 0.75f*color.b, color.a));
 
 
   Display::draw_rounded_rect(Rectf(Vector(rect.right - 4 - total_width, rect.top + 4),
@@ -194,13 +204,6 @@
 }
 
 void
-MenuComponent::add_item(const std::string& label)
-{
-  MenuItem* item = new BoolMenuItem(this, label, true, "on", "off");
-  items.push_back(item);
-}
-
-void
 MenuComponent::draw()
 {
   float spacing = 10.0f;

Modified: trunk/windstille/src/gui/menu_component.hpp
===================================================================
--- trunk/windstille/src/gui/menu_component.hpp	2007-06-10 00:25:29 UTC (rev 1380)
+++ trunk/windstille/src/gui/menu_component.hpp	2007-06-10 04:04:17 UTC (rev 1381)
@@ -48,16 +48,22 @@
   virtual void update(float delta);
 };
 
-class BoolMenuItem : public MenuItem {
+class EnumMenuItem : public MenuItem {
 private: // FIXME: Convert this into a generic enum/value slider
-  bool value;
-  std::string true_label;
-  std::string false_label;
+  struct EnumValue {
+    std::string label;
+    int         value;
+  };
+  
+  int index;
+  std::vector<EnumValue> labels;
 
 public:  
-  BoolMenuItem(MenuComponent* parent_, 
-               const std::string& label_, bool value_, 
-               const std::string& true_label_ = "on", const std::string& false_label_ = "off");
+  EnumMenuItem(MenuComponent* parent_, 
+               const std::string& label_, int index_ = 0);
+  
+  void add_pair(int value, const std::string& label);
+
   void incr();
   void decr();
   void draw(const Rectf& rect, bool is_active);
@@ -94,7 +100,6 @@
   MenuComponent(const Rectf& rect, Component* parent);
   virtual ~MenuComponent();
 
-  void add_item(const std::string& label);
   void add_item(MenuItem* item);
   void draw();
   void update(float delta, const Controller& controller);

Modified: trunk/windstille/src/screen_manager.cpp
===================================================================
--- trunk/windstille/src/screen_manager.cpp	2007-06-10 00:25:29 UTC (rev 1380)
+++ trunk/windstille/src/screen_manager.cpp	2007-06-10 04:04:17 UTC (rev 1381)
@@ -217,13 +217,36 @@
                     grid->pack(new Button("0",  grid), 1, 3);
                     grid->pack(new Button("Ok", grid), 2, 3);
 
+                    // Begin Option Menu
                     MenuComponent* menu = new MenuComponent(Rectf(100, 130, 700, 500), tab);
-                    menu->add_item("Volume");
-                    menu->add_item("Sound");
-                    menu->add_item("Aspect Ratio");
-                    menu->add_item(new SliderMenuItem(menu, "Volume", 50, 0, 100, 5));
 
-                    tab->pack("Menu", menu);
+                    SliderMenuItem* music_volume_item = new SliderMenuItem(menu, "Music Volume", 100, 0, 100, 10);
+                    menu->add_item(music_volume_item);
+
+                    SliderMenuItem* sfx_volume_item = new SliderMenuItem(menu, "Sound FX Volume", 100, 0, 100, 10);
+                    menu->add_item(sfx_volume_item);
+
+                    EnumMenuItem* fullscreen_item = new EnumMenuItem(menu, "Fullscreen", 0);
+                    fullscreen_item->add_pair(1, "on");
+                    fullscreen_item->add_pair(0, "off");
+                    menu->add_item(fullscreen_item);
+
+                    EnumMenuItem* fps_item = new EnumMenuItem(menu, "Display Frames per Second", 0);
+                    fps_item->add_pair(1, "on");
+                    fps_item->add_pair(0, "off");
+                    menu->add_item(fps_item);
+
+
+                    EnumMenuItem* aspect_item = new EnumMenuItem(menu, "Aspect Ratio");
+                    aspect_item->add_pair(0, "4:3");
+                    aspect_item->add_pair(1, "16:9");
+                    aspect_item->add_pair(3, "16:10");
+                    aspect_item->add_pair(2, "letterbox");
+                    menu->add_item(aspect_item);
+
+                    tab->pack("Options", menu);
+                    // End: Option Menu
+
                     tab->pack("Auto Map",  new Automap(Rectf(100, 130, 700, 500), tab));
                     tab->pack("Grid Test", grid);
 



From grumbel at mail.berlios.de  Sun Jun 10 06:20:05 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sun, 10 Jun 2007 06:20:05 +0200
Subject: [Windstille-commit] r1382 - in trunk/windstille/src: . gui
Message-ID: <200706100420.l5A4K5BP002207@sheep.berlios.de>

Author: grumbel
Date: 2007-06-10 06:20:04 +0200 (Sun, 10 Jun 2007)
New Revision: 1382

Modified:
   trunk/windstille/src/gui/menu_component.cpp
   trunk/windstille/src/gui/menu_component.hpp
   trunk/windstille/src/screen_manager.cpp
   trunk/windstille/src/screen_manager.hpp
Log:
- added signals to MenuItem

Modified: trunk/windstille/src/gui/menu_component.cpp
===================================================================
--- trunk/windstille/src/gui/menu_component.cpp	2007-06-10 04:04:17 UTC (rev 1381)
+++ trunk/windstille/src/gui/menu_component.cpp	2007-06-10 04:20:04 UTC (rev 1382)
@@ -84,6 +84,7 @@
   index -= 1;
   if (index < 0)
     index = labels.size()-1;
+  on_change(labels[index].value);
 }
 
 void
@@ -92,6 +93,7 @@
   index += 1;
   if (index >= static_cast<int>(labels.size()))
     index = 0;
+  on_change(labels[index].value);
 }
 
 void 
@@ -138,6 +140,7 @@
   value += step;
   if (value > max_value)
     value = max_value;
+  on_change(value);
 }
 
 void
@@ -146,6 +149,7 @@
   value -= step;
   if (value < min_value)
     value = min_value;
+  on_change(value);
 }
 
 void

Modified: trunk/windstille/src/gui/menu_component.hpp
===================================================================
--- trunk/windstille/src/gui/menu_component.hpp	2007-06-10 04:04:17 UTC (rev 1381)
+++ trunk/windstille/src/gui/menu_component.hpp	2007-06-10 04:20:04 UTC (rev 1382)
@@ -28,6 +28,7 @@
 
 #include <string>
 #include <vector>
+#include "signals/signal_v1.hpp"
 #include "font/fonts.hpp"
 #include "component.hpp"
 
@@ -57,7 +58,7 @@
   
   int index;
   std::vector<EnumValue> labels;
-
+  Signal_v1<int> on_change;
 public:  
   EnumMenuItem(MenuComponent* parent_, 
                const std::string& label_, int index_ = 0);
@@ -68,6 +69,7 @@
   void decr();
   void draw(const Rectf& rect, bool is_active);
   void update(float);
+  Signal_v1<int>& sig_change() { return on_change; }
 };
 
 /** A slider widget for use in volume controls, gamma controls and
@@ -78,7 +80,7 @@
   int min_value;
   int max_value;
   int step;
-
+  Signal_v1<int> on_change;
 public:  
   SliderMenuItem(MenuComponent* parent_, 
                  const std::string& label_, int value_, int mix_value_ = 0, int max_value_ = 100, int step = 10);
@@ -86,6 +88,7 @@
   void decr();
   void draw(const Rectf& rect, bool is_active);
   void update(float);
+  Signal_v1<int>& sig_change() { return on_change; }
 };
 
 /** */

Modified: trunk/windstille/src/screen_manager.cpp
===================================================================
--- trunk/windstille/src/screen_manager.cpp	2007-06-10 04:04:17 UTC (rev 1381)
+++ trunk/windstille/src/screen_manager.cpp	2007-06-10 04:20:04 UTC (rev 1382)
@@ -234,9 +234,9 @@
                     EnumMenuItem* fps_item = new EnumMenuItem(menu, "Display Frames per Second", 0);
                     fps_item->add_pair(1, "on");
                     fps_item->add_pair(0, "off");
+                    slots.push_back(fps_item->sig_change().connect(this, &ScreenManager::show_fps));
                     menu->add_item(fps_item);
 
-
                     EnumMenuItem* aspect_item = new EnumMenuItem(menu, "Aspect Ratio");
                     aspect_item->add_pair(0, "4:3");
                     aspect_item->add_pair(1, "16:9");
@@ -382,5 +382,12 @@
 {
   do_quit = true;
 }
+
+// Callbacks
+void
+ScreenManager::show_fps(int i)
+{
+  config.set_bool("show-fps", i);
+}
 
 /* EOF */

Modified: trunk/windstille/src/screen_manager.hpp
===================================================================
--- trunk/windstille/src/screen_manager.hpp	2007-06-10 04:04:17 UTC (rev 1381)
+++ trunk/windstille/src/screen_manager.hpp	2007-06-10 04:20:04 UTC (rev 1382)
@@ -26,12 +26,17 @@
 #ifndef HEADER_SCREEN_MANAGER_HPP
 #define HEADER_SCREEN_MANAGER_HPP
 
+#include <vector>
+#include "signals/slot.hpp"
+
 class Screen;
 
 /** */
 class ScreenManager
 {
 private:
+  std::vector<Slot> slots;
+
   Screen* screen;
   Screen* overlay_screen;
 
@@ -63,7 +68,9 @@
       screen, usefull for menus or console, use set_overlay(0) to kill
       the current overlay */
   void set_overlay(Screen* s);
-
+  
+  // Callbacks
+  void show_fps(int i);
 private:
   void poll_events();
   void draw_fps();



From grumbel at mail.berlios.de  Mon Jun 11 01:04:51 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 11 Jun 2007 01:04:51 +0200
Subject: [Windstille-commit] r1383 - in trunk/windstille: . data/images
	data/scripts src src/font src/gui
Message-ID: <200706102304.l5AN4pcw009673@sheep.berlios.de>

Author: grumbel
Date: 2007-06-11 01:04:41 +0200 (Mon, 11 Jun 2007)
New Revision: 1383

Added:
   trunk/windstille/data/images/titlescreen.png
   trunk/windstille/data/scripts/init.nut
Modified:
   trunk/windstille/
   trunk/windstille/src/SConscript
   trunk/windstille/src/conversation.cpp
   trunk/windstille/src/dialog_manager.cpp
   trunk/windstille/src/font/fonts.cpp
   trunk/windstille/src/font/fonts.hpp
   trunk/windstille/src/game_session.cpp
   trunk/windstille/src/gui/button.cpp
   trunk/windstille/src/gui/list_view.cpp
   trunk/windstille/src/gui/menu_component.cpp
   trunk/windstille/src/gui/menu_component.hpp
   trunk/windstille/src/gui/tab_component.cpp
   trunk/windstille/src/inventory.cpp
   trunk/windstille/src/screen_manager.cpp
   trunk/windstille/src/screen_manager.hpp
   trunk/windstille/src/text_area.cpp
   trunk/windstille/src/windstille_main.cpp
Log:
- added simple title screen


Property changes on: trunk/windstille
___________________________________________________________________
Name: svn:ignore
   + windstille


Added: trunk/windstille/data/images/titlescreen.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/titlescreen.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/scripts/init.nut
===================================================================
--- trunk/windstille/data/scripts/init.nut	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/data/scripts/init.nut	2007-06-10 23:04:41 UTC (rev 1383)
@@ -0,0 +1,34 @@
+/* -*- c++ -*-
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+/*
+ * This script is automatically executed on Windstille startup, use
+ * windstille.nut for function definitions, use this for things that
+ * should get executed (console messages displayed on start up and such).
+ */
+
+// FIXME: println does a 'inspect', print a to_s, unintuitive
+
+/* EOF */

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/SConscript	2007-06-10 23:04:41 UTC (rev 1383)
@@ -83,6 +83,7 @@
 'tile_description.cpp',
 'timer.cpp',
 'trigger.cpp',
+'title_screen.cpp',
 'util.cpp',
 'view.cpp',
 'lisp_getters.cpp',

Modified: trunk/windstille/src/conversation.cpp
===================================================================
--- trunk/windstille/src/conversation.cpp	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/conversation.cpp	2007-06-10 23:04:41 UTC (rev 1383)
@@ -72,11 +72,11 @@
   for(int i = 0; i < int(choices.size()); ++i)
     {
       if (i == selection)
-        Fonts::ttfdialog->draw(x, y, choices[i]);
+        Fonts::vera20->draw(x, y, choices[i]);
       else
-        Fonts::ttfdialog->draw(x, y, choices[i], Color(0.5f, 0.5f, 0.5f));
+        Fonts::vera20->draw(x, y, choices[i], Color(0.5f, 0.5f, 0.5f));
   
-      y += Fonts::ttfdialog->get_height() + 10;
+      y += Fonts::vera20->get_height() + 10;
     }
 }
 

Modified: trunk/windstille/src/dialog_manager.cpp
===================================================================
--- trunk/windstille/src/dialog_manager.cpp	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/dialog_manager.cpp	2007-06-10 23:04:41 UTC (rev 1383)
@@ -190,9 +190,9 @@
 
 
   delete text_area;
-  text_area = new TextArea(Rect(Point(text_rect.left, text_rect.top + Fonts::ttfdialog->get_height()),
+  text_area = new TextArea(Rect(Point(text_rect.left, text_rect.top + Fonts::vera20->get_height()),
                                 Size(text_width, 200)), true);
-  text_area->set_font(Fonts::ttfdialog);
+  text_area->set_font(Fonts::vera20);
   text_area->set_text(text);
 }
 

Modified: trunk/windstille/src/font/fonts.cpp
===================================================================
--- trunk/windstille/src/font/fonts.cpp	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/font/fonts.cpp	2007-06-10 23:04:41 UTC (rev 1383)
@@ -27,20 +27,22 @@
 #include "border_font_effect.hpp"
 #include "fonts.hpp"
 
-TTFFont* Fonts::ttffont   = 0;
-TTFFont* Fonts::vera12    = 0;
-TTFFont* Fonts::vera16    = 0;
-TTFFont* Fonts::ttfdialog = 0;
+TTFFont* Fonts::ttffont = 0;
+TTFFont* Fonts::vera12  = 0;
+TTFFont* Fonts::vera16  = 0;
+TTFFont* Fonts::vera20  = 0;
+TTFFont* Fonts::vera28  = 0;
 
 void
 Fonts::init()
 {
   BorderFontEffect* border_effect = new BorderFontEffect(1);
 
-  ttffont   = new TTFFont("fonts/VeraMono.ttf", 12);
-  vera12    = new TTFFont("fonts/Vera.ttf", 12);
-  vera16    = new TTFFont("fonts/Vera.ttf", 16);
-  ttfdialog = new TTFFont("fonts/Vera.ttf", 20);
+  ttffont = new TTFFont("fonts/VeraMono.ttf", 12);
+  vera12  = new TTFFont("fonts/Vera.ttf", 12);
+  vera16  = new TTFFont("fonts/Vera.ttf", 16);
+  vera20  = new TTFFont("fonts/Vera.ttf", 20);
+  vera28  = new TTFFont("fonts/Vera.ttf", 28);
 
   delete border_effect;
 }
@@ -51,7 +53,8 @@
   delete ttffont;
   delete vera12;
   delete vera16;
-  delete ttfdialog;
+  delete vera20;
+  delete vera28;
 }
 
 /* EOF */

Modified: trunk/windstille/src/font/fonts.hpp
===================================================================
--- trunk/windstille/src/font/fonts.hpp	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/font/fonts.hpp	2007-06-10 23:04:41 UTC (rev 1383)
@@ -33,7 +33,8 @@
 extern TTFFont* ttffont;
 extern TTFFont* vera12;
 extern TTFFont* vera16;
-extern TTFFont* ttfdialog;
+extern TTFFont* vera20;
+extern TTFFont* vera28;
 
 void init();
 void deinit();

Modified: trunk/windstille/src/game_session.cpp
===================================================================
--- trunk/windstille/src/game_session.cpp	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/game_session.cpp	2007-06-10 23:04:41 UTC (rev 1383)
@@ -180,7 +180,7 @@
   if (pause)
     {
       if ((SDL_GetTicks() / 1000) % 2)
-        Fonts::ttfdialog->draw(Display::get_width()/2, Display::get_height()/2, "Pause");
+        Fonts::vera20->draw(Display::get_width()/2, Display::get_height()/2, "Pause");
     }
 }
 

Modified: trunk/windstille/src/gui/button.cpp
===================================================================
--- trunk/windstille/src/gui/button.cpp	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/gui/button.cpp	2007-06-10 23:04:41 UTC (rev 1383)
@@ -51,7 +51,7 @@
 {
   Display::fill_rect(rect, Color(0.0f, 0.0f, 0.0f, 0.5f));
   Display::draw_rect(rect, Color(1.0f, 1.0f, 1.0f, 0.5f));
-  Fonts::ttfdialog->draw_center(rect.left + rect.get_width()/2, rect.top + rect.get_height()/2,
+  Fonts::vera20->draw_center(rect.left + rect.get_width()/2, rect.top + rect.get_height()/2,
                                 label,
                                 is_active()
                                 ? Color(1.0f, 1.0f, 1.0f, 1.0f) 

Modified: trunk/windstille/src/gui/list_view.cpp
===================================================================
--- trunk/windstille/src/gui/list_view.cpp	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/gui/list_view.cpp	2007-06-10 23:04:41 UTC (rev 1383)
@@ -43,7 +43,7 @@
 void
 ListView::draw()
 {
-  TTFFont* font = Fonts::ttfdialog;
+  TTFFont* font = Fonts::vera20;
 
   float x = rect.left;
   float y = rect.top + font->get_height();

Modified: trunk/windstille/src/gui/menu_component.cpp
===================================================================
--- trunk/windstille/src/gui/menu_component.cpp	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/gui/menu_component.cpp	2007-06-10 23:04:41 UTC (rev 1383)
@@ -26,6 +26,7 @@
 #include <iostream>
 #include "input/controller.hpp"
 #include "menu_component.hpp"
+#include "gui/root_component.hpp"
 #include "display/display.hpp"
 #include "math.hpp"
 
@@ -40,7 +41,7 @@
 MenuItem::draw(const Rectf& rect, bool is_active)
 {
   Color font_color;
-  TTFFont* font = Fonts::vera16;
+  TTFFont* font = parent->get_font();
   
   if (is_active) {
     Display::fill_rounded_rect(rect, 5.0f, Color(0.5f, 0.5f, 0.5f, 0.75f));
@@ -100,7 +101,7 @@
 EnumMenuItem::draw(const Rectf& rect, bool is_active)
 {
   MenuItem::draw(rect, is_active);
-  TTFFont* font = Fonts::vera16;
+  TTFFont* font = parent->get_font();
   Color font_color;
   if (is_active)
     {
@@ -111,9 +112,9 @@
       font_color = Color(0.75f, 0.75f, 0.75f, 1.0f);
     }
 
-  font->draw(rect.right - font->get_height() - font->get_width("< " + labels[index].label + " >"),
+  font->draw(rect.right - font->get_height() - font->get_width(labels[index].label),
              rect.top + font->get_height()/2.0f + rect.get_height()/2.0f - 2.0f,
-             "< " + labels[index].label + " >",
+             labels[index].label,
              font_color);
 }
 
@@ -187,9 +188,32 @@
   MenuItem::update(delta);
 }
 
+ButtonMenuItem::ButtonMenuItem(MenuComponent* parent_, const std::string& label_)
+  : MenuItem(parent_, label_)
+{
+}
+
+void
+ButtonMenuItem::click()
+{
+  on_click();
+}
+
+void
+ButtonMenuItem::draw(const Rectf& rect, bool is_active)
+{
+  MenuItem::draw(rect, is_active);
+}
+
+void
+ButtonMenuItem::update(float)
+{
+}
+
 MenuComponent::MenuComponent(const Rectf& rect, Component* parent)
   : Component(rect, parent),
-    current_item(0)
+    current_item(0),
+    font(Fonts::vera16)
 {
 }
 
@@ -211,7 +235,7 @@
 MenuComponent::draw()
 {
   float spacing = 10.0f;
-  float step = Fonts::vera16->get_height() + spacing*2.0f;
+  float step = font->get_height() + spacing*2.0f;
 
   for(Items::size_type i = 0; i < items.size(); ++i)
     {
@@ -232,7 +256,7 @@
         {
           if (i->button.name == OK_BUTTON)
             {
-              
+              items[current_item]->click();
             }
           else if (i->button.name == CANCEL_BUTTON)
             {
@@ -246,12 +270,10 @@
               if (i->axis.pos < 0)
                 {
                   items[current_item]->incr();
-                  // insert callback here
                 }
               else if (i->axis.pos > 0)
                 {
                   items[current_item]->decr();
-                  // insert callback here
                 }
             }
           else if (i->axis.name == Y_AXIS)
@@ -261,19 +283,49 @@
                   current_item = current_item - 1;
                   if (current_item < 0)
                     {
-                      current_item = 0;
-                      set_active(false);
+                      if (dynamic_cast<RootComponent*>(parent))
+                        {
+                          current_item = static_cast<int>(items.size())-1; 
+                        }
+                      else
+                        { // FIXME: This only works good with TabComponent
+                          current_item = 0;
+                          set_active(false);
+                        }
                     }
                 }
               else if (i->axis.pos > 0)
                 {
-                  current_item = Math::mid(0, current_item + 1, static_cast<int>(items.size()-1)); 
+                  if (dynamic_cast<RootComponent*>(parent))
+                    {
+                      current_item += 1;
+                      if (current_item >= static_cast<int>(items.size()))
+                        {
+                          current_item = 0;
+                        }
+                    }
+                  else
+                    {
+                      current_item = Math::mid(0, current_item + 1, static_cast<int>(items.size()-1)); 
+                    }
                 }
             }
         }
     }
 }
 
+void
+MenuComponent::set_font(TTFFont* font_)
+{
+  font = font_;
+}
+
+TTFFont*
+MenuComponent::get_font()
+{
+  return font;
+}
+
 } // namespace GUI
 
 /* EOF */

Modified: trunk/windstille/src/gui/menu_component.hpp
===================================================================
--- trunk/windstille/src/gui/menu_component.hpp	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/gui/menu_component.hpp	2007-06-10 23:04:41 UTC (rev 1383)
@@ -29,9 +29,12 @@
 #include <string>
 #include <vector>
 #include "signals/signal_v1.hpp"
+#include "signals/signal_v0.hpp"
 #include "font/fonts.hpp"
 #include "component.hpp"
 
+class TTFFont;
+
 namespace GUI {
 
 class MenuComponent;
@@ -45,6 +48,7 @@
   virtual ~MenuItem() {}
   virtual void incr() =0;
   virtual void decr() =0;
+  virtual void click() =0;
   virtual void draw(const Rectf& rect, bool is_active);
   virtual void update(float delta);
 };
@@ -67,6 +71,7 @@
 
   void incr();
   void decr();
+  void click() {}
   void draw(const Rectf& rect, bool is_active);
   void update(float);
   Signal_v1<int>& sig_change() { return on_change; }
@@ -86,11 +91,25 @@
                  const std::string& label_, int value_, int mix_value_ = 0, int max_value_ = 100, int step = 10);
   void incr();
   void decr();
+  void click() {}
   void draw(const Rectf& rect, bool is_active);
   void update(float);
   Signal_v1<int>& sig_change() { return on_change; }
 };
 
+class ButtonMenuItem : public MenuItem {
+public:
+  Signal_v0 on_click;
+public:  
+  ButtonMenuItem(MenuComponent* parent_, const std::string& label_);
+  void incr() {}
+  void decr() {}
+  void click();
+  void draw(const Rectf& rect, bool is_active);
+  void update(float);
+  Signal_v0& sig_click() { return on_click; }
+};
+
 /** */
 class MenuComponent : public Component
 {
@@ -98,7 +117,7 @@
   typedef std::vector<MenuItem* > Items;
   Items items;
   int   current_item;
-  
+  TTFFont* font;
 public:
   MenuComponent(const Rectf& rect, Component* parent);
   virtual ~MenuComponent();
@@ -107,6 +126,8 @@
   void draw();
   void update(float delta, const Controller& controller);
 
+  void     set_font(TTFFont* font_);
+  TTFFont* get_font();
 private:
   MenuComponent (const MenuComponent&);
   MenuComponent& operator= (const MenuComponent&);

Modified: trunk/windstille/src/gui/tab_component.cpp
===================================================================
--- trunk/windstille/src/gui/tab_component.cpp	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/gui/tab_component.cpp	2007-06-10 23:04:41 UTC (rev 1383)
@@ -56,7 +56,7 @@
     {
       Rectf tab_rect(Vector(rect.left + tab_width * i + 10,
                             rect.top),
-                     Sizef(tab_width - 20, Fonts::ttfdialog->get_height() + 6));
+                     Sizef(tab_width - 20, Fonts::vera20->get_height() + 6));
 
       if (i == current_tab)
         Display::fill_rounded_rect(tab_rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 0.5f));
@@ -65,8 +65,8 @@
 
       Display::draw_rounded_rect(tab_rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 0.5f));
 
-      Fonts::ttfdialog->draw_center(rect.left + tab_width * i + tab_width/2,
-                                    rect.top + Fonts::ttfdialog->get_height(),
+      Fonts::vera20->draw_center(rect.left + tab_width * i + tab_width/2,
+                                    rect.top + Fonts::vera20->get_height(),
                                     tabs[i].label,
                                     tabs[current_tab].component->is_active()
                                     ? Color(1.0f, 1.0f, 1.0f, 0.5f) 
@@ -144,7 +144,7 @@
 
   int padding = 6;
   component->set_screen_rect(Rectf(rect.left + padding,
-                                   rect.top  + padding + Fonts::ttfdialog->get_height() + 10,
+                                   rect.top  + padding + Fonts::vera20->get_height() + 10,
                                    rect.right  - padding,
                                    rect.bottom - padding
                                    ));

Modified: trunk/windstille/src/inventory.cpp
===================================================================
--- trunk/windstille/src/inventory.cpp	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/inventory.cpp	2007-06-10 23:04:41 UTC (rev 1383)
@@ -109,7 +109,7 @@
       if (i == 0 && moving == 0)
         {
           slothighlight.draw(draw_pos);
-          Fonts::ttfdialog->draw_center(draw_pos.x, draw_pos.y - 64, item.name);
+          Fonts::vera20->draw_center(draw_pos.x, draw_pos.y - 64, item.name);
         }
       else
         {

Modified: trunk/windstille/src/screen_manager.cpp
===================================================================
--- trunk/windstille/src/screen_manager.cpp	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/screen_manager.cpp	2007-06-10 23:04:41 UTC (rev 1383)
@@ -178,7 +178,7 @@
           if (event.key.state)
             {    
               switch (event.key.keysym.sym)
-                {       
+                {
                 case SDLK_F6:
                   SDL_ShowCursor(SDL_ENABLE);   // SDL_ENABLE to show the mouse cursor (default)
                   SDL_WM_GrabInput(SDL_GRAB_OFF); // SDL_GRAB_OFF to not grab input (default)
@@ -189,88 +189,6 @@
                   SDL_WM_GrabInput(SDL_GRAB_ON); // SDL_GRAB_OFF to not grab input (default)
                   break;
       
-                case SDLK_F8:
-                  {
-                    using namespace GUI;
-                    GUIManager* manager = new GUIManager();
-
-                    TabComponent* tab = new TabComponent(Rectf(100, 100, 700, 500), manager->get_root());
-
-                    GridComponent* grid = new GridComponent(Rectf(100, 130, 700, 500), 3, 4, tab);
-
-                    grid->pack(new Button("1", grid), 0, 0);
-                    grid->pack(new Button("2", grid), 1, 0);
-                    grid->pack(new Button("3", grid), 2, 0);
-
-                    grid->pack(new Slider(grid), 0, 1);
-                    //grid->pack(new Button("5", grid), 1, 1, 2, 2);
-                    TextView* text_view = new TextView(Rectf(), grid);
-                    grid->pack(text_view, 1, 1, 2, 2);
-
-                    //grid->pack(new Button("6", grid), 2, 1);
-
-                    grid->pack(new Button("7", grid), 0, 2, 1, 2);
-                    //grid->pack(new Button("8", grid), 1, 2);
-                    //grid->pack(new Button("9", grid), 2, 2);
-
-                    //grid->pack(new Button("Cl", grid), 0, 3);
-                    grid->pack(new Button("0",  grid), 1, 3);
-                    grid->pack(new Button("Ok", grid), 2, 3);
-
-                    // Begin Option Menu
-                    MenuComponent* menu = new MenuComponent(Rectf(100, 130, 700, 500), tab);
-
-                    SliderMenuItem* music_volume_item = new SliderMenuItem(menu, "Music Volume", 100, 0, 100, 10);
-                    menu->add_item(music_volume_item);
-
-                    SliderMenuItem* sfx_volume_item = new SliderMenuItem(menu, "Sound FX Volume", 100, 0, 100, 10);
-                    menu->add_item(sfx_volume_item);
-
-                    EnumMenuItem* fullscreen_item = new EnumMenuItem(menu, "Fullscreen", 0);
-                    fullscreen_item->add_pair(1, "on");
-                    fullscreen_item->add_pair(0, "off");
-                    menu->add_item(fullscreen_item);
-
-                    EnumMenuItem* fps_item = new EnumMenuItem(menu, "Display Frames per Second", 0);
-                    fps_item->add_pair(1, "on");
-                    fps_item->add_pair(0, "off");
-                    slots.push_back(fps_item->sig_change().connect(this, &ScreenManager::show_fps));
-                    menu->add_item(fps_item);
-
-                    EnumMenuItem* aspect_item = new EnumMenuItem(menu, "Aspect Ratio");
-                    aspect_item->add_pair(0, "4:3");
-                    aspect_item->add_pair(1, "16:9");
-                    aspect_item->add_pair(3, "16:10");
-                    aspect_item->add_pair(2, "letterbox");
-                    menu->add_item(aspect_item);
-
-                    tab->pack("Options", menu);
-                    // End: Option Menu
-
-                    tab->pack("Auto Map",  new Automap(Rectf(100, 130, 700, 500), tab));
-                    tab->pack("Grid Test", grid);
-
-                    ListView* list_view = new ListView(Rectf(), tab);
-                    list_view->add_column("Date");
-                    list_view->add_column("Name");
-                    list_view->add_column("Subject");
-
-                    list_view->add_item(ListView::Item("2005-10-08", "John Doh", "Re: Buying a goldmine"));
-                    list_view->add_item(ListView::Item("2005-13-08", "Jane Doh", "Re: What the f***"));
-                    list_view->add_item(ListView::Item("2005-13-09", "Testo Test", "Testing Email"));
-
-                    tab->pack("ListView", list_view);
-
-                    manager->get_root()->set_child(tab);
-                    text_view->set_text("Hello World\n<large>Blabla</large> more textt and more and"
-                                        "more for testing all for testing even more and more blabla blabla"
-                                        "more for testing all for testing even more and more blabla blabla"
-                                        "blabla blabla blabltest ende.");
-
-                    set_overlay(manager);
-                  }
-                  break;
-
                 case SDLK_F9:
                   set_overlay(new InputConfigurator());
                   break;
@@ -373,11 +291,24 @@
 void
 ScreenManager::set_overlay(Screen* s)
 {
+  // FIXME: need to delete overlay
   next_overlay_screen = s;
   has_next_overlay_screen = true;
 }
 
 void
+ScreenManager::push_overlay(Screen* s)
+{
+  assert(!"Implement me");
+}
+
+void
+ScreenManager::pop_overlay()
+{
+  assert(!"Implement me");
+}
+
+void
 ScreenManager::quit()
 {
   do_quit = true;
@@ -390,4 +321,29 @@
   config.set_bool("show-fps", i);
 }
 
+void
+ScreenManager::menu_start_game()
+{
+  set_overlay(0);
+}
+
+void
+ScreenManager::menu_options()
+{
+  console << "Options cliked" << std::endl;
+}
+
+void
+ScreenManager::menu_credits()
+{
+  console << "Credits clicked" << std::endl;
+}
+
+void
+ScreenManager::menu_quit()
+{
+  GameSession::current()->quit();
+  set_overlay(0);
+}
+
 /* EOF */

Modified: trunk/windstille/src/screen_manager.hpp
===================================================================
--- trunk/windstille/src/screen_manager.hpp	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/screen_manager.hpp	2007-06-10 23:04:41 UTC (rev 1383)
@@ -31,7 +31,10 @@
 
 class Screen;
 
-/** */
+/**
+ *  The ScreenManager handles overlays like Option Menus, Main Menus
+ *  and such
+ */
 class ScreenManager
 {
 private:
@@ -69,8 +72,19 @@
       the current overlay */
   void set_overlay(Screen* s);
   
-  // Callbacks
+  /** Replace the current overlay with a new one */
+  void push_overlay(Screen* s);
+
+  void pop_overlay();
+
+  // Callbacks, FIXME: Could be moved to a seperate class
   void show_fps(int i);
+
+  void menu_start_game();
+  void menu_options();
+  void menu_credits();
+  void menu_quit();
+
 private:
   void poll_events();
   void draw_fps();

Modified: trunk/windstille/src/text_area.cpp
===================================================================
--- trunk/windstille/src/text_area.cpp	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/text_area.cpp	2007-06-10 23:04:41 UTC (rev 1383)
@@ -60,7 +60,7 @@
 TextArea::TextArea(const Rectf& rect, bool letter_by_letter)
   : impl(new TextAreaImpl)
 {
-  impl->font = Fonts::ttfdialog;
+  impl->font = Fonts::vera20;
   impl->rect    = rect;
   // FIXME: freetype might provide info for vspacing, not sure
   impl->v_space = 2;

Modified: trunk/windstille/src/windstille_main.cpp
===================================================================
--- trunk/windstille/src/windstille_main.cpp	2007-06-10 04:20:04 UTC (rev 1382)
+++ trunk/windstille/src/windstille_main.cpp	2007-06-10 23:04:41 UTC (rev 1383)
@@ -32,6 +32,7 @@
 #include "windstille_main.hpp"
 #include "font/fonts.hpp"
 #include "game_session.hpp"
+#include "title_screen.hpp"
 #include "sector.hpp"
 #include "input/input_manager.hpp"
 #include "sound/sound_manager.hpp"
@@ -155,7 +156,8 @@
       {
         if (levelfile.empty())
           {
-            screen_manager.set_screen(new GameSession("levels/newformat2.wst"));
+            //screen_manager.set_screen(new GameSession("levels/newformat2.wst"));
+            screen_manager.set_screen(new TitleScreen());
           }
         else
           {



From grumbel at mail.berlios.de  Mon Jun 11 04:29:52 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 11 Jun 2007 04:29:52 +0200
Subject: [Windstille-commit] r1384 - in trunk/windstille/data: . models
	models/characters models/characters/bob
	models/characters/jane models/characters/yagor models/objects
	models/objects/barrobot models/objects/pistol models/vehicles
	models/vehicles/train scripts scripts/apartment
Message-ID: <200706110229.l5B2TqBw024377@sheep.berlios.de>

Author: grumbel
Date: 2007-06-11 04:28:28 +0200 (Mon, 11 Jun 2007)
New Revision: 1384

Added:
   trunk/windstille/data/models/
   trunk/windstille/data/models/characters/
   trunk/windstille/data/models/characters/bob/
   trunk/windstille/data/models/characters/bob/bob.wsprite
   trunk/windstille/data/models/characters/jane/
   trunk/windstille/data/models/characters/jane/jane.wsprite
   trunk/windstille/data/models/characters/yagor/
   trunk/windstille/data/models/characters/yagor/yagor.wsprite
   trunk/windstille/data/models/objects/
   trunk/windstille/data/models/objects/barrobot/
   trunk/windstille/data/models/objects/barrobot/barrobot.blend1
   trunk/windstille/data/models/objects/barrobot/barrobot.png
   trunk/windstille/data/models/objects/barrobot/barrobot.xcf
   trunk/windstille/data/models/objects/barrobot/barrobotsprite.png
   trunk/windstille/data/models/objects/barrobot/render.png
   trunk/windstille/data/models/objects/pistol/
   trunk/windstille/data/models/objects/pistol/pistol.wsprite
   trunk/windstille/data/models/vehicles/
   trunk/windstille/data/models/vehicles/train/
   trunk/windstille/data/models/vehicles/train/texture.png
   trunk/windstille/data/models/vehicles/train/train.wsprite
   trunk/windstille/data/models/weapons/
   trunk/windstille/data/scripts/apartment/
   trunk/windstille/data/scripts/apartment/barrobot.nut
   trunk/windstille/data/scripts/apartment/init.nut
   trunk/windstille/data/scripts/apartment/yagor.nut
Log:
- added some data files back to the data/ dir

Added: trunk/windstille/data/models/characters/bob/bob.wsprite
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/models/characters/bob/bob.wsprite
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/windstille/data/models/characters/jane/jane.wsprite
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/models/characters/jane/jane.wsprite
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/windstille/data/models/characters/yagor/yagor.wsprite
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/models/characters/yagor/yagor.wsprite
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/windstille/data/models/objects/barrobot/barrobot.blend1
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/models/objects/barrobot/barrobot.blend1
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/windstille/data/models/objects/barrobot/barrobot.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/models/objects/barrobot/barrobot.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/models/objects/barrobot/barrobot.xcf
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/models/objects/barrobot/barrobot.xcf
___________________________________________________________________
Name: svn:mime-type
   + application/x-xcf

Added: trunk/windstille/data/models/objects/barrobot/barrobotsprite.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/models/objects/barrobot/barrobotsprite.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/models/objects/barrobot/render.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/models/objects/barrobot/render.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/models/objects/pistol/pistol.wsprite
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/models/objects/pistol/pistol.wsprite
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/windstille/data/models/vehicles/train/texture.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/models/vehicles/train/texture.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/models/vehicles/train/train.wsprite
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/models/vehicles/train/train.wsprite
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/windstille/data/scripts/apartment/barrobot.nut
===================================================================
--- trunk/windstille/data/scripts/apartment/barrobot.nut	2007-06-10 23:04:41 UTC (rev 1383)
+++ trunk/windstille/data/scripts/apartment/barrobot.nut	2007-06-11 02:28:28 UTC (rev 1384)
@@ -0,0 +1,22 @@
+cutscene_begin();
+
+barrobot <- Dialog(TOP, "Bar Robot", "images/portraits/barrobot.sprite");
+jane  <- Dialog(TOP, "Jane", "images/portraits/jane.sprite");
+
+barrobot.show("Hello how are you?")
+
+// yagor.show("How are you?<sleep>\nEverything fine today?")
+// jane.show("Jep, thanks for asking. Buts its a bit dark here. Do you have a flashlight?")
+// yagor.show("Sure, here take....")
+// fadeout()
+// wait_for_fade()
+// fadein();
+// yagor.show("Here it is.")
+// jane.show("Ok, thanks, time to explore this apartment a bit.")
+
+// objects.flashlight.set_active(true);
+// objects.flashlight.set_parent("player");
+
+cutscene_end();
+
+/* EOF */

Added: trunk/windstille/data/scripts/apartment/init.nut
===================================================================
--- trunk/windstille/data/scripts/apartment/init.nut	2007-06-10 23:04:41 UTC (rev 1383)
+++ trunk/windstille/data/scripts/apartment/init.nut	2007-06-11 02:28:28 UTC (rev 1384)
@@ -0,0 +1,27 @@
+function barrobot()
+{
+  //cutscene_begin();
+
+  barrobot <- Dialog(BOTTOM, "Bar Robot", "images/portraits/barrobot.sprite");
+  jane  <- Dialog(TOP, "Jane", "images/portraits/jane.sprite");
+
+  barrobot.show("Hello how are you?\n" +
+                "<sleep>" +
+                "Do you want a drink?")
+
+    // yagor.show("How are you?<sleep>\nEverything fine today?")
+    // jane.show("Jep, thanks for asking. Buts its a bit dark here. Do you have a flashlight?")
+    // yagor.show("Sure, here take....")
+    // fadeout()
+    // wait_for_fade()
+    // fadein();
+    // yagor.show("Here it is.")
+    // jane.show("Ok, thanks, time to explore this apartment a bit.")
+
+    // objects.flashlight.set_active(true);
+    // objects.flashlight.set_parent("player");
+
+    //cutscene_end();
+}
+
+/* EOF */

Added: trunk/windstille/data/scripts/apartment/yagor.nut
===================================================================
--- trunk/windstille/data/scripts/apartment/yagor.nut	2007-06-10 23:04:41 UTC (rev 1383)
+++ trunk/windstille/data/scripts/apartment/yagor.nut	2007-06-11 02:28:28 UTC (rev 1384)
@@ -0,0 +1,20 @@
+cutscene_begin();
+wait(1);
+yagor <- Dialog(TOP, "Yagor", "images/portraits/yagor.sprite");
+jane  <- Dialog(TOP, "Jane", "images/portraits/jane.sprite");
+
+yagor.show("How are you?<sleep>\nEverything fine today?")
+jane.show("Jep, thanks for asking. Buts its a bit dark here. Do you have a flashlight?")
+yagor.show("Sure, here take....")
+fadeout()
+wait_for_fade()
+fadein();
+yagor.show("Here it is.")
+jane.show("Ok, thanks, time to explore this apartment a bit.")
+
+objects.flashlight.set_active(true);
+objects.flashlight.set_parent("player");
+
+cutscene_end();
+
+/* EOF */



From grumbel at mail.berlios.de  Mon Jun 11 04:30:47 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 11 Jun 2007 04:30:47 +0200
Subject: [Windstille-commit] r1385 - in trunk/windstille/src: . gui input
Message-ID: <200706110230.l5B2Ulr1024454@sheep.berlios.de>

Author: grumbel
Date: 2007-06-11 04:30:46 +0200 (Mon, 11 Jun 2007)
New Revision: 1385

Added:
   trunk/windstille/src/title_screen.cpp
   trunk/windstille/src/title_screen.hpp
Modified:
   trunk/windstille/src/gui/gui_manager.cpp
   trunk/windstille/src/gui/menu_component.cpp
   trunk/windstille/src/gui/menu_component.hpp
   trunk/windstille/src/input/input_configurator.cpp
   trunk/windstille/src/screen_manager.cpp
   trunk/windstille/src/screen_manager.hpp
Log:
- added title screen

Modified: trunk/windstille/src/gui/gui_manager.cpp
===================================================================
--- trunk/windstille/src/gui/gui_manager.cpp	2007-06-11 02:28:28 UTC (rev 1384)
+++ trunk/windstille/src/gui/gui_manager.cpp	2007-06-11 02:30:46 UTC (rev 1385)
@@ -60,7 +60,7 @@
 
   if (!root->is_active())
     { //FIXME: This doesn't work when GUI isn't an overlay
-      screen_manager.set_overlay(0);
+      screen_manager.pop_overlay();
     }
 }
 

Modified: trunk/windstille/src/gui/menu_component.cpp
===================================================================
--- trunk/windstille/src/gui/menu_component.cpp	2007-06-11 02:28:28 UTC (rev 1384)
+++ trunk/windstille/src/gui/menu_component.cpp	2007-06-11 02:30:46 UTC (rev 1385)
@@ -136,7 +136,7 @@
 }
 
 void
-SliderMenuItem::incr()
+SliderMenuItem::decr()
 {
   value += step;
   if (value > max_value)
@@ -145,7 +145,7 @@
 }
 
 void
-SliderMenuItem::decr()
+SliderMenuItem::incr()
 {
   value -= step;
   if (value < min_value)
@@ -170,7 +170,7 @@
       color = Color(0.75f, 0.75f, 0.75f, 1.0f);
     }
 
-  Display::fill_rounded_rect(Rectf(Vector(rect.right - 4 - width, rect.top + 4),
+  Display::fill_rounded_rect(Rectf(Vector(rect.right - 4 - total_width, rect.top + 4),
                                    Sizef(width, rect.get_height() - 8)), 
                              5.0f,
                              Color(0.75f*color.r, 0.75f*color.g, 0.75f*color.b, color.a));
@@ -210,10 +210,11 @@
 {
 }
 
-MenuComponent::MenuComponent(const Rectf& rect, Component* parent)
+MenuComponent::MenuComponent(const Rectf& rect, bool allow_cancel_, Component* parent)
   : Component(rect, parent),
     current_item(0),
-    font(Fonts::vera16)
+    font(Fonts::vera16),
+    allow_cancel(allow_cancel_)
 {
 }
 
@@ -260,7 +261,8 @@
             }
           else if (i->button.name == CANCEL_BUTTON)
             {
-              set_active(false);
+              if (allow_cancel) // FIXME: Could use a signal instead
+                set_active(false);
             }
         }
       else if (i->type == AXIS_EVENT)

Modified: trunk/windstille/src/gui/menu_component.hpp
===================================================================
--- trunk/windstille/src/gui/menu_component.hpp	2007-06-11 02:28:28 UTC (rev 1384)
+++ trunk/windstille/src/gui/menu_component.hpp	2007-06-11 02:30:46 UTC (rev 1385)
@@ -118,8 +118,9 @@
   Items items;
   int   current_item;
   TTFFont* font;
+  bool allow_cancel;
 public:
-  MenuComponent(const Rectf& rect, Component* parent);
+  MenuComponent(const Rectf& rect, bool allow_cancel_, Component* parent);
   virtual ~MenuComponent();
 
   void add_item(MenuItem* item);

Modified: trunk/windstille/src/input/input_configurator.cpp
===================================================================
--- trunk/windstille/src/input/input_configurator.cpp	2007-06-11 02:28:28 UTC (rev 1384)
+++ trunk/windstille/src/input/input_configurator.cpp	2007-06-11 02:30:46 UTC (rev 1385)
@@ -141,7 +141,7 @@
   if (items.empty())
     {
       std::cout << "InputConfigurator: done" << std::endl;
-      screen_manager.set_overlay(0);
+      screen_manager.pop_overlay();
       return; 
     }
   
@@ -228,7 +228,7 @@
       if (event.key.keysym.sym == SDLK_ESCAPE)
         {
           std::cout << "InputConfigurator: abort" << std::endl;
-          screen_manager.set_overlay(0);
+          screen_manager.pop_overlay();
           //next_item();
         }
       else

Modified: trunk/windstille/src/screen_manager.cpp
===================================================================
--- trunk/windstille/src/screen_manager.cpp	2007-06-11 02:28:28 UTC (rev 1384)
+++ trunk/windstille/src/screen_manager.cpp	2007-06-11 02:30:46 UTC (rev 1385)
@@ -63,9 +63,10 @@
     do_quit(false)
 {
   screen = 0;
-  overlay_screen = 0;
-  next_overlay_screen = 0;
-  has_next_overlay_screen = false;
+
+  overlay_screen_action = NONE;
+  overlay_screen_screen = 0;
+
   ticks = 0;
 }
 
@@ -99,8 +100,8 @@
           console.update(step);
           if (!console.is_active())
             {
-              if (overlay_screen)
-                overlay_screen->update(step, InputManager::get_controller());
+              if (!overlay_screens.empty())
+                overlay_screens.back()->update(step, InputManager::get_controller());
               else
                 screen->update(step, InputManager::get_controller());
             }
@@ -115,8 +116,8 @@
 
       screen->draw();
 
-      if (overlay_screen)
-        overlay_screen->draw();
+      if (!overlay_screens.empty())
+        overlay_screens.back()->draw();
 
       console.draw();
 
@@ -126,13 +127,29 @@
       SDL_GL_SwapBuffers();
       frame_counter += 1;
 
-      if (has_next_overlay_screen)
+      // Commit any pending screen actions
+      switch(overlay_screen_action)
         {
-          delete overlay_screen;
-          overlay_screen = next_overlay_screen;
-          next_overlay_screen = 0;
-          has_next_overlay_screen = false;
+        case PUSH_SCREEN:
+          overlay_screens.push_back(overlay_screen_screen);
+          break;
+
+        case POP_SCREEN:
+          overlay_screens.pop_back();
+          break;
+
+        case CLEAR_SCREENS:
+          // FIXME: Might be insecure to do this here instead of in the update() loop
+          for(std::vector<Screen*>::iterator i = overlay_screens.begin(); i != overlay_screens.end(); ++i)
+            delete *i;
+          overlay_screens.clear();
+          break;
+
+        case NONE:
+          // nothing
+          break;
         }
+      overlay_screen_action = NONE;
 
       poll_events();
     }
@@ -190,7 +207,7 @@
                   break;
       
                 case SDLK_F9:
-                  set_overlay(new InputConfigurator());
+                  push_overlay(new InputConfigurator());
                   break;
 
                 case SDLK_F10:
@@ -220,8 +237,8 @@
                 default:
                   if (!console.is_active())
                     {
-                      if (overlay_screen)
-                        overlay_screen->handle_event(event);
+                      if (!overlay_screens.empty())
+                        overlay_screens.back()->handle_event(event);
                       else
                         screen->handle_event(event);
                     }
@@ -251,13 +268,13 @@
           if (InputManagerSDL::current())
             InputManagerSDL::current()->on_event(event);
 
-          if (overlay_screen)
-            overlay_screen->handle_event(event);
+          if (!overlay_screens.empty())
+            overlay_screens.back()->handle_event(event);
           break;
         
         default:
-          if (overlay_screen)
-            overlay_screen->handle_event(event);
+          if (!overlay_screens.empty())
+            overlay_screens.back()->handle_event(event);
           else              
             screen->handle_event(event);
           break;
@@ -289,23 +306,22 @@
 }
 
 void
-ScreenManager::set_overlay(Screen* s)
+ScreenManager::push_overlay(Screen* s)
 {
-  // FIXME: need to delete overlay
-  next_overlay_screen = s;
-  has_next_overlay_screen = true;
+  overlay_screen_action = PUSH_SCREEN;
+  overlay_screen_screen = s;
 }
 
 void
-ScreenManager::push_overlay(Screen* s)
+ScreenManager::pop_overlay()
 {
-  assert(!"Implement me");
+  overlay_screen_action = POP_SCREEN;
 }
 
 void
-ScreenManager::pop_overlay()
+ScreenManager::clear_overlay()
 {
-  assert(!"Implement me");
+  overlay_screen_action = CLEAR_SCREENS;
 }
 
 void
@@ -313,37 +329,5 @@
 {
   do_quit = true;
 }
-
-// Callbacks
-void
-ScreenManager::show_fps(int i)
-{
-  config.set_bool("show-fps", i);
-}
 
-void
-ScreenManager::menu_start_game()
-{
-  set_overlay(0);
-}
-
-void
-ScreenManager::menu_options()
-{
-  console << "Options cliked" << std::endl;
-}
-
-void
-ScreenManager::menu_credits()
-{
-  console << "Credits clicked" << std::endl;
-}
-
-void
-ScreenManager::menu_quit()
-{
-  GameSession::current()->quit();
-  set_overlay(0);
-}
-
 /* EOF */

Modified: trunk/windstille/src/screen_manager.hpp
===================================================================
--- trunk/windstille/src/screen_manager.hpp	2007-06-11 02:28:28 UTC (rev 1384)
+++ trunk/windstille/src/screen_manager.hpp	2007-06-11 02:30:46 UTC (rev 1385)
@@ -41,11 +41,13 @@
   std::vector<Slot> slots;
 
   Screen* screen;
-  Screen* overlay_screen;
 
-  Screen* next_overlay_screen;
-  bool    has_next_overlay_screen;
+  std::vector<Screen*> overlay_screens;
 
+  enum ScreenAction { NONE, POP_SCREEN, PUSH_SCREEN, CLEAR_SCREENS };
+  ScreenAction overlay_screen_action;
+  Screen*      overlay_screen_screen;
+
   unsigned int ticks;
 
   float time_counter;
@@ -67,24 +69,13 @@
   /** Sets the currently active screen */
   void set_screen(Screen* s);
 
-  /** Sets the overlay, which is a screen drawn on-top of the current
-      screen, usefull for menus or console, use set_overlay(0) to kill
-      the current overlay */
-  void set_overlay(Screen* s);
-  
-  /** Replace the current overlay with a new one */
   void push_overlay(Screen* s);
-
   void pop_overlay();
+  void clear_overlay();
 
   // Callbacks, FIXME: Could be moved to a seperate class
   void show_fps(int i);
 
-  void menu_start_game();
-  void menu_options();
-  void menu_credits();
-  void menu_quit();
-
 private:
   void poll_events();
   void draw_fps();

Added: trunk/windstille/src/title_screen.cpp
===================================================================
--- trunk/windstille/src/title_screen.cpp	2007-06-11 02:28:28 UTC (rev 1384)
+++ trunk/windstille/src/title_screen.cpp	2007-06-11 02:30:46 UTC (rev 1385)
@@ -0,0 +1,210 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include <iostream>
+#include "config.hpp"
+#include "console.hpp"
+#include "font/fonts.hpp"
+#include "gui/gui_manager.hpp"
+#include "gui/root_component.hpp"
+#include "screen_manager.hpp"
+#include "gui/menu_component.hpp"
+#include "game_session.hpp"
+#include "title_screen.hpp"
+
+TitleScreen::TitleScreen()
+{
+  background = Sprite("images/titlescreen.sprite");
+  on_start();
+}
+
+TitleScreen::~TitleScreen()
+{
+}
+
+void
+TitleScreen::on_start()
+{
+  using namespace GUI;
+  GUIManager* manager = new GUIManager();
+
+  // Begin Main Menu
+  MenuComponent* menu = new MenuComponent(Rectf(Vector(400, 250), Sizef(200, 500)), false,
+                                          manager->get_root());
+
+  menu->set_font(Fonts::vera20);
+
+  ButtonMenuItem* select_scenario_button = new ButtonMenuItem(menu,  "Select Scenario");
+  slots.push_back(select_scenario_button->sig_click().connect(this, &TitleScreen::menu_select_scenario));
+  menu->add_item(select_scenario_button);
+
+  ButtonMenuItem* options_button = new ButtonMenuItem(menu,  "Options");
+  slots.push_back(options_button->sig_click().connect(this, &TitleScreen::menu_options));
+  menu->add_item(options_button);
+
+  ButtonMenuItem* credits_button = new ButtonMenuItem(menu,  "Credits");
+  slots.push_back(credits_button->sig_click().connect(this, &TitleScreen::menu_credits));
+  menu->add_item(credits_button);
+
+  ButtonMenuItem* quit_button = new ButtonMenuItem(menu,  "Quit");
+  slots.push_back(quit_button->sig_click().connect(this, &TitleScreen::menu_quit));
+  menu->add_item(quit_button);
+  // End: Option Menu
+
+  manager->get_root()->set_child(menu);
+
+  screen_manager.push_overlay(manager);
+}
+
+void
+TitleScreen::draw()
+{
+  background.draw(Vector(0, 0));
+}
+
+void
+TitleScreen::update(float delta, const Controller& controller)
+{
+  background.update(delta);
+}
+
+void
+TitleScreen::handle_event(const SDL_Event& )
+{
+  
+}
+
+void
+TitleScreen::menu_start_game()
+{
+  screen_manager.set_screen(new GameSession("levels/newformat2.wst"));
+  screen_manager.pop_overlay();
+}
+
+void
+TitleScreen::menu_select_scenario()
+{
+  using namespace GUI;
+  GUIManager* manager = new GUIManager();
+
+  MenuComponent* menu = new MenuComponent(Rectf(Vector(500-200, 250), Sizef(400, 500)), true,
+                                          manager->get_root());
+
+  menu->set_font(Fonts::vera20);
+
+  std::vector<std::string> scenarios;
+  scenarios.push_back("levels/apartment.wst");
+  scenarios.push_back("levels/bluestone.wst");
+  scenarios.push_back("levels/forest.wst");
+  scenarios.push_back("levels/industrial.wst");
+  scenarios.push_back("levels/intro.wst");
+  scenarios.push_back("levels/virtualreality.wst");
+  
+  for(std::vector<std::string>::iterator i = scenarios.begin(); i != scenarios.end(); ++i)
+    {
+      ButtonMenuItem* scenario_button = new ButtonMenuItem(menu,  *i);
+
+      slots.push_back(scenario_button->sig_click().connect<TitleScreen, std::string>
+                      (this, &TitleScreen::menu_start_scenario, 
+                       std::string(*i)));
+
+      menu->add_item(scenario_button);
+    }
+
+  manager->get_root()->set_child(menu);
+
+  screen_manager.push_overlay(manager);
+}
+
+void
+TitleScreen::menu_options()
+{
+  using namespace GUI;
+  GUIManager* manager = new GUIManager();
+
+  // Begin Main Menu
+  MenuComponent* menu = new MenuComponent(Rectf(Vector(500-200, 250), Sizef(400, 500)), true,
+                                          manager->get_root());
+
+  menu->set_font(Fonts::vera20);
+
+  SliderMenuItem* music_volume_item = new SliderMenuItem(menu,  "Music Volume", 100, 0, 100, 10);
+  menu->add_item(music_volume_item);
+
+  SliderMenuItem* sfx_volume_item   = new SliderMenuItem(menu,  "SFX Volume",   100, 0, 100, 10);
+  menu->add_item(sfx_volume_item);
+
+  SliderMenuItem* voice_volume_item = new SliderMenuItem(menu,  "Voice Volume", 100, 0, 100, 10);
+  menu->add_item(voice_volume_item);
+
+  EnumMenuItem* aspect_item = new EnumMenuItem(menu,  "Aspect Ratio", 0);
+  aspect_item->add_pair(0, "4:3");
+  aspect_item->add_pair(1, "5:4");
+  aspect_item->add_pair(2, "16:9");
+  aspect_item->add_pair(3, "16:10");
+  aspect_item->add_pair(4, "letterbox");
+  menu->add_item(aspect_item);
+  
+  EnumMenuItem* show_fps_item = new EnumMenuItem(menu,  "Show FPS", 0);
+  show_fps_item->add_pair(1, "on");
+  show_fps_item->add_pair(0, "off");
+  menu->add_item(show_fps_item);
+  slots.push_back(show_fps_item->sig_change().connect(this, &TitleScreen::menu_show_fps));
+
+  manager->get_root()->set_child(menu);
+
+  screen_manager.push_overlay(manager);
+}
+
+void
+TitleScreen::menu_credits()
+{
+  console << "Credits clicked" << std::endl;
+}
+
+void
+TitleScreen::menu_quit()
+{
+  //GameSession::current()->quit();
+  screen_manager.pop_overlay();
+  screen_manager.quit();
+}
+
+void
+TitleScreen::menu_start_scenario(std::string scenario)
+{
+  std::cout << "Starting: " << scenario << std::endl;
+  screen_manager.set_screen(new GameSession(scenario));
+  screen_manager.clear_overlay();
+ }
+
+void
+TitleScreen::menu_show_fps(int i)
+{
+  std::cout << i << std::endl;
+  config.set_bool("show-fps", i);
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/title_screen.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/title_screen.hpp
===================================================================
--- trunk/windstille/src/title_screen.hpp	2007-06-11 02:28:28 UTC (rev 1384)
+++ trunk/windstille/src/title_screen.hpp	2007-06-11 02:30:46 UTC (rev 1385)
@@ -0,0 +1,70 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_TITLE_SCREEN_HPP
+#define HEADER_TITLE_SCREEN_HPP
+
+#include "sprite2d/sprite.hpp"
+#include "screen.hpp"
+
+#include <vector>
+#include "signals/slot.hpp"
+
+/** */
+class TitleScreen : public Screen
+{
+private:
+  std::vector<Slot> slots;
+
+  Sprite background;
+
+public:
+  TitleScreen();
+  ~TitleScreen();
+
+  void on_start();
+
+  void draw();
+  void update(float delta, const Controller& controller);
+
+  void handle_event(const SDL_Event& );
+
+  // Callbacks
+  void menu_start_game();
+  void menu_select_scenario();
+  void menu_options();
+  void menu_credits();
+  void menu_quit();
+  void menu_show_fps(int i);
+
+  void menu_start_scenario(std::string scenario);
+private:
+  TitleScreen (const TitleScreen&);
+  TitleScreen& operator= (const TitleScreen&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/title_screen.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Mon Jun 11 04:32:33 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 11 Jun 2007 04:32:33 +0200
Subject: [Windstille-commit] r1386 - in trunk/windstille: . lib tools
Message-ID: <200706110232.l5B2WX7F024605@sheep.berlios.de>

Author: grumbel
Date: 2007-06-11 04:32:33 +0200 (Mon, 11 Jun 2007)
New Revision: 1386

Added:
   trunk/windstille/tools/bone_export.py
Modified:
   trunk/windstille/
   trunk/windstille/lib/
Log:
- unfinished bone export script
- some svn:ignore


Property changes on: trunk/windstille
___________________________________________________________________
Name: svn:ignore
   - windstille

   + 
.sconsign.dblite
windstille



Property changes on: trunk/windstille/lib
___________________________________________________________________
Name: svn:ignore
   + libglew.a


Added: trunk/windstille/tools/bone_export.py
===================================================================
--- trunk/windstille/tools/bone_export.py	2007-06-11 02:30:46 UTC (rev 1385)
+++ trunk/windstille/tools/bone_export.py	2007-06-11 02:32:33 UTC (rev 1386)
@@ -0,0 +1,25 @@
+import Blender
+import Blender.Armature
+
+arms = Blender.Armature.Get()
+print "####################################"
+for arm in arms.values():
+	print "Armature: %s" % arm.name
+	for bone in arm.bones.values():
+		print "  Bone: %s" % bone
+		print "  BoneSpace:"
+		print bone.matrix['BONESPACE']
+		print
+		print "  ArmatureSpace:"
+		print bone.matrix['ARMATURESPACE']
+		print
+	print
+
+mesh = Blender.NMesh.GetRaw("Cube.001")
+print mesh.faces[0].v[0].index
+
+for v in mesh.verts:
+	mesh.getVertexInfluences(v.index)
+	
+# EOF #
+



From grumbel at mail.berlios.de  Mon Jun 11 04:47:15 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 11 Jun 2007 04:47:15 +0200
Subject: [Windstille-commit] r1387 - trunk/windstille/src
Message-ID: <200706110247.l5B2lFME025328@sheep.berlios.de>

Author: grumbel
Date: 2007-06-11 04:47:15 +0200 (Mon, 11 Jun 2007)
New Revision: 1387

Modified:
   trunk/windstille/src/game_session.cpp
   trunk/windstille/src/title_screen.cpp
   trunk/windstille/src/title_screen.hpp
Log:
- added fullscreen to the option menu

Modified: trunk/windstille/src/game_session.cpp
===================================================================
--- trunk/windstille/src/game_session.cpp	2007-06-11 02:32:33 UTC (rev 1386)
+++ trunk/windstille/src/game_session.cpp	2007-06-11 02:47:15 UTC (rev 1387)
@@ -286,7 +286,10 @@
     }
 
   if(keystate[SDLK_ESCAPE])
-    GameSession::current()->quit();
+    {
+      // FIXME: Display pause/option menu here
+      GameSession::current()->quit();
+    }
 }
 
 void

Modified: trunk/windstille/src/title_screen.cpp
===================================================================
--- trunk/windstille/src/title_screen.cpp	2007-06-11 02:32:33 UTC (rev 1386)
+++ trunk/windstille/src/title_screen.cpp	2007-06-11 02:47:15 UTC (rev 1387)
@@ -26,6 +26,7 @@
 #include <iostream>
 #include "config.hpp"
 #include "console.hpp"
+#include "display/display.hpp"
 #include "font/fonts.hpp"
 #include "gui/gui_manager.hpp"
 #include "gui/root_component.hpp"
@@ -167,12 +168,18 @@
   aspect_item->add_pair(4, "letterbox");
   menu->add_item(aspect_item);
   
-  EnumMenuItem* show_fps_item = new EnumMenuItem(menu,  "Show FPS", 0);
+  EnumMenuItem* show_fps_item = new EnumMenuItem(menu,  "Show FPS", config.get_bool("show-fps"));
   show_fps_item->add_pair(1, "on");
   show_fps_item->add_pair(0, "off");
   menu->add_item(show_fps_item);
   slots.push_back(show_fps_item->sig_change().connect(this, &TitleScreen::menu_show_fps));
 
+  EnumMenuItem* fullscreen_item = new EnumMenuItem(menu,  "Fullscreen", config.get_bool("fullscreen"));
+  fullscreen_item->add_pair(1, "on");
+  fullscreen_item->add_pair(0, "off");
+  menu->add_item(fullscreen_item);
+  slots.push_back(fullscreen_item->sig_change().connect(this, &TitleScreen::menu_fullscreen));
+
   manager->get_root()->set_child(menu);
 
   screen_manager.push_overlay(manager);
@@ -203,8 +210,14 @@
 void
 TitleScreen::menu_show_fps(int i)
 {
-  std::cout << i << std::endl;
   config.set_bool("show-fps", i);
 }
 
+void
+TitleScreen::menu_fullscreen(int i)
+{
+  config.set_bool("fullscreen", i);
+  Display::set_fullscreen(config.get_bool("fullscreen"));
+}
+
 /* EOF */

Modified: trunk/windstille/src/title_screen.hpp
===================================================================
--- trunk/windstille/src/title_screen.hpp	2007-06-11 02:32:33 UTC (rev 1386)
+++ trunk/windstille/src/title_screen.hpp	2007-06-11 02:47:15 UTC (rev 1387)
@@ -58,6 +58,7 @@
   void menu_credits();
   void menu_quit();
   void menu_show_fps(int i);
+  void menu_fullscreen(int i);
 
   void menu_start_scenario(std::string scenario);
 private:



From grumbel at mail.berlios.de  Mon Jun 11 15:49:42 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 11 Jun 2007 15:49:42 +0200
Subject: [Windstille-commit] r1388 - in trunk/windstille: . src
Message-ID: <200706111349.l5BDngqT008376@sheep.berlios.de>

Author: grumbel
Date: 2007-06-11 15:49:41 +0200 (Mon, 11 Jun 2007)
New Revision: 1388

Added:
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/menu_manager.hpp
Modified:
   trunk/windstille/
   trunk/windstille/src/SConscript
   trunk/windstille/src/game_session.cpp
   trunk/windstille/src/title_screen.cpp
   trunk/windstille/src/title_screen.hpp
Log:
- added pause menu
- moved menu code in a separate class


Property changes on: trunk/windstille
___________________________________________________________________
Name: svn:ignore
   - 
.sconsign.dblite
windstille

   + 
cache/
.sconsign.dblite
windstille


Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-11 02:47:15 UTC (rev 1387)
+++ trunk/windstille/src/SConscript	2007-06-11 13:49:41 UTC (rev 1388)
@@ -148,6 +148,7 @@
 'math/quaternion.cpp',
 'math/rect.cpp',
 'math/vector.cpp',
+'menu_manager.cpp',
 'particle_viewer.cpp',
 'particles/particle_system.cpp',
 'particles/spark_drawer.cpp',

Modified: trunk/windstille/src/game_session.cpp
===================================================================
--- trunk/windstille/src/game_session.cpp	2007-06-11 02:47:15 UTC (rev 1387)
+++ trunk/windstille/src/game_session.cpp	2007-06-11 13:49:41 UTC (rev 1388)
@@ -31,6 +31,7 @@
 #include <sqstdio.h> 
 #include <sqstdaux.h> 
 
+#include "menu_manager.hpp"
 #include "font/fonts.hpp"
 #include "sector.hpp"
 #include "console.hpp"
@@ -287,8 +288,7 @@
 
   if(keystate[SDLK_ESCAPE])
     {
-      // FIXME: Display pause/option menu here
-      GameSession::current()->quit();
+      menu_manager.display_pause_menu();
     }
 }
 

Added: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-11 02:47:15 UTC (rev 1387)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-11 13:49:41 UTC (rev 1388)
@@ -0,0 +1,309 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include "config.hpp"
+#include "console.hpp"
+#include "display/display.hpp"
+#include "font/fonts.hpp"
+#include "gui/gui_manager.hpp"
+#include "gui/root_component.hpp"
+#include "screen_manager.hpp"
+#include "gui/menu_component.hpp"
+#include "game_session.hpp"
+#include "sector.hpp"
+#include "menu_manager.hpp"
+
+MenuManager menu_manager;
+
+MenuManager::MenuManager()
+{
+}
+
+void
+MenuManager::display_option_menu()
+{
+  using namespace GUI;
+  GUIManager* manager = new GUIManager();
+
+  // Begin Main Menu
+  MenuComponent* menu = new MenuComponent(Rectf(Vector(400-200, 200), Sizef(400, 500)), true,
+                                          manager->get_root());
+
+  menu->set_font(Fonts::vera20);
+
+  SliderMenuItem* music_volume_item = new SliderMenuItem(menu,  "Music Volume", 100, 0, 100, 10);
+  menu->add_item(music_volume_item);
+
+  SliderMenuItem* sfx_volume_item   = new SliderMenuItem(menu,  "SFX Volume",   100, 0, 100, 10);
+  menu->add_item(sfx_volume_item);
+
+  SliderMenuItem* voice_volume_item = new SliderMenuItem(menu,  "Voice Volume", 100, 0, 100, 10);
+  menu->add_item(voice_volume_item);
+
+  EnumMenuItem* aspect_item = new EnumMenuItem(menu,  "Aspect Ratio", 0);
+  aspect_item->add_pair(0, "4:3");
+  aspect_item->add_pair(1, "5:4");
+  aspect_item->add_pair(2, "16:9");
+  aspect_item->add_pair(3, "16:10");
+  aspect_item->add_pair(4, "letterbox");
+  menu->add_item(aspect_item);
+  
+  EnumMenuItem* show_fps_item = new EnumMenuItem(menu,  "Show FPS", config.get_bool("show-fps"));
+  show_fps_item->add_pair(1, "on");
+  show_fps_item->add_pair(0, "off");
+  menu->add_item(show_fps_item);
+  slots.push_back(show_fps_item->sig_change().connect(this, &MenuManager::menu_show_fps));
+
+  EnumMenuItem* fullscreen_item = new EnumMenuItem(menu,  "Fullscreen", config.get_bool("fullscreen"));
+  fullscreen_item->add_pair(1, "on");
+  fullscreen_item->add_pair(0, "off");
+  menu->add_item(fullscreen_item);
+  slots.push_back(fullscreen_item->sig_change().connect(this, &MenuManager::menu_fullscreen));
+
+  manager->get_root()->set_child(menu);
+
+  screen_manager.push_overlay(manager);
+}
+
+void
+MenuManager::display_main_menu()
+{
+  using namespace GUI;
+  GUIManager* manager = new GUIManager();
+
+  // Begin Main Menu
+  MenuComponent* menu = new MenuComponent(Rectf(Vector(400, 250), Sizef(200, 500)), false,
+                                          manager->get_root());
+
+  menu->set_font(Fonts::vera20);
+
+  ButtonMenuItem* select_scenario_button = new ButtonMenuItem(menu,  "Select Scenario");
+  slots.push_back(select_scenario_button->sig_click().connect(this, &MenuManager::display_scenario_menu));
+  menu->add_item(select_scenario_button);
+
+  ButtonMenuItem* options_button = new ButtonMenuItem(menu,  "Options");
+  slots.push_back(options_button->sig_click().connect(this, &MenuManager::display_option_menu));
+  menu->add_item(options_button);
+
+  ButtonMenuItem* credits_button = new ButtonMenuItem(menu,  "Credits");
+  slots.push_back(credits_button->sig_click().connect(this, &MenuManager::menu_credits));
+  menu->add_item(credits_button);
+
+  ButtonMenuItem* quit_button = new ButtonMenuItem(menu,  "Quit");
+  slots.push_back(quit_button->sig_click().connect(this, &MenuManager::menu_quit));
+  menu->add_item(quit_button);
+  // End: Option Menu
+
+  manager->get_root()->set_child(menu);
+
+  screen_manager.push_overlay(manager);
+}
+
+void
+MenuManager::display_pause_menu()
+{
+  using namespace GUI;
+  GUIManager* manager = new GUIManager();
+
+  // Begin Main Menu
+  MenuComponent* menu = new MenuComponent(Rectf(Vector(400-150, 200), Sizef(300, 500)), true,
+                                          manager->get_root());
+
+  menu->set_font(Fonts::vera20);
+
+  ButtonMenuItem* continue_button = new ButtonMenuItem(menu,  "Resume Game");
+  slots.push_back(continue_button->sig_click().connect(this, &MenuManager::menu_continue));
+  menu->add_item(continue_button);
+
+  ButtonMenuItem* select_scenario_button = new ButtonMenuItem(menu,  "Select Scenario");
+  slots.push_back(select_scenario_button->sig_click().connect(this, &MenuManager::display_scenario_menu));
+  menu->add_item(select_scenario_button);
+
+  ButtonMenuItem* options_button = new ButtonMenuItem(menu,  "Options");
+  slots.push_back(options_button->sig_click().connect(this, &MenuManager::display_option_menu));
+  menu->add_item(options_button);
+
+  ButtonMenuItem* debug_button = new ButtonMenuItem(menu,  "Debug");
+  slots.push_back(debug_button->sig_click().connect(this, &MenuManager::display_debug_menu));
+  menu->add_item(debug_button);
+
+  ButtonMenuItem* credits_button = new ButtonMenuItem(menu,  "Credits");
+  slots.push_back(credits_button->sig_click().connect(this, &MenuManager::menu_credits));
+  menu->add_item(credits_button);
+
+  ButtonMenuItem* quit_button = new ButtonMenuItem(menu,  "Return to Title Screen");
+  slots.push_back(quit_button->sig_click().connect(this, &MenuManager::menu_exit));
+  menu->add_item(quit_button);
+  // End: Option Menu
+
+  manager->get_root()->set_child(menu);
+
+  screen_manager.push_overlay(manager); 
+}
+
+void
+MenuManager::display_scenario_menu()
+{
+  using namespace GUI;
+  GUIManager* manager = new GUIManager();
+
+  MenuComponent* menu = new MenuComponent(Rectf(Vector(400-200, 200), Sizef(400, 500)), true,
+                                          manager->get_root());
+
+  menu->set_font(Fonts::vera20);
+
+  std::vector<std::string> scenarios;
+  scenarios.push_back("levels/apartment.wst");
+  scenarios.push_back("levels/bluestone.wst");
+  scenarios.push_back("levels/forest.wst");
+  scenarios.push_back("levels/industrial.wst");
+  scenarios.push_back("levels/intro.wst");
+  scenarios.push_back("levels/newformat2.wst");
+  scenarios.push_back("levels/virtualreality.wst");
+  
+  for(std::vector<std::string>::iterator i = scenarios.begin(); i != scenarios.end(); ++i)
+    {
+      ButtonMenuItem* scenario_button = new ButtonMenuItem(menu,  *i);
+
+      slots.push_back(scenario_button->sig_click().connect<MenuManager, std::string>
+                      (this, &MenuManager::menu_start_scenario, 
+                       std::string(*i)));
+
+      menu->add_item(scenario_button);
+    }
+
+  manager->get_root()->set_child(menu);
+
+  screen_manager.push_overlay(manager); 
+}
+
+void
+MenuManager::display_debug_menu()
+{
+  using namespace GUI;
+  GUIManager* manager = new GUIManager();
+
+  // Begin Main Menu
+  MenuComponent* menu = new MenuComponent(Rectf(Vector(400-300, 200), Sizef(600, 500)), true,
+                                          manager->get_root());
+
+  menu->set_font(Fonts::vera20);
+
+  Color amb = Sector::current()->get_ambient_light();
+
+  SliderMenuItem* r_ambient_light_item = new SliderMenuItem(menu,  "Ambient Light (Red)", int(amb.r*100), 0, 100, 10);
+  slots.push_back(r_ambient_light_item->sig_change().connect(this, &MenuManager::menu_ambient_light, 0));
+  menu->add_item(r_ambient_light_item);
+
+  SliderMenuItem* g_ambient_light_item = new SliderMenuItem(menu,  "Ambient Light (Green)", int(amb.g*100), 0, 100, 10);
+  slots.push_back(g_ambient_light_item->sig_change().connect(this, &MenuManager::menu_ambient_light, 1));
+  menu->add_item(g_ambient_light_item);
+
+  SliderMenuItem* b_ambient_light_item = new SliderMenuItem(menu,  "Ambient Light (Blue)", int(amb.b*100), 0, 100, 10);
+  slots.push_back(b_ambient_light_item->sig_change().connect(this, &MenuManager::menu_ambient_light, 2));
+  menu->add_item(b_ambient_light_item);
+
+  manager->get_root()->set_child(menu);
+
+  screen_manager.push_overlay(manager); 
+}
+
+// Callbacks
+
+void
+MenuManager::menu_start_game()
+{
+  screen_manager.set_screen(new GameSession("levels/newformat2.wst"));
+  screen_manager.pop_overlay();
+}
+
+void
+MenuManager::menu_credits()
+{
+  console << "Credits clicked" << std::endl;
+}
+
+void
+MenuManager::menu_quit()
+{
+  //GameSession::current()->quit();
+  screen_manager.pop_overlay();
+  screen_manager.quit();
+}
+
+void
+MenuManager::menu_start_scenario(std::string scenario)
+{
+  std::cout << "Starting: " << scenario << std::endl;
+  screen_manager.set_screen(new GameSession(scenario));
+  screen_manager.clear_overlay();
+ }
+
+void
+MenuManager::menu_show_fps(int i)
+{
+  config.set_bool("show-fps", i);
+}
+
+void
+MenuManager::menu_fullscreen(int i)
+{
+  config.set_bool("fullscreen", i);
+  Display::set_fullscreen(config.get_bool("fullscreen"));
+}
+
+void
+MenuManager::menu_continue()
+{
+  screen_manager.pop_overlay();
+}
+
+void
+MenuManager::menu_exit()
+{
+  // FIXME: Make this return to the title screen
+  screen_manager.pop_overlay();
+  screen_manager.quit(); 
+}
+
+void
+MenuManager::menu_ambient_light(int i, int component)
+{
+  if (Sector::current())
+    {
+      Color amb = Sector::current()->get_ambient_light();
+
+      if (component == 0)
+        amb.r = i / 100.0f;
+      else if (component == 1)
+        amb.g = i / 100.0f;
+      else if (component == 2)
+        amb.b = i / 100.0f;
+
+      Sector::current()->set_ambient_light(amb);
+    }
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/menu_manager.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/menu_manager.hpp
===================================================================
--- trunk/windstille/src/menu_manager.hpp	2007-06-11 02:47:15 UTC (rev 1387)
+++ trunk/windstille/src/menu_manager.hpp	2007-06-11 13:49:41 UTC (rev 1388)
@@ -0,0 +1,67 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_WINDSTILLE_MENU_MANAGER_HPP
+#define HEADER_WINDSTILLE_MENU_MANAGER_HPP
+
+#include <vector>
+#include "signals/slot.hpp"
+
+/** */
+class MenuManager
+{
+private:
+  std::vector<Slot> slots;
+
+public:
+  MenuManager();
+
+  void display_option_menu();
+  void display_debug_menu();
+  void display_main_menu();
+  void display_pause_menu();
+  void display_scenario_menu();
+
+  // Callbacks
+  void menu_start_game();
+  void menu_credits();
+  void menu_quit();
+  void menu_exit();
+  void menu_show_fps(int i);
+  void menu_fullscreen(int i);
+  void menu_continue();
+  void menu_ambient_light(int i, int component);
+  void menu_start_scenario(std::string scenario);
+
+private:
+  MenuManager (const MenuManager&);
+  MenuManager& operator= (const MenuManager&);
+};
+
+extern MenuManager menu_manager;
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/menu_manager.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/title_screen.cpp
===================================================================
--- trunk/windstille/src/title_screen.cpp	2007-06-11 02:47:15 UTC (rev 1387)
+++ trunk/windstille/src/title_screen.cpp	2007-06-11 13:49:41 UTC (rev 1388)
@@ -24,15 +24,7 @@
 */
 
 #include <iostream>
-#include "config.hpp"
-#include "console.hpp"
-#include "display/display.hpp"
-#include "font/fonts.hpp"
-#include "gui/gui_manager.hpp"
-#include "gui/root_component.hpp"
-#include "screen_manager.hpp"
-#include "gui/menu_component.hpp"
-#include "game_session.hpp"
+#include "menu_manager.hpp"
 #include "title_screen.hpp"
 
 TitleScreen::TitleScreen()
@@ -48,35 +40,7 @@
 void
 TitleScreen::on_start()
 {
-  using namespace GUI;
-  GUIManager* manager = new GUIManager();
-
-  // Begin Main Menu
-  MenuComponent* menu = new MenuComponent(Rectf(Vector(400, 250), Sizef(200, 500)), false,
-                                          manager->get_root());
-
-  menu->set_font(Fonts::vera20);
-
-  ButtonMenuItem* select_scenario_button = new ButtonMenuItem(menu,  "Select Scenario");
-  slots.push_back(select_scenario_button->sig_click().connect(this, &TitleScreen::menu_select_scenario));
-  menu->add_item(select_scenario_button);
-
-  ButtonMenuItem* options_button = new ButtonMenuItem(menu,  "Options");
-  slots.push_back(options_button->sig_click().connect(this, &TitleScreen::menu_options));
-  menu->add_item(options_button);
-
-  ButtonMenuItem* credits_button = new ButtonMenuItem(menu,  "Credits");
-  slots.push_back(credits_button->sig_click().connect(this, &TitleScreen::menu_credits));
-  menu->add_item(credits_button);
-
-  ButtonMenuItem* quit_button = new ButtonMenuItem(menu,  "Quit");
-  slots.push_back(quit_button->sig_click().connect(this, &TitleScreen::menu_quit));
-  menu->add_item(quit_button);
-  // End: Option Menu
-
-  manager->get_root()->set_child(menu);
-
-  screen_manager.push_overlay(manager);
+  menu_manager.display_main_menu();
 }
 
 void
@@ -97,127 +61,4 @@
   
 }
 
-void
-TitleScreen::menu_start_game()
-{
-  screen_manager.set_screen(new GameSession("levels/newformat2.wst"));
-  screen_manager.pop_overlay();
-}
-
-void
-TitleScreen::menu_select_scenario()
-{
-  using namespace GUI;
-  GUIManager* manager = new GUIManager();
-
-  MenuComponent* menu = new MenuComponent(Rectf(Vector(500-200, 250), Sizef(400, 500)), true,
-                                          manager->get_root());
-
-  menu->set_font(Fonts::vera20);
-
-  std::vector<std::string> scenarios;
-  scenarios.push_back("levels/apartment.wst");
-  scenarios.push_back("levels/bluestone.wst");
-  scenarios.push_back("levels/forest.wst");
-  scenarios.push_back("levels/industrial.wst");
-  scenarios.push_back("levels/intro.wst");
-  scenarios.push_back("levels/virtualreality.wst");
-  
-  for(std::vector<std::string>::iterator i = scenarios.begin(); i != scenarios.end(); ++i)
-    {
-      ButtonMenuItem* scenario_button = new ButtonMenuItem(menu,  *i);
-
-      slots.push_back(scenario_button->sig_click().connect<TitleScreen, std::string>
-                      (this, &TitleScreen::menu_start_scenario, 
-                       std::string(*i)));
-
-      menu->add_item(scenario_button);
-    }
-
-  manager->get_root()->set_child(menu);
-
-  screen_manager.push_overlay(manager);
-}
-
-void
-TitleScreen::menu_options()
-{
-  using namespace GUI;
-  GUIManager* manager = new GUIManager();
-
-  // Begin Main Menu
-  MenuComponent* menu = new MenuComponent(Rectf(Vector(500-200, 250), Sizef(400, 500)), true,
-                                          manager->get_root());
-
-  menu->set_font(Fonts::vera20);
-
-  SliderMenuItem* music_volume_item = new SliderMenuItem(menu,  "Music Volume", 100, 0, 100, 10);
-  menu->add_item(music_volume_item);
-
-  SliderMenuItem* sfx_volume_item   = new SliderMenuItem(menu,  "SFX Volume",   100, 0, 100, 10);
-  menu->add_item(sfx_volume_item);
-
-  SliderMenuItem* voice_volume_item = new SliderMenuItem(menu,  "Voice Volume", 100, 0, 100, 10);
-  menu->add_item(voice_volume_item);
-
-  EnumMenuItem* aspect_item = new EnumMenuItem(menu,  "Aspect Ratio", 0);
-  aspect_item->add_pair(0, "4:3");
-  aspect_item->add_pair(1, "5:4");
-  aspect_item->add_pair(2, "16:9");
-  aspect_item->add_pair(3, "16:10");
-  aspect_item->add_pair(4, "letterbox");
-  menu->add_item(aspect_item);
-  
-  EnumMenuItem* show_fps_item = new EnumMenuItem(menu,  "Show FPS", config.get_bool("show-fps"));
-  show_fps_item->add_pair(1, "on");
-  show_fps_item->add_pair(0, "off");
-  menu->add_item(show_fps_item);
-  slots.push_back(show_fps_item->sig_change().connect(this, &TitleScreen::menu_show_fps));
-
-  EnumMenuItem* fullscreen_item = new EnumMenuItem(menu,  "Fullscreen", config.get_bool("fullscreen"));
-  fullscreen_item->add_pair(1, "on");
-  fullscreen_item->add_pair(0, "off");
-  menu->add_item(fullscreen_item);
-  slots.push_back(fullscreen_item->sig_change().connect(this, &TitleScreen::menu_fullscreen));
-
-  manager->get_root()->set_child(menu);
-
-  screen_manager.push_overlay(manager);
-}
-
-void
-TitleScreen::menu_credits()
-{
-  console << "Credits clicked" << std::endl;
-}
-
-void
-TitleScreen::menu_quit()
-{
-  //GameSession::current()->quit();
-  screen_manager.pop_overlay();
-  screen_manager.quit();
-}
-
-void
-TitleScreen::menu_start_scenario(std::string scenario)
-{
-  std::cout << "Starting: " << scenario << std::endl;
-  screen_manager.set_screen(new GameSession(scenario));
-  screen_manager.clear_overlay();
- }
-
-void
-TitleScreen::menu_show_fps(int i)
-{
-  config.set_bool("show-fps", i);
-}
-
-void
-TitleScreen::menu_fullscreen(int i)
-{
-  config.set_bool("fullscreen", i);
-  Display::set_fullscreen(config.get_bool("fullscreen"));
-}
-
 /* EOF */

Modified: trunk/windstille/src/title_screen.hpp
===================================================================
--- trunk/windstille/src/title_screen.hpp	2007-06-11 02:47:15 UTC (rev 1387)
+++ trunk/windstille/src/title_screen.hpp	2007-06-11 13:49:41 UTC (rev 1388)
@@ -29,15 +29,10 @@
 #include "sprite2d/sprite.hpp"
 #include "screen.hpp"
 
-#include <vector>
-#include "signals/slot.hpp"
-
 /** */
 class TitleScreen : public Screen
 {
 private:
-  std::vector<Slot> slots;
-
   Sprite background;
 
 public:
@@ -51,16 +46,6 @@
 
   void handle_event(const SDL_Event& );
 
-  // Callbacks
-  void menu_start_game();
-  void menu_select_scenario();
-  void menu_options();
-  void menu_credits();
-  void menu_quit();
-  void menu_show_fps(int i);
-  void menu_fullscreen(int i);
-
-  void menu_start_scenario(std::string scenario);
 private:
   TitleScreen (const TitleScreen&);
   TitleScreen& operator= (const TitleScreen&);



From grumbel at mail.berlios.de  Mon Jun 11 17:36:31 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 11 Jun 2007 17:36:31 +0200
Subject: [Windstille-commit] r1389 - in trunk/windstille/src: . gui
Message-ID: <200706111536.l5BFaVp6019497@sheep.berlios.de>

Author: grumbel
Date: 2007-06-11 17:36:31 +0200 (Mon, 11 Jun 2007)
New Revision: 1389

Added:
   trunk/windstille/src/gui/group_component.cpp
   trunk/windstille/src/gui/group_component.hpp
Modified:
   trunk/windstille/src/SConscript
   trunk/windstille/src/gui/menu_component.cpp
   trunk/windstille/src/menu_manager.cpp
Log:
- added group component to provide a title over a menu

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-11 13:49:41 UTC (rev 1388)
+++ trunk/windstille/src/SConscript	2007-06-11 15:36:31 UTC (rev 1389)
@@ -125,6 +125,7 @@
 'gui/component.cpp',
 'gui/component_factory.cpp',
 'gui/grid_component.cpp',
+'gui/group_component.cpp',
 'gui/gui_manager.cpp',
 'gui/list_view.cpp',
 'gui/root_component.cpp',

Added: trunk/windstille/src/gui/group_component.cpp
===================================================================
--- trunk/windstille/src/gui/group_component.cpp	2007-06-11 13:49:41 UTC (rev 1388)
+++ trunk/windstille/src/gui/group_component.cpp	2007-06-11 15:36:31 UTC (rev 1389)
@@ -0,0 +1,98 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include <assert.h>
+#include "display/display.hpp"
+#include "color.hpp"
+#include "font/fonts.hpp"
+#include "group_component.hpp"
+
+namespace GUI {
+
+GroupComponent::GroupComponent(const Rectf& rect, const std::string& title_, Component* parent)
+  : Component(rect, parent),
+    title(title_),
+    child(0)
+{
+  
+}
+
+GroupComponent::~GroupComponent()
+{
+  
+}
+
+void
+GroupComponent::draw()
+{
+  Display::fill_rounded_rect(rect, 5.0f, Color(0.0f, 0.0f, 0.0f, 0.5f));
+  Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 0.5f));
+
+  TTFFont* font = Fonts::vera20;
+  font->draw_center(rect.left + rect.get_width()/2, rect.top + font->get_height() + 5, 
+                    title, Color(1.0f, 1.0f, 1.0f));
+
+  Display::fill_rect(Rectf(rect.left  + 8, rect.top + font->get_height() + 16,
+                           rect.right - 8, rect.top + font->get_height() + 18),
+                     Color(1.0f, 1.0f, 1.0f, 0.5f));
+
+  if (child)
+    child->draw();
+}
+
+void
+GroupComponent::update(float delta, const Controller& controller)
+{
+  if (child)
+    child->update(delta, controller);
+}
+
+void
+GroupComponent::pack(Component* component)
+{
+  assert(child == 0);
+  child = component;
+
+  int padding = 6;
+  child->set_screen_rect(Rectf(rect.left + padding,
+                               rect.top  + padding + Fonts::vera20->get_height() + 24,
+                               rect.right  - padding,
+                               rect.bottom - padding
+                               ));
+  child->set_active(true);
+}
+
+bool
+GroupComponent::is_active() const
+{
+  if (child)
+    return child->is_active();
+  else
+    return false;
+}
+
+} // namespace GUI
+
+/* EOF */


Property changes on: trunk/windstille/src/gui/group_component.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/gui/group_component.hpp
===================================================================
--- trunk/windstille/src/gui/group_component.hpp	2007-06-11 13:49:41 UTC (rev 1388)
+++ trunk/windstille/src/gui/group_component.hpp	2007-06-11 15:36:31 UTC (rev 1389)
@@ -0,0 +1,61 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_GROUP_COMPONENT_HPP
+#define HEADER_GROUP_COMPONENT_HPP
+
+#include <string>
+#include "component.hpp"
+
+namespace GUI {
+
+/** */
+class GroupComponent : public Component
+{
+private:
+  std::string title;
+  Component* child;
+
+public:
+  GroupComponent(const Rectf& rect, const std::string& title_, Component* parent);
+  ~GroupComponent();
+
+  void draw();
+  void update(float delta, const Controller& controller);
+
+  void pack(Component* component);
+  
+  bool is_active() const;
+
+private:
+  GroupComponent (const GroupComponent&);
+  GroupComponent& operator= (const GroupComponent&);
+};
+
+} // namespace GUI
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/gui/group_component.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/gui/menu_component.cpp
===================================================================
--- trunk/windstille/src/gui/menu_component.cpp	2007-06-11 13:49:41 UTC (rev 1388)
+++ trunk/windstille/src/gui/menu_component.cpp	2007-06-11 15:36:31 UTC (rev 1389)
@@ -48,8 +48,8 @@
     Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 1.0f));
     font_color = Color(1.0f, 1.0f, 1.0f);
   } else {
-    Display::fill_rounded_rect(rect, 5.0f, Color(0.3f, 0.3f, 0.3f, 0.75f));
-    Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 0.75f));
+    //Display::fill_rounded_rect(rect, 5.0f, Color(0.3f, 0.3f, 0.3f, 0.75f));
+    //Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 0.75f));
     font_color = Color(0.75f, 0.75f, 0.75f, 1.0f);
   }
 

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-11 13:49:41 UTC (rev 1388)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-11 15:36:31 UTC (rev 1389)
@@ -29,6 +29,7 @@
 #include "font/fonts.hpp"
 #include "gui/gui_manager.hpp"
 #include "gui/root_component.hpp"
+#include "gui/group_component.hpp"
 #include "screen_manager.hpp"
 #include "gui/menu_component.hpp"
 #include "game_session.hpp"
@@ -47,9 +48,14 @@
   using namespace GUI;
   GUIManager* manager = new GUIManager();
 
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 300-170), Sizef(500, 340)), 
+                                             "Options",
+                                             manager->get_root());
+
   // Begin Main Menu
-  MenuComponent* menu = new MenuComponent(Rectf(Vector(400-200, 200), Sizef(400, 500)), true,
-                                          manager->get_root());
+  MenuComponent* menu = new MenuComponent(Rectf(), true,
+                                          group);
+  group->pack(menu);
 
   menu->set_font(Fonts::vera20);
 
@@ -82,8 +88,14 @@
   menu->add_item(fullscreen_item);
   slots.push_back(fullscreen_item->sig_change().connect(this, &MenuManager::menu_fullscreen));
 
-  manager->get_root()->set_child(menu);
+  EnumMenuItem* difficulty_item = new EnumMenuItem(menu,  "Difficulty", 1);
+  difficulty_item->add_pair(0, "easy");
+  difficulty_item->add_pair(1, "medium");
+  difficulty_item->add_pair(2, "hard");
+  menu->add_item(difficulty_item);
 
+  manager->get_root()->set_child(group);
+
   screen_manager.push_overlay(manager);
 }
 
@@ -127,9 +139,14 @@
   using namespace GUI;
   GUIManager* manager = new GUIManager();
 
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-200, 300-170), Sizef(400, 340)), 
+                                             "Pause Menu",
+                                             manager->get_root());
+
   // Begin Main Menu
   MenuComponent* menu = new MenuComponent(Rectf(Vector(400-150, 200), Sizef(300, 500)), true,
-                                          manager->get_root());
+                                          group);
+  group->pack(menu);
 
   menu->set_font(Fonts::vera20);
 
@@ -158,7 +175,7 @@
   menu->add_item(quit_button);
   // End: Option Menu
 
-  manager->get_root()->set_child(menu);
+  manager->get_root()->set_child(group);
 
   screen_manager.push_overlay(manager); 
 }
@@ -169,9 +186,13 @@
   using namespace GUI;
   GUIManager* manager = new GUIManager();
 
-  MenuComponent* menu = new MenuComponent(Rectf(Vector(400-200, 200), Sizef(400, 500)), true,
-                                          manager->get_root());
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-200, 300-170), Sizef(400, 340)), 
+                                             "Select Scenario",
+                                             manager->get_root());
 
+  MenuComponent* menu = new MenuComponent(Rectf(), true, group);
+  group->pack(menu);
+
   menu->set_font(Fonts::vera20);
 
   std::vector<std::string> scenarios;
@@ -194,7 +215,7 @@
       menu->add_item(scenario_button);
     }
 
-  manager->get_root()->set_child(menu);
+  manager->get_root()->set_child(group);
 
   screen_manager.push_overlay(manager); 
 }
@@ -205,9 +226,13 @@
   using namespace GUI;
   GUIManager* manager = new GUIManager();
 
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 300-170), Sizef(500, 340)), 
+                                             "Select Scenario",
+                                             manager->get_root());
+
   // Begin Main Menu
-  MenuComponent* menu = new MenuComponent(Rectf(Vector(400-300, 200), Sizef(600, 500)), true,
-                                          manager->get_root());
+  MenuComponent* menu = new MenuComponent(Rectf(), true, group);
+  group->pack(menu);
 
   menu->set_font(Fonts::vera20);
 
@@ -225,7 +250,7 @@
   slots.push_back(b_ambient_light_item->sig_change().connect(this, &MenuManager::menu_ambient_light, 2));
   menu->add_item(b_ambient_light_item);
 
-  manager->get_root()->set_child(menu);
+  manager->get_root()->set_child(group);
 
   screen_manager.push_overlay(manager); 
 }



From grumbel at mail.berlios.de  Mon Jun 11 18:59:52 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 11 Jun 2007 18:59:52 +0200
Subject: [Windstille-commit] r1390 - in trunk/windstille/src: . gui
Message-ID: <200706111659.l5BGxqp1003838@sheep.berlios.de>

Author: grumbel
Date: 2007-06-11 18:59:51 +0200 (Mon, 11 Jun 2007)
New Revision: 1390

Modified:
   trunk/windstille/src/gui/component.cpp
   trunk/windstille/src/gui/component.hpp
   trunk/windstille/src/gui/group_component.cpp
   trunk/windstille/src/gui/group_component.hpp
   trunk/windstille/src/gui/menu_component.cpp
   trunk/windstille/src/gui/menu_component.hpp
   trunk/windstille/src/gui/root_component.cpp
   trunk/windstille/src/gui/root_component.hpp
   trunk/windstille/src/gui/text_view.cpp
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/menu_manager.hpp
Log:
- some general improvements
- added textview for credits to the menu

Modified: trunk/windstille/src/gui/component.cpp
===================================================================
--- trunk/windstille/src/gui/component.cpp	2007-06-11 15:36:31 UTC (rev 1389)
+++ trunk/windstille/src/gui/component.cpp	2007-06-11 16:59:51 UTC (rev 1390)
@@ -23,6 +23,7 @@
 **  02111-1307, USA.
 */
 
+#include <assert.h>
 #include "component.hpp"
 
 namespace GUI {
@@ -70,6 +71,18 @@
   rect = r;
 }
 
+float
+Component::get_prefered_width() const
+{
+  assert(!"Implement me");
+}
+
+float
+Component::get_prefered_height() const
+{
+  assert(!"Implement me");
+}
+
 } // namespace GUI
 
 /* EOF */

Modified: trunk/windstille/src/gui/component.hpp
===================================================================
--- trunk/windstille/src/gui/component.hpp	2007-06-11 15:36:31 UTC (rev 1389)
+++ trunk/windstille/src/gui/component.hpp	2007-06-11 16:59:51 UTC (rev 1390)
@@ -55,6 +55,9 @@
   virtual Rectf get_screen_rect() const;
   virtual void  set_screen_rect(const Rectf& rect);
 
+  virtual float get_prefered_width() const;
+  virtual float get_prefered_height() const;
+
 private:
   Component (const Component&);
   Component& operator= (const Component&);

Modified: trunk/windstille/src/gui/group_component.cpp
===================================================================
--- trunk/windstille/src/gui/group_component.cpp	2007-06-11 15:36:31 UTC (rev 1389)
+++ trunk/windstille/src/gui/group_component.cpp	2007-06-11 16:59:51 UTC (rev 1390)
@@ -50,13 +50,16 @@
   Display::fill_rounded_rect(rect, 5.0f, Color(0.0f, 0.0f, 0.0f, 0.5f));
   Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 0.5f));
 
-  TTFFont* font = Fonts::vera20;
-  font->draw_center(rect.left + rect.get_width()/2, rect.top + font->get_height() + 5, 
-                    title, Color(1.0f, 1.0f, 1.0f));
+  if (!title.empty())
+    {
+      TTFFont* font = Fonts::vera20;
+      font->draw_center(rect.left + rect.get_width()/2, rect.top + font->get_height() + 5, 
+                        title, Color(1.0f, 1.0f, 1.0f));
 
-  Display::fill_rect(Rectf(rect.left  + 8, rect.top + font->get_height() + 16,
-                           rect.right - 8, rect.top + font->get_height() + 18),
-                     Color(1.0f, 1.0f, 1.0f, 0.5f));
+      Display::fill_rect(Rectf(rect.left  + 8, rect.top + font->get_height() + 16,
+                               rect.right - 8, rect.top + font->get_height() + 18),
+                         Color(1.0f, 1.0f, 1.0f, 0.5f));
+    }
 
   if (child)
     child->draw();
@@ -77,7 +80,7 @@
 
   int padding = 6;
   child->set_screen_rect(Rectf(rect.left + padding,
-                               rect.top  + padding + Fonts::vera20->get_height() + 24,
+                               rect.top  + padding + (title.empty() ? 0 : Fonts::vera20->get_height() + 24),
                                rect.right  - padding,
                                rect.bottom - padding
                                ));
@@ -93,6 +96,14 @@
     return false;
 }
 
+void
+GroupComponent::layout()
+{
+  // FIXME: implement me
+  // child->get_prefered_width();
+  // child->get_prefered_height();
+}
+
 } // namespace GUI
 
 /* EOF */

Modified: trunk/windstille/src/gui/group_component.hpp
===================================================================
--- trunk/windstille/src/gui/group_component.hpp	2007-06-11 15:36:31 UTC (rev 1389)
+++ trunk/windstille/src/gui/group_component.hpp	2007-06-11 16:59:51 UTC (rev 1390)
@@ -48,7 +48,7 @@
   void pack(Component* component);
   
   bool is_active() const;
-
+  void layout();
 private:
   GroupComponent (const GroupComponent&);
   GroupComponent& operator= (const GroupComponent&);

Modified: trunk/windstille/src/gui/menu_component.cpp
===================================================================
--- trunk/windstille/src/gui/menu_component.cpp	2007-06-11 15:36:31 UTC (rev 1389)
+++ trunk/windstille/src/gui/menu_component.cpp	2007-06-11 16:59:51 UTC (rev 1390)
@@ -26,7 +26,7 @@
 #include <iostream>
 #include "input/controller.hpp"
 #include "menu_component.hpp"
-#include "gui/root_component.hpp"
+#include "gui/tab_component.hpp"
 #include "display/display.hpp"
 #include "math.hpp"
 
@@ -285,31 +285,32 @@
                   current_item = current_item - 1;
                   if (current_item < 0)
                     {
-                      if (dynamic_cast<RootComponent*>(parent))
+                      if (dynamic_cast<TabComponent*>(parent))
                         {
-                          current_item = static_cast<int>(items.size())-1; 
-                        }
-                      else
-                        { // FIXME: This only works good with TabComponent
                           current_item = 0;
                           set_active(false);
                         }
+                      else
+                        { 
+                          current_item = static_cast<int>(items.size())-1; 
+                        }
                     }
                 }
               else if (i->axis.pos > 0)
                 {
-                  if (dynamic_cast<RootComponent*>(parent))
+                  if (dynamic_cast<TabComponent*>(parent))
                     {
+                      current_item = Math::mid(0, current_item + 1, static_cast<int>(items.size()-1)); 
+                    }
+                  else
+                    {
                       current_item += 1;
                       if (current_item >= static_cast<int>(items.size()))
                         {
                           current_item = 0;
                         }
+
                     }
-                  else
-                    {
-                      current_item = Math::mid(0, current_item + 1, static_cast<int>(items.size()-1)); 
-                    }
                 }
             }
         }
@@ -328,6 +329,25 @@
   return font;
 }
 
+float
+MenuComponent::get_prefered_width() const
+{
+  /*
+  float width = 0;
+  for(Items::iterator i = items.begin(); i != items.end(); ++i)
+    {
+      width = std::max(get_width())
+    }  */
+  return 200; // FIXME:
+}
+
+float
+MenuComponent::get_prefered_height() const
+{
+  float step = font->get_height() + 20.0f;
+  return step * items.size();
+}
+
 } // namespace GUI
 
 /* EOF */

Modified: trunk/windstille/src/gui/menu_component.hpp
===================================================================
--- trunk/windstille/src/gui/menu_component.hpp	2007-06-11 15:36:31 UTC (rev 1389)
+++ trunk/windstille/src/gui/menu_component.hpp	2007-06-11 16:59:51 UTC (rev 1390)
@@ -127,6 +127,9 @@
   void draw();
   void update(float delta, const Controller& controller);
 
+  float get_prefered_width() const;
+  float get_prefered_height() const;
+
   void     set_font(TTFFont* font_);
   TTFFont* get_font();
 private:

Modified: trunk/windstille/src/gui/root_component.cpp
===================================================================
--- trunk/windstille/src/gui/root_component.cpp	2007-06-11 15:36:31 UTC (rev 1389)
+++ trunk/windstille/src/gui/root_component.cpp	2007-06-11 16:59:51 UTC (rev 1390)
@@ -24,6 +24,7 @@
 */
 
 #include <iostream>
+#include "input/controller.hpp"
 #include "root_component.hpp"
 
 namespace GUI {
@@ -49,6 +50,11 @@
 void
 RootComponent::draw()
 {
+  for(Children::iterator i = chidren.begin(); i != chidren.end(); ++i)
+    {
+      (*i)->draw();
+    }
+
   if (child)
     child->draw();
 }
@@ -58,6 +64,11 @@
 {
   if (child)
     child->update(delta, controller);
+  
+  for(Children::iterator i = chidren.begin(); i != chidren.end(); ++i)
+    {
+      (*i)->update(delta, Controller());
+    }
 }
 
 bool
@@ -69,6 +80,12 @@
     return false;
 }
 
+void
+RootComponent::add_child(Component* child)
+{
+  chidren.push_back(child);
+}
+
 } // namespace GUI
 
 /* EOF */

Modified: trunk/windstille/src/gui/root_component.hpp
===================================================================
--- trunk/windstille/src/gui/root_component.hpp	2007-06-11 15:36:31 UTC (rev 1389)
+++ trunk/windstille/src/gui/root_component.hpp	2007-06-11 16:59:51 UTC (rev 1390)
@@ -26,6 +26,7 @@
 #ifndef HEADER_WINDSTILLE_GUI_ROOT_COMPONENT_HPP
 #define HEADER_WINDSTILLE_GUI_ROOT_COMPONENT_HPP
 
+#include <vector>
 #include "component.hpp"
 
 namespace GUI {
@@ -35,7 +36,8 @@
 {
 private:
   Component* child;
-
+  typedef std::vector<Component*> Children;
+  Children chidren;
 public:
   RootComponent(const Rectf& rect);
   ~RootComponent();
@@ -43,7 +45,10 @@
   void draw();
   void update(float delta, const Controller& controller);
 
+  /** Set the main chidren */
   void set_child(Component* child);
+  void add_child(Component* child);
+
   Component* get_child() const { return child; }
   
   bool is_active() const;

Modified: trunk/windstille/src/gui/text_view.cpp
===================================================================
--- trunk/windstille/src/gui/text_view.cpp	2007-06-11 15:36:31 UTC (rev 1389)
+++ trunk/windstille/src/gui/text_view.cpp	2007-06-11 16:59:51 UTC (rev 1390)
@@ -23,6 +23,7 @@
 **  02111-1307, USA.
 */
 
+#include "input/controller.hpp"
 #include "text_view.hpp"
 
 namespace GUI {
@@ -47,7 +48,21 @@
 TextView::update(float delta, const Controller& controller)
 {
   text_area.update(delta);
-  set_active(false);
+
+  for(InputEventLst::const_iterator i = controller.get_events().begin(); i != controller.get_events().end(); ++i) 
+    {
+      if (i->type == BUTTON_EVENT && i->button.down)
+        {
+          if (i->button.name == OK_BUTTON)
+            {
+              set_active(false);
+            }
+          else if (i->button.name == CANCEL_BUTTON)
+            {            
+              set_active(false);
+            }
+        }
+    }  
 }
 
 void

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-11 15:36:31 UTC (rev 1389)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-11 16:59:51 UTC (rev 1390)
@@ -29,6 +29,7 @@
 #include "font/fonts.hpp"
 #include "gui/gui_manager.hpp"
 #include "gui/root_component.hpp"
+#include "gui/text_view.hpp"
 #include "gui/group_component.hpp"
 #include "screen_manager.hpp"
 #include "gui/menu_component.hpp"
@@ -95,7 +96,7 @@
   menu->add_item(difficulty_item);
 
   manager->get_root()->set_child(group);
-
+  group->layout();
   screen_manager.push_overlay(manager);
 }
 
@@ -105,9 +106,14 @@
   using namespace GUI;
   GUIManager* manager = new GUIManager();
 
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400, 250), Sizef(200, 176)),
+                                             "",
+                                             manager->get_root());
+
   // Begin Main Menu
   MenuComponent* menu = new MenuComponent(Rectf(Vector(400, 250), Sizef(200, 500)), false,
-                                          manager->get_root());
+                                          group);
+  group->pack(menu);
 
   menu->set_font(Fonts::vera20);
 
@@ -120,7 +126,7 @@
   menu->add_item(options_button);
 
   ButtonMenuItem* credits_button = new ButtonMenuItem(menu,  "Credits");
-  slots.push_back(credits_button->sig_click().connect(this, &MenuManager::menu_credits));
+  slots.push_back(credits_button->sig_click().connect(this, &MenuManager::display_credits));
   menu->add_item(credits_button);
 
   ButtonMenuItem* quit_button = new ButtonMenuItem(menu,  "Quit");
@@ -128,8 +134,8 @@
   menu->add_item(quit_button);
   // End: Option Menu
 
-  manager->get_root()->set_child(menu);
-
+  manager->get_root()->set_child(group);
+  group->layout();
   screen_manager.push_overlay(manager);
 }
 
@@ -167,7 +173,7 @@
   menu->add_item(debug_button);
 
   ButtonMenuItem* credits_button = new ButtonMenuItem(menu,  "Credits");
-  slots.push_back(credits_button->sig_click().connect(this, &MenuManager::menu_credits));
+  slots.push_back(credits_button->sig_click().connect(this, &MenuManager::display_credits));
   menu->add_item(credits_button);
 
   ButtonMenuItem* quit_button = new ButtonMenuItem(menu,  "Return to Title Screen");
@@ -254,7 +260,36 @@
 
   screen_manager.push_overlay(manager); 
 }
-
+
+void
+MenuManager::display_credits()
+{
+  using namespace GUI;
+  GUIManager* manager = new GUIManager();
+
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 300-170), Sizef(500, 340)), 
+                                             "Credits",
+                                             manager->get_root());
+
+  TextView* text = new TextView(Rectf(), group);
+  text->set_text("<b>Programming</b>\n"
+                 "===========\n"
+                 "\n"
+                 "  Ingo Ruhnke &lt;grumbel at gmx.de&gt;\n"
+                 "  Matthias Braun matze at braunis.de\n"
+                 "  James Gregory\n"
+                 "  David Kamphausen &lt;david.kamphausen at web.de&gt;\n"
+                 "  Mark Dillavou &lt;line72 at line72.net&gt;\n"
+                 "\n"
+                 "incomplete placeholder, see AUTHORS for full list\n");
+  text->set_active(true);
+
+  group->pack(text);
+
+  manager->get_root()->set_child(group);
+  screen_manager.push_overlay(manager);
+}
+  
 // Callbacks
 
 void
@@ -265,12 +300,6 @@
 }
 
 void
-MenuManager::menu_credits()
-{
-  console << "Credits clicked" << std::endl;
-}
-
-void
 MenuManager::menu_quit()
 {
   //GameSession::current()->quit();

Modified: trunk/windstille/src/menu_manager.hpp
===================================================================
--- trunk/windstille/src/menu_manager.hpp	2007-06-11 15:36:31 UTC (rev 1389)
+++ trunk/windstille/src/menu_manager.hpp	2007-06-11 16:59:51 UTC (rev 1390)
@@ -43,10 +43,10 @@
   void display_main_menu();
   void display_pause_menu();
   void display_scenario_menu();
+  void display_credits();
 
   // Callbacks
   void menu_start_game();
-  void menu_credits();
   void menu_quit();
   void menu_exit();
   void menu_show_fps(int i);



From grumbel at mail.berlios.de  Mon Jun 11 21:47:18 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 11 Jun 2007 21:47:18 +0200
Subject: [Windstille-commit] r1391 - in trunk/windstille: . src src/gui
	src/objects
Message-ID: <200706111947.l5BJlI4J018065@sheep.berlios.de>

Author: grumbel
Date: 2007-06-11 21:47:18 +0200 (Mon, 11 Jun 2007)
New Revision: 1391

Modified:
   trunk/windstille/
   trunk/windstille/src/game_session.cpp
   trunk/windstille/src/gui/root_component.cpp
   trunk/windstille/src/gui/root_component.hpp
   trunk/windstille/src/gui/text_view.cpp
   trunk/windstille/src/gui/text_view.hpp
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/menu_manager.hpp
   trunk/windstille/src/objects/swarm.cpp
   trunk/windstille/src/particle_viewer.cpp
Log:
- made swarm a bit more visible
- added GPL text to main menu
- added model viewer to main menu


Property changes on: trunk/windstille
___________________________________________________________________
Name: svn:ignore
   - 
cache/
.sconsign.dblite
windstille

   + 
cache
cache/
.sconsign.dblite
windstille


Modified: trunk/windstille/src/game_session.cpp
===================================================================
--- trunk/windstille/src/game_session.cpp	2007-06-11 16:59:51 UTC (rev 1390)
+++ trunk/windstille/src/game_session.cpp	2007-06-11 19:47:18 UTC (rev 1391)
@@ -290,6 +290,10 @@
     {
       menu_manager.display_pause_menu();
     }
+  else if(keystate[SDLK_F2])
+    {
+      menu_manager.display_debug_menu();
+    }
 }
 
 void

Modified: trunk/windstille/src/gui/root_component.cpp
===================================================================
--- trunk/windstille/src/gui/root_component.cpp	2007-06-11 16:59:51 UTC (rev 1390)
+++ trunk/windstille/src/gui/root_component.cpp	2007-06-11 19:47:18 UTC (rev 1391)
@@ -24,6 +24,7 @@
 */
 
 #include <iostream>
+#include "console.hpp"
 #include "input/controller.hpp"
 #include "root_component.hpp"
 
@@ -31,7 +32,7 @@
 
 RootComponent::RootComponent(const Rectf& rect)
   : Component(rect, 0),
-    child(0)
+    focus(0)
 {
   set_active(true);
 }
@@ -41,41 +42,31 @@
 }
 
 void
-RootComponent::set_child(Component* child_)
-{
-  child = child_;
-  child->set_active(true);
-}
-
-void
 RootComponent::draw()
 {
-  for(Children::iterator i = chidren.begin(); i != chidren.end(); ++i)
+  for(Children::iterator i = children.begin(); i != children.end(); ++i)
     {
       (*i)->draw();
     }
-
-  if (child)
-    child->draw();
 }
 
 void
 RootComponent::update(float delta, const Controller& controller)
 {
-  if (child)
-    child->update(delta, controller);
-  
-  for(Children::iterator i = chidren.begin(); i != chidren.end(); ++i)
+  for(Children::iterator i = children.begin(); i != children.end(); ++i)
     {
-      (*i)->update(delta, Controller());
+      if (*i == focus)
+        (*i)->update(delta, controller);
+      else
+        (*i)->update(delta, Controller());
     }
 }
 
 bool
 RootComponent::is_active() const
 {
-  if (child)
-    return child->is_active();
+  if (focus)
+    return focus->is_active();
   else
     return false;
 }
@@ -83,9 +74,25 @@
 void
 RootComponent::add_child(Component* child)
 {
-  chidren.push_back(child);
+  focus = child;
+  children.push_back(child);
 }
 
+void
+RootComponent::set_focus(Component* child_)
+{
+  Children::iterator i = std::find(children.begin(), children.end(), child_);
+  if (i != children.end())
+    {
+      focus = child_;
+      focus->set_active(true);
+    }
+  else
+    {
+      console << "Error: Need to add_child() first befor calling set_focus()" << std::endl;
+    }
+}
+
 } // namespace GUI
 
 /* EOF */

Modified: trunk/windstille/src/gui/root_component.hpp
===================================================================
--- trunk/windstille/src/gui/root_component.hpp	2007-06-11 16:59:51 UTC (rev 1390)
+++ trunk/windstille/src/gui/root_component.hpp	2007-06-11 19:47:18 UTC (rev 1391)
@@ -35,9 +35,11 @@
 class RootComponent : public Component
 {
 private:
-  Component* child;
+  Component* focus;
+
   typedef std::vector<Component*> Children;
-  Children chidren;
+  Children children;
+
 public:
   RootComponent(const Rectf& rect);
   ~RootComponent();
@@ -45,11 +47,12 @@
   void draw();
   void update(float delta, const Controller& controller);
 
-  /** Set the main chidren */
-  void set_child(Component* child);
+  /** Set the chidren that shall recieve input */
+  void set_focus(Component* child);
+
   void add_child(Component* child);
 
-  Component* get_child() const { return child; }
+  Component* get_focus() const { return focus; }
   
   bool is_active() const;
 private:

Modified: trunk/windstille/src/gui/text_view.cpp
===================================================================
--- trunk/windstille/src/gui/text_view.cpp	2007-06-11 16:59:51 UTC (rev 1390)
+++ trunk/windstille/src/gui/text_view.cpp	2007-06-11 19:47:18 UTC (rev 1391)
@@ -78,6 +78,12 @@
   text_area.set_text(text);
 }
 
+void
+TextView::set_font(TTFFont* font)
+{
+  text_area.set_font(font);
+}
+
 } // namespace GUI
 
 /* EOF */

Modified: trunk/windstille/src/gui/text_view.hpp
===================================================================
--- trunk/windstille/src/gui/text_view.hpp	2007-06-11 16:59:51 UTC (rev 1390)
+++ trunk/windstille/src/gui/text_view.hpp	2007-06-11 19:47:18 UTC (rev 1391)
@@ -44,9 +44,10 @@
   void draw();
   void update(float delta, const Controller& controller);
 
-  void  set_screen_rect(const Rectf& rect);
+  void set_screen_rect(const Rectf& rect);
   void set_text(const std::string& text);
-  
+  void set_font(TTFFont* font);
+
 private:
   TextView (const TextView&);
   TextView& operator= (const TextView&);

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-11 16:59:51 UTC (rev 1390)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-11 19:47:18 UTC (rev 1391)
@@ -35,6 +35,8 @@
 #include "gui/menu_component.hpp"
 #include "game_session.hpp"
 #include "sector.hpp"
+#include "sprite3d/manager.hpp"
+#include "sprite3dview.hpp"
 #include "menu_manager.hpp"
 
 MenuManager menu_manager;
@@ -78,14 +80,14 @@
   menu->add_item(aspect_item);
   
   EnumMenuItem* show_fps_item = new EnumMenuItem(menu,  "Show FPS", config.get_bool("show-fps"));
+  show_fps_item->add_pair(0, "off");
   show_fps_item->add_pair(1, "on");
-  show_fps_item->add_pair(0, "off");
   menu->add_item(show_fps_item);
   slots.push_back(show_fps_item->sig_change().connect(this, &MenuManager::menu_show_fps));
 
   EnumMenuItem* fullscreen_item = new EnumMenuItem(menu,  "Fullscreen", config.get_bool("fullscreen"));
+  fullscreen_item->add_pair(0, "off");
   fullscreen_item->add_pair(1, "on");
-  fullscreen_item->add_pair(0, "off");
   menu->add_item(fullscreen_item);
   slots.push_back(fullscreen_item->sig_change().connect(this, &MenuManager::menu_fullscreen));
 
@@ -95,7 +97,7 @@
   difficulty_item->add_pair(2, "hard");
   menu->add_item(difficulty_item);
 
-  manager->get_root()->set_child(group);
+  manager->get_root()->add_child(group);
   group->layout();
   screen_manager.push_overlay(manager);
 }
@@ -106,12 +108,27 @@
   using namespace GUI;
   GUIManager* manager = new GUIManager();
 
-  GroupComponent* group = new GroupComponent(Rectf(Vector(400, 250), Sizef(200, 176)),
+  GroupComponent* text_group = new GroupComponent(Rectf(10, 500+20, 800-10, 600-10),
+                                                  "",
+                                                  manager->get_root());
+
+  TextView* text = new TextView(Rectf(), text_group);
+  text_group->pack(text);
+  text->set_font(Fonts::vera12);
+  text->set_text("Copyright (C) 2007 Ingo Ruhnke &lt;grumbel at gmx.de&gt;\n"
+                 "\n"
+                 "This program is free software; you can redistribute it and/or "
+                 "modify it under the terms of the GNU General Public License "
+                 "as published by the Free Software Foundation; either version 2 "
+                 "of the License, or (at your option) any later version.");
+  manager->get_root()->add_child(text_group);
+
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400, 250), Sizef(200, 210)),
                                              "",
                                              manager->get_root());
 
   // Begin Main Menu
-  MenuComponent* menu = new MenuComponent(Rectf(Vector(400, 250), Sizef(200, 500)), false,
+  MenuComponent* menu = new MenuComponent(Rectf(), false,
                                           group);
   group->pack(menu);
 
@@ -121,6 +138,10 @@
   slots.push_back(select_scenario_button->sig_click().connect(this, &MenuManager::display_scenario_menu));
   menu->add_item(select_scenario_button);
 
+  ButtonMenuItem* model_viewer_button = new ButtonMenuItem(menu,  "Model Viewer");
+  slots.push_back(model_viewer_button->sig_click().connect(this, &MenuManager::menu_mode_viewer));
+  menu->add_item(model_viewer_button);
+
   ButtonMenuItem* options_button = new ButtonMenuItem(menu,  "Options");
   slots.push_back(options_button->sig_click().connect(this, &MenuManager::display_option_menu));
   menu->add_item(options_button);
@@ -134,7 +155,7 @@
   menu->add_item(quit_button);
   // End: Option Menu
 
-  manager->get_root()->set_child(group);
+  manager->get_root()->add_child(group);
   group->layout();
   screen_manager.push_overlay(manager);
 }
@@ -181,7 +202,7 @@
   menu->add_item(quit_button);
   // End: Option Menu
 
-  manager->get_root()->set_child(group);
+  manager->get_root()->add_child(group);
 
   screen_manager.push_overlay(manager); 
 }
@@ -221,7 +242,7 @@
       menu->add_item(scenario_button);
     }
 
-  manager->get_root()->set_child(group);
+  manager->get_root()->add_child(group);
 
   screen_manager.push_overlay(manager); 
 }
@@ -256,11 +277,11 @@
   slots.push_back(b_ambient_light_item->sig_change().connect(this, &MenuManager::menu_ambient_light, 2));
   menu->add_item(b_ambient_light_item);
 
-  manager->get_root()->set_child(group);
+  manager->get_root()->add_child(group);
 
   screen_manager.push_overlay(manager); 
 }
-
+
 void
 MenuManager::display_credits()
 {
@@ -272,8 +293,9 @@
                                              manager->get_root());
 
   TextView* text = new TextView(Rectf(), group);
-  text->set_text("<b>Programming</b>\n"
-                 "===========\n"
+  text->set_font(Fonts::vera16);
+  text->set_text("<sin>Programming</sin>\n"
+                 "<sin>===========</sin>\n"
                  "\n"
                  "  Ingo Ruhnke &lt;grumbel at gmx.de&gt;\n"
                  "  Matthias Braun matze at braunis.de\n"
@@ -286,10 +308,20 @@
 
   group->pack(text);
 
-  manager->get_root()->set_child(group);
+  manager->get_root()->add_child(group);
   screen_manager.push_overlay(manager);
 }
-  
+
+void
+MenuManager::menu_mode_viewer()
+{
+  Sprite3DView* sprite3dview = new Sprite3DView();
+
+  // Launching Sprite3DView instead of game
+  screen_manager.pop_overlay();
+  screen_manager.set_screen(sprite3dview);
+}
+  
 // Callbacks
 
 void

Modified: trunk/windstille/src/menu_manager.hpp
===================================================================
--- trunk/windstille/src/menu_manager.hpp	2007-06-11 16:59:51 UTC (rev 1390)
+++ trunk/windstille/src/menu_manager.hpp	2007-06-11 19:47:18 UTC (rev 1391)
@@ -54,6 +54,7 @@
   void menu_continue();
   void menu_ambient_light(int i, int component);
   void menu_start_scenario(std::string scenario);
+  void menu_mode_viewer();
 
 private:
   MenuManager (const MenuManager&);

Modified: trunk/windstille/src/objects/swarm.cpp
===================================================================
--- trunk/windstille/src/objects/swarm.cpp	2007-06-11 16:59:51 UTC (rev 1390)
+++ trunk/windstille/src/objects/swarm.cpp	2007-06-11 19:47:18 UTC (rev 1391)
@@ -68,19 +68,25 @@
   VertexArrayDrawingRequest* array = new VertexArrayDrawingRequest(Vector(0, 0), 
                                                                    1000.0f, sc.highlight().get_modelview());
 
-  array->set_mode(GL_LINES);
+  array->set_mode(GL_QUADS);
   array->set_blend_func(GL_ONE, GL_ZERO);
 
-  Color begin_color(1.0f, 1.0f, 1.0f);
-  Color end_color(0.0f, 0.0f, 0.0f);
+  Color color(1.0f, 1.0f, 1.0f);
+  Color bottom_color(0.0f, 0.0f, 0.0f);
 
   for(Agents::const_iterator i = agents.begin(); i != agents.end(); ++i)
     {
-      array->color(begin_color);
-      array->vertex(i->last_pos.x, i->last_pos.y);
+      array->color(color);
+      array->vertex(i->pos.x - 1, i->pos.y - 1);
 
-      array->color(end_color);
-      array->vertex(i->pos.x, i->pos.y);
+      array->color(color);
+      array->vertex(i->pos.x + 2, i->pos.y - 1);
+
+      array->color(bottom_color);
+      array->vertex(i->pos.x + 2, i->pos.y + 2);
+
+      array->color(bottom_color);
+      array->vertex(i->pos.x - 1, i->pos.y + 2);
     }
 
   sc.highlight().draw(array);

Modified: trunk/windstille/src/particle_viewer.cpp
===================================================================
--- trunk/windstille/src/particle_viewer.cpp	2007-06-11 16:59:51 UTC (rev 1390)
+++ trunk/windstille/src/particle_viewer.cpp	2007-06-11 19:47:18 UTC (rev 1391)
@@ -102,7 +102,7 @@
   manager = new GUIManager();
   tab = new TabComponent(Rectf(200, 50, 600, 250), manager->get_root());
   
-  manager->get_root()->set_child(tab);
+  manager->get_root()->add_child(tab);
 }
 
 ParticleViewer::~ParticleViewer()
@@ -186,7 +186,7 @@
       if (controller.button_was_pressed(OK_BUTTON))
         {
           show_gui = true;
-          manager->get_root()->get_child()->set_active(true);
+          manager->get_root()->get_focus()->set_active(true);
         }
     }
   else



From grumbel at mail.berlios.de  Mon Jun 11 22:12:35 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 11 Jun 2007 22:12:35 +0200
Subject: [Windstille-commit] r1392 - trunk/windstille/src
Message-ID: <200706112012.l5BKCZU6020102@sheep.berlios.de>

Author: grumbel
Date: 2007-06-11 22:12:34 +0200 (Mon, 11 Jun 2007)
New Revision: 1392

Modified:
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/screen.hpp
   trunk/windstille/src/screen_manager.cpp
   trunk/windstille/src/screen_manager.hpp
   trunk/windstille/src/sprite3dview.cpp
   trunk/windstille/src/title_screen.cpp
   trunk/windstille/src/title_screen.hpp
   trunk/windstille/src/windstille_main.cpp
Log:
- allow to leave the game and return to the title screen

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-11 19:47:18 UTC (rev 1391)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-11 20:12:34 UTC (rev 1392)
@@ -254,7 +254,7 @@
   GUIManager* manager = new GUIManager();
 
   GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 300-170), Sizef(500, 340)), 
-                                             "Select Scenario",
+                                             "Debug",
                                              manager->get_root());
 
   // Begin Main Menu
@@ -319,7 +319,7 @@
 
   // Launching Sprite3DView instead of game
   screen_manager.pop_overlay();
-  screen_manager.set_screen(sprite3dview);
+  screen_manager.push_screen(sprite3dview);
 }
   
 // Callbacks
@@ -327,7 +327,7 @@
 void
 MenuManager::menu_start_game()
 {
-  screen_manager.set_screen(new GameSession("levels/newformat2.wst"));
+  screen_manager.push_screen(new GameSession("levels/newformat2.wst"));
   screen_manager.pop_overlay();
 }
 
@@ -343,7 +343,7 @@
 MenuManager::menu_start_scenario(std::string scenario)
 {
   std::cout << "Starting: " << scenario << std::endl;
-  screen_manager.set_screen(new GameSession(scenario));
+  screen_manager.push_screen(new GameSession(scenario));
   screen_manager.clear_overlay();
  }
 
@@ -371,7 +371,7 @@
 {
   // FIXME: Make this return to the title screen
   screen_manager.pop_overlay();
-  screen_manager.quit(); 
+  screen_manager.pop_screen(); 
 }
 
 void

Modified: trunk/windstille/src/screen.hpp
===================================================================
--- trunk/windstille/src/screen.hpp	2007-06-11 19:47:18 UTC (rev 1391)
+++ trunk/windstille/src/screen.hpp	2007-06-11 20:12:34 UTC (rev 1392)
@@ -38,6 +38,8 @@
   Screen();
   virtual ~Screen();
 
+  virtual void on_startup() {}
+
   /** Draw the current screen */
   virtual void draw() =0;
 

Modified: trunk/windstille/src/screen_manager.cpp
===================================================================
--- trunk/windstille/src/screen_manager.cpp	2007-06-11 19:47:18 UTC (rev 1391)
+++ trunk/windstille/src/screen_manager.cpp	2007-06-11 20:12:34 UTC (rev 1392)
@@ -62,7 +62,8 @@
     overlap_delta(0),
     do_quit(false)
 {
-  screen = 0;
+  screen_action = NONE;
+  screen_screen = 0;
 
   overlay_screen_action = NONE;
   overlay_screen_screen = 0;
@@ -102,8 +103,8 @@
             {
               if (!overlay_screens.empty())
                 overlay_screens.back()->update(step, InputManager::get_controller());
-              else
-                screen->update(step, InputManager::get_controller());
+              else if (!screens.empty())
+                screens.back()->update(step, InputManager::get_controller());
             }
           InputManager::clear();
   
@@ -114,7 +115,8 @@
 
       sound_manager->update();
 
-      screen->draw();
+      if (!screens.empty())
+        screens.back()->draw();
 
       if (!overlay_screens.empty())
         overlay_screens.back()->draw();
@@ -139,7 +141,6 @@
           break;
 
         case CLEAR_SCREENS:
-          // FIXME: Might be insecure to do this here instead of in the update() loop
           for(std::vector<Screen*>::iterator i = overlay_screens.begin(); i != overlay_screens.end(); ++i)
             delete *i;
           overlay_screens.clear();
@@ -151,6 +152,31 @@
         }
       overlay_screen_action = NONE;
 
+      switch(screen_action)
+        {
+        case PUSH_SCREEN:
+          screens.push_back(screen_screen);
+          screens.back()->on_startup();
+          break;
+
+        case POP_SCREEN:
+          screens.pop_back();
+          if (!screens.empty())
+            screens.back()->on_startup();
+          break;
+
+        case CLEAR_SCREENS:
+          for(std::vector<Screen*>::iterator i = screens.begin(); i != screens.end(); ++i)
+            delete *i;
+          screens.clear();
+          break;
+
+        case NONE:
+          // nothing
+          break;
+        }
+      screen_action = NONE;
+
       poll_events();
     }
 }
@@ -239,8 +265,8 @@
                     {
                       if (!overlay_screens.empty())
                         overlay_screens.back()->handle_event(event);
-                      else
-                        screen->handle_event(event);
+                      else if (!screens.empty())
+                        screens.back()->handle_event(event);
                     }
                   break;
                 }
@@ -275,8 +301,8 @@
         default:
           if (!overlay_screens.empty())
             overlay_screens.back()->handle_event(event);
-          else              
-            screen->handle_event(event);
+          else if (!screens.empty())
+            screens.back()->handle_event(event);
           break;
         }
     }
@@ -299,13 +325,19 @@
 }
 
 void
-ScreenManager::set_screen(Screen* s)
+ScreenManager::push_screen(Screen* s)
 {
-  delete screen;
-  screen = s;
+  screen_action = PUSH_SCREEN;
+  screen_screen = s;
 }
 
 void
+ScreenManager::pop_screen()
+{
+  screen_action = POP_SCREEN;
+}
+
+void
 ScreenManager::push_overlay(Screen* s)
 {
   overlay_screen_action = PUSH_SCREEN;

Modified: trunk/windstille/src/screen_manager.hpp
===================================================================
--- trunk/windstille/src/screen_manager.hpp	2007-06-11 19:47:18 UTC (rev 1391)
+++ trunk/windstille/src/screen_manager.hpp	2007-06-11 20:12:34 UTC (rev 1392)
@@ -26,9 +26,6 @@
 #ifndef HEADER_SCREEN_MANAGER_HPP
 #define HEADER_SCREEN_MANAGER_HPP
 
-#include <vector>
-#include "signals/slot.hpp"
-
 class Screen;
 
 /**
@@ -38,13 +35,13 @@
 class ScreenManager
 {
 private:
-  std::vector<Slot> slots;
+  enum ScreenAction { NONE, POP_SCREEN, PUSH_SCREEN, CLEAR_SCREENS };
 
-  Screen* screen;
+  std::vector<Screen*> screens;
+  ScreenAction screen_action;
+  Screen*      screen_screen;
 
   std::vector<Screen*> overlay_screens;
-
-  enum ScreenAction { NONE, POP_SCREEN, PUSH_SCREEN, CLEAR_SCREENS };
   ScreenAction overlay_screen_action;
   Screen*      overlay_screen_screen;
 
@@ -66,8 +63,8 @@
   /** Breaks out of the run() function */
   void quit();
 
-  /** Sets the currently active screen */
-  void set_screen(Screen* s);
+  void push_screen(Screen* s);
+  void pop_screen();
 
   void push_overlay(Screen* s);
   void pop_overlay();

Modified: trunk/windstille/src/sprite3dview.cpp
===================================================================
--- trunk/windstille/src/sprite3dview.cpp	2007-06-11 19:47:18 UTC (rev 1391)
+++ trunk/windstille/src/sprite3dview.cpp	2007-06-11 20:12:34 UTC (rev 1392)
@@ -29,6 +29,7 @@
 #include "console.hpp"
 #include "font/ttf_font.hpp"
 #include "font/fonts.hpp"
+#include "screen_manager.hpp"
 #include "sprite3dview.hpp"
 
 Sprite3DView::Sprite3DView()
@@ -135,6 +136,11 @@
   roty += controller.get_axis_state(Y2_AXIS) * 50.0f * delta;
 
   //std::cout << controller.get_axis_state(Y2_AXIS) << std::endl;
+
+  Uint8 *keystate = SDL_GetKeyState(NULL);
+
+  if(keystate[SDLK_ESCAPE])
+    screen_manager.pop_screen();
 }
 
 /* EOF */

Modified: trunk/windstille/src/title_screen.cpp
===================================================================
--- trunk/windstille/src/title_screen.cpp	2007-06-11 19:47:18 UTC (rev 1391)
+++ trunk/windstille/src/title_screen.cpp	2007-06-11 20:12:34 UTC (rev 1392)
@@ -30,7 +30,6 @@
 TitleScreen::TitleScreen()
 {
   background = Sprite("images/titlescreen.sprite");
-  on_start();
 }
 
 TitleScreen::~TitleScreen()
@@ -38,7 +37,7 @@
 }
 
 void
-TitleScreen::on_start()
+TitleScreen::on_startup()
 {
   menu_manager.display_main_menu();
 }

Modified: trunk/windstille/src/title_screen.hpp
===================================================================
--- trunk/windstille/src/title_screen.hpp	2007-06-11 19:47:18 UTC (rev 1391)
+++ trunk/windstille/src/title_screen.hpp	2007-06-11 20:12:34 UTC (rev 1392)
@@ -39,7 +39,7 @@
   TitleScreen();
   ~TitleScreen();
 
-  void on_start();
+  void on_startup();
 
   void draw();
   void update(float delta, const Controller& controller);

Modified: trunk/windstille/src/windstille_main.cpp
===================================================================
--- trunk/windstille/src/windstille_main.cpp	2007-06-11 19:47:18 UTC (rev 1391)
+++ trunk/windstille/src/windstille_main.cpp	2007-06-11 20:12:34 UTC (rev 1392)
@@ -133,7 +133,7 @@
           sprite3dview->set_model(levelfile);
 
         // Launching Sprite3DView instead of game
-        screen_manager.set_screen(sprite3dview);
+        screen_manager.push_screen(sprite3dview);
       }
     else if (sprite2dview)
       {
@@ -143,25 +143,25 @@
           sprite2dview->set_sprite(levelfile);
 
         // Launching Sprite2DView instead of game
-        screen_manager.set_screen(sprite2dview);
+        screen_manager.push_screen(sprite2dview);
       }
     else if (particleview)
       {
         ParticleViewer* particle_viewer = new ParticleViewer();
         if (!levelfile.empty())
           particle_viewer->load(levelfile);
-        screen_manager.set_screen(particle_viewer);
+        screen_manager.push_screen(particle_viewer);
       }
     else
       {
         if (levelfile.empty())
           {
-            //screen_manager.set_screen(new GameSession("levels/newformat2.wst"));
-            screen_manager.set_screen(new TitleScreen());
+            //screen_manager.push_screen(new GameSession("levels/newformat2.wst"));
+            screen_manager.push_screen(new TitleScreen());
           }
         else
           {
-            screen_manager.set_screen(new GameSession(levelfile));
+            screen_manager.push_screen(new GameSession(levelfile));
           }
       }
         



From grumbel at mail.berlios.de  Mon Jun 11 23:20:10 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 11 Jun 2007 23:20:10 +0200
Subject: [Windstille-commit] r1393 - in trunk/windstille/src: . gui
Message-ID: <200706112120.l5BLKA4E028562@sheep.berlios.de>

Author: grumbel
Date: 2007-06-11 23:20:09 +0200 (Mon, 11 Jun 2007)
New Revision: 1393

Modified:
   trunk/windstille/src/gui/group_component.cpp
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/menu_manager.hpp
Log:
- added model list menu

Modified: trunk/windstille/src/gui/group_component.cpp
===================================================================
--- trunk/windstille/src/gui/group_component.cpp	2007-06-11 20:12:34 UTC (rev 1392)
+++ trunk/windstille/src/gui/group_component.cpp	2007-06-11 21:20:09 UTC (rev 1393)
@@ -47,7 +47,7 @@
 void
 GroupComponent::draw()
 {
-  Display::fill_rounded_rect(rect, 5.0f, Color(0.0f, 0.0f, 0.0f, 0.5f));
+  Display::fill_rounded_rect(rect, 5.0f, Color(0.0f, 0.0f, 0.0f, 0.7));
   Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 0.5f));
 
   if (!title.empty())

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-11 20:12:34 UTC (rev 1392)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-11 21:20:09 UTC (rev 1393)
@@ -139,7 +139,7 @@
   menu->add_item(select_scenario_button);
 
   ButtonMenuItem* model_viewer_button = new ButtonMenuItem(menu,  "Model Viewer");
-  slots.push_back(model_viewer_button->sig_click().connect(this, &MenuManager::menu_mode_viewer));
+  slots.push_back(model_viewer_button->sig_click().connect(this, &MenuManager::display_models_menu));
   menu->add_item(model_viewer_button);
 
   ButtonMenuItem* options_button = new ButtonMenuItem(menu,  "Options");
@@ -208,6 +208,44 @@
 }
 
 void
+MenuManager::display_models_menu()
+{
+  using namespace GUI;
+  GUIManager* manager = new GUIManager();
+
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 300-170), Sizef(500, 340)), 
+                                             "Select Model",
+                                             manager->get_root());
+
+  MenuComponent* menu = new MenuComponent(Rectf(), true, group);
+  group->pack(menu);
+
+  menu->set_font(Fonts::vera20);
+
+  std::vector<std::string> models;
+  models.push_back("models/characters/bob/bob.wsprite");
+  models.push_back("models/characters/jane/jane.wsprite");
+  models.push_back("models/characters/yagor/yagor.wsprite");
+  models.push_back("models/objects/pistol/pistol.wsprite");
+  models.push_back("models/vehicles/train/train.wsprite");
+  
+  for(std::vector<std::string>::iterator i = models.begin(); i != models.end(); ++i)
+    {
+      ButtonMenuItem* scenario_button = new ButtonMenuItem(menu,  *i);
+
+      slots.push_back(scenario_button->sig_click().connect<MenuManager, std::string>
+                      (this, &MenuManager::menu_show_model, 
+                       std::string(*i)));
+
+      menu->add_item(scenario_button);
+    }
+
+  manager->get_root()->add_child(group);
+
+  screen_manager.push_overlay(manager);  
+}
+
+void
 MenuManager::display_scenario_menu()
 {
   using namespace GUI;
@@ -288,22 +326,34 @@
   using namespace GUI;
   GUIManager* manager = new GUIManager();
 
-  GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 300-170), Sizef(500, 340)), 
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 300-200), Sizef(500, 400)), 
                                              "Credits",
                                              manager->get_root());
 
   TextView* text = new TextView(Rectf(), group);
-  text->set_font(Fonts::vera16);
-  text->set_text("<sin>Programming</sin>\n"
-                 "<sin>===========</sin>\n"
+  text->set_font(Fonts::vera12);
+  text->set_text("Programming\n"
+                 "===========\n"
                  "\n"
-                 "  Ingo Ruhnke &lt;grumbel at gmx.de&gt;\n"
-                 "  Matthias Braun matze at braunis.de\n"
-                 "  James Gregory\n"
-                 "  David Kamphausen &lt;david.kamphausen at web.de&gt;\n"
-                 "  Mark Dillavou &lt;line72 at line72.net&gt;\n"
+                 "  Ingo Ruhnke - Grumbel - &lt;grumbel at gmx.de&gt;\n"
+                 "  Matthias Braun - MatzeB - matze at braunis.de\n"
+                 "  James Gregory -\n"
+                 "  David Kamphausen - Godrin - &lt;david.kamphausen at web.de&gt;\n"
+                 "  Mark Dillavou - Line72- &lt;line72 at line72.net&gt;\n"
                  "\n"
-                 "incomplete placeholder, see AUTHORS for full list\n");
+                 "Graphics\n"
+                 "========\n"
+                 "  Ingo Ruhnke - Grumbel - &lt;grumbel at gmx.de&gt;\n"
+                 "  Ken Hirsch - quickflash - &lt;khirsch11414 at yahoo.com&gt;\n"
+                 "\n"
+                 "0.2.0 Win32 Build\n"
+                 "==================\n"
+                 "  Robert Konrad &lt;rkon at gmx.de&gt;\n"
+                 "\n"
+                 "Music\n"
+                 "=====\n"
+                 "  Ralph Weinert &lt;r.weinert at bluewin.ch&gt;\n"
+                 "  Marek Moeckel - Wansti - &lt;wansti at gmx.de&gt;\n");
   text->set_active(true);
 
   group->pack(text);
@@ -311,18 +361,20 @@
   manager->get_root()->add_child(group);
   screen_manager.push_overlay(manager);
 }
-
+  
+// Callbacks
+
 void
-MenuManager::menu_mode_viewer()
+MenuManager::menu_show_model(std::string model)
 {
   Sprite3DView* sprite3dview = new Sprite3DView();
 
+  sprite3dview->set_model(model);
+
   // Launching Sprite3DView instead of game
-  screen_manager.pop_overlay();
   screen_manager.push_screen(sprite3dview);
+  screen_manager.clear_overlay();
 }
-  
-// Callbacks
 
 void
 MenuManager::menu_start_game()

Modified: trunk/windstille/src/menu_manager.hpp
===================================================================
--- trunk/windstille/src/menu_manager.hpp	2007-06-11 20:12:34 UTC (rev 1392)
+++ trunk/windstille/src/menu_manager.hpp	2007-06-11 21:20:09 UTC (rev 1393)
@@ -43,6 +43,7 @@
   void display_main_menu();
   void display_pause_menu();
   void display_scenario_menu();
+  void display_models_menu();
   void display_credits();
 
   // Callbacks
@@ -54,7 +55,7 @@
   void menu_continue();
   void menu_ambient_light(int i, int component);
   void menu_start_scenario(std::string scenario);
-  void menu_mode_viewer();
+  void menu_show_model(std::string scenario);
 
 private:
   MenuManager (const MenuManager&);



From grumbel at mail.berlios.de  Mon Jun 11 23:53:38 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 11 Jun 2007 23:53:38 +0200
Subject: [Windstille-commit] r1394 - trunk/windstille/src
Message-ID: <200706112153.l5BLrcKS030771@sheep.berlios.de>

Author: grumbel
Date: 2007-06-11 23:53:38 +0200 (Mon, 11 Jun 2007)
New Revision: 1394

Modified:
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/menu_manager.hpp
   trunk/windstille/src/windstille_main.cpp
Log:
- added help screen

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-11 21:20:09 UTC (rev 1393)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-11 21:53:38 UTC (rev 1394)
@@ -123,7 +123,7 @@
                  "of the License, or (at your option) any later version.");
   manager->get_root()->add_child(text_group);
 
-  GroupComponent* group = new GroupComponent(Rectf(Vector(400, 250), Sizef(200, 210)),
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400, 230), Sizef(200, 250)),
                                              "",
                                              manager->get_root());
 
@@ -150,6 +150,10 @@
   slots.push_back(credits_button->sig_click().connect(this, &MenuManager::display_credits));
   menu->add_item(credits_button);
 
+  ButtonMenuItem* help_button = new ButtonMenuItem(menu,  "Help");
+  slots.push_back(help_button->sig_click().connect(this, &MenuManager::display_help));
+  menu->add_item(help_button);
+
   ButtonMenuItem* quit_button = new ButtonMenuItem(menu,  "Quit");
   slots.push_back(quit_button->sig_click().connect(this, &MenuManager::menu_quit));
   menu->add_item(quit_button);
@@ -197,6 +201,10 @@
   slots.push_back(credits_button->sig_click().connect(this, &MenuManager::display_credits));
   menu->add_item(credits_button);
 
+  ButtonMenuItem* help_button = new ButtonMenuItem(menu,  "Help");
+  slots.push_back(help_button->sig_click().connect(this, &MenuManager::display_help));
+  menu->add_item(help_button);
+
   ButtonMenuItem* quit_button = new ButtonMenuItem(menu,  "Return to Title Screen");
   slots.push_back(quit_button->sig_click().connect(this, &MenuManager::menu_exit));
   menu->add_item(quit_button);
@@ -321,6 +329,46 @@
 }
 
 void
+MenuManager::display_help()
+{
+  using namespace GUI;
+  GUIManager* manager = new GUIManager();
+
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 300-200), Sizef(500, 400)), 
+                                             "Help",
+                                             manager->get_root());
+
+  TextView* text = new TextView(Rectf(), group);
+  text->set_font(Fonts::vera12);
+  text->set_text("This is a tech-demo of Windstille. Its not meant "
+                 "to be playable in any way except a bit of walking around. "
+                 "It provides nothing to accomplish, just a few scenarios to "
+                 "load and look at. Enjoy what works, don't complain if something "
+                 "doesn't, since most stuff simply won't work anyway.\n"
+                 "\n"
+                 "Key Bindings\n"
+                 "============\n"
+                 "F1 - open the console\n"
+                 "F6 - mouse release\n"
+                 "F7 - mouse grap\n"
+                 "F8 - run gui test (broken)\n"
+                 "F9 - configure input\n"
+                 "F11 - toggle fullscreen\n"
+                 "F12 - do a screenshot\n"
+                 "\n"
+                 "cursor keys - walk\n"
+                 "d - run/cancel\n"
+                 "s - jump/ok\n"
+                 );
+  text->set_active(true);
+
+  group->pack(text);
+
+  manager->get_root()->add_child(group);
+  screen_manager.push_overlay(manager);
+}
+
+void
 MenuManager::display_credits()
 {
   using namespace GUI;

Modified: trunk/windstille/src/menu_manager.hpp
===================================================================
--- trunk/windstille/src/menu_manager.hpp	2007-06-11 21:20:09 UTC (rev 1393)
+++ trunk/windstille/src/menu_manager.hpp	2007-06-11 21:53:38 UTC (rev 1394)
@@ -45,6 +45,7 @@
   void display_scenario_menu();
   void display_models_menu();
   void display_credits();
+  void display_help();
 
   // Callbacks
   void menu_start_game();

Modified: trunk/windstille/src/windstille_main.cpp
===================================================================
--- trunk/windstille/src/windstille_main.cpp	2007-06-11 21:20:09 UTC (rev 1393)
+++ trunk/windstille/src/windstille_main.cpp	2007-06-11 21:53:38 UTC (rev 1394)
@@ -165,13 +165,6 @@
           }
       }
         
-    console << "F1 - open the console" << std::endl;
-    console << "F6 - mouse release" << std::endl;
-    console << "F7 - mouse grap" << std::endl;;
-    console << "F8 - run gui test" << std::endl;;
-    console << "F9 - configure input" << std::endl;
-    console << "F11 - toggle fullscreen" << std::endl;
-    console << "F12 - do a screenshot" << std::endl;
     screen_manager.run();
     
     TileFactory::deinit();



From grumbel at mail.berlios.de  Mon Jun 11 23:56:55 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 11 Jun 2007 23:56:55 +0200
Subject: [Windstille-commit] r1395 - trunk/windstille
Message-ID: <200706112156.l5BLutL1031008@sheep.berlios.de>

Author: grumbel
Date: 2007-06-11 23:56:55 +0200 (Mon, 11 Jun 2007)
New Revision: 1395

Added:
   trunk/windstille/Makefile
Log:
- dummy Makefile to call scons

Added: trunk/windstille/Makefile
===================================================================
--- trunk/windstille/Makefile	2007-06-11 21:53:38 UTC (rev 1394)
+++ trunk/windstille/Makefile	2007-06-11 21:56:55 UTC (rev 1395)
@@ -0,0 +1,4 @@
+all:
+	scons
+
+# EOF #



From grumbel at mail.berlios.de  Tue Jun 12 01:34:34 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 01:34:34 +0200
Subject: [Windstille-commit] r1396 - in trunk/windstille: . src/input
Message-ID: <200706112334.l5BNYY5Y018022@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 01:34:33 +0200 (Tue, 12 Jun 2007)
New Revision: 1396

Modified:
   trunk/windstille/config.h
   trunk/windstille/src/input/input_configurator.cpp
   trunk/windstille/src/input/input_manager_sdl.cpp
Log:
added hardcoded default config for escape and enter

Modified: trunk/windstille/config.h
===================================================================
--- trunk/windstille/config.h	2007-06-11 21:56:55 UTC (rev 1395)
+++ trunk/windstille/config.h	2007-06-11 23:34:33 UTC (rev 1396)
@@ -1,4 +1,4 @@
-/* config.h.  Generated by configure.  */
+/* config.h.  Generated from config.h.in by configure.  */
 /* config.h.in.  Generated from configure.ac by autoheader.  */
 
 /* Include pthread support for binary relocation? */

Modified: trunk/windstille/src/input/input_configurator.cpp
===================================================================
--- trunk/windstille/src/input/input_configurator.cpp	2007-06-11 21:56:55 UTC (rev 1395)
+++ trunk/windstille/src/input/input_configurator.cpp	2007-06-11 23:34:33 UTC (rev 1396)
@@ -231,6 +231,10 @@
           screen_manager.pop_overlay();
           //next_item();
         }
+      else if (event.key.keysym.sym == SDLK_RETURN)
+        {
+          std::cout << "Binding the enter key is not allowed" << std::endl;
+        }
       else
         {
           if (items.back().mode == ConfigureItem::CONFIGURE_BUTTON)

Modified: trunk/windstille/src/input/input_manager_sdl.cpp
===================================================================
--- trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-11 21:56:55 UTC (rev 1395)
+++ trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-11 23:34:33 UTC (rev 1396)
@@ -193,6 +193,17 @@
 void
 InputManagerSDL::on_key_event(const SDL_KeyboardEvent& event)
 {
+  // Hardcoded defaults
+  if (event.keysym.sym == SDLK_RETURN)
+    {
+      add_button_event(OK_BUTTON, event.state);
+    }
+  else if (event.keysym.sym == SDLK_ESCAPE)
+    {
+      add_button_event(CANCEL_BUTTON, event.state);
+    }
+
+  // Dynamic bindings
   for (std::vector<KeyboardButtonBinding>::const_iterator i = impl->keyboard_button_bindings.begin();
        i != impl->keyboard_button_bindings.end();
        ++i)



From grumbel at mail.berlios.de  Tue Jun 12 05:06:02 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 05:06:02 +0200
Subject: [Windstille-commit] r1397 - in trunk/windstille: . data data/music
	data/sounds src src/display src/gui
Message-ID: <200706120306.l5C362Ae030559@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 05:06:00 +0200 (Tue, 12 Jun 2007)
New Revision: 1397

Added:
   trunk/windstille/data/music/
   trunk/windstille/data/music/Windstille_Ralph_Weinert.ogg
   trunk/windstille/data/music/jingle.ogg
   trunk/windstille/data/music/nightfall.ogg
   trunk/windstille/data/music/silence_wip.ogg
   trunk/windstille/data/music/techdemo.ogg
   trunk/windstille/data/sounds/README
   trunk/windstille/data/sounds/menu_change.wav
   trunk/windstille/data/sounds/menu_click.wav
Modified:
   trunk/windstille/
   trunk/windstille/SConstruct
   trunk/windstille/src/SConscript
   trunk/windstille/src/display/scene_context.cpp
   trunk/windstille/src/gui/component.cpp
   trunk/windstille/src/gui/menu_component.cpp
Log:
- added some annoying sound effects to the menu


Property changes on: trunk/windstille
___________________________________________________________________
Name: svn:ignore
   - 
cache
cache/
.sconsign.dblite
windstille

   + 
aclocal.m4
autom4te.cache
cache
cache/
config.h.in
config.log
config.status
configure
custom.py
Jamconfig
Jamconfig.in
.sconsign.dblite
windstille


Modified: trunk/windstille/SConstruct
===================================================================
--- trunk/windstille/SConstruct	2007-06-11 23:34:33 UTC (rev 1396)
+++ trunk/windstille/SConstruct	2007-06-12 03:06:00 UTC (rev 1397)
@@ -86,8 +86,8 @@
 
 env = Environment(options=opts)
 
-env["CACHEDIR"] = "cache/"
-if not os.path.isdir(env['CACHEDIR']): os.mkdir(env['CACHEDIR'])
+# env["CACHEDIR"] = "cache/"
+# if not os.path.isdir(env['CACHEDIR']): os.mkdir(env['CACHEDIR'])
 
 # env.BuildDir('build2', '.')
 

Added: trunk/windstille/data/music/Windstille_Ralph_Weinert.ogg
===================================================================
--- trunk/windstille/data/music/Windstille_Ralph_Weinert.ogg	2007-06-11 23:34:33 UTC (rev 1396)
+++ trunk/windstille/data/music/Windstille_Ralph_Weinert.ogg	2007-06-12 03:06:00 UTC (rev 1397)
@@ -0,0 +1 @@
+link ../../../media/music/Windstille_Ralph_Weinert.ogg
\ No newline at end of file


Property changes on: trunk/windstille/data/music/Windstille_Ralph_Weinert.ogg
___________________________________________________________________
Name: svn:special
   + *

Added: trunk/windstille/data/music/jingle.ogg
===================================================================
--- trunk/windstille/data/music/jingle.ogg	2007-06-11 23:34:33 UTC (rev 1396)
+++ trunk/windstille/data/music/jingle.ogg	2007-06-12 03:06:00 UTC (rev 1397)
@@ -0,0 +1 @@
+link ../../../media/music/jingle.ogg
\ No newline at end of file


Property changes on: trunk/windstille/data/music/jingle.ogg
___________________________________________________________________
Name: svn:special
   + *

Added: trunk/windstille/data/music/nightfall.ogg
===================================================================
--- trunk/windstille/data/music/nightfall.ogg	2007-06-11 23:34:33 UTC (rev 1396)
+++ trunk/windstille/data/music/nightfall.ogg	2007-06-12 03:06:00 UTC (rev 1397)
@@ -0,0 +1 @@
+link ../../../media/music/nightfall.ogg
\ No newline at end of file


Property changes on: trunk/windstille/data/music/nightfall.ogg
___________________________________________________________________
Name: svn:special
   + *

Added: trunk/windstille/data/music/silence_wip.ogg
===================================================================
--- trunk/windstille/data/music/silence_wip.ogg	2007-06-11 23:34:33 UTC (rev 1396)
+++ trunk/windstille/data/music/silence_wip.ogg	2007-06-12 03:06:00 UTC (rev 1397)
@@ -0,0 +1 @@
+link ../../../media/music/silence_wip.ogg
\ No newline at end of file


Property changes on: trunk/windstille/data/music/silence_wip.ogg
___________________________________________________________________
Name: svn:special
   + *

Added: trunk/windstille/data/music/techdemo.ogg
===================================================================
--- trunk/windstille/data/music/techdemo.ogg	2007-06-11 23:34:33 UTC (rev 1396)
+++ trunk/windstille/data/music/techdemo.ogg	2007-06-12 03:06:00 UTC (rev 1397)
@@ -0,0 +1 @@
+link ../../../media/music/techdemo.ogg
\ No newline at end of file


Property changes on: trunk/windstille/data/music/techdemo.ogg
___________________________________________________________________
Name: svn:special
   + *

Added: trunk/windstille/data/sounds/README
===================================================================
--- trunk/windstille/data/sounds/README	2007-06-11 23:34:33 UTC (rev 1396)
+++ trunk/windstille/data/sounds/README	2007-06-12 03:06:00 UTC (rev 1397)
@@ -0,0 +1,4 @@
+Based on OpenArea sound effect ./sound/misc/menu1.wav:
+======================================================
+menu_change.wav
+menu_click.wav
\ No newline at end of file

Added: trunk/windstille/data/sounds/menu_change.wav
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/sounds/menu_change.wav
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/windstille/data/sounds/menu_click.wav
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/sounds/menu_click.wav
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-11 23:34:33 UTC (rev 1396)
+++ trunk/windstille/src/SConscript	2007-06-12 03:06:00 UTC (rev 1397)
@@ -27,6 +27,7 @@
 SConscript("squirrel/SConstruct")
 
 env = Environment(CC = 'gcc',
+                  CXX = 'g++',
                   CCFLAGS = ['-O0', '-Wall', '-Werror', '-g', '-DDEBUG'])
 
 # env.Copy(LIBS = ['a', 'b'])
@@ -35,6 +36,8 @@
 env.ParseConfig('sdl-config --cflags --libs')
 env.ParseConfig('freetype-config --libs --cflags')
 
+# env['ENV']['LSBCC_SHAREDLIBS'] = 'png2:SDL:SDL_image:vorbis:ogg:openal:physfs'
+
 env.Program('../windstille', [
 'baby_xml.cpp',
 'blitter.cpp',

Modified: trunk/windstille/src/display/scene_context.cpp
===================================================================
--- trunk/windstille/src/display/scene_context.cpp	2007-06-11 23:34:33 UTC (rev 1396)
+++ trunk/windstille/src/display/scene_context.cpp	2007-06-12 03:06:00 UTC (rev 1397)
@@ -463,6 +463,7 @@
 
     default:
       assert(!"SceneContext::get_layer(): Unknown type");
+      return impl->color; // never reached, but makes compiler happy
     }
 }
 

Modified: trunk/windstille/src/gui/component.cpp
===================================================================
--- trunk/windstille/src/gui/component.cpp	2007-06-11 23:34:33 UTC (rev 1396)
+++ trunk/windstille/src/gui/component.cpp	2007-06-12 03:06:00 UTC (rev 1397)
@@ -75,12 +75,14 @@
 Component::get_prefered_width() const
 {
   assert(!"Implement me");
+  return 100.0f;
 }
 
 float
 Component::get_prefered_height() const
 {
   assert(!"Implement me");
+  return 100.0f;
 }
 
 } // namespace GUI

Modified: trunk/windstille/src/gui/menu_component.cpp
===================================================================
--- trunk/windstille/src/gui/menu_component.cpp	2007-06-11 23:34:33 UTC (rev 1396)
+++ trunk/windstille/src/gui/menu_component.cpp	2007-06-12 03:06:00 UTC (rev 1397)
@@ -24,6 +24,7 @@
 */
 
 #include <iostream>
+#include "sound/sound_manager.hpp"
 #include "input/controller.hpp"
 #include "menu_component.hpp"
 #include "gui/tab_component.hpp"
@@ -82,6 +83,8 @@
 void
 EnumMenuItem::incr()
 {
+  sound_manager->play("sounds/menu_click.wav");           
+
   index -= 1;
   if (index < 0)
     index = labels.size()-1;
@@ -91,6 +94,8 @@
 void
 EnumMenuItem::decr()
 {
+  sound_manager->play("sounds/menu_click.wav");
+
   index += 1;
   if (index >= static_cast<int>(labels.size()))
     index = 0;
@@ -138,6 +143,8 @@
 void
 SliderMenuItem::decr()
 {
+  sound_manager->play("sounds/menu_click.wav");
+
   value += step;
   if (value > max_value)
     value = max_value;
@@ -147,6 +154,8 @@
 void
 SliderMenuItem::incr()
 {
+  sound_manager->play("sounds/menu_click.wav");
+
   value -= step;
   if (value < min_value)
     value = min_value;
@@ -196,6 +205,8 @@
 void
 ButtonMenuItem::click()
 {
+  sound_manager->play("sounds/menu_click.wav");
+
   on_click();
 }
 
@@ -282,6 +293,8 @@
             {
               if (i->axis.pos < 0)
                 {
+                  sound_manager->play("sounds/menu_change.wav");
+                                        
                   current_item = current_item - 1;
                   if (current_item < 0)
                     {
@@ -298,6 +311,8 @@
                 }
               else if (i->axis.pos > 0)
                 {
+                  sound_manager->play("sounds/menu_change.wav");
+
                   if (dynamic_cast<TabComponent*>(parent))
                     {
                       current_item = Math::mid(0, current_item + 1, static_cast<int>(items.size()-1)); 



From grumbel at mail.berlios.de  Tue Jun 12 05:39:46 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 05:39:46 +0200
Subject: [Windstille-commit] r1398 - in trunk/windstille: data/images
	data/particlesystems data/shader src src/gui src/objects
Message-ID: <200706120339.l5C3dkj0032475@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 05:39:45 +0200 (Tue, 12 Jun 2007)
New Revision: 1398

Added:
   trunk/windstille/data/images/greychess.png
Modified:
   trunk/windstille/data/particlesystems/fire.particles
   trunk/windstille/data/shader/particledeform.frag
   trunk/windstille/data/shader/shockwave.frag
   trunk/windstille/data/shader/shockwave2.frag
   trunk/windstille/src/gui/menu_component.cpp
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/menu_manager.hpp
   trunk/windstille/src/objects/shockwave.hpp
   trunk/windstille/src/particle_viewer.cpp
   trunk/windstille/src/sprite3dview.cpp
Log:
- added the particle viewer to the menu
- fixed the a bit shader

Added: trunk/windstille/data/images/greychess.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/greychess.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Modified: trunk/windstille/data/particlesystems/fire.particles
===================================================================
--- trunk/windstille/data/particlesystems/fire.particles	2007-06-12 03:06:00 UTC (rev 1397)
+++ trunk/windstille/data/particlesystems/fire.particles	2007-06-12 03:39:45 UTC (rev 1398)
@@ -60,20 +60,20 @@
 
 
  ;; Deform
- (particle-system
-  (pos 0 0)
-        (lifetime 2.0)
-  (count 25)
-  (z-pos 1100)
-  (layer "highlight")
-  (velocity 200 300)
-  (cone -95 -85)
-  (gravity 0 -0.3)
-  (size 1.5 1.0)
-  (distribution (line-distribution (x1 -50) (y1 0) (x2 50) (y2 0)))
-  (drawer (deform-drawer (image "images/particles/smoke.png")
-                                 (blendfunc-src "src_alpha")
-                                  (blendfunc-dst "one"))))
+; (particle-system
+;  (pos 0 0)
+;        (lifetime 2.0)
+;  (count 25)
+;  (z-pos 1100)
+;  (layer "highlight")
+;  (velocity 200 300)
+;  (cone -95 -85)
+;  (gravity 0 -0.3)
+;  (size 1.5 1.0)
+;  (distribution (line-distribution (x1 -50) (y1 0) (x2 50) (y2 0)))
+;  (drawer (deform-drawer (image "images/particles/smoke.png")
+;                                 (blendfunc-src "src_alpha")
+;                                  (blendfunc-dst "one"))))
 
 
 

Modified: trunk/windstille/data/shader/particledeform.frag
===================================================================
--- trunk/windstille/data/shader/particledeform.frag	2007-06-12 03:06:00 UTC (rev 1397)
+++ trunk/windstille/data/shader/particledeform.frag	2007-06-12 03:39:45 UTC (rev 1398)
@@ -1,5 +1,7 @@
 // -*- c++ -*-
 
+#extension GL_ARB_texture_rectangle : enable
+
 uniform sampler2DRect screen;
 uniform sampler2DRect particles;
 

Modified: trunk/windstille/data/shader/shockwave.frag
===================================================================
--- trunk/windstille/data/shader/shockwave.frag	2007-06-12 03:06:00 UTC (rev 1397)
+++ trunk/windstille/data/shader/shockwave.frag	2007-06-12 03:39:45 UTC (rev 1398)
@@ -1,5 +1,7 @@
 // -*- c++ -*-
 
+#extension GL_ARB_texture_rectangle : enable
+
 uniform float radius;
 uniform sampler2D background_tex;
 uniform sampler2D noise_tex;

Modified: trunk/windstille/data/shader/shockwave2.frag
===================================================================
--- trunk/windstille/data/shader/shockwave2.frag	2007-06-12 03:06:00 UTC (rev 1397)
+++ trunk/windstille/data/shader/shockwave2.frag	2007-06-12 03:39:45 UTC (rev 1398)
@@ -2,6 +2,8 @@
 
 // Shockwave shader, good look version
 
+#extension GL_ARB_texture_rectangle : enable
+
 uniform sampler2DRect background_tex;
 uniform sampler2D noise_tex;
 uniform float     radius;

Modified: trunk/windstille/src/gui/menu_component.cpp
===================================================================
--- trunk/windstille/src/gui/menu_component.cpp	2007-06-12 03:06:00 UTC (rev 1397)
+++ trunk/windstille/src/gui/menu_component.cpp	2007-06-12 03:39:45 UTC (rev 1398)
@@ -273,7 +273,10 @@
           else if (i->button.name == CANCEL_BUTTON)
             {
               if (allow_cancel) // FIXME: Could use a signal instead
-                set_active(false);
+                {
+                  sound_manager->play("sounds/menu_click.wav");
+                  set_active(false);
+                }
             }
         }
       else if (i->type == AXIS_EVENT)

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-12 03:06:00 UTC (rev 1397)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-12 03:39:45 UTC (rev 1398)
@@ -27,13 +27,14 @@
 #include "console.hpp"
 #include "display/display.hpp"
 #include "font/fonts.hpp"
+#include "game_session.hpp"
+#include "gui/group_component.hpp"
 #include "gui/gui_manager.hpp"
+#include "gui/menu_component.hpp"
 #include "gui/root_component.hpp"
 #include "gui/text_view.hpp"
-#include "gui/group_component.hpp"
+#include "particle_viewer.hpp"
 #include "screen_manager.hpp"
-#include "gui/menu_component.hpp"
-#include "game_session.hpp"
 #include "sector.hpp"
 #include "sprite3d/manager.hpp"
 #include "sprite3dview.hpp"
@@ -123,7 +124,7 @@
                  "of the License, or (at your option) any later version.");
   manager->get_root()->add_child(text_group);
 
-  GroupComponent* group = new GroupComponent(Rectf(Vector(400, 230), Sizef(200, 250)),
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400, 200), Sizef(200, 294)),
                                              "",
                                              manager->get_root());
 
@@ -142,6 +143,10 @@
   slots.push_back(model_viewer_button->sig_click().connect(this, &MenuManager::display_models_menu));
   menu->add_item(model_viewer_button);
 
+  ButtonMenuItem* particles_button = new ButtonMenuItem(menu,  "Particle Systems");
+  slots.push_back(particles_button->sig_click().connect(this, &MenuManager::display_particle_menu));
+  menu->add_item(particles_button);
+
   ButtonMenuItem* options_button = new ButtonMenuItem(menu,  "Options");
   slots.push_back(options_button->sig_click().connect(this, &MenuManager::display_option_menu));
   menu->add_item(options_button);
@@ -252,7 +257,41 @@
 
   screen_manager.push_overlay(manager);  
 }
+
+void
+MenuManager::display_particle_menu()
+{
+  using namespace GUI;
+  GUIManager* manager = new GUIManager();
 
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-200, 300-170), Sizef(400, 340)), 
+                                             "Particle Systems",
+                                             manager->get_root());
+
+  MenuComponent* menu = new MenuComponent(Rectf(), true, group);
+  group->pack(menu);
+
+  menu->set_font(Fonts::vera20);
+
+  std::vector<std::string> scenarios;
+  scenarios.push_back("particlesystems/fire.particles");
+  
+  for(std::vector<std::string>::iterator i = scenarios.begin(); i != scenarios.end(); ++i)
+    {
+      ButtonMenuItem* scenario_button = new ButtonMenuItem(menu,  *i);
+
+      slots.push_back(scenario_button->sig_click().connect<MenuManager, std::string>
+                      (this, &MenuManager::menu_show_particle_system, 
+                       std::string(*i)));
+
+      menu->add_item(scenario_button);
+    }
+
+  manager->get_root()->add_child(group);
+
+  screen_manager.push_overlay(manager); 
+}
+
 void
 MenuManager::display_scenario_menu()
 {
@@ -425,6 +464,16 @@
 }
 
 void
+MenuManager::menu_show_particle_system(std::string file)
+{
+  ParticleViewer* particle_viewer = new ParticleViewer();
+  particle_viewer->load(file);
+
+  screen_manager.push_screen(particle_viewer);
+  screen_manager.clear_overlay();
+}
+
+void
 MenuManager::menu_start_game()
 {
   screen_manager.push_screen(new GameSession("levels/newformat2.wst"));

Modified: trunk/windstille/src/menu_manager.hpp
===================================================================
--- trunk/windstille/src/menu_manager.hpp	2007-06-12 03:06:00 UTC (rev 1397)
+++ trunk/windstille/src/menu_manager.hpp	2007-06-12 03:39:45 UTC (rev 1398)
@@ -43,6 +43,7 @@
   void display_main_menu();
   void display_pause_menu();
   void display_scenario_menu();
+  void display_particle_menu();
   void display_models_menu();
   void display_credits();
   void display_help();
@@ -57,7 +58,7 @@
   void menu_ambient_light(int i, int component);
   void menu_start_scenario(std::string scenario);
   void menu_show_model(std::string scenario);
-
+  void menu_show_particle_system(std::string file);
 private:
   MenuManager (const MenuManager&);
   MenuManager& operator= (const MenuManager&);

Modified: trunk/windstille/src/objects/shockwave.hpp
===================================================================
--- trunk/windstille/src/objects/shockwave.hpp	2007-06-12 03:06:00 UTC (rev 1397)
+++ trunk/windstille/src/objects/shockwave.hpp	2007-06-12 03:39:45 UTC (rev 1398)
@@ -38,6 +38,7 @@
   Texture       noise;
   ShaderProgram shader_program;
   float radius;
+
 public:
   Shockwave(FileReader& props);
   ~Shockwave();

Modified: trunk/windstille/src/particle_viewer.cpp
===================================================================
--- trunk/windstille/src/particle_viewer.cpp	2007-06-12 03:06:00 UTC (rev 1397)
+++ trunk/windstille/src/particle_viewer.cpp	2007-06-12 03:39:45 UTC (rev 1398)
@@ -188,6 +188,10 @@
           show_gui = true;
           manager->get_root()->get_focus()->set_active(true);
         }
+      else if (controller.button_was_pressed(CANCEL_BUTTON))
+        {
+          screen_manager.pop_screen();
+        }
     }
   else
     {

Modified: trunk/windstille/src/sprite3dview.cpp
===================================================================
--- trunk/windstille/src/sprite3dview.cpp	2007-06-12 03:06:00 UTC (rev 1397)
+++ trunk/windstille/src/sprite3dview.cpp	2007-06-12 03:39:45 UTC (rev 1398)
@@ -139,7 +139,7 @@
 
   Uint8 *keystate = SDL_GetKeyState(NULL);
 
-  if(keystate[SDLK_ESCAPE])
+  if(keystate[SDLK_ESCAPE]) // FIXME: Use cancel button instead
     screen_manager.pop_screen();
 }
 



From grumbel at mail.berlios.de  Tue Jun 12 14:51:03 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 14:51:03 +0200
Subject: [Windstille-commit] r1399 - in trunk/windstille/src: . gui input
Message-ID: <200706121251.l5CCp3iE002871@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 14:51:02 +0200 (Tue, 12 Jun 2007)
New Revision: 1399

Modified:
   trunk/windstille/src/controller_def.hpp
   trunk/windstille/src/game_session.cpp
   trunk/windstille/src/gui/button.cpp
   trunk/windstille/src/gui/list_view.cpp
   trunk/windstille/src/gui/menu_component.cpp
   trunk/windstille/src/gui/slider.cpp
   trunk/windstille/src/gui/tab_component.cpp
   trunk/windstille/src/gui/text_view.cpp
   trunk/windstille/src/input/input_manager_sdl.cpp
   trunk/windstille/src/particle_viewer.cpp
   trunk/windstille/src/sprite3dview.cpp
Log:
- added ESCAPE/ENTER_BUTTON to the controller, changed GUI code to handle them

Modified: trunk/windstille/src/controller_def.hpp
===================================================================
--- trunk/windstille/src/controller_def.hpp	2007-06-12 03:39:45 UTC (rev 1398)
+++ trunk/windstille/src/controller_def.hpp	2007-06-12 12:51:02 UTC (rev 1399)
@@ -51,6 +51,11 @@
     PAUSE_BUTTON,     // used to pause the game
     AIM_BUTTON,       // used to draw the gun and aim
 
+    // These are not to be used alone, but only as alternatives for
+    // other keys
+    ESCAPE_BUTTON,    // hardcoded to escape key
+    ENTER_BUTTON,     // hardcoded to enter key
+
     LAST_EVENT
   };
 

Modified: trunk/windstille/src/game_session.cpp
===================================================================
--- trunk/windstille/src/game_session.cpp	2007-06-12 03:39:45 UTC (rev 1398)
+++ trunk/windstille/src/game_session.cpp	2007-06-12 12:51:02 UTC (rev 1399)
@@ -285,15 +285,10 @@
       else
         current_gui = &inventory;
     }
-
-  if(keystate[SDLK_ESCAPE])
+  else if (controller.button_was_pressed(ESCAPE_BUTTON))
     {
       menu_manager.display_pause_menu();
     }
-  else if(keystate[SDLK_F2])
-    {
-      menu_manager.display_debug_menu();
-    }
 }
 
 void
@@ -375,6 +370,10 @@
                 console << "Collision Debugging " << (collision_debug ? "enabled" : "disabled") << std::endl;
               }
               break;
+
+            case SDLK_F2:
+              menu_manager.display_debug_menu();
+              break;
         
             default:
               break;

Modified: trunk/windstille/src/gui/button.cpp
===================================================================
--- trunk/windstille/src/gui/button.cpp	2007-06-12 03:39:45 UTC (rev 1398)
+++ trunk/windstille/src/gui/button.cpp	2007-06-12 12:51:02 UTC (rev 1399)
@@ -70,7 +70,7 @@
           if (i->button.name == OK_BUTTON)
             {
             }
-          else if (i->button.name == CANCEL_BUTTON)
+          else if (i->button.name == CANCEL_BUTTON || i->button.name == ESCAPE_BUTTON)
             {            
               set_active(false);
             }

Modified: trunk/windstille/src/gui/list_view.cpp
===================================================================
--- trunk/windstille/src/gui/list_view.cpp	2007-06-12 03:39:45 UTC (rev 1398)
+++ trunk/windstille/src/gui/list_view.cpp	2007-06-12 12:51:02 UTC (rev 1399)
@@ -92,7 +92,7 @@
             {
               // do something with item (scripting callback)
             }
-          else if (i->button.name == CANCEL_BUTTON)
+          else if (i->button.name == CANCEL_BUTTON || i->button.name == ESCAPE_BUTTON)
             {
               set_active(false);
             }

Modified: trunk/windstille/src/gui/menu_component.cpp
===================================================================
--- trunk/windstille/src/gui/menu_component.cpp	2007-06-12 03:39:45 UTC (rev 1398)
+++ trunk/windstille/src/gui/menu_component.cpp	2007-06-12 12:51:02 UTC (rev 1399)
@@ -266,11 +266,11 @@
     {
       if (i->type == BUTTON_EVENT && i->button.down)
         {
-          if (i->button.name == OK_BUTTON)
+          if (i->button.name == OK_BUTTON || i->button.name == ENTER_BUTTON)
             {
               items[current_item]->click();
             }
-          else if (i->button.name == CANCEL_BUTTON)
+          else if (i->button.name == CANCEL_BUTTON || i->button.name == ESCAPE_BUTTON)
             {
               if (allow_cancel) // FIXME: Could use a signal instead
                 {

Modified: trunk/windstille/src/gui/slider.cpp
===================================================================
--- trunk/windstille/src/gui/slider.cpp	2007-06-12 03:39:45 UTC (rev 1398)
+++ trunk/windstille/src/gui/slider.cpp	2007-06-12 12:51:02 UTC (rev 1399)
@@ -97,11 +97,11 @@
     {
       if (i->type == BUTTON_EVENT && i->button.down)
         {
-          if (i->button.name == OK_BUTTON)
+          if (i->button.name == OK_BUTTON || i->button.name == ENTER_BUTTON)
             {
               
             }
-          else if (i->button.name == CANCEL_BUTTON)           
+          else if (i->button.name == CANCEL_BUTTON || i->button.name == ESCAPE_BUTTON)
             {
               set_active(false);
             }

Modified: trunk/windstille/src/gui/tab_component.cpp
===================================================================
--- trunk/windstille/src/gui/tab_component.cpp	2007-06-12 03:39:45 UTC (rev 1398)
+++ trunk/windstille/src/gui/tab_component.cpp	2007-06-12 12:51:02 UTC (rev 1399)
@@ -93,11 +93,11 @@
         {
           if (i->type == BUTTON_EVENT && i->button.down)
             {
-              if (i->button.name == OK_BUTTON)
+              if (i->button.name == OK_BUTTON || i->button.name == ENTER_BUTTON)
                 {
                   tabs[current_tab].component->set_active(true);
                 }
-              else if (i->button.name == CANCEL_BUTTON)
+              else if (i->button.name == CANCEL_BUTTON || i->button.name == ESCAPE_BUTTON)
                 {
                   tabs[current_tab].component->set_active(false);
                   set_active(false);

Modified: trunk/windstille/src/gui/text_view.cpp
===================================================================
--- trunk/windstille/src/gui/text_view.cpp	2007-06-12 03:39:45 UTC (rev 1398)
+++ trunk/windstille/src/gui/text_view.cpp	2007-06-12 12:51:02 UTC (rev 1399)
@@ -53,11 +53,11 @@
     {
       if (i->type == BUTTON_EVENT && i->button.down)
         {
-          if (i->button.name == OK_BUTTON)
+          if (i->button.name == OK_BUTTON || i->button.name == ENTER_BUTTON)
             {
               set_active(false);
             }
-          else if (i->button.name == CANCEL_BUTTON)
+          else if (i->button.name == CANCEL_BUTTON || i->button.name == ESCAPE_BUTTON)
             {            
               set_active(false);
             }

Modified: trunk/windstille/src/input/input_manager_sdl.cpp
===================================================================
--- trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-12 03:39:45 UTC (rev 1398)
+++ trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-12 12:51:02 UTC (rev 1399)
@@ -196,11 +196,11 @@
   // Hardcoded defaults
   if (event.keysym.sym == SDLK_RETURN)
     {
-      add_button_event(OK_BUTTON, event.state);
+      add_button_event(ENTER_BUTTON, event.state);
     }
   else if (event.keysym.sym == SDLK_ESCAPE)
     {
-      add_button_event(CANCEL_BUTTON, event.state);
+      add_button_event(ESCAPE_BUTTON, event.state);
     }
 
   // Dynamic bindings

Modified: trunk/windstille/src/particle_viewer.cpp
===================================================================
--- trunk/windstille/src/particle_viewer.cpp	2007-06-12 03:39:45 UTC (rev 1398)
+++ trunk/windstille/src/particle_viewer.cpp	2007-06-12 12:51:02 UTC (rev 1399)
@@ -185,10 +185,12 @@
 
       if (controller.button_was_pressed(OK_BUTTON))
         {
-          show_gui = true;
-          manager->get_root()->get_focus()->set_active(true);
+          // FIXME: Disable GUI, since its crashy
+          // show_gui = true;
+          // manager->get_root()->get_focus()->set_active(true);
         }
-      else if (controller.button_was_pressed(CANCEL_BUTTON))
+      else if (controller.button_was_pressed(CANCEL_BUTTON) ||
+               controller.button_was_pressed(ESCAPE_BUTTON))
         {
           screen_manager.pop_screen();
         }

Modified: trunk/windstille/src/sprite3dview.cpp
===================================================================
--- trunk/windstille/src/sprite3dview.cpp	2007-06-12 03:39:45 UTC (rev 1398)
+++ trunk/windstille/src/sprite3dview.cpp	2007-06-12 12:51:02 UTC (rev 1399)
@@ -135,11 +135,8 @@
   rotx += controller.get_axis_state(X2_AXIS) * 50.0f * delta;
   roty += controller.get_axis_state(Y2_AXIS) * 50.0f * delta;
 
-  //std::cout << controller.get_axis_state(Y2_AXIS) << std::endl;
-
-  Uint8 *keystate = SDL_GetKeyState(NULL);
-
-  if(keystate[SDLK_ESCAPE]) // FIXME: Use cancel button instead
+  if (controller.button_was_pressed(ESCAPE_BUTTON) ||
+      controller.button_was_pressed(CANCEL_BUTTON))
     screen_manager.pop_screen();
 }
 



From grumbel at mail.berlios.de  Tue Jun 12 15:07:25 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 15:07:25 +0200
Subject: [Windstille-commit] r1400 - in trunk/windstille: data/3dsprites
	data/models/characters/jane data/models/characters/yagor src
Message-ID: <200706121307.l5CD7PmG005752@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 15:07:24 +0200 (Tue, 12 Jun 2007)
New Revision: 1400

Added:
   trunk/windstille/data/models/characters/jane/jane.wsprite
   trunk/windstille/data/models/characters/jane/suit2-texture.png
   trunk/windstille/data/models/characters/jane/texture1.png
   trunk/windstille/data/models/characters/yagor/clothtexture.png
   trunk/windstille/data/models/characters/yagor/facetexture.png
Removed:
   trunk/windstille/data/3dsprites/clothtexture.png
   trunk/windstille/data/3dsprites/facetexture.png
   trunk/windstille/data/3dsprites/heroken.wsprite
   trunk/windstille/data/3dsprites/suit2-texture.png
   trunk/windstille/data/3dsprites/texture1.png
   trunk/windstille/data/models/characters/jane/jane.wsprite
Modified:
   trunk/windstille/src/character.cpp
   trunk/windstille/src/player.cpp
Log:
- fixed some data being in the wrong place

Deleted: trunk/windstille/data/3dsprites/clothtexture.png
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/3dsprites/facetexture.png
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/3dsprites/heroken.wsprite
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/3dsprites/suit2-texture.png
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/3dsprites/texture1.png
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/models/characters/jane/jane.wsprite
===================================================================
(Binary files differ)

Copied: trunk/windstille/data/models/characters/jane/jane.wsprite (from rev 1396, trunk/windstille/data/3dsprites/heroken.wsprite)

Copied: trunk/windstille/data/models/characters/jane/suit2-texture.png (from rev 1396, trunk/windstille/data/3dsprites/suit2-texture.png)

Copied: trunk/windstille/data/models/characters/jane/texture1.png (from rev 1396, trunk/windstille/data/3dsprites/texture1.png)

Copied: trunk/windstille/data/models/characters/yagor/clothtexture.png (from rev 1396, trunk/windstille/data/3dsprites/clothtexture.png)

Copied: trunk/windstille/data/models/characters/yagor/facetexture.png (from rev 1396, trunk/windstille/data/3dsprites/facetexture.png)

Modified: trunk/windstille/src/character.cpp
===================================================================
--- trunk/windstille/src/character.cpp	2007-06-12 12:51:02 UTC (rev 1399)
+++ trunk/windstille/src/character.cpp	2007-06-12 13:07:24 UTC (rev 1400)
@@ -39,7 +39,7 @@
   use_verb = "Talk";
   z_pos = 100.0f;
 
-  std::string sprite3d_filename = "3dsprites/heroken.wsprite";
+  std::string sprite3d_filename = "models/characters/jane/jane.wsprite";
   std::string action_name;
 
   props.get("name", name);

Modified: trunk/windstille/src/player.cpp
===================================================================
--- trunk/windstille/src/player.cpp	2007-06-12 12:51:02 UTC (rev 1399)
+++ trunk/windstille/src/player.cpp	2007-06-12 13:07:24 UTC (rev 1400)
@@ -53,7 +53,7 @@
   state(STAND)
 {
   //laser_pointer = new LaserPointer();
-  sprite = Sprite3D("3dsprites/heroken.wsprite");
+  sprite = Sprite3D("models/characters/jane/jane.wsprite");
   pos.x = 320;
   pos.y = 200;
   name = "player";



From grumbel at mail.berlios.de  Tue Jun 12 15:08:12 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 15:08:12 +0200
Subject: [Windstille-commit] r1401 - in trunk/windstille/data/models:
	characters/bob objects/pistol
Message-ID: <200706121308.l5CD8CJj006020@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 15:07:56 +0200 (Tue, 12 Jun 2007)
New Revision: 1401

Added:
   trunk/windstille/data/models/characters/bob/body.png
   trunk/windstille/data/models/characters/bob/head.png
   trunk/windstille/data/models/objects/pistol/pistoltexture.png
Log:
- fixed some data being in the wrong place

Added: trunk/windstille/data/models/characters/bob/body.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/models/characters/bob/body.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/models/characters/bob/head.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/models/characters/bob/head.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/models/objects/pistol/pistoltexture.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/models/objects/pistol/pistoltexture.png
___________________________________________________________________
Name: svn:mime-type
   + image/png



From grumbel at mail.berlios.de  Tue Jun 12 15:23:04 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 15:23:04 +0200
Subject: [Windstille-commit] r1402 - in trunk/windstille: . src/gui
	src/sprite3d
Message-ID: <200706121323.l5CDN4CY007565@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 15:23:02 +0200 (Tue, 12 Jun 2007)
New Revision: 1402

Modified:
   trunk/windstille/INSTALL
   trunk/windstille/README
   trunk/windstille/TODO
   trunk/windstille/src/gui/Jamfile
   trunk/windstille/src/sprite3d/data.cpp
Log:
- updated INSTALL, updated README, fixed compiler warning, updated Jam build files

Modified: trunk/windstille/INSTALL
===================================================================
--- trunk/windstille/INSTALL	2007-06-12 13:07:56 UTC (rev 1401)
+++ trunk/windstille/INSTALL	2007-06-12 13:23:02 UTC (rev 1402)
@@ -1,229 +1,5 @@
-Copyright (C) 1994, 1995, 1996, 1999, 2000, 2001, 2002 Free Software
-Foundation, Inc.
+The game does not support installation right now, just compile with:
 
-   This file is free documentation; the Free Software Foundation gives
-unlimited permission to copy, distribute and modify it.
+ % scons
 
-Basic Installation
-==================
-
-   These are generic installation instructions.
-
-   The `configure' shell script attempts to guess correct values for
-various system-dependent variables used during compilation.  It uses
-those values to create a `Makefile' in each directory of the package.
-It may also create one or more `.h' files containing system-dependent
-definitions.  Finally, it creates a shell script `config.status' that
-you can run in the future to recreate the current configuration, and a
-file `config.log' containing compiler output (useful mainly for
-debugging `configure').
-
-   It can also use an optional file (typically called `config.cache'
-and enabled with `--cache-file=config.cache' or simply `-C') that saves
-the results of its tests to speed up reconfiguring.  (Caching is
-disabled by default to prevent problems with accidental use of stale
-cache files.)
-
-   If you need to do unusual things to compile the package, please try
-to figure out how `configure' could check whether to do them, and mail
-diffs or instructions to the address given in the `README' so they can
-be considered for the next release.  If you are using the cache, and at
-some point `config.cache' contains results you don't want to keep, you
-may remove or edit it.
-
-   The file `configure.ac' (or `configure.in') is used to create
-`configure' by a program called `autoconf'.  You only need
-`configure.ac' if you want to change it or regenerate `configure' using
-a newer version of `autoconf'.
-
-The simplest way to compile this package is:
-
-  1. `cd' to the directory containing the package's source code and type
-     `./configure' to configure the package for your system.  If you're
-     using `csh' on an old version of System V, you might need to type
-     `sh ./configure' instead to prevent `csh' from trying to execute
-     `configure' itself.
-
-     Running `configure' takes awhile.  While running, it prints some
-     messages telling which features it is checking for.
-
-  2. Type `make' to compile the package.
-
-  3. Optionally, type `make check' to run any self-tests that come with
-     the package.
-
-  4. Type `make install' to install the programs and any data files and
-     documentation.
-
-  5. You can remove the program binaries and object files from the
-     source code directory by typing `make clean'.  To also remove the
-     files that `configure' created (so you can compile the package for
-     a different kind of computer), type `make distclean'.  There is
-     also a `make maintainer-clean' target, but that is intended mainly
-     for the package's developers.  If you use it, you may have to get
-     all sorts of other programs in order to regenerate files that came
-     with the distribution.
-
-Compilers and Options
-=====================
-
-   Some systems require unusual options for compilation or linking that
-the `configure' script does not know about.  Run `./configure --help'
-for details on some of the pertinent environment variables.
-
-   You can give `configure' initial values for configuration parameters
-by setting variables in the command line or in the environment.  Here
-is an example:
-
-     ./configure CC=c89 CFLAGS=-O2 LIBS=-lposix
-
-   *Note Defining Variables::, for more details.
-
-Compiling For Multiple Architectures
-====================================
-
-   You can compile the package for more than one kind of computer at the
-same time, by placing the object files for each architecture in their
-own directory.  To do this, you must use a version of `make' that
-supports the `VPATH' variable, such as GNU `make'.  `cd' to the
-directory where you want the object files and executables to go and run
-the `configure' script.  `configure' automatically checks for the
-source code in the directory that `configure' is in and in `..'.
-
-   If you have to use a `make' that does not support the `VPATH'
-variable, you have to compile the package for one architecture at a
-time in the source code directory.  After you have installed the
-package for one architecture, use `make distclean' before reconfiguring
-for another architecture.
-
-Installation Names
-==================
-
-   By default, `make install' will install the package's files in
-`/usr/local/bin', `/usr/local/man', etc.  You can specify an
-installation prefix other than `/usr/local' by giving `configure' the
-option `--prefix=PATH'.
-
-   You can specify separate installation prefixes for
-architecture-specific files and architecture-independent files.  If you
-give `configure' the option `--exec-prefix=PATH', the package will use
-PATH as the prefix for installing programs and libraries.
-Documentation and other data files will still use the regular prefix.
-
-   In addition, if you use an unusual directory layout you can give
-options like `--bindir=PATH' to specify different values for particular
-kinds of files.  Run `configure --help' for a list of the directories
-you can set and what kinds of files go in them.
-
-   If the package supports it, you can cause programs to be installed
-with an extra prefix or suffix on their names by giving `configure' the
-option `--program-prefix=PREFIX' or `--program-suffix=SUFFIX'.
-
-Optional Features
-=================
-
-   Some packages pay attention to `--enable-FEATURE' options to
-`configure', where FEATURE indicates an optional part of the package.
-They may also pay attention to `--with-PACKAGE' options, where PACKAGE
-is something like `gnu-as' or `x' (for the X Window System).  The
-`README' should mention any `--enable-' and `--with-' options that the
-package recognizes.
-
-   For packages that use the X Window System, `configure' can usually
-find the X include and library files automatically, but if it doesn't,
-you can use the `configure' options `--x-includes=DIR' and
-`--x-libraries=DIR' to specify their locations.
-
-Specifying the System Type
-==========================
-
-   There may be some features `configure' cannot figure out
-automatically, but needs to determine by the type of machine the package
-will run on.  Usually, assuming the package is built to be run on the
-_same_ architectures, `configure' can figure that out, but if it prints
-a message saying it cannot guess the machine type, give it the
-`--build=TYPE' option.  TYPE can either be a short name for the system
-type, such as `sun4', or a canonical name which has the form:
-
-     CPU-COMPANY-SYSTEM
-
-where SYSTEM can have one of these forms:
-
-     OS KERNEL-OS
-
-   See the file `config.sub' for the possible values of each field.  If
-`config.sub' isn't included in this package, then this package doesn't
-need to know the machine type.
-
-   If you are _building_ compiler tools for cross-compiling, you should
-use the `--target=TYPE' option to select the type of system they will
-produce code for.
-
-   If you want to _use_ a cross compiler, that generates code for a
-platform different from the build platform, you should specify the
-"host" platform (i.e., that on which the generated programs will
-eventually be run) with `--host=TYPE'.
-
-Sharing Defaults
-================
-
-   If you want to set default values for `configure' scripts to share,
-you can create a site shell script called `config.site' that gives
-default values for variables like `CC', `cache_file', and `prefix'.
-`configure' looks for `PREFIX/share/config.site' if it exists, then
-`PREFIX/etc/config.site' if it exists.  Or, you can set the
-`CONFIG_SITE' environment variable to the location of the site script.
-A warning: not all `configure' scripts look for a site script.
-
-Defining Variables
-==================
-
-   Variables not defined in a site shell script can be set in the
-environment passed to `configure'.  However, some packages may run
-configure again during the build, and the customized values of these
-variables may be lost.  In order to avoid this problem, you should set
-them in the `configure' command line, using `VAR=value'.  For example:
-
-     ./configure CC=/usr/local2/bin/gcc
-
-will cause the specified gcc to be used as the C compiler (unless it is
-overridden in the site shell script).
-
-`configure' Invocation
-======================
-
-   `configure' recognizes the following options to control how it
-operates.
-
-`--help'
-`-h'
-     Print a summary of the options to `configure', and exit.
-
-`--version'
-`-V'
-     Print the version of Autoconf used to generate the `configure'
-     script, and exit.
-
-`--cache-file=FILE'
-     Enable the cache: use and save the results of the tests in FILE,
-     traditionally `config.cache'.  FILE defaults to `/dev/null' to
-     disable caching.
-
-`--config-cache'
-`-C'
-     Alias for `--cache-file=config.cache'.
-
-`--quiet'
-`--silent'
-`-q'
-     Do not print messages saying which checks are being made.  To
-     suppress all normal output, redirect it to `/dev/null' (any error
-     messages will still be shown).
-
-`--srcdir=DIR'
-     Look for the package's source code in directory DIR.  Usually
-     `configure' can determine that directory automatically.
-
-`configure' also accepts some other, not widely useful, options.  Run
-`configure --help' for more details.
-
+and run it from inside its source directory.

Modified: trunk/windstille/README
===================================================================
--- trunk/windstille/README	2007-06-12 13:07:56 UTC (rev 1401)
+++ trunk/windstille/README	2007-06-12 13:23:02 UTC (rev 1402)
@@ -7,7 +7,7 @@
 Its webpage at which one might find new versions, source code,
 artworks and more informations is located at:
 
- * http://www.nongnu.org/windstille/
+ * http://windstille.berlios.de/
 
 For informations on how to compile and run Windstille see the file
 INSTALL. Windstille makes use of OpenGL so you will need working

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-12 13:07:56 UTC (rev 1401)
+++ trunk/windstille/TODO	2007-06-12 13:23:02 UTC (rev 1402)
@@ -1,19 +1,5 @@
 - collision detection
-- a background
 - virtual tiles in the editor
 - animated tiles
 
-26.76
-14
-
-- multiplayer (2 Player should be enough) Turrican clone
-- maybe including some metroid influence
-- opengl support (maybe keeping 2d backward compatible)
-- large level support (metroid doors?)
-- map generation?!
-- easy and fast gameplay
-- scriptable final bosses
-- lots of upgradeable weapons
- 
-
 # EOF #

Modified: trunk/windstille/src/gui/Jamfile
===================================================================
--- trunk/windstille/src/gui/Jamfile	2007-06-12 13:07:56 UTC (rev 1401)
+++ trunk/windstille/src/gui/Jamfile	2007-06-12 13:23:02 UTC (rev 1402)
@@ -11,12 +11,16 @@
   component_factory.cpp
   grid_component.hpp
   grid_component.cpp
+  group_component.hpp
+  group_component.cpp
   gui_manager.hpp
   gui_manager.cpp
   label.cpp
   label.hpp
   list_view.hpp
   list_view.cpp
+  menu_component.hpp
+  menu_component.cpp
   root_component.cpp
   root_component.hpp
   slider.cpp

Modified: trunk/windstille/src/sprite3d/data.cpp
===================================================================
--- trunk/windstille/src/sprite3d/data.cpp	2007-06-12 13:07:56 UTC (rev 1401)
+++ trunk/windstille/src/sprite3d/data.cpp	2007-06-12 13:23:02 UTC (rev 1402)
@@ -18,15 +18,20 @@
 
 static inline float read_float(PHYSFS_file* file)
 {
-  uint32_t int_result;
-  if(PHYSFS_readULE32(file, &int_result) == 0) {
+  union {
+    uint32_t i;
+    float    f;
+  } result;
+
+  if(PHYSFS_readULE32(file, &result.i) == 0) {
     std::ostringstream msg;
     msg << "Problem reading float value: " << PHYSFS_getLastError();
     throw std::runtime_error(msg.str());
   }
 
-  // is this platform independent?
-  return * ( reinterpret_cast<float*> (&int_result) );
+  // FIXME: is this platform independent? -> should be, since
+  // endianess is handled in readULE32
+  return result.f;
 }
 
 static inline uint16_t read_uint16_t(PHYSFS_file* file)



From grumbel at mail.berlios.de  Tue Jun 12 16:27:50 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 16:27:50 +0200
Subject: [Windstille-commit] r1403 - in
	trunk/windstille/data/models/characters: bob jane yagor
Message-ID: <200706121427.l5CERoCc014204@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 16:27:44 +0200 (Tue, 12 Jun 2007)
New Revision: 1403

Modified:
   trunk/windstille/data/models/characters/bob/body.png
   trunk/windstille/data/models/characters/bob/head.png
   trunk/windstille/data/models/characters/jane/suit2-texture.png
   trunk/windstille/data/models/characters/jane/texture1.png
   trunk/windstille/data/models/characters/yagor/clothtexture.png
   trunk/windstille/data/models/characters/yagor/facetexture.png
Log:
- scaled the textures down to 256x256

Modified: trunk/windstille/data/models/characters/bob/body.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/models/characters/bob/head.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/models/characters/jane/suit2-texture.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/models/characters/jane/texture1.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/models/characters/yagor/clothtexture.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/models/characters/yagor/facetexture.png
===================================================================
(Binary files differ)



From grumbel at mail.berlios.de  Tue Jun 12 16:40:30 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 16:40:30 +0200
Subject: [Windstille-commit] r1404 - trunk/windstille/data/images
Message-ID: <200706121440.l5CEeUoo015460@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 16:40:30 +0200 (Tue, 12 Jun 2007)
New Revision: 1404

Removed:
   trunk/windstille/data/images/bonus/
   trunk/windstille/data/images/hero_dead/
   trunk/windstille/data/images/hero_jump.png
   trunk/windstille/data/images/hero_light.png
   trunk/windstille/data/images/hero_run/
   trunk/windstille/data/images/hero_sit.png
   trunk/windstille/data/images/hero_stand.png
   trunk/windstille/data/images/hero_walk.png
   trunk/windstille/data/images/human.sprite
   trunk/windstille/data/images/human_duck.png
   trunk/windstille/data/images/human_portrait.png
   trunk/windstille/data/images/human_run.png
   trunk/windstille/data/images/human_stand.png
   trunk/windstille/data/images/human_turn.png
   trunk/windstille/data/images/human_walk.png
Log:
- removed a bunch of unneeded images

Deleted: trunk/windstille/data/images/hero_jump.png
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/images/hero_light.png
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/images/hero_sit.png
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/images/hero_stand.png
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/images/hero_walk.png
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/images/human.sprite
===================================================================
--- trunk/windstille/data/images/human.sprite	2007-06-12 14:27:44 UTC (rev 1403)
+++ trunk/windstille/data/images/human.sprite	2007-06-12 14:40:30 UTC (rev 1404)
@@ -1,20 +0,0 @@
-(sprite
-  (action
-    (name "walk")
-    (speed 15.0)
-    (image-grid
-      (file "hero_walk.png")
-      (x-size 89)
-      (y-size 128)
-    )
-  )
-  (action
-    (name "turn")
-    (speed 15.0)
-    (image-grid
-      (file "human_turn.png")
-      (x-size 98)
-      (y-size 125)
-    )
-  )
-)

Deleted: trunk/windstille/data/images/human_duck.png
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/images/human_portrait.png
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/images/human_run.png
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/images/human_stand.png
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/images/human_turn.png
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/images/human_walk.png
===================================================================
(Binary files differ)



From grumbel at mail.berlios.de  Tue Jun 12 16:59:29 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 16:59:29 +0200
Subject: [Windstille-commit] r1405 - in trunk/windstille: . data
	data/models/characters data/models/characters/monster
	data/models/characters/powersuit
	data/models/characters/sophie data/models/characters/spider
	data/models/characters/vrdummy data/models/objects
	data/models/objects/barrobot data/models/objects/grenade
	data/models/vehicles data/models/vehicles/shuttle src
Message-ID: <200706121459.l5CExT9O017714@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 16:59:29 +0200 (Tue, 12 Jun 2007)
New Revision: 1405

Added:
   trunk/windstille/data/models/characters/monster/
   trunk/windstille/data/models/characters/monster/monster.wsprite
   trunk/windstille/data/models/characters/monster/monstertexture.png
   trunk/windstille/data/models/characters/powersuit/
   trunk/windstille/data/models/characters/powersuit/powersuit.wsprite
   trunk/windstille/data/models/characters/powersuit/powersuittexture.png
   trunk/windstille/data/models/characters/sophie/
   trunk/windstille/data/models/characters/sophie/sophie.wsprite
   trunk/windstille/data/models/characters/sophie/sophieheadtexture.png
   trunk/windstille/data/models/characters/sophie/sophietexture.png
   trunk/windstille/data/models/characters/spider/
   trunk/windstille/data/models/characters/spider/spider.wsprite
   trunk/windstille/data/models/characters/spider/spidertexture.png
   trunk/windstille/data/models/characters/vrdummy/
   trunk/windstille/data/models/characters/vrdummy/vrdummy.wsprite
   trunk/windstille/data/models/characters/vrdummy/vrdummytexture.png
   trunk/windstille/data/models/objects/grenade/
   trunk/windstille/data/models/objects/grenade/grenade.wsprite
   trunk/windstille/data/models/objects/grenade/grenadetexture.png
   trunk/windstille/data/models/vehicles/shuttle/
   trunk/windstille/data/models/vehicles/shuttle/shuttle.wsprite
Removed:
   trunk/windstille/data/3dsprites/
   trunk/windstille/data/models/objects/barrobot/barrobot.blend1
   trunk/windstille/data/models/objects/barrobot/barrobot.png
   trunk/windstille/data/models/objects/barrobot/barrobot.xcf
   trunk/windstille/data/models/objects/barrobot/render.png
Modified:
   trunk/windstille/README
   trunk/windstille/TODO
   trunk/windstille/src/menu_manager.cpp
Log:
- moved some model files around in the right directories

Modified: trunk/windstille/README
===================================================================
--- trunk/windstille/README	2007-06-12 14:40:30 UTC (rev 1404)
+++ trunk/windstille/README	2007-06-12 14:59:29 UTC (rev 1405)
@@ -9,6 +9,10 @@
 
  * http://windstille.berlios.de/
 
+The latest development version can be optained by:
+
+ $ svn co svn://svn.berlios.de/windstille/trunk/windstille
+
 For informations on how to compile and run Windstille see the file
 INSTALL. Windstille makes use of OpenGL so you will need working
 hardware 3d support.

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-12 14:40:30 UTC (rev 1404)
+++ trunk/windstille/TODO	2007-06-12 14:59:29 UTC (rev 1405)
@@ -1,3 +1,4 @@
+- shrink textures: a lot!
 - collision detection
 - virtual tiles in the editor
 - animated tiles

Copied: trunk/windstille/data/models/characters/monster/monster.wsprite (from rev 1396, trunk/windstille/data/3dsprites/monster.wsprite)

Copied: trunk/windstille/data/models/characters/monster/monstertexture.png (from rev 1396, trunk/windstille/data/3dsprites/monstertexture.png)

Copied: trunk/windstille/data/models/characters/powersuit/powersuit.wsprite (from rev 1396, trunk/windstille/data/3dsprites/powersuit.wsprite)

Copied: trunk/windstille/data/models/characters/powersuit/powersuittexture.png (from rev 1396, trunk/windstille/data/3dsprites/powersuittexture.png)

Copied: trunk/windstille/data/models/characters/sophie/sophie.wsprite (from rev 1396, trunk/windstille/data/3dsprites/sophie.wsprite)

Copied: trunk/windstille/data/models/characters/sophie/sophieheadtexture.png (from rev 1396, trunk/windstille/data/3dsprites/sophieheadtexture.png)

Copied: trunk/windstille/data/models/characters/sophie/sophietexture.png (from rev 1396, trunk/windstille/data/3dsprites/sophietexture.png)

Copied: trunk/windstille/data/models/characters/spider/spider.wsprite (from rev 1396, trunk/windstille/data/3dsprites/spider.wsprite)

Copied: trunk/windstille/data/models/characters/spider/spidertexture.png (from rev 1396, trunk/windstille/data/3dsprites/spidertexture.png)

Copied: trunk/windstille/data/models/characters/vrdummy/vrdummy.wsprite (from rev 1396, trunk/windstille/data/3dsprites/vrdummy.wsprite)

Copied: trunk/windstille/data/models/characters/vrdummy/vrdummytexture.png (from rev 1396, trunk/windstille/data/3dsprites/vrdummytexture.png)

Deleted: trunk/windstille/data/models/objects/barrobot/barrobot.blend1
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/models/objects/barrobot/barrobot.png
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/models/objects/barrobot/barrobot.xcf
===================================================================
(Binary files differ)

Deleted: trunk/windstille/data/models/objects/barrobot/render.png
===================================================================
(Binary files differ)

Copied: trunk/windstille/data/models/objects/grenade/grenade.wsprite (from rev 1396, trunk/windstille/data/3dsprites/grenade.wsprite)

Copied: trunk/windstille/data/models/objects/grenade/grenadetexture.png (from rev 1396, trunk/windstille/data/3dsprites/grenadetexture.png)

Copied: trunk/windstille/data/models/vehicles/shuttle/shuttle.wsprite (from rev 1396, trunk/windstille/data/3dsprites/shuttle.wsprite)

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-12 14:40:30 UTC (rev 1404)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-12 14:59:29 UTC (rev 1405)
@@ -226,7 +226,7 @@
   using namespace GUI;
   GUIManager* manager = new GUIManager();
 
-  GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 300-170), Sizef(500, 340)), 
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 0), Sizef(500, 600)), 
                                              "Select Model",
                                              manager->get_root());
 
@@ -240,8 +240,15 @@
   models.push_back("models/characters/jane/jane.wsprite");
   models.push_back("models/characters/yagor/yagor.wsprite");
   models.push_back("models/objects/pistol/pistol.wsprite");
-  models.push_back("models/vehicles/train/train.wsprite");
-  
+  models.push_back("models/vehicles/train/train.wsprite"); 
+  models.push_back("models/characters/powersuit/powersuit.wsprite");
+  models.push_back("models/characters/spider/spider.wsprite");
+  models.push_back("models/objects/grenade/grenade.wsprite");
+  models.push_back("models/vehicles/shuttle/shuttle.wsprite");
+  models.push_back("models/characters/vrdummy/vrdummy.wsprite");
+  models.push_back("models/characters/monster/monster.wsprite");
+  models.push_back("models/characters/sophie/sophie.wsprite");
+
   for(std::vector<std::string>::iterator i = models.begin(); i != models.end(); ++i)
     {
       ButtonMenuItem* scenario_button = new ButtonMenuItem(menu,  *i);



From grumbel at mail.berlios.de  Tue Jun 12 17:02:20 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 17:02:20 +0200
Subject: [Windstille-commit] r1406 - trunk/windstille/src
Message-ID: <200706121502.l5CF2KGB018147@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 17:02:19 +0200 (Tue, 12 Jun 2007)
New Revision: 1406

Modified:
   trunk/windstille/src/menu_manager.cpp
Log:
- some cleanup of the model view menu

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-12 14:59:29 UTC (rev 1405)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-12 15:02:19 UTC (rev 1406)
@@ -226,7 +226,7 @@
   using namespace GUI;
   GUIManager* manager = new GUIManager();
 
-  GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 0), Sizef(500, 600)), 
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 30), Sizef(500, 540)), 
                                              "Select Model",
                                              manager->get_root());
 
@@ -238,16 +238,16 @@
   std::vector<std::string> models;
   models.push_back("models/characters/bob/bob.wsprite");
   models.push_back("models/characters/jane/jane.wsprite");
-  models.push_back("models/characters/yagor/yagor.wsprite");
-  models.push_back("models/objects/pistol/pistol.wsprite");
-  models.push_back("models/vehicles/train/train.wsprite"); 
+  models.push_back("models/characters/monster/monster.wsprite");
   models.push_back("models/characters/powersuit/powersuit.wsprite");
+  models.push_back("models/characters/sophie/sophie.wsprite");
   models.push_back("models/characters/spider/spider.wsprite");
+  models.push_back("models/characters/vrdummy/vrdummy.wsprite");
+  models.push_back("models/characters/yagor/yagor.wsprite");
   models.push_back("models/objects/grenade/grenade.wsprite");
+  models.push_back("models/objects/pistol/pistol.wsprite");
   models.push_back("models/vehicles/shuttle/shuttle.wsprite");
-  models.push_back("models/characters/vrdummy/vrdummy.wsprite");
-  models.push_back("models/characters/monster/monster.wsprite");
-  models.push_back("models/characters/sophie/sophie.wsprite");
+  models.push_back("models/vehicles/train/train.wsprite"); 
 
   for(std::vector<std::string>::iterator i = models.begin(); i != models.end(); ++i)
     {



From grumbel at mail.berlios.de  Tue Jun 12 18:47:39 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 18:47:39 +0200
Subject: [Windstille-commit] r1407 - in trunk/windstille/data/images: .
	caustic objects tiles
Message-ID: <200706121647.l5CGldS1023349@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 18:45:53 +0200 (Tue, 12 Jun 2007)
New Revision: 1407

Modified:
   trunk/windstille/data/images/404.png
   trunk/windstille/data/images/arrow.png
   trunk/windstille/data/images/black.png
   trunk/windstille/data/images/bomb.png
   trunk/windstille/data/images/bomb1.png
   trunk/windstille/data/images/bombhighlight.png
   trunk/windstille/data/images/bomblight.png
   trunk/windstille/data/images/caustic/01.png
   trunk/windstille/data/images/caustic/02.png
   trunk/windstille/data/images/caustic/03.png
   trunk/windstille/data/images/caustic/04.png
   trunk/windstille/data/images/caustic/05.png
   trunk/windstille/data/images/caustic/06.png
   trunk/windstille/data/images/caustic/07.png
   trunk/windstille/data/images/caustic/08.png
   trunk/windstille/data/images/caustic/09.png
   trunk/windstille/data/images/caustic/10.png
   trunk/windstille/data/images/caustic/11.png
   trunk/windstille/data/images/caustic/12.png
   trunk/windstille/data/images/caustic/13.png
   trunk/windstille/data/images/caustic/14.png
   trunk/windstille/data/images/caustic/15.png
   trunk/windstille/data/images/caustic/16.png
   trunk/windstille/data/images/caustic/17.png
   trunk/windstille/data/images/caustic/18.png
   trunk/windstille/data/images/caustic/19.png
   trunk/windstille/data/images/caustic/20.png
   trunk/windstille/data/images/caustic/21.png
   trunk/windstille/data/images/caustic/22.png
   trunk/windstille/data/images/caustic/23.png
   trunk/windstille/data/images/caustic/24.png
   trunk/windstille/data/images/caustic/25.png
   trunk/windstille/data/images/caustic/26.png
   trunk/windstille/data/images/caustic/27.png
   trunk/windstille/data/images/caustic/28.png
   trunk/windstille/data/images/caustic/29.png
   trunk/windstille/data/images/caustic/30.png
   trunk/windstille/data/images/caustic/31.png
   trunk/windstille/data/images/caustic/32.png
   trunk/windstille/data/images/colltest.png
   trunk/windstille/data/images/colltest2.png
   trunk/windstille/data/images/controldialog.png
   trunk/windstille/data/images/energy_bar.png
   trunk/windstille/data/images/exit.png
   trunk/windstille/data/images/explolight.png
   trunk/windstille/data/images/explosion.png
   trunk/windstille/data/images/flashlighthighlight.png
   trunk/windstille/data/images/flashlightlight.png
   trunk/windstille/data/images/greychess.png
   trunk/windstille/data/images/groundset.png
   trunk/windstille/data/images/groundset2.png
   trunk/windstille/data/images/hedgehog.png
   trunk/windstille/data/images/hedgehog1.png
   trunk/windstille/data/images/hedgehog_die1.png
   trunk/windstille/data/images/hedgehog_die2.png
   trunk/windstille/data/images/hedgehog_die3.png
   trunk/windstille/data/images/hedgehog_die4.png
   trunk/windstille/data/images/hedgehog_die5.png
   trunk/windstille/data/images/hedgehog_highlight.png
   trunk/windstille/data/images/hedgehog_light.png
   trunk/windstille/data/images/industrialset.png
   trunk/windstille/data/images/laserpointer.png
   trunk/windstille/data/images/laserpointer_light.png
   trunk/windstille/data/images/light.png
   trunk/windstille/data/images/light1.png
   trunk/windstille/data/images/light2.png
   trunk/windstille/data/images/light3.png
   trunk/windstille/data/images/logo.png
   trunk/windstille/data/images/logo_black.png
   trunk/windstille/data/images/logo_large.png
   trunk/windstille/data/images/nightvision.png
   trunk/windstille/data/images/noise.png
   trunk/windstille/data/images/noise2.png
   trunk/windstille/data/images/noise3.png
   trunk/windstille/data/images/objects/apartmentlamp.png
   trunk/windstille/data/images/objects/apartmentlamp_highlight.png
   trunk/windstille/data/images/objects/apartmentlamp_light.png
   trunk/windstille/data/images/objects/bar.png
   trunk/windstille/data/images/objects/box.png
   trunk/windstille/data/images/objects/elevatordoor.png
   trunk/windstille/data/images/objects/elevatordoor_left.png
   trunk/windstille/data/images/objects/elevatordoor_right.png
   trunk/windstille/data/images/objects/northernstarjoinnow.png
   trunk/windstille/data/images/objects/painting1.png
   trunk/windstille/data/images/objects/painting2.png
   trunk/windstille/data/images/objects/painting3.png
   trunk/windstille/data/images/objects/painting4.png
   trunk/windstille/data/images/objects/showerdoors.png
   trunk/windstille/data/images/objects/vrdoor-color.png
   trunk/windstille/data/images/objects/vrdoor-highlight.png
   trunk/windstille/data/images/portrait.png
   trunk/windstille/data/images/spider_mine.png
   trunk/windstille/data/images/streetlamp-highlight.png
   trunk/windstille/data/images/streetlamp-light.png
   trunk/windstille/data/images/streetlamp.png
   trunk/windstille/data/images/tiles/apartment-background.png
   trunk/windstille/data/images/tiles/apartment-foreground.png
   trunk/windstille/data/images/tiles/bluestone.png
   trunk/windstille/data/images/tiles/forestground.png
   trunk/windstille/data/images/tiles/groundset.png
   trunk/windstille/data/images/tiles/industrial.png
   trunk/windstille/data/images/tiles/notile.png
   trunk/windstille/data/images/tiles/tile23.png
   trunk/windstille/data/images/tiles/tile40.png
   trunk/windstille/data/images/tiles/tile41.png
   trunk/windstille/data/images/tiles/tile42.png
   trunk/windstille/data/images/tiles/tile43.png
   trunk/windstille/data/images/tiles/tile44.png
   trunk/windstille/data/images/tiles/tile45.png
   trunk/windstille/data/images/tiles/tile46.png
   trunk/windstille/data/images/tiles/virtualreality-background.png
   trunk/windstille/data/images/tiles/virtualreality-foreground.png
   trunk/windstille/data/images/tiles/virtualreality-highlight.png
   trunk/windstille/data/images/titlescreen.png
   trunk/windstille/data/images/unknown.png
   trunk/windstille/data/images/verdana11_blue.png
   trunk/windstille/data/images/verdana32_blue.png
   trunk/windstille/data/images/verdana32_blueh.png
   trunk/windstille/data/images/verdana48_blue.png
   trunk/windstille/data/images/verdana48_blueh.png
   trunk/windstille/data/images/virtualreality-background.png
   trunk/windstille/data/images/virtualreality-highlight.png
   trunk/windstille/data/images/virtualreality.png
   trunk/windstille/data/images/wallpaper.png
   trunk/windstille/data/images/watersplash.png
Log:
- recompressed a bunch of images


Modified: trunk/windstille/data/images/404.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/arrow.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/black.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/bomb.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/bomb1.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/bombhighlight.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/bomblight.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/01.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/02.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/03.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/04.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/05.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/06.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/07.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/08.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/09.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/10.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/11.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/12.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/13.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/14.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/15.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/16.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/17.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/18.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/19.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/20.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/21.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/22.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/23.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/24.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/25.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/26.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/27.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/28.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/29.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/30.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/31.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/caustic/32.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/colltest.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/colltest2.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/controldialog.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/energy_bar.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/exit.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/explolight.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/explosion.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/flashlighthighlight.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/flashlightlight.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/greychess.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/groundset.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/groundset2.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/hedgehog.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/hedgehog1.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/hedgehog_die1.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/hedgehog_die2.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/hedgehog_die3.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/hedgehog_die4.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/hedgehog_die5.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/hedgehog_highlight.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/hedgehog_light.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/industrialset.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/laserpointer.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/laserpointer_light.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/light.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/light1.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/light2.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/light3.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/logo.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/logo_black.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/logo_large.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/nightvision.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/noise.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/noise2.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/noise3.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/apartmentlamp.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/apartmentlamp_highlight.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/apartmentlamp_light.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/bar.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/box.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/elevatordoor.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/elevatordoor_left.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/elevatordoor_right.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/northernstarjoinnow.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/painting1.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/painting2.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/painting3.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/painting4.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/showerdoors.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/vrdoor-color.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/vrdoor-highlight.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/portrait.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/spider_mine.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/streetlamp-highlight.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/streetlamp-light.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/streetlamp.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/apartment-background.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/apartment-foreground.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/bluestone.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/forestground.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/groundset.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/industrial.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/notile.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/tile23.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/tile40.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/tile41.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/tile42.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/tile43.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/tile44.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/tile45.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/tile46.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/virtualreality-background.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/virtualreality-foreground.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/virtualreality-highlight.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/titlescreen.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/unknown.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/verdana11_blue.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/verdana32_blue.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/verdana32_blueh.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/verdana48_blue.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/verdana48_blueh.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/virtualreality-background.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/virtualreality-highlight.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/virtualreality.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/wallpaper.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/watersplash.png
===================================================================
(Binary files differ)



From grumbel at mail.berlios.de  Tue Jun 12 18:48:45 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 18:48:45 +0200
Subject: [Windstille-commit] r1408 - in
	trunk/windstille/data/models/characters: monster powersuit
	sophie spider vrdummy
Message-ID: <200706121648.l5CGmjAN024342@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 18:48:33 +0200 (Tue, 12 Jun 2007)
New Revision: 1408

Modified:
   trunk/windstille/data/models/characters/monster/monstertexture.png
   trunk/windstille/data/models/characters/powersuit/powersuittexture.png
   trunk/windstille/data/models/characters/sophie/sophieheadtexture.png
   trunk/windstille/data/models/characters/sophie/sophietexture.png
   trunk/windstille/data/models/characters/spider/spidertexture.png
   trunk/windstille/data/models/characters/vrdummy/vrdummytexture.png
Log:
- recompressed a bunch of images


Modified: trunk/windstille/data/models/characters/monster/monstertexture.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/models/characters/powersuit/powersuittexture.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/models/characters/sophie/sophieheadtexture.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/models/characters/sophie/sophietexture.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/models/characters/spider/spidertexture.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/models/characters/vrdummy/vrdummytexture.png
===================================================================
(Binary files differ)



From grumbel at mail.berlios.de  Tue Jun 12 19:32:06 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 19:32:06 +0200
Subject: [Windstille-commit] r1410 - in trunk/windstille/src: . display
Message-ID: <200706121732.l5CHW6ZV014739@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 19:32:05 +0200 (Tue, 12 Jun 2007)
New Revision: 1410

Modified:
   trunk/windstille/src/console.cpp
   trunk/windstille/src/display/texture.cpp
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/script_manager.cpp
Log:
- fixed Squirrel API issues

Modified: trunk/windstille/src/console.cpp
===================================================================
--- trunk/windstille/src/console.cpp	2007-06-12 16:50:11 UTC (rev 1409)
+++ trunk/windstille/src/console.cpp	2007-06-12 17:32:05 UTC (rev 1410)
@@ -506,7 +506,7 @@
     if(i>0){
       if(SQ_SUCCEEDED(sq_compilebuffer(vm,buffer,i,_SC("interactive console"),SQTrue))){
         sq_pushroottable(vm);
-        if(SQ_SUCCEEDED(sq_call(vm,1, retval))) 
+        if(SQ_SUCCEEDED(sq_call(vm,1, retval, true))) 
           {
             if (sq_gettype(vm, -1) != OT_NULL)
               console << squirrel2string(vm, -1) << std::endl;

Modified: trunk/windstille/src/display/texture.cpp
===================================================================
--- trunk/windstille/src/display/texture.cpp	2007-06-12 16:50:11 UTC (rev 1409)
+++ trunk/windstille/src/display/texture.cpp	2007-06-12 17:32:05 UTC (rev 1410)
@@ -99,11 +99,16 @@
   impl->height = image->h;
 
   const SDL_PixelFormat* format = image->format;
+
   if(!is_power_of_2(image->w) || !is_power_of_2(image->h))
     throw std::runtime_error("image has no power of 2 size");
+
   if(format->BitsPerPixel != 24 && format->BitsPerPixel != 32)
     throw std::runtime_error("image has not 24 or 32 bit color depth");
 
+  // FIXME: User SDL_ConvertSurface to bring images in the right format
+  // SDL_ConvertSurface(bmp, screen->format, SDL_SWSURFACE);
+  
   try 
     {
       GLint maxt;

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-12 16:50:11 UTC (rev 1409)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-12 17:32:05 UTC (rev 1410)
@@ -226,7 +226,7 @@
   using namespace GUI;
   GUIManager* manager = new GUIManager();
 
-  GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 30), Sizef(500, 540)), 
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-275, 30), Sizef(550, 540)), 
                                              "Select Model",
                                              manager->get_root());
 

Modified: trunk/windstille/src/script_manager.cpp
===================================================================
--- trunk/windstille/src/script_manager.cpp	2007-06-12 16:50:11 UTC (rev 1409)
+++ trunk/windstille/src/script_manager.cpp	2007-06-12 17:32:05 UTC (rev 1410)
@@ -115,7 +115,7 @@
   already_run_scripts[sourcename] = true;
 
   sq_pushroottable(vm);
-  if(sq_call(vm, 1, false) < 0)
+  if(sq_call(vm, 1, false, true) < 0)
     throw SquirrelError(vm, "Couldn't start script");
 }
 
@@ -130,7 +130,7 @@
       {
         squirrel_vm.waiting_for_events = WakeupData(NO_EVENT);
         try {
-          if(sq_wakeupvm(squirrel_vm.vm, false, false) < 0) {
+          if(sq_wakeupvm(squirrel_vm.vm, false, false, true) < 0) {
             throw SquirrelError(squirrel_vm.vm, "Couldn't resume script");
           }
         } catch(std::exception& e) {



From grumbel at mail.berlios.de  Tue Jun 12 19:33:03 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 19:33:03 +0200
Subject: [Windstille-commit] r1411 - in trunk/windstille/data: images
	images/objects images/tiles models/characters/sophie
Message-ID: <200706121733.l5CHX3NA014854@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 19:32:53 +0200 (Tue, 12 Jun 2007)
New Revision: 1411

Added:
   trunk/windstille/data/models/characters/sophie/headtexture.png
Removed:
   trunk/windstille/data/models/characters/sophie/sophieheadtexture.png
Modified:
   trunk/windstille/data/images/404.png
   trunk/windstille/data/images/colltest.png
   trunk/windstille/data/images/energy_bar.png
   trunk/windstille/data/images/greychess.png
   trunk/windstille/data/images/hedgehog_die5.png
   trunk/windstille/data/images/logo.png
   trunk/windstille/data/images/nightvision.png
   trunk/windstille/data/images/noise.png
   trunk/windstille/data/images/noise2.png
   trunk/windstille/data/images/objects/apartmentlamp_light.png
   trunk/windstille/data/images/objects/elevatordoor_right.png
   trunk/windstille/data/images/objects/vrdoor-color.png
   trunk/windstille/data/images/streetlamp-highlight.png
   trunk/windstille/data/images/streetlamp-light.png
   trunk/windstille/data/images/tiles/notile.png
   trunk/windstille/data/images/tiles/tile42.png
   trunk/windstille/data/images/tiles/tile43.png
   trunk/windstille/data/images/tiles/tile45.png
Log:
- reverted some images to their old state for compability

Modified: trunk/windstille/data/images/404.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/colltest.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/energy_bar.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/greychess.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/hedgehog_die5.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/logo.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/nightvision.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/noise.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/noise2.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/apartmentlamp_light.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/elevatordoor_right.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/objects/vrdoor-color.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/streetlamp-highlight.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/streetlamp-light.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/notile.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/tile42.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/tile43.png
===================================================================
(Binary files differ)

Modified: trunk/windstille/data/images/tiles/tile45.png
===================================================================
(Binary files differ)

Copied: trunk/windstille/data/models/characters/sophie/headtexture.png (from rev 1408, trunk/windstille/data/models/characters/sophie/sophieheadtexture.png)

Deleted: trunk/windstille/data/models/characters/sophie/sophieheadtexture.png
===================================================================
(Binary files differ)



From grumbel at mail.berlios.de  Tue Jun 12 19:33:16 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 19:33:16 +0200
Subject: [Windstille-commit] r1412 - trunk/windstille/lib/SQUIRREL2/include
Message-ID: <200706121733.l5CHXG4p014890@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 19:33:16 +0200 (Tue, 12 Jun 2007)
New Revision: 1412

Modified:
   trunk/windstille/lib/SQUIRREL2/include/sqstdio.h
Log:
- little compiler warning removed

Modified: trunk/windstille/lib/SQUIRREL2/include/sqstdio.h
===================================================================
--- trunk/windstille/lib/SQUIRREL2/include/sqstdio.h	2007-06-12 17:32:53 UTC (rev 1411)
+++ trunk/windstille/lib/SQUIRREL2/include/sqstdio.h	2007-06-12 17:33:16 UTC (rev 1412)
@@ -7,6 +7,7 @@
 #define SQSTD_STREAM_TYPE_TAG 0x80000000
 
 struct SQStream {
+	virtual ~SQStream() {}
 	virtual SQInteger Read(void *buffer, SQInteger size) = 0;
 	virtual SQInteger Write(void *buffer, SQInteger size) = 0;
 	virtual SQInteger Flush() = 0;



From grumbel at mail.berlios.de  Tue Jun 12 20:29:47 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 20:29:47 +0200
Subject: [Windstille-commit] r1413 - in trunk/windstille: . lib src
Message-ID: <200706121829.l5CITlOJ020001@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 20:29:46 +0200 (Tue, 12 Jun 2007)
New Revision: 1413

Modified:
   trunk/windstille/Jamrules
   trunk/windstille/lib/Jamfile
   trunk/windstille/src/Jamfile
   trunk/windstille/src/SConscript
Log:
- fixed Jamfiles
- added missing libpng

Modified: trunk/windstille/Jamrules
===================================================================
--- trunk/windstille/Jamrules	2007-06-12 17:33:16 UTC (rev 1412)
+++ trunk/windstille/Jamrules	2007-06-12 18:29:46 UTC (rev 1413)
@@ -49,7 +49,7 @@
 # Include Dirs
 IncludeDir $(top_builddir) ; # for config.h
 IncludeDir $(top_srcdir)/src ;
-IncludeDir $(top_srcdir)/src/squirrel/include ;
+IncludeDir $(top_srcdir)/lib/SQUIRREL2/include/ ;
 
 # use CLANLIB, OPENAL and PHYSFS
 USE_LIBS = FT2 OPENAL PHYSFS VORBISFILE VORBIS OGG ICONV GL GLU SDL SDLIMAGE ;

Modified: trunk/windstille/lib/Jamfile
===================================================================
--- trunk/windstille/lib/Jamfile	2007-06-12 17:33:16 UTC (rev 1412)
+++ trunk/windstille/lib/Jamfile	2007-06-12 18:29:46 UTC (rev 1413)
@@ -1,3 +1,14 @@
 SubDir TOP lib ;
 
 SubInclude TOP lib glew ;
+
+Library squirrel
+    : [ Wildcard SQUIRREL2/squirrel : *.cpp *.h ]
+      [ Wildcard SQUIRREL2/sqstdlib : *.cpp *.h ]
+    : noinstall
+;
+CXXFLAGS on $(squirrel_OBJECTS) 
+        = [ Filter [ on $(squirrel_OBJECTS) GetVar CXXFLAGS ] : -Wall -W -Werror ] ;
+CFLAGS on $(squirrel_OBJECTS) 
+        = [ Filter [ on $(squirrel_OBJECTS) GetVar CFLAGS ] : -Wall -W -Werror ] ;
+IncludeDir squirrel : SQUIRREL2/include ;

Modified: trunk/windstille/src/Jamfile
===================================================================
--- trunk/windstille/src/Jamfile	2007-06-12 17:33:16 UTC (rev 1412)
+++ trunk/windstille/src/Jamfile	2007-06-12 18:29:46 UTC (rev 1413)
@@ -15,7 +15,6 @@
 SubInclude TOP src sound ;
 SubInclude TOP src sprite2d ;
 SubInclude TOP src sprite3d ;
-SubInclude TOP src squirrel ;
 SubInclude TOP src tinygettext ;
 
 sources = [ Wildcard *.cpp *.hpp ] ;

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-12 17:33:16 UTC (rev 1412)
+++ trunk/windstille/src/SConscript	2007-06-12 18:29:46 UTC (rev 1413)
@@ -180,7 +180,7 @@
 'tinygettext/gettext.cpp',
 'tinygettext/tinygettext.cpp'
 ],
-LIBS    = ['GL', 'GLU', 'squirrel', 'physfs', 'SDL_image', 'openal', 'glew', 'ogg', 'vorbis', 'vorbisfile'] + env['LIBS'],
+LIBS    = ['GL', 'GLU', 'squirrel', 'physfs', 'SDL_image', 'openal', 'glew', 'ogg', 'vorbis', 'vorbisfile', 'png'] + env['LIBS'],
 LIBPATH = ['../lib/'],
 CPPPATH = env['CPPPATH'] + ['.', '..', '../lib/SQUIRREL2/include/', '../lib/glew'])
 



From grumbel at mail.berlios.de  Tue Jun 12 21:06:53 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 21:06:53 +0200
Subject: [Windstille-commit] r1414 - in trunk/windstille: . lib
Message-ID: <200706121906.l5CJ6rmX022265@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 21:06:51 +0200 (Tue, 12 Jun 2007)
New Revision: 1414

Modified:
   trunk/windstille/SConstruct
   trunk/windstille/lib/SConscript
Log:
- added 32bti check

Modified: trunk/windstille/SConstruct
===================================================================
--- trunk/windstille/SConstruct	2007-06-12 18:29:46 UTC (rev 1413)
+++ trunk/windstille/SConstruct	2007-06-12 19:06:51 UTC (rev 1414)
@@ -91,23 +91,24 @@
 
 # env.BuildDir('build2', '.')
 
-if 'configure' in COMMAND_LINE_TARGETS:
-    conf = Configure( env, custom_tests = { 'CheckSDL' : CheckSDL, 'CheckPhysFS' : CheckPhysFS } )
+#if 'configure' in COMMAND_LINE_TARGETS:
+#    conf = Configure( env, custom_tests = { 'CheckSDL' : CheckSDL, 'CheckPhysFS' : CheckPhysFS } )
+#
+#    if not conf.CheckSDL('1.2.8'):
+#        print 'We really need SDL!'
+#        Exit(1)
+#        
+#    if not conf.CheckPhysFS('1.0'):
+#        print "libphysfs missing"
+#        Exit(1)
+#
+#    env = conf.Finish()
+# else:
 
-    if not conf.CheckSDL('1.2.8'):
-        print 'We really need SDL!'
-        Exit(1)
-        
-    if not conf.CheckPhysFS('1.0'):
-        print "libphysfs missing"
-        Exit(1)
+Export('env')
+SConscript('tools/SConscript')
+SConscript('lib//SConscript')
+SConscript('src/SConscript')
+SConscript('src/scripting/SConscript')
 
-    env = conf.Finish() 
-else:
-    Export('env')
-    SConscript('tools/SConscript')
-    SConscript('lib//SConscript')
-    SConscript('src/SConscript')
-    SConscript('src/scripting/SConscript')
-
 # EOF #

Modified: trunk/windstille/lib/SConscript
===================================================================
--- trunk/windstille/lib/SConscript	2007-06-12 18:29:46 UTC (rev 1413)
+++ trunk/windstille/lib/SConscript	2007-06-12 19:06:51 UTC (rev 1414)
@@ -8,8 +8,31 @@
             glob.glob('glew/*.c') +
             glob.glob('glew/*.h'))
 
-squirrel_env = Environment(CPPPATH = ['SQUIRREL2/include'])
+squirrel_env = Environment(CPPPATH = ['SQUIRREL2/include'],
+             CXXFLAGS = ["-fno-rtti"])
 
+def Check32bit(context):
+    check32bit_test_source_file = """
+#include <stdio.h>
+int main()
+{
+   printf("%dbits", sizeof(int)*8);
+   return 0;
+}
+    """
+    context.Message('Checking for bits... ')
+    (suc, output) = context.TryRun(check32bit_test_source_file, '.cpp')
+    if suc:
+       context.Result(output)
+    else:
+       context.Result(output)
+    return output
+
+conf = Configure(squirrel_env, custom_tests = { 'Check32bit' : Check32bit })
+if conf.Check32bit() == "64bits":
+  conf.env.Append(CXXFLAGS="-D_SQ64")
+squirrel_env = conf.Finish()
+
 squirrel_env.Library('squirrel',
             glob.glob('SQUIRREL2/squirrel/*.cpp') +
             glob.glob('SQUIRREL2/sqstdlib/*.cpp'))



From grumbel at mail.berlios.de  Tue Jun 12 21:15:45 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 21:15:45 +0200
Subject: [Windstille-commit] r1415 - trunk/windstille/lib
Message-ID: <200706121915.l5CJFj7x023059@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 21:15:44 +0200 (Tue, 12 Jun 2007)
New Revision: 1415

Modified:
   trunk/windstille/lib/SConscript
Log:
- fixed 64bit check

Modified: trunk/windstille/lib/SConscript
===================================================================
--- trunk/windstille/lib/SConscript	2007-06-12 19:06:51 UTC (rev 1414)
+++ trunk/windstille/lib/SConscript	2007-06-12 19:15:44 UTC (rev 1415)
@@ -16,16 +16,16 @@
 #include <stdio.h>
 int main()
 {
-   printf("%dbits", sizeof(int)*8);
+   printf("%dbits", sizeof(void*)*8);
    return 0;
 }
     """
     context.Message('Checking for bits... ')
     (suc, output) = context.TryRun(check32bit_test_source_file, '.cpp')
     if suc:
-       context.Result(output)
+      context.Result(output)
     else:
-       context.Result(output)
+      context.Result("test error")
     return output
 
 conf = Configure(squirrel_env, custom_tests = { 'Check32bit' : Check32bit })



From grumbel at mail.berlios.de  Tue Jun 12 21:32:47 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 21:32:47 +0200
Subject: [Windstille-commit] r1416 - trunk/windstille/lib
Message-ID: <200706121932.l5CJWlsO024230@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 21:32:47 +0200 (Tue, 12 Jun 2007)
New Revision: 1416

Modified:
   trunk/windstille/lib/SConscript
Log:
- added debugging symbols

Modified: trunk/windstille/lib/SConscript
===================================================================
--- trunk/windstille/lib/SConscript	2007-06-12 19:15:44 UTC (rev 1415)
+++ trunk/windstille/lib/SConscript	2007-06-12 19:32:47 UTC (rev 1416)
@@ -2,14 +2,14 @@
 
 import glob
 
-glew_env = Environment(CPPPATH = ['glew'])
+glew_env = Environment(CPPPATH = ['glew'], CXXFLAGS = ['-g', '-DDEBUG'])
 
 glew = glew_env.Library('glew',
             glob.glob('glew/*.c') +
             glob.glob('glew/*.h'))
 
 squirrel_env = Environment(CPPPATH = ['SQUIRREL2/include'],
-             CXXFLAGS = ["-fno-rtti"])
+             CXXFLAGS = ["-fno-rtti", "-g", "-DDEBUG"])
 
 def Check32bit(context):
     check32bit_test_source_file = """



From grumbel at mail.berlios.de  Tue Jun 12 22:30:28 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 22:30:28 +0200
Subject: [Windstille-commit] r1417 - trunk/windstille/src/scripting
Message-ID: <200706122030.l5CKUSxV029538@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 22:30:28 +0200 (Tue, 12 Jun 2007)
New Revision: 1417

Modified:
   trunk/windstille/src/scripting/serialize.cpp
   trunk/windstille/src/scripting/spawn_object.cpp
   trunk/windstille/src/scripting/wrapper_util.cpp
Log:
- some 64bit fixes

Modified: trunk/windstille/src/scripting/serialize.cpp
===================================================================
--- trunk/windstille/src/scripting/serialize.cpp	2007-06-12 19:32:47 UTC (rev 1416)
+++ trunk/windstille/src/scripting/serialize.cpp	2007-06-12 20:30:28 UTC (rev 1417)
@@ -79,7 +79,7 @@
 
     switch(sq_gettype(v, -1)) {
       case OT_INTEGER: {
-        int val;
+        SQInteger val;
         sq_getinteger(v, -1, &val);
         writer.write_int(key, val);
         break;

Modified: trunk/windstille/src/scripting/spawn_object.cpp
===================================================================
--- trunk/windstille/src/scripting/spawn_object.cpp	2007-06-12 19:32:47 UTC (rev 1416)
+++ trunk/windstille/src/scripting/spawn_object.cpp	2007-06-12 20:30:28 UTC (rev 1417)
@@ -27,9 +27,9 @@
 {
   switch(sq_gettype(v, -1)) {
     case OT_INTEGER: {
-      int val;
+      SQInteger val;
       sq_getinteger(v, -1, &val);
-      entries.push_back(new Lisp(val));
+      entries.push_back(new Lisp(static_cast<int>(val)));
       break;
     }
     case OT_FLOAT: {

Modified: trunk/windstille/src/scripting/wrapper_util.cpp
===================================================================
--- trunk/windstille/src/scripting/wrapper_util.cpp	2007-06-12 19:32:47 UTC (rev 1416)
+++ trunk/windstille/src/scripting/wrapper_util.cpp	2007-06-12 20:30:28 UTC (rev 1417)
@@ -22,7 +22,7 @@
       break;
     }
     case OT_INTEGER: {
-      int val;
+      SQInteger val;
       sq_getinteger(v, i, &val);
       os << val;
       break;
@@ -124,9 +124,9 @@
                 printf("null");        
                 break;
             case OT_INTEGER: {
-                int val;
+                SQInteger val;
                 sq_getinteger(v, i, &val);
-                printf("integer (%d)", val);
+                printf("integer (%d)", static_cast<int>(val));
                 break;
             }
             case OT_FLOAT: {



From grumbel at mail.berlios.de  Tue Jun 12 23:08:13 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 12 Jun 2007 23:08:13 +0200
Subject: [Windstille-commit] r1418 - in trunk/windstille: . lib src
	src/scripting
Message-ID: <200706122108.l5CL8D2m002414@sheep.berlios.de>

Author: grumbel
Date: 2007-06-12 23:08:12 +0200 (Tue, 12 Jun 2007)
New Revision: 1418

Modified:
   trunk/windstille/SConstruct
   trunk/windstille/lib/SConscript
   trunk/windstille/src/SConscript
   trunk/windstille/src/scripting/SConscript
Log:
- moved 64bit check to a upper level

Modified: trunk/windstille/SConstruct
===================================================================
--- trunk/windstille/SConstruct	2007-06-12 20:30:28 UTC (rev 1417)
+++ trunk/windstille/SConstruct	2007-06-12 21:08:12 UTC (rev 1418)
@@ -26,10 +26,10 @@
 
 import sys, os
 sys.path.append('scons')
-
+
 def CheckSDL(context, version):
     context.Message( 'Checking for SDL >= %s ...' % version )
-    (ret, outstring) = context.TryAction('sdl-config --version > $TARGET')
+    (ret, outstring) = context.TryAction('sdl-config --version')
     if ret:
         outstring = outstring[0:-1]
         if outstring != version:
@@ -41,7 +41,7 @@
     else:
         context.Result( ret )
         return ret
-
+
 def CheckPhysFS(context, version):
     optionFile = env['CACHEDIR'] + 'libphysfs.cache.py'
     opts = Options(optionFile)
@@ -80,32 +80,33 @@
     else:
         context.Result('ok (cached)')
         return 1
+
+def Check32bit(context):
+    check32bit_test_source_file = """
+#include <stdio.h>
+int main()
+{
+   printf("%dbit", sizeof(void*)*8);
+   return 0;
+}
+    """
+    context.Message('Checking for bits... ')
+    (suc, output) = context.TryRun(check32bit_test_source_file, '.cpp')
+    if suc:
+      context.Result(output)
+    else:
+      context.Result("test error")
+    return output
 
-opts = Options(['options.cache', 'custom.py'])
-opts.Add('CXX', 'The C++ compiler')
+
+conf_env = Environment()
+conf = Configure(conf_env, custom_tests = { 'Check32bit' : Check32bit })
+if conf.Check32bit() == "64bit":
+  conf.env.Append(CXXFLAGS="-D_SQ64")
+conf_env = conf.Finish()
 
-env = Environment(options=opts)
+Export('conf_env')
 
-# env["CACHEDIR"] = "cache/"
-# if not os.path.isdir(env['CACHEDIR']): os.mkdir(env['CACHEDIR'])
-
-# env.BuildDir('build2', '.')
-
-#if 'configure' in COMMAND_LINE_TARGETS:
-#    conf = Configure( env, custom_tests = { 'CheckSDL' : CheckSDL, 'CheckPhysFS' : CheckPhysFS } )
-#
-#    if not conf.CheckSDL('1.2.8'):
-#        print 'We really need SDL!'
-#        Exit(1)
-#        
-#    if not conf.CheckPhysFS('1.0'):
-#        print "libphysfs missing"
-#        Exit(1)
-#
-#    env = conf.Finish()
-# else:
-
-Export('env')
 SConscript('tools/SConscript')
 SConscript('lib//SConscript')
 SConscript('src/SConscript')

Modified: trunk/windstille/lib/SConscript
===================================================================
--- trunk/windstille/lib/SConscript	2007-06-12 20:30:28 UTC (rev 1417)
+++ trunk/windstille/lib/SConscript	2007-06-12 21:08:12 UTC (rev 1418)
@@ -2,6 +2,8 @@
 
 import glob
 
+Import('conf_env')
+
 glew_env = Environment(CPPPATH = ['glew'], CXXFLAGS = ['-g', '-DDEBUG'])
 
 glew = glew_env.Library('glew',
@@ -10,29 +12,8 @@
 
 squirrel_env = Environment(CPPPATH = ['SQUIRREL2/include'],
              CXXFLAGS = ["-fno-rtti", "-g", "-DDEBUG"])
+squirrel_env.Append(CXXFLAGS = conf_env['CXXFLAGS'])
 
-def Check32bit(context):
-    check32bit_test_source_file = """
-#include <stdio.h>
-int main()
-{
-   printf("%dbits", sizeof(void*)*8);
-   return 0;
-}
-    """
-    context.Message('Checking for bits... ')
-    (suc, output) = context.TryRun(check32bit_test_source_file, '.cpp')
-    if suc:
-      context.Result(output)
-    else:
-      context.Result("test error")
-    return output
-
-conf = Configure(squirrel_env, custom_tests = { 'Check32bit' : Check32bit })
-if conf.Check32bit() == "64bits":
-  conf.env.Append(CXXFLAGS="-D_SQ64")
-squirrel_env = conf.Finish()
-
 squirrel_env.Library('squirrel',
             glob.glob('SQUIRREL2/squirrel/*.cpp') +
             glob.glob('SQUIRREL2/sqstdlib/*.cpp'))

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-12 20:30:28 UTC (rev 1417)
+++ trunk/windstille/src/SConscript	2007-06-12 21:08:12 UTC (rev 1418)
@@ -24,10 +24,14 @@
 ##  02111-1307, USA.
 ##
 
+Import('conf_env')
+
 env = Environment(CC = 'gcc',
                   CXX = 'g++',
-                  CCFLAGS = ['-O0', '-Wall', '-Werror', '-g', '-DDEBUG'])
+                  CXXFLAGS = ['-O0', '-Wall', '-Werror', '-g', '-DDEBUG'] + conf_env['CXXFLAGS'])
 
+env.Append(CXXFLAGS = conf_env['CXXFLAGS'])
+
 # env.Copy(LIBS = ['a', 'b'])
 
 env.foo = 5

Modified: trunk/windstille/src/scripting/SConscript
===================================================================
--- trunk/windstille/src/scripting/SConscript	2007-06-12 20:30:28 UTC (rev 1417)
+++ trunk/windstille/src/scripting/SConscript	2007-06-12 21:08:12 UTC (rev 1418)
@@ -2,7 +2,7 @@
 
 import SCons
 
-Import(['env', 'miniswig'])
+Import(['miniswig'])
 
 env = Environment(MINISWIG='tools/miniswig/miniswig')
 



From grumbel at mail.berlios.de  Wed Jun 13 05:04:37 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 13 Jun 2007 05:04:37 +0200
Subject: [Windstille-commit] r1419 - in trunk/windstille: . data/levels src
	src/gui src/objects
Message-ID: <200706130304.l5D34bn5010010@sheep.berlios.de>

Author: grumbel
Date: 2007-06-13 05:04:35 +0200 (Wed, 13 Jun 2007)
New Revision: 1419

Added:
   trunk/windstille/src/gui/menu_item.cpp
   trunk/windstille/src/gui/menu_item.hpp
Modified:
   trunk/windstille/
   trunk/windstille/data/levels/newformat2.wst
   trunk/windstille/src/SConscript
   trunk/windstille/src/grenade.cpp
   trunk/windstille/src/gui/menu_component.cpp
   trunk/windstille/src/gui/menu_component.hpp
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/menu_manager.hpp
   trunk/windstille/src/objects/vrdummy.cpp
Log:
- seperated MenuItem in its own file
- added scrolling to MenuComponent
- fixed some wsprite paths


Property changes on: trunk/windstille
___________________________________________________________________
Name: svn:ignore
   - 
aclocal.m4
autom4te.cache
cache
cache/
config.h.in
config.log
config.status
configure
custom.py
Jamconfig
Jamconfig.in
.sconsign.dblite
windstille

   + 
aclocal.m4
autom4te.cache
cache
cache/
config.h.in
config.log
config.status
configure
custom.py
Jamconfig
Jamconfig.in
.sconf_temp/
.sconsign.dblite
windstille


Modified: trunk/windstille/data/levels/newformat2.wst
===================================================================
--- trunk/windstille/data/levels/newformat2.wst	2007-06-12 21:08:12 UTC (rev 1418)
+++ trunk/windstille/data/levels/newformat2.wst	2007-06-13 03:04:35 UTC (rev 1419)
@@ -223,7 +223,7 @@
     (character
       (name "frank")
       (pos 200 831)
-      (sprite3d "3dsprites/sophie.wsprite")
+      (sprite3d "models/characters/sophie/sophie.wsprite")
     )
     (spider-mine
       (name "spider2")

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-12 21:08:12 UTC (rev 1418)
+++ trunk/windstille/src/SConscript	2007-06-13 03:04:35 UTC (rev 1419)
@@ -126,6 +126,7 @@
 'gui/automap.cpp',
 'gui/button.cpp',
 'gui/menu_component.cpp',
+'gui/menu_item.cpp',
 'gui/label.cpp',
 'gui/component.cpp',
 'gui/component_factory.cpp',

Modified: trunk/windstille/src/grenade.cpp
===================================================================
--- trunk/windstille/src/grenade.cpp	2007-06-12 21:08:12 UTC (rev 1418)
+++ trunk/windstille/src/grenade.cpp	2007-06-13 03:04:35 UTC (rev 1419)
@@ -29,7 +29,7 @@
 #include "collision/collision_engine.hpp"
 
 Grenade::Grenade()
-  : sprite("3dsprites/grenade.wsprite"), physics(this)
+  : sprite("models/objects/grenade/grenade.wsprite"), physics(this)
 {
   c_object.reset(new CollisionObject(this, Rectf(0, 0, 32, 32)));
   physics.register_collobj(*c_object);

Modified: trunk/windstille/src/gui/menu_component.cpp
===================================================================
--- trunk/windstille/src/gui/menu_component.cpp	2007-06-12 21:08:12 UTC (rev 1418)
+++ trunk/windstille/src/gui/menu_component.cpp	2007-06-13 03:04:35 UTC (rev 1419)
@@ -29,203 +29,19 @@
 #include "menu_component.hpp"
 #include "gui/tab_component.hpp"
 #include "display/display.hpp"
+#include "menu_item.hpp"
 #include "math.hpp"
 
 namespace GUI {
-
-MenuItem::MenuItem(MenuComponent* parent_, const std::string& label_)
-  : parent(parent_),
-    label(label_)
-{}
 
-void
-MenuItem::draw(const Rectf& rect, bool is_active)
-{
-  Color font_color;
-  TTFFont* font = parent->get_font();
-  
-  if (is_active) {
-    Display::fill_rounded_rect(rect, 5.0f, Color(0.5f, 0.5f, 0.5f, 0.75f));
-    Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 1.0f));
-    font_color = Color(1.0f, 1.0f, 1.0f);
-  } else {
-    //Display::fill_rounded_rect(rect, 5.0f, Color(0.3f, 0.3f, 0.3f, 0.75f));
-    //Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 0.75f));
-    font_color = Color(0.75f, 0.75f, 0.75f, 1.0f);
-  }
-
-  font->draw(rect.left + font->get_height(), rect.top + font->get_height()/2.0f + rect.get_height()/2.0f - 2.0f,
-             label, font_color);
-      
-}
-
-void
-MenuItem::update(float delta)
-{
-}
-
-EnumMenuItem::EnumMenuItem(MenuComponent* parent_, 
-                           const std::string& label_, int index_)
-  : MenuItem(parent_, label_),
-    index(index_)
-{
-}
-
-void
-EnumMenuItem::add_pair(int value, const std::string& label)
-{
-  EnumValue enum_value;
-  enum_value.value = value;
-  enum_value.label = label;
-  labels.push_back(enum_value);
-}
-
-void
-EnumMenuItem::incr()
-{
-  sound_manager->play("sounds/menu_click.wav");           
-
-  index -= 1;
-  if (index < 0)
-    index = labels.size()-1;
-  on_change(labels[index].value);
-}
-
-void
-EnumMenuItem::decr()
-{
-  sound_manager->play("sounds/menu_click.wav");
-
-  index += 1;
-  if (index >= static_cast<int>(labels.size()))
-    index = 0;
-  on_change(labels[index].value);
-}
-
-void 
-EnumMenuItem::draw(const Rectf& rect, bool is_active)
-{
-  MenuItem::draw(rect, is_active);
-  TTFFont* font = parent->get_font();
-  Color font_color;
-  if (is_active)
-    {
-      font_color = Color(1.0f, 1.0f, 1.0f);
-    }
-  else
-    {
-      font_color = Color(0.75f, 0.75f, 0.75f, 1.0f);
-    }
-
-  font->draw(rect.right - font->get_height() - font->get_width(labels[index].label),
-             rect.top + font->get_height()/2.0f + rect.get_height()/2.0f - 2.0f,
-             labels[index].label,
-             font_color);
-}
-
-void 
-EnumMenuItem::update(float delta)
-{
-  MenuItem::update(delta);
-}
-
-SliderMenuItem::SliderMenuItem(MenuComponent* parent_, 
-                               const std::string& label_,
-                               int value_, int min_value_, int max_value_, int step_) 
-  : MenuItem(parent_, label_),
-    value(value_),
-    min_value(min_value_),
-    max_value(max_value_),
-    step(step_)
-{  
-}
-
-void
-SliderMenuItem::decr()
-{
-  sound_manager->play("sounds/menu_click.wav");
-
-  value += step;
-  if (value > max_value)
-    value = max_value;
-  on_change(value);
-}
-
-void
-SliderMenuItem::incr()
-{
-  sound_manager->play("sounds/menu_click.wav");
-
-  value -= step;
-  if (value < min_value)
-    value = min_value;
-  on_change(value);
-}
-
-void
-SliderMenuItem::draw(const Rectf& rect, bool is_active)
-{
-  MenuItem::draw(rect, is_active);
-  int total_width = 200;
-  int width = total_width * value / (max_value - min_value);
-
-  Color color;
-  if (is_active)
-    {
-      color = Color(1.0f, 1.0f, 1.0f);
-    }
-  else
-    {
-      color = Color(0.75f, 0.75f, 0.75f, 1.0f);
-    }
-
-  Display::fill_rounded_rect(Rectf(Vector(rect.right - 4 - total_width, rect.top + 4),
-                                   Sizef(width, rect.get_height() - 8)), 
-                             5.0f,
-                             Color(0.75f*color.r, 0.75f*color.g, 0.75f*color.b, color.a));
-
-
-  Display::draw_rounded_rect(Rectf(Vector(rect.right - 4 - total_width, rect.top + 4),
-                                   Sizef(total_width, rect.get_height() - 8)), 
-                             5.0f,
-                             color);
-}
-
-void
-SliderMenuItem::update(float delta)
-{
-  MenuItem::update(delta);
-}
-
-ButtonMenuItem::ButtonMenuItem(MenuComponent* parent_, const std::string& label_)
-  : MenuItem(parent_, label_)
-{
-}
-
-void
-ButtonMenuItem::click()
-{
-  sound_manager->play("sounds/menu_click.wav");
-
-  on_click();
-}
-
-void
-ButtonMenuItem::draw(const Rectf& rect, bool is_active)
-{
-  MenuItem::draw(rect, is_active);
-}
-
-void
-ButtonMenuItem::update(float)
-{
-}
-
 MenuComponent::MenuComponent(const Rectf& rect, bool allow_cancel_, Component* parent)
   : Component(rect, parent),
     current_item(0),
     font(Fonts::vera16),
-    allow_cancel(allow_cancel_)
+    allow_cancel(allow_cancel_),
+    scroll_mode(false),
+    scroll_offset(0),
+    num_displayable_items(-1)
 {
 }
 
@@ -241,20 +57,52 @@
 MenuComponent::add_item(MenuItem* item)
 {
   items.push_back(item);
+  
+  if (calc_height() >= rect.get_height())
+    {
+      scroll_mode   = true;
+      scroll_offset = 0;
+      num_displayable_items = static_cast<int>(rect.get_height() / item_height());
+    }
 }
 
 void
 MenuComponent::draw()
 {
-  float spacing = 10.0f;
-  float step = font->get_height() + spacing*2.0f;
+  float step = item_height();
 
-  for(Items::size_type i = 0; i < items.size(); ++i)
-    {
-      items[i]->draw(Rectf(rect.left, rect.top + i * step + 2.0f, 
-                           rect.right, rect.top + (i+1) * step - 2.0f), 
-                     is_active() && (int(i) == current_item));
+  if (scroll_mode)
+    { // we can only display a subset of items and have to scroll
+      for(int i = 0; i < num_displayable_items; ++i)
+        {
+          items[i+scroll_offset]->draw(Rectf(rect.left, rect.top + i * step + 2.0f, 
+                                             rect.right - 32, rect.top + (i+1) * step - 2.0f), 
+                                       is_active() && (int(i+scroll_offset) == current_item));
+        }
+      
+      // draw scrollbar
+      float scrollbar_height = (rect.get_height()-4.0f) * num_displayable_items / items.size();
+      float scrollbar_incr   = (rect.get_height()-4.0f) * scroll_offset / items.size();
+
+      Display::fill_rounded_rect(Rectf(rect.right - 24, rect.top + 2.0f + scrollbar_incr,
+                                       rect.right - 2,  rect.top + 2.0f + scrollbar_incr + scrollbar_height),
+                                 5.0f,
+                                 Color(0.5f, 0.5f, 0.5f, 0.75f));
+      
+      Display::draw_rounded_rect(Rectf(rect.right - 24, rect.top + 2.0f,
+                                       rect.right - 2,  rect.bottom - 2.0f),
+                                 5.0f,
+                                 Color(1.0f, 1.0f, 1.0f, 1.0f));
     }
+  else
+    { // all items fit on the screen
+      for(Items::size_type i = 0; i < items.size(); ++i)
+        {
+          items[i]->draw(Rectf(rect.left, rect.top + i * step + 2.0f, 
+                               rect.right, rect.top + (i+1) * step - 2.0f), 
+                         is_active() && (int(i) == current_item));
+        }
+    }
 }
 
 void
@@ -295,7 +143,7 @@
           else if (i->axis.name == Y_AXIS)
             {
               if (i->axis.pos < 0)
-                {
+                { // up
                   sound_manager->play("sounds/menu_change.wav");
                                         
                   current_item = current_item - 1;
@@ -311,9 +159,11 @@
                           current_item = static_cast<int>(items.size())-1; 
                         }
                     }
+                  
+                  adjust_scroll_offset();
                 }
               else if (i->axis.pos > 0)
-                {
+                { // down
                   sound_manager->play("sounds/menu_change.wav");
 
                   if (dynamic_cast<TabComponent*>(parent))
@@ -329,6 +179,8 @@
                         }
 
                     }
+
+                  adjust_scroll_offset();
                 }
             }
         }
@@ -351,10 +203,10 @@
 MenuComponent::get_prefered_width() const
 {
   /*
-  float width = 0;
-  for(Items::iterator i = items.begin(); i != items.end(); ++i)
+    float width = 0;
+    for(Items::iterator i = items.begin(); i != items.end(); ++i)
     {
-      width = std::max(get_width())
+    width = std::max(get_width())
     }  */
   return 200; // FIXME:
 }
@@ -366,6 +218,35 @@
   return step * items.size();
 }
 
+float
+MenuComponent::calc_height()
+{
+  return items.size() * item_height();
+}
+
+float
+MenuComponent::item_height() const
+{
+  float spacing = 10.0f;
+  return font->get_height() + spacing*2.0f;
+}
+
+void 
+MenuComponent::adjust_scroll_offset()
+{
+  if (scroll_mode)
+    {
+      if (current_item - scroll_offset >= num_displayable_items)
+        { // scrolling down
+          scroll_offset = current_item - (num_displayable_items-1);
+        }
+      else if (current_item < scroll_offset)
+        { // scrolling up
+          scroll_offset = current_item;
+        }
+    }  
+}
+
 } // namespace GUI
 
 /* EOF */

Modified: trunk/windstille/src/gui/menu_component.hpp
===================================================================
--- trunk/windstille/src/gui/menu_component.hpp	2007-06-12 21:08:12 UTC (rev 1418)
+++ trunk/windstille/src/gui/menu_component.hpp	2007-06-13 03:04:35 UTC (rev 1419)
@@ -28,8 +28,6 @@
 
 #include <string>
 #include <vector>
-#include "signals/signal_v1.hpp"
-#include "signals/signal_v0.hpp"
 #include "font/fonts.hpp"
 #include "component.hpp"
 
@@ -37,88 +35,30 @@
 
 namespace GUI {
 
-class MenuComponent;
-
-class MenuItem {
-public:
-  MenuComponent* parent;
-  std::string label;
+class MenuItem;
 
-  MenuItem(MenuComponent* parent_, const std::string& label_);
-  virtual ~MenuItem() {}
-  virtual void incr() =0;
-  virtual void decr() =0;
-  virtual void click() =0;
-  virtual void draw(const Rectf& rect, bool is_active);
-  virtual void update(float delta);
-};
-
-class EnumMenuItem : public MenuItem {
-private: // FIXME: Convert this into a generic enum/value slider
-  struct EnumValue {
-    std::string label;
-    int         value;
-  };
-  
-  int index;
-  std::vector<EnumValue> labels;
-  Signal_v1<int> on_change;
-public:  
-  EnumMenuItem(MenuComponent* parent_, 
-               const std::string& label_, int index_ = 0);
-  
-  void add_pair(int value, const std::string& label);
-
-  void incr();
-  void decr();
-  void click() {}
-  void draw(const Rectf& rect, bool is_active);
-  void update(float);
-  Signal_v1<int>& sig_change() { return on_change; }
-};
-
-/** A slider widget for use in volume controls, gamma controls and
-    things like that */
-class SliderMenuItem : public MenuItem {
-public:
-  int value;
-  int min_value;
-  int max_value;
-  int step;
-  Signal_v1<int> on_change;
-public:  
-  SliderMenuItem(MenuComponent* parent_, 
-                 const std::string& label_, int value_, int mix_value_ = 0, int max_value_ = 100, int step = 10);
-  void incr();
-  void decr();
-  void click() {}
-  void draw(const Rectf& rect, bool is_active);
-  void update(float);
-  Signal_v1<int>& sig_change() { return on_change; }
-};
-
-class ButtonMenuItem : public MenuItem {
-public:
-  Signal_v0 on_click;
-public:  
-  ButtonMenuItem(MenuComponent* parent_, const std::string& label_);
-  void incr() {}
-  void decr() {}
-  void click();
-  void draw(const Rectf& rect, bool is_active);
-  void update(float);
-  Signal_v0& sig_click() { return on_click; }
-};
-
 /** */
 class MenuComponent : public Component
 {
 private:
   typedef std::vector<MenuItem* > Items;
   Items items;
+
   int   current_item;
   TTFFont* font;
   bool allow_cancel;
+
+  bool scroll_mode;
+  int  scroll_offset;
+  int  num_displayable_items;
+
+  /** Calculate how much height will be needed for the menu */
+  float calc_height();
+
+  /** Return the height of a single item */
+  float item_height() const;
+
+  void adjust_scroll_offset();
 public:
   MenuComponent(const Rectf& rect, bool allow_cancel_, Component* parent);
   virtual ~MenuComponent();

Added: trunk/windstille/src/gui/menu_item.cpp
===================================================================
--- trunk/windstille/src/gui/menu_item.cpp	2007-06-12 21:08:12 UTC (rev 1418)
+++ trunk/windstille/src/gui/menu_item.cpp	2007-06-13 03:04:35 UTC (rev 1419)
@@ -0,0 +1,225 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include "sound/sound_manager.hpp"
+#include "display/display.hpp"
+#include "font/ttf_font.hpp"
+#include "menu_component.hpp"
+
+#include "menu_item.hpp"
+
+namespace GUI {
+
+MenuItem::MenuItem(MenuComponent* parent_, const std::string& label_)
+  : parent(parent_),
+    label(label_)
+{}
+
+void
+MenuItem::draw(const Rectf& rect, bool is_active)
+{
+  Color font_color;
+  TTFFont* font = parent->get_font();
+  
+  if (is_active) {
+    Display::fill_rounded_rect(rect, 5.0f, Color(0.5f, 0.5f, 0.5f, 0.75f));
+    Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 1.0f));
+    font_color = Color(1.0f, 1.0f, 1.0f);
+  } else {
+    //Display::fill_rounded_rect(rect, 5.0f, Color(0.3f, 0.3f, 0.3f, 0.75f));
+    //Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f, 0.75f));
+    font_color = Color(0.75f, 0.75f, 0.75f, 1.0f);
+  }
+
+  font->draw(rect.left + font->get_height(), rect.top + font->get_height()/2.0f + rect.get_height()/2.0f - 2.0f,
+             label, font_color);
+      
+}
+
+void
+MenuItem::update(float delta)
+{
+}
+
+EnumMenuItem::EnumMenuItem(MenuComponent* parent_, 
+                           const std::string& label_, int index_)
+  : MenuItem(parent_, label_),
+    index(index_)
+{
+}
+
+void
+EnumMenuItem::add_pair(int value, const std::string& label)
+{
+  EnumValue enum_value;
+  enum_value.value = value;
+  enum_value.label = label;
+  labels.push_back(enum_value);
+}
+
+void
+EnumMenuItem::incr()
+{
+  sound_manager->play("sounds/menu_click.wav");           
+
+  index -= 1;
+  if (index < 0)
+    index = labels.size()-1;
+  on_change(labels[index].value);
+}
+
+void
+EnumMenuItem::decr()
+{
+  sound_manager->play("sounds/menu_click.wav");
+
+  index += 1;
+  if (index >= static_cast<int>(labels.size()))
+    index = 0;
+  on_change(labels[index].value);
+}
+
+void 
+EnumMenuItem::draw(const Rectf& rect, bool is_active)
+{
+  MenuItem::draw(rect, is_active);
+  TTFFont* font = parent->get_font();
+  Color font_color;
+  if (is_active)
+    {
+      font_color = Color(1.0f, 1.0f, 1.0f);
+    }
+  else
+    {
+      font_color = Color(0.75f, 0.75f, 0.75f, 1.0f);
+    }
+
+  font->draw(rect.right - font->get_height() - font->get_width(labels[index].label),
+             rect.top + font->get_height()/2.0f + rect.get_height()/2.0f - 2.0f,
+             labels[index].label,
+             font_color);
+}
+
+void 
+EnumMenuItem::update(float delta)
+{
+  MenuItem::update(delta);
+}
+
+SliderMenuItem::SliderMenuItem(MenuComponent* parent_, 
+                               const std::string& label_,
+                               int value_, int min_value_, int max_value_, int step_) 
+  : MenuItem(parent_, label_),
+    value(value_),
+    min_value(min_value_),
+    max_value(max_value_),
+    step(step_)
+{  
+}
+
+void
+SliderMenuItem::decr()
+{
+  sound_manager->play("sounds/menu_click.wav");
+
+  value += step;
+  if (value > max_value)
+    value = max_value;
+  on_change(value);
+}
+
+void
+SliderMenuItem::incr()
+{
+  sound_manager->play("sounds/menu_click.wav");
+
+  value -= step;
+  if (value < min_value)
+    value = min_value;
+  on_change(value);
+}
+
+void
+SliderMenuItem::draw(const Rectf& rect, bool is_active)
+{
+  MenuItem::draw(rect, is_active);
+  int total_width = 200;
+  int width = total_width * value / (max_value - min_value);
+
+  Color color;
+  if (is_active)
+    {
+      color = Color(1.0f, 1.0f, 1.0f);
+    }
+  else
+    {
+      color = Color(0.75f, 0.75f, 0.75f, 1.0f);
+    }
+
+  Display::fill_rounded_rect(Rectf(Vector(rect.right - 4 - total_width, rect.top + 4),
+                                   Sizef(width, rect.get_height() - 8)), 
+                             5.0f,
+                             Color(0.75f*color.r, 0.75f*color.g, 0.75f*color.b, color.a));
+
+
+  Display::draw_rounded_rect(Rectf(Vector(rect.right - 4 - total_width, rect.top + 4),
+                                   Sizef(total_width, rect.get_height() - 8)), 
+                             5.0f,
+                             color);
+}
+
+void
+SliderMenuItem::update(float delta)
+{
+  MenuItem::update(delta);
+}
+
+ButtonMenuItem::ButtonMenuItem(MenuComponent* parent_, const std::string& label_)
+  : MenuItem(parent_, label_)
+{
+}
+
+void
+ButtonMenuItem::click()
+{
+  sound_manager->play("sounds/menu_click.wav");
+
+  on_click();
+}
+
+void
+ButtonMenuItem::draw(const Rectf& rect, bool is_active)
+{
+  MenuItem::draw(rect, is_active);
+}
+
+void
+ButtonMenuItem::update(float)
+{
+}
+
+} // namespace GUI
+
+/* EOF */


Property changes on: trunk/windstille/src/gui/menu_item.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/gui/menu_item.hpp
===================================================================
--- trunk/windstille/src/gui/menu_item.hpp	2007-06-12 21:08:12 UTC (rev 1418)
+++ trunk/windstille/src/gui/menu_item.hpp	2007-06-13 03:04:35 UTC (rev 1419)
@@ -0,0 +1,114 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_WINDSTILLE_GUI_MENU_ITEM_HPP
+#define HEADER_WINDSTILLE_GUI_MENU_ITEM_HPP
+
+#include <string>
+#include <vector>
+#include "math/rect.hpp"
+#include "signals/signal_v1.hpp"
+#include "signals/signal_v0.hpp"
+
+namespace GUI {
+
+class MenuComponent;
+
+class MenuItem {
+public:
+  MenuComponent* parent;
+  std::string label;
+
+  MenuItem(MenuComponent* parent_, const std::string& label_);
+  virtual ~MenuItem() {}
+  virtual void incr() =0;
+  virtual void decr() =0;
+  virtual void click() =0;
+  virtual void draw(const Rectf& rect, bool is_active);
+  virtual void update(float delta);
+};
+
+class EnumMenuItem : public MenuItem {
+private: // FIXME: Convert this into a generic enum/value slider
+  struct EnumValue {
+    std::string label;
+    int         value;
+  };
+  
+  int index;
+  std::vector<EnumValue> labels;
+  Signal_v1<int> on_change;
+public:  
+  EnumMenuItem(MenuComponent* parent_, 
+               const std::string& label_, int index_ = 0);
+  
+  void add_pair(int value, const std::string& label);
+
+  void incr();
+  void decr();
+  void click() {}
+  void draw(const Rectf& rect, bool is_active);
+  void update(float);
+  Signal_v1<int>& sig_change() { return on_change; }
+};
+
+/** A slider widget for use in volume controls, gamma controls and
+    things like that */
+class SliderMenuItem : public MenuItem {
+public:
+  int value;
+  int min_value;
+  int max_value;
+  int step;
+  Signal_v1<int> on_change;
+public:  
+  SliderMenuItem(MenuComponent* parent_, 
+                 const std::string& label_, int value_, int mix_value_ = 0, int max_value_ = 100, int step = 10);
+  void incr();
+  void decr();
+  void click() {}
+  void draw(const Rectf& rect, bool is_active);
+  void update(float);
+  Signal_v1<int>& sig_change() { return on_change; }
+};
+
+class ButtonMenuItem : public MenuItem {
+public:
+  Signal_v0 on_click;
+public:  
+  ButtonMenuItem(MenuComponent* parent_, const std::string& label_);
+  void incr() {}
+  void decr() {}
+  void click();
+  void draw(const Rectf& rect, bool is_active);
+  void update(float);
+  Signal_v0& sig_click() { return on_click; }
+};
+
+} // namespace GUI
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/gui/menu_item.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-12 21:08:12 UTC (rev 1418)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-13 03:04:35 UTC (rev 1419)
@@ -38,6 +38,7 @@
 #include "sector.hpp"
 #include "sprite3d/manager.hpp"
 #include "sprite3dview.hpp"
+#include "gui/menu_item.hpp"
 #include "menu_manager.hpp"
 
 MenuManager menu_manager;
@@ -98,6 +99,10 @@
   difficulty_item->add_pair(2, "hard");
   menu->add_item(difficulty_item);
 
+  SliderMenuItem* gamma_item   = new SliderMenuItem(menu,  "Gamma",  100, 10, 200, 10);
+  slots.push_back(gamma_item->sig_change().connect(this, &MenuManager::menu_gamma));
+  menu->add_item(gamma_item);
+
   manager->get_root()->add_child(group);
   group->layout();
   screen_manager.push_overlay(manager);
@@ -175,7 +180,7 @@
   using namespace GUI;
   GUIManager* manager = new GUIManager();
 
-  GroupComponent* group = new GroupComponent(Rectf(Vector(400-200, 300-170), Sizef(400, 340)), 
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-200, 300-170), Sizef(400, 300)), 
                                              "Pause Menu",
                                              manager->get_root());
 
@@ -190,9 +195,9 @@
   slots.push_back(continue_button->sig_click().connect(this, &MenuManager::menu_continue));
   menu->add_item(continue_button);
 
-  ButtonMenuItem* select_scenario_button = new ButtonMenuItem(menu,  "Select Scenario");
-  slots.push_back(select_scenario_button->sig_click().connect(this, &MenuManager::display_scenario_menu));
-  menu->add_item(select_scenario_button);
+  //  ButtonMenuItem* select_scenario_button = new ButtonMenuItem(menu,  "Select Scenario");
+  //  slots.push_back(select_scenario_button->sig_click().connect(this, &MenuManager::display_scenario_menu));
+  // menu->add_item(select_scenario_button);
 
   ButtonMenuItem* options_button = new ButtonMenuItem(menu,  "Options");
   slots.push_back(options_button->sig_click().connect(this, &MenuManager::display_option_menu));
@@ -226,7 +231,7 @@
   using namespace GUI;
   GUIManager* manager = new GUIManager();
 
-  GroupComponent* group = new GroupComponent(Rectf(Vector(400-275, 30), Sizef(550, 540)), 
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-275, 100), Sizef(550, 376)),  // 378
                                              "Select Model",
                                              manager->get_root());
 
@@ -385,6 +390,8 @@
                                              manager->get_root());
 
   TextView* text = new TextView(Rectf(), group);
+  group->pack(text);
+
   text->set_font(Fonts::vera12);
   text->set_text("This is a tech-demo of Windstille. Its not meant "
                  "to be playable in any way except a bit of walking around. "
@@ -408,8 +415,6 @@
                  );
   text->set_active(true);
 
-  group->pack(text);
-
   manager->get_root()->add_child(group);
   screen_manager.push_overlay(manager);
 }
@@ -425,6 +430,8 @@
                                              manager->get_root());
 
   TextView* text = new TextView(Rectf(), group);
+  group->pack(text);
+
   text->set_font(Fonts::vera12);
   text->set_text("Programming\n"
                  "===========\n"
@@ -450,8 +457,6 @@
                  "  Marek Moeckel - Wansti - &lt;wansti at gmx.de&gt;\n");
   text->set_active(true);
 
-  group->pack(text);
-
   manager->get_root()->add_child(group);
   screen_manager.push_overlay(manager);
 }
@@ -548,4 +553,11 @@
     }
 }
 
+void
+MenuManager::menu_gamma(int i)
+{
+  float gamma = i / 100.0f;
+  SDL_SetGamma(gamma, gamma, gamma);
+}
+
 /* EOF */

Modified: trunk/windstille/src/menu_manager.hpp
===================================================================
--- trunk/windstille/src/menu_manager.hpp	2007-06-12 21:08:12 UTC (rev 1418)
+++ trunk/windstille/src/menu_manager.hpp	2007-06-13 03:04:35 UTC (rev 1419)
@@ -59,6 +59,7 @@
   void menu_start_scenario(std::string scenario);
   void menu_show_model(std::string scenario);
   void menu_show_particle_system(std::string file);
+  void menu_gamma(int i);
 private:
   MenuManager (const MenuManager&);
   MenuManager& operator= (const MenuManager&);

Modified: trunk/windstille/src/objects/vrdummy.cpp
===================================================================
--- trunk/windstille/src/objects/vrdummy.cpp	2007-06-12 21:08:12 UTC (rev 1418)
+++ trunk/windstille/src/objects/vrdummy.cpp	2007-06-13 03:04:35 UTC (rev 1419)
@@ -32,7 +32,7 @@
   props.get("pos",  pos);
   props.print_unused_warnings("VRDummy");
   
-  sprite = Sprite3D("3dsprites/vrdummy.wsprite");
+  sprite = Sprite3D("models/characters/vrdummy/vrdummy.wsprite");
   rotation = 0;
 
   highlight = Sprite("images/hedgehog_highlight.sprite");



From grumbel at mail.berlios.de  Wed Jun 13 06:33:51 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 13 Jun 2007 06:33:51 +0200
Subject: [Windstille-commit] r1420 - in trunk/windstille: . src
Message-ID: <200706130433.l5D4XpBv019064@sheep.berlios.de>

Author: grumbel
Date: 2007-06-13 06:33:49 +0200 (Wed, 13 Jun 2007)
New Revision: 1420

Modified:
   trunk/windstille/
   trunk/windstille/INSTALL
   trunk/windstille/NEWS
   trunk/windstille/src/menu_manager.cpp
Log:
Updated NEWS and INSTALL


Property changes on: trunk/windstille
___________________________________________________________________
Name: svn:ignore
   - 
aclocal.m4
autom4te.cache
cache
cache/
config.h.in
config.log
config.status
configure
custom.py
Jamconfig
Jamconfig.in
.sconf_temp/
.sconsign.dblite
windstille

   + 
aclocal.m4
autom4te.cache
cache
cache/
config.h.in
config.log
config.status
configure
custom.py
Jamconfig
Jamconfig.in
.sconf_temp
.sconf_temp/
.sconsign.dblite
windstille


Modified: trunk/windstille/INSTALL
===================================================================
--- trunk/windstille/INSTALL	2007-06-13 03:04:35 UTC (rev 1419)
+++ trunk/windstille/INSTALL	2007-06-13 04:33:49 UTC (rev 1420)
@@ -1,5 +1,26 @@
+Windstille Compilation
+======================
+
+To compile Windstille you need:
+
+ * OpenAL
+ * OpenGL
+ * SDL
+ * SDL_image
+ * freetype
+ * libpng
+ * physfs
+ * boost
+ * scons
+
+In most cases these will come with your distribution.
+
 The game does not support installation right now, just compile with:
 
- % scons
+ $ scons
 
-and run it from inside its source directory.
+and run it from inside its source directory with:
+
+ $ ./windstille
+
+# EOF #

Modified: trunk/windstille/NEWS
===================================================================
--- trunk/windstille/NEWS	2007-06-13 03:04:35 UTC (rev 1419)
+++ trunk/windstille/NEWS	2007-06-13 04:33:49 UTC (rev 1420)
@@ -1,7 +1,14 @@
 Windstille 0.3.0
 ================
- - 
+ - near complete rewrite of the engine
+ - 3D sprites
+ - light effects
+ - particle system
+ - model viewer
+ - menu system
+ - scripting
 
+
 Windstille 0.2.0
 ================
  - one new level (quite large)

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-13 03:04:35 UTC (rev 1419)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-13 04:33:49 UTC (rev 1420)
@@ -121,7 +121,7 @@
   TextView* text = new TextView(Rectf(), text_group);
   text_group->pack(text);
   text->set_font(Fonts::vera12);
-  text->set_text("Copyright (C) 2007 Ingo Ruhnke &lt;grumbel at gmx.de&gt;\n"
+  text->set_text("Windstille 0.3.0 - Copyright (C) 2007 Ingo Ruhnke &lt;grumbel at gmx.de&gt;\n"
                  "\n"
                  "This program is free software; you can redistribute it and/or "
                  "modify it under the terms of the GNU General Public License "



From grumbel at mail.berlios.de  Wed Jun 13 06:39:40 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 13 Jun 2007 06:39:40 +0200
Subject: [Windstille-commit] r1421 - trunk/windstille
Message-ID: <200706130439.l5D4deOL029209@sheep.berlios.de>

Author: grumbel
Date: 2007-06-13 06:39:29 +0200 (Wed, 13 Jun 2007)
New Revision: 1421

Modified:
   trunk/windstille/README
Log:
- spelling fix

Modified: trunk/windstille/README
===================================================================
--- trunk/windstille/README	2007-06-13 04:33:49 UTC (rev 1420)
+++ trunk/windstille/README	2007-06-13 04:39:29 UTC (rev 1421)
@@ -9,7 +9,7 @@
 
  * http://windstille.berlios.de/
 
-The latest development version can be optained by:
+The latest development version can be obtained by:
 
  $ svn co svn://svn.berlios.de/windstille/trunk/windstille
 



From grumbel at mail.berlios.de  Wed Jun 13 06:41:02 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 13 Jun 2007 06:41:02 +0200
Subject: [Windstille-commit] r1422 - tags
Message-ID: <200706130441.l5D4f2Iq031498@sheep.berlios.de>

Author: grumbel
Date: 2007-06-13 06:40:57 +0200 (Wed, 13 Jun 2007)
New Revision: 1422

Added:
   tags/windstille-0.3.0/
Log:
Released Windstille 0.3.0


Copied: tags/windstille-0.3.0 (from rev 1421, trunk/windstille)



From grumbel at mail.berlios.de  Wed Jun 13 06:52:40 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 13 Jun 2007 06:52:40 +0200
Subject: [Windstille-commit] r1423 - trunk/htdocs
Message-ID: <200706130452.l5D4qe1T013482@sheep.berlios.de>

Author: grumbel
Date: 2007-06-13 06:52:32 +0200 (Wed, 13 Jun 2007)
New Revision: 1423

Modified:
   trunk/htdocs/index.xml
   trunk/htdocs/news.xml
Log:
--- some unknown new stuff (automatically inserted by the upload script) ---

Modified: trunk/htdocs/index.xml
===================================================================
--- trunk/htdocs/index.xml	2007-06-13 04:40:57 UTC (rev 1422)
+++ trunk/htdocs/index.xml	2007-06-13 04:52:32 UTC (rev 1423)
@@ -42,8 +42,7 @@
     <subsection title="Scripting">
       <p>
         To allow a wide varity of puzzles and story events inside the
-        game, it will have to rely on a scripting engine, namly <a
-          href="http://www.gnu.org/software/guile/">Guile</a>. Game
+        game, it will have to rely on a scripting engine. Game
         content should be influencable quite a lot by scripting so
         that level designers and script writers have the freedom
         needed to create a compelling game.

Modified: trunk/htdocs/news.xml
===================================================================
--- trunk/htdocs/news.xml	2007-06-13 04:40:57 UTC (rev 1422)
+++ trunk/htdocs/news.xml	2007-06-13 04:52:32 UTC (rev 1423)
@@ -3,6 +3,19 @@
   
   <section title="News">
     <news>
+      <item date="13. Jun 2007">
+        Windstille 0.3.0 is out, featuring:
+        <ul>
+<li>near complete rewrite of the engine</li>
+<li>3D sprites</li>
+<li>light effects</li>
+<li>particle system</li>
+<li>model viewer</li>
+<li>menu system</li>
+<li>scripting</li>
+        </ul>
+      </item>
+
       <item date="23. Jun 2005">
         On 25. June 2005, 18:00 GMT we will have a developer IRC
         meeting in <tt>irc.freenode.net</tt>, channel



From grumbel at mail.berlios.de  Wed Jun 13 06:55:57 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 13 Jun 2007 06:55:57 +0200
Subject: [Windstille-commit] r1424 - trunk/htdocs
Message-ID: <200706130455.l5D4tvv9017513@sheep.berlios.de>

Author: grumbel
Date: 2007-06-13 06:55:56 +0200 (Wed, 13 Jun 2007)
New Revision: 1424

Modified:
   trunk/htdocs/download.xml
   trunk/htdocs/news.xml
Log:
--- some unknown new stuff (automatically inserted by the upload script) ---

Modified: trunk/htdocs/download.xml
===================================================================
--- trunk/htdocs/download.xml	2007-06-13 04:52:32 UTC (rev 1423)
+++ trunk/htdocs/download.xml	2007-06-13 04:55:56 UTC (rev 1424)
@@ -3,14 +3,21 @@
   
   <section title="Download">
     <p>
-      Below you can download the source code and static-binaries for
-      Windstille, the 0.2.0 release should be a useable techdemo, its
-      a bit playable (one level, one type of enemy) and should give
-      you an impression of how Windstille might look like. Win32
+      Below you can download the source code for Windstille, the 0.2.0
+      release should be a useable techdemo, its a bit playable (one
+      level, one type of enemy) and should give you an impression of
+      how Windstille might look like. The 0.3.0 release is much newer,
+      but not really playable, its just a pure techdemo. Win32
       releases always lack a bit behind. The static-binary requires a
       working OpenGL installation, glibc version shouldn't matter.
     </p>
 
+    <subsection title="0.3.0">
+      <ul>
+        <li>Source: <a href="http://download2.berlios.de/windstille/windstille-0.3.0.tar.bz2">windstille-0.3.0.tar.bz2</a></li>
+      </ul>
+    </subsection>
+
     <subsection title="0.2.0">
       <ul>
         <li>GNU/Linux binary+source: <a href="http://savannah.nongnu.org/download/windstille/windstille-0.2.0-binary-i386.tar.bz2">windstille-0.2.0-binary-i386.tar.bz2 [9.5mb]</a></li>
@@ -49,4 +56,4 @@
       <tt>svn co svn://svn.berlios.de/windstille/trunk/</tt>
     </p>
   </section>
-</page>
\ No newline at end of file
+</page>

Modified: trunk/htdocs/news.xml
===================================================================
--- trunk/htdocs/news.xml	2007-06-13 04:52:32 UTC (rev 1423)
+++ trunk/htdocs/news.xml	2007-06-13 04:55:56 UTC (rev 1424)
@@ -4,7 +4,7 @@
   <section title="News">
     <news>
       <item date="13. Jun 2007">
-        Windstille 0.3.0 is out, featuring:
+        <a href="download.html">Windstille 0.3.0</a> is out, featuring:
         <ul>
 <li>near complete rewrite of the engine</li>
 <li>3D sprites</li>



From grumbel at mail.berlios.de  Wed Jun 13 17:16:13 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 13 Jun 2007 17:16:13 +0200
Subject: [Windstille-commit] r1425 - trunk/windstille/src/gui
Message-ID: <200706131516.l5DFGDJw021829@sheep.berlios.de>

Author: grumbel
Date: 2007-06-13 17:16:13 +0200 (Wed, 13 Jun 2007)
New Revision: 1425

Modified:
   trunk/windstille/src/gui/Jamfile
Log:
- updated jam file

Modified: trunk/windstille/src/gui/Jamfile
===================================================================
--- trunk/windstille/src/gui/Jamfile	2007-06-13 04:55:56 UTC (rev 1424)
+++ trunk/windstille/src/gui/Jamfile	2007-06-13 15:16:13 UTC (rev 1425)
@@ -21,6 +21,8 @@
   list_view.cpp
   menu_component.hpp
   menu_component.cpp
+  menu_item.hpp
+  menu_item.cpp
   root_component.cpp
   root_component.hpp
   slider.cpp



From grumbel at mail.berlios.de  Wed Jun 13 17:54:23 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 13 Jun 2007 17:54:23 +0200
Subject: [Windstille-commit] r1426 - trunk/windstille/src
Message-ID: <200706131554.l5DFsN1L028181@sheep.berlios.de>

Author: grumbel
Date: 2007-06-13 17:54:23 +0200 (Wed, 13 Jun 2007)
New Revision: 1426

Modified:
   trunk/windstille/src/player.cpp
Log:
- disabled walking sound, not good and causes crashes

Modified: trunk/windstille/src/player.cpp
===================================================================
--- trunk/windstille/src/player.cpp	2007-06-13 15:16:13 UTC (rev 1425)
+++ trunk/windstille/src/player.cpp	2007-06-13 15:54:23 UTC (rev 1426)
@@ -383,9 +383,9 @@
     velocity.x = -WALK_SPEED;
 
   // start walking sound
-  sound_source.reset(sound_manager->create_sound_source("sounds/steps_dirt.ogg"));
-  sound_source->set_looping(true);
-  sound_source->play();
+  // sound_source.reset(sound_manager->create_sound_source("sounds/steps_dirt.ogg"));
+  // sound_source->set_looping(true);
+  // sound_source->play();
 }
 
 void
@@ -415,7 +415,7 @@
 Player::leave_walk()
 {
   // stop walking sound
-  sound_source->stop();
+  // sound_source->stop();
 }
 
 void
@@ -542,9 +542,9 @@
   state = RUN;
 
   // start running sound
-  sound_source.reset(sound_manager->create_sound_source("sounds/steps_dirt.ogg"));
-  sound_source->set_looping(true);
-  sound_source->play();
+  // sound_source.reset(sound_manager->create_sound_source("sounds/steps_dirt.ogg"));
+  // sound_source->set_looping(true);
+  // sound_source->play();
 }
 
 void
@@ -565,7 +565,7 @@
 void
 Player::leave_run()
 {
-  sound_source->stop();
+  // sound_source->stop();
 }
 
 void



From grumbel at mail.berlios.de  Thu Jun 14 00:56:17 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 14 Jun 2007 00:56:17 +0200
Subject: [Windstille-commit] r1427 - in trunk/windstille/data/images: .
	controller
Message-ID: <200706132256.l5DMuH8v018090@sheep.berlios.de>

Author: grumbel
Date: 2007-06-14 00:56:15 +0200 (Thu, 14 Jun 2007)
New Revision: 1427

Added:
   trunk/windstille/data/images/controller/
   trunk/windstille/data/images/controller/a.png
   trunk/windstille/data/images/controller/b.png
   trunk/windstille/data/images/controller/back.png
   trunk/windstille/data/images/controller/dpad_down.png
   trunk/windstille/data/images/controller/dpad_left.png
   trunk/windstille/data/images/controller/dpad_right.png
   trunk/windstille/data/images/controller/dpad_up.png
   trunk/windstille/data/images/controller/start.png
   trunk/windstille/data/images/controller/x.png
   trunk/windstille/data/images/controller/y.png
Log:
- added some images of buttons and dpad

Added: trunk/windstille/data/images/controller/a.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/a.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/images/controller/b.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/b.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/images/controller/back.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/back.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/images/controller/dpad_down.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/dpad_down.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/images/controller/dpad_left.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/dpad_left.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/images/controller/dpad_right.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/dpad_right.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/images/controller/dpad_up.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/dpad_up.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/images/controller/start.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/start.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/images/controller/x.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/x.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/images/controller/y.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/y.png
___________________________________________________________________
Name: svn:mime-type
   + image/png



From grumbel at mail.berlios.de  Thu Jun 14 07:36:46 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 14 Jun 2007 07:36:46 +0200
Subject: [Windstille-commit] r1428 - in trunk/windstille/src: . gui input
Message-ID: <200706140536.l5E5ak58002528@sheep.berlios.de>

Author: grumbel
Date: 2007-06-14 07:36:45 +0200 (Thu, 14 Jun 2007)
New Revision: 1428

Modified:
   trunk/windstille/src/controller_def.hpp
   trunk/windstille/src/game_session.cpp
   trunk/windstille/src/gui/menu_component.cpp
   trunk/windstille/src/input/input_configurator.cpp
   trunk/windstille/src/input/input_manager_impl.hpp
   trunk/windstille/src/input/input_manager_sdl.cpp
   trunk/windstille/src/input/input_manager_sdl.hpp
   trunk/windstille/src/pda.cpp
   trunk/windstille/src/player.cpp
   trunk/windstille/src/sprite3dview.cpp
   trunk/windstille/src/sprite3dview.hpp
   trunk/windstille/src/windstille_main.cpp
Log:
- changed the input code so that it works well with a gamepad
- added default config for xbox360 gamepad

Modified: trunk/windstille/src/controller_def.hpp
===================================================================
--- trunk/windstille/src/controller_def.hpp	2007-06-13 22:56:15 UTC (rev 1427)
+++ trunk/windstille/src/controller_def.hpp	2007-06-14 05:36:45 UTC (rev 1428)
@@ -51,17 +51,22 @@
     PAUSE_BUTTON,     // used to pause the game
     AIM_BUTTON,       // used to draw the gun and aim
 
-    // These are not to be used alone, but only as alternatives for
-    // other keys
-    ESCAPE_BUTTON,    // hardcoded to escape key
-    ENTER_BUTTON,     // hardcoded to enter key
+    // Keys for menu navigation, they come with hardcoded defaults for
+    // the keyboard, a joystick might emmit them as well
+    ESCAPE_BUTTON,
+    ENTER_BUTTON,
 
+    MENU_UP_BUTTON,  
+    MENU_DOWN_BUTTON,
+    MENU_LEFT_BUTTON,
+    MENU_RIGHT_BUTTON,
+
     LAST_EVENT
   };
 
 #define JUMP_BUTTON   PRIMARY_BUTTON
-#define RUN_BUTTON    SECONDARY_BUTTON
-#define USE_BUTTON    TERTIARY_BUTTON
+#define RUN_BUTTON    TERTIARY_BUTTON
+#define USE_BUTTON    SECONDARY_BUTTON
 #define OK_BUTTON     PRIMARY_BUTTON
 #define CANCEL_BUTTON SECONDARY_BUTTON
 

Modified: trunk/windstille/src/game_session.cpp
===================================================================
--- trunk/windstille/src/game_session.cpp	2007-06-13 22:56:15 UTC (rev 1427)
+++ trunk/windstille/src/game_session.cpp	2007-06-14 05:36:45 UTC (rev 1428)
@@ -198,8 +198,8 @@
   else if (cutscene_value < 0.0f)
     cutscene_value = 0.0f;
 
-  if (controller.button_was_pressed(PAUSE_BUTTON))
-    pause = !pause;
+  // if (controller.button_was_pressed(PAUSE_BUTTON))
+  // pause = !pause;
 
   Uint8 *keystate = SDL_GetKeyState(NULL);
 
@@ -285,7 +285,8 @@
       else
         current_gui = &inventory;
     }
-  else if (controller.button_was_pressed(ESCAPE_BUTTON))
+  else if (controller.button_was_pressed(ESCAPE_BUTTON) ||
+           controller.button_was_pressed(PAUSE_BUTTON))
     {
       menu_manager.display_pause_menu();
     }

Modified: trunk/windstille/src/gui/menu_component.cpp
===================================================================
--- trunk/windstille/src/gui/menu_component.cpp	2007-06-13 22:56:15 UTC (rev 1427)
+++ trunk/windstille/src/gui/menu_component.cpp	2007-06-14 05:36:45 UTC (rev 1428)
@@ -118,7 +118,9 @@
             {
               items[current_item]->click();
             }
-          else if (i->button.name == CANCEL_BUTTON || i->button.name == ESCAPE_BUTTON)
+          else if (i->button.name == CANCEL_BUTTON || 
+                   i->button.name == ESCAPE_BUTTON ||
+                   i->button.name == PAUSE_BUTTON)
             {
               if (allow_cancel) // FIXME: Could use a signal instead
                 {
@@ -126,62 +128,53 @@
                   set_active(false);
                 }
             }
-        }
-      else if (i->type == AXIS_EVENT)
-        {
-          if (i->axis.name == X_AXIS)
+          else if (i->button.name == MENU_LEFT_BUTTON)
             {
-              if (i->axis.pos < 0)
-                {
-                  items[current_item]->incr();
-                }
-              else if (i->axis.pos > 0)
-                {
-                  items[current_item]->decr();
-                }
+              items[current_item]->incr();              
             }
-          else if (i->axis.name == Y_AXIS)
+          else if (i->button.name == MENU_RIGHT_BUTTON)
             {
-              if (i->axis.pos < 0)
-                { // up
-                  sound_manager->play("sounds/menu_change.wav");
-                                        
-                  current_item = current_item - 1;
-                  if (current_item < 0)
+              items[current_item]->decr();              
+            }          
+          else if (i->button.name == MENU_UP_BUTTON)
+            {
+              sound_manager->play("sounds/menu_change.wav");
+              
+              current_item = current_item - 1;
+              if (current_item < 0)
+                {
+                  if (dynamic_cast<TabComponent*>(parent))
                     {
-                      if (dynamic_cast<TabComponent*>(parent))
-                        {
-                          current_item = 0;
-                          set_active(false);
-                        }
-                      else
-                        { 
-                          current_item = static_cast<int>(items.size())-1; 
-                        }
+                      current_item = 0;
+                      set_active(false);
                     }
-                  
-                  adjust_scroll_offset();
+                  else
+                    { 
+                      current_item = static_cast<int>(items.size())-1; 
+                    }
                 }
-              else if (i->axis.pos > 0)
-                { // down
-                  sound_manager->play("sounds/menu_change.wav");
+                  
+              adjust_scroll_offset();
+            }
+          else if (i->button.name == MENU_DOWN_BUTTON)
+            {
+              sound_manager->play("sounds/menu_change.wav");
 
-                  if (dynamic_cast<TabComponent*>(parent))
+              if (dynamic_cast<TabComponent*>(parent))
+                {
+                  current_item = Math::mid(0, current_item + 1, static_cast<int>(items.size()-1)); 
+                }
+              else
+                {
+                  current_item += 1;
+                  if (current_item >= static_cast<int>(items.size()))
                     {
-                      current_item = Math::mid(0, current_item + 1, static_cast<int>(items.size()-1)); 
+                      current_item = 0;
                     }
-                  else
-                    {
-                      current_item += 1;
-                      if (current_item >= static_cast<int>(items.size()))
-                        {
-                          current_item = 0;
-                        }
 
-                    }
-
-                  adjust_scroll_offset();
                 }
+
+              adjust_scroll_offset();
             }
         }
     }

Modified: trunk/windstille/src/input/input_configurator.cpp
===================================================================
--- trunk/windstille/src/input/input_configurator.cpp	2007-06-13 22:56:15 UTC (rev 1427)
+++ trunk/windstille/src/input/input_configurator.cpp	2007-06-14 05:36:45 UTC (rev 1428)
@@ -57,9 +57,6 @@
   add_configure_item(ConfigureItem::CONFIGURE_AXIS, Y_AXIS);
   add_configure_item(ConfigureItem::CONFIGURE_AXIS, X_AXIS);
 
-  // add_configure_item(ConfigureItem::CONFIGURE_AXIS, X2_AXIS);
-  // add_configure_item(ConfigureItem::CONFIGURE_AXIS, Y2_AXIS);
-
   print_item();
 
   InputManagerSDL::current()->clear_bindings();

Modified: trunk/windstille/src/input/input_manager_impl.hpp
===================================================================
--- trunk/windstille/src/input/input_manager_impl.hpp	2007-06-13 22:56:15 UTC (rev 1427)
+++ trunk/windstille/src/input/input_manager_impl.hpp	2007-06-14 05:36:45 UTC (rev 1428)
@@ -44,10 +44,10 @@
   const Controller& get_controller() const;
   void clear();
 
-  void add_axis_event  (int name, float pos);
-  void add_ball_event  (int name, float pos);
-  void add_button_event(int name, bool down);
-  void add_keyboard_event(int name, KeyboardEvent::KeyType key_type, int code);
+  virtual void add_axis_event  (int name, float pos);
+  virtual void add_ball_event  (int name, float pos);
+  virtual void add_button_event(int name, bool down);
+  virtual void add_keyboard_event(int name, KeyboardEvent::KeyType key_type, int code);
 private:
   InputManagerImpl(const InputManagerImpl&);
   InputManagerImpl& operator=(const InputManagerImpl&);

Modified: trunk/windstille/src/input/input_manager_sdl.cpp
===================================================================
--- trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-13 22:56:15 UTC (rev 1427)
+++ trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-14 05:36:45 UTC (rev 1428)
@@ -202,6 +202,22 @@
     {
       add_button_event(ESCAPE_BUTTON, event.state);
     }
+  else if (event.keysym.sym == SDLK_LEFT)
+    {
+      add_button_event(MENU_LEFT_BUTTON, event.state);
+    }
+  else if (event.keysym.sym == SDLK_RIGHT)
+    {
+      add_button_event(MENU_RIGHT_BUTTON, event.state);
+    }
+  else if (event.keysym.sym == SDLK_UP)
+    {
+      add_button_event(MENU_UP_BUTTON, event.state);
+    }
+  else if (event.keysym.sym == SDLK_DOWN)
+    {
+      add_button_event(MENU_DOWN_BUTTON, event.state);
+    }
 
   // Dynamic bindings
   for (std::vector<KeyboardButtonBinding>::const_iterator i = impl->keyboard_button_bindings.begin();
@@ -475,4 +491,66 @@
   impl->keyboard_axis_bindings.clear();
 }
 
+void
+InputManagerSDL::add_axis_event  (int name, float pos)
+{
+  // Convert analog axis events into digital menu movements
+  // FIXME: add key repeat
+  float click_threshold = 0.5f;
+  float release_threshold = 0.3f;
+
+  // FIXME: need state info
+  float old_pos = controller.get_axis_state(name);
+  if (name == X_AXIS)
+    {
+      if (controller.get_button_state(MENU_LEFT_BUTTON) == 0 &&
+          pos < -click_threshold && old_pos > -click_threshold) 
+        {
+          add_button_event(MENU_LEFT_BUTTON, 1);
+        } 
+      else if (controller.get_button_state(MENU_LEFT_BUTTON) == 1 &&
+               old_pos < -release_threshold && pos > -release_threshold) 
+        {
+          add_button_event(MENU_LEFT_BUTTON, 0);
+        } 
+      
+      else if (controller.get_button_state(MENU_RIGHT_BUTTON) == 0 &&
+               pos > click_threshold && old_pos < click_threshold) 
+        {
+          add_button_event(MENU_RIGHT_BUTTON, 1);
+        } 
+      else  if (controller.get_button_state(MENU_RIGHT_BUTTON) == 1 &&
+                old_pos > release_threshold && pos < release_threshold) 
+        {
+          add_button_event(MENU_RIGHT_BUTTON, 0);
+        }
+    }
+  else if (name == Y_AXIS)
+    {
+      if (controller.get_button_state(MENU_UP_BUTTON) == 0 &&
+          pos < -click_threshold && old_pos > -click_threshold) 
+        {
+          add_button_event(MENU_UP_BUTTON, 1);
+        } 
+      else if (controller.get_button_state(MENU_UP_BUTTON) == 1 &&
+               old_pos < -release_threshold && pos > -release_threshold) 
+        {
+          add_button_event(MENU_UP_BUTTON, 0);
+        }
+
+      else  if (controller.get_button_state(MENU_DOWN_BUTTON) == 0 &&
+                pos > click_threshold && old_pos < click_threshold) 
+        {
+          add_button_event(MENU_DOWN_BUTTON, 1);
+        } 
+      else  if (controller.get_button_state(MENU_DOWN_BUTTON) == 1 &&
+                old_pos > release_threshold && pos < release_threshold) 
+        {
+          add_button_event(MENU_DOWN_BUTTON, 0);
+        }
+    }
+
+  InputManagerImpl::add_axis_event(name, pos);
+}
+
 /* EOF */

Modified: trunk/windstille/src/input/input_manager_sdl.hpp
===================================================================
--- trunk/windstille/src/input/input_manager_sdl.hpp	2007-06-13 22:56:15 UTC (rev 1427)
+++ trunk/windstille/src/input/input_manager_sdl.hpp	2007-06-14 05:36:45 UTC (rev 1428)
@@ -113,6 +113,7 @@
 
   void on_event(const SDL_Event& event);
 
+  void add_axis_event  (int name, float pos);
 private:
   void on_key_event(const SDL_KeyboardEvent& key);
   void on_mouse_button_event(const SDL_MouseButtonEvent& button);

Modified: trunk/windstille/src/pda.cpp
===================================================================
--- trunk/windstille/src/pda.cpp	2007-06-13 22:56:15 UTC (rev 1427)
+++ trunk/windstille/src/pda.cpp	2007-06-14 05:36:45 UTC (rev 1428)
@@ -67,37 +67,40 @@
 {
   const InputEventLst& events = controller.get_events();
   for(InputEventLst::const_iterator i = events.begin(); i != events.end(); ++i) {
-    if (i->type == AXIS_EVENT && i->axis.name == X_AXIS) {
-      if (i->axis.pos > 0) {
-        state = static_cast<pda_state>(state + 1);
-        if (state > PDA_DIALOGS)
-          state = PDA_OBJECTIVES;
+    if (i->type == BUTTON_EVENT)
+      {
+        if (i->axis.name == MENU_LEFT_BUTTON && i->button.down) 
+          {
+            state = static_cast<pda_state>(state + 1);
+            if (state > PDA_DIALOGS)
+              state = PDA_OBJECTIVES;
+          }
+        else if (i->axis.name == MENU_RIGHT_BUTTON && i->button.down) 
+          {
+            state = static_cast<pda_state>(state - 1);
+            if (state < PDA_OBJECTIVES)
+              state = PDA_DIALOGS;
+          }
       }
-      else if (i->axis.pos < 0) {
-        state = static_cast<pda_state>(state - 1);
-        if (state < PDA_OBJECTIVES)
-          state = PDA_DIALOGS;
-      }
-    }
   }
   
   int width  = 600;
   int height = 400;
   
   switch (state) {
-    case PDA_OBJECTIVES:
-      show_objectives();
-      break;
-    case PDA_DIALOGS:
-      show_dialogs();
-      break;
+  case PDA_OBJECTIVES:
+    show_objectives();
+    break;
+  case PDA_DIALOGS:
+    show_dialogs();
+    break;
   }
  
   if (new_text != old_text) {
     delete text_area;
     text_area = new TextArea(Rect(Point(100,
-                100),
-                Size(width, height)), false);
+                                        100),
+                                  Size(width, height)), false);
     text_area->set_font(Fonts::ttffont);
     text_area->set_text(new_text);
     

Modified: trunk/windstille/src/player.cpp
===================================================================
--- trunk/windstille/src/player.cpp	2007-06-13 22:56:15 UTC (rev 1427)
+++ trunk/windstille/src/player.cpp	2007-06-14 05:36:45 UTC (rev 1428)
@@ -231,7 +231,7 @@
 void
 Player::update_walk_stand()
 {
-  if (controller.get_axis_state(Y_AXIS) > 0) {
+  if (controller.get_axis_state(Y_AXIS) > 0.5f) {
     TileMap* tilemap = Sector::current()->get_tilemap2();
     if (tilemap)
       {
@@ -257,7 +257,7 @@
             return;
           }
       }
-  } else if (controller.get_axis_state(Y_AXIS) < 0) {
+  } else if (controller.get_axis_state(Y_AXIS) < -0.5f) {
     TileMap* tilemap = Sector::current()->get_tilemap2();
     if (tilemap)
       {
@@ -290,11 +290,11 @@
 {
   assert(contact);
 
-  if (controller.get_axis_state(X_AXIS) < 0 ||
-      controller.get_axis_state(Y_AXIS) > 0)
+  if (controller.get_axis_state(X_AXIS) < -0.5f ||
+      controller.get_axis_state(Y_AXIS) > 0.5f)
     contact->advance(-WALK_SPEED * delta * 0.7f);
-  else if (controller.get_axis_state(X_AXIS) > 0 ||
-           controller.get_axis_state(Y_AXIS) < 0)
+  else if (controller.get_axis_state(X_AXIS) > 0.5f ||
+           controller.get_axis_state(Y_AXIS) < -0.5f)
     contact->advance(WALK_SPEED * delta * 0.7f);
 
   velocity = Vector(0, 0);
@@ -340,7 +340,7 @@
     }
     
   if(controller.button_was_pressed(JUMP_BUTTON)
-     && controller.get_axis_state(Y_AXIS) > 1.0f) 
+     && controller.get_axis_state(Y_AXIS) > 0.5f) 
     {
       set_jump_up_begin();
     } 
@@ -355,14 +355,14 @@
       sprite.set_action("PullGun");
       state = PULL_GUN;
     }
-  else if (controller.get_axis_state(X_AXIS) < 0) 
+  else if (controller.get_axis_state(X_AXIS) < -0.5f) 
     {
       if(get_direction() == WEST)
         set_walk(WEST);
       else
         set_turnaround();
     }
-  else if (controller.get_axis_state(X_AXIS) > 0) 
+  else if (controller.get_axis_state(X_AXIS) > 0.5f) 
     {
       if(get_direction() == EAST)
         set_walk(EAST);
@@ -397,8 +397,8 @@
     return;
   }
 
-  if(get_direction() == WEST && controller.get_axis_state(X_AXIS) > 0
-     || get_direction() == EAST && controller.get_axis_state(X_AXIS) < 0) {
+  if(get_direction() == WEST && controller.get_axis_state(X_AXIS) > 0.5f
+     || get_direction() == EAST && controller.get_axis_state(X_AXIS) < -0.5f) {
     leave_walk();
     set_turnaround();
     return;
@@ -439,11 +439,11 @@
     return;
   }
   
-  if(!(controller.get_axis_state(Y_AXIS) > 0) && sprite.get_speed() > 0) {
+  if(!(controller.get_axis_state(Y_AXIS) > 0.5f) && sprite.get_speed() > 0) {
     sprite.set_speed(-1.0);
     sprite.set_next_action("Stand");
     state = STAND;
-  } else if(controller.get_axis_state(Y_AXIS) > 0 && sprite.get_speed() < 0) {
+  } else if(controller.get_axis_state(Y_AXIS) > 0.5f && sprite.get_speed() < 0) {
     sprite.set_speed(1.0);
     sprite.set_next_action("Ducking");
   }
@@ -459,7 +459,7 @@
 void
 Player::update_ducked()
 {
-  if(!controller.get_axis_state(Y_AXIS) > 0) {
+  if(!controller.get_axis_state(Y_AXIS) > 0.5f) {
     state = DUCKING;
     sprite.set_action("StandToDuck", -1.0);
     sprite.set_next_action("Stand");
@@ -486,8 +486,8 @@
       set_walk(WEST);
     }
   } 
-  if(sprite.get_rot() && controller.get_axis_state(X_AXIS) > 0
-     || !sprite.get_rot() && controller.get_axis_state(X_AXIS) < 0) {
+  if(sprite.get_rot() && controller.get_axis_state(X_AXIS) > 0.5f
+     || !sprite.get_rot() && controller.get_axis_state(X_AXIS) < -0.5f) {
     sprite.set_speed(-1.0);
     sprite.set_next_action("Walk");
     state = WALK;

Modified: trunk/windstille/src/sprite3dview.cpp
===================================================================
--- trunk/windstille/src/sprite3dview.cpp	2007-06-13 22:56:15 UTC (rev 1427)
+++ trunk/windstille/src/sprite3dview.cpp	2007-06-14 05:36:45 UTC (rev 1428)
@@ -43,7 +43,7 @@
 
   rotx  = 0.0f;
   roty  = 0.0f;
-  scale = 1.0f;
+  scale = 2.0f;
 }
 
 Sprite3DView::~Sprite3DView()
@@ -68,9 +68,9 @@
 
   sc.push_modelview();
   sc.translate(Display::get_width()/2, Display::get_height()/2 + 200);
-  sc.scale(3.0f, 3.0f);
-  sc.rotate(rotx, 0.0f, 1.0f, 0.0f);
-  sc.rotate(roty, 1.0f, 0.0f, 0.0f);
+  sc.scale(scale, scale);
+  sc.rotate(roty, 0.0f, 1.0f, 0.0f);
+  sc.rotate(rotx, 1.0f, 0.0f, 0.0f);
   sprite.draw(sc.color(), Vector(0,0), 0); 
   sc.pop_modelview();
 
@@ -112,14 +112,14 @@
   //std::cout << "Delta: " << delta << std::endl;
 
   int last_action = current_action;
-  if (controller.axis_was_pressed_up(Y_AXIS))
+  if (controller.button_was_pressed(MENU_DOWN_BUTTON))
     {
       if (current_action == int(actions.size())-1)
         current_action = 0;
       else
         current_action += 1;
     }
-  else if (controller.axis_was_pressed_down(Y_AXIS))
+  else if (controller.button_was_pressed(MENU_UP_BUTTON))
     {
       if (current_action == 0)
         current_action = actions.size()-1;
@@ -127,6 +127,15 @@
         current_action -= 1;
     }
 
+  if (controller.get_button_state(PRIMARY_BUTTON))
+    {
+      scale *= 1.0f + 0.3f * delta;
+    }
+  else if (controller.get_button_state(PDA_BUTTON))
+    {
+      scale /= 1.0f + 0.3f * delta;
+    }
+  
   if (last_action != current_action && !actions.empty())
     {
       sprite.set_action(actions[current_action]);
@@ -140,4 +149,10 @@
     screen_manager.pop_screen();
 }
 
+void
+Sprite3DView::handle_event(const SDL_Event& )
+{
+  
+}
+
 /* EOF */

Modified: trunk/windstille/src/sprite3dview.hpp
===================================================================
--- trunk/windstille/src/sprite3dview.hpp	2007-06-13 22:56:15 UTC (rev 1427)
+++ trunk/windstille/src/sprite3dview.hpp	2007-06-14 05:36:45 UTC (rev 1428)
@@ -54,6 +54,8 @@
   void update(float delta, const Controller& controller);
 
   void set_model(const std::string& filename);
+  
+  void handle_event(const SDL_Event& );
 
 private:
   Sprite3DView (const Sprite3DView&);

Modified: trunk/windstille/src/windstille_main.cpp
===================================================================
--- trunk/windstille/src/windstille_main.cpp	2007-06-13 22:56:15 UTC (rev 1427)
+++ trunk/windstille/src/windstille_main.cpp	2007-06-14 05:36:45 UTC (rev 1428)
@@ -83,6 +83,12 @@
       controller_description.add_button("primary-button",   PRIMARY_BUTTON);
       controller_description.add_button("secondary-button", SECONDARY_BUTTON);
       controller_description.add_button("tertiary-button",  TERTIARY_BUTTON);
+
+      controller_description.add_button("menu-up-button",  MENU_UP_BUTTON);
+      controller_description.add_button("menu-down-button",  MENU_DOWN_BUTTON);
+
+      controller_description.add_button("menu-left-button",  MENU_LEFT_BUTTON);
+      controller_description.add_button("menu-right-button",  MENU_RIGHT_BUTTON);
   
       controller_description.add_button("pda-button", PDA_BUTTON);
       controller_description.add_button("inventory-button", INVENTORY_BUTTON);



From grumbel at mail.berlios.de  Thu Jun 14 22:00:09 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 14 Jun 2007 22:00:09 +0200
Subject: [Windstille-commit] r1429 - in trunk/media/images: . gui
Message-ID: <200706142000.l5EK09G1024717@sheep.berlios.de>

Author: grumbel
Date: 2007-06-14 21:59:52 +0200 (Thu, 14 Jun 2007)
New Revision: 1429

Added:
   trunk/media/images/gui/
   trunk/media/images/gui/analogstick.xcf
   trunk/media/images/gui/button.xcf
   trunk/media/images/gui/button2.xcf
   trunk/media/images/gui/dpad.xcf
   trunk/media/images/gui/keyboardkey.png
   trunk/media/images/gui/keyboardkey_small.xcf
   trunk/media/images/gui/start_back.xcf
   trunk/media/images/gui/trigger.xcf
   trunk/media/images/gui/trigger2.xcf
Log:
- added images of controller elements for gui

Added: trunk/media/images/gui/analogstick.xcf
===================================================================
(Binary files differ)


Property changes on: trunk/media/images/gui/analogstick.xcf
___________________________________________________________________
Name: svn:mime-type
   + application/x-xcf

Added: trunk/media/images/gui/button.xcf
===================================================================
(Binary files differ)


Property changes on: trunk/media/images/gui/button.xcf
___________________________________________________________________
Name: svn:mime-type
   + application/x-xcf

Added: trunk/media/images/gui/button2.xcf
===================================================================
(Binary files differ)


Property changes on: trunk/media/images/gui/button2.xcf
___________________________________________________________________
Name: svn:mime-type
   + application/x-xcf

Added: trunk/media/images/gui/dpad.xcf
===================================================================
(Binary files differ)


Property changes on: trunk/media/images/gui/dpad.xcf
___________________________________________________________________
Name: svn:mime-type
   + application/x-xcf

Added: trunk/media/images/gui/keyboardkey.png
===================================================================
(Binary files differ)


Property changes on: trunk/media/images/gui/keyboardkey.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/media/images/gui/keyboardkey_small.xcf
===================================================================
(Binary files differ)


Property changes on: trunk/media/images/gui/keyboardkey_small.xcf
___________________________________________________________________
Name: svn:mime-type
   + application/x-xcf

Added: trunk/media/images/gui/start_back.xcf
===================================================================
(Binary files differ)


Property changes on: trunk/media/images/gui/start_back.xcf
___________________________________________________________________
Name: svn:mime-type
   + application/x-xcf

Added: trunk/media/images/gui/trigger.xcf
===================================================================
(Binary files differ)


Property changes on: trunk/media/images/gui/trigger.xcf
___________________________________________________________________
Name: svn:mime-type
   + application/x-xcf

Added: trunk/media/images/gui/trigger2.xcf
===================================================================
(Binary files differ)


Property changes on: trunk/media/images/gui/trigger2.xcf
___________________________________________________________________
Name: svn:mime-type
   + application/x-xcf



From grumbel at mail.berlios.de  Fri Jun 15 03:32:36 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 15 Jun 2007 03:32:36 +0200
Subject: [Windstille-commit] r1430 - in trunk: . test
Message-ID: <200706150132.l5F1Wau7003485@sheep.berlios.de>

Author: grumbel
Date: 2007-06-15 03:32:36 +0200 (Fri, 15 Jun 2007)
New Revision: 1430

Added:
   trunk/test/
   trunk/test/README
   trunk/test/mygame.py
   trunk/test/rungame.py
Log:
- directory for random tests and experiments

Added: trunk/test/README
===================================================================
--- trunk/test/README	2007-06-14 19:59:52 UTC (rev 1429)
+++ trunk/test/README	2007-06-15 01:32:36 UTC (rev 1430)
@@ -0,0 +1 @@
+Numerous random test things

Added: trunk/test/mygame.py
===================================================================
--- trunk/test/mygame.py	2007-06-14 19:59:52 UTC (rev 1429)
+++ trunk/test/mygame.py	2007-06-15 01:32:36 UTC (rev 1430)
@@ -0,0 +1,43 @@
+def bezier(p0, p1, p2, p3, t):
+    return p0*(1-t)**3 + 3*p1*t*((1-t)**2) + 3*p2*(t**2)*(1-t) + p3*t**3
+               
+p0 = (10, 100)
+p1 = (10, 400)
+p2 = (400, 400)
+p3 = (400, 10)
+
+pygame.display.set_caption("Bezier Demo")
+while do_continue():   
+    for event in pygame.event.get():
+        if event.type == pygame.QUIT: sys.exit()
+        elif event.type == MOUSEBUTTONDOWN:
+            pressed = pygame.key.get_pressed()
+            if event.button == 1:
+                if pressed[K_SPACE]:
+                    p0 = event.pos
+                else:
+                    p1 = event.pos
+            elif event.button == 3:
+                if pressed[K_SPACE]:
+                    p3 = event.pos
+                else:
+                    p2 = event.pos
+
+    screen.fill((0,0,0))
+    pygame.draw.line(screen, (255, 0, 255), p0, p1, 3)
+    pygame.draw.line(screen, (0, 255, 0), p2, p3, 3)
+
+    last = None
+    for i in range(0, 101, 5):
+        t = i/100.0
+        bx = bezier(p0[0], p1[0], p2[0], p3[0], t)
+        by = bezier(p0[1], p1[1], p2[1], p3[1], t)
+
+        if last:
+            pygame.draw.line(screen, (255, 255, 255), last, (bx, by), 3)
+        last = (bx,by)
+
+    pygame.time.wait(100) 
+    pygame.display.flip()
+
+# EOF #

Added: trunk/test/rungame.py
===================================================================
--- trunk/test/rungame.py	2007-06-14 19:59:52 UTC (rev 1429)
+++ trunk/test/rungame.py	2007-06-15 01:32:36 UTC (rev 1430)
@@ -0,0 +1,53 @@
+#! /usr/bin/env python
+
+import os, sys
+import pygame
+import _fam
+from pygame.locals import *
+from threading import Thread
+from stat import *
+
+def do_continue():
+    global mtime, filename
+    new_mtime = os.stat(filename)[ST_MTIME]
+    if mtime != new_mtime:
+        mtime = new_mtime
+        return False
+    else:
+        return True
+
+def main(args):   
+    if len(args) != 1:
+        print "Usage rungame.py FILENAME"
+    else:
+        global filename, mtime, screen
+        
+        pygame.init()
+        screen   = pygame.display.set_mode((512,512))
+        filename = args[0]
+        mtime    = os.stat(filename)[ST_MTIME]
+
+        quit = False
+        while not quit:
+            try:
+                print "Restarting:", filename
+                execfile(filename)
+            except SyntaxError, err:
+                print "SyntaxError:", err                
+            except (KeyboardInterrupt, SystemExit):
+                print "Interrupt recieved, going to quit"
+                quit = True
+            except:
+                print "Unexpected error:", sys.exc_info()[0]
+                
+            pygame.time.wait(500)
+
+
+filename = None
+mtime    = None
+screen   = None
+
+if __name__ == "__main__":
+    main(sys.argv[1:])
+    
+# EOF #


Property changes on: trunk/test/rungame.py
___________________________________________________________________
Name: svn:executable
   + *



From grumbel at mail.berlios.de  Fri Jun 15 08:29:33 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 15 Jun 2007 08:29:33 +0200
Subject: [Windstille-commit] r1431 - trunk/windstille/data/images/controller
Message-ID: <200706150629.l5F6TX4s000964@sheep.berlios.de>

Author: grumbel
Date: 2007-06-15 08:29:32 +0200 (Fri, 15 Jun 2007)
New Revision: 1431

Added:
   trunk/windstille/data/images/controller/lb.png
   trunk/windstille/data/images/controller/lt.png
   trunk/windstille/data/images/controller/rb.png
   trunk/windstille/data/images/controller/rt.png
   trunk/windstille/data/images/controller/stick_l.png
   trunk/windstille/data/images/controller/stick_r.png
Log:
- some more images for the controller

Added: trunk/windstille/data/images/controller/lb.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/lb.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/images/controller/lt.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/lt.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/images/controller/rb.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/rb.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/images/controller/rt.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/rt.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/images/controller/stick_l.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/stick_l.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/windstille/data/images/controller/stick_r.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/controller/stick_r.png
___________________________________________________________________
Name: svn:mime-type
   + image/png



From grumbel at mail.berlios.de  Fri Jun 15 08:30:09 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 15 Jun 2007 08:30:09 +0200
Subject: [Windstille-commit] r1432 - in trunk/windstille/src: font gui input
	lisp math objects physfs signals sound sprite2d sprite3d tinygettext
Message-ID: <200706150630.l5F6U9Tq001042@sheep.berlios.de>

Author: grumbel
Date: 2007-06-15 08:30:08 +0200 (Fri, 15 Jun 2007)
New Revision: 1432

Modified:
   trunk/windstille/src/font/Jamfile
   trunk/windstille/src/gui/Jamfile
   trunk/windstille/src/input/Jamfile
   trunk/windstille/src/lisp/Jamfile
   trunk/windstille/src/math/Jamfile
   trunk/windstille/src/objects/Jamfile
   trunk/windstille/src/physfs/Jamfile
   trunk/windstille/src/signals/Jamfile
   trunk/windstille/src/sound/Jamfile
   trunk/windstille/src/sprite2d/Jamfile
   trunk/windstille/src/sprite3d/Jamfile
   trunk/windstille/src/tinygettext/Jamfile
Log:
- updated the Jamfiles a bit

Modified: trunk/windstille/src/font/Jamfile
===================================================================
--- trunk/windstille/src/font/Jamfile	2007-06-15 06:29:32 UTC (rev 1431)
+++ trunk/windstille/src/font/Jamfile	2007-06-15 06:30:08 UTC (rev 1432)
@@ -1,14 +1,6 @@
 SubDir TOP src font ;
 
-sources = 
-  border_font_effect.hpp
-  border_font_effect.cpp
-  font_effect.hpp
-  fonts.hpp
-  fonts.cpp
-  ttf_font.cpp
-  ttf_font.hpp
-;
+sources = [ Wildcard *.cpp *.hpp ] ;
 
 TRANSLATABLE_SOURCES = [ SearchSource $(sources) ] ;
 font_objects = [ CompileObjects $(sources) ] ;

Modified: trunk/windstille/src/gui/Jamfile
===================================================================
--- trunk/windstille/src/gui/Jamfile	2007-06-15 06:29:32 UTC (rev 1431)
+++ trunk/windstille/src/gui/Jamfile	2007-06-15 06:30:08 UTC (rev 1432)
@@ -1,37 +1,6 @@
 SubDir TOP src gui ;
 
-sources = 
-  automap.hpp
-  automap.cpp
-  button.hpp
-  button.cpp
-  component.hpp
-  component.cpp
-  component_factory.hpp
-  component_factory.cpp
-  grid_component.hpp
-  grid_component.cpp
-  group_component.hpp
-  group_component.cpp
-  gui_manager.hpp
-  gui_manager.cpp
-  label.cpp
-  label.hpp
-  list_view.hpp
-  list_view.cpp
-  menu_component.hpp
-  menu_component.cpp
-  menu_item.hpp
-  menu_item.cpp
-  root_component.cpp
-  root_component.hpp
-  slider.cpp
-  slider.hpp
-  tab_component.hpp
-  tab_component.cpp
-  text_view.hpp
-  text_view.cpp
-;
+sources = [ Wildcard *.cpp *.hpp ] ;
 
 TRANSLATABLE_SOURCES = [ SearchSource $(sources) ] ;
 gui_objects = [ CompileObjects $(sources) ] ;

Modified: trunk/windstille/src/input/Jamfile
===================================================================
--- trunk/windstille/src/input/Jamfile	2007-06-15 06:29:32 UTC (rev 1431)
+++ trunk/windstille/src/input/Jamfile	2007-06-15 06:30:08 UTC (rev 1432)
@@ -1,22 +1,7 @@
 SubDir TOP src input ;
 
-sources =
-    controller.cpp
-    controller.hpp
-    controller_description.cpp
-    controller_description.hpp
-    input_configurator.hpp
-    input_configurator.cpp
-    input_event.hpp
-    input_manager.cpp
-    input_manager.hpp
-    input_manager_impl.cpp
-    input_manager_impl.hpp
-    input_manager_sdl.cpp
-    input_manager_sdl.hpp
+sources = [ Wildcard *.cpp *.hpp ] ;
 
-;
-
 TRANSLATABLE_SOURCES += [ SearchSource $(sources) ] ;
 input_objects = [ CompileObjects $(sources) ] ;
 

Modified: trunk/windstille/src/lisp/Jamfile
===================================================================
--- trunk/windstille/src/lisp/Jamfile	2007-06-15 06:29:32 UTC (rev 1431)
+++ trunk/windstille/src/lisp/Jamfile	2007-06-15 06:30:08 UTC (rev 1432)
@@ -1,20 +1,6 @@
 SubDir TOP src lisp ;
 
-sources =
-  getters.hpp
-  getters.cpp
-  lexer.cpp
-  lexer.hpp
-  lisp.cpp
-  lisp.hpp
-  parser.cpp
-  parser.hpp
-  properties.cpp
-  properties.hpp
-  property_iterator.hpp
-  writer.cpp
-  writer.hpp
-;
+sources = [ Wildcard *.cpp *.hpp ] ;
 
 TRANSLATABLE_SOURCES += [ SearchSource $(sources) ] ;
 lisp_objects = [ CompileObjects $(sources) ] ;

Modified: trunk/windstille/src/math/Jamfile
===================================================================
--- trunk/windstille/src/math/Jamfile	2007-06-15 06:29:32 UTC (rev 1431)
+++ trunk/windstille/src/math/Jamfile	2007-06-15 06:30:08 UTC (rev 1432)
@@ -1,19 +1,6 @@
 SubDir TOP src math ;
 
-sources = matrix.hpp
-          matrix.cpp
-          origin.hpp
-          origin.cpp
-          point.hpp
-          quaternion.hpp
-          quaternion.cpp
-          rect.hpp
-          rect.cpp
-          size.hpp
-          vector.hpp
-          vector.cpp
-	  vector3.hpp
-;
+sources = [ Wildcard *.cpp *.hpp ] ;
 
 TRANSLATABLE_SOURCES = [ SearchSource $(sources) ] ;
 math_objects = [ CompileObjects $(sources) ] ;

Modified: trunk/windstille/src/objects/Jamfile
===================================================================
--- trunk/windstille/src/objects/Jamfile	2007-06-15 06:29:32 UTC (rev 1431)
+++ trunk/windstille/src/objects/Jamfile	2007-06-15 06:30:08 UTC (rev 1432)
@@ -1,25 +1,6 @@
 SubDir TOP src objects ;
 
-sources =
-  background_gradient.cpp
-  background_gradient.hpp
-  bomb.cpp
-  bomb.hpp
-  hedgehog.cpp
-  hedgehog.hpp
-  nightvision.cpp
-  nightvision.hpp
-  shockwave.cpp
-  shockwave.hpp
-  spider_mine.cpp
-  spider_mine.hpp
-  swarm.cpp
-  swarm.hpp
-  test_object.cpp
-  test_object.hpp
-  vrdummy.cpp
-  vrdummy.hpp
-;
+sources = [ Wildcard *.cpp *.hpp ] ;
 
 TRANSLATABLE_SOURCES += [ SearchSource $(sources) ] ;
 objects_objects = [ CompileObjects $(sources) ] ;

Modified: trunk/windstille/src/physfs/Jamfile
===================================================================
--- trunk/windstille/src/physfs/Jamfile	2007-06-15 06:29:32 UTC (rev 1431)
+++ trunk/windstille/src/physfs/Jamfile	2007-06-15 06:30:08 UTC (rev 1432)
@@ -1,11 +1,6 @@
 SubDir TOP src physfs ;
 
-sources = 
-    physfs_sdl.cpp
-    physfs_sdl.hpp
-    physfs_stream.cpp
-    physfs_stream.hpp
-;
+sources = [ Wildcard *.cpp *.hpp ] ;
 
 TRANSLATABLE_SOURCES += [ SearchSource $(sources) ] ;
 physfs_objects = [ CompileObjects $(sources) ] ;

Modified: trunk/windstille/src/signals/Jamfile
===================================================================
--- trunk/windstille/src/signals/Jamfile	2007-06-15 06:29:32 UTC (rev 1431)
+++ trunk/windstille/src/signals/Jamfile	2007-06-15 06:30:08 UTC (rev 1432)
@@ -1,26 +1,6 @@
 SubDir TOP src signals ;
 
-sources = signal.hpp
-	  signal_v0.hpp
-	  signal_v1.hpp
-	  signal_v2.hpp
-	  signal_v3.hpp
-	  signal_v4.hpp
-	  signal_v5.hpp
-	  signals.hpp
-	  slot.cpp
-	  slot.hpp
-	  slot_generic.cpp
-	  slot_generic.hpp
-	  slot_v0.hpp
-	  slot_v1.hpp
-	  slot_v2.hpp
-	  slot_v3.hpp
-	  slot_v4.hpp
-	  slot_v5.hpp
-	  slotbuffer_v0.hpp
-	  slotbuffer_v1.hpp
-;
+sources = [ Wildcard *.cpp *.hpp ] ;
 
 TRANSLATABLE_SOURCES = [ SearchSource $(sources) ] ;
 signals_objects = [ CompileObjects $(sources) ] ;

Modified: trunk/windstille/src/sound/Jamfile
===================================================================
--- trunk/windstille/src/sound/Jamfile	2007-06-15 06:29:32 UTC (rev 1431)
+++ trunk/windstille/src/sound/Jamfile	2007-06-15 06:30:08 UTC (rev 1432)
@@ -1,15 +1,6 @@
 SubDir TOP src sound ;
 
-sources =
-    sound_file.cpp
-    sound_file.hpp
-    sound_manager.cpp
-    sound_manager.hpp
-    sound_source.cpp
-    sound_source.hpp
-    stream_sound_source.cpp
-    stream_sound_source.hpp
-;
+sources = [ Wildcard *.cpp *.hpp ] ;
 
 TRANSLATABLE_SOURCES += [ SearchSource $(sources) ] ;
 sound_objects = [ CompileObjects $(sources) ] ;

Modified: trunk/windstille/src/sprite2d/Jamfile
===================================================================
--- trunk/windstille/src/sprite2d/Jamfile	2007-06-15 06:29:32 UTC (rev 1431)
+++ trunk/windstille/src/sprite2d/Jamfile	2007-06-15 06:30:08 UTC (rev 1432)
@@ -1,13 +1,6 @@
 SubDir TOP src sprite2d ;
 
-sources =
-    data.cpp
-    data.hpp
-    manager.cpp
-    manager.hpp
-    sprite.cpp
-    sprite.hpp
-;
+sources = [ Wildcard *.cpp *.hpp ] ;
 
 TRANSLATABLE_SOURCES += [ SearchSource $(sources) ] ;
 sprite2d_objects = [ CompileObjects $(sources) ] ;

Modified: trunk/windstille/src/sprite3d/Jamfile
===================================================================
--- trunk/windstille/src/sprite3d/Jamfile	2007-06-15 06:29:32 UTC (rev 1431)
+++ trunk/windstille/src/sprite3d/Jamfile	2007-06-15 06:30:08 UTC (rev 1432)
@@ -1,13 +1,6 @@
 SubDir TOP src sprite3d ;
 
-sources =
-  data.cpp
-  data.hpp
-  manager.cpp
-  manager.hpp
-  sprite3d.cpp
-  sprite3d.hpp
-;
+sources = [ Wildcard *.cpp *.hpp ] ;
 
 TRANSLATABLE_SOURCES += [ SearchSource $(sources) ] ;
 sprite3d_objects = [ CompileObjects $(sources) ] ;

Modified: trunk/windstille/src/tinygettext/Jamfile
===================================================================
--- trunk/windstille/src/tinygettext/Jamfile	2007-06-15 06:29:32 UTC (rev 1431)
+++ trunk/windstille/src/tinygettext/Jamfile	2007-06-15 06:30:08 UTC (rev 1432)
@@ -1,11 +1,6 @@
 SubDir TOP src tinygettext ;
 
-sources =
-    tinygettext.cpp
-    tinygettext.hpp
-    gettext.cpp
-    gettext.hpp
-;
+sources = [ Wildcard *.cpp *.hpp ] ;
 
 TRANSLATABLE_SOURCES += [ SearchSource $(sources) ] ;
 tinygettext_objects = [ CompileObjects $(sources) ] ;



From grumbel at mail.berlios.de  Fri Jun 15 08:30:45 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 15 Jun 2007 08:30:45 +0200
Subject: [Windstille-commit] r1433 - trunk/windstille/src/input
Message-ID: <200706150630.l5F6UjNE001085@sheep.berlios.de>

Author: grumbel
Date: 2007-06-15 08:30:45 +0200 (Fri, 15 Jun 2007)
New Revision: 1433

Modified:
   trunk/windstille/src/input/input_manager_impl.cpp
   trunk/windstille/src/input/input_manager_sdl.cpp
Log:
- added hard coded deadzone

Modified: trunk/windstille/src/input/input_manager_impl.cpp
===================================================================
--- trunk/windstille/src/input/input_manager_impl.cpp	2007-06-15 06:30:08 UTC (rev 1432)
+++ trunk/windstille/src/input/input_manager_impl.cpp	2007-06-15 06:30:45 UTC (rev 1433)
@@ -23,11 +23,16 @@
 **  02111-1307, USA.
 */
 
+#include <math.h>
 #include "input_manager_impl.hpp"
 
 void
 InputManagerImpl::add_axis_event(int name, float pos)
 {
+  // FIXME: Hardcoding a deadzone might not be a good idea
+  if (fabsf(pos) < 0.125f)
+    pos = 0;
+
   InputEvent event;
   event.type = AXIS_EVENT;
   event.axis.name = name;

Modified: trunk/windstille/src/input/input_manager_sdl.cpp
===================================================================
--- trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-15 06:30:08 UTC (rev 1432)
+++ trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-15 06:30:45 UTC (rev 1433)
@@ -180,8 +180,12 @@
 {
   current_ = this;
 
-  for (int i = 0; i < SDLK_LAST; ++i)
-    impl->keyidmapping[SDL_GetKeyName(static_cast<SDLKey>(i))] = static_cast<SDLKey>(i);
+  for (int i = 0; i < SDLK_LAST; ++i) {
+    char* key_name = SDL_GetKeyName(static_cast<SDLKey>(i));
+    impl->keyidmapping[key_name] = static_cast<SDLKey>(i);
+    // FIXME: Make the keynames somewhere user visible so that users can use them
+    // std::cout << key_name << std::endl;
+  }
 
   parse_config(lisp);
 }



From grumbel at mail.berlios.de  Fri Jun 15 08:31:50 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 15 Jun 2007 08:31:50 +0200
Subject: [Windstille-commit] r1434 - in trunk/windstille: . data/controller
	src src/math src/navigation
Message-ID: <200706150631.l5F6VoNR001197@sheep.berlios.de>

Author: grumbel
Date: 2007-06-15 08:31:49 +0200 (Fri, 15 Jun 2007)
New Revision: 1434

Added:
   trunk/windstille/src/math/line.cpp
   trunk/windstille/src/math/line.hpp
   trunk/windstille/src/navigation/
   trunk/windstille/src/navigation/connection.cpp
   trunk/windstille/src/navigation/connection.hpp
   trunk/windstille/src/navigation/navigation_graph.cpp
   trunk/windstille/src/navigation/navigation_graph.hpp
   trunk/windstille/src/navigation/node.cpp
   trunk/windstille/src/navigation/node.hpp
   trunk/windstille/src/navigation/properties.cpp
   trunk/windstille/src/navigation/properties.hpp
   trunk/windstille/src/navigation/segment.cpp
   trunk/windstille/src/navigation/segment.hpp
Modified:
   trunk/windstille/INSTALL
   trunk/windstille/NEWS
   trunk/windstille/TODO
   trunk/windstille/data/controller/keyboard.scm
   trunk/windstille/src/SConscript
   trunk/windstille/src/controller_def.hpp
   trunk/windstille/src/conversation.cpp
   trunk/windstille/src/game_session.cpp
   trunk/windstille/src/sprite3dview.cpp
   trunk/windstille/src/view.cpp
   trunk/windstille/src/view.hpp
   trunk/windstille/src/windstille_main.cpp
Log:
- some framework for new collision/naviagtion stuff
- more xbox360 pad mappings

Modified: trunk/windstille/INSTALL
===================================================================
--- trunk/windstille/INSTALL	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/INSTALL	2007-06-15 06:31:49 UTC (rev 1434)
@@ -23,4 +23,8 @@
 
  $ ./windstille
 
+Compile on FreeBSD:
+
+<AnMaster> CPPFLAGS="-I/usr/local/include -D_SQ64" CXXFLAGS="-DICONV_CONST=const" LDFLAGS="-lpng -L/usr/local/lib" ./configure --prefix=$HOME/test --with-ogg=/usr/local --with-libOpenAL=/usr/local --with-libphysfs=/usr/local
+
 # EOF #

Modified: trunk/windstille/NEWS
===================================================================
--- trunk/windstille/NEWS	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/NEWS	2007-06-15 06:31:49 UTC (rev 1434)
@@ -1,3 +1,8 @@
+Windstille 0.3.1
+================
+ - fixed crash when sound is disabled
+ - more solid gamepad support
+
 Windstille 0.3.0
 ================
  - near complete rewrite of the engine

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/TODO	2007-06-15 06:31:49 UTC (rev 1434)
@@ -1,3 +1,4 @@
+- implement proper dead-zone in input handling
 - shrink textures: a lot!
 - collision detection
 - virtual tiles in the editor

Modified: trunk/windstille/data/controller/keyboard.scm
===================================================================
--- trunk/windstille/data/controller/keyboard.scm	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/data/controller/keyboard.scm	2007-06-15 06:31:49 UTC (rev 1434)
@@ -9,39 +9,56 @@
   (joystick-axis (device 0)  (axis 1)))
  
  (x2-axis
-  (keyboard-axis (minus "left") (plus "right"))
-  (joystick-axis (device 0)  (axis 3)))
+  (keyboard-axis (minus "[4]") (plus "[6]"))
+  (joystick-axis (device 0)  (axis 4)))
 
  (y2-axis
-  (keyboard-axis (minus "c") (plus "t"))
-  (joystick-axis (device 0)  (axis 4)))
+  (keyboard-axis (minus "[2]") (plus "[8]"))
+  (joystick-axis (device 0)  (axis 3)))
 
+ (view-center-button
+  (keyboard-button (key "[5]"))
+  (joystick-button (device 0)  (button 9)))
+
  (primary-button
   (keyboard-button (key "s"))
-  (joystick-button (device 0)  (button 2)))
+  (joystick-button (device 0)  (button 0)))
 
  (secondary-button
   (keyboard-button (key "d"))
-  (joystick-button (device 0)  (button 3)))
+  (joystick-button (device 0)  (button 1)))
 
  (tertiary-button
   (keyboard-button (key "a"))
-  (joystick-button (device 0)  (button 1)))
+  (joystick-button (device 0)  (button 3)))
 
  (pda-button
   (keyboard-button (key "w"))
-  (joystick-button (device 0)  (button 0)))
+  (joystick-button (device 0)  (button 2)))
 
  (aim-button
   (keyboard-button (key "k"))
-  (joystick-button (device 0)  (button 7)))
+  (joystick-button (device 0)  (button 5)))
  
  (pause-button
   (keyboard-button (key "p"))
-  (joystick-button (device 0)  (button 9)))
+  (joystick-button (device 0)  (button 6)))
 
  (inventory-button
-  (keyboard-button (key "e")))
+  (keyboard-button (key "e"))
+  (joystick-button (device 0)  (button 14)))
+
+ (menu-up-button
+  (joystick-button (device 0)  (button 10)))
+
+ (menu-down-button
+  (joystick-button (device 0)  (button 11)))
+
+ (menu-left-button
+  (joystick-button (device 0)  (button 12)))
+
+ (menu-right-button
+  (joystick-button (device 0)  (button 13)))
  )
 
 ;; EOF ;;

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/SConscript	2007-06-15 06:31:49 UTC (rev 1434)
@@ -150,11 +150,17 @@
 'lisp/parser.cpp',
 'lisp/properties.cpp',
 'lisp/writer.cpp',
+'navigation/connection.cpp',
+'navigation/navigation_graph.cpp',
+'navigation/node.cpp',
+'navigation/segment.cpp',
+'navigation/properties.cpp',
 'math/matrix.cpp',
 'math/origin.cpp',
 'math/quaternion.cpp',
 'math/rect.cpp',
 'math/vector.cpp',
+'math/line.cpp',
 'menu_manager.cpp',
 'particle_viewer.cpp',
 'particles/particle_system.cpp',

Modified: trunk/windstille/src/controller_def.hpp
===================================================================
--- trunk/windstille/src/controller_def.hpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/controller_def.hpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -41,6 +41,8 @@
 
     X2_AXIS,
     Y2_AXIS, 
+    
+    VIEW_CENTER_BUTTON,
 
     PRIMARY_BUTTON,   // used to ok a dialog or for running
     SECONDARY_BUTTON, // used to cancel a dialog or for jumping

Modified: trunk/windstille/src/conversation.cpp
===================================================================
--- trunk/windstille/src/conversation.cpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/conversation.cpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -87,40 +87,27 @@
   if (!active)
     return;
 
-  const InputEventLst& events = controller.get_events();
-
-  for(InputEventLst::const_iterator i = events.begin(); i != events.end(); ++i)
+  if (controller.button_was_pressed(MENU_UP_BUTTON))
     {
-      if (i->type == AXIS_EVENT && i->axis.name == Y_AXIS)
-        {
-          if (i->axis.pos > 0)
-            {
-              selection -= 1;
-              if (selection < 0)
-                selection = choices.size() - 1;
-            }
-          else if (i->axis.pos < 0)
-            {        
-              selection += 1;
-              if (selection >= int(choices.size()))
-                selection = 0;
-            }
-        }
-      else if (i->type == BUTTON_EVENT && i->button.down)
-        {
-          switch (i->button.name)
-            {
-            case OK_BUTTON:
-              active = false;
-              GameSession::current()->get_pda().add_dialog("Jane", choices[selection]);
-              choices.clear();
-              GameSession::current()->set_control_state(GameSession::GAME);
-              script_manager->fire_wakeup_event(ScriptManager::CONVERSATION_CLOSED);
-              return;
-              break;
-            }
-        }
+      selection -= 1;
+      if (selection < 0)
+        selection = choices.size() - 1;
     }
+  else if (controller.button_was_pressed(MENU_DOWN_BUTTON))
+    {
+      selection += 1;
+      if (selection >= int(choices.size()))
+        selection = 0;
+    }
+  
+  if (controller.button_was_pressed(OK_BUTTON))
+    {
+      active = false;
+      GameSession::current()->get_pda().add_dialog("Jane", choices[selection]);
+      choices.clear();
+      GameSession::current()->set_control_state(GameSession::GAME);
+      script_manager->fire_wakeup_event(ScriptManager::CONVERSATION_CLOSED);
+    }
 }
 
 int

Modified: trunk/windstille/src/game_session.cpp
===================================================================
--- trunk/windstille/src/game_session.cpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/game_session.cpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -217,7 +217,7 @@
       game_time += delta;
       script_manager->update();
       
-      view.update(delta);
+      view.update(delta, controller);
       sector->update(delta);
   
       switch (fade_state)

Added: trunk/windstille/src/math/line.cpp
===================================================================
--- trunk/windstille/src/math/line.cpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/math/line.cpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -0,0 +1,40 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include "line.hpp"
+
+Line::Line(const Vector& p1_,
+           const Vector& p2_)
+  : p1(p1_), p2(p2_)
+{
+}
+
+float
+Line::length() const
+{
+  return (p2 - p1).length();
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/math/line.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/math/line.hpp
===================================================================
--- trunk/windstille/src/math/line.hpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/math/line.hpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -0,0 +1,57 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_LINE_HPP
+#define HEADER_LINE_HPP
+
+#include "math/vector.hpp"
+
+/** */
+class Line
+{
+private:
+public:
+  Vector p1;
+  Vector p2;
+
+  Line(const Vector& p1,
+       const Vector& p2);  
+  
+  float length() const;
+
+  /** Calculate if and where two lines collide */
+  bool collide(const Line& line, float& a, float& b);
+
+  /** Calculate if and where two lines collide */
+  bool collide(const Line& line, Vector& colpos);
+
+private:
+  Line (const Line&);
+  Line& operator= (const Line&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/math/line.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/navigation/connection.cpp
===================================================================
--- trunk/windstille/src/navigation/connection.cpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/navigation/connection.cpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -0,0 +1,30 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include "connection.hpp"
+
+
+
+/* EOF */


Property changes on: trunk/windstille/src/navigation/connection.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/navigation/connection.hpp
===================================================================
--- trunk/windstille/src/navigation/connection.hpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/navigation/connection.hpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -0,0 +1,67 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_CONNECTION_HPP
+#define HEADER_CONNECTION_HPP
+
+class Segment;
+class Node;
+
+/** 
+ */
+class Connection
+{
+public:
+  Segment* segment;
+
+  /** Position on the segment, stored with range [0,1], not
+      world-co */
+  float pos;
+
+  /** Move forward \a adv of units in world-co 
+   *  @return The amount of units left when hitting the end of the segment or 0.0f 
+   */
+  float advance_this_segment(float adv);
+
+public:
+  /** Move forward \a adv of units in world-co, automatically jump
+   * across segments, unless a end node is hit
+   *
+   * @param adv in: the amount of advancment to be done, out: the
+   * amount of units that wheren't use on the given segment
+   * @param next_segment out: the next segment get written into this
+   *
+   *  @return The amount of units left when hitting the end of the segment or 0.0f 
+   */
+  float advance(float& adv, Node** next_node);
+  
+private:
+  Connection (const Connection&);
+  Connection& operator= (const Connection&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/navigation/connection.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/navigation/navigation_graph.cpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -0,0 +1,30 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include "navigation_graph.hpp"
+
+
+
+/* EOF */


Property changes on: trunk/windstille/src/navigation/navigation_graph.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/navigation/navigation_graph.hpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -0,0 +1,64 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_NAVIGATION_GRAPH_HPP
+#define HEADER_NAVIGATION_GRAPH_HPP
+
+#include <vector>
+#include "math/line.hpp"
+
+class Node;
+class Segment;
+
+/** */
+class NavigationGraph
+{
+private:
+  std::vector<Node*>    nodes;
+  std::vector<Segment*> segments;
+
+  // insert some spartial thingy here
+
+public:
+  NavigationGraph();
+  ~NavigationGraph();
+
+  /** Find segments that collide with the given line */
+  std::vector<Segment*> find_segments(const Line& line);
+
+  /** Find nodes that are near the given point */
+  std::vector<Node*> find_nodes(const Vector& pos, float radius);
+
+  /** Find segments that are near the given point */
+  std::vector<Segment*> find_segments(const Vector& pos, float radius);
+
+private:
+  NavigationGraph (const NavigationGraph&);
+  NavigationGraph& operator= (const NavigationGraph&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/navigation/navigation_graph.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/navigation/node.cpp
===================================================================
--- trunk/windstille/src/navigation/node.cpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/navigation/node.cpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -0,0 +1,30 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include "node.hpp"
+
+
+
+/* EOF */


Property changes on: trunk/windstille/src/navigation/node.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/navigation/node.hpp
===================================================================
--- trunk/windstille/src/navigation/node.hpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/navigation/node.hpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -0,0 +1,54 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_NAVIGATION_NODE_HPP
+#define HEADER_NAVIGATION_NODE_HPP
+
+#include <vector>
+#include "math/vector.hpp"
+
+class Segment;
+
+/** */
+class Node
+{
+private:
+  int    id;
+  Vector pos;
+  
+  /** Segments connected to this node */
+  std::vector<Segment*> segments;
+
+public:
+  Node();
+
+private:
+  Node(const Node&);
+  Node& operator=(const Node&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/navigation/node.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/navigation/properties.cpp
===================================================================
--- trunk/windstille/src/navigation/properties.cpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/navigation/properties.cpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -0,0 +1,30 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include "properties.hpp"
+
+
+
+/* EOF */


Property changes on: trunk/windstille/src/navigation/properties.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/navigation/properties.hpp
===================================================================
--- trunk/windstille/src/navigation/properties.hpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/navigation/properties.hpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -0,0 +1,42 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_COLLISION_PROPERTIES_HPP
+#define HEADER_COLLISION_PROPERTIES_HPP
+
+#include <inttypes.h>
+
+enum {
+  WALKABLE = (1<<0),
+  WALL     = (1<<1),
+  LADDER   = (1<<2),
+  STAIRS   = (1<<2),
+};
+
+typedef uint32_t Properties;
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/navigation/properties.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/navigation/segment.cpp
===================================================================
--- trunk/windstille/src/navigation/segment.cpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/navigation/segment.cpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -0,0 +1,30 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include "segment.hpp"
+
+
+
+/* EOF */


Property changes on: trunk/windstille/src/navigation/segment.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/navigation/segment.hpp
===================================================================
--- trunk/windstille/src/navigation/segment.hpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/navigation/segment.hpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -0,0 +1,54 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_SEGMENT_HPP
+#define HEADER_SEGMENT_HPP
+
+class Node;
+
+#include "properties.hpp"
+
+/** */
+class Segment
+{
+private:
+  Node* node1;
+  Node* node2;
+  
+  Properties props;
+
+public:
+
+  /** Calculate the angle between two segments */
+  float angle(Segment* seg);
+  
+private:
+  Segment (const Segment&);
+  Segment& operator= (const Segment&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/navigation/segment.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/sprite3dview.cpp
===================================================================
--- trunk/windstille/src/sprite3dview.cpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/sprite3dview.cpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -141,8 +141,8 @@
       sprite.set_action(actions[current_action]);
     }
 
-  rotx += controller.get_axis_state(X2_AXIS) * 50.0f * delta;
-  roty += controller.get_axis_state(Y2_AXIS) * 50.0f * delta;
+  rotx += controller.get_axis_state(Y2_AXIS) * 50.0f * delta;
+  roty += controller.get_axis_state(X2_AXIS) * 50.0f * delta;
 
   if (controller.button_was_pressed(ESCAPE_BUTTON) ||
       controller.button_was_pressed(CANCEL_BUTTON))

Modified: trunk/windstille/src/view.cpp
===================================================================
--- trunk/windstille/src/view.cpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/view.cpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -62,7 +62,7 @@
 }
 
 void
-View::update (float delta)
+View::update (float delta, const Controller& controller)
 {
   camera.update(delta);
 
@@ -73,18 +73,13 @@
   if (keystate[SDLK_KP_MINUS])
     zoom *= 1.0 - delta;
 
-  if(keystate[SDLK_KP2])
-    transform.y += delta * 200 / zoom;
-  if(keystate[SDLK_KP8])
-    transform.y -= delta * 200 / zoom;
-  if(keystate[SDLK_KP4])
-    transform.x -= delta * 200 / zoom;
-  if(keystate[SDLK_KP6])
-    transform.x += delta * 200 / zoom;
-  if(keystate[SDLK_KP5]){
-    transform = Vector(0, 0);
-    zoom = 1.0;
+  if(controller.get_button_state(VIEW_CENTER_BUTTON)) {
+      transform = Vector(0, 0);
+      zoom = 1.0;
   }
+
+  transform.x += 0.5f * controller.get_axis_state(X2_AXIS) / zoom;
+  transform.y -= 0.5f * controller.get_axis_state(Y2_AXIS) / zoom;
 }
 
 Rectf

Modified: trunk/windstille/src/view.hpp
===================================================================
--- trunk/windstille/src/view.hpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/view.hpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -30,6 +30,7 @@
 #include "graphic_context_state.hpp"
 #include "math/vector.hpp"
 
+class Controller;
 class SceneContext;
 
 /** This class is the gui component which renders the world to the
@@ -55,7 +56,7 @@
   Vector screen_to_world(const Vector& point);
 
   void draw(SceneContext& gc);
-  void update(float delta);
+  void update(float delta, const Controller& controller);
 
   static View* current() { return current_; }
 

Modified: trunk/windstille/src/windstille_main.cpp
===================================================================
--- trunk/windstille/src/windstille_main.cpp	2007-06-15 06:30:45 UTC (rev 1433)
+++ trunk/windstille/src/windstille_main.cpp	2007-06-15 06:31:49 UTC (rev 1434)
@@ -90,6 +90,8 @@
       controller_description.add_button("menu-left-button",  MENU_LEFT_BUTTON);
       controller_description.add_button("menu-right-button",  MENU_RIGHT_BUTTON);
   
+      controller_description.add_button("view-center-button", VIEW_CENTER_BUTTON);
+
       controller_description.add_button("pda-button", PDA_BUTTON);
       controller_description.add_button("inventory-button", INVENTORY_BUTTON);
 



From grumbel at mail.berlios.de  Fri Jun 15 08:39:51 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 15 Jun 2007 08:39:51 +0200
Subject: [Windstille-commit] r1435 - in trunk/media: . images/artwork
	images/artwork/misc images/misc images/objects
	models/characters/jane models/objects/surveillancerobot
	models/vehicles models/vehicles/artillery
	models/vehicles/battleship models/vehicles/cleansweep
	models/vehicles/jeep models/vehicles/mech
	models/vehicles/rocketlauncher models/vehicles/troopshuttle
	models/vehicles/truck2
Message-ID: <200706150639.l5F6dpge001870@sheep.berlios.de>

Author: grumbel
Date: 2007-06-15 08:38:21 +0200 (Fri, 15 Jun 2007)
New Revision: 1435

Added:
   trunk/media/images/artwork/misc/pod.jpg
   trunk/media/images/artwork/titlescreen.xcf
Removed:
   trunk/media/images/misc/car.xcf
   trunk/media/images/misc/policecar.xcf
Modified:
   trunk/media/README
   trunk/media/images/artwork/misc/starter.png
   trunk/media/images/objects/blackboard.xcf
   trunk/media/models/characters/jane/body.blend
   trunk/media/models/characters/jane/face2.png
   trunk/media/models/characters/jane/face2.xcf
   trunk/media/models/objects/surveillancerobot/
   trunk/media/models/vehicles/
   trunk/media/models/vehicles/artillery/
   trunk/media/models/vehicles/battleship/
   trunk/media/models/vehicles/cleansweep/
   trunk/media/models/vehicles/jeep/
   trunk/media/models/vehicles/mech/
   trunk/media/models/vehicles/rocketlauncher/
   trunk/media/models/vehicles/troopshuttle/troopshuttle.blend
   trunk/media/models/vehicles/truck2/
Log:
- Misc updates

Modified: trunk/media/README
===================================================================
--- trunk/media/README	2007-06-15 06:31:49 UTC (rev 1434)
+++ trunk/media/README	2007-06-15 06:38:21 UTC (rev 1435)
@@ -1,11 +1,14 @@
 Windstille SVN Directory Structure Overview
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
-artwork/
- - misc artworks of the world of Windstille 
+images/
+ - misc images for use in Windstille 
 
 models/
  - Blender 3d models and their textures
  
+music/
+ - music for use in Windstille, source files when available (FLAC, .rg, etc)
+
 ________________________________________________________________________
 $Id: README 1296 2007-01-02 19:42:58Z grumbel $

Added: trunk/media/images/artwork/misc/pod.jpg
===================================================================
(Binary files differ)


Property changes on: trunk/media/images/artwork/misc/pod.jpg
___________________________________________________________________
Name: svn:mime-type
   + image/jpeg

Modified: trunk/media/images/artwork/misc/starter.png
===================================================================
(Binary files differ)

Added: trunk/media/images/artwork/titlescreen.xcf
===================================================================
(Binary files differ)


Property changes on: trunk/media/images/artwork/titlescreen.xcf
___________________________________________________________________
Name: svn:mime-type
   + application/x-xcf

Deleted: trunk/media/images/misc/car.xcf
===================================================================
(Binary files differ)

Deleted: trunk/media/images/misc/policecar.xcf
===================================================================
(Binary files differ)

Modified: trunk/media/images/objects/blackboard.xcf
===================================================================
(Binary files differ)

Modified: trunk/media/models/characters/jane/body.blend
===================================================================
(Binary files differ)

Modified: trunk/media/models/characters/jane/face2.png
===================================================================
(Binary files differ)

Modified: trunk/media/models/characters/jane/face2.xcf
===================================================================
(Binary files differ)


Property changes on: trunk/media/models/objects/surveillancerobot
___________________________________________________________________
Name: svn:ignore
   + .
*.blend[1-9]



Property changes on: trunk/media/models/vehicles
___________________________________________________________________
Name: svn:ignore
   - *.blend[1-9]
render/
old/

   + 


From grumbel at mail.berlios.de  Fri Jun 15 08:40:08 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 15 Jun 2007 08:40:08 +0200
Subject: [Windstille-commit] r1436 - trunk/test
Message-ID: <200706150640.l5F6e8Ub001928@sheep.berlios.de>

Author: grumbel
Date: 2007-06-15 08:40:08 +0200 (Fri, 15 Jun 2007)
New Revision: 1436

Added:
   trunk/test/SConstruct
   trunk/test/classtest.nut
   trunk/test/scopetest.nut
   trunk/test/vargtest.nut
Log:
- misc stuff

Added: trunk/test/SConstruct
===================================================================
--- trunk/test/SConstruct	2007-06-15 06:38:21 UTC (rev 1435)
+++ trunk/test/SConstruct	2007-06-15 06:40:08 UTC (rev 1436)
@@ -0,0 +1,3 @@
+Program('signals', ['signals.cpp'], CXXFLAGS="-O2 -Wall -ansi -pedantic", LIBS="boost_signals-st")
+
+# EOF #

Added: trunk/test/classtest.nut
===================================================================
--- trunk/test/classtest.nut	2007-06-15 06:38:21 UTC (rev 1435)
+++ trunk/test/classtest.nut	2007-06-15 06:40:08 UTC (rev 1436)
@@ -0,0 +1,16 @@
+class HelloWorld {
+  constructor() {
+    test <- "HelloWorld";
+  }
+  
+  function print() {
+    ::print(test);
+  }
+  
+};
+
+print("--------------------");
+a <- HelloWorld();
+a.print();
+
+/* EOF */

Added: trunk/test/scopetest.nut
===================================================================
--- trunk/test/scopetest.nut	2007-06-15 06:38:21 UTC (rev 1435)
+++ trunk/test/scopetest.nut	2007-06-15 06:40:08 UTC (rev 1436)
@@ -0,0 +1,12 @@
+function scopetest() {
+  {
+    local a = 5;
+    b <- 5;
+  }
+  // print(a + "\n");
+  print(b + "\n");
+}
+
+scopetest();
+
+/* EOF */

Added: trunk/test/vargtest.nut
===================================================================
--- trunk/test/vargtest.nut	2007-06-15 06:38:21 UTC (rev 1435)
+++ trunk/test/vargtest.nut	2007-06-15 06:40:08 UTC (rev 1436)
@@ -0,0 +1,14 @@
+function varg_test(...) {
+  print("Number of arguments: " + vargc + "\n");
+  //for(local i = 0; i < vargc; ++i) {
+  print(vargv);
+}
+
+varg_test("Hello World", 3, 5 ,6);
+quit();
+
+/* EOF */
+
+
+
+



From grumbel at mail.berlios.de  Fri Jun 15 19:13:28 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 15 Jun 2007 19:13:28 +0200
Subject: [Windstille-commit] r1437 - in trunk/windstille/src: . display math
Message-ID: <200706151713.l5FHDSkZ030094@sheep.berlios.de>

Author: grumbel
Date: 2007-06-15 19:13:26 +0200 (Fri, 15 Jun 2007)
New Revision: 1437

Added:
   trunk/windstille/src/geometry_test.cpp
   trunk/windstille/src/geometry_test.hpp
Modified:
   trunk/windstille/src/SConscript
   trunk/windstille/src/display/display.cpp
   trunk/windstille/src/display/display.hpp
   trunk/windstille/src/math/line.cpp
   trunk/windstille/src/math/line.hpp
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/menu_manager.hpp
Log:
- added some line intersection code and some code to test it

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-15 06:40:08 UTC (rev 1436)
+++ trunk/windstille/src/SConscript	2007-06-15 17:13:26 UTC (rev 1437)
@@ -60,6 +60,7 @@
 'game_object.cpp',
 'game_session.cpp',
 'globals.cpp',
+'geometry_test.cpp',
 'graphic_context_state.cpp',
 'grenade.cpp',
 'inventory.cpp',

Modified: trunk/windstille/src/display/display.cpp
===================================================================
--- trunk/windstille/src/display/display.cpp	2007-06-15 06:40:08 UTC (rev 1436)
+++ trunk/windstille/src/display/display.cpp	2007-06-15 17:13:26 UTC (rev 1437)
@@ -42,6 +42,12 @@
 std::vector<Framebuffer> framebuffers;
 
 void
+Display::draw_line(const Line& line, const Color& color)
+{
+  draw_line(line.p1, line.p2, color);
+}
+
+void
 Display::draw_line(const Vector& pos1, const Vector& pos2, const Color& color)
 {
   OpenGLState state;

Modified: trunk/windstille/src/display/display.hpp
===================================================================
--- trunk/windstille/src/display/display.hpp	2007-06-15 06:40:08 UTC (rev 1436)
+++ trunk/windstille/src/display/display.hpp	2007-06-15 17:13:26 UTC (rev 1437)
@@ -29,6 +29,7 @@
 #include <vector>
 #include <SDL.h>
 #include "math/rect.hpp"
+#include "math/line.hpp"
 #include "color.hpp"
 #include "display/framebuffer.hpp"
 
@@ -45,6 +46,7 @@
   static void fill_rounded_rect(const Rectf& rect, float radius, const Color& color);
   static void draw_rounded_rect(const Rectf& rect, float radius, const Color& color);
 
+  static void draw_line(const Line& line, const Color& color);
   static void draw_line(const Vector& pos1, const Vector& pos2, const Color& color);
 
   static void draw_circle(const Vector& pos, float radius, const Color& color);

Added: trunk/windstille/src/geometry_test.cpp
===================================================================
--- trunk/windstille/src/geometry_test.cpp	2007-06-15 06:40:08 UTC (rev 1436)
+++ trunk/windstille/src/geometry_test.cpp	2007-06-15 17:13:26 UTC (rev 1437)
@@ -0,0 +1,113 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include <GL/glew.h>
+#include <GL/gl.h>
+#include "geometry_test.hpp"
+#include "math/rect.hpp"
+#include "console.hpp"
+#include "math/size.hpp"
+#include "controller_def.hpp"
+#include "input/controller.hpp"
+#include "display/display.hpp"
+
+GeometryTest::GeometryTest()
+{
+  cursor = Vector(400, 300);
+  point_count = 0;
+  had_prev_collision = true;
+}
+
+void
+GeometryTest::draw()
+{
+  glClear(GL_COLOR_BUFFER_BIT);
+
+  Display::draw_line(line1, Color(0.0f, 1.0f, 0.0f));
+  Display::draw_line(line2, Color(0.0f, 1.0f, 0.0f));
+
+  Display::fill_rect(Rectf(cursor - Vector(2,2), Sizef(5,5)), Color(1.0f, 1.0f, 1.0f));
+  Display::fill_rect(Rectf(cursor2 - Vector(2,2), Sizef(5,5)), Color(1.0f, 1.0f, 1.0f));
+  Display::fill_rect(Rectf(collision_point - Vector(2,2), Sizef(5,5)), Color(1.0f, 0.0f, 0.0f));
+
+  Vector current_point;
+  if (point_count == 0)
+    current_point = line1.p1;
+  else if (point_count == 1)
+    current_point = line1.p2;
+  else if (point_count == 2)
+    current_point = line2.p1;
+  else // (point_count == 3)
+    current_point = line2.p2;
+
+  Display::fill_rect(Rectf(current_point - Vector(2,2), Sizef(5,5)), Color(1.0f, 0.0f, 1.0f));
+}
+
+void
+GeometryTest::update(float delta, const Controller& controller)
+{
+  cursor.x += controller.get_axis_state(X_AXIS) * 500.0f * delta;
+  cursor.y += controller.get_axis_state(Y_AXIS) * 500.0f * delta;
+
+  cursor2.x += controller.get_axis_state(X2_AXIS) * 500.0f * delta;
+  cursor2.y -= controller.get_axis_state(Y2_AXIS) * 500.0f * delta;
+
+  if (controller.button_was_pressed(TERTIARY_BUTTON))
+    {
+      point_count += 1;
+      if (point_count > 1)
+        point_count = 0;   
+    }
+
+  if (controller.get_button_state(AIM_BUTTON))
+    {
+      if (point_count == 0)
+        {
+          line1.p1 = cursor;
+          line1.p2 = cursor2;
+        }
+      else if (point_count == 1)
+        {
+          line2.p1 = cursor;
+          line2.p2 = cursor2;
+        }
+
+      if (line1.intersect(line2, collision_point))
+        {
+          if (!had_prev_collision)
+            console << "Collision" << std::endl;
+          had_prev_collision = true;
+        }
+      else
+        {
+          if (had_prev_collision)
+            console << "No Collision" << std::endl;
+          had_prev_collision = false;
+          collision_point = Vector(32, 32);
+        }
+    }
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/geometry_test.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/geometry_test.hpp
===================================================================
--- trunk/windstille/src/geometry_test.hpp	2007-06-15 06:40:08 UTC (rev 1436)
+++ trunk/windstille/src/geometry_test.hpp	2007-06-15 17:13:26 UTC (rev 1437)
@@ -0,0 +1,60 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_GEOMETRY_TEST_HPP
+#define HEADER_GEOMETRY_TEST_HPP
+
+#include "screen.hpp"
+#include "math/vector.hpp"
+#include "math/line.hpp"
+
+/** */
+class GeometryTest : public Screen
+{
+private:
+  Vector cursor;
+  Vector cursor2;
+  Vector collision_point;
+
+  int point_count;
+
+  Line line1;
+  Line line2;
+  bool had_prev_collision;
+
+public:
+  GeometryTest();
+
+  void draw();
+  void update(float delta, const Controller& controller);
+
+private:
+  GeometryTest (const GeometryTest&);
+  GeometryTest& operator= (const GeometryTest&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/geometry_test.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/math/line.cpp
===================================================================
--- trunk/windstille/src/math/line.cpp	2007-06-15 06:40:08 UTC (rev 1436)
+++ trunk/windstille/src/math/line.cpp	2007-06-15 17:13:26 UTC (rev 1437)
@@ -37,4 +37,39 @@
   return (p2 - p1).length();
 }
 
+bool
+Line::intersect(const Line& line, float& ua, float& ub)
+{
+  const float& x1 = p1.x;
+  const float& y1 = p1.y;
+
+  const float& x2 = p2.x;
+  const float& y2 = p2.y;
+  
+  const float& x3 = line.p1.x;
+  const float& y3 = line.p1.y;
+
+  const float& x4 = line.p2.x;
+  const float& y4 = line.p2.y;
+
+  float quotient = ((y4 - y3) * (x2 - x1) - (x4 - x3) * (y2 - y1));
+
+  ua = ((x4 - x3) * (y1 - y3) - (y4 - y3) * (x1 - x3)) / quotient;
+  ub = ((x2 - x1) * (y1 - y3) - (y2 - y1) * (x1 - x3)) / quotient;
+
+  return (ua >= 0.0f && ua <= 1.0f &&
+          ub >= 0.0f && ub <= 1.0f);
+}
+
+bool
+Line::intersect(const Line& line, Vector& colpos)
+{
+  float ua, ub;
+  bool do_collide = intersect(line, ua, ub);
+
+  colpos = p1 + ((p2 - p1) * ua);
+
+  return do_collide;
+}
+
 /* EOF */

Modified: trunk/windstille/src/math/line.hpp
===================================================================
--- trunk/windstille/src/math/line.hpp	2007-06-15 06:40:08 UTC (rev 1436)
+++ trunk/windstille/src/math/line.hpp	2007-06-15 17:13:26 UTC (rev 1437)
@@ -36,16 +36,21 @@
   Vector p1;
   Vector p2;
 
+  Line() {}
+  
   Line(const Vector& p1,
        const Vector& p2);  
   
   float length() const;
 
-  /** Calculate if and where two lines collide */
-  bool collide(const Line& line, float& a, float& b);
+  /** Calculate if and where two lines intersect
+   *  @param a  
+   *  @param b 
+   */
+  bool intersect(const Line& line_b, float& ua, float& ub);
 
-  /** Calculate if and where two lines collide */
-  bool collide(const Line& line, Vector& colpos);
+  /** Calculate if and where two lines intersect */
+  bool intersect(const Line& line, Vector& colpos);
 
 private:
   Line (const Line&);

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-15 06:40:08 UTC (rev 1436)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-15 17:13:26 UTC (rev 1437)
@@ -38,6 +38,7 @@
 #include "sector.hpp"
 #include "sprite3d/manager.hpp"
 #include "sprite3dview.hpp"
+#include "geometry_test.hpp"
 #include "gui/menu_item.hpp"
 #include "menu_manager.hpp"
 
@@ -144,6 +145,10 @@
   slots.push_back(select_scenario_button->sig_click().connect(this, &MenuManager::display_scenario_menu));
   menu->add_item(select_scenario_button);
 
+  ButtonMenuItem* geometry_test_button = new ButtonMenuItem(menu,  "Geometry Test");
+  slots.push_back(geometry_test_button->sig_click().connect(this, &MenuManager::menu_show_geometry_test));
+  menu->add_item(geometry_test_button);
+
   ButtonMenuItem* model_viewer_button = new ButtonMenuItem(menu,  "Model Viewer");
   slots.push_back(model_viewer_button->sig_click().connect(this, &MenuManager::display_models_menu));
   menu->add_item(model_viewer_button);
@@ -554,6 +559,13 @@
 }
 
 void
+MenuManager::menu_show_geometry_test()
+{
+  screen_manager.push_screen(new GeometryTest());
+  screen_manager.clear_overlay();  
+}
+
+void
 MenuManager::menu_gamma(int i)
 {
   float gamma = i / 100.0f;

Modified: trunk/windstille/src/menu_manager.hpp
===================================================================
--- trunk/windstille/src/menu_manager.hpp	2007-06-15 06:40:08 UTC (rev 1436)
+++ trunk/windstille/src/menu_manager.hpp	2007-06-15 17:13:26 UTC (rev 1437)
@@ -58,6 +58,7 @@
   void menu_ambient_light(int i, int component);
   void menu_start_scenario(std::string scenario);
   void menu_show_model(std::string scenario);
+  void menu_show_geometry_test();
   void menu_show_particle_system(std::string file);
   void menu_gamma(int i);
 private:



From grumbel at mail.berlios.de  Fri Jun 15 20:58:33 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 15 Jun 2007 20:58:33 +0200
Subject: [Windstille-commit] r1438 - in trunk/windstille/src: . navigation
Message-ID: <200706151858.l5FIwXqQ029557@sheep.berlios.de>

Author: grumbel
Date: 2007-06-15 20:58:32 +0200 (Fri, 15 Jun 2007)
New Revision: 1438

Removed:
   trunk/windstille/src/spawnpoint.cpp
   trunk/windstille/src/spawnpoint.hpp
Modified:
   trunk/windstille/src/SConscript
   trunk/windstille/src/game_session.cpp
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/navigation/navigation_graph.cpp
   trunk/windstille/src/sector.cpp
   trunk/windstille/src/sector.hpp
Log:
- removed spawnpoint handling

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-15 17:13:26 UTC (rev 1437)
+++ trunk/windstille/src/SConscript	2007-06-15 18:58:32 UTC (rev 1438)
@@ -78,7 +78,6 @@
 'scriptable_object.cpp',
 'script_manager.cpp',
 'sector.cpp',
-'spawnpoint.cpp',
 'sprite3dview.cpp',
 'sprite2dview.cpp',
 'text_area.cpp',

Modified: trunk/windstille/src/game_session.cpp
===================================================================
--- trunk/windstille/src/game_session.cpp	2007-06-15 17:13:26 UTC (rev 1437)
+++ trunk/windstille/src/game_session.cpp	2007-06-15 18:58:32 UTC (rev 1438)
@@ -322,7 +322,6 @@
   //FIXME: does the TestObject class still need to exist?
   //sector->add(new TestObject());
   
-  impl->sector->spawn_player("default");
   impl->sector->activate();
   
   if (debug) std::cout << "Finished changing sector" << std::endl;

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-15 17:13:26 UTC (rev 1437)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-15 18:58:32 UTC (rev 1438)
@@ -130,7 +130,7 @@
                  "of the License, or (at your option) any later version.");
   manager->get_root()->add_child(text_group);
 
-  GroupComponent* group = new GroupComponent(Rectf(Vector(400, 200), Sizef(200, 294)),
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-50, 200), Sizef(300, 294)),
                                              "",
                                              manager->get_root());
 

Modified: trunk/windstille/src/navigation/navigation_graph.cpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-15 17:13:26 UTC (rev 1437)
+++ trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-15 18:58:32 UTC (rev 1438)
@@ -25,6 +25,30 @@
 
 #include "navigation_graph.hpp"
 
-
-
+NavigationGraph::NavigationGraph()
+{
+}
+
+NavigationGraph::~NavigationGraph()
+{
+}
+
+std::vector<Segment*>
+NavigationGraph::find_segments(const Line& line)
+{
+  return std::vector<Segment*>();
+}
+
+std::vector<Node*>
+NavigationGraph::find_nodes(const Vector& pos, float radius)
+{
+  return std::vector<Node*>();
+}
+
+std::vector<Segment*>
+NavigationGraph::find_segments(const Vector& pos, float radius)
+{
+  return std::vector<Segment*>();
+}
+
 /* EOF */

Modified: trunk/windstille/src/sector.cpp
===================================================================
--- trunk/windstille/src/sector.cpp	2007-06-15 17:13:26 UTC (rev 1437)
+++ trunk/windstille/src/sector.cpp	2007-06-15 18:58:32 UTC (rev 1438)
@@ -34,7 +34,6 @@
 #include "objects/test_object.hpp"
 #include "sector.hpp"
 #include "objects/vrdummy.hpp"
-#include "spawnpoint.hpp"
 #include "sound/sound_manager.hpp"
 #include "script_manager.hpp"
 #include "collision/collision_engine.hpp"
@@ -51,19 +50,14 @@
 #include "objects/spider_mine.hpp"
 #include "box.hpp"
 #include "scriptable_object.hpp"
+#include "navigation/navigation_graph.hpp"
 #include "scripting/squirrel_error.hpp"
 
 // The table (works like a namespace here) where the game objects will appear
 #define OBJECTS_TABLE "objects"
 
 Sector* Sector::current_ = 0;
-
-const std::string&
-Sector::get_filename () const
-{
-  return filename;
-}
-
+
 Sector::Sector(const std::string& arg_filename)
   : filename(arg_filename),
     player(0)    
@@ -76,6 +70,7 @@
   
   if (debug) std::cout << "Creating new Sector" << std::endl;
   collision_engine = new CollisionEngine();
+  navigation_graph = new NavigationGraph();
 
   current_ = this;
   interactive_tilemap = 0;
@@ -87,21 +82,26 @@
 
   // add interactive to collision engine
   collision_engine->add(new CollisionObject(interactive_tilemap));
-}
 
+  // Spawn the Player
+  if(!player) {
+    player = new Player();
+    add(player);
+  }
+  player->set_pos(Vector(300,200));
+}
+
 Sector::~Sector()
 {
-  for(SpawnPoints::iterator i = spawn_points.begin();
-      i != spawn_points.end(); ++i)
-    delete *i;                                         
   for(Objects::iterator i = objects.begin(); i != objects.end(); ++i)
     (*i)->unref();
   for(Objects::iterator i = new_objects.begin(); i != new_objects.end(); ++i)
     (*i)->unref();
 
+  delete navigation_graph;
   delete collision_engine;
 }
-
+
 void
 Sector::parse_file(const std::string& filename)
 {
@@ -126,17 +126,13 @@
     std::cerr << "Warning no version specified in levelformat.\n";
   if(version > 1)
     std::cerr << "Warning: format version is newer than game.\n";
+
   props.get("name", name);
   props.get("music", music);
   props.get("init-script", init_script);
   props.get("ambient-color", ambient_light);
   
   PropertyIterator<const Lisp*> iter;
-  props.get_iter("spawnpoint", iter);
-  while(iter.next()) {
-    spawn_points.push_back(new SpawnPoint(*iter));
-  }
-
   const Lisp* objects = 0;
   if(props.get("objects", objects) == false)
     throw std::runtime_error("No objects specified");
@@ -149,7 +145,7 @@
   props.print_unused_warnings("sector");
   if (debug) std::cout << "Finished parsing" << std::endl;
 }
-
+
 void
 Sector::add_object(const std::string& name, const lisp::Lisp* lisp)
 {
@@ -200,7 +196,7 @@
     std::cout << "Skipping unknown Object: " << name << "\n";
   }
 }
-
+
 void
 Sector::activate()
 {
@@ -211,39 +207,8 @@
   if (init_script != "")
     script_manager->run_script_file(init_script);
 }
-
+
 void
-Sector::spawn_player(const std::string& spawnpoint)
-{
-  const SpawnPoint* result = 0;
-  for(SpawnPoints::iterator i = spawn_points.begin();
-      i != spawn_points.end(); ++i) {
-    const SpawnPoint* sp = *i;
-    if(sp->name == spawnpoint) {
-      result = sp;
-      break;
-    }
-  }
-
-  Vector spawnpos(320, 200);
-  if(result == 0) {
-    if(spawnpoint != "default") {
-      std::cerr << "SpawnPoint '" << spawnpoint << "' not found.\n";
-      spawn_player("default");
-      return;
-    }
-  } else {
-    spawnpos = result->pos;
-  }
-
-  if(!player) {
-    player = new Player();
-    add(player);
-  }
-  player->set_pos(spawnpos);
-}
-
-void
 Sector::draw(SceneContext& sc)
 {
   sc.light().fill_screen(ambient_light);
@@ -254,7 +219,7 @@
         (*i)->draw(sc);
     }
 }
-
+
 void Sector::commit_adds()
 {
   // Add new game objects
@@ -263,7 +228,7 @@
   }
   new_objects.clear();
 }
-
+
 void Sector::update(float delta)
 {
   commit_adds();
@@ -276,7 +241,7 @@
   }
   commit_removes();
 }
-
+
 void
 Sector::commit_removes()
 {
@@ -296,7 +261,7 @@
     ++i;
   }
 }
-
+
 void
 Sector::add(GameObject* obj)
 {
@@ -306,7 +271,7 @@
     expose_object_to_squirrel(obj);
   }
 }
-
+
 void
 Sector::remove_object_from_squirrel(GameObject* object)
 {
@@ -335,7 +300,7 @@
   // pop objects and root table
   sq_pop(v, 2);
 }
-
+
 // tries to find out the "real" class of an gameobject by some dynamic casting
 // and creates a matching squirrel instance for that object
 static inline void create_squirrel_instance(HSQUIRRELVM v, GameObject* object)
@@ -361,7 +326,7 @@
 
   create_squirrel_instance(v, new Scripting::GameObject(object), true);
 }
-
+
 void
 Sector::expose_object_to_squirrel(GameObject* object)
 {
@@ -391,7 +356,7 @@
   // pop roottable and objects table
   sq_pop(v, 2);
 }
-
+
 GameObject*
 Sector::get_object(const std::string& name) const
 {
@@ -404,35 +369,41 @@
     }
   return 0;
 }
-
+
 int
 Sector::get_width () const
 {
   return interactive_tilemap->get_width() * TILE_SIZE;
 }
-
+
 int
 Sector::get_height () const
 {
   return interactive_tilemap->get_height() * TILE_SIZE;
 }
-
+
 void
 Sector::set_tilemap(TileMap* t)
 {
   interactive_tilemap = t;
 }
-
+
 void
 Sector::set_ambient_light(const Color& color)
 {
   ambient_light = color;
 }
-
+
 Color
 Sector::get_ambient_light() const
 {
   return ambient_light;
 }
-
+
+const std::string&
+Sector::get_filename () const
+{
+  return filename;
+}
+
 /* EOF */

Modified: trunk/windstille/src/sector.hpp
===================================================================
--- trunk/windstille/src/sector.hpp	2007-06-15 17:13:26 UTC (rev 1437)
+++ trunk/windstille/src/sector.hpp	2007-06-15 18:58:32 UTC (rev 1438)
@@ -31,11 +31,17 @@
 class SceneContext;
 class SpawnPoint;
 class CollisionEngine;
+class NavigationGraph;
 class Entity;
 
 /** */
 class Sector
 {
+private: 
+  static Sector* current_;  
+public:
+  static Sector* current() { return current_; }
+  
 private:
   std::string filename;
   std::string name;
@@ -45,13 +51,9 @@
   typedef std::vector<GameObject*> Objects;
   Objects objects;
   /** container for newly created GameObjects (they'll be added once per frame
-   * in the update function
-   */
+   * in the update function */
   Objects new_objects;
 
-  typedef std::vector<SpawnPoint*> SpawnPoints;
-  SpawnPoints spawn_points;
-
   Color ambient_light;
 
   /** The TileMap with which the player interacts */
@@ -59,15 +61,15 @@
   TileMap* interactivebackground_tilemap;
 
   CollisionEngine* collision_engine;
+  NavigationGraph* navigation_graph;
 
   Player* player;
 
   void parse_file(const std::string& filename);
 
-  static Sector* current_;
-
   void commit_adds();
   void commit_removes();
+
   void expose_object_to_squirrel(GameObject* object);
   void remove_object_from_squirrel(GameObject* object);
 
@@ -75,8 +77,6 @@
   Sector(const std::string& filename);
   ~Sector();
 
-  static Sector* current() { return current_; }
-
   const std::string& get_filename () const;
 
   void draw(SceneContext& gc);
@@ -87,11 +87,6 @@
    */
   void activate();
   
-  /**
-   * Spawns the player at the specified spawnpoint
-   */
-  void spawn_player(const std::string& spawnpoint);
-
   int get_width  () const;
   int get_height () const;
 

Deleted: trunk/windstille/src/spawnpoint.cpp
===================================================================
--- trunk/windstille/src/spawnpoint.cpp	2007-06-15 17:13:26 UTC (rev 1437)
+++ trunk/windstille/src/spawnpoint.cpp	2007-06-15 18:58:32 UTC (rev 1438)
@@ -1,19 +0,0 @@
-#include "spawnpoint.hpp"
-
-#include <iostream>
-#include <stdexcept>
-#include "lisp/properties.hpp"
-#include "lisp_getters.hpp"
-
-SpawnPoint::SpawnPoint(const lisp::Lisp* lisp)
-{
-  using namespace lisp;
-
-  Properties props(lisp);
-  props.get("name", name);
-  props.get("pos", pos);
-  props.print_unused_warnings("spawnpoint");
-
-  if(name == "")
-    throw std::runtime_error("No name specified for spawnpoint");
-}

Deleted: trunk/windstille/src/spawnpoint.hpp
===================================================================
--- trunk/windstille/src/spawnpoint.hpp	2007-06-15 17:13:26 UTC (rev 1437)
+++ trunk/windstille/src/spawnpoint.hpp	2007-06-15 18:58:32 UTC (rev 1438)
@@ -1,18 +0,0 @@
-#ifndef __SPAWN_POINT_HPP__
-#define __SPAWN_POINT_HPP__
-
-#include <string>
-#include "math/vector.hpp"
-#include "lisp/lisp.hpp"
-
-class SpawnPoint
-{
-public:
-  SpawnPoint(const lisp::Lisp* lisp);
-
-  std::string name;
-  Vector pos;
-};
-
-#endif
-



From grumbel at mail.berlios.de  Fri Jun 15 22:34:15 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 15 Jun 2007 22:34:15 +0200
Subject: [Windstille-commit] r1439 - in trunk/windstille/src: . scripting
Message-ID: <200706152034.l5FKYFq4003160@sheep.berlios.de>

Author: grumbel
Date: 2007-06-15 22:34:14 +0200 (Fri, 15 Jun 2007)
New Revision: 1439

Removed:
   trunk/windstille/src/scripting/serialize.cpp
   trunk/windstille/src/scripting/serialize.hpp
   trunk/windstille/src/scripting/spawn_object.cpp
   trunk/windstille/src/scripting/spawn_object.hpp
   trunk/windstille/src/scripting/wrapper_util.cpp
   trunk/windstille/src/scripting/wrapper_util.hpp
Modified:
   trunk/windstille/src/SConscript
   trunk/windstille/src/console.cpp
   trunk/windstille/src/game_session.cpp
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/script_manager.cpp
   trunk/windstille/src/script_manager.hpp
   trunk/windstille/src/scripting/SConscript
   trunk/windstille/src/scripting/interface.cpp
   trunk/windstille/src/scripting/interface.hpp
   trunk/windstille/src/scripting/wrapper.interface.hpp
Log:
- reordered the scripting functions a bit

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/SConscript	2007-06-15 20:34:14 UTC (rev 1439)
@@ -171,11 +171,9 @@
 'physfs/physfs_stream.cpp',
 'scripting/game_objects.cpp',
 'scripting/interface.cpp',
-'scripting/serialize.cpp',
-'scripting/spawn_object.cpp',
 'scripting/squirrel_error.cpp',
 'scripting/wrapper.cpp',
-'scripting/wrapper_util.cpp',
+'scripting/util.cpp',
 'signals/slot.cpp',
 'signals/slot_generic.cpp',
 'sound/sound_file.cpp',

Modified: trunk/windstille/src/console.cpp
===================================================================
--- trunk/windstille/src/console.cpp	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/console.cpp	2007-06-15 20:34:14 UTC (rev 1439)
@@ -29,7 +29,7 @@
 #include "input/input_manager.hpp"
 #include "script_manager.hpp"
 #include "display/display.hpp"
-#include "scripting/wrapper_util.hpp"
+#include "scripting/util.hpp"
 #include "console.hpp"
 
 Console console;
@@ -469,7 +469,7 @@
           const SQChar *s;
           if (SQ_SUCCEEDED(sq_getstring(v,-2, &s)))
             {
-              console << s << " -> " << squirrel2string(v, -1) << std::endl;
+              console << s << " -> " << Scripting::squirrel2string(v, -1) << std::endl;
             }
           else
             {
@@ -509,7 +509,7 @@
         if(SQ_SUCCEEDED(sq_call(vm,1, retval, true))) 
           {
             if (sq_gettype(vm, -1) != OT_NULL)
-              console << squirrel2string(vm, -1) << std::endl;
+              console << Scripting::squirrel2string(vm, -1) << std::endl;
           }
       }
     }

Modified: trunk/windstille/src/game_session.cpp
===================================================================
--- trunk/windstille/src/game_session.cpp	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/game_session.cpp	2007-06-15 20:34:14 UTC (rev 1439)
@@ -45,7 +45,7 @@
 #include "dialog_manager.hpp"
 #include "windstille_main.hpp"
 #include "display/scene_context.hpp"
-#include "scripting/wrapper_util.hpp"
+#include "scripting/util.hpp"
 #include "scripting/wrapper.hpp"
 #include "input/input_manager.hpp"
 #include "particles/particle_system.hpp"

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-15 20:34:14 UTC (rev 1439)
@@ -58,7 +58,7 @@
                                              "Options",
                                              manager->get_root());
 
-  // Begin Main Menu
+  // Begin Menu
   MenuComponent* menu = new MenuComponent(Rectf(), true,
                                           group);
   group->pack(menu);
@@ -130,11 +130,11 @@
                  "of the License, or (at your option) any later version.");
   manager->get_root()->add_child(text_group);
 
-  GroupComponent* group = new GroupComponent(Rectf(Vector(400-50, 200), Sizef(300, 294)),
+  GroupComponent* group = new GroupComponent(Rectf(Vector(400-25, 200), Sizef(250, 294)),
                                              "",
                                              manager->get_root());
 
-  // Begin Main Menu
+  // Begin Menu
   MenuComponent* menu = new MenuComponent(Rectf(), false,
                                           group);
   group->pack(menu);
@@ -189,7 +189,7 @@
                                              "Pause Menu",
                                              manager->get_root());
 
-  // Begin Main Menu
+  // Begin Menu
   MenuComponent* menu = new MenuComponent(Rectf(Vector(400-150, 200), Sizef(300, 500)), true,
                                           group);
   group->pack(menu);
@@ -359,7 +359,7 @@
                                              "Debug",
                                              manager->get_root());
 
-  // Begin Main Menu
+  // Begin Menu
   MenuComponent* menu = new MenuComponent(Rectf(), true, group);
   group->pack(menu);
 

Modified: trunk/windstille/src/script_manager.cpp
===================================================================
--- trunk/windstille/src/script_manager.cpp	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/script_manager.cpp	2007-06-15 20:34:14 UTC (rev 1439)
@@ -14,7 +14,7 @@
 #include "console.hpp"
 #include "timer.hpp"
 #include "scripting/wrapper.hpp"
-#include "scripting/wrapper_util.hpp"
+#include "scripting/util.hpp"
 #include "scripting/squirrel_error.hpp"
 #include "physfs/physfs_stream.hpp"
 

Modified: trunk/windstille/src/script_manager.hpp
===================================================================
--- trunk/windstille/src/script_manager.hpp	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/script_manager.hpp	2007-06-15 20:34:14 UTC (rev 1439)
@@ -8,7 +8,7 @@
 #include <iostream>
 #include "timer.hpp"
 #include "scripting/wrapper.hpp"
-#include "scripting/wrapper_util.hpp"
+#include "scripting/util.hpp"
 
 /**
  * This class is responsible for managing all running squirrel threads

Modified: trunk/windstille/src/scripting/SConscript
===================================================================
--- trunk/windstille/src/scripting/SConscript	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/scripting/SConscript	2007-06-15 20:34:14 UTC (rev 1439)
@@ -8,7 +8,7 @@
 
 env.Depends(env.Command('miniswig.tmp', 'wrapper.interface.hpp',
                         ["cpp -x c  -CC $SOURCE -o $TARGET -DSCRIPTING_API"]),
-            ['interface.hpp', 'spawn_object.hpp', 'game_objects.hpp'])
+            ['interface.hpp', 'game_objects.hpp'])
 
 env.Depends(env.Command(['wrapper.cpp', 'wrapper.hpp'], 'miniswig.tmp',
                         ["$MINISWIG  --input $SOURCE --output-cpp ${TARGETS[0]} --output-hpp ${TARGETS[1]} --module windstille --select-namespace Scripting"]),

Modified: trunk/windstille/src/scripting/interface.cpp
===================================================================
--- trunk/windstille/src/scripting/interface.cpp	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/scripting/interface.cpp	2007-06-15 20:34:14 UTC (rev 1439)
@@ -25,6 +25,7 @@
 
 #include <vector>
 #include "wrapper.interface.hpp"
+#include "util.hpp"
 #include "interface.hpp"
 #include "sound/sound_manager.hpp"
 #include "game_session.hpp"
@@ -33,7 +34,6 @@
 #include "script_manager.hpp"
 #include "sector.hpp"
 #include "font/fonts.hpp"
-#include "serialize.hpp"
 #include "camera.hpp"
 #include "config.hpp"
 #include "pda.hpp"
@@ -317,7 +317,27 @@
   GameSession::current()->get_scene_context()->set_render_mask(mask);
 }
 
+SQInteger spawn_object(HSQUIRRELVM v)
+{
+  using namespace lisp;
+  
+  const char* objname;
+  sq_getstring(v, 2, &objname);
 
+  std::vector<lisp::Lisp*> entries;
+  entries.push_back(new Lisp(Lisp::TYPE_SYMBOL, objname));
+  table_to_lisp(v, 3, entries);
+  std::auto_ptr<Lisp> lisp (new Lisp(entries));
+  try {
+    Sector::current()->add_object(objname, lisp.get());
+  } catch(std::exception& e) {
+    std::cerr << "Error parsing object in spawn_object: " << e.what()
+      << "\n";
+  }
+
+  return 0;
+}
+
 } // namespace Scripting
 
 /* EOF */

Modified: trunk/windstille/src/scripting/interface.hpp
===================================================================
--- trunk/windstille/src/scripting/interface.hpp	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/scripting/interface.hpp	2007-06-15 20:34:14 UTC (rev 1439)
@@ -113,6 +113,15 @@
 int  render_mask_get();
 void render_mask_set(int mask);
 
+/**
+ * Spawn object. Parameters:
+ *    name:    string with name of object
+ *    table:   table that is parsed to get object properties
+ *
+ * Example: spawn_object("scriptable-object", {name="blup", pos=[350,370], sprite="images/arrow.sprite"});
+ */
+SQInteger spawn_object(HSQUIRRELVM v) __custom;
+
 } // namespace Scripting
 
 #endif

Deleted: trunk/windstille/src/scripting/serialize.cpp
===================================================================
--- trunk/windstille/src/scripting/serialize.cpp	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/scripting/serialize.cpp	2007-06-15 20:34:14 UTC (rev 1439)
@@ -1,131 +0,0 @@
-#include "serialize.hpp"
-
-#include <memory>
-#include <assert.h>
-#include "lisp/lisp.hpp"
-#include "lisp/parser.hpp"
-#include "lisp/properties.hpp"
-#include "lisp/writer.hpp"
-
-void load_squirrel_table(HSQUIRRELVM v, int table_idx, const lisp::Lisp* lisp)
-{
-  using namespace lisp;
-  
-  Properties props(lisp);
-  PropertyIterator<const Lisp*> iter = props.get_iter();
-  while(iter.next()) {
-    sq_pushstring(v, iter.item().c_str(), iter.item().size());
-    switch((*iter)->get_type()) {
-      case Lisp::TYPE_LIST:
-        sq_newtable(v);
-        load_squirrel_table(v, sq_gettop(v), *iter);
-        break;
-      case Lisp::TYPE_INT:
-        sq_pushinteger(v, (*iter)->get_int());
-        break;
-      case Lisp::TYPE_FLOAT:
-        sq_pushfloat(v, (*iter)->get_float());
-        break;
-      case Lisp::TYPE_STRING:
-        sq_pushstring(v, (*iter)->get_string(), -1);
-        break;
-      case Lisp::TYPE_BOOL:
-        sq_pushbool(v, (*iter)->get_bool());
-        break;
-      case Lisp::TYPE_SYMBOL:
-        std::cerr << "Unexpected symbol in lisp file...";
-        sq_pushnull(v);
-        break;
-      default:
-        assert(false);
-        break;
-    }
-    if(table_idx < 0) {
-      sq_createslot(v, table_idx - 2);
-    } else {
-      sq_createslot(v, table_idx);
-    }
-  }
-}
-
-void load_squirrel_table(HSQUIRRELVM v, int table_idx, const std::string& file)
-{
-  using namespace lisp;
-  std::auto_ptr<Lisp> root (Parser::parse(file));
-
-  Properties rootp(root.get());
-  const lisp::Lisp* table = 0;
-  if(rootp.get("squirrel-state", table) == false)
-    throw std::runtime_error("Not a squirrel-state file");
-
-  load_squirrel_table(v, table_idx, table);
-}
-
-void save_squirrel_table(HSQUIRRELVM v, int table_idx, lisp::Writer& writer)
-{
-  // offset because of sq_pushnull
-  if(table_idx < 0)
-    table_idx--;
-  
-  //iterator table
-  sq_pushnull(v);
-  while(SQ_SUCCEEDED(sq_next(v, table_idx))) {
-    if(sq_gettype(v, -2) != OT_STRING) {
-      std::cerr << "Table contains non-string key\n";
-      continue;
-    }
-    const char* key;
-    sq_getstring(v, -2, &key);
-
-    switch(sq_gettype(v, -1)) {
-      case OT_INTEGER: {
-        SQInteger val;
-        sq_getinteger(v, -1, &val);
-        writer.write_int(key, val);
-        break;
-      }
-      case OT_FLOAT: {
-        float val;
-        sq_getfloat(v, -1, &val);
-        writer.write_float(key, val);
-        break;
-      }
-      case OT_BOOL: {
-        SQBool val;
-        sq_getbool(v, -1, &val);
-        writer.write_bool(key, val);
-        break;
-      }
-      case OT_STRING: {
-        const char* str;
-        sq_getstring(v, -1, &str);
-        writer.write_string(key, str);
-        break;
-      }
-      case OT_TABLE: {
-        writer.start_list(key);
-        save_squirrel_table(v, -1, writer);
-        writer.end_list(key);
-        break;
-      }
-      case OT_CLOSURE:
-        break; // ignore
-      case OT_NATIVECLOSURE:
-        break;
-      default:
-        std::cerr << "Can't serialize key '" << key << "' in table.\n";
-        break;
-    }
-    sq_pop(v, 2);
-  }
-  sq_pop(v, 1);
-}
-
-void save_squirrel_table(HSQUIRRELVM v, int table_idx, const std::string& file)
-{
-  lisp::Writer writer(file);
-
-  writer.start_list("squirrel-state");
-  save_squirrel_table(v, table_idx, writer);
-  writer.end_list("squirrel-state");
-}

Deleted: trunk/windstille/src/scripting/serialize.hpp
===================================================================
--- trunk/windstille/src/scripting/serialize.hpp	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/scripting/serialize.hpp	2007-06-15 20:34:14 UTC (rev 1439)
@@ -1,12 +0,0 @@
-#ifndef __SERIALIZE_HPP__
-#define __SERIALIZE_HPP__
-
-#include <squirrel.h>
-#include <string>
-
-void save_squirrel_table(HSQUIRRELVM v, int table_idx, const std::string& file);
-void load_squirrel_table(HSQUIRRELVM v, int table_idx, const std::string& file);
-
-#endif
-
-

Deleted: trunk/windstille/src/scripting/spawn_object.cpp
===================================================================
--- trunk/windstille/src/scripting/spawn_object.cpp	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/scripting/spawn_object.cpp	2007-06-15 20:34:14 UTC (rev 1439)
@@ -1,120 +0,0 @@
-#include "wrapper.interface.hpp"
-#include "spawn_object.hpp"
-
-#include <iostream>
-#include "lisp/lisp.hpp"
-#include "wrapper_util.hpp"
-#include "sector.hpp"
-
-namespace Scripting
-{
-
-using namespace lisp;
-
-void table_to_lisp(HSQUIRRELVM v, int table_idx, std::vector<Lisp*>& entries);
-
-std::string sq_to_lisp_string(std::string sq_str)
-{
-  for (unsigned i = 0; i != sq_str.size(); ++i) {
-    if (sq_str[i] == '_')
-      sq_str[i] = '-';
-  }
-  
-  return sq_str;
-}
-
-void sq_to_lisp(HSQUIRRELVM v, std::vector<Lisp*>& entries)
-{
-  switch(sq_gettype(v, -1)) {
-    case OT_INTEGER: {
-      SQInteger val;
-      sq_getinteger(v, -1, &val);
-      entries.push_back(new Lisp(static_cast<int>(val)));
-      break;
-    }
-    case OT_FLOAT: {
-      float val;
-      sq_getfloat(v, -1, &val);
-      entries.push_back(new Lisp(val));
-      break;
-    }
-    case OT_STRING: {
-      const char* str;
-      sq_getstring(v, -1, &str);      
-      entries.push_back(new Lisp(Lisp::TYPE_STRING, str));
-      break;
-    }                                                    
-    case OT_BOOL: {
-      SQBool boolean;
-      sq_getbool(v, -1, &boolean);
-      entries.push_back(new Lisp((bool) boolean));
-      break;
-    }
-    case OT_ARRAY:
-    case OT_TABLE: {
-      table_to_lisp(v, -1, entries);
-      break;
-    }
-    default:
-      std::cerr << "Unsupported value type in table\n";
-      break;
-  }
-}
-
-void table_to_lisp(HSQUIRRELVM v, int table_idx, std::vector<Lisp*>& entries)
-{
-  // offset because of sq_pushnull
-  if(table_idx < 0)
-    table_idx--;
-
-  // iterate table
-  sq_pushnull(v);
-  while(SQ_SUCCEEDED(sq_next(v, table_idx))) {
-    // key is -2, value -1 now
-    if(sq_gettype(v, table_idx) == OT_TABLE) {
-      if(sq_gettype(v, -2) != OT_STRING) {
-        std::cerr << "Table contains a non string key\n";
-        continue;
-      }
-
-      const char* key;
-      sq_getstring(v, -2, &key);
-      std::string lisp_key = sq_to_lisp_string(key);
-
-      std::vector<Lisp*> childs;
-      childs.push_back(new Lisp(Lisp::TYPE_SYMBOL, lisp_key));
-      sq_to_lisp(v, childs);
-      entries.push_back(new Lisp(childs));
-    } else {
-      sq_to_lisp(v, entries);
-    }
-    
-    // pop table key and value
-    sq_pop(v, 2);
-  }
-  // pop iterator
-  sq_pop(v, 1);
-}
-
-SQInteger spawn_object(HSQUIRRELVM v)
-{
-  using namespace lisp;
-  
-  const char* objname;
-  sq_getstring(v, 2, &objname);
-
-  std::vector<lisp::Lisp*> entries;
-  entries.push_back(new Lisp(Lisp::TYPE_SYMBOL, objname));
-  table_to_lisp(v, 3, entries);
-  std::auto_ptr<Lisp> lisp (new Lisp(entries));
-  try {
-    Sector::current()->add_object(objname, lisp.get());
-  } catch(std::exception& e) {
-    std::cerr << "Error parsing object in spawn_object: " << e.what()
-      << "\n";
-  }
-
-  return 0;
-}
-
-}

Deleted: trunk/windstille/src/scripting/spawn_object.hpp
===================================================================
--- trunk/windstille/src/scripting/spawn_object.hpp	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/scripting/spawn_object.hpp	2007-06-15 20:34:14 UTC (rev 1439)
@@ -1,23 +0,0 @@
-#ifndef __SPAWN_OBJECT_HPP__
-#define __SPAWN_OBJECT_HPP__
-
-#ifndef SCRIPTING_API
-#include <squirrel.h>
-#endif
-
-namespace Scripting
-{
-
-/**
- * Spawn object. Parameters:
- *    name:    string with name of object
- *    table:   table that is parsed to get object properties
- *
- * Example: spawn_object("scriptable-object", {name="blup", pos=[350,370], sprite="images/arrow.sprite"});
- */
-SQInteger spawn_object(HSQUIRRELVM v) __custom;
-
-}
-
-#endif
-

Modified: trunk/windstille/src/scripting/wrapper.interface.hpp
===================================================================
--- trunk/windstille/src/scripting/wrapper.interface.hpp	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/scripting/wrapper.interface.hpp	2007-06-15 20:34:14 UTC (rev 1439)
@@ -4,5 +4,4 @@
 #endif
 
 #include "interface.hpp"
-#include "spawn_object.hpp"
 #include "game_objects.hpp"

Deleted: trunk/windstille/src/scripting/wrapper_util.cpp
===================================================================
--- trunk/windstille/src/scripting/wrapper_util.cpp	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/scripting/wrapper_util.cpp	2007-06-15 20:34:14 UTC (rev 1439)
@@ -1,183 +0,0 @@
-#include <config.h>
-
-#include <stdexcept>
-#include <sstream>
-#include "wrapper_util.hpp"
-
-std::string squirrel2string(HSQUIRRELVM v, int i)
-{
-  std::ostringstream os;
-  switch(sq_gettype(v, i))
-    {
-    case OT_NULL:
-      os << "<null>";        
-      break;
-    case OT_BOOL: {
-      SQBool p;
-      sq_getbool(v, i, &p);
-      if (p) 
-        os << "true";
-      else
-        os << "false";
-      break;
-    }
-    case OT_INTEGER: {
-      SQInteger val;
-      sq_getinteger(v, i, &val);
-      os << val;
-      break;
-    }
-    case OT_FLOAT: {
-      float val;
-      sq_getfloat(v, i, &val);
-      os << val;
-      break;
-    }
-    case OT_STRING: {
-      const char* val;
-      sq_getstring(v, i, &val);
-      os << "\"" << val << "\"";
-      break;    
-    }
-    case OT_TABLE: {
-      bool first = true;
-      os << "{";
-      sq_pushnull(v);  //null iterator
-      while(SQ_SUCCEEDED(sq_next(v,i-1)))
-        {
-          if (!first) {
-            os << ", ";
-          }
-          first = false;
-
-          //here -1 is the value and -2 is the key
-          os << squirrel2string(v, -2) << " => " 
-             << squirrel2string(v, -1);
-                              
-          sq_pop(v,2); //pops key and val before the nex iteration
-        }
-      sq_pop(v, 1);
-      os << "}";
-      break;
-    }
-    case OT_ARRAY: {
-      bool first = true;
-      os << "[";
-      sq_pushnull(v);  //null iterator
-      while(SQ_SUCCEEDED(sq_next(v,i-1)))
-        {
-          if (!first) {
-            os << ", ";
-          }
-          first = false;
-
-          //here -1 is the value and -2 is the key
-          // we ignore the key, since that is just the index in an array
-          os << squirrel2string(v, -1);
-                              
-          sq_pop(v,2); //pops key and val before the nex iteration
-        }
-      sq_pop(v, 1);
-      os << "]";
-      break;
-    }
-    case OT_USERDATA:
-      os << "<userdata>";
-      break;
-    case OT_CLOSURE:        
-      os << "<closure (function)>";
-      break;
-    case OT_NATIVECLOSURE:
-      os << "<native closure (C function)>";
-      break;
-    case OT_GENERATOR:
-      os << "<generator>";
-      break;
-    case OT_USERPOINTER:
-      os << "userpointer";
-      break;
-    case OT_THREAD:
-      os << "<thread>";
-      break;
-    case OT_CLASS:
-      os << "<class>";
-      break;
-    case OT_INSTANCE:
-      os << "<instance>";
-      break;
-    default:
-      os << "<unknown>";
-      break;
-    }
-  return os.str();
-}
-
-void print_squirrel_stack(HSQUIRRELVM v)
-{
-    printf("--------------------------------------------------------------\n");
-    int count = sq_gettop(v);
-    for(int i = 1; i <= count; ++i) {
-        printf("%d: ",i);
-        switch(sq_gettype(v, i))
-        {
-            case OT_NULL:
-                printf("null");        
-                break;
-            case OT_INTEGER: {
-                SQInteger val;
-                sq_getinteger(v, i, &val);
-                printf("integer (%d)", static_cast<int>(val));
-                break;
-            }
-            case OT_FLOAT: {
-                float val;
-                sq_getfloat(v, i, &val);
-                printf("float (%f)", val);
-                break;
-            }
-            case OT_STRING: {
-                const char* val;
-                sq_getstring(v, i, &val);
-                printf("string (%s)", val);
-                break;    
-            }
-            case OT_TABLE:
-                printf("table");
-                break;
-            case OT_ARRAY:
-                printf("array");
-                break;
-            case OT_USERDATA:
-                printf("userdata");
-                break;
-            case OT_CLOSURE:        
-                printf("closure(function)");    
-                break;
-            case OT_NATIVECLOSURE:
-                printf("native closure(C function)");
-                break;
-            case OT_GENERATOR:
-                printf("generator");
-                break;
-            case OT_USERPOINTER:
-                printf("userpointer");
-                break;
-            case OT_THREAD:
-                printf("thread");
-                break;
-            case OT_CLASS:
-                printf("class");
-                break;
-            case OT_INSTANCE:
-                printf("instance");
-                break;
-            default:
-                printf("unknown?!?");
-                break;
-        }
-        printf("\n");
-    }
-    printf("--------------------------------------------------------------\n");
-}
-
-/* EOF */

Deleted: trunk/windstille/src/scripting/wrapper_util.hpp
===================================================================
--- trunk/windstille/src/scripting/wrapper_util.hpp	2007-06-15 18:58:32 UTC (rev 1438)
+++ trunk/windstille/src/scripting/wrapper_util.hpp	2007-06-15 20:34:14 UTC (rev 1439)
@@ -1,11 +0,0 @@
-#ifndef __WRAPPERUTIL_HPP__
-#define __WRAPPERUTIL_HPP__
-
-#include <squirrel.h>
-#include <sstream>
-#include <string>
-
-std::string squirrel2string(HSQUIRRELVM v, int i);
-void print_squirrel_stack(HSQUIRRELVM v);
-
-#endif



From grumbel at mail.berlios.de  Fri Jun 15 22:46:36 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 15 Jun 2007 22:46:36 +0200
Subject: [Windstille-commit] r1440 - trunk/windstille/src/scripting
Message-ID: <200706152046.l5FKka2s003825@sheep.berlios.de>

Author: grumbel
Date: 2007-06-15 22:46:36 +0200 (Fri, 15 Jun 2007)
New Revision: 1440

Added:
   trunk/windstille/src/scripting/README
   trunk/windstille/src/scripting/util.cpp
   trunk/windstille/src/scripting/util.hpp
Log:
- reordered the scripting functions a bit

Added: trunk/windstille/src/scripting/README
===================================================================
--- trunk/windstille/src/scripting/README	2007-06-15 20:34:14 UTC (rev 1439)
+++ trunk/windstille/src/scripting/README	2007-06-15 20:46:36 UTC (rev 1440)
@@ -0,0 +1,29 @@
+  Scripting
+?????????????
+
+Autogenerated
+=============
+
+- wrapper.?pp is automatically generated
+
+Util
+====
+
+- util.?pp - utility functions to convert squirrel expression
+  to string as well as print a stackstrace
+
+- squirrel_error.?pp converts a squirrel error into a C++ exception
+
+Interface
+=========
+
+- interface.?pp contains simple functions that can be accessed from
+  the squirrel console
+
+- game_objects.?pp contains wrapper classes around objects to make
+  them exportable to squirrel
+
+- wrapper.interface.hpp include files for wrappper.cpp
+ 
+
+# EOF #

Added: trunk/windstille/src/scripting/util.cpp
===================================================================
--- trunk/windstille/src/scripting/util.cpp	2007-06-15 20:34:14 UTC (rev 1439)
+++ trunk/windstille/src/scripting/util.cpp	2007-06-15 20:46:36 UTC (rev 1440)
@@ -0,0 +1,424 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Matthias Braun <matze at braunis.de>, 
+**                     Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include <sstream>
+#include <memory>
+
+#include <assert.h>
+#include "lisp/lisp.hpp"
+#include "lisp/parser.hpp"
+#include "lisp/properties.hpp"
+#include "lisp/writer.hpp"
+
+#include "util.hpp"
+
+namespace Scripting {
+
+std::string sq_to_lisp_string(std::string sq_str)
+{
+  for (unsigned i = 0; i != sq_str.size(); ++i) {
+    if (sq_str[i] == '_')
+      sq_str[i] = '-';
+  }
+  
+  return sq_str;
+}
+
+void sq_to_lisp(HSQUIRRELVM v, std::vector<lisp::Lisp*>& entries)
+{
+  switch(sq_gettype(v, -1)) {
+    case OT_INTEGER: {
+      SQInteger val;
+      sq_getinteger(v, -1, &val);
+      entries.push_back(new lisp::Lisp(static_cast<int>(val)));
+      break;
+    }
+    case OT_FLOAT: {
+      float val;
+      sq_getfloat(v, -1, &val);
+      entries.push_back(new lisp::Lisp(val));
+      break;
+    }
+    case OT_STRING: {
+      const char* str;
+      sq_getstring(v, -1, &str);      
+      entries.push_back(new lisp::Lisp(lisp::Lisp::TYPE_STRING, str));
+      break;
+    }                                                    
+    case OT_BOOL: {
+      SQBool boolean;
+      sq_getbool(v, -1, &boolean);
+      entries.push_back(new lisp::Lisp((bool) boolean));
+      break;
+    }
+    case OT_ARRAY:
+    case OT_TABLE: {
+      table_to_lisp(v, -1, entries);
+      break;
+    }
+    default:
+      std::cerr << "Unsupported value type in table\n";
+      break;
+  }
+}
+
+void table_to_lisp(HSQUIRRELVM v, int table_idx, std::vector<lisp::Lisp*>& entries)
+{
+  // offset because of sq_pushnull
+  if(table_idx < 0)
+    table_idx--;
+
+  // iterate table
+  sq_pushnull(v);
+  while(SQ_SUCCEEDED(sq_next(v, table_idx))) {
+    // key is -2, value -1 now
+    if(sq_gettype(v, table_idx) == OT_TABLE) {
+      if(sq_gettype(v, -2) != OT_STRING) {
+        std::cerr << "Table contains a non string key\n";
+        continue;
+      }
+
+      const char* key;
+      sq_getstring(v, -2, &key);
+      std::string lisp_key = sq_to_lisp_string(key);
+
+      std::vector<lisp::Lisp*> childs;
+      childs.push_back(new lisp::Lisp(lisp::Lisp::TYPE_SYMBOL, lisp_key));
+      sq_to_lisp(v, childs);
+      entries.push_back(new lisp::Lisp(childs));
+    } else {
+      sq_to_lisp(v, entries);
+    }
+    
+    // pop table key and value
+    sq_pop(v, 2);
+  }
+  // pop iterator
+  sq_pop(v, 1);
+}
+
+std::string squirrel2string(HSQUIRRELVM v, int i)
+{
+  std::ostringstream os;
+  switch(sq_gettype(v, i))
+    {
+    case OT_NULL:
+      os << "<null>";        
+      break;
+    case OT_BOOL: {
+      SQBool p;
+      sq_getbool(v, i, &p);
+      if (p) 
+        os << "true";
+      else
+        os << "false";
+      break;
+    }
+    case OT_INTEGER: {
+      SQInteger val;
+      sq_getinteger(v, i, &val);
+      os << val;
+      break;
+    }
+    case OT_FLOAT: {
+      float val;
+      sq_getfloat(v, i, &val);
+      os << val;
+      break;
+    }
+    case OT_STRING: {
+      const char* val;
+      sq_getstring(v, i, &val);
+      os << "\"" << val << "\"";
+      break;    
+    }
+    case OT_TABLE: {
+      bool first = true;
+      os << "{";
+      sq_pushnull(v);  //null iterator
+      while(SQ_SUCCEEDED(sq_next(v,i-1)))
+        {
+          if (!first) {
+            os << ", ";
+          }
+          first = false;
+
+          //here -1 is the value and -2 is the key
+          os << squirrel2string(v, -2) << " => " 
+             << squirrel2string(v, -1);
+                              
+          sq_pop(v,2); //pops key and val before the nex iteration
+        }
+      sq_pop(v, 1);
+      os << "}";
+      break;
+    }
+    case OT_ARRAY: {
+      bool first = true;
+      os << "[";
+      sq_pushnull(v);  //null iterator
+      while(SQ_SUCCEEDED(sq_next(v,i-1)))
+        {
+          if (!first) {
+            os << ", ";
+          }
+          first = false;
+
+          //here -1 is the value and -2 is the key
+          // we ignore the key, since that is just the index in an array
+          os << squirrel2string(v, -1);
+                              
+          sq_pop(v,2); //pops key and val before the nex iteration
+        }
+      sq_pop(v, 1);
+      os << "]";
+      break;
+    }
+    case OT_USERDATA:
+      os << "<userdata>";
+      break;
+    case OT_CLOSURE:        
+      os << "<closure (function)>";
+      break;
+    case OT_NATIVECLOSURE:
+      os << "<native closure (C function)>";
+      break;
+    case OT_GENERATOR:
+      os << "<generator>";
+      break;
+    case OT_USERPOINTER:
+      os << "userpointer";
+      break;
+    case OT_THREAD:
+      os << "<thread>";
+      break;
+    case OT_CLASS:
+      os << "<class>";
+      break;
+    case OT_INSTANCE:
+      os << "<instance>";
+      break;
+    default:
+      os << "<unknown>";
+      break;
+    }
+  return os.str();
+}
+
+void print_squirrel_stack(HSQUIRRELVM v)
+{
+    printf("--------------------------------------------------------------\n");
+    int count = sq_gettop(v);
+    for(int i = 1; i <= count; ++i) {
+        printf("%d: ",i);
+        switch(sq_gettype(v, i))
+        {
+            case OT_NULL:
+                printf("null");        
+                break;
+            case OT_INTEGER: {
+                SQInteger val;
+                sq_getinteger(v, i, &val);
+                printf("integer (%d)", static_cast<int>(val));
+                break;
+            }
+            case OT_FLOAT: {
+                float val;
+                sq_getfloat(v, i, &val);
+                printf("float (%f)", val);
+                break;
+            }
+            case OT_STRING: {
+                const char* val;
+                sq_getstring(v, i, &val);
+                printf("string (%s)", val);
+                break;    
+            }
+            case OT_TABLE:
+                printf("table");
+                break;
+            case OT_ARRAY:
+                printf("array");
+                break;
+            case OT_USERDATA:
+                printf("userdata");
+                break;
+            case OT_CLOSURE:        
+                printf("closure(function)");    
+                break;
+            case OT_NATIVECLOSURE:
+                printf("native closure(C function)");
+                break;
+            case OT_GENERATOR:
+                printf("generator");
+                break;
+            case OT_USERPOINTER:
+                printf("userpointer");
+                break;
+            case OT_THREAD:
+                printf("thread");
+                break;
+            case OT_CLASS:
+                printf("class");
+                break;
+            case OT_INSTANCE:
+                printf("instance");
+                break;
+            default:
+                printf("unknown?!?");
+                break;
+        }
+        printf("\n");
+    }
+    printf("--------------------------------------------------------------\n");
+}
+
+void load_squirrel_table(HSQUIRRELVM v, int table_idx, const lisp::Lisp* lisp)
+{
+  using namespace lisp;
+  
+  Properties props(lisp);
+  PropertyIterator<const lisp::Lisp*> iter = props.get_iter();
+  while(iter.next()) {
+    sq_pushstring(v, iter.item().c_str(), iter.item().size());
+    switch((*iter)->get_type()) {
+      case lisp::Lisp::TYPE_LIST:
+        sq_newtable(v);
+        load_squirrel_table(v, sq_gettop(v), *iter);
+        break;
+      case lisp::Lisp::TYPE_INT:
+        sq_pushinteger(v, (*iter)->get_int());
+        break;
+      case lisp::Lisp::TYPE_FLOAT:
+        sq_pushfloat(v, (*iter)->get_float());
+        break;
+      case lisp::Lisp::TYPE_STRING:
+        sq_pushstring(v, (*iter)->get_string(), -1);
+        break;
+      case lisp::Lisp::TYPE_BOOL:
+        sq_pushbool(v, (*iter)->get_bool());
+        break;
+      case lisp::Lisp::TYPE_SYMBOL:
+        std::cerr << "Unexpected symbol in lisp file...";
+        sq_pushnull(v);
+        break;
+      default:
+        assert(false);
+        break;
+    }
+    if(table_idx < 0) {
+      sq_createslot(v, table_idx - 2);
+    } else {
+      sq_createslot(v, table_idx);
+    }
+  }
+}
+
+void load_squirrel_table(HSQUIRRELVM v, int table_idx, const std::string& file)
+{
+  using namespace lisp;
+  std::auto_ptr<Lisp> root (Parser::parse(file));
+
+  Properties rootp(root.get());
+  const lisp::Lisp* table = 0;
+  if(rootp.get("squirrel-state", table) == false)
+    throw std::runtime_error("Not a squirrel-state file");
+
+  load_squirrel_table(v, table_idx, table);
+}
+
+void save_squirrel_table(HSQUIRRELVM v, int table_idx, lisp::Writer& writer)
+{
+  // offset because of sq_pushnull
+  if(table_idx < 0)
+    table_idx--;
+  
+  //iterator table
+  sq_pushnull(v);
+  while(SQ_SUCCEEDED(sq_next(v, table_idx))) {
+    if(sq_gettype(v, -2) != OT_STRING) {
+      std::cerr << "Table contains non-string key\n";
+      continue;
+    }
+    const char* key;
+    sq_getstring(v, -2, &key);
+
+    switch(sq_gettype(v, -1)) {
+      case OT_INTEGER: {
+        SQInteger val;
+        sq_getinteger(v, -1, &val);
+        writer.write_int(key, val);
+        break;
+      }
+      case OT_FLOAT: {
+        float val;
+        sq_getfloat(v, -1, &val);
+        writer.write_float(key, val);
+        break;
+      }
+      case OT_BOOL: {
+        SQBool val;
+        sq_getbool(v, -1, &val);
+        writer.write_bool(key, val);
+        break;
+      }
+      case OT_STRING: {
+        const char* str;
+        sq_getstring(v, -1, &str);
+        writer.write_string(key, str);
+        break;
+      }
+      case OT_TABLE: {
+        writer.start_list(key);
+        save_squirrel_table(v, -1, writer);
+        writer.end_list(key);
+        break;
+      }
+      case OT_CLOSURE:
+        break; // ignore
+      case OT_NATIVECLOSURE:
+        break;
+      default:
+        std::cerr << "Can't serialize key '" << key << "' in table.\n";
+        break;
+    }
+    sq_pop(v, 2);
+  }
+  sq_pop(v, 1);
+}
+
+void save_squirrel_table(HSQUIRRELVM v, int table_idx, const std::string& file)
+{
+  lisp::Writer writer(file);
+
+  writer.start_list("squirrel-state");
+  save_squirrel_table(v, table_idx, writer);
+  writer.end_list("squirrel-state");
+}
+
+} // namespace Scripting
+
+/* EOF */


Property changes on: trunk/windstille/src/scripting/util.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/scripting/util.hpp
===================================================================
--- trunk/windstille/src/scripting/util.hpp	2007-06-15 20:34:14 UTC (rev 1439)
+++ trunk/windstille/src/scripting/util.hpp	2007-06-15 20:46:36 UTC (rev 1440)
@@ -0,0 +1,58 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_WINDSTILLE_SCRIPTING_UTIL_HPP
+#define HEADER_WINDSTILLE_SCRIPTING_UTIL_HPP
+
+#include <squirrel.h>
+#include <string>
+
+namespace lisp {
+class Writer;
+};
+
+namespace Scripting {
+
+// Squirrel to Lisp
+void        table_to_lisp(HSQUIRRELVM v, int table_idx, std::vector<lisp::Lisp*>& entries);
+void        sq_to_lisp(HSQUIRRELVM v, std::vector<lisp::Lisp*>& entries);
+std::string sq_to_lisp_string(std::string sq_str);
+std::string squirrel2string(HSQUIRRELVM v, int i);
+
+void print_squirrel_stack(HSQUIRRELVM v);
+
+
+// serialisation
+void save_squirrel_table(HSQUIRRELVM v, int table_idx, lisp::Writer& writer);
+void load_squirrel_table(HSQUIRRELVM v, int table_idx, const lisp::Lisp* lisp);
+
+void save_squirrel_table(HSQUIRRELVM v, int table_idx, const std::string& file);
+void load_squirrel_table(HSQUIRRELVM v, int table_idx, const std::string& file);
+
+} // namespace Scripting
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/scripting/util.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Sat Jun 16 00:48:18 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 16 Jun 2007 00:48:18 +0200
Subject: [Windstille-commit] r1441 - in trunk/windstille/src: . math
	navigation
Message-ID: <200706152248.l5FMmIaY006853@sheep.berlios.de>

Author: grumbel
Date: 2007-06-16 00:48:16 +0200 (Sat, 16 Jun 2007)
New Revision: 1441

Modified:
   trunk/windstille/src/SConscript
   trunk/windstille/src/geometry_test.cpp
   trunk/windstille/src/math/line.hpp
   trunk/windstille/src/math/vector.cpp
   trunk/windstille/src/math/vector.hpp
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/menu_manager.hpp
   trunk/windstille/src/navigation/connection.cpp
   trunk/windstille/src/navigation/connection.hpp
   trunk/windstille/src/navigation/navigation_graph.cpp
   trunk/windstille/src/navigation/navigation_graph.hpp
   trunk/windstille/src/navigation/node.cpp
   trunk/windstille/src/navigation/node.hpp
   trunk/windstille/src/navigation/segment.cpp
   trunk/windstille/src/navigation/segment.hpp
Log:
- added subapp for navigation testing

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-15 20:46:36 UTC (rev 1440)
+++ trunk/windstille/src/SConscript	2007-06-15 22:48:16 UTC (rev 1441)
@@ -66,6 +66,7 @@
 'inventory.cpp',
 'laser_pointer.cpp',
 'liquid.cpp',
+'navigation_test.cpp',
 'pda.cpp',
 'physics.cpp',
 'pistol.cpp',

Modified: trunk/windstille/src/geometry_test.cpp
===================================================================
--- trunk/windstille/src/geometry_test.cpp	2007-06-15 20:46:36 UTC (rev 1440)
+++ trunk/windstille/src/geometry_test.cpp	2007-06-15 22:48:16 UTC (rev 1441)
@@ -31,83 +31,93 @@
 #include "math/size.hpp"
 #include "controller_def.hpp"
 #include "input/controller.hpp"
+#include "screen_manager.hpp"
 #include "display/display.hpp"
 
 GeometryTest::GeometryTest()
 {
-  cursor = Vector(400, 300);
   point_count = 0;
   had_prev_collision = true;
+
+  line1 = Line(Vector(300, 300),
+               Vector(500, 300));
+
+  line2 = Line(Vector(400, 200),
+               Vector(400, 400));
+
+  cursor  = line1.p1;
+  cursor2 = line1.p2;
 }
 
 void
 GeometryTest::draw()
 {
-  glClear(GL_COLOR_BUFFER_BIT);
+  glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
 
   Display::draw_line(line1, Color(0.0f, 1.0f, 0.0f));
   Display::draw_line(line2, Color(0.0f, 1.0f, 0.0f));
 
-  Display::fill_rect(Rectf(cursor - Vector(2,2), Sizef(5,5)), Color(1.0f, 1.0f, 1.0f));
-  Display::fill_rect(Rectf(cursor2 - Vector(2,2), Sizef(5,5)), Color(1.0f, 1.0f, 1.0f));
-  Display::fill_rect(Rectf(collision_point - Vector(2,2), Sizef(5,5)), Color(1.0f, 0.0f, 0.0f));
+  Display::fill_rect(Rectf(cursor - Vector(2,2), Sizef(5,5)),  Color(1.0f, 0.0f, 1.0f));
+  Display::fill_rect(Rectf(cursor2 - Vector(2,2), Sizef(5,5)), Color(1.0f, 1.0f, 0.0f));
 
-  Vector current_point;
-  if (point_count == 0)
-    current_point = line1.p1;
-  else if (point_count == 1)
-    current_point = line1.p2;
-  else if (point_count == 2)
-    current_point = line2.p1;
-  else // (point_count == 3)
-    current_point = line2.p2;
-
-  Display::fill_rect(Rectf(current_point - Vector(2,2), Sizef(5,5)), Color(1.0f, 0.0f, 1.0f));
+  Display::fill_rect(Rectf(collision_point - Vector(3,3), Sizef(7,7)), Color(1.0f, 1.0f, 1.0f));
 }
 
 void
 GeometryTest::update(float delta, const Controller& controller)
 {
+  if (controller.button_was_pressed(ESCAPE_BUTTON) ||
+      controller.button_was_pressed(PAUSE_BUTTON))
+    {
+      screen_manager.pop_screen();
+    }
+
   cursor.x += controller.get_axis_state(X_AXIS) * 500.0f * delta;
   cursor.y += controller.get_axis_state(Y_AXIS) * 500.0f * delta;
 
   cursor2.x += controller.get_axis_state(X2_AXIS) * 500.0f * delta;
   cursor2.y -= controller.get_axis_state(Y2_AXIS) * 500.0f * delta;
 
-  if (controller.button_was_pressed(TERTIARY_BUTTON))
+  if (controller.button_was_pressed(PRIMARY_BUTTON))
     {
+      if (point_count == 0) {
+        cursor  = line2.p1;
+        cursor2 = line2.p2;
+      } else {
+        cursor  = line1.p1;
+        cursor2 = line1.p2;
+      }
+
       point_count += 1;
       if (point_count > 1)
-        point_count = 0;   
+        point_count = 0;
     }
 
-  if (controller.get_button_state(AIM_BUTTON))
+
+  if (point_count == 0)
     {
-      if (point_count == 0)
-        {
-          line1.p1 = cursor;
-          line1.p2 = cursor2;
-        }
-      else if (point_count == 1)
-        {
-          line2.p1 = cursor;
-          line2.p2 = cursor2;
-        }
+      line1.p1 = cursor;
+      line1.p2 = cursor2;
+    }
+  else if (point_count == 1)
+    {
+      line2.p1 = cursor;
+      line2.p2 = cursor2;
+    }
 
-      if (line1.intersect(line2, collision_point))
-        {
-          if (!had_prev_collision)
-            console << "Collision" << std::endl;
-          had_prev_collision = true;
-        }
-      else
-        {
-          if (had_prev_collision)
-            console << "No Collision" << std::endl;
-          had_prev_collision = false;
-          collision_point = Vector(32, 32);
-        }
+  if (line1.intersect(line2, collision_point))
+    {
+      if (!had_prev_collision)
+        console << "Collision" << std::endl;
+      had_prev_collision = true;
     }
+  else
+    {
+      if (had_prev_collision)
+        console << "No Collision" << std::endl;
+      had_prev_collision = false;
+      collision_point = Vector(32, 32);
+    }
 }
 
 /* EOF */

Modified: trunk/windstille/src/math/line.hpp
===================================================================
--- trunk/windstille/src/math/line.hpp	2007-06-15 20:46:36 UTC (rev 1440)
+++ trunk/windstille/src/math/line.hpp	2007-06-15 22:48:16 UTC (rev 1441)
@@ -51,10 +51,6 @@
 
   /** Calculate if and where two lines intersect */
   bool intersect(const Line& line, Vector& colpos);
-
-private:
-  Line (const Line&);
-  Line& operator= (const Line&);
 };
 
 #endif

Modified: trunk/windstille/src/math/vector.cpp
===================================================================
--- trunk/windstille/src/math/vector.cpp	2007-06-15 20:46:36 UTC (rev 1440)
+++ trunk/windstille/src/math/vector.cpp	2007-06-15 22:48:16 UTC (rev 1441)
@@ -41,17 +41,22 @@
   return sqrt(x*x + y*y);
 }
 
+Vector
+Vector::rotate(float angle) const
+{
+  float len = magnitude();
+  return Vector(len * cos(angle), len * sin(angle));
+}
+
 std::ostream& operator<<(std::ostream& s, const Vector& v)
 {
   s << "(" << v.x << ", " << v.y << ")";
   return s;
 }
 
-Vector
-Vector::rotate(float angle) const
+Vector operator*(float s, const Vector& v)
 {
-  float len = magnitude();
-  return Vector(len * cos(angle), len * sin(angle));
+  return Vector(v.x * s, v.y * s);
 }
 
 /* EOF */

Modified: trunk/windstille/src/math/vector.hpp
===================================================================
--- trunk/windstille/src/math/vector.hpp	2007-06-15 20:46:36 UTC (rev 1440)
+++ trunk/windstille/src/math/vector.hpp	2007-06-15 22:48:16 UTC (rev 1441)
@@ -129,6 +129,7 @@
 };
 
 std::ostream& operator<<(std::ostream& s, const Vector& v);
+Vector        operator*(float s, const Vector& v);
 
 #endif
 

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-15 20:46:36 UTC (rev 1440)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-15 22:48:16 UTC (rev 1441)
@@ -39,6 +39,7 @@
 #include "sprite3d/manager.hpp"
 #include "sprite3dview.hpp"
 #include "geometry_test.hpp"
+#include "navigation_test.hpp"
 #include "gui/menu_item.hpp"
 #include "menu_manager.hpp"
 
@@ -145,6 +146,10 @@
   slots.push_back(select_scenario_button->sig_click().connect(this, &MenuManager::display_scenario_menu));
   menu->add_item(select_scenario_button);
 
+  ButtonMenuItem* navigation_test_button = new ButtonMenuItem(menu,  "Navigation Test");
+  slots.push_back(navigation_test_button->sig_click().connect(this, &MenuManager::menu_show_navigation_test));
+  menu->add_item(navigation_test_button);
+
   ButtonMenuItem* geometry_test_button = new ButtonMenuItem(menu,  "Geometry Test");
   slots.push_back(geometry_test_button->sig_click().connect(this, &MenuManager::menu_show_geometry_test));
   menu->add_item(geometry_test_button);
@@ -566,6 +571,13 @@
 }
 
 void
+MenuManager::menu_show_navigation_test()
+{
+  screen_manager.push_screen(new NavigationTest());
+  screen_manager.clear_overlay();  
+}
+
+void
 MenuManager::menu_gamma(int i)
 {
   float gamma = i / 100.0f;

Modified: trunk/windstille/src/menu_manager.hpp
===================================================================
--- trunk/windstille/src/menu_manager.hpp	2007-06-15 20:46:36 UTC (rev 1440)
+++ trunk/windstille/src/menu_manager.hpp	2007-06-15 22:48:16 UTC (rev 1441)
@@ -59,6 +59,7 @@
   void menu_start_scenario(std::string scenario);
   void menu_show_model(std::string scenario);
   void menu_show_geometry_test();
+  void menu_show_navigation_test();
   void menu_show_particle_system(std::string file);
   void menu_gamma(int i);
 private:

Modified: trunk/windstille/src/navigation/connection.cpp
===================================================================
--- trunk/windstille/src/navigation/connection.cpp	2007-06-15 20:46:36 UTC (rev 1440)
+++ trunk/windstille/src/navigation/connection.cpp	2007-06-15 22:48:16 UTC (rev 1441)
@@ -23,8 +23,50 @@
 **  02111-1307, USA.
 */
 
+#include "segment.hpp"
+#include "node.hpp"
 #include "connection.hpp"
 
+void
+Connection::advance(float& adv, Node*& next_node)
+{
+  Vector p1 = segment->get_node1()->get_pos();
+  Vector p2 = segment->get_node2()->get_pos();
+  
+  float length = (p2 - p1).length();
+  
+  // convert from world co to [0,1] range
+  float adv_01 = adv / length;
 
+  if (adv_01 > 0)
+    {
+      pos += adv_01;
+      if (pos > 1.0f) {
+        adv = (pos - 1.0f) * length;
+        next_node = segment->get_node2();
+      } else {
+        adv = 0;
+      }
+    }
+  else
+    {
+      pos += adv_01;
+      if (pos < 0.0f) {
+        adv = pos * length;
+        next_node = segment->get_node1();
+      } else {
+        adv = 0;
+      }
+    }
+}
 
+Vector
+Connection::get_pos() const
+{
+  Vector p1 = segment->get_node1()->get_pos();
+  Vector p2 = segment->get_node2()->get_pos();
+
+  return p1 + pos*(p2 - p1);
+}
+
 /* EOF */

Modified: trunk/windstille/src/navigation/connection.hpp
===================================================================
--- trunk/windstille/src/navigation/connection.hpp	2007-06-15 20:46:36 UTC (rev 1440)
+++ trunk/windstille/src/navigation/connection.hpp	2007-06-15 22:48:16 UTC (rev 1441)
@@ -26,6 +26,8 @@
 #ifndef HEADER_CONNECTION_HPP
 #define HEADER_CONNECTION_HPP
 
+#include "math/vector.hpp"
+
 class Segment;
 class Node;
 
@@ -55,7 +57,9 @@
    *
    *  @return The amount of units left when hitting the end of the segment or 0.0f 
    */
-  float advance(float& adv, Node** next_node);
+  void advance(float& adv, Node*& next_node);
+
+  Vector get_pos() const;
   
 private:
   Connection (const Connection&);

Modified: trunk/windstille/src/navigation/navigation_graph.cpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-15 20:46:36 UTC (rev 1440)
+++ trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-15 22:48:16 UTC (rev 1441)
@@ -23,16 +23,36 @@
 **  02111-1307, USA.
 */
 
+#include "display/display.hpp"
+#include "node.hpp"
+#include "segment.hpp"
 #include "navigation_graph.hpp"
 
 NavigationGraph::NavigationGraph()
 {
+  
 }
 
 NavigationGraph::~NavigationGraph()
 {
 }
 
+Node*
+NavigationGraph::add_node(const Vector& pos)
+{
+  Node* node = new Node(pos);
+  nodes.push_back(node);
+  return node;
+}
+
+Segment*
+NavigationGraph::add_segment(Node* node1, Node* node2)
+{
+  Segment* segment = new Segment(node1, node2);
+  segments.push_back(segment);
+  return segment;
+}
+
 std::vector<Segment*>
 NavigationGraph::find_segments(const Line& line)
 {
@@ -50,5 +70,42 @@
 {
   return std::vector<Segment*>();
 }
+
+Node*
+NavigationGraph::find_closest_node(const Vector& pos, float radius)
+{
+  // FIXME: Optimize this with spatial tree thingy
+  Node* node = 0;
+  float min_distance = radius;
+
+  for(Nodes::iterator i = nodes.begin(); i != nodes.end(); ++i)
+    {
+      float current_distance = (pos - (*i)->get_pos()).length();
+      if (current_distance < min_distance)
+        {
+          min_distance = current_distance;
+          node = *i;
+        }
+    }
+  
+  return node;
+}
 
+void
+NavigationGraph::draw()
+{
+  for(Segments::iterator i = segments.begin(); i != segments.end(); ++i)
+    {
+      Display::draw_line((*i)->get_node1()->get_pos(),
+                         (*i)->get_node2()->get_pos(),
+                         Color(1.0f, 0.0f, 0.0f));
+    }
+
+  for(Nodes::iterator i = nodes.begin(); i != nodes.end(); ++i)
+    {
+      Display::fill_rect(Rectf((*i)->get_pos() - Vector(4,4), Sizef(9, 9)),
+                         Color(1.0f, 1.0f, 0.0f));
+    }
+}
+
 /* EOF */

Modified: trunk/windstille/src/navigation/navigation_graph.hpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-15 20:46:36 UTC (rev 1440)
+++ trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-15 22:48:16 UTC (rev 1441)
@@ -36,24 +36,35 @@
 class NavigationGraph
 {
 private:
-  std::vector<Node*>    nodes;
-  std::vector<Segment*> segments;
-
+  typedef std::vector<Node*>    Nodes;
+  typedef std::vector<Segment*> Segments;
+  
+  Nodes    nodes;
+  Segments segments;
+  
   // insert some spartial thingy here
 
 public:
   NavigationGraph();
   ~NavigationGraph();
 
+  Node*    add_node(const Vector& pos);
+  Segment* add_segment(Node* node1, Node* node2);
+
   /** Find segments that collide with the given line */
   std::vector<Segment*> find_segments(const Line& line);
 
   /** Find nodes that are near the given point */
   std::vector<Node*> find_nodes(const Vector& pos, float radius);
 
+  /** Find the closest node */
+  Node* find_closest_node(const Vector& pos, float radius);
+
   /** Find segments that are near the given point */
   std::vector<Segment*> find_segments(const Vector& pos, float radius);
 
+  /** Draw the navigation graph, for debugging only */
+  void draw();
 private:
   NavigationGraph (const NavigationGraph&);
   NavigationGraph& operator= (const NavigationGraph&);

Modified: trunk/windstille/src/navigation/node.cpp
===================================================================
--- trunk/windstille/src/navigation/node.cpp	2007-06-15 20:46:36 UTC (rev 1440)
+++ trunk/windstille/src/navigation/node.cpp	2007-06-15 22:48:16 UTC (rev 1441)
@@ -25,6 +25,11 @@
 
 #include "node.hpp"
 
+Node::Node(const Vector& pos_)
+  : pos(pos_)
+    // FIXME: Do something with id
+{
+  
+}
 
-
 /* EOF */

Modified: trunk/windstille/src/navigation/node.hpp
===================================================================
--- trunk/windstille/src/navigation/node.hpp	2007-06-15 20:46:36 UTC (rev 1440)
+++ trunk/windstille/src/navigation/node.hpp	2007-06-15 22:48:16 UTC (rev 1441)
@@ -42,8 +42,10 @@
   std::vector<Segment*> segments;
 
 public:
-  Node();
+  Node(const Vector& pos_);
 
+  Vector get_pos() const { return pos; }
+
 private:
   Node(const Node&);
   Node& operator=(const Node&);

Modified: trunk/windstille/src/navigation/segment.cpp
===================================================================
--- trunk/windstille/src/navigation/segment.cpp	2007-06-15 20:46:36 UTC (rev 1440)
+++ trunk/windstille/src/navigation/segment.cpp	2007-06-15 22:48:16 UTC (rev 1441)
@@ -23,8 +23,21 @@
 **  02111-1307, USA.
 */
 
+#include <assert.h>
 #include "segment.hpp"
 
+Segment::Segment(Node* node1_, Node* node2_, Properties props_)
+  : node1(node1_), 
+    node2(node2_),
+    props(props_)
+{
+}
 
+float
+Segment::angle(Segment* seg)
+{
+  assert(!"Implement me");
+  return 0.0f;
+}
 
 /* EOF */

Modified: trunk/windstille/src/navigation/segment.hpp
===================================================================
--- trunk/windstille/src/navigation/segment.hpp	2007-06-15 20:46:36 UTC (rev 1440)
+++ trunk/windstille/src/navigation/segment.hpp	2007-06-15 22:48:16 UTC (rev 1441)
@@ -26,10 +26,10 @@
 #ifndef HEADER_SEGMENT_HPP
 #define HEADER_SEGMENT_HPP
 
+#include "properties.hpp"
+
 class Node;
 
-#include "properties.hpp"
-
 /** */
 class Segment
 {
@@ -40,10 +40,14 @@
   Properties props;
 
 public:
+  Segment(Node* node1_, Node* node2_, Properties props_ = 0);
 
   /** Calculate the angle between two segments */
   float angle(Segment* seg);
   
+  Node* get_node1() const { return node1; } 
+  Node* get_node2() const { return node2; } 
+
 private:
   Segment (const Segment&);
   Segment& operator= (const Segment&);



From grumbel at mail.berlios.de  Sat Jun 16 01:22:13 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 16 Jun 2007 01:22:13 +0200
Subject: [Windstille-commit] r1442 - in trunk/windstille/src: . math
	navigation
Message-ID: <200706152322.l5FNMDxl012220@sheep.berlios.de>

Author: grumbel
Date: 2007-06-16 01:22:12 +0200 (Sat, 16 Jun 2007)
New Revision: 1442

Added:
   trunk/windstille/src/navigation_test.cpp
   trunk/windstille/src/navigation_test.hpp
Modified:
   trunk/windstille/src/math/line.cpp
   trunk/windstille/src/math/line.hpp
   trunk/windstille/src/navigation/navigation_graph.cpp
   trunk/windstille/src/navigation/navigation_graph.hpp
   trunk/windstille/src/navigation/segment.cpp
   trunk/windstille/src/navigation/segment.hpp
Log:
- added some more NavigationGraph stuff along with a test app

Modified: trunk/windstille/src/math/line.cpp
===================================================================
--- trunk/windstille/src/math/line.cpp	2007-06-15 22:48:16 UTC (rev 1441)
+++ trunk/windstille/src/math/line.cpp	2007-06-15 23:22:12 UTC (rev 1442)
@@ -38,7 +38,7 @@
 }
 
 bool
-Line::intersect(const Line& line, float& ua, float& ub)
+Line::intersect(const Line& line, float& ua, float& ub) const
 {
   const float& x1 = p1.x;
   const float& y1 = p1.y;
@@ -62,7 +62,7 @@
 }
 
 bool
-Line::intersect(const Line& line, Vector& colpos)
+Line::intersect(const Line& line, Vector& colpos) const
 {
   float ua, ub;
   bool do_collide = intersect(line, ua, ub);
@@ -72,4 +72,37 @@
   return do_collide;
 }
 
+float
+Line::distance(const Vector& p3) const
+{
+  const float& x1 = p1.x;
+  const float& y1 = p1.y;
+
+  const float& x2 = p2.x;
+  const float& y2 = p2.y;
+  
+  const float& x3 = p3.x;
+  const float& y3 = p3.y;
+
+  float u =
+    ((x3 - x1) * (x2 - x1) + (y3 - y1) * (y2 - y1)) /
+    length() * length();
+  
+  if (u < 0.0f)
+    {
+      return (p1 - p3).length();
+    }
+  else if (u > 1.0f)
+    {
+      return (p2 - p3).length();
+    }
+  else // (u >= 0.0f && u <= 1.0f)
+    {
+      Vector p4(x1 + u * (x2 - x1),
+                y1 + u * (y2 - y2));
+
+      return (p3 - p4).length();
+    }
+}
+
 /* EOF */

Modified: trunk/windstille/src/math/line.hpp
===================================================================
--- trunk/windstille/src/math/line.hpp	2007-06-15 22:48:16 UTC (rev 1441)
+++ trunk/windstille/src/math/line.hpp	2007-06-15 23:22:12 UTC (rev 1442)
@@ -47,10 +47,13 @@
    *  @param a  
    *  @param b 
    */
-  bool intersect(const Line& line_b, float& ua, float& ub);
+  bool intersect(const Line& line_b, float& ua, float& ub) const;
 
   /** Calculate if and where two lines intersect */
-  bool intersect(const Line& line, Vector& colpos);
+  bool intersect(const Line& line, Vector& colpos) const;
+
+  /** Calculate the minimal distance between this line and the point p */
+  float distance(const Vector& p) const;
 };
 
 #endif

Modified: trunk/windstille/src/navigation/navigation_graph.cpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-15 22:48:16 UTC (rev 1441)
+++ trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-15 23:22:12 UTC (rev 1442)
@@ -91,6 +91,26 @@
   return node;
 }
 
+Segment*
+NavigationGraph::find_closest_segment(const Vector& pos, float radius)
+{
+  Segment* segment   = 0;
+  float min_distance = radius;
+
+  for(Segments::iterator i = segments.begin(); i != segments.end(); ++i)
+    {
+      float current_distance = Line((*i)->get_node1()->get_pos(),
+                                    (*i)->get_node2()->get_pos()).distance(pos);
+      if (current_distance < min_distance)
+        {
+          min_distance = current_distance;
+          segment = *i;
+        }
+    }
+
+  return segment;
+}
+
 void
 NavigationGraph::draw()
 {

Modified: trunk/windstille/src/navigation/navigation_graph.hpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-15 22:48:16 UTC (rev 1441)
+++ trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-15 23:22:12 UTC (rev 1442)
@@ -60,6 +60,8 @@
   /** Find the closest node */
   Node* find_closest_node(const Vector& pos, float radius);
 
+  Segment* find_closest_segment(const Vector& pos, float radius);
+
   /** Find segments that are near the given point */
   std::vector<Segment*> find_segments(const Vector& pos, float radius);
 

Modified: trunk/windstille/src/navigation/segment.cpp
===================================================================
--- trunk/windstille/src/navigation/segment.cpp	2007-06-15 22:48:16 UTC (rev 1441)
+++ trunk/windstille/src/navigation/segment.cpp	2007-06-15 23:22:12 UTC (rev 1442)
@@ -24,6 +24,7 @@
 */
 
 #include <assert.h>
+#include "node.hpp"
 #include "segment.hpp"
 
 Segment::Segment(Node* node1_, Node* node2_, Properties props_)
@@ -40,4 +41,11 @@
   return 0.0f;
 }
 
+Line
+Segment::get_line() const
+{
+  return Line(node1->get_pos(),
+              node2->get_pos());
+}
+
 /* EOF */

Modified: trunk/windstille/src/navigation/segment.hpp
===================================================================
--- trunk/windstille/src/navigation/segment.hpp	2007-06-15 22:48:16 UTC (rev 1441)
+++ trunk/windstille/src/navigation/segment.hpp	2007-06-15 23:22:12 UTC (rev 1442)
@@ -26,6 +26,7 @@
 #ifndef HEADER_SEGMENT_HPP
 #define HEADER_SEGMENT_HPP
 
+#include "math/line.hpp"
 #include "properties.hpp"
 
 class Node;
@@ -48,6 +49,8 @@
   Node* get_node1() const { return node1; } 
   Node* get_node2() const { return node2; } 
 
+  Line get_line() const;
+
 private:
   Segment (const Segment&);
   Segment& operator= (const Segment&);

Added: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-15 22:48:16 UTC (rev 1441)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-15 23:22:12 UTC (rev 1442)
@@ -0,0 +1,86 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include <GL/glew.h>
+#include <GL/gl.h>
+#include "input/controller.hpp"
+#include "display/display.hpp"
+#include "screen_manager.hpp"
+#include "navigation/navigation_graph.hpp"
+#include "navigation/node.hpp"
+#include "navigation/segment.hpp"
+#include "navigation_test.hpp"
+
+NavigationTest::NavigationTest()
+  : cursor(400, 300)
+{
+  graph = new NavigationGraph();
+
+  Node* node1 = graph->add_node(Vector(100, 200));
+  Node* node2 = graph->add_node(Vector(300, 400));
+  Node* node3 = graph->add_node(Vector(500, 300));
+  Node* node4 = graph->add_node(Vector(700, 400));
+
+  graph->add_segment(node1, node2);
+  graph->add_segment(node2, node3);
+  graph->add_segment(node3, node4);
+  
+}
+
+void
+NavigationTest::draw()
+{
+  glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
+  graph->draw();
+
+  Display::fill_rect(Rectf(cursor - Vector(2,2), Sizef(5,5)),  Color(1.0f, 1.0f, 1.0f));
+  Display::draw_circle(cursor, 32.0f, Color(1.0f, 1.0f, 1.0f, 0.5f));
+
+  Node* node = graph->find_closest_node(cursor, 32.0f);
+  if (node)
+    Display::draw_circle(node->get_pos(), 12.0f, Color(1.0f, 1.0f, 1.0f, 1.0f));
+
+  Segment* segment = graph->find_closest_segment(cursor, 32.0f);
+  if (segment)
+    Display::draw_line(segment->get_line(), Color(1.0f, 1.0f, 1.0f, 1.0f));
+}
+
+void
+NavigationTest::update(float delta, const Controller& controller)
+{
+  if (controller.button_was_pressed(ESCAPE_BUTTON) ||
+      controller.button_was_pressed(PAUSE_BUTTON))
+    {
+      screen_manager.pop_screen();
+    }
+
+  cursor.x += controller.get_axis_state(X_AXIS) * 500.0f * delta;
+  cursor.y += controller.get_axis_state(Y_AXIS) * 500.0f * delta;
+
+  if (controller.button_was_pressed(PRIMARY_BUTTON))
+    graph->add_node(cursor);
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/navigation_test.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/navigation_test.hpp
===================================================================
--- trunk/windstille/src/navigation_test.hpp	2007-06-15 22:48:16 UTC (rev 1441)
+++ trunk/windstille/src/navigation_test.hpp	2007-06-15 23:22:12 UTC (rev 1442)
@@ -0,0 +1,55 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_NAVIGATION_TEST_HPP
+#define HEADER_NAVIGATION_TEST_HPP
+
+#include "screen.hpp"
+
+class NavigationGraph;
+class Connection;
+
+/** */
+class NavigationTest : public Screen
+{
+private:
+  Vector cursor;
+  NavigationGraph* graph;
+  Connection* connection;
+
+public:
+  NavigationTest();
+
+  void draw();
+  void update(float delta, const Controller& controller);
+
+private:
+  NavigationTest (const NavigationTest&);
+  NavigationTest& operator= (const NavigationTest&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/navigation_test.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Sat Jun 16 02:25:20 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 16 Jun 2007 02:25:20 +0200
Subject: [Windstille-commit] r1443 - in trunk/windstille: . src src/display
	src/math src/navigation
Message-ID: <200706160025.l5G0PJJ2001934@sheep.berlios.de>

Author: grumbel
Date: 2007-06-16 02:25:16 +0200 (Sat, 16 Jun 2007)
New Revision: 1443

Modified:
   trunk/windstille/INSTALL
   trunk/windstille/src/display/display.cpp
   trunk/windstille/src/display/display.hpp
   trunk/windstille/src/math/line.cpp
   trunk/windstille/src/navigation/navigation_graph.cpp
   trunk/windstille/src/navigation/navigation_graph.hpp
   trunk/windstille/src/navigation/node.hpp
   trunk/windstille/src/navigation_test.cpp
   trunk/windstille/src/navigation_test.hpp
Log:
- turned navigation test into a more or less usable navigation graph editor

Modified: trunk/windstille/INSTALL
===================================================================
--- trunk/windstille/INSTALL	2007-06-15 23:22:12 UTC (rev 1442)
+++ trunk/windstille/INSTALL	2007-06-16 00:25:16 UTC (rev 1443)
@@ -12,6 +12,8 @@
  * physfs
  * boost
  * scons
+ * bison
+ * flex
 
 In most cases these will come with your distribution.
 

Modified: trunk/windstille/src/display/display.cpp
===================================================================
--- trunk/windstille/src/display/display.cpp	2007-06-15 23:22:12 UTC (rev 1442)
+++ trunk/windstille/src/display/display.cpp	2007-06-16 00:25:16 UTC (rev 1443)
@@ -48,6 +48,21 @@
 }
 
 void
+Display::draw_segment(const Line& line, const Color& color)
+{
+  Vector normal = (line.p2 - line.p1);
+
+  normal = Vector(-normal.y, normal.x);
+  normal.normalize();
+  normal *= -32.0f;
+  
+  Vector p3 = line.p1 + 0.5f * (line.p2 - line.p1);
+
+  draw_line(line,   color);
+  draw_line(p3, p3 + normal, Color(0.0f, 1.0f, 1.0f));
+}
+
+void
 Display::draw_line(const Vector& pos1, const Vector& pos2, const Color& color)
 {
   OpenGLState state;

Modified: trunk/windstille/src/display/display.hpp
===================================================================
--- trunk/windstille/src/display/display.hpp	2007-06-15 23:22:12 UTC (rev 1442)
+++ trunk/windstille/src/display/display.hpp	2007-06-16 00:25:16 UTC (rev 1443)
@@ -46,6 +46,9 @@
   static void fill_rounded_rect(const Rectf& rect, float radius, const Color& color);
   static void draw_rounded_rect(const Rectf& rect, float radius, const Color& color);
 
+  /** Same as draw_line, but in addition draw a normal on top of the line */
+  static void draw_segment(const Line& line, const Color& color);
+
   static void draw_line(const Line& line, const Color& color);
   static void draw_line(const Vector& pos1, const Vector& pos2, const Color& color);
 

Modified: trunk/windstille/src/math/line.cpp
===================================================================
--- trunk/windstille/src/math/line.cpp	2007-06-15 23:22:12 UTC (rev 1442)
+++ trunk/windstille/src/math/line.cpp	2007-06-16 00:25:16 UTC (rev 1443)
@@ -23,6 +23,7 @@
 **  02111-1307, USA.
 */
 
+#include <iostream>
 #include "line.hpp"
 
 Line::Line(const Vector& p1_,
@@ -86,7 +87,7 @@
 
   float u =
     ((x3 - x1) * (x2 - x1) + (y3 - y1) * (y2 - y1)) /
-    length() * length();
+    (length() * length());
   
   if (u < 0.0f)
     {
@@ -99,9 +100,9 @@
   else // (u >= 0.0f && u <= 1.0f)
     {
       Vector p4(x1 + u * (x2 - x1),
-                y1 + u * (y2 - y2));
+                y1 + u * (y2 - y1));
 
-      return (p3 - p4).length();
+      return (p4 - p3).length();
     }
 }
 

Modified: trunk/windstille/src/navigation/navigation_graph.cpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-15 23:22:12 UTC (rev 1442)
+++ trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-16 00:25:16 UTC (rev 1443)
@@ -23,6 +23,8 @@
 **  02111-1307, USA.
 */
 
+#include <iostream>
+#include <algorithm>
 #include "display/display.hpp"
 #include "node.hpp"
 #include "segment.hpp"
@@ -45,6 +47,54 @@
   return node;
 }
 
+void
+NavigationGraph::remove_segment(Segment* segment)
+{
+  // FIXME: Slow
+  Segments::iterator i = std::find(segments.begin(), segments.end(), segment);
+  if (i != segments.end())
+    {
+      segments.erase(i);
+    }
+
+  delete segment;
+}
+
+struct ContainsNode
+{
+  Node* node;
+
+  ContainsNode(Node* node_) : node(node_) {}
+
+  bool operator()(Segment* segment) {
+    return 
+      (segment->get_node1() == node ||
+       segment->get_node2() == node);
+  }
+};
+
+void
+NavigationGraph::remove_node(Node* node)
+{
+  // FIXME: Slow
+
+  // Remove all segments that would get invalid by removing the node
+  Segments::iterator i = std::remove_if(segments.begin(), segments.end(), ContainsNode(node));
+  if (i != segments.end())
+    {
+      segments.erase(i, segments.end());
+    }
+  
+  // Remove the node itself 
+  Nodes::iterator j = std::find(nodes.begin(), nodes.end(), node);
+  if (j != nodes.end())
+    {
+      nodes.erase(j);
+    }  
+
+  delete node;
+}
+
 Segment*
 NavigationGraph::add_segment(Node* node1, Node* node2)
 {
@@ -53,6 +103,18 @@
   return segment;
 }
 
+void
+NavigationGraph::split_segment(Segment* segment)
+{
+  Node* node1 = segment->get_node1();
+  Node* node3 = segment->get_node2();
+  Node* node2 = add_node(0.5f * (node1->get_pos() + node3->get_pos()));
+
+  remove_segment(segment);
+  add_segment(node1, node2);  
+  add_segment(node2, node3);  
+}
+
 std::vector<Segment*>
 NavigationGraph::find_segments(const Line& line)
 {
@@ -116,9 +178,9 @@
 {
   for(Segments::iterator i = segments.begin(); i != segments.end(); ++i)
     {
-      Display::draw_line((*i)->get_node1()->get_pos(),
-                         (*i)->get_node2()->get_pos(),
-                         Color(1.0f, 0.0f, 0.0f));
+      Display::draw_segment(Line((*i)->get_node1()->get_pos(),
+                                 (*i)->get_node2()->get_pos()),
+                            Color(1.0f, 0.0f, 0.0f));
     }
 
   for(Nodes::iterator i = nodes.begin(); i != nodes.end(); ++i)

Modified: trunk/windstille/src/navigation/navigation_graph.hpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-15 23:22:12 UTC (rev 1442)
+++ trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-16 00:25:16 UTC (rev 1443)
@@ -51,6 +51,11 @@
   Node*    add_node(const Vector& pos);
   Segment* add_segment(Node* node1, Node* node2);
 
+  void remove_node(Node* node);
+  void remove_segment(Segment* segment);
+
+  void split_segment(Segment* segment);
+
   /** Find segments that collide with the given line */
   std::vector<Segment*> find_segments(const Line& line);
 

Modified: trunk/windstille/src/navigation/node.hpp
===================================================================
--- trunk/windstille/src/navigation/node.hpp	2007-06-15 23:22:12 UTC (rev 1442)
+++ trunk/windstille/src/navigation/node.hpp	2007-06-16 00:25:16 UTC (rev 1443)
@@ -45,7 +45,7 @@
   Node(const Vector& pos_);
 
   Vector get_pos() const { return pos; }
-
+  void   set_pos(const Vector& p) { pos = p; }
 private:
   Node(const Node&);
   Node& operator=(const Node&);

Modified: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-15 23:22:12 UTC (rev 1442)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-16 00:25:16 UTC (rev 1443)
@@ -34,18 +34,21 @@
 #include "navigation_test.hpp"
 
 NavigationTest::NavigationTest()
-  : cursor(400, 300)
+  : cursor(400, 300),
+    selected_segment(0),
+    selected_node(0),
+    node_to_connect(0)
 {
   graph = new NavigationGraph();
 
   Node* node1 = graph->add_node(Vector(100, 200));
   Node* node2 = graph->add_node(Vector(300, 400));
-  Node* node3 = graph->add_node(Vector(500, 300));
-  Node* node4 = graph->add_node(Vector(700, 400));
+  //Node* node3 = graph->add_node(Vector(500, 300));
+  //Node* node4 = graph->add_node(Vector(700, 400));
 
   graph->add_segment(node1, node2);
-  graph->add_segment(node2, node3);
-  graph->add_segment(node3, node4);
+  //graph->add_segment(node2, node3);
+  //graph->add_segment(node3, node4);
   
 }
 
@@ -58,13 +61,18 @@
   Display::fill_rect(Rectf(cursor - Vector(2,2), Sizef(5,5)),  Color(1.0f, 1.0f, 1.0f));
   Display::draw_circle(cursor, 32.0f, Color(1.0f, 1.0f, 1.0f, 0.5f));
 
-  Node* node = graph->find_closest_node(cursor, 32.0f);
-  if (node)
-    Display::draw_circle(node->get_pos(), 12.0f, Color(1.0f, 1.0f, 1.0f, 1.0f));
+  if (node_to_connect)
+    {
+      Display::fill_rect(Rectf(node_to_connect->get_pos() - Vector(2,2), Sizef(5,5)),  
+                         Color(1.0f, 1.0f, 1.0f));
+      Display::draw_line(node_to_connect->get_pos(), cursor, Color(1.0f, 1.0f, 1.0f, 0.5f));
+    }
 
-  Segment* segment = graph->find_closest_segment(cursor, 32.0f);
-  if (segment)
-    Display::draw_line(segment->get_line(), Color(1.0f, 1.0f, 1.0f, 1.0f));
+  if (selected_node)
+    Display::draw_circle(selected_node->get_pos(), 12.0f, Color(1.0f, 1.0f, 1.0f, 1.0f));
+
+  if (selected_segment)
+    Display::draw_line(selected_segment->get_line(), Color(1.0f, 1.0f, 1.0f, 1.0f));
 }
 
 void
@@ -80,7 +88,55 @@
   cursor.y += controller.get_axis_state(Y_AXIS) * 500.0f * delta;
 
   if (controller.button_was_pressed(PRIMARY_BUTTON))
-    graph->add_node(cursor);
+    {
+      if (node_to_connect)
+        {
+          if (selected_node)
+            graph->add_segment(node_to_connect, selected_node);
+          
+          node_to_connect = 0;
+        }
+      else if (selected_node)
+        {
+          node_to_connect = selected_node;
+        }
+      else if (selected_segment)
+        {
+          graph->split_segment(selected_segment);
+          selected_segment = 0;
+        }
+      else
+        {
+          graph->add_node(cursor);
+        }
+    }
+
+  if (controller.get_button_state(TERTIARY_BUTTON))
+    {
+      if (selected_node)
+        {
+          selected_node->set_pos(cursor);
+        }
+    }
+
+  if (controller.button_was_pressed(PDA_BUTTON))
+    {
+      if (selected_node) {
+        graph->remove_node(selected_node);
+        selected_node = 0;
+      } 
+      
+      if (selected_segment) {
+        graph->remove_segment(selected_segment);
+        selected_segment = 0;
+      }      
+    }
+
+  selected_node = graph->find_closest_node(cursor, 32.0f);
+  if (!selected_node)
+    selected_segment = graph->find_closest_segment(cursor, 32.0f);
+  else
+    selected_segment = 0;
 }
 
 /* EOF */

Modified: trunk/windstille/src/navigation_test.hpp
===================================================================
--- trunk/windstille/src/navigation_test.hpp	2007-06-15 23:22:12 UTC (rev 1442)
+++ trunk/windstille/src/navigation_test.hpp	2007-06-16 00:25:16 UTC (rev 1443)
@@ -30,6 +30,8 @@
 
 class NavigationGraph;
 class Connection;
+class Segment;
+class Node;
 
 /** */
 class NavigationTest : public Screen
@@ -39,6 +41,11 @@
   NavigationGraph* graph;
   Connection* connection;
 
+  Segment* selected_segment;
+  Node*    selected_node;
+
+  Node* node_to_connect;
+
 public:
   NavigationTest();
 



From grumbel at mail.berlios.de  Sat Jun 16 03:05:37 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 16 Jun 2007 03:05:37 +0200
Subject: [Windstille-commit] r1444 - in trunk/windstille: lib src
	src/navigation
Message-ID: <200706160105.l5G15bc3004063@sheep.berlios.de>

Author: grumbel
Date: 2007-06-16 03:05:35 +0200 (Sat, 16 Jun 2007)
New Revision: 1444

Modified:
   trunk/windstille/lib/README
   trunk/windstille/src/navigation/connection.cpp
   trunk/windstille/src/navigation/connection.hpp
   trunk/windstille/src/navigation/node.cpp
   trunk/windstille/src/navigation/node.hpp
   trunk/windstille/src/navigation/segment.cpp
   trunk/windstille/src/navigation/segment.hpp
   trunk/windstille/src/navigation_test.cpp
Log:
- basic line-walking is now working

Modified: trunk/windstille/lib/README
===================================================================
--- trunk/windstille/lib/README	2007-06-16 00:25:16 UTC (rev 1443)
+++ trunk/windstille/lib/README	2007-06-16 01:05:35 UTC (rev 1444)
@@ -1,5 +1,8 @@
 glew/:      http://glew.sourceforge.net/
 
-SQUIRREL2/: http://squirrel-lang.org
+SQUIRREL2/ - http://squirrel-lang.org
+-------------------------------------
+SQUIRREL2/ is a verbatim copy of the squirrel tarball, to update it,
+just remove SQUIRREL2 and extract a new tarball.
 
 # EOF #

Modified: trunk/windstille/src/navigation/connection.cpp
===================================================================
--- trunk/windstille/src/navigation/connection.cpp	2007-06-16 00:25:16 UTC (rev 1443)
+++ trunk/windstille/src/navigation/connection.cpp	2007-06-16 01:05:35 UTC (rev 1444)
@@ -25,9 +25,23 @@
 
 #include "segment.hpp"
 #include "node.hpp"
+#include "display/display.hpp"
 #include "connection.hpp"
 
+Connection::Connection(Segment* segment_, float pos_)
+  : segment(segment_),
+    pos(pos_)
+{  
+}
+
 void
+Connection::set_pos(Segment* segment_, float pos_)
+{
+  segment = segment_;
+  pos     = pos_;
+}
+
+void
 Connection::advance(float& adv, Node*& next_node)
 {
   Vector p1 = segment->get_node1()->get_pos();
@@ -43,6 +57,7 @@
       pos += adv_01;
       if (pos > 1.0f) {
         adv = (pos - 1.0f) * length;
+        pos = 1.0f;
         next_node = segment->get_node2();
       } else {
         adv = 0;
@@ -53,6 +68,7 @@
       pos += adv_01;
       if (pos < 0.0f) {
         adv = pos * length;
+        pos = 0;
         next_node = segment->get_node1();
       } else {
         adv = 0;
@@ -69,4 +85,11 @@
   return p1 + pos*(p2 - p1);
 }
 
+void
+Connection::draw()
+{
+  Display::fill_circle(get_pos(), 16.0f, Color(0.0f, 0.0f, 1.0f));
+  Display::fill_circle(get_pos(), 8.0f, Color(0.0f, 1.0f, 1.0f));
+}
+
 /* EOF */

Modified: trunk/windstille/src/navigation/connection.hpp
===================================================================
--- trunk/windstille/src/navigation/connection.hpp	2007-06-16 00:25:16 UTC (rev 1443)
+++ trunk/windstille/src/navigation/connection.hpp	2007-06-16 01:05:35 UTC (rev 1444)
@@ -33,7 +33,7 @@
 
 /** 
  */
-class Connection
+class Connection // FIXME: Rename to SegmentContact
 {
 public:
   Segment* segment;
@@ -48,6 +48,10 @@
   float advance_this_segment(float adv);
 
 public:
+  Connection(Segment* segment_, float pos_);
+
+  void set_pos(Segment* segment_, float pos_);
+
   /** Move forward \a adv of units in world-co, automatically jump
    * across segments, unless a end node is hit
    *
@@ -59,8 +63,12 @@
    */
   void advance(float& adv, Node*& next_node);
 
+  Segment* get_segment() const { return segment; }
+  float get_float_pos() const { return pos; }
+
   Vector get_pos() const;
-  
+
+  void draw();
 private:
   Connection (const Connection&);
   Connection& operator= (const Connection&);

Modified: trunk/windstille/src/navigation/node.cpp
===================================================================
--- trunk/windstille/src/navigation/node.cpp	2007-06-16 00:25:16 UTC (rev 1443)
+++ trunk/windstille/src/navigation/node.cpp	2007-06-16 01:05:35 UTC (rev 1444)
@@ -23,6 +23,7 @@
 **  02111-1307, USA.
 */
 
+#include <algorithm>
 #include "node.hpp"
 
 Node::Node(const Vector& pos_)
@@ -31,5 +32,21 @@
 {
   
 }
-
+
+void
+Node::add_segment(Segment* segment)
+{
+  segments.push_back(segment);
+}
+
+void
+Node::remove_segment(Segment* segment)
+{
+  Segments::iterator i = std::find(segments.begin(), segments.end(), segment);
+  if (i != segments.end())
+    {
+      segments.erase(i);
+    }
+}
+
 /* EOF */

Modified: trunk/windstille/src/navigation/node.hpp
===================================================================
--- trunk/windstille/src/navigation/node.hpp	2007-06-16 00:25:16 UTC (rev 1443)
+++ trunk/windstille/src/navigation/node.hpp	2007-06-16 01:05:35 UTC (rev 1444)
@@ -38,14 +38,19 @@
   int    id;
   Vector pos;
   
+public:
   /** Segments connected to this node */
-  std::vector<Segment*> segments;
+  typedef std::vector<Segment*> Segments;
+  Segments segments;
 
 public:
   Node(const Vector& pos_);
 
   Vector get_pos() const { return pos; }
   void   set_pos(const Vector& p) { pos = p; }
+  
+  void add_segment(Segment* segment);
+  void remove_segment(Segment* segment);
 private:
   Node(const Node&);
   Node& operator=(const Node&);

Modified: trunk/windstille/src/navigation/segment.cpp
===================================================================
--- trunk/windstille/src/navigation/segment.cpp	2007-06-16 00:25:16 UTC (rev 1443)
+++ trunk/windstille/src/navigation/segment.cpp	2007-06-16 01:05:35 UTC (rev 1444)
@@ -32,8 +32,16 @@
     node2(node2_),
     props(props_)
 {
+  node1->add_segment(this);
+  node2->add_segment(this);
 }
 
+Segment::~Segment()
+{
+  node1->remove_segment(this);
+  node2->remove_segment(this);
+}
+
 float
 Segment::angle(Segment* seg)
 {

Modified: trunk/windstille/src/navigation/segment.hpp
===================================================================
--- trunk/windstille/src/navigation/segment.hpp	2007-06-16 00:25:16 UTC (rev 1443)
+++ trunk/windstille/src/navigation/segment.hpp	2007-06-16 01:05:35 UTC (rev 1444)
@@ -42,6 +42,7 @@
 
 public:
   Segment(Node* node1_, Node* node2_, Properties props_ = 0);
+  ~Segment();
 
   /** Calculate the angle between two segments */
   float angle(Segment* seg);

Modified: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-16 00:25:16 UTC (rev 1443)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-16 01:05:35 UTC (rev 1444)
@@ -23,6 +23,8 @@
 **  02111-1307, USA.
 */
 
+#include <assert.h>
+#include <iostream>
 #include <GL/glew.h>
 #include <GL/gl.h>
 #include "input/controller.hpp"
@@ -30,11 +32,14 @@
 #include "screen_manager.hpp"
 #include "navigation/navigation_graph.hpp"
 #include "navigation/node.hpp"
+#include "navigation/connection.hpp"
 #include "navigation/segment.hpp"
 #include "navigation_test.hpp"
 
 NavigationTest::NavigationTest()
   : cursor(400, 300),
+    graph(0),
+    connection(0),
     selected_segment(0),
     selected_node(0),
     node_to_connect(0)
@@ -73,6 +78,9 @@
 
   if (selected_segment)
     Display::draw_line(selected_segment->get_line(), Color(1.0f, 1.0f, 1.0f, 1.0f));
+
+  if (connection)
+    connection->draw();
 }
 
 void
@@ -119,6 +127,57 @@
         }
     }
 
+  if (controller.button_was_pressed(SECONDARY_BUTTON))
+    {
+      if (selected_segment)
+        {
+          delete connection;
+          connection = new Connection(selected_segment, 0.5f);
+        }
+    }
+
+  if (connection)
+    {
+      Node* next_node;
+      float advance = 512.0f * controller.get_axis_state(X2_AXIS) * delta;
+      connection->advance(advance, next_node);
+      if (advance != 0)
+        {
+          Segment* next_segment = 0;
+          for(Node::Segments::iterator i = next_node->segments.begin(); i != next_node->segments.end(); ++i)
+            {
+              if (connection->get_segment() != *i)
+                {
+                  next_segment = *i;
+                  break;
+                }
+            }
+              
+          if (!next_segment)
+            {
+              std::cout << "Dead End" << std::endl;
+            }
+          else
+            {
+              std::cout << "transition" << std::endl;
+                           
+              // FIXME: broken API this 0.0 or 1.0 depends on the segment
+              if (connection->get_float_pos() == 0.0f)
+                {
+                  connection->set_pos(next_segment, 1.0f);
+                }
+              else if (connection->get_float_pos() == 1.0f)
+                {
+                  connection->set_pos(next_segment, 0.0f);
+                }
+              else
+                {
+                  assert(!"This should never been reached! - 3124");
+                }
+            }
+        }
+    }
+
   if (controller.button_was_pressed(PDA_BUTTON))
     {
       if (selected_node) {



From grumbel at mail.berlios.de  Sat Jun 16 06:03:53 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 16 Jun 2007 06:03:53 +0200
Subject: [Windstille-commit] r1445 - in trunk/windstille: . doc src
	src/navigation
Message-ID: <200706160403.l5G43rqn016609@sheep.berlios.de>

Author: grumbel
Date: 2007-06-16 06:03:52 +0200 (Sat, 16 Jun 2007)
New Revision: 1445

Added:
   trunk/windstille/doc/
   trunk/windstille/doc/Doxyfile
Removed:
   trunk/windstille/docs/
Modified:
   trunk/windstille/TODO
   trunk/windstille/src/navigation/connection.hpp
   trunk/windstille/src/windstille_main.hpp
Log:
- added doxygen file

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-16 01:05:35 UTC (rev 1444)
+++ trunk/windstille/TODO	2007-06-16 04:03:52 UTC (rev 1445)
@@ -1,3 +1,5 @@
+- incooperate the freebsd patches
+- add bison checks
 - implement proper dead-zone in input handling
 - shrink textures: a lot!
 - collision detection

Copied: trunk/windstille/doc (from rev 1418, trunk/windstille/docs)


Property changes on: trunk/windstille/doc
___________________________________________________________________
Name: svn:ignore
   + api


Added: trunk/windstille/doc/Doxyfile
===================================================================
--- trunk/windstille/docs/Doxyfile	2007-06-12 21:08:12 UTC (rev 1418)
+++ trunk/windstille/doc/Doxyfile	2007-06-16 04:03:52 UTC (rev 1445)
@@ -0,0 +1,238 @@
+# Doxyfile 1.5.1
+
+#---------------------------------------------------------------------------
+# Project related configuration options
+#---------------------------------------------------------------------------
+PROJECT_NAME           = Windstille
+PROJECT_NUMBER         = 
+OUTPUT_DIRECTORY       = 
+CREATE_SUBDIRS         = NO
+OUTPUT_LANGUAGE        = English
+USE_WINDOWS_ENCODING   = NO
+BRIEF_MEMBER_DESC      = YES
+REPEAT_BRIEF           = YES
+ABBREVIATE_BRIEF       = "The $name class" \
+                         "The $name widget" \
+                         "The $name file" \
+                         is \
+                         provides \
+                         specifies \
+                         contains \
+                         represents \
+                         a \
+                         an \
+                         the
+ALWAYS_DETAILED_SEC    = NO
+INLINE_INHERITED_MEMB  = NO
+FULL_PATH_NAMES        = YES
+STRIP_FROM_PATH        = 
+STRIP_FROM_INC_PATH    = 
+SHORT_NAMES            = NO
+JAVADOC_AUTOBRIEF      = NO
+MULTILINE_CPP_IS_BRIEF = NO
+DETAILS_AT_TOP         = NO
+INHERIT_DOCS           = YES
+SEPARATE_MEMBER_PAGES  = NO
+TAB_SIZE               = 8
+ALIASES                = 
+OPTIMIZE_OUTPUT_FOR_C  = NO
+OPTIMIZE_OUTPUT_JAVA   = NO
+BUILTIN_STL_SUPPORT    = NO
+DISTRIBUTE_GROUP_DOC   = NO
+SUBGROUPING            = YES
+#---------------------------------------------------------------------------
+# Build related configuration options
+#---------------------------------------------------------------------------
+EXTRACT_ALL            = YES
+EXTRACT_PRIVATE        = YES
+EXTRACT_STATIC         = YES
+EXTRACT_LOCAL_CLASSES  = YES
+EXTRACT_LOCAL_METHODS  = NO
+HIDE_UNDOC_MEMBERS     = NO
+HIDE_UNDOC_CLASSES     = NO
+HIDE_FRIEND_COMPOUNDS  = NO
+HIDE_IN_BODY_DOCS      = NO
+INTERNAL_DOCS          = NO
+CASE_SENSE_NAMES       = YES
+HIDE_SCOPE_NAMES       = NO
+SHOW_INCLUDE_FILES     = YES
+INLINE_INFO            = YES
+SORT_MEMBER_DOCS       = YES
+SORT_BRIEF_DOCS        = NO
+SORT_BY_SCOPE_NAME     = NO
+GENERATE_TODOLIST      = YES
+GENERATE_TESTLIST      = YES
+GENERATE_BUGLIST       = YES
+GENERATE_DEPRECATEDLIST= YES
+ENABLED_SECTIONS       = 
+MAX_INITIALIZER_LINES  = 30
+SHOW_USED_FILES        = YES
+SHOW_DIRECTORIES       = NO
+FILE_VERSION_FILTER    = 
+#---------------------------------------------------------------------------
+# configuration options related to warning and progress messages
+#---------------------------------------------------------------------------
+QUIET                  = NO
+WARNINGS               = YES
+WARN_IF_UNDOCUMENTED   = YES
+WARN_IF_DOC_ERROR      = YES
+WARN_NO_PARAMDOC       = NO
+WARN_FORMAT            = "$file:$line: $text"
+WARN_LOGFILE           = 
+#---------------------------------------------------------------------------
+# configuration options related to the input files
+#---------------------------------------------------------------------------
+INPUT                  = ../src/
+FILE_PATTERNS          = *.c \
+                         *.h \
+                         *.cpp \
+                         *.hpp
+RECURSIVE              = YES
+EXCLUDE                = 
+EXCLUDE_SYMLINKS       = NO
+EXCLUDE_PATTERNS       = 
+EXAMPLE_PATH           = 
+EXAMPLE_PATTERNS       = *
+EXAMPLE_RECURSIVE      = NO
+IMAGE_PATH             = 
+INPUT_FILTER           = 
+FILTER_PATTERNS        = 
+FILTER_SOURCE_FILES    = NO
+#---------------------------------------------------------------------------
+# configuration options related to source browsing
+#---------------------------------------------------------------------------
+SOURCE_BROWSER         = YES
+INLINE_SOURCES         = NO
+STRIP_CODE_COMMENTS    = YES
+REFERENCED_BY_RELATION = YES
+REFERENCES_RELATION    = YES
+REFERENCES_LINK_SOURCE = YES
+USE_HTAGS              = NO
+VERBATIM_HEADERS       = YES
+#---------------------------------------------------------------------------
+# configuration options related to the alphabetical class index
+#---------------------------------------------------------------------------
+ALPHABETICAL_INDEX     = YES
+COLS_IN_ALPHA_INDEX    = 5
+IGNORE_PREFIX          = 
+#---------------------------------------------------------------------------
+# configuration options related to the HTML output
+#---------------------------------------------------------------------------
+GENERATE_HTML          = YES
+HTML_OUTPUT            = api
+HTML_FILE_EXTENSION    = .html
+HTML_HEADER            = 
+HTML_FOOTER            = 
+HTML_STYLESHEET        = 
+HTML_ALIGN_MEMBERS     = YES
+GENERATE_HTMLHELP      = NO
+CHM_FILE               = 
+HHC_LOCATION           = 
+GENERATE_CHI           = NO
+BINARY_TOC             = NO
+TOC_EXPAND             = NO
+DISABLE_INDEX          = NO
+ENUM_VALUES_PER_LINE   = 4
+GENERATE_TREEVIEW      = NO
+TREEVIEW_WIDTH         = 250
+#---------------------------------------------------------------------------
+# configuration options related to the LaTeX output
+#---------------------------------------------------------------------------
+GENERATE_LATEX         = NO
+LATEX_OUTPUT           = latex
+LATEX_CMD_NAME         = latex
+MAKEINDEX_CMD_NAME     = makeindex
+COMPACT_LATEX          = NO
+PAPER_TYPE             = a4wide
+EXTRA_PACKAGES         = 
+LATEX_HEADER           = 
+PDF_HYPERLINKS         = NO
+USE_PDFLATEX           = NO
+LATEX_BATCHMODE        = NO
+LATEX_HIDE_INDICES     = NO
+#---------------------------------------------------------------------------
+# configuration options related to the RTF output
+#---------------------------------------------------------------------------
+GENERATE_RTF           = NO
+RTF_OUTPUT             = rtf
+COMPACT_RTF            = NO
+RTF_HYPERLINKS         = NO
+RTF_STYLESHEET_FILE    = 
+RTF_EXTENSIONS_FILE    = 
+#---------------------------------------------------------------------------
+# configuration options related to the man page output
+#---------------------------------------------------------------------------
+GENERATE_MAN           = NO
+MAN_OUTPUT             = man
+MAN_EXTENSION          = .3
+MAN_LINKS              = NO
+#---------------------------------------------------------------------------
+# configuration options related to the XML output
+#---------------------------------------------------------------------------
+GENERATE_XML           = NO
+XML_OUTPUT             = xml
+XML_SCHEMA             = 
+XML_DTD                = 
+XML_PROGRAMLISTING     = YES
+#---------------------------------------------------------------------------
+# configuration options for the AutoGen Definitions output
+#---------------------------------------------------------------------------
+GENERATE_AUTOGEN_DEF   = NO
+#---------------------------------------------------------------------------
+# configuration options related to the Perl module output
+#---------------------------------------------------------------------------
+GENERATE_PERLMOD       = NO
+PERLMOD_LATEX          = NO
+PERLMOD_PRETTY         = YES
+PERLMOD_MAKEVAR_PREFIX = 
+#---------------------------------------------------------------------------
+# Configuration options related to the preprocessor   
+#---------------------------------------------------------------------------
+ENABLE_PREPROCESSING   = YES
+MACRO_EXPANSION        = NO
+EXPAND_ONLY_PREDEF     = NO
+SEARCH_INCLUDES        = YES
+INCLUDE_PATH           = 
+INCLUDE_FILE_PATTERNS  = 
+PREDEFINED             = 
+EXPAND_AS_DEFINED      = 
+SKIP_FUNCTION_MACROS   = YES
+#---------------------------------------------------------------------------
+# Configuration::additions related to external references   
+#---------------------------------------------------------------------------
+TAGFILES               = 
+GENERATE_TAGFILE       = 
+ALLEXTERNALS           = NO
+EXTERNAL_GROUPS        = YES
+PERL_PATH              = /usr/bin/perl
+#---------------------------------------------------------------------------
+# Configuration options related to the dot tool   
+#---------------------------------------------------------------------------
+CLASS_DIAGRAMS         = NO
+HIDE_UNDOC_RELATIONS   = YES
+HAVE_DOT               = YES
+CLASS_GRAPH            = YES
+COLLABORATION_GRAPH    = YES
+GROUP_GRAPHS           = YES
+UML_LOOK               = NO
+TEMPLATE_RELATIONS     = NO
+INCLUDE_GRAPH          = YES
+INCLUDED_BY_GRAPH      = YES
+CALL_GRAPH             = YES
+CALLER_GRAPH           = NO
+GRAPHICAL_HIERARCHY    = YES
+DIRECTORY_GRAPH        = YES
+DOT_IMAGE_FORMAT       = png
+DOT_PATH               = 
+DOTFILE_DIRS           = 
+MAX_DOT_GRAPH_WIDTH    = 1024
+MAX_DOT_GRAPH_HEIGHT   = 1024
+MAX_DOT_GRAPH_DEPTH    = 1000
+DOT_TRANSPARENT        = NO
+DOT_MULTI_TARGETS      = NO
+GENERATE_LEGEND        = YES
+DOT_CLEANUP            = YES
+#---------------------------------------------------------------------------
+# Configuration::additions related to the search engine   
+#---------------------------------------------------------------------------
+SEARCHENGINE           = NO

Modified: trunk/windstille/src/navigation/connection.hpp
===================================================================
--- trunk/windstille/src/navigation/connection.hpp	2007-06-16 01:05:35 UTC (rev 1444)
+++ trunk/windstille/src/navigation/connection.hpp	2007-06-16 04:03:52 UTC (rev 1445)
@@ -42,11 +42,6 @@
       world-co */
   float pos;
 
-  /** Move forward \a adv of units in world-co 
-   *  @return The amount of units left when hitting the end of the segment or 0.0f 
-   */
-  float advance_this_segment(float adv);
-
 public:
   Connection(Segment* segment_, float pos_);
 
@@ -55,14 +50,15 @@
   /** Move forward \a adv of units in world-co, automatically jump
    * across segments, unless a end node is hit
    *
-   * @param adv in: the amount of advancment to be done, out: the
-   * amount of units that wheren't use on the given segment
-   * @param next_segment out: the next segment get written into this
+   * @param[in,out] adv the amount of advancment to be done, the
+   *                    amount of units that wheren't use on the given
+   *                    segment
    *
-   *  @return The amount of units left when hitting the end of the segment or 0.0f 
+   * @param[out] next_node if the advance ends at a node, it gets
+   *                       returned in next_node
    */
   void advance(float& adv, Node*& next_node);
-
+  
   Segment* get_segment() const { return segment; }
   float get_float_pos() const { return pos; }
 

Modified: trunk/windstille/src/windstille_main.hpp
===================================================================
--- trunk/windstille/src/windstille_main.hpp	2007-06-16 01:05:35 UTC (rev 1444)
+++ trunk/windstille/src/windstille_main.hpp	2007-06-16 04:03:52 UTC (rev 1445)
@@ -23,6 +23,34 @@
 **  02111-1307, USA.
 */
 
+/*! \mainpage Windstille Documentation
+ *
+ * \section intro_sec Introduction
+ *
+ * Windstille is a classic 2d jump'n shoot game in which the player
+ * will be placed in a foreign alien world and has to find its way
+ * back into safety. Windstille is currently available for GNU/Linux
+ * and Windows.  Its webpage at which one might find new versions,
+ * source code, artworks and more informations is located at:
+ *
+ * http://windstille.berlios.de/
+ *
+ * The latest development version can be obtained by:
+ * 
+ * $ svn co svn://svn.berlios.de/windstille/trunk/windstille
+ * 
+ * Windstille is covered under the GNU GPL, which means that you can copy
+ * and even modify it pretty much as you like, as long as you keep the
+ * copyright headers in place and distribute the source too if you
+ * distribute binaries, see the file COPYING for details.
+ *
+ * \section install_sec Installation
+ *
+ * To compile Windstille you need:
+ *
+ * OpenAL, OpenGL, SDL, SDL_image, freetype, libpng, physfs, boost, scons, bison, flex
+ */
+
 #ifndef HEADER_WINDSTILLE_WINDSTILLE_MAIN_HPP
 #define HEADER_WINDSTILLE_WINDSTILLE_MAIN_HPP
 



From grumbel at mail.berlios.de  Sat Jun 16 07:23:27 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 16 Jun 2007 07:23:27 +0200
Subject: [Windstille-commit] r1446 - in trunk/windstille/src: . math
	navigation
Message-ID: <200706160523.l5G5NRgp000992@sheep.berlios.de>

Author: grumbel
Date: 2007-06-16 07:23:27 +0200 (Sat, 16 Jun 2007)
New Revision: 1446

Modified:
   trunk/windstille/src/geometry_test.cpp
   trunk/windstille/src/math/vector.cpp
   trunk/windstille/src/math/vector.hpp
   trunk/windstille/src/navigation/connection.cpp
   trunk/windstille/src/navigation/connection.hpp
   trunk/windstille/src/navigation_test.cpp
Log:
- added some code to navigate around the navigation graph with a directional vector

Modified: trunk/windstille/src/geometry_test.cpp
===================================================================
--- trunk/windstille/src/geometry_test.cpp	2007-06-16 04:03:52 UTC (rev 1445)
+++ trunk/windstille/src/geometry_test.cpp	2007-06-16 05:23:27 UTC (rev 1446)
@@ -61,6 +61,13 @@
   Display::fill_rect(Rectf(cursor2 - Vector(2,2), Sizef(5,5)), Color(1.0f, 1.0f, 0.0f));
 
   Display::fill_rect(Rectf(collision_point - Vector(3,3), Sizef(7,7)), Color(1.0f, 1.0f, 1.0f));
+
+  // Try vector projection
+  Vector a(line1.p2 - line1.p1);
+  Vector b(line2.p2 - line2.p1);
+  Vector c(a.project(b));
+  
+  Display::draw_line(line1.p1, line1.p1 + c, Color(1.0f, 1.0f, 1.0f, 0.5f));
 }
 
 void

Modified: trunk/windstille/src/math/vector.cpp
===================================================================
--- trunk/windstille/src/math/vector.cpp	2007-06-16 04:03:52 UTC (rev 1445)
+++ trunk/windstille/src/math/vector.cpp	2007-06-16 05:23:27 UTC (rev 1446)
@@ -48,6 +48,26 @@
   return Vector(len * cos(angle), len * sin(angle));
 }
 
+Vector
+Vector::project(const Vector& b)
+{
+  float dp = this->dot(b);
+  return Vector((dp / (b.x*b.x + b.y*b.y) ) * b.x,
+                (dp / (b.x*b.x + b.y*b.y) ) * b.y);
+}
+
+float
+Vector::dot(const Vector& b)
+{
+  return (x * b.x + y * b.y);
+}
+
+bool
+Vector::is_null() const
+{
+  return (x == 0.0f && y == 0.0f);
+}
+
 std::ostream& operator<<(std::ostream& s, const Vector& v)
 {
   s << "(" << v.x << ", " << v.y << ")";

Modified: trunk/windstille/src/math/vector.hpp
===================================================================
--- trunk/windstille/src/math/vector.hpp	2007-06-16 04:03:52 UTC (rev 1445)
+++ trunk/windstille/src/math/vector.hpp	2007-06-16 05:23:27 UTC (rev 1446)
@@ -116,12 +116,19 @@
       return x*other.x + y*other.y;
     }
 
+  /** Project vecter a onto vector b and return the resulting vector */
+  Vector project(const Vector& b);
+
   float magnitude() const;
   float length() const { return magnitude(); }
 
   Vector unit() const;
-  void normalize();
+  void   normalize();
 
+  float dot(const Vector& b);
+
+  bool is_null() const;
+
   // ... add the other operators as needed, I'm too lazy now ...
 
   float x, y; // leave this public, get/set methods just give me headaches

Modified: trunk/windstille/src/navigation/connection.cpp
===================================================================
--- trunk/windstille/src/navigation/connection.cpp	2007-06-16 04:03:52 UTC (rev 1445)
+++ trunk/windstille/src/navigation/connection.cpp	2007-06-16 05:23:27 UTC (rev 1446)
@@ -76,6 +76,36 @@
     }
 }
 
+void
+Connection::advance(Vector& adv, Node*& next_node)
+{
+  // FIXME: This might be optimizable
+  Vector p1 = segment->get_node1()->get_pos();
+  Vector p2 = segment->get_node2()->get_pos();
+  
+  Vector segment_v = p2 - p1;
+
+  Vector proj = adv.project(segment_v);
+
+  float angle = atan2(segment_v.y, segment_v.x) - atan2(proj.y, proj.x);
+
+  // Check if we are going forward or backward
+  float advf;
+  if (angle > M_PI/2 || angle < -M_PI/2)
+    advf = -proj.length();
+  else
+    advf = proj.length();
+
+  // Move forward
+  advance(advf, next_node);
+  
+  // Calculate the rest Vector
+  if (advf == 0.0f)
+    adv = Vector(0,0);
+  else
+    adv -= (proj * ((proj.length() - advf)/proj.length()));
+}
+
 Vector
 Connection::get_pos() const
 {

Modified: trunk/windstille/src/navigation/connection.hpp
===================================================================
--- trunk/windstille/src/navigation/connection.hpp	2007-06-16 04:03:52 UTC (rev 1445)
+++ trunk/windstille/src/navigation/connection.hpp	2007-06-16 05:23:27 UTC (rev 1446)
@@ -47,20 +47,34 @@
 
   void set_pos(Segment* segment_, float pos_);
 
-  /** Move forward \a adv of units in world-co, automatically jump
-   * across segments, unless a end node is hit
+  /** Move forward \a adv of units in world-co, when a node is hit,
+   *  the function returns and let the user decide how to continue
    *
+   *  @param[in,out] adv the amount of advancment to be done, the
+   *                     amount of units that wheren't use on the
+   *                     given segment
+   *
+   *  @param[out] next_node if the advance ends at a node, it gets
+   *                        returned in next_node
+   */
+  void advance(float& adv, Node*& next_node);
+  
+  /** Move forward \a adv of units in world-co, when a node is hit,
+   *  the function returns and let the user decide how to
+   *  continue. \adv is projected onto the current segment to figure
+   *  out how far we should go
+   *
    * @param[in,out] adv the amount of advancment to be done, the
    *                    amount of units that wheren't use on the given
    *                    segment
    *
    * @param[out] next_node if the advance ends at a node, it gets
    *                       returned in next_node
-   */
-  void advance(float& adv, Node*& next_node);
-  
+   */  
+  void advance(Vector& adv, Node*& next_node);
+
   Segment* get_segment() const { return segment; }
-  float get_float_pos() const { return pos; }
+  float    get_float_pos() const { return pos; }
 
   Vector get_pos() const;
 

Modified: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-16 04:03:52 UTC (rev 1445)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-16 05:23:27 UTC (rev 1446)
@@ -139,9 +139,15 @@
   if (connection)
     {
       Node* next_node;
-      float advance = 512.0f * controller.get_axis_state(X2_AXIS) * delta;
+      //float advance = 512.0f * controller.get_axis_state(X2_AXIS) * delta;
+
+      // FIXME: xpad driver is buggy and reverses the Y2 axis
+      Vector advance(512.0f * controller.get_axis_state(X2_AXIS) * delta,
+                     -512.0f * controller.get_axis_state(Y2_AXIS) * delta);
+      
       connection->advance(advance, next_node);
-      if (advance != 0)
+      
+      if (!advance.is_null())
         {
           Segment* next_segment = 0;
           for(Node::Segments::iterator i = next_node->segments.begin(); i != next_node->segments.end(); ++i)



From grumbel at mail.berlios.de  Sat Jun 16 07:40:36 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 16 Jun 2007 07:40:36 +0200
Subject: [Windstille-commit] r1447 - trunk/windstille/src
Message-ID: <200706160540.l5G5eaSn001648@sheep.berlios.de>

Author: grumbel
Date: 2007-06-16 07:40:35 +0200 (Sat, 16 Jun 2007)
New Revision: 1447

Modified:
   trunk/windstille/src/navigation_test.cpp
   trunk/windstille/src/navigation_test.hpp
Log:
- added little line to show the current walking direction

Modified: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-16 05:23:27 UTC (rev 1446)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-16 05:40:35 UTC (rev 1447)
@@ -80,7 +80,12 @@
     Display::draw_line(selected_segment->get_line(), Color(1.0f, 1.0f, 1.0f, 1.0f));
 
   if (connection)
-    connection->draw();
+    {
+      connection->draw();
+      
+      Display::draw_line(connection->get_pos(), connection->get_pos() + 100.0f*stick,
+                         Color(1.0f, 1.0f, 1.0f, 1.0f));
+    }
 }
 
 void
@@ -142,13 +147,15 @@
       //float advance = 512.0f * controller.get_axis_state(X2_AXIS) * delta;
 
       // FIXME: xpad driver is buggy and reverses the Y2 axis
-      Vector advance(512.0f * controller.get_axis_state(X2_AXIS) * delta,
-                     -512.0f * controller.get_axis_state(Y2_AXIS) * delta);
+      stick = Vector(controller.get_axis_state(X2_AXIS),
+                     -controller.get_axis_state(Y2_AXIS));
       
+      Vector advance = delta * 512.0f * stick;
       connection->advance(advance, next_node);
       
       if (!advance.is_null())
-        {
+        { // FIXME: This should be a while loop, currently we are just
+          // discarding the rest movement
           Segment* next_segment = 0;
           for(Node::Segments::iterator i = next_node->segments.begin(); i != next_node->segments.end(); ++i)
             {

Modified: trunk/windstille/src/navigation_test.hpp
===================================================================
--- trunk/windstille/src/navigation_test.hpp	2007-06-16 05:23:27 UTC (rev 1446)
+++ trunk/windstille/src/navigation_test.hpp	2007-06-16 05:40:35 UTC (rev 1447)
@@ -38,6 +38,8 @@
 {
 private:
   Vector cursor;
+  Vector stick;
+  
   NavigationGraph* graph;
   Connection* connection;
 



From grumbel at mail.berlios.de  Sat Jun 16 17:57:52 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 16 Jun 2007 17:57:52 +0200
Subject: [Windstille-commit] r1448 - in trunk/windstille/src: . font gui
	lisp scripting tinygettext
Message-ID: <200706161557.l5GFvqTH000392@sheep.berlios.de>

Author: grumbel
Date: 2007-06-16 17:57:48 +0200 (Sat, 16 Jun 2007)
New Revision: 1448

Modified:
   trunk/windstille/src/console.cpp
   trunk/windstille/src/font/fonts.hpp
   trunk/windstille/src/gui/automap.cpp
   trunk/windstille/src/gui/automap.hpp
   trunk/windstille/src/gui/button.cpp
   trunk/windstille/src/gui/button.hpp
   trunk/windstille/src/gui/component.cpp
   trunk/windstille/src/gui/component.hpp
   trunk/windstille/src/gui/component_factory.cpp
   trunk/windstille/src/gui/component_factory.hpp
   trunk/windstille/src/gui/grid_component.cpp
   trunk/windstille/src/gui/grid_component.hpp
   trunk/windstille/src/gui/group_component.cpp
   trunk/windstille/src/gui/group_component.hpp
   trunk/windstille/src/gui/gui_manager.cpp
   trunk/windstille/src/gui/gui_manager.hpp
   trunk/windstille/src/gui/label.cpp
   trunk/windstille/src/gui/label.hpp
   trunk/windstille/src/gui/list_view.cpp
   trunk/windstille/src/gui/list_view.hpp
   trunk/windstille/src/gui/menu_component.cpp
   trunk/windstille/src/gui/menu_component.hpp
   trunk/windstille/src/gui/menu_item.cpp
   trunk/windstille/src/gui/menu_item.hpp
   trunk/windstille/src/gui/root_component.cpp
   trunk/windstille/src/gui/root_component.hpp
   trunk/windstille/src/gui/slider.cpp
   trunk/windstille/src/gui/slider.hpp
   trunk/windstille/src/gui/tab_component.cpp
   trunk/windstille/src/gui/tab_component.hpp
   trunk/windstille/src/gui/text_view.cpp
   trunk/windstille/src/gui/text_view.hpp
   trunk/windstille/src/lisp/parser.cpp
   trunk/windstille/src/lisp/parser.hpp
   trunk/windstille/src/math.hpp
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/particle_viewer.cpp
   trunk/windstille/src/particle_viewer.hpp
   trunk/windstille/src/response_curve.cpp
   trunk/windstille/src/screen_manager.cpp
   trunk/windstille/src/script_manager.cpp
   trunk/windstille/src/scripting/SConscript
   trunk/windstille/src/scripting/game_objects.cpp
   trunk/windstille/src/scripting/game_objects.hpp
   trunk/windstille/src/scripting/interface.cpp
   trunk/windstille/src/scripting/interface.hpp
   trunk/windstille/src/scripting/squirrel_error.cpp
   trunk/windstille/src/scripting/squirrel_error.hpp
   trunk/windstille/src/scripting/util.cpp
   trunk/windstille/src/scripting/util.hpp
   trunk/windstille/src/scripting/wrapper.cpp
   trunk/windstille/src/scripting/wrapper.hpp
   trunk/windstille/src/sector.cpp
   trunk/windstille/src/tinygettext/gettext.cpp
   trunk/windstille/src/tinygettext/gettext.hpp
   trunk/windstille/src/tinygettext/tinygettext.cpp
   trunk/windstille/src/tinygettext/tinygettext.hpp
   trunk/windstille/src/windstille_main.cpp
Log:
- renamed namespaces to lowercase
- turned Fonts into a class

Modified: trunk/windstille/src/console.cpp
===================================================================
--- trunk/windstille/src/console.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/console.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -469,7 +469,7 @@
           const SQChar *s;
           if (SQ_SUCCEEDED(sq_getstring(v,-2, &s)))
             {
-              console << s << " -> " << Scripting::squirrel2string(v, -1) << std::endl;
+              console << s << " -> " << scripting::squirrel2string(v, -1) << std::endl;
             }
           else
             {
@@ -509,7 +509,7 @@
         if(SQ_SUCCEEDED(sq_call(vm,1, retval, true))) 
           {
             if (sq_gettype(vm, -1) != OT_NULL)
-              console << Scripting::squirrel2string(vm, -1) << std::endl;
+              console << scripting::squirrel2string(vm, -1) << std::endl;
           }
       }
     }

Modified: trunk/windstille/src/font/fonts.hpp
===================================================================
--- trunk/windstille/src/font/fonts.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/font/fonts.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -28,19 +28,18 @@
 
 #include "ttf_font.hpp"
 
-namespace Fonts {
+class Fonts {
+public:
+  static TTFFont* ttffont;
+  static TTFFont* vera12;
+  static TTFFont* vera16;
+  static TTFFont* vera20;
+  static TTFFont* vera28;
 
-extern TTFFont* ttffont;
-extern TTFFont* vera12;
-extern TTFFont* vera16;
-extern TTFFont* vera20;
-extern TTFFont* vera28;
+  static void init();
+  static void deinit();
+};
 
-void init();
-void deinit();
-
-} // namespace Fonts
-
 #endif
 
 /* EOF */

Modified: trunk/windstille/src/gui/automap.cpp
===================================================================
--- trunk/windstille/src/gui/automap.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/automap.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -30,7 +30,7 @@
 #include "display/display.hpp"
 #include "automap.hpp"
 
-namespace GUI {
+namespace gui {
 
 Automap::Automap(const lisp::Lisp* lisp, Component* parent)
   : Component(parent)
@@ -133,6 +133,6 @@
     }
 }
 
-} // namespace GUI
+} // namespace gui
 
 /* EOF */

Modified: trunk/windstille/src/gui/automap.hpp
===================================================================
--- trunk/windstille/src/gui/automap.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/automap.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -29,7 +29,7 @@
 #include "display/surface.hpp"
 #include "component.hpp"
 
-namespace GUI {
+namespace gui {
 
 /** */
 class Automap : public Component
@@ -52,7 +52,7 @@
   Automap& operator= (const Automap&);
 };
 
-} // namespace GUI
+} // namespace gui
 
 #endif
 

Modified: trunk/windstille/src/gui/button.cpp
===================================================================
--- trunk/windstille/src/gui/button.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/button.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -28,7 +28,7 @@
 #include "input/controller.hpp"
 #include "button.hpp"
 
-namespace GUI {
+namespace gui {
 
 Button::Button(const lisp::Lisp* lisp, Component* parent)
   : Component(parent)
@@ -78,6 +78,6 @@
     }  
 }
 
-} // namespace GUI
+} // namespace gui
 
 /* EOF */

Modified: trunk/windstille/src/gui/button.hpp
===================================================================
--- trunk/windstille/src/gui/button.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/button.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -30,7 +30,7 @@
 #include "lisp/lisp.hpp"
 #include "component.hpp"
 
-namespace GUI {
+namespace gui {
 
 /** */
 class Button : public Component
@@ -51,7 +51,7 @@
   Button& operator= (const Button&);
 };
 
-} // namespace GUI
+} // namespace gui
 
 #endif
 

Modified: trunk/windstille/src/gui/component.cpp
===================================================================
--- trunk/windstille/src/gui/component.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/component.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -26,7 +26,7 @@
 #include <assert.h>
 #include "component.hpp"
 
-namespace GUI {
+namespace gui {
 
 Component::Component(Component* parent)
   : parent(parent),
@@ -85,6 +85,6 @@
   return 100.0f;
 }
 
-} // namespace GUI
+} // namespace gui
 
 /* EOF */

Modified: trunk/windstille/src/gui/component.hpp
===================================================================
--- trunk/windstille/src/gui/component.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/component.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -30,7 +30,7 @@
 
 class Controller;
 
-namespace GUI {
+namespace gui {
 
 /** */
 class Component
@@ -63,7 +63,7 @@
   Component& operator= (const Component&);
 };
 
-} // namespace GUI
+} // namespace gui
 
 #endif
 

Modified: trunk/windstille/src/gui/component_factory.cpp
===================================================================
--- trunk/windstille/src/gui/component_factory.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/component_factory.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -30,7 +30,7 @@
 #include "button.hpp"
 #include "component_factory.hpp"
 
-namespace GUI {
+namespace gui {
 
 ComponentFactory::ComponentFactory()
 {
@@ -65,6 +65,6 @@
     }
 }
 
-} // namespace GUI
+} // namespace gui
 
 /* EOF */

Modified: trunk/windstille/src/gui/component_factory.hpp
===================================================================
--- trunk/windstille/src/gui/component_factory.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/component_factory.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -29,7 +29,7 @@
 #include <string>
 #include "lisp/lisp.hpp"
 
-namespace GUI {
+namespace gui {
 
 class Component;
 
@@ -48,7 +48,7 @@
   ComponentFactory& operator= (const ComponentFactory&);
 };
 
-} // namespace GUI
+} // namespace gui
 
 #endif
 

Modified: trunk/windstille/src/gui/grid_component.cpp
===================================================================
--- trunk/windstille/src/gui/grid_component.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/grid_component.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -28,7 +28,7 @@
 #include "input/controller.hpp"
 #include "grid_component.hpp"
 
-namespace GUI {
+namespace gui {
 
 GridComponent::GridComponent(const lisp::Lisp* lisp, Component* parent)
   : Component(parent)
@@ -241,6 +241,6 @@
   //grid(pos.x, pos.y).component->set_active(true);
 }
 
-} // namespace GUI
+} // namespace gui
 
 /* EOF */

Modified: trunk/windstille/src/gui/grid_component.hpp
===================================================================
--- trunk/windstille/src/gui/grid_component.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/grid_component.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -30,7 +30,7 @@
 #include "field.hpp"
 #include "component.hpp"
 
-namespace GUI {
+namespace gui {
 
 /** */
 class GridComponent : public Component
@@ -85,7 +85,7 @@
   GridComponent& operator= (const GridComponent&);
 };
 
-} // namespace GUI
+} // namespace gui
 
 #endif
 

Modified: trunk/windstille/src/gui/group_component.cpp
===================================================================
--- trunk/windstille/src/gui/group_component.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/group_component.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -29,7 +29,7 @@
 #include "font/fonts.hpp"
 #include "group_component.hpp"
 
-namespace GUI {
+namespace gui {
 
 GroupComponent::GroupComponent(const Rectf& rect, const std::string& title_, Component* parent)
   : Component(rect, parent),
@@ -104,6 +104,6 @@
   // child->get_prefered_height();
 }
 
-} // namespace GUI
+} // namespace gui
 
 /* EOF */

Modified: trunk/windstille/src/gui/group_component.hpp
===================================================================
--- trunk/windstille/src/gui/group_component.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/group_component.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -29,7 +29,7 @@
 #include <string>
 #include "component.hpp"
 
-namespace GUI {
+namespace gui {
 
 /** */
 class GroupComponent : public Component
@@ -54,7 +54,7 @@
   GroupComponent& operator= (const GroupComponent&);
 };
 
-} // namespace GUI
+} // namespace gui
 
 #endif
 

Modified: trunk/windstille/src/gui/gui_manager.cpp
===================================================================
--- trunk/windstille/src/gui/gui_manager.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/gui_manager.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -35,7 +35,7 @@
 #include "automap.hpp"
 #include "gui_manager.hpp"
 
-namespace GUI {
+namespace gui {
 
 GUIManager::GUIManager()
 {
@@ -70,6 +70,6 @@
   return root;
 }
 
-} // namespace GUI
+} // namespace gui
 
 /* EOF */

Modified: trunk/windstille/src/gui/gui_manager.hpp
===================================================================
--- trunk/windstille/src/gui/gui_manager.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/gui_manager.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -28,7 +28,7 @@
 
 #include "screen.hpp"
 
-namespace GUI {
+namespace gui {
 
 class RootComponent;
 
@@ -51,7 +51,7 @@
   GUIManager& operator= (const GUIManager&);
 };
 
-} // namespace GUI
+} // namespace gui
 
 #endif
 

Modified: trunk/windstille/src/gui/label.cpp
===================================================================
--- trunk/windstille/src/gui/label.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/label.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -26,7 +26,7 @@
 #include "font/fonts.hpp"
 #include "label.hpp"
 
-namespace GUI {
+namespace gui {
 
 Label::Label(const std::string& label_)
   : Component(Rectf(), parent),
@@ -54,6 +54,6 @@
   set_active(false);
 }
 
-} // namespace GUI
+} // namespace gui
 
 /* EOF */

Modified: trunk/windstille/src/gui/label.hpp
===================================================================
--- trunk/windstille/src/gui/label.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/label.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -29,7 +29,7 @@
 #include <string>
 #include "component.hpp"
 
-namespace GUI {
+namespace gui {
 
 /** */
 class Label : public Component
@@ -49,7 +49,7 @@
   Label& operator= (const Label&);
 };
 
-} // namespace GUI
+} // namespace gui
 
 #endif
 

Modified: trunk/windstille/src/gui/list_view.cpp
===================================================================
--- trunk/windstille/src/gui/list_view.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/list_view.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -28,7 +28,7 @@
 #include "font/fonts.hpp"
 #include "list_view.hpp"
 
-namespace GUI {
+namespace gui {
 
 ListView::ListView(const Rectf& rect, Component* parent)
   : Component(rect, parent)
@@ -140,6 +140,6 @@
   items.push_back(item);
 }
 
-} // namespace GUI
+} // namespace gui
 
 /* EOF */

Modified: trunk/windstille/src/gui/list_view.hpp
===================================================================
--- trunk/windstille/src/gui/list_view.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/list_view.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -30,7 +30,7 @@
 #include <string>
 #include "component.hpp"
 
-namespace GUI { 
+namespace gui { 
 
 /** */
 class ListView : public Component
@@ -78,7 +78,7 @@
   ListView& operator= (const ListView&);
 };
 
-} // namespace GUI 
+} // namespace gui 
 
 #endif
 

Modified: trunk/windstille/src/gui/menu_component.cpp
===================================================================
--- trunk/windstille/src/gui/menu_component.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/menu_component.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -32,7 +32,7 @@
 #include "menu_item.hpp"
 #include "math.hpp"
 
-namespace GUI {
+namespace gui {
 
 MenuComponent::MenuComponent(const Rectf& rect, bool allow_cancel_, Component* parent)
   : Component(rect, parent),
@@ -162,7 +162,7 @@
 
               if (dynamic_cast<TabComponent*>(parent))
                 {
-                  current_item = Math::mid(0, current_item + 1, static_cast<int>(items.size()-1)); 
+                  current_item = math::mid(0, current_item + 1, static_cast<int>(items.size()-1)); 
                 }
               else
                 {
@@ -240,6 +240,6 @@
     }  
 }
 
-} // namespace GUI
+} // namespace gui
 
 /* EOF */

Modified: trunk/windstille/src/gui/menu_component.hpp
===================================================================
--- trunk/windstille/src/gui/menu_component.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/menu_component.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -33,7 +33,7 @@
 
 class TTFFont;
 
-namespace GUI {
+namespace gui {
 
 class MenuItem;
 
@@ -77,7 +77,7 @@
   MenuComponent& operator= (const MenuComponent&);
 };
 
-} // namespace GUI
+} // namespace gui
 
 #endif
 

Modified: trunk/windstille/src/gui/menu_item.cpp
===================================================================
--- trunk/windstille/src/gui/menu_item.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/menu_item.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -30,7 +30,7 @@
 
 #include "menu_item.hpp"
 
-namespace GUI {
+namespace gui {
 
 MenuItem::MenuItem(MenuComponent* parent_, const std::string& label_)
   : parent(parent_),
@@ -220,6 +220,6 @@
 {
 }
 
-} // namespace GUI
+} // namespace gui
 
 /* EOF */

Modified: trunk/windstille/src/gui/menu_item.hpp
===================================================================
--- trunk/windstille/src/gui/menu_item.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/menu_item.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -32,7 +32,7 @@
 #include "signals/signal_v1.hpp"
 #include "signals/signal_v0.hpp"
 
-namespace GUI {
+namespace gui {
 
 class MenuComponent;
 
@@ -107,7 +107,7 @@
   Signal_v0& sig_click() { return on_click; }
 };
 
-} // namespace GUI
+} // namespace gui
 
 #endif
 

Modified: trunk/windstille/src/gui/root_component.cpp
===================================================================
--- trunk/windstille/src/gui/root_component.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/root_component.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -28,7 +28,7 @@
 #include "input/controller.hpp"
 #include "root_component.hpp"
 
-namespace GUI {
+namespace gui {
 
 RootComponent::RootComponent(const Rectf& rect)
   : Component(rect, 0),
@@ -93,6 +93,6 @@
     }
 }
 
-} // namespace GUI
+} // namespace gui
 
 /* EOF */

Modified: trunk/windstille/src/gui/root_component.hpp
===================================================================
--- trunk/windstille/src/gui/root_component.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/root_component.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -29,7 +29,7 @@
 #include <vector>
 #include "component.hpp"
 
-namespace GUI {
+namespace gui {
 
 /** */
 class RootComponent : public Component
@@ -60,7 +60,7 @@
   RootComponent& operator= (const RootComponent&);
 };
 
-} // namespace GUI
+} // namespace gui
 
 #endif
 

Modified: trunk/windstille/src/gui/slider.cpp
===================================================================
--- trunk/windstille/src/gui/slider.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/slider.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -28,7 +28,7 @@
 #include "color.hpp"
 #include "slider.hpp"
 
-namespace GUI {
+namespace gui {
 
 Slider::Slider(Component* parent)
   : Component(parent),
@@ -139,6 +139,6 @@
   pos = pos_;
 }
 
-} // namespace GUI
+} // namespace gui
 
 /* EOF */

Modified: trunk/windstille/src/gui/slider.hpp
===================================================================
--- trunk/windstille/src/gui/slider.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/slider.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -28,7 +28,7 @@
 
 #include "component.hpp"
 
-namespace GUI {
+namespace gui {
 
 /** */
 class Slider : public Component
@@ -60,7 +60,7 @@
   Slider& operator= (const Slider&);
 };
 
-} // namespace GUI
+} // namespace gui
 
 #endif
 

Modified: trunk/windstille/src/gui/tab_component.cpp
===================================================================
--- trunk/windstille/src/gui/tab_component.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/tab_component.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -28,7 +28,7 @@
 #include "display/display.hpp"
 #include "tab_component.hpp"
 
-namespace GUI {
+namespace gui {
 
 TabComponent::TabComponent(const lisp::Lisp* lisp, Component* parent)
   : Component(parent)
@@ -150,6 +150,6 @@
                                    ));
 }
 
-} // namespace GUI
+} // namespace gui
 
 /* EOF */

Modified: trunk/windstille/src/gui/tab_component.hpp
===================================================================
--- trunk/windstille/src/gui/tab_component.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/tab_component.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -31,7 +31,7 @@
 #include "lisp/lisp.hpp"
 #include "component.hpp"
 
-namespace GUI {
+namespace gui {
 
 /** */
 class TabComponent : public Component
@@ -67,7 +67,7 @@
   TabComponent& operator= (const TabComponent&);
 };
 
-} // namespace GUI
+} // namespace gui
 
 #endif
 

Modified: trunk/windstille/src/gui/text_view.cpp
===================================================================
--- trunk/windstille/src/gui/text_view.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/text_view.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -26,7 +26,7 @@
 #include "input/controller.hpp"
 #include "text_view.hpp"
 
-namespace GUI {
+namespace gui {
 
 TextView::TextView(const Rectf& rect, Component* component)
   : Component(rect, component),
@@ -84,6 +84,6 @@
   text_area.set_font(font);
 }
 
-} // namespace GUI
+} // namespace gui
 
 /* EOF */

Modified: trunk/windstille/src/gui/text_view.hpp
===================================================================
--- trunk/windstille/src/gui/text_view.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/gui/text_view.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -29,7 +29,7 @@
 #include "text_area.hpp"
 #include "component.hpp"
 
-namespace GUI {
+namespace gui {
 
 /** */
 class TextView : public Component
@@ -53,7 +53,7 @@
   TextView& operator= (const TextView&);
 };
 
-} // namespace GUI
+} // namespace gui
 
 #endif
 

Modified: trunk/windstille/src/lisp/parser.cpp
===================================================================
--- trunk/windstille/src/lisp/parser.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/lisp/parser.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -58,7 +58,7 @@
 Parser::Parser()
   : lexer(0), dictionary_manager(0), dictionary(0)
 {
-  dictionary_manager = new TinyGetText::DictionaryManager();
+  dictionary_manager = new tinygettext::DictionaryManager();
   dictionary_manager->set_charset("UTF-8");
 }
 

Modified: trunk/windstille/src/lisp/parser.hpp
===================================================================
--- trunk/windstille/src/lisp/parser.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/lisp/parser.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -22,7 +22,7 @@
 #include <string>
 #include "lexer.hpp"
 
-namespace TinyGetText {
+namespace tinygettext {
 class Dictionary;
 class DictionaryManager;
 }
@@ -48,8 +48,8 @@
   
   std::string filename;
   Lexer* lexer;
-  TinyGetText::DictionaryManager* dictionary_manager;
-  TinyGetText::Dictionary* dictionary;
+  tinygettext::DictionaryManager* dictionary_manager;
+  tinygettext::Dictionary* dictionary;
   Lexer::TokenType token;
 };
 

Modified: trunk/windstille/src/math.hpp
===================================================================
--- trunk/windstille/src/math.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/math.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -26,7 +26,7 @@
 #ifndef HEADER_MATH_HXX
 #define HEADER_MATH_HXX
 
-namespace Math {
+namespace math {
 
 template<class T> 
 T min (const T& a, const T& b) 
@@ -52,7 +52,7 @@
   return max<T>((a), min<T>((b), (c)));
 }
 
-} // namespace Math
+} // namespace math
 
 #endif
 

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -52,7 +52,7 @@
 void
 MenuManager::display_option_menu()
 {
-  using namespace GUI;
+  using namespace gui;
   GUIManager* manager = new GUIManager();
 
   GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 300-170), Sizef(500, 340)), 
@@ -113,7 +113,7 @@
 void
 MenuManager::display_main_menu()
 {
-  using namespace GUI;
+  using namespace gui;
   GUIManager* manager = new GUIManager();
 
   GroupComponent* text_group = new GroupComponent(Rectf(10, 500+20, 800-10, 600-10),
@@ -187,7 +187,7 @@
 void
 MenuManager::display_pause_menu()
 {
-  using namespace GUI;
+  using namespace gui;
   GUIManager* manager = new GUIManager();
 
   GroupComponent* group = new GroupComponent(Rectf(Vector(400-200, 300-170), Sizef(400, 300)), 
@@ -238,7 +238,7 @@
 void
 MenuManager::display_models_menu()
 {
-  using namespace GUI;
+  using namespace gui;
   GUIManager* manager = new GUIManager();
 
   GroupComponent* group = new GroupComponent(Rectf(Vector(400-275, 100), Sizef(550, 376)),  // 378
@@ -283,7 +283,7 @@
 void
 MenuManager::display_particle_menu()
 {
-  using namespace GUI;
+  using namespace gui;
   GUIManager* manager = new GUIManager();
 
   GroupComponent* group = new GroupComponent(Rectf(Vector(400-200, 300-170), Sizef(400, 340)), 
@@ -317,7 +317,7 @@
 void
 MenuManager::display_scenario_menu()
 {
-  using namespace GUI;
+  using namespace gui;
   GUIManager* manager = new GUIManager();
 
   GroupComponent* group = new GroupComponent(Rectf(Vector(400-200, 300-170), Sizef(400, 340)), 
@@ -357,7 +357,7 @@
 void
 MenuManager::display_debug_menu()
 {
-  using namespace GUI;
+  using namespace gui;
   GUIManager* manager = new GUIManager();
 
   GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 300-170), Sizef(500, 340)), 
@@ -392,7 +392,7 @@
 void
 MenuManager::display_help()
 {
-  using namespace GUI;
+  using namespace gui;
   GUIManager* manager = new GUIManager();
 
   GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 300-200), Sizef(500, 400)), 
@@ -432,7 +432,7 @@
 void
 MenuManager::display_credits()
 {
-  using namespace GUI;
+  using namespace gui;
   GUIManager* manager = new GUIManager();
 
   GroupComponent* group = new GroupComponent(Rectf(Vector(400-250, 300-200), Sizef(500, 400)), 

Modified: trunk/windstille/src/particle_viewer.cpp
===================================================================
--- trunk/windstille/src/particle_viewer.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/particle_viewer.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -47,15 +47,15 @@
 {
 public:
   ParticleSystem* psystem;
-  GUI::GridComponent* grid;
-  GUI::Slider* gravity_slider;
-  GUI::Slider* velocity_slider;
-  GUI::Slider* count_slider;
+  gui::GridComponent* grid;
+  gui::Slider* gravity_slider;
+  gui::Slider* velocity_slider;
+  gui::Slider* count_slider;
   
-  ParticleSystemGUI(GUI::Component* parent, ParticleSystem* psystem_)
+  ParticleSystemGUI(gui::Component* parent, ParticleSystem* psystem_)
     : psystem(psystem_)
   {
-    using namespace GUI;
+    using namespace gui;
     grid = new GridComponent(Rectf(200, 120, 600, 220), 2, 3, parent);
     grid->set_padding(4);
 
@@ -89,7 +89,7 @@
     psystem->set_count(count_slider->get_pos());
   }
 
-  GUI::Component* get_component() { return grid; }
+  gui::Component* get_component() { return grid; }
 };
 
 ParticleViewer::ParticleViewer()
@@ -97,7 +97,7 @@
   background = Sprite("images/greychess.sprite");
   show_gui = false;
 
-  using namespace GUI;
+  using namespace gui;
 
   manager = new GUIManager();
   tab = new TabComponent(Rectf(200, 50, 600, 250), manager->get_root());

Modified: trunk/windstille/src/particle_viewer.hpp
===================================================================
--- trunk/windstille/src/particle_viewer.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/particle_viewer.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -31,7 +31,7 @@
 #include "gui/gui_manager.hpp"
 #include "particles/particle_system.hpp"
 
-namespace GUI {
+namespace gui {
 class Slider;
 class TabComponent;
 }
@@ -49,8 +49,8 @@
 
   Vector pos;
   bool   show_gui;
-  GUI::GUIManager* manager;
-  GUI::TabComponent* tab;
+  gui::GUIManager* manager;
+  gui::TabComponent* tab;
 
   typedef std::vector<ParticleSystemGUI*> ParticleSystemGUIs;
   ParticleSystemGUIs guis;

Modified: trunk/windstille/src/response_curve.cpp
===================================================================
--- trunk/windstille/src/response_curve.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/response_curve.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -50,7 +50,7 @@
     }
   else
     {
-      v = Math::mid(i_min, v, i_max);
+      v = math::mid(i_min, v, i_max);
 
       int   bucket_count = samples.size() - 1;
       float bucket_size  = (i_max - i_min) / bucket_count;

Modified: trunk/windstille/src/screen_manager.cpp
===================================================================
--- trunk/windstille/src/screen_manager.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/screen_manager.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -51,7 +51,7 @@
 #include "gui/automap.hpp"
 
 
-using GUI::GUIManager;
+using gui::GUIManager;
 
 ScreenManager screen_manager; 
 

Modified: trunk/windstille/src/script_manager.cpp
===================================================================
--- trunk/windstille/src/script_manager.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/script_manager.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -18,7 +18,7 @@
 #include "scripting/squirrel_error.hpp"
 #include "physfs/physfs_stream.hpp"
 
-using namespace Scripting;
+using namespace scripting;
 
 ScriptManager* script_manager = 0;
 

Modified: trunk/windstille/src/scripting/SConscript
===================================================================
--- trunk/windstille/src/scripting/SConscript	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/scripting/SConscript	2007-06-16 15:57:48 UTC (rev 1448)
@@ -11,7 +11,7 @@
             ['interface.hpp', 'game_objects.hpp'])
 
 env.Depends(env.Command(['wrapper.cpp', 'wrapper.hpp'], 'miniswig.tmp',
-                        ["$MINISWIG  --input $SOURCE --output-cpp ${TARGETS[0]} --output-hpp ${TARGETS[1]} --module windstille --select-namespace Scripting"]),
+                        ["$MINISWIG  --input $SOURCE --output-cpp ${TARGETS[0]} --output-hpp ${TARGETS[1]} --module windstille --select-namespace scripting"]),
             miniswig)
 
 # EOF #

Modified: trunk/windstille/src/scripting/game_objects.cpp
===================================================================
--- trunk/windstille/src/scripting/game_objects.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/scripting/game_objects.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -3,7 +3,7 @@
 #include "sector.hpp"
 #include "game_objects.hpp"
 
-namespace Scripting
+namespace scripting
 {
 
 const std::string&

Modified: trunk/windstille/src/scripting/game_objects.hpp
===================================================================
--- trunk/windstille/src/scripting/game_objects.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/scripting/game_objects.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -15,7 +15,7 @@
 typedef Entity _Entity;
 #endif
 
-namespace Scripting
+namespace scripting
 {
 
 class GameObject

Modified: trunk/windstille/src/scripting/interface.cpp
===================================================================
--- trunk/windstille/src/scripting/interface.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/scripting/interface.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -40,7 +40,7 @@
 #include "display/display.hpp"
 #include "controller_help_window.hpp"
 
-namespace Scripting
+namespace scripting
 {
 
 void set_sector(const std::string& filename)
@@ -338,6 +338,6 @@
   return 0;
 }
 
-} // namespace Scripting
+} // namespace scripting
 
 /* EOF */

Modified: trunk/windstille/src/scripting/interface.hpp
===================================================================
--- trunk/windstille/src/scripting/interface.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/scripting/interface.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -31,7 +31,7 @@
 #include <squirrel.h>
 #endif
 
-namespace Scripting {
+namespace scripting {
 
 void set_sector(const std::string& filename);
 
@@ -122,7 +122,7 @@
  */
 SQInteger spawn_object(HSQUIRRELVM v) __custom;
 
-} // namespace Scripting
+} // namespace scripting
 
 #endif
 

Modified: trunk/windstille/src/scripting/squirrel_error.cpp
===================================================================
--- trunk/windstille/src/scripting/squirrel_error.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/scripting/squirrel_error.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -3,7 +3,7 @@
 #include "squirrel_error.hpp"
 #include <sstream>
 
-namespace Scripting
+namespace scripting
 {
 
 SquirrelError::SquirrelError(HSQUIRRELVM v, const std::string& message) throw()

Modified: trunk/windstille/src/scripting/squirrel_error.hpp
===================================================================
--- trunk/windstille/src/scripting/squirrel_error.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/scripting/squirrel_error.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -4,7 +4,7 @@
 #include <squirrel.h>
 #include <stdexcept>
 
-namespace Scripting
+namespace scripting
 {
 
 /** Exception class for squirrel errors, it takes a squirrelvm and uses

Modified: trunk/windstille/src/scripting/util.cpp
===================================================================
--- trunk/windstille/src/scripting/util.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/scripting/util.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -35,7 +35,7 @@
 
 #include "util.hpp"
 
-namespace Scripting {
+namespace scripting {
 
 std::string sq_to_lisp_string(std::string sq_str)
 {
@@ -419,6 +419,6 @@
   writer.end_list("squirrel-state");
 }
 
-} // namespace Scripting
+} // namespace scripting
 
 /* EOF */

Modified: trunk/windstille/src/scripting/util.hpp
===================================================================
--- trunk/windstille/src/scripting/util.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/scripting/util.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -33,7 +33,7 @@
 class Writer;
 };
 
-namespace Scripting {
+namespace scripting {
 
 // Squirrel to Lisp
 void        table_to_lisp(HSQUIRRELVM v, int table_idx, std::vector<lisp::Lisp*>& entries);
@@ -51,7 +51,7 @@
 void save_squirrel_table(HSQUIRRELVM v, int table_idx, const std::string& file);
 void load_squirrel_table(HSQUIRRELVM v, int table_idx, const std::string& file);
 
-} // namespace Scripting
+} // namespace scripting
 
 #endif
 

Modified: trunk/windstille/src/scripting/wrapper.cpp
===================================================================
--- trunk/windstille/src/scripting/wrapper.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/scripting/wrapper.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -13,14 +13,14 @@
 #include "squirrel_error.hpp"
 #include "wrapper.interface.hpp"
 
-namespace Scripting
+namespace scripting
 {
 namespace Wrapper
 {
 
 static SQInteger GameObject_release_hook(SQUserPointer ptr, SQInteger )
 {
-  Scripting::GameObject* _this = reinterpret_cast<Scripting::GameObject*> (ptr);
+  scripting::GameObject* _this = reinterpret_cast<scripting::GameObject*> (ptr);
   delete _this;
   return 0;
 }
@@ -32,7 +32,7 @@
     sq_throwerror(vm, _SC("'get_name' called without instance"));
     return SQ_ERROR;
   }
-  Scripting::GameObject* _this = reinterpret_cast<Scripting::GameObject*> (data);
+  scripting::GameObject* _this = reinterpret_cast<scripting::GameObject*> (data);
   
   try {
     const std::string& return_value = _this->get_name();
@@ -57,7 +57,7 @@
     sq_throwerror(vm, _SC("'remove' called without instance"));
     return SQ_ERROR;
   }
-  Scripting::GameObject* _this = reinterpret_cast<Scripting::GameObject*> (data);
+  scripting::GameObject* _this = reinterpret_cast<scripting::GameObject*> (data);
   
   try {
     _this->remove();
@@ -81,7 +81,7 @@
     sq_throwerror(vm, _SC("'set_active' called without instance"));
     return SQ_ERROR;
   }
-  Scripting::GameObject* _this = reinterpret_cast<Scripting::GameObject*> (data);
+  scripting::GameObject* _this = reinterpret_cast<scripting::GameObject*> (data);
   SQBool arg0;
   if(SQ_FAILED(sq_getbool(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a bool"));
@@ -110,7 +110,7 @@
     sq_throwerror(vm, _SC("'set_parent' called without instance"));
     return SQ_ERROR;
   }
-  Scripting::GameObject* _this = reinterpret_cast<Scripting::GameObject*> (data);
+  scripting::GameObject* _this = reinterpret_cast<scripting::GameObject*> (data);
   const SQChar* arg0;
   if(SQ_FAILED(sq_getstring(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a string"));
@@ -134,7 +134,7 @@
 
 static SQInteger TestObject_release_hook(SQUserPointer ptr, SQInteger )
 {
-  Scripting::TestObject* _this = reinterpret_cast<Scripting::TestObject*> (ptr);
+  scripting::TestObject* _this = reinterpret_cast<scripting::TestObject*> (ptr);
   delete _this;
   return 0;
 }
@@ -146,7 +146,7 @@
     sq_throwerror(vm, _SC("'set_sprite' called without instance"));
     return SQ_ERROR;
   }
-  Scripting::TestObject* _this = reinterpret_cast<Scripting::TestObject*> (data);
+  scripting::TestObject* _this = reinterpret_cast<scripting::TestObject*> (data);
   const SQChar* arg0;
   if(SQ_FAILED(sq_getstring(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a string"));
@@ -175,7 +175,7 @@
     sq_throwerror(vm, _SC("'set_action' called without instance"));
     return SQ_ERROR;
   }
-  Scripting::TestObject* _this = reinterpret_cast<Scripting::TestObject*> (data);
+  scripting::TestObject* _this = reinterpret_cast<scripting::TestObject*> (data);
   const SQChar* arg0;
   if(SQ_FAILED(sq_getstring(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a string"));
@@ -204,7 +204,7 @@
     sq_throwerror(vm, _SC("'set_pos' called without instance"));
     return SQ_ERROR;
   }
-  Scripting::TestObject* _this = reinterpret_cast<Scripting::TestObject*> (data);
+  scripting::TestObject* _this = reinterpret_cast<scripting::TestObject*> (data);
   SQFloat arg0;
   if(SQ_FAILED(sq_getfloat(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a float"));
@@ -238,7 +238,7 @@
     sq_throwerror(vm, _SC("'set_vflip' called without instance"));
     return SQ_ERROR;
   }
-  Scripting::TestObject* _this = reinterpret_cast<Scripting::TestObject*> (data);
+  scripting::TestObject* _this = reinterpret_cast<scripting::TestObject*> (data);
   SQBool arg0;
   if(SQ_FAILED(sq_getbool(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a bool"));
@@ -267,7 +267,7 @@
     sq_throwerror(vm, _SC("'attach' called without instance"));
     return SQ_ERROR;
   }
-  Scripting::TestObject* _this = reinterpret_cast<Scripting::TestObject*> (data);
+  scripting::TestObject* _this = reinterpret_cast<scripting::TestObject*> (data);
   const SQChar* arg0;
   if(SQ_FAILED(sq_getstring(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a string"));
@@ -296,7 +296,7 @@
 
 static SQInteger Player_release_hook(SQUserPointer ptr, SQInteger )
 {
-  Scripting::Player* _this = reinterpret_cast<Scripting::Player*> (ptr);
+  scripting::Player* _this = reinterpret_cast<scripting::Player*> (ptr);
   delete _this;
   return 0;
 }
@@ -308,7 +308,7 @@
     sq_throwerror(vm, _SC("'start_listening' called without instance"));
     return SQ_ERROR;
   }
-  Scripting::Player* _this = reinterpret_cast<Scripting::Player*> (data);
+  scripting::Player* _this = reinterpret_cast<scripting::Player*> (data);
   
   try {
     _this->start_listening();
@@ -332,7 +332,7 @@
     sq_throwerror(vm, _SC("'stop_listening' called without instance"));
     return SQ_ERROR;
   }
-  Scripting::Player* _this = reinterpret_cast<Scripting::Player*> (data);
+  scripting::Player* _this = reinterpret_cast<scripting::Player*> (data);
   
   try {
     _this->stop_listening();
@@ -351,7 +351,7 @@
 
 static SQInteger ScriptableObject_release_hook(SQUserPointer ptr, SQInteger )
 {
-  Scripting::ScriptableObject* _this = reinterpret_cast<Scripting::ScriptableObject*> (ptr);
+  scripting::ScriptableObject* _this = reinterpret_cast<scripting::ScriptableObject*> (ptr);
   delete _this;
   return 0;
 }
@@ -363,7 +363,7 @@
     sq_throwerror(vm, _SC("'move_to' called without instance"));
     return SQ_ERROR;
   }
-  Scripting::ScriptableObject* _this = reinterpret_cast<Scripting::ScriptableObject*> (data);
+  scripting::ScriptableObject* _this = reinterpret_cast<scripting::ScriptableObject*> (data);
   SQFloat arg0;
   if(SQ_FAILED(sq_getfloat(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a float"));
@@ -407,7 +407,7 @@
     sq_throwerror(vm, _SC("'start_flash' called without instance"));
     return SQ_ERROR;
   }
-  Scripting::ScriptableObject* _this = reinterpret_cast<Scripting::ScriptableObject*> (data);
+  scripting::ScriptableObject* _this = reinterpret_cast<scripting::ScriptableObject*> (data);
   SQFloat arg0;
   if(SQ_FAILED(sq_getfloat(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a float"));
@@ -438,7 +438,7 @@
   }
   
   try {
-    Scripting::set_sector(arg0);
+    scripting::set_sector(arg0);
   
     return 0;
   
@@ -461,7 +461,7 @@
   }
   
   try {
-    Scripting::play_music(arg0);
+    scripting::play_music(arg0);
   
     return 0;
   
@@ -484,7 +484,7 @@
   }
   
   try {
-    Scripting::stop_music(static_cast<float> (arg0));
+    scripting::stop_music(static_cast<float> (arg0));
   
     return 0;
   
@@ -507,7 +507,7 @@
   }
   
   try {
-    Scripting::play_sound(arg0);
+    scripting::play_sound(arg0);
   
     return 0;
   
@@ -535,7 +535,7 @@
   }
   
   try {
-    Scripting::caption_add(static_cast<int> (arg0), arg1);
+    scripting::caption_add(static_cast<int> (arg0), arg1);
   
     return 0;
   
@@ -554,7 +554,7 @@
   (void) vm;
   
   try {
-    Scripting::caption_clear();
+    scripting::caption_clear();
   
     return 0;
   
@@ -573,7 +573,7 @@
   (void) vm;
   
   try {
-    Scripting::caption_end();
+    scripting::caption_end();
   
     return 0;
   
@@ -596,7 +596,7 @@
   }
   
   try {
-    Scripting::camera_set_active(arg0 == SQTrue);
+    scripting::camera_set_active(arg0 == SQTrue);
   
     return 0;
   
@@ -615,7 +615,7 @@
   (void) vm;
   
   try {
-    Scripting::camera_continue_path();
+    scripting::camera_continue_path();
   
     return 0;
   
@@ -634,7 +634,7 @@
   (void) vm;
   
   try {
-    Scripting::camera_begin_path();
+    scripting::camera_begin_path();
   
     return 0;
   
@@ -667,7 +667,7 @@
   }
   
   try {
-    Scripting::camera_add_point(static_cast<float> (arg0), static_cast<float> (arg1), static_cast<float> (arg2));
+    scripting::camera_add_point(static_cast<float> (arg0), static_cast<float> (arg1), static_cast<float> (arg2));
   
     return 0;
   
@@ -686,7 +686,7 @@
   (void) vm;
   
   try {
-    Scripting::camera_end_path();
+    scripting::camera_end_path();
   
     return 0;
   
@@ -714,7 +714,7 @@
   }
   
   try {
-    Scripting::camera_set_pos(static_cast<float> (arg0), static_cast<float> (arg1));
+    scripting::camera_set_pos(static_cast<float> (arg0), static_cast<float> (arg1));
   
     return 0;
   
@@ -737,7 +737,7 @@
   }
   
   try {
-    Scripting::camera_set_zoom(static_cast<float> (arg0));
+    scripting::camera_set_zoom(static_cast<float> (arg0));
   
     return 0;
   
@@ -760,7 +760,7 @@
   }
   
   try {
-    Scripting::set_controller_help_active(arg0 == SQTrue);
+    scripting::set_controller_help_active(arg0 == SQTrue);
   
     return 0;
   
@@ -798,7 +798,7 @@
   }
   
   try {
-    Scripting::dialog_show(static_cast<int> (arg0), arg1, arg2, arg3);
+    scripting::dialog_show(static_cast<int> (arg0), arg1, arg2, arg3);
   
     return 0;
   
@@ -817,7 +817,7 @@
   HSQUIRRELVM arg0 = vm;
   
   try {
-    Scripting::wait_for_dialog(arg0);
+    scripting::wait_for_dialog(arg0);
   
     return sq_suspendvm(vm);
   
@@ -836,7 +836,7 @@
   HSQUIRRELVM arg0 = vm;
   
   try {
-    Scripting::wait_for_fade(arg0);
+    scripting::wait_for_fade(arg0);
   
     return sq_suspendvm(vm);
   
@@ -855,7 +855,7 @@
   HSQUIRRELVM arg0 = vm;
   
   try {
-    Scripting::wait_for_camera(arg0);
+    scripting::wait_for_camera(arg0);
   
     return sq_suspendvm(vm);
   
@@ -878,7 +878,7 @@
   }
   
   try {
-    Scripting::conversation_add(arg0);
+    scripting::conversation_add(arg0);
   
     return 0;
   
@@ -897,7 +897,7 @@
   (void) vm;
   
   try {
-    Scripting::conversation_show();
+    scripting::conversation_show();
   
     return 0;
   
@@ -915,7 +915,7 @@
 {
   
   try {
-    int return_value = Scripting::conversation_get_selection();
+    int return_value = scripting::conversation_get_selection();
   
     sq_pushinteger(vm, return_value);
     return 1;
@@ -935,7 +935,7 @@
   HSQUIRRELVM arg0 = vm;
   
   try {
-    Scripting::wait_for_conversation(arg0);
+    scripting::wait_for_conversation(arg0);
   
     return sq_suspendvm(vm);
   
@@ -963,7 +963,7 @@
   }
   
   try {
-    Scripting::add_objective(arg0, arg1);
+    scripting::add_objective(arg0, arg1);
   
     return 0;
   
@@ -986,7 +986,7 @@
   }
   
   try {
-    Scripting::objective_complete(arg0);
+    scripting::objective_complete(arg0);
   
     return 0;
   
@@ -1009,7 +1009,7 @@
   }
   
   try {
-    bool return_value = Scripting::is_objective_given(arg0);
+    bool return_value = scripting::is_objective_given(arg0);
   
     sq_pushbool(vm, return_value);
     return 1;
@@ -1033,7 +1033,7 @@
   }
   
   try {
-    bool return_value = Scripting::is_objective_complete(arg0);
+    bool return_value = scripting::is_objective_complete(arg0);
   
     sq_pushbool(vm, return_value);
     return 1;
@@ -1053,7 +1053,7 @@
   HSQUIRRELVM arg0 = vm;
   
   try {
-    bool return_value = Scripting::run_before(arg0);
+    bool return_value = scripting::run_before(arg0);
   
     sq_pushbool(vm, return_value);
     return 1;
@@ -1078,7 +1078,7 @@
   }
   
   try {
-    Scripting::save_state(arg0, arg1);
+    scripting::save_state(arg0, arg1);
   
     return 0;
   
@@ -1102,7 +1102,7 @@
   }
   
   try {
-    Scripting::load_state(arg0, arg1);
+    scripting::load_state(arg0, arg1);
   
     return 0;
   
@@ -1121,7 +1121,7 @@
   (void) vm;
   
   try {
-    Scripting::list_objects();
+    scripting::list_objects();
   
     return 0;
   
@@ -1144,7 +1144,7 @@
   }
   
   try {
-    Scripting::set_debug(arg0 == SQTrue);
+    scripting::set_debug(arg0 == SQTrue);
   
     return 0;
   
@@ -1162,7 +1162,7 @@
 {
   
   try {
-    bool return_value = Scripting::get_debug();
+    bool return_value = scripting::get_debug();
   
     sq_pushbool(vm, return_value);
     return 1;
@@ -1181,7 +1181,7 @@
 {
   
   try {
-    float return_value = Scripting::get_game_speed();
+    float return_value = scripting::get_game_speed();
   
     sq_pushfloat(vm, return_value);
     return 1;
@@ -1205,7 +1205,7 @@
   }
   
   try {
-    Scripting::set_game_speed(static_cast<float> (arg0));
+    scripting::set_game_speed(static_cast<float> (arg0));
   
     return 0;
   
@@ -1229,7 +1229,7 @@
   }
   
   try {
-    Scripting::wait(arg0, static_cast<float> (arg1));
+    scripting::wait(arg0, static_cast<float> (arg1));
   
     return sq_suspendvm(vm);
   
@@ -1245,12 +1245,12 @@
 
 static SQInteger display_wrapper(HSQUIRRELVM vm)
 {
-  return Scripting::display(vm);
+  return scripting::display(vm);
 }
 
 static SQInteger println_wrapper(HSQUIRRELVM vm)
 {
-  return Scripting::println(vm);
+  return scripting::println(vm);
 }
 
 static SQInteger set_console_font_wrapper(HSQUIRRELVM vm)
@@ -1267,7 +1267,7 @@
   }
   
   try {
-    Scripting::set_console_font(arg0, static_cast<int> (arg1));
+    scripting::set_console_font(arg0, static_cast<int> (arg1));
   
     return 0;
   
@@ -1290,7 +1290,7 @@
   }
   
   try {
-    Scripting::set_gamma(static_cast<float> (arg0));
+    scripting::set_gamma(static_cast<float> (arg0));
   
     return 0;
   
@@ -1323,7 +1323,7 @@
   }
   
   try {
-    Scripting::set_gamma_rgb(static_cast<float> (arg0), static_cast<float> (arg1), static_cast<float> (arg2));
+    scripting::set_gamma_rgb(static_cast<float> (arg0), static_cast<float> (arg1), static_cast<float> (arg2));
   
     return 0;
   
@@ -1342,7 +1342,7 @@
   (void) vm;
   
   try {
-    Scripting::show_config();
+    scripting::show_config();
   
     return 0;
   
@@ -1361,7 +1361,7 @@
   (void) vm;
   
   try {
-    Scripting::cutscene_begin();
+    scripting::cutscene_begin();
   
     return 0;
   
@@ -1380,7 +1380,7 @@
   (void) vm;
   
   try {
-    Scripting::cutscene_end();
+    scripting::cutscene_end();
   
     return 0;
   
@@ -1418,7 +1418,7 @@
   }
   
   try {
-    Scripting::internal_fadeout_rgb(static_cast<float> (arg0), static_cast<float> (arg1), static_cast<float> (arg2), static_cast<float> (arg3));
+    scripting::internal_fadeout_rgb(static_cast<float> (arg0), static_cast<float> (arg1), static_cast<float> (arg2), static_cast<float> (arg3));
   
     return 0;
   
@@ -1441,7 +1441,7 @@
   }
   
   try {
-    Scripting::internal_fadein(static_cast<float> (arg0));
+    scripting::internal_fadein(static_cast<float> (arg0));
   
     return 0;
   
@@ -1459,7 +1459,7 @@
 {
   
   try {
-    int return_value = Scripting::render_mask_get();
+    int return_value = scripting::render_mask_get();
   
     sq_pushinteger(vm, return_value);
     return 1;
@@ -1483,7 +1483,7 @@
   }
   
   try {
-    Scripting::render_mask_set(static_cast<int> (arg0));
+    scripting::render_mask_set(static_cast<int> (arg0));
   
     return 0;
   
@@ -1499,12 +1499,12 @@
 
 static SQInteger spawn_object_wrapper(HSQUIRRELVM vm)
 {
-  return Scripting::spawn_object(vm);
+  return scripting::spawn_object(vm);
 }
 
 } // end of namespace Wrapper
 
-void create_squirrel_instance(HSQUIRRELVM v, Scripting::GameObject* object, bool setup_releasehook)
+void create_squirrel_instance(HSQUIRRELVM v, scripting::GameObject* object, bool setup_releasehook)
 {
   using namespace Wrapper;
 
@@ -1530,7 +1530,7 @@
   sq_remove(v, -2); // remove root table
 }
 
-void create_squirrel_instance(HSQUIRRELVM v, Scripting::TestObject* object, bool setup_releasehook)
+void create_squirrel_instance(HSQUIRRELVM v, scripting::TestObject* object, bool setup_releasehook)
 {
   using namespace Wrapper;
 
@@ -1556,7 +1556,7 @@
   sq_remove(v, -2); // remove root table
 }
 
-void create_squirrel_instance(HSQUIRRELVM v, Scripting::Player* object, bool setup_releasehook)
+void create_squirrel_instance(HSQUIRRELVM v, scripting::Player* object, bool setup_releasehook)
 {
   using namespace Wrapper;
 
@@ -1582,7 +1582,7 @@
   sq_remove(v, -2); // remove root table
 }
 
-void create_squirrel_instance(HSQUIRRELVM v, Scripting::ScriptableObject* object, bool setup_releasehook)
+void create_squirrel_instance(HSQUIRRELVM v, scripting::ScriptableObject* object, bool setup_releasehook)
 {
   using namespace Wrapper;
 
@@ -2072,5 +2072,5 @@
 
 }
 
-} // end of namespace Scripting
+} // end of namespace scripting
 

Modified: trunk/windstille/src/scripting/wrapper.hpp
===================================================================
--- trunk/windstille/src/scripting/wrapper.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/scripting/wrapper.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -9,15 +9,15 @@
 #include <squirrel.h>
 #include "wrapper.interface.hpp"
 
-namespace Scripting
+namespace scripting
 {
 
 void register_windstille_wrapper(HSQUIRRELVM v);
 
-void create_squirrel_instance(HSQUIRRELVM v, Scripting::GameObject* object, bool setup_releasehook = false);
-void create_squirrel_instance(HSQUIRRELVM v, Scripting::TestObject* object, bool setup_releasehook = false);
-void create_squirrel_instance(HSQUIRRELVM v, Scripting::Player* object, bool setup_releasehook = false);
-void create_squirrel_instance(HSQUIRRELVM v, Scripting::ScriptableObject* object, bool setup_releasehook = false);
+void create_squirrel_instance(HSQUIRRELVM v, scripting::GameObject* object, bool setup_releasehook = false);
+void create_squirrel_instance(HSQUIRRELVM v, scripting::TestObject* object, bool setup_releasehook = false);
+void create_squirrel_instance(HSQUIRRELVM v, scripting::Player* object, bool setup_releasehook = false);
+void create_squirrel_instance(HSQUIRRELVM v, scripting::ScriptableObject* object, bool setup_releasehook = false);
 
 }
 

Modified: trunk/windstille/src/sector.cpp
===================================================================
--- trunk/windstille/src/sector.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/sector.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -275,7 +275,7 @@
 void
 Sector::remove_object_from_squirrel(GameObject* object)
 {
-  using namespace Scripting;
+  using namespace scripting;
 
   // get objects table
   HSQUIRRELVM v = script_manager->get_vm();
@@ -307,30 +307,30 @@
 {
   ScriptableObject* script_obj = dynamic_cast<ScriptableObject*> (object);
   if(script_obj) {
-    create_squirrel_instance(v, new Scripting::ScriptableObject(script_obj),
+    create_squirrel_instance(v, new scripting::ScriptableObject(script_obj),
                              true);
     return;
   }
   
   TestObject* tobj = dynamic_cast<TestObject*> (object);
   if(tobj) {
-    create_squirrel_instance(v, new Scripting::TestObject(tobj), true);
+    create_squirrel_instance(v, new scripting::TestObject(tobj), true);
     return;
   }                                                                             
 
   Player* player = dynamic_cast<Player*> (object);
   if(player) {
-    create_squirrel_instance(v, new Scripting::Player(player), true);
+    create_squirrel_instance(v, new scripting::Player(player), true);
     return;
   }
 
-  create_squirrel_instance(v, new Scripting::GameObject(object), true);
+  create_squirrel_instance(v, new scripting::GameObject(object), true);
 }
 
 void
 Sector::expose_object_to_squirrel(GameObject* object)
 {
-  using namespace Scripting;
+  using namespace scripting;
 
   // get objects table
   HSQUIRRELVM v = script_manager->get_vm();

Modified: trunk/windstille/src/tinygettext/gettext.cpp
===================================================================
--- trunk/windstille/src/tinygettext/gettext.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/tinygettext/gettext.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -1,4 +1,4 @@
 #include "gettext.hpp"
 
-TinyGetText::DictionaryManager* dictionaryManager = 0;
+tinygettext::DictionaryManager* dictionaryManager = 0;
 

Modified: trunk/windstille/src/tinygettext/gettext.hpp
===================================================================
--- trunk/windstille/src/tinygettext/gettext.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/tinygettext/gettext.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -3,7 +3,7 @@
 
 #include "tinygettext/tinygettext.hpp"
 
-extern TinyGetText::DictionaryManager* dictionaryManager;
+extern tinygettext::DictionaryManager* dictionaryManager;
 
 static inline const char* _(const char* message)
 {

Modified: trunk/windstille/src/tinygettext/tinygettext.cpp
===================================================================
--- trunk/windstille/src/tinygettext/tinygettext.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/tinygettext/tinygettext.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -30,7 +30,7 @@
 
 //#define TRANSLATION_DEBUG
 
-namespace TinyGetText {
+namespace tinygettext {
 
 /** Convert \a which is in \a from_charset to \a to_charset and return it */
 std::string convert(const std::string& text,
@@ -720,6 +720,6 @@
   POFileReader reader(in, dict_);
 }
 
-} // namespace TinyGetText
+} // namespace tinygettext
 
 /* EOF */

Modified: trunk/windstille/src/tinygettext/tinygettext.hpp
===================================================================
--- trunk/windstille/src/tinygettext/tinygettext.hpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/tinygettext/tinygettext.hpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -24,7 +24,7 @@
 #include <set>
 #include <string>
 
-namespace TinyGetText {
+namespace tinygettext {
 
 typedef int (*PluralFunc)(int n);
 
@@ -151,7 +151,7 @@
 void read_po_file(Dictionary& dict, std::istream& in);
 LanguageDef& get_language_def(const std::string& name);
 
-} // namespace TinyGetText
+} // namespace tinygettext
 
 #endif
 

Modified: trunk/windstille/src/windstille_main.cpp
===================================================================
--- trunk/windstille/src/windstille_main.cpp	2007-06-16 05:40:35 UTC (rev 1447)
+++ trunk/windstille/src/windstille_main.cpp	2007-06-16 15:57:48 UTC (rev 1448)
@@ -69,7 +69,7 @@
     init_physfs(argv[0]);
     init_sdl();
 
-    dictionaryManager = new TinyGetText::DictionaryManager();
+    dictionaryManager = new tinygettext::DictionaryManager();
     dictionaryManager->set_charset("iso8859-1");
     dictionaryManager->add_directory("locale");
 



From grumbel at mail.berlios.de  Sat Jun 16 18:03:03 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 16 Jun 2007 18:03:03 +0200
Subject: [Windstille-commit] r1449 - trunk/windstille/test/physics
Message-ID: <200706161603.l5GG33DG000938@sheep.berlios.de>

Author: grumbel
Date: 2007-06-16 18:03:02 +0200 (Sat, 16 Jun 2007)
New Revision: 1449

Modified:
   trunk/windstille/test/physics/SConstruct
Log:
- updated for clanlib0.8

Modified: trunk/windstille/test/physics/SConstruct
===================================================================
--- trunk/windstille/test/physics/SConstruct	2007-06-16 15:57:48 UTC (rev 1448)
+++ trunk/windstille/test/physics/SConstruct	2007-06-16 16:03:02 UTC (rev 1449)
@@ -9,7 +9,7 @@
                   options=opts)
 Help(opts.GenerateHelpText(env))
 
-env.ParseConfig("pkg-config --cflags --libs clanCore-0.7 clanDisplay-0.7 clanGL-0.7 clanSignals-0.7")
+env.ParseConfig("pkg-config --cflags --libs clanCore-0.8 clanDisplay-0.8 clanGL-0.8 clanSignals-0.8")
 
 ptest = env.Program('main',
                     ['main.cxx', 'physics.cxx'])



From grumbel at mail.berlios.de  Sat Jun 16 18:14:36 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 16 Jun 2007 18:14:36 +0200
Subject: [Windstille-commit] r1450 - trunk/windstille
Message-ID: <200706161614.l5GGEadj002073@sheep.berlios.de>

Author: grumbel
Date: 2007-06-16 18:14:35 +0200 (Sat, 16 Jun 2007)
New Revision: 1450

Removed:
   trunk/windstille/contrib/
Log:
- removed unneeded directory



From grumbel at mail.berlios.de  Sat Jun 16 22:04:55 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 16 Jun 2007 22:04:55 +0200
Subject: [Windstille-commit] r1451 - in trunk/windstille/src: . math
	navigation
Message-ID: <200706162004.l5GK4tE5032412@sheep.berlios.de>

Author: grumbel
Date: 2007-06-16 22:04:55 +0200 (Sat, 16 Jun 2007)
New Revision: 1451

Added:
   trunk/windstille/src/navigation/segment_position.cpp
   trunk/windstille/src/navigation/segment_position.hpp
Removed:
   trunk/windstille/src/navigation/connection.cpp
   trunk/windstille/src/navigation/connection.hpp
Modified:
   trunk/windstille/src/SConscript
   trunk/windstille/src/math/line.cpp
   trunk/windstille/src/math/line.hpp
   trunk/windstille/src/navigation/navigation_graph.cpp
   trunk/windstille/src/navigation/navigation_graph.hpp
   trunk/windstille/src/navigation_test.cpp
   trunk/windstille/src/navigation_test.hpp
Log:
- renamed Connection to SegementPosition
- added some 'jump'n run' to the navigator test

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-16 16:14:35 UTC (rev 1450)
+++ trunk/windstille/src/SConscript	2007-06-16 20:04:55 UTC (rev 1451)
@@ -151,7 +151,7 @@
 'lisp/parser.cpp',
 'lisp/properties.cpp',
 'lisp/writer.cpp',
-'navigation/connection.cpp',
+'navigation/segment_position.cpp',
 'navigation/navigation_graph.cpp',
 'navigation/node.cpp',
 'navigation/segment.cpp',

Modified: trunk/windstille/src/math/line.cpp
===================================================================
--- trunk/windstille/src/math/line.cpp	2007-06-16 16:14:35 UTC (rev 1450)
+++ trunk/windstille/src/math/line.cpp	2007-06-16 20:04:55 UTC (rev 1451)
@@ -39,6 +39,13 @@
 }
 
 bool
+Line::intersect(const Line& line_b) const
+{
+  float ua, ub;
+  return intersect(line_b, ua, ub);
+}
+
+bool
 Line::intersect(const Line& line, float& ua, float& ub) const
 {
   const float& x1 = p1.x;

Modified: trunk/windstille/src/math/line.hpp
===================================================================
--- trunk/windstille/src/math/line.hpp	2007-06-16 16:14:35 UTC (rev 1450)
+++ trunk/windstille/src/math/line.hpp	2007-06-16 20:04:55 UTC (rev 1451)
@@ -43,6 +43,9 @@
   
   float length() const;
 
+  /** Calculate if two lines intersec */
+  bool intersect(const Line& line_b) const;
+
   /** Calculate if and where two lines intersect
    *  @param a  
    *  @param b 

Deleted: trunk/windstille/src/navigation/connection.cpp
===================================================================
--- trunk/windstille/src/navigation/connection.cpp	2007-06-16 16:14:35 UTC (rev 1450)
+++ trunk/windstille/src/navigation/connection.cpp	2007-06-16 20:04:55 UTC (rev 1451)
@@ -1,125 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include "segment.hpp"
-#include "node.hpp"
-#include "display/display.hpp"
-#include "connection.hpp"
-
-Connection::Connection(Segment* segment_, float pos_)
-  : segment(segment_),
-    pos(pos_)
-{  
-}
-
-void
-Connection::set_pos(Segment* segment_, float pos_)
-{
-  segment = segment_;
-  pos     = pos_;
-}
-
-void
-Connection::advance(float& adv, Node*& next_node)
-{
-  Vector p1 = segment->get_node1()->get_pos();
-  Vector p2 = segment->get_node2()->get_pos();
-  
-  float length = (p2 - p1).length();
-  
-  // convert from world co to [0,1] range
-  float adv_01 = adv / length;
-
-  if (adv_01 > 0)
-    {
-      pos += adv_01;
-      if (pos > 1.0f) {
-        adv = (pos - 1.0f) * length;
-        pos = 1.0f;
-        next_node = segment->get_node2();
-      } else {
-        adv = 0;
-      }
-    }
-  else
-    {
-      pos += adv_01;
-      if (pos < 0.0f) {
-        adv = pos * length;
-        pos = 0;
-        next_node = segment->get_node1();
-      } else {
-        adv = 0;
-      }
-    }
-}
-
-void
-Connection::advance(Vector& adv, Node*& next_node)
-{
-  // FIXME: This might be optimizable
-  Vector p1 = segment->get_node1()->get_pos();
-  Vector p2 = segment->get_node2()->get_pos();
-  
-  Vector segment_v = p2 - p1;
-
-  Vector proj = adv.project(segment_v);
-
-  float angle = atan2(segment_v.y, segment_v.x) - atan2(proj.y, proj.x);
-
-  // Check if we are going forward or backward
-  float advf;
-  if (angle > M_PI/2 || angle < -M_PI/2)
-    advf = -proj.length();
-  else
-    advf = proj.length();
-
-  // Move forward
-  advance(advf, next_node);
-  
-  // Calculate the rest Vector
-  if (advf == 0.0f)
-    adv = Vector(0,0);
-  else
-    adv -= (proj * ((proj.length() - advf)/proj.length()));
-}
-
-Vector
-Connection::get_pos() const
-{
-  Vector p1 = segment->get_node1()->get_pos();
-  Vector p2 = segment->get_node2()->get_pos();
-
-  return p1 + pos*(p2 - p1);
-}
-
-void
-Connection::draw()
-{
-  Display::fill_circle(get_pos(), 16.0f, Color(0.0f, 0.0f, 1.0f));
-  Display::fill_circle(get_pos(), 8.0f, Color(0.0f, 1.0f, 1.0f));
-}
-
-/* EOF */

Deleted: trunk/windstille/src/navigation/connection.hpp
===================================================================
--- trunk/windstille/src/navigation/connection.hpp	2007-06-16 16:14:35 UTC (rev 1450)
+++ trunk/windstille/src/navigation/connection.hpp	2007-06-16 20:04:55 UTC (rev 1451)
@@ -1,89 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_CONNECTION_HPP
-#define HEADER_CONNECTION_HPP
-
-#include "math/vector.hpp"
-
-class Segment;
-class Node;
-
-/** 
- */
-class Connection // FIXME: Rename to SegmentContact
-{
-public:
-  Segment* segment;
-
-  /** Position on the segment, stored with range [0,1], not
-      world-co */
-  float pos;
-
-public:
-  Connection(Segment* segment_, float pos_);
-
-  void set_pos(Segment* segment_, float pos_);
-
-  /** Move forward \a adv of units in world-co, when a node is hit,
-   *  the function returns and let the user decide how to continue
-   *
-   *  @param[in,out] adv the amount of advancment to be done, the
-   *                     amount of units that wheren't use on the
-   *                     given segment
-   *
-   *  @param[out] next_node if the advance ends at a node, it gets
-   *                        returned in next_node
-   */
-  void advance(float& adv, Node*& next_node);
-  
-  /** Move forward \a adv of units in world-co, when a node is hit,
-   *  the function returns and let the user decide how to
-   *  continue. \adv is projected onto the current segment to figure
-   *  out how far we should go
-   *
-   * @param[in,out] adv the amount of advancment to be done, the
-   *                    amount of units that wheren't use on the given
-   *                    segment
-   *
-   * @param[out] next_node if the advance ends at a node, it gets
-   *                       returned in next_node
-   */  
-  void advance(Vector& adv, Node*& next_node);
-
-  Segment* get_segment() const { return segment; }
-  float    get_float_pos() const { return pos; }
-
-  Vector get_pos() const;
-
-  void draw();
-private:
-  Connection (const Connection&);
-  Connection& operator= (const Connection&);
-};
-
-#endif
-
-/* EOF */

Modified: trunk/windstille/src/navigation/navigation_graph.cpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-16 16:14:35 UTC (rev 1450)
+++ trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-16 20:04:55 UTC (rev 1451)
@@ -28,6 +28,7 @@
 #include "display/display.hpp"
 #include "node.hpp"
 #include "segment.hpp"
+#include "segment_position.hpp"
 #include "navigation_graph.hpp"
 
 NavigationGraph::NavigationGraph()
@@ -115,24 +116,64 @@
   add_segment(node2, node3);  
 }
 
-std::vector<Segment*>
-NavigationGraph::find_segments(const Line& line)
+std::vector<SegmentPosition>
+NavigationGraph::find_intersections(const Line& line)
 {
-  return std::vector<Segment*>();
+
+  // FIXME: Return a navgraph pos here
+  std::vector<SegmentPosition> ret;
+ 
+  for(Segments::iterator i = segments.begin(); i != segments.end(); ++i)
+    {
+      Line seg_line((*i)->get_node1()->get_pos(),
+                    (*i)->get_node2()->get_pos());
+      
+      float ua, ub;
+      if (line.intersect(seg_line, ua, ub))
+        {
+          ret.push_back(SegmentPosition(*i, ub));
+        }
+    }
+
+  return ret;
 }
 
 std::vector<Node*>
 NavigationGraph::find_nodes(const Vector& pos, float radius)
 {
-  return std::vector<Node*>();
+  // FIXME: Optimize this with spatial tree thingy
+  std::vector<Node*> ret;
+
+  for(Nodes::iterator i = nodes.begin(); i != nodes.end(); ++i)
+    {
+      float distance = (pos - (*i)->get_pos()).length();
+      if (distance < radius)
+        {
+          ret.push_back(*i);
+        }
+    }
+  
+  return ret;
 }
 
 std::vector<Segment*>
 NavigationGraph::find_segments(const Vector& pos, float radius)
 {
-  return std::vector<Segment*>();
+  std::vector<Segment*> ret;
+ 
+  for(Segments::iterator i = segments.begin(); i != segments.end(); ++i)
+    {
+      float distance = Line((*i)->get_node1()->get_pos(),
+                            (*i)->get_node2()->get_pos()).distance(pos);
+      if (distance < radius)
+        {
+          ret.push_back(*i);
+        }
+    }
+
+  return ret;
 }
-
+
 Node*
 NavigationGraph::find_closest_node(const Vector& pos, float radius)
 {

Modified: trunk/windstille/src/navigation/navigation_graph.hpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-16 16:14:35 UTC (rev 1450)
+++ trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-16 20:04:55 UTC (rev 1451)
@@ -31,6 +31,7 @@
 
 class Node;
 class Segment;
+class SegmentPosition;
 
 /** */
 class NavigationGraph
@@ -56,13 +57,13 @@
 
   void split_segment(Segment* segment);
 
-  /** Find segments that collide with the given line */
-  std::vector<Segment*> find_segments(const Line& line);
+  /** Find segments that intersect with the given line */
+  std::vector<SegmentPosition> find_intersections(const Line& line);
 
   /** Find nodes that are near the given point */
   std::vector<Node*> find_nodes(const Vector& pos, float radius);
 
-  /** Find the closest node */
+  /** Find the closest node, limit search to nodes in radius */
   Node* find_closest_node(const Vector& pos, float radius);
 
   Segment* find_closest_segment(const Vector& pos, float radius);

Added: trunk/windstille/src/navigation/segment_position.cpp
===================================================================
--- trunk/windstille/src/navigation/segment_position.cpp	2007-06-16 16:14:35 UTC (rev 1450)
+++ trunk/windstille/src/navigation/segment_position.cpp	2007-06-16 20:04:55 UTC (rev 1451)
@@ -0,0 +1,125 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include "segment.hpp"
+#include "node.hpp"
+#include "display/display.hpp"
+#include "segment_position.hpp"
+
+SegmentPosition::SegmentPosition(Segment* segment_, float pos_)
+  : segment(segment_),
+    pos(pos_)
+{  
+}
+
+void
+SegmentPosition::set_pos(Segment* segment_, float pos_)
+{
+  segment = segment_;
+  pos     = pos_;
+}
+
+void
+SegmentPosition::advance(float& adv, Node*& next_node)
+{
+  Vector p1 = segment->get_node1()->get_pos();
+  Vector p2 = segment->get_node2()->get_pos();
+  
+  float length = (p2 - p1).length();
+  
+  // convert from world co to [0,1] range
+  float adv_01 = adv / length;
+
+  if (adv_01 > 0)
+    {
+      pos += adv_01;
+      if (pos > 1.0f) {
+        adv = (pos - 1.0f) * length;
+        pos = 1.0f;
+        next_node = segment->get_node2();
+      } else {
+        adv = 0;
+      }
+    }
+  else
+    {
+      pos += adv_01;
+      if (pos < 0.0f) {
+        adv = pos * length;
+        pos = 0;
+        next_node = segment->get_node1();
+      } else {
+        adv = 0;
+      }
+    }
+}
+
+void
+SegmentPosition::advance(Vector& adv, Node*& next_node)
+{
+  // FIXME: This might be optimizable
+  Vector p1 = segment->get_node1()->get_pos();
+  Vector p2 = segment->get_node2()->get_pos();
+  
+  Vector segment_v = p2 - p1;
+
+  Vector proj = adv.project(segment_v);
+
+  float angle = atan2(segment_v.y, segment_v.x) - atan2(proj.y, proj.x);
+
+  // Check if we are going forward or backward
+  float advf;
+  if (angle > M_PI/2 || angle < -M_PI/2)
+    advf = -proj.length();
+  else
+    advf = proj.length();
+
+  // Move forward
+  advance(advf, next_node);
+  
+  // Calculate the rest Vector
+  if (advf == 0.0f)
+    adv = Vector(0,0);
+  else
+    adv -= (proj * ((proj.length() - advf)/proj.length()));
+}
+
+Vector
+SegmentPosition::get_pos() const
+{
+  Vector p1 = segment->get_node1()->get_pos();
+  Vector p2 = segment->get_node2()->get_pos();
+
+  return p1 + pos*(p2 - p1);
+}
+
+void
+SegmentPosition::draw()
+{
+  Display::fill_circle(get_pos(), 16.0f, Color(0.0f, 0.0f, 1.0f, 0.5f));
+  Display::fill_circle(get_pos(), 8.0f, Color(0.0f, 1.0f, 1.0f));
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/navigation/segment_position.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/navigation/segment_position.hpp
===================================================================
--- trunk/windstille/src/navigation/segment_position.hpp	2007-06-16 16:14:35 UTC (rev 1450)
+++ trunk/windstille/src/navigation/segment_position.hpp	2007-06-16 20:04:55 UTC (rev 1451)
@@ -0,0 +1,86 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_CONNECTION_HPP
+#define HEADER_CONNECTION_HPP
+
+#include "math/vector.hpp"
+
+class Segment;
+class Node;
+
+/** 
+ */
+class SegmentPosition
+{
+public:
+  Segment* segment;
+
+  /** Position on the segment, stored with range [0,1], not
+      world-co */
+  float pos;
+
+public:
+  SegmentPosition(Segment* segment_, float pos_);
+
+  void set_pos(Segment* segment_, float pos_);
+
+  /** Move forward \a adv of units in world-co, when a node is hit,
+   *  the function returns and let the user decide how to continue
+   *
+   *  @param[in,out] adv the amount of advancment to be done, the
+   *                     amount of units that wheren't use on the
+   *                     given segment
+   *
+   *  @param[out] next_node if the advance ends at a node, it gets
+   *                        returned in next_node
+   */
+  void advance(float& adv, Node*& next_node);
+  
+  /** Move forward \a adv of units in world-co, when a node is hit,
+   *  the function returns and let the user decide how to
+   *  continue. \adv is projected onto the current segment to figure
+   *  out how far we should go
+   *
+   * @param[in,out] adv the amount of advancment to be done, the
+   *                    amount of units that wheren't use on the given
+   *                    segment
+   *
+   * @param[out] next_node if the advance ends at a node, it gets
+   *                       returned in next_node
+   */  
+  void advance(Vector& adv, Node*& next_node);
+
+  Segment* get_segment() const { return segment; }
+  float    get_float_pos() const { return pos; }
+
+  Vector get_pos() const;
+
+  void draw();
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/navigation/segment_position.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-16 16:14:35 UTC (rev 1450)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-16 20:04:55 UTC (rev 1451)
@@ -32,12 +32,13 @@
 #include "screen_manager.hpp"
 #include "navigation/navigation_graph.hpp"
 #include "navigation/node.hpp"
-#include "navigation/connection.hpp"
+#include "navigation/segment_position.hpp"
 #include "navigation/segment.hpp"
 #include "navigation_test.hpp"
 
 NavigationTest::NavigationTest()
   : cursor(400, 300),
+    player(200,200),
     graph(0),
     connection(0),
     selected_segment(0),
@@ -79,6 +80,8 @@
   if (selected_segment)
     Display::draw_line(selected_segment->get_line(), Color(1.0f, 1.0f, 1.0f, 1.0f));
 
+  Display::fill_circle(player, 12.0f, Color(0.0f, 0.0f, 1.0f, 1.0f));
+
   if (connection)
     {
       connection->draw();
@@ -97,9 +100,13 @@
       screen_manager.pop_screen();
     }
 
-  cursor.x += controller.get_axis_state(X_AXIS) * 500.0f * delta;
-  cursor.y += controller.get_axis_state(Y_AXIS) * 500.0f * delta;
+  cursor += Vector(controller.get_axis_state(X_AXIS) * 500.0f * delta,
+                   controller.get_axis_state(Y_AXIS) * 500.0f * delta);
 
+  // FIXME: xpad driver is buggy and reverses the Y2 axis
+  stick = Vector(controller.get_axis_state(X2_AXIS),
+                 -controller.get_axis_state(Y2_AXIS));
+
   if (controller.button_was_pressed(PRIMARY_BUTTON))
     {
       if (node_to_connect)
@@ -137,18 +144,15 @@
       if (selected_segment)
         {
           delete connection;
-          connection = new Connection(selected_segment, 0.5f);
+          connection = new SegmentPosition(selected_segment, 0.5f);
         }
     }
 
   if (connection)
-    {
+    { 
+      // Handle the movement of the connection
       Node* next_node;
       //float advance = 512.0f * controller.get_axis_state(X2_AXIS) * delta;
-
-      // FIXME: xpad driver is buggy and reverses the Y2 axis
-      stick = Vector(controller.get_axis_state(X2_AXIS),
-                     -controller.get_axis_state(Y2_AXIS));
       
       Vector advance = delta * 512.0f * stick;
       connection->advance(advance, next_node);
@@ -189,8 +193,31 @@
                 }
             }
         }
+      player = connection->get_pos();
+
+      if (controller.get_button_state(AIM_BUTTON))
+        {
+          delete connection;
+          connection = 0;
+        }
     }
+  else
+    { // handle non connection based movement
+      player += Vector(0.0f, 100.0f) * delta;
+      
+      player.x += 512.0f * stick.x * delta;
 
+      if (controller.get_button_state(AIM_BUTTON))
+        {
+          player.y -= 0.5f * 512.0f * delta;
+        }
+
+      std::vector<SegmentPosition> positions = graph->find_intersections(Line(old_player, player));
+      if (!positions.empty()) {
+        connection = new SegmentPosition(positions.front());
+      }
+    }
+  
   if (controller.button_was_pressed(PDA_BUTTON))
     {
       if (selected_node) {
@@ -209,6 +236,8 @@
     selected_segment = graph->find_closest_segment(cursor, 32.0f);
   else
     selected_segment = 0;
+
+  old_player = player;
 }
 
 /* EOF */

Modified: trunk/windstille/src/navigation_test.hpp
===================================================================
--- trunk/windstille/src/navigation_test.hpp	2007-06-16 16:14:35 UTC (rev 1450)
+++ trunk/windstille/src/navigation_test.hpp	2007-06-16 20:04:55 UTC (rev 1451)
@@ -29,7 +29,7 @@
 #include "screen.hpp"
 
 class NavigationGraph;
-class Connection;
+class SegmentPosition;
 class Segment;
 class Node;
 
@@ -39,9 +39,11 @@
 private:
   Vector cursor;
   Vector stick;
+  Vector player;
+  Vector old_player;
   
   NavigationGraph* graph;
-  Connection* connection;
+  SegmentPosition* connection;
 
   Segment* selected_segment;
   Node*    selected_node;



From grumbel at mail.berlios.de  Sun Jun 17 04:43:11 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sun, 17 Jun 2007 04:43:11 +0200
Subject: [Windstille-commit] r1452 - in trunk/windstille: . src
	src/navigation
Message-ID: <200706170243.l5H2hBbc010114@sheep.berlios.de>

Author: grumbel
Date: 2007-06-17 04:43:10 +0200 (Sun, 17 Jun 2007)
New Revision: 1452

Modified:
   trunk/windstille/TODO
   trunk/windstille/src/navigation/navigation_graph.cpp
   trunk/windstille/src/navigation/node.cpp
   trunk/windstille/src/navigation/node.hpp
   trunk/windstille/src/navigation/segment.cpp
   trunk/windstille/src/navigation/segment_position.cpp
   trunk/windstille/src/navigation/segment_position.hpp
   trunk/windstille/src/navigation_test.cpp
Log:
- fixed transition handling over lines with oposing normals
- fixed bug in node removal


Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-16 20:04:55 UTC (rev 1451)
+++ trunk/windstille/TODO	2007-06-17 02:43:10 UTC (rev 1452)
@@ -5,5 +5,6 @@
 - collision detection
 - virtual tiles in the editor
 - animated tiles
+- add option to invert axis
 
 # EOF #

Modified: trunk/windstille/src/navigation/navigation_graph.cpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-16 20:04:55 UTC (rev 1451)
+++ trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-17 02:43:10 UTC (rev 1452)
@@ -56,44 +56,40 @@
   if (i != segments.end())
     {
       segments.erase(i);
+      delete segment;
     }
 
-  delete segment;
+  // FIXME: Throw exception here
 }
 
-struct ContainsNode
-{
-  Node* node;
-
-  ContainsNode(Node* node_) : node(node_) {}
-
-  bool operator()(Segment* segment) {
-    return 
-      (segment->get_node1() == node ||
-       segment->get_node2() == node);
-  }
-};
-
 void
 NavigationGraph::remove_node(Node* node)
 {
   // FIXME: Slow
-
   // Remove all segments that would get invalid by removing the node
-  Segments::iterator i = std::remove_if(segments.begin(), segments.end(), ContainsNode(node));
-  if (i != segments.end())
+  for(Segments::iterator i = segments.begin(); i != segments.end(); ++i)
     {
-      segments.erase(i, segments.end());
+      if ((*i)->get_node1() == node ||
+          (*i)->get_node2() == node)
+        {
+          delete *i;
+          *i = 0;
+        }
     }
+
+  Segments::iterator new_end = std::remove(segments.begin(), segments.end(), (Segment*)0);
+  if (new_end != segments.end())
+    { 
+      segments.erase(new_end, segments.end());
+    }
   
   // Remove the node itself 
   Nodes::iterator j = std::find(nodes.begin(), nodes.end(), node);
   if (j != nodes.end())
     {
       nodes.erase(j);
+      delete node;
     }  
-
-  delete node;
 }
 
 Segment*

Modified: trunk/windstille/src/navigation/node.cpp
===================================================================
--- trunk/windstille/src/navigation/node.cpp	2007-06-16 20:04:55 UTC (rev 1451)
+++ trunk/windstille/src/navigation/node.cpp	2007-06-17 02:43:10 UTC (rev 1452)
@@ -23,29 +23,38 @@
 **  02111-1307, USA.
 */
 
+#include <iostream>
 #include <algorithm>
 #include "node.hpp"
-
+
 Node::Node(const Vector& pos_)
   : pos(pos_)
     // FIXME: Do something with id
 {
-  
+  std::cout << "Creating node: " << this << std::endl;
 }
 
+Node::~Node()
+{
+  std::cout << "Destroying node: " << this << std::endl;
+}
+
 void
-Node::add_segment(Segment* segment)
+Node::add_segment(const SegmentPosition& position)
 {
-  segments.push_back(segment);
+  segments.push_back(position);
 }
 
 void
 Node::remove_segment(Segment* segment)
 {
-  Segments::iterator i = std::find(segments.begin(), segments.end(), segment);
-  if (i != segments.end())
+  for(Segments::iterator i = segments.begin(); i != segments.end(); ++i)
     {
-      segments.erase(i);
+      if (i->segment == segment)
+        {
+          segments.erase(i);
+          return;
+        }
     }
 }
 

Modified: trunk/windstille/src/navigation/node.hpp
===================================================================
--- trunk/windstille/src/navigation/node.hpp	2007-06-16 20:04:55 UTC (rev 1451)
+++ trunk/windstille/src/navigation/node.hpp	2007-06-17 02:43:10 UTC (rev 1452)
@@ -29,7 +29,7 @@
 #include <vector>
 #include "math/vector.hpp"
 
-class Segment;
+#include "segment_position.hpp"
 
 /** */
 class Node
@@ -40,16 +40,20 @@
   
 public:
   /** Segments connected to this node */
-  typedef std::vector<Segment*> Segments;
+  typedef std::vector<SegmentPosition> Segments;
   Segments segments;
 
 public:
   Node(const Vector& pos_);
+  ~Node();
 
   Vector get_pos() const { return pos; }
   void   set_pos(const Vector& p) { pos = p; }
-  
-  void add_segment(Segment* segment);
+
+  /** Connect the given segment to the node, the position is used to
+      mark the end of the segment that is actually connected */
+  void add_segment(const SegmentPosition& segment);
+
   void remove_segment(Segment* segment);
 private:
   Node(const Node&);

Modified: trunk/windstille/src/navigation/segment.cpp
===================================================================
--- trunk/windstille/src/navigation/segment.cpp	2007-06-16 20:04:55 UTC (rev 1451)
+++ trunk/windstille/src/navigation/segment.cpp	2007-06-17 02:43:10 UTC (rev 1452)
@@ -23,6 +23,7 @@
 **  02111-1307, USA.
 */
 
+#include <iostream>
 #include <assert.h>
 #include "node.hpp"
 #include "segment.hpp"
@@ -32,12 +33,16 @@
     node2(node2_),
     props(props_)
 {
-  node1->add_segment(this);
-  node2->add_segment(this);
+  node1->add_segment(SegmentPosition(this, 0.0f));
+  node2->add_segment(SegmentPosition(this, 1.0f));
+
+  std::cout << "Creating segment: " << this << " with " << node1 << ", " << node2 << std::endl;
 }
 
 Segment::~Segment()
 {
+  std::cout << "Destroying segment: " << this << " with " << node1 << ", " << node2 << std::endl;
+
   node1->remove_segment(this);
   node2->remove_segment(this);
 }

Modified: trunk/windstille/src/navigation/segment_position.cpp
===================================================================
--- trunk/windstille/src/navigation/segment_position.cpp	2007-06-16 20:04:55 UTC (rev 1451)
+++ trunk/windstille/src/navigation/segment_position.cpp	2007-06-17 02:43:10 UTC (rev 1452)
@@ -28,6 +28,12 @@
 #include "display/display.hpp"
 #include "segment_position.hpp"
 
+SegmentPosition::SegmentPosition()
+  : segment(0),
+    pos(0.0f)
+{
+}
+
 SegmentPosition::SegmentPosition(Segment* segment_, float pos_)
   : segment(segment_),
     pos(pos_)

Modified: trunk/windstille/src/navigation/segment_position.hpp
===================================================================
--- trunk/windstille/src/navigation/segment_position.hpp	2007-06-16 20:04:55 UTC (rev 1451)
+++ trunk/windstille/src/navigation/segment_position.hpp	2007-06-17 02:43:10 UTC (rev 1452)
@@ -43,6 +43,7 @@
   float pos;
 
 public:
+  SegmentPosition();
   SegmentPosition(Segment* segment_, float pos_);
 
   void set_pos(Segment* segment_, float pos_);

Modified: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-16 20:04:55 UTC (rev 1451)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-17 02:43:10 UTC (rev 1452)
@@ -132,7 +132,7 @@
     }
 
   if (controller.get_button_state(TERTIARY_BUTTON))
-    {
+    { // Move node
       if (selected_node)
         {
           selected_node->set_pos(cursor);
@@ -140,12 +140,8 @@
     }
 
   if (controller.button_was_pressed(SECONDARY_BUTTON))
-    {
-      if (selected_segment)
-        {
-          delete connection;
-          connection = new SegmentPosition(selected_segment, 0.5f);
-        }
+    { // Set player
+      player = old_player = cursor;
     }
 
   if (connection)
@@ -156,49 +152,47 @@
       
       Vector advance = delta * 512.0f * stick;
       connection->advance(advance, next_node);
+
+      player = connection->get_pos();
       
       if (!advance.is_null())
         { // FIXME: This should be a while loop, currently we are just
           // discarding the rest movement
-          Segment* next_segment = 0;
+          SegmentPosition next_segment;
           for(Node::Segments::iterator i = next_node->segments.begin(); i != next_node->segments.end(); ++i)
             {
-              if (connection->get_segment() != *i)
+              if (connection->get_segment() != i->segment)
                 {
                   next_segment = *i;
                   break;
                 }
             }
               
-          if (!next_segment)
+          if (!next_segment.segment)
             {
               std::cout << "Dead End" << std::endl;
+              delete connection;
+              connection = 0;
+
+              // FIXME: Voodoo to fix connection/dedaend cicles
+              player += stick;
+              old_player = player;
             }
           else
             {
               std::cout << "transition" << std::endl;
-                           
-              // FIXME: broken API this 0.0 or 1.0 depends on the segment
-              if (connection->get_float_pos() == 0.0f)
-                {
-                  connection->set_pos(next_segment, 1.0f);
-                }
-              else if (connection->get_float_pos() == 1.0f)
-                {
-                  connection->set_pos(next_segment, 0.0f);
-                }
-              else
-                {
-                  assert(!"This should never been reached! - 3124");
-                }
+              *connection = next_segment;
             }
         }
-      player = connection->get_pos();
 
       if (controller.get_button_state(AIM_BUTTON))
-        {
+        {         
           delete connection;
           connection = 0;
+
+          // FIXME: Voodoo to fix connection/dedaend cicles
+          player += stick;
+          old_player = player;
         }
     }
   else
@@ -214,6 +208,7 @@
 
       std::vector<SegmentPosition> positions = graph->find_intersections(Line(old_player, player));
       if (!positions.empty()) {
+        std::cout << "Doing connection" << std::endl;
         connection = new SegmentPosition(positions.front());
       }
     }



From grumbel at mail.berlios.de  Sun Jun 17 04:59:18 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sun, 17 Jun 2007 04:59:18 +0200
Subject: [Windstille-commit] r1453 - in trunk/windstille/src: . navigation
Message-ID: <200706170259.l5H2xImp010815@sheep.berlios.de>

Author: grumbel
Date: 2007-06-17 04:59:17 +0200 (Sun, 17 Jun 2007)
New Revision: 1453

Modified:
   trunk/windstille/src/navigation/segment.cpp
   trunk/windstille/src/navigation/segment.hpp
   trunk/windstille/src/navigation_test.cpp
Log:
- navigation around a full navigation graph is now working

Modified: trunk/windstille/src/navigation/segment.cpp
===================================================================
--- trunk/windstille/src/navigation/segment.cpp	2007-06-17 02:43:10 UTC (rev 1452)
+++ trunk/windstille/src/navigation/segment.cpp	2007-06-17 02:59:17 UTC (rev 1453)
@@ -61,4 +61,10 @@
               node2->get_pos());
 }
 
+Vector
+Segment::get_vector() const
+{
+  return node2->get_pos() - node1->get_pos();
+}
+
 /* EOF */

Modified: trunk/windstille/src/navigation/segment.hpp
===================================================================
--- trunk/windstille/src/navigation/segment.hpp	2007-06-17 02:43:10 UTC (rev 1452)
+++ trunk/windstille/src/navigation/segment.hpp	2007-06-17 02:59:17 UTC (rev 1453)
@@ -27,6 +27,7 @@
 #define HEADER_SEGMENT_HPP
 
 #include "math/line.hpp"
+#include "math/vector.hpp"
 #include "properties.hpp"
 
 class Node;
@@ -51,7 +52,8 @@
   Node* get_node2() const { return node2; } 
 
   Line get_line() const;
-
+  Vector get_vector() const;
+  
 private:
   Segment (const Segment&);
   Segment& operator= (const Segment&);

Modified: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-17 02:43:10 UTC (rev 1452)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-17 02:59:17 UTC (rev 1453)
@@ -156,15 +156,25 @@
       player = connection->get_pos();
       
       if (!advance.is_null())
-        { // FIXME: This should be a while loop, currently we are just
+        { // Not all advancement got used up, which means we have hit
+          // the end of a segment
+
+          // FIXME: This should be a while loop, currently we are just
           // discarding the rest movement
+
           SegmentPosition next_segment;
+          float length = 0;
           for(Node::Segments::iterator i = next_node->segments.begin(); i != next_node->segments.end(); ++i)
             {
               if (connection->get_segment() != i->segment)
-                {
-                  next_segment = *i;
-                  break;
+                { // Find out into the direction of which segment the stick is pointing
+                  Vector proj = stick.project(i->segment->get_vector());
+                  
+                  if (proj.length() > length)
+                    {
+                      next_segment = *i;
+                      length       = proj.length();
+                    }
                 }
             }
               
@@ -174,7 +184,7 @@
               delete connection;
               connection = 0;
 
-              // FIXME: Voodoo to fix connection/dedaend cicles
+              // FIXME: Voodoo to fix connection/deadend cicles
               player += stick;
               old_player = player;
             }



From grumbel at mail.berlios.de  Sun Jun 17 07:23:04 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sun, 17 Jun 2007 07:23:04 +0200
Subject: [Windstille-commit] r1454 - in trunk/windstille/src: . navigation
Message-ID: <200706170523.l5H5N4a8030735@sheep.berlios.de>

Author: grumbel
Date: 2007-06-17 07:23:04 +0200 (Sun, 17 Jun 2007)
New Revision: 1454

Added:
   trunk/windstille/src/handle.hpp
Modified:
   trunk/windstille/src/navigation/navigation_graph.cpp
   trunk/windstille/src/navigation/navigation_graph.hpp
   trunk/windstille/src/navigation/node.cpp
   trunk/windstille/src/navigation/segment.cpp
   trunk/windstille/src/navigation/segment.hpp
   trunk/windstille/src/navigation_test.cpp
   trunk/windstille/src/navigation_test.hpp
Log:
- some experiments with handles

Added: trunk/windstille/src/handle.hpp
===================================================================
--- trunk/windstille/src/handle.hpp	2007-06-17 02:59:17 UTC (rev 1453)
+++ trunk/windstille/src/handle.hpp	2007-06-17 05:23:04 UTC (rev 1454)
@@ -0,0 +1,141 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_HANDLE_HPP
+#define HEADER_HANDLE_HPP
+
+#include <vector>
+
+template<typename Data> class HandleManager;
+
+template<typename Data>
+class Handle
+{
+private:
+  HandleManager<Data>* manager;
+
+  unsigned int index;
+  unsigned int magic;
+
+public:
+  Handle(HandleManager<Data>* manager_, 
+             unsigned int index_,
+             unsigned int magic_)
+    : manager(manager_),
+      index(index_),
+      magic(magic_)
+  {
+  }
+
+  bool is_null() {
+    return manager->dereference(index, magic) != 0;
+  }
+
+  Data* operator->() {
+    return manager->dereference(index, magic);
+  }
+
+  Data& operator*() {
+    return manager->dereference(index, magic);
+  }
+};
+
+template<typename Data>
+class HandleManager
+{
+private:
+  std::vector<Data>        data_lst;
+  std::vector<unsigned int> magic_lst;
+
+  /** List of indexes in \a data_lst and \a magic_lst that aren't
+      used */
+  std::vector<unsigned int>  free_list;
+  
+  unsigned int next_magic;
+
+public:
+  HandleManager() 
+    : next_magic(0)
+  {
+  }
+  
+  Handle<Data> aquire(const Data& data)
+  {
+    if (free_list.empty()) 
+      {
+        data_lst.push_back(data);
+        magic_lst.push_back(next_magic);
+
+        return Handle<Data>(this, next_magic++);
+      }
+    else
+      {
+        unsigned int index = free_list.back();
+        free_list.pop_back();
+
+        data_lst[index]  = data;
+        magic_lst[index] = next_magic;
+
+        return Handle<Data>(this, next_magic++);
+      }
+  }
+
+  void release(const Handle<Data>& handle)
+  {
+    if (valid(handle))
+      {
+        delete data_lst[handle.index];
+        data_lst[handle.index] = 0;
+
+        free_list.push_back(handle.index);
+      }
+    else
+      {
+        // invalid handle
+      }
+  }
+  
+  bool valid(const Handle<Data>& handle)
+  {
+    return (handle.index < data_lst.size() &&
+            magic_lst[handle.index] == handle.magic);
+  }
+
+  Data& dereference(const Handle<Data>& handle)
+  {
+    if (valid)
+      {
+        return data_lst[handle.index];
+      }
+    else
+      {
+        // invalid handle
+      }
+  }
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/handle.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/navigation/navigation_graph.cpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-17 02:59:17 UTC (rev 1453)
+++ trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-17 05:23:04 UTC (rev 1454)
@@ -38,39 +38,45 @@
 
 NavigationGraph::~NavigationGraph()
 {
+  for(Segments::iterator i = segments.begin(); i != segments.end(); ++i)
+    delete *i;
+
+  for (Nodes::iterator i = nodes.begin(); i != nodes.end(); ++i)
+    delete *i;
 }
 
-Node*
+NodeHandle
 NavigationGraph::add_node(const Vector& pos)
 {
   Node* node = new Node(pos);
   nodes.push_back(node);
-  return node;
+  return NodeHandle(node);
 }
 
 void
-NavigationGraph::remove_segment(Segment* segment)
+NavigationGraph::remove_segment(SegmentHandle segment)
 {
   // FIXME: Slow
-  Segments::iterator i = std::find(segments.begin(), segments.end(), segment);
+  Segments::iterator i = std::find(segments.begin(), segments.end(), segment.get());
   if (i != segments.end())
     {
       segments.erase(i);
-      delete segment;
+      delete segment.get();
     }
 
   // FIXME: Throw exception here
 }
 
 void
-NavigationGraph::remove_node(Node* node)
+NavigationGraph::remove_node(NodeHandle node)
 {
   // FIXME: Slow
+
   // Remove all segments that would get invalid by removing the node
   for(Segments::iterator i = segments.begin(); i != segments.end(); ++i)
     {
-      if ((*i)->get_node1() == node ||
-          (*i)->get_node2() == node)
+      if ((*i)->get_node1() == node.get() ||
+          (*i)->get_node2() == node.get())
         {
           delete *i;
           *i = 0;
@@ -84,28 +90,28 @@
     }
   
   // Remove the node itself 
-  Nodes::iterator j = std::find(nodes.begin(), nodes.end(), node);
+  Nodes::iterator j = std::find(nodes.begin(), nodes.end(), node.get());
   if (j != nodes.end())
     {
       nodes.erase(j);
-      delete node;
+      delete node.get();
     }  
 }
 
-Segment*
-NavigationGraph::add_segment(Node* node1, Node* node2)
+SegmentHandle
+NavigationGraph::add_segment(NodeHandle node1, NodeHandle node2)
 {
-  Segment* segment = new Segment(node1, node2);
+  Segment* segment = new Segment(node1.get(), node2.get());
   segments.push_back(segment);
-  return segment;
+  return SegmentHandle(segment);
 }
 
 void
-NavigationGraph::split_segment(Segment* segment)
+NavigationGraph::split_segment(SegmentHandle segment)
 {
-  Node* node1 = segment->get_node1();
-  Node* node3 = segment->get_node2();
-  Node* node2 = add_node(0.5f * (node1->get_pos() + node3->get_pos()));
+  NodeHandle node1 = NodeHandle(segment->get_node1());
+  NodeHandle node3 = NodeHandle(segment->get_node2());
+  NodeHandle node2 = add_node(0.5f * (node1->get_pos() + node3->get_pos()));
 
   remove_segment(segment);
   add_segment(node1, node2);  
@@ -115,8 +121,8 @@
 std::vector<SegmentPosition>
 NavigationGraph::find_intersections(const Line& line)
 {
-
-  // FIXME: Return a navgraph pos here
+  // FIXME: we might want to only return the first intersection, not
+  // all of them or alternativly return ua
   std::vector<SegmentPosition> ret;
  
   for(Segments::iterator i = segments.begin(); i != segments.end(); ++i)
@@ -134,28 +140,28 @@
   return ret;
 }
 
-std::vector<Node*>
+std::vector<NodeHandle>
 NavigationGraph::find_nodes(const Vector& pos, float radius)
 {
   // FIXME: Optimize this with spatial tree thingy
-  std::vector<Node*> ret;
+  std::vector<NodeHandle> ret;
 
   for(Nodes::iterator i = nodes.begin(); i != nodes.end(); ++i)
     {
       float distance = (pos - (*i)->get_pos()).length();
       if (distance < radius)
         {
-          ret.push_back(*i);
+          ret.push_back(NodeHandle(*i));
         }
     }
   
   return ret;
 }
 
-std::vector<Segment*>
+std::vector<SegmentHandle>
 NavigationGraph::find_segments(const Vector& pos, float radius)
 {
-  std::vector<Segment*> ret;
+  std::vector<SegmentHandle> ret;
  
   for(Segments::iterator i = segments.begin(); i != segments.end(); ++i)
     {
@@ -163,14 +169,14 @@
                             (*i)->get_node2()->get_pos()).distance(pos);
       if (distance < radius)
         {
-          ret.push_back(*i);
+          ret.push_back(SegmentHandle(*i));
         }
     }
 
   return ret;
 }
 
-Node*
+NodeHandle
 NavigationGraph::find_closest_node(const Vector& pos, float radius)
 {
   // FIXME: Optimize this with spatial tree thingy
@@ -187,10 +193,10 @@
         }
     }
   
-  return node;
+  return NodeHandle(node);
 }
 
-Segment*
+SegmentHandle
 NavigationGraph::find_closest_segment(const Vector& pos, float radius)
 {
   Segment* segment   = 0;
@@ -207,7 +213,7 @@
         }
     }
 
-  return segment;
+  return SegmentHandle(segment);
 }
 
 void

Modified: trunk/windstille/src/navigation/navigation_graph.hpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-17 02:59:17 UTC (rev 1453)
+++ trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-17 05:23:04 UTC (rev 1454)
@@ -27,19 +27,51 @@
 #define HEADER_NAVIGATION_GRAPH_HPP
 
 #include <vector>
+#include "handle.hpp"
 #include "math/line.hpp"
 
 class Node;
 class Segment;
 class SegmentPosition;
 
+template<typename Data>
+class PointerHandle
+{
+private:
+  Data* data;
+
+public: 
+  PointerHandle(Data* data_)
+    : data(data_)
+  {}
+
+  inline Data* get() {
+    return data;
+  }
+
+  inline Data* operator->()  {
+    return data;
+  }
+
+  inline Data& operator*()  {
+    return *data;
+  }
+
+  operator bool() {
+    return data != 0;
+  }
+};
+
+typedef PointerHandle<Node>    NodeHandle; 
+typedef PointerHandle<Segment> SegmentHandle; 
+
 /** */
 class NavigationGraph
 {
 private:
   typedef std::vector<Node*>    Nodes;
   typedef std::vector<Segment*> Segments;
-  
+
   Nodes    nodes;
   Segments segments;
   
@@ -49,30 +81,33 @@
   NavigationGraph();
   ~NavigationGraph();
 
-  Node*    add_node(const Vector& pos);
-  Segment* add_segment(Node* node1, Node* node2);
+  // FIXME: It might be worth it to return handles that can be
+  // validated instead of pure pointers
+  NodeHandle    add_node(const Vector& pos);
+  SegmentHandle add_segment(NodeHandle node1, NodeHandle node2);
 
-  void remove_node(Node* node);
-  void remove_segment(Segment* segment);
+  void remove_node(NodeHandle node);
+  void remove_segment(SegmentHandle segment);
 
-  void split_segment(Segment* segment);
+  void split_segment(SegmentHandle segment);
 
   /** Find segments that intersect with the given line */
   std::vector<SegmentPosition> find_intersections(const Line& line);
 
   /** Find nodes that are near the given point */
-  std::vector<Node*> find_nodes(const Vector& pos, float radius);
+  std::vector<NodeHandle> find_nodes(const Vector& pos, float radius);
 
   /** Find the closest node, limit search to nodes in radius */
-  Node* find_closest_node(const Vector& pos, float radius);
+  NodeHandle find_closest_node(const Vector& pos, float radius);
 
-  Segment* find_closest_segment(const Vector& pos, float radius);
+  SegmentHandle find_closest_segment(const Vector& pos, float radius);
 
   /** Find segments that are near the given point */
-  std::vector<Segment*> find_segments(const Vector& pos, float radius);
+  std::vector<SegmentHandle> find_segments(const Vector& pos, float radius);
 
   /** Draw the navigation graph, for debugging only */
   void draw();
+
 private:
   NavigationGraph (const NavigationGraph&);
   NavigationGraph& operator= (const NavigationGraph&);

Modified: trunk/windstille/src/navigation/node.cpp
===================================================================
--- trunk/windstille/src/navigation/node.cpp	2007-06-17 02:59:17 UTC (rev 1453)
+++ trunk/windstille/src/navigation/node.cpp	2007-06-17 05:23:04 UTC (rev 1454)
@@ -23,7 +23,6 @@
 **  02111-1307, USA.
 */
 
-#include <iostream>
 #include <algorithm>
 #include "node.hpp"
 
@@ -31,12 +30,10 @@
   : pos(pos_)
     // FIXME: Do something with id
 {
-  std::cout << "Creating node: " << this << std::endl;
 }
 
 Node::~Node()
 {
-  std::cout << "Destroying node: " << this << std::endl;
 }
 
 void

Modified: trunk/windstille/src/navigation/segment.cpp
===================================================================
--- trunk/windstille/src/navigation/segment.cpp	2007-06-17 02:59:17 UTC (rev 1453)
+++ trunk/windstille/src/navigation/segment.cpp	2007-06-17 05:23:04 UTC (rev 1454)
@@ -23,7 +23,6 @@
 **  02111-1307, USA.
 */
 
-#include <iostream>
 #include <assert.h>
 #include "node.hpp"
 #include "segment.hpp"
@@ -35,14 +34,10 @@
 {
   node1->add_segment(SegmentPosition(this, 0.0f));
   node2->add_segment(SegmentPosition(this, 1.0f));
-
-  std::cout << "Creating segment: " << this << " with " << node1 << ", " << node2 << std::endl;
 }
 
 Segment::~Segment()
 {
-  std::cout << "Destroying segment: " << this << " with " << node1 << ", " << node2 << std::endl;
-
   node1->remove_segment(this);
   node2->remove_segment(this);
 }

Modified: trunk/windstille/src/navigation/segment.hpp
===================================================================
--- trunk/windstille/src/navigation/segment.hpp	2007-06-17 02:59:17 UTC (rev 1453)
+++ trunk/windstille/src/navigation/segment.hpp	2007-06-17 05:23:04 UTC (rev 1454)
@@ -51,7 +51,7 @@
   Node* get_node1() const { return node1; } 
   Node* get_node2() const { return node2; } 
 
-  Line get_line() const;
+  Line   get_line() const;
   Vector get_vector() const;
   
 private:

Modified: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-17 02:59:17 UTC (rev 1453)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-17 05:23:04 UTC (rev 1454)
@@ -47,8 +47,8 @@
 {
   graph = new NavigationGraph();
 
-  Node* node1 = graph->add_node(Vector(100, 200));
-  Node* node2 = graph->add_node(Vector(300, 400));
+  NodeHandle node1 = graph->add_node(Vector(100, 200));
+  NodeHandle node2 = graph->add_node(Vector(300, 400));
   //Node* node3 = graph->add_node(Vector(500, 300));
   //Node* node4 = graph->add_node(Vector(700, 400));
 

Modified: trunk/windstille/src/navigation_test.hpp
===================================================================
--- trunk/windstille/src/navigation_test.hpp	2007-06-17 02:59:17 UTC (rev 1453)
+++ trunk/windstille/src/navigation_test.hpp	2007-06-17 05:23:04 UTC (rev 1454)
@@ -26,6 +26,7 @@
 #ifndef HEADER_NAVIGATION_TEST_HPP
 #define HEADER_NAVIGATION_TEST_HPP
 
+#include "navigation/navigation_graph.hpp"
 #include "screen.hpp"
 
 class NavigationGraph;
@@ -45,10 +46,10 @@
   NavigationGraph* graph;
   SegmentPosition* connection;
 
-  Segment* selected_segment;
-  Node*    selected_node;
+  SegmentHandle selected_segment;
+  NodeHandle    selected_node;
 
-  Node* node_to_connect;
+  NodeHandle node_to_connect;
 
 public:
   NavigationTest();



From grumbel at mail.berlios.de  Sun Jun 17 08:40:15 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sun, 17 Jun 2007 08:40:15 +0200
Subject: [Windstille-commit] r1455 - in trunk/windstille/src: . navigation
Message-ID: <200706170640.l5H6eFB8001618@sheep.berlios.de>

Author: grumbel
Date: 2007-06-17 08:40:14 +0200 (Sun, 17 Jun 2007)
New Revision: 1455

Modified:
   trunk/windstille/src/navigation/navigation_graph.cpp
   trunk/windstille/src/navigation/navigation_graph.hpp
   trunk/windstille/src/navigation/segment.cpp
   trunk/windstille/src/navigation/segment.hpp
   trunk/windstille/src/navigation_test.cpp
Log:
- added save function to the NavigationGraph

Modified: trunk/windstille/src/navigation/navigation_graph.cpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-17 05:23:04 UTC (rev 1454)
+++ trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-17 06:40:14 UTC (rev 1455)
@@ -24,6 +24,7 @@
 */
 
 #include <iostream>
+#include <map>
 #include <algorithm>
 #include "display/display.hpp"
 #include "node.hpp"
@@ -233,4 +234,31 @@
     }
 }
 
+void
+NavigationGraph::save(std::ostream& out)
+{
+  int id = 1;
+  std::map<Node*, int> ptr2id;
+
+  for(Nodes::iterator i = nodes.begin(); i != nodes.end(); ++i)
+    ptr2id[*i] = id++;
+
+  out << "(navigation\n";
+
+  out << "  (segments\n";
+  for(Segments::iterator i = segments.begin(); i != segments.end(); ++i)  
+    out << "    (segment "
+        << "(node " << ptr2id[(*i)->get_node1()] << ") "
+        << "(node " << ptr2id[(*i)->get_node2()] << ") "
+        << "(properties " << (*i)->get_properties() << "))\n";
+  out << " )\n";
+      
+    out << "  (nodes\n"; 
+  for(Nodes::iterator i = nodes.begin(); i != nodes.end(); ++i)
+    out << "    (node (id " << ptr2id[*i] << ") (pos " << (*i)->get_pos().x << " " << (*i)->get_pos().y << "))\n";
+  out << " )\n";
+
+  out << ")\n";
+}
+
 /* EOF */

Modified: trunk/windstille/src/navigation/navigation_graph.hpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-17 05:23:04 UTC (rev 1454)
+++ trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-17 06:40:14 UTC (rev 1455)
@@ -26,6 +26,7 @@
 #ifndef HEADER_NAVIGATION_GRAPH_HPP
 #define HEADER_NAVIGATION_GRAPH_HPP
 
+#include <iosfwd>
 #include <vector>
 #include "handle.hpp"
 #include "math/line.hpp"
@@ -108,6 +109,8 @@
   /** Draw the navigation graph, for debugging only */
   void draw();
 
+  void save(std::ostream& out);
+
 private:
   NavigationGraph (const NavigationGraph&);
   NavigationGraph& operator= (const NavigationGraph&);

Modified: trunk/windstille/src/navigation/segment.cpp
===================================================================
--- trunk/windstille/src/navigation/segment.cpp	2007-06-17 05:23:04 UTC (rev 1454)
+++ trunk/windstille/src/navigation/segment.cpp	2007-06-17 06:40:14 UTC (rev 1455)
@@ -30,7 +30,7 @@
 Segment::Segment(Node* node1_, Node* node2_, Properties props_)
   : node1(node1_), 
     node2(node2_),
-    props(props_)
+    properties(props_)
 {
   node1->add_segment(SegmentPosition(this, 0.0f));
   node2->add_segment(SegmentPosition(this, 1.0f));

Modified: trunk/windstille/src/navigation/segment.hpp
===================================================================
--- trunk/windstille/src/navigation/segment.hpp	2007-06-17 05:23:04 UTC (rev 1454)
+++ trunk/windstille/src/navigation/segment.hpp	2007-06-17 06:40:14 UTC (rev 1455)
@@ -39,7 +39,7 @@
   Node* node1;
   Node* node2;
   
-  Properties props;
+  Properties properties;
 
 public:
   Segment(Node* node1_, Node* node2_, Properties props_ = 0);
@@ -51,6 +51,8 @@
   Node* get_node1() const { return node1; } 
   Node* get_node2() const { return node2; } 
 
+  Properties get_properties()  const { return properties; }
+
   Line   get_line() const;
   Vector get_vector() const;
   

Modified: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-17 05:23:04 UTC (rev 1454)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-17 06:40:14 UTC (rev 1455)
@@ -223,6 +223,11 @@
       }
     }
   
+  if (controller.button_was_pressed(VIEW_CENTER_BUTTON))
+    {
+      graph->save(std::cout);
+    }
+
   if (controller.button_was_pressed(PDA_BUTTON))
     {
       if (selected_node) {



From grumbel at mail.berlios.de  Sun Jun 17 19:28:15 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sun, 17 Jun 2007 19:28:15 +0200
Subject: [Windstille-commit] r1456 - in trunk/windstille/src: . navigation
Message-ID: <200706171728.l5HHSFW4018906@sheep.berlios.de>

Author: grumbel
Date: 2007-06-17 19:28:15 +0200 (Sun, 17 Jun 2007)
New Revision: 1456

Modified:
   trunk/windstille/src/navigation/navigation_graph.cpp
   trunk/windstille/src/navigation/navigation_graph.hpp
   trunk/windstille/src/navigation_test.cpp
Log:
- some code to test find_nodes()
- nodes can no longer link to themself

Modified: trunk/windstille/src/navigation/navigation_graph.cpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-17 06:40:14 UTC (rev 1455)
+++ trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-17 17:28:15 UTC (rev 1456)
@@ -102,9 +102,16 @@
 SegmentHandle
 NavigationGraph::add_segment(NodeHandle node1, NodeHandle node2)
 {
-  Segment* segment = new Segment(node1.get(), node2.get());
-  segments.push_back(segment);
-  return SegmentHandle(segment);
+  if (node1.get() != node2.get()) // node links to themself are forbidden
+    { // FIXME: Find a way to figure out if the given segment already exists
+      Segment* segment = new Segment(node1.get(), node2.get());
+      segments.push_back(segment);
+      return SegmentHandle(segment);
+    }
+  else
+    {
+      return SegmentHandle();
+    }
 }
 
 void

Modified: trunk/windstille/src/navigation/navigation_graph.hpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-17 06:40:14 UTC (rev 1455)
+++ trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-17 17:28:15 UTC (rev 1456)
@@ -42,6 +42,10 @@
   Data* data;
 
 public: 
+  PointerHandle() 
+    : data(0)
+  {}
+
   PointerHandle(Data* data_)
     : data(data_)
   {}
@@ -95,7 +99,7 @@
   /** Find segments that intersect with the given line */
   std::vector<SegmentPosition> find_intersections(const Line& line);
 
-  /** Find nodes that are near the given point */
+  /** Find nodes that are near within the \a radius */
   std::vector<NodeHandle> find_nodes(const Vector& pos, float radius);
 
   /** Find the closest node, limit search to nodes in radius */

Modified: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-17 06:40:14 UTC (rev 1455)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-17 17:28:15 UTC (rev 1456)
@@ -67,6 +67,12 @@
   Display::fill_rect(Rectf(cursor - Vector(2,2), Sizef(5,5)),  Color(1.0f, 1.0f, 1.0f));
   Display::draw_circle(cursor, 32.0f, Color(1.0f, 1.0f, 1.0f, 0.5f));
 
+  std::vector<NodeHandle> nodes = graph->find_nodes(cursor, 128.0f);
+  for(std::vector<NodeHandle>::iterator i = nodes.begin(); i != nodes.end(); ++i)
+    {
+      Display::draw_circle((*i)->get_pos(), 12.0f, Color(1.0f, 1.0f, 1.0f, 0.5f));
+    }
+
   if (node_to_connect)
     {
       Display::fill_rect(Rectf(node_to_connect->get_pos() - Vector(2,2), Sizef(5,5)),  



From grumbel at mail.berlios.de  Mon Jun 18 02:17:14 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 18 Jun 2007 02:17:14 +0200
Subject: [Windstille-commit] r1457 - in trunk/windstille: . src
	src/navigation
Message-ID: <200706180017.l5I0HEHC029576@sheep.berlios.de>

Author: grumbel
Date: 2007-06-18 02:17:13 +0200 (Mon, 18 Jun 2007)
New Revision: 1457

Modified:
   trunk/windstille/TODO
   trunk/windstille/src/navigation/navigation_graph.cpp
   trunk/windstille/src/navigation/navigation_graph.hpp
   trunk/windstille/src/navigation/segment_position.cpp
   trunk/windstille/src/navigation/segment_position.hpp
   trunk/windstille/src/navigation_test.cpp
Log:
- added check to let SegmentPosition get removed when the segment disapears

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-17 17:28:15 UTC (rev 1456)
+++ trunk/windstille/TODO	2007-06-18 00:17:13 UTC (rev 1457)
@@ -1,10 +1,13 @@
 - incooperate the freebsd patches
 - add bison checks
-- implement proper dead-zone in input handling
-- shrink textures: a lot!
+
 - collision detection
 - virtual tiles in the editor
 - animated tiles
+
+Input Handling:
+---------------
 - add option to invert axis
+- implement proper dead-zone in input handling
 
 # EOF #

Modified: trunk/windstille/src/navigation/navigation_graph.cpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-17 17:28:15 UTC (rev 1456)
+++ trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-18 00:17:13 UTC (rev 1457)
@@ -268,4 +268,18 @@
   out << ")\n";
 }
 
+bool
+NavigationGraph::valid(Segment* segment)
+{
+  // FIXME: Slow
+  return std::find(segments.begin(), segments.end(), segment) != segments.end();
+}
+
+bool
+NavigationGraph::valid(Node* node)
+{
+  // FIXME: Slow
+  return std::find(nodes.begin(), nodes.end(), node) != nodes.end();
+}
+
 /* EOF */

Modified: trunk/windstille/src/navigation/navigation_graph.hpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-17 17:28:15 UTC (rev 1456)
+++ trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-18 00:17:13 UTC (rev 1457)
@@ -115,6 +115,8 @@
 
   void save(std::ostream& out);
 
+  bool valid(Segment* segment);
+  bool valid(Node*    node);
 private:
   NavigationGraph (const NavigationGraph&);
   NavigationGraph& operator= (const NavigationGraph&);

Modified: trunk/windstille/src/navigation/segment_position.cpp
===================================================================
--- trunk/windstille/src/navigation/segment_position.cpp	2007-06-17 17:28:15 UTC (rev 1456)
+++ trunk/windstille/src/navigation/segment_position.cpp	2007-06-18 00:17:13 UTC (rev 1457)
@@ -121,11 +121,4 @@
   return p1 + pos*(p2 - p1);
 }
 
-void
-SegmentPosition::draw()
-{
-  Display::fill_circle(get_pos(), 16.0f, Color(0.0f, 0.0f, 1.0f, 0.5f));
-  Display::fill_circle(get_pos(), 8.0f, Color(0.0f, 1.0f, 1.0f));
-}
-
 /* EOF */

Modified: trunk/windstille/src/navigation/segment_position.hpp
===================================================================
--- trunk/windstille/src/navigation/segment_position.hpp	2007-06-17 17:28:15 UTC (rev 1456)
+++ trunk/windstille/src/navigation/segment_position.hpp	2007-06-18 00:17:13 UTC (rev 1457)
@@ -78,8 +78,6 @@
   float    get_float_pos() const { return pos; }
 
   Vector get_pos() const;
-
-  void draw();
 };
 
 #endif

Modified: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-17 17:28:15 UTC (rev 1456)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-18 00:17:13 UTC (rev 1457)
@@ -90,8 +90,9 @@
 
   if (connection)
     {
-      connection->draw();
-      
+      Display::fill_circle(connection->get_pos(), 16.0f, Color(0.0f, 0.0f, 1.0f, 0.5f));
+      Display::fill_circle(connection->get_pos(), 8.0f, Color(0.0f, 1.0f, 1.0f));
+     
       Display::draw_line(connection->get_pos(), connection->get_pos() + 100.0f*stick,
                          Color(1.0f, 1.0f, 1.0f, 1.0f));
     }
@@ -253,6 +254,12 @@
   else
     selected_segment = 0;
 
+  if (connection && !graph->valid(connection->get_segment()))
+    {
+      delete connection;
+      connection = 0;
+    }
+
   old_player = player;
 }
 



From grumbel at mail.berlios.de  Mon Jun 18 03:35:46 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 18 Jun 2007 03:35:46 +0200
Subject: [Windstille-commit] r1458 - in trunk/windstille: . src
Message-ID: <200706180135.l5I1Zkru001180@sheep.berlios.de>

Author: grumbel
Date: 2007-06-18 03:35:45 +0200 (Mon, 18 Jun 2007)
New Revision: 1458

Modified:
   trunk/windstille/SConstruct
   trunk/windstille/src/SConscript
Log:
- added Dmitry Marakasov <amdmi3 at amdmi3.ru> freebsd build patches
- added way to set options for compile

Modified: trunk/windstille/SConstruct
===================================================================
--- trunk/windstille/SConstruct	2007-06-18 00:17:13 UTC (rev 1457)
+++ trunk/windstille/SConstruct	2007-06-18 01:35:45 UTC (rev 1458)
@@ -99,7 +99,25 @@
     return output
 
 
+# FIXME: Add check for ICONV_CONST
+
 conf_env = Environment()
+
+opts = Options(['options.cache', 'custom.py'], ARGUMENTS)
+opts.Add('CPPPATH', 'Additional preprocessor paths')
+opts.Add('CPPFLAGS', 'Additional preprocessor flags')
+opts.Add('CPPDEFINES', 'defined constants')
+opts.Add('LIBPATH', 'Additional library paths')
+opts.Add('LIBS', 'Additional libraries')
+opts.Add('CCFLAGS', 'C Compiler flags')
+opts.Add('LINKFLAGS', 'Linker Compiler flags')
+opts.Add('CC', 'C Compiler')
+opts.Add('CXX', 'C++ Compiler')  
+opts.Update(conf_env)
+opts.Save('options.cache', conf_env)
+
+Help(opts.GenerateHelpText(conf_env))
+
 conf = Configure(conf_env, custom_tests = { 'Check32bit' : Check32bit })
 if conf.Check32bit() == "64bit":
   conf.env.Append(CXXFLAGS="-D_SQ64")

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-18 00:17:13 UTC (rev 1457)
+++ trunk/windstille/src/SConscript	2007-06-18 01:35:45 UTC (rev 1458)
@@ -26,12 +26,11 @@
 
 Import('conf_env')
 
-env = Environment(CC = 'gcc',
-                  CXX = 'g++',
-                  CXXFLAGS = ['-O0', '-Wall', '-Werror', '-g', '-DDEBUG'] + conf_env['CXXFLAGS'])
+env = conf_env.Copy()
+env.Append(LIBS    = ['GL', 'GLU', 'squirrel', 'physfs', 'SDL_image', 'openal', 'glew', 'ogg', 'vorbis', 'vorbisfile', 'png'])
+env.Append(LIBPATH = ['../lib/'] )
+env.Append(CPPPATH = ['.', '..', '../lib/SQUIRREL2/include/', '../lib/glew'])
 
-env.Append(CXXFLAGS = conf_env['CXXFLAGS'])
-
 # env.Copy(LIBS = ['a', 'b'])
 
 env.foo = 5
@@ -189,9 +188,6 @@
 'sprite3d/sprite3d.cpp',
 'tinygettext/gettext.cpp',
 'tinygettext/tinygettext.cpp'
-],
-LIBS    = ['GL', 'GLU', 'squirrel', 'physfs', 'SDL_image', 'openal', 'glew', 'ogg', 'vorbis', 'vorbisfile', 'png'] + env['LIBS'],
-LIBPATH = ['../lib/'],
-CPPPATH = env['CPPPATH'] + ['.', '..', '../lib/SQUIRREL2/include/', '../lib/glew'])
+])
 
 # EOF #



From grumbel at mail.berlios.de  Mon Jun 18 04:13:19 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 18 Jun 2007 04:13:19 +0200
Subject: [Windstille-commit] r1459 - in trunk/windstille: . src src/display
	src/scripting src/sprite2d src/sprite3d
Message-ID: <200706180213.l5I2DJCF002902@sheep.berlios.de>

Author: grumbel
Date: 2007-06-18 04:13:15 +0200 (Mon, 18 Jun 2007)
New Revision: 1459

Modified:
   trunk/windstille/SConstruct
   trunk/windstille/src/SConscript
   trunk/windstille/src/box.cpp
   trunk/windstille/src/character.cpp
   trunk/windstille/src/config.cpp
   trunk/windstille/src/console.cpp
   trunk/windstille/src/display/surface.cpp
   trunk/windstille/src/display/surface_manager.cpp
   trunk/windstille/src/display/texture.cpp
   trunk/windstille/src/display/texture_manager.cpp
   trunk/windstille/src/display/vertex_array_drawing_request.cpp
   trunk/windstille/src/elevator.cpp
   trunk/windstille/src/graphic_context_state.cpp
   trunk/windstille/src/grenade.cpp
   trunk/windstille/src/lisp_getters.cpp
   trunk/windstille/src/physics.cpp
   trunk/windstille/src/pistol.cpp
   trunk/windstille/src/player.cpp
   trunk/windstille/src/script_manager.cpp
   trunk/windstille/src/scriptable_object.cpp
   trunk/windstille/src/scripting/SConscript
   trunk/windstille/src/scripting/game_objects.cpp
   trunk/windstille/src/scripting/game_objects.hpp
   trunk/windstille/src/scripting/interface.cpp
   trunk/windstille/src/scripting/interface.hpp
   trunk/windstille/src/scripting/squirrel_error.cpp
   trunk/windstille/src/scripting/squirrel_error.hpp
   trunk/windstille/src/scripting/util.cpp
   trunk/windstille/src/scripting/util.hpp
   trunk/windstille/src/scripting/wrapper.cpp
   trunk/windstille/src/scripting/wrapper.hpp
   trunk/windstille/src/sector.cpp
   trunk/windstille/src/sprite2d/sprite.cpp
   trunk/windstille/src/sprite3d/data.cpp
   trunk/windstille/src/tile_factory.cpp
   trunk/windstille/src/tile_packer.cpp
   trunk/windstille/src/timer.cpp
   trunk/windstille/src/windstille_main.cpp
Log:
- removed some config.h
- renamed namespace scripting back to Scripting due to being hardcoded in miniswig

Modified: trunk/windstille/SConstruct
===================================================================
--- trunk/windstille/SConstruct	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/SConstruct	2007-06-18 02:13:15 UTC (rev 1459)
@@ -101,6 +101,10 @@
 
 # FIXME: Add check for ICONV_CONST
 
+# BuildDir('build/src',   'src', duplicate=0)
+# BuildDir('build/lib',   'lib', duplicate=0)
+# BuildDir('build/tools', 'tools', duplicate=0)
+
 conf_env = Environment()
 
 opts = Options(['options.cache', 'custom.py'], ARGUMENTS)
@@ -115,7 +119,6 @@
 opts.Add('CXX', 'C++ Compiler')  
 opts.Update(conf_env)
 opts.Save('options.cache', conf_env)
-
 Help(opts.GenerateHelpText(conf_env))
 
 conf = Configure(conf_env, custom_tests = { 'Check32bit' : Check32bit })
@@ -125,9 +128,13 @@
 
 Export('conf_env')
 
+# SConscript('build/tools/SConscript')
+# SConscript('build/lib/SConscript')
+# SConscript('build/src/SConscript')
+# SConscript('build/src/scripting/SConscript')
+
 SConscript('tools/SConscript')
-SConscript('lib//SConscript')
+SConscript('lib/SConscript')
 SConscript('src/SConscript')
-SConscript('src/scripting/SConscript')
 
 # EOF #

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/SConscript	2007-06-18 02:13:15 UTC (rev 1459)
@@ -26,6 +26,8 @@
 
 Import('conf_env')
 
+SConscript('scripting/SConscript')
+
 env = conf_env.Copy()
 env.Append(LIBS    = ['GL', 'GLU', 'squirrel', 'physfs', 'SDL_image', 'openal', 'glew', 'ogg', 'vorbis', 'vorbisfile', 'png'])
 env.Append(LIBPATH = ['../lib/'] )

Modified: trunk/windstille/src/box.cpp
===================================================================
--- trunk/windstille/src/box.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/box.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -16,7 +16,6 @@
 //  You should have received a copy of the GNU General Public License
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-#include <config.h>
 
 #include "box.hpp"
 #include "globals.hpp"

Modified: trunk/windstille/src/character.cpp
===================================================================
--- trunk/windstille/src/character.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/character.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -16,7 +16,6 @@
 //  You should have received a copy of the GNU General Public License
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-#include <config.h>
 
 #include "character.hpp"
 #include "sector.hpp"

Modified: trunk/windstille/src/config.cpp
===================================================================
--- trunk/windstille/src/config.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/config.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -23,11 +23,12 @@
 **  02111-1307, USA.
 */
 
-#include "config.hpp"
+#include "windstille.hpp"
+
 #include <boost/format.hpp>
-#include <config.h>
 #include <memory>
 #include <iostream>
+#include "config.hpp"
 #include "tinygettext/gettext.hpp"
 #include "lisp/lisp.hpp"
 #include "lisp/parser.hpp"
@@ -261,7 +262,7 @@
           break;
 
         case 'v':
-          std::cout << "Windstille " << PACKAGE_VERSION << std::endl;
+          std::cout << "Windstille " << WINDSTILLE_VERSION << std::endl;
           exit(EXIT_SUCCESS);
           break;
 

Modified: trunk/windstille/src/console.cpp
===================================================================
--- trunk/windstille/src/console.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/console.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -469,7 +469,7 @@
           const SQChar *s;
           if (SQ_SUCCEEDED(sq_getstring(v,-2, &s)))
             {
-              console << s << " -> " << scripting::squirrel2string(v, -1) << std::endl;
+              console << s << " -> " << Scripting::squirrel2string(v, -1) << std::endl;
             }
           else
             {
@@ -509,7 +509,7 @@
         if(SQ_SUCCEEDED(sq_call(vm,1, retval, true))) 
           {
             if (sq_gettype(vm, -1) != OT_NULL)
-              console << scripting::squirrel2string(vm, -1) << std::endl;
+              console << Scripting::squirrel2string(vm, -1) << std::endl;
           }
       }
     }

Modified: trunk/windstille/src/display/surface.cpp
===================================================================
--- trunk/windstille/src/display/surface.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/display/surface.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -22,7 +22,6 @@
 **  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
 **  02111-1307, USA.
 */
-#include <config.h>
 
 #include "surface.hpp"
 #include "math/vector.hpp"

Modified: trunk/windstille/src/display/surface_manager.cpp
===================================================================
--- trunk/windstille/src/display/surface_manager.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/display/surface_manager.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -1,4 +1,3 @@
-#include <config.h>
 
 #include "surface_manager.hpp"
 

Modified: trunk/windstille/src/display/texture.cpp
===================================================================
--- trunk/windstille/src/display/texture.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/display/texture.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -23,7 +23,6 @@
 **  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
 **  02111-1307, USA.
 */
-#include <config.h>
 
 #include <stdexcept>
 #include <iostream>

Modified: trunk/windstille/src/display/texture_manager.cpp
===================================================================
--- trunk/windstille/src/display/texture_manager.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/display/texture_manager.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -1,4 +1,3 @@
-#include <config.h>
 
 #include "texture_manager.hpp"
 

Modified: trunk/windstille/src/display/vertex_array_drawing_request.cpp
===================================================================
--- trunk/windstille/src/display/vertex_array_drawing_request.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/display/vertex_array_drawing_request.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -23,7 +23,6 @@
 **  02111-1307, USA.
 */
 
-#include <config.h>
 
 #include <assert.h>
 

Modified: trunk/windstille/src/elevator.cpp
===================================================================
--- trunk/windstille/src/elevator.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/elevator.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -21,7 +21,6 @@
 **  along with this program; if not, write to the Free Software
 **  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */
-#include <config.h>
 
 #include "elevator.hpp"
 #include "sector.hpp"

Modified: trunk/windstille/src/graphic_context_state.cpp
===================================================================
--- trunk/windstille/src/graphic_context_state.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/graphic_context_state.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -16,7 +16,6 @@
 //  You should have received a copy of the GNU General Public License
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-#include <config.h>
 
 #include <math.h>
 #include <GL/glew.h>

Modified: trunk/windstille/src/grenade.cpp
===================================================================
--- trunk/windstille/src/grenade.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/grenade.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -22,7 +22,6 @@
 **  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
 **  02111-1307, USA.
 */
-#include <config.h>
 
 #include "grenade.hpp"
 #include "sector.hpp"

Modified: trunk/windstille/src/lisp_getters.cpp
===================================================================
--- trunk/windstille/src/lisp_getters.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/lisp_getters.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -23,7 +23,6 @@
 **  02111-1307, USA.
 */
 
-#include <config.h>
 
 #include "lisp/lisp.hpp"
 #include "lisp/getters.hpp"

Modified: trunk/windstille/src/physics.cpp
===================================================================
--- trunk/windstille/src/physics.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/physics.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -1,4 +1,3 @@
-#include <config.h>
 
 #include "physics.hpp"
 

Modified: trunk/windstille/src/pistol.cpp
===================================================================
--- trunk/windstille/src/pistol.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/pistol.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -17,7 +17,6 @@
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
-#include <config.h>
 
 #include "laser_pointer.hpp"
 #include "pistol.hpp"

Modified: trunk/windstille/src/player.cpp
===================================================================
--- trunk/windstille/src/player.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/player.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -16,7 +16,6 @@
 //  You should have received a copy of the GNU General Public License
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-#include <config.h>
 
 #include "tile_map.hpp"
 #include "sector.hpp"

Modified: trunk/windstille/src/script_manager.cpp
===================================================================
--- trunk/windstille/src/script_manager.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/script_manager.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -18,7 +18,7 @@
 #include "scripting/squirrel_error.hpp"
 #include "physfs/physfs_stream.hpp"
 
-using namespace scripting;
+using namespace Scripting;
 
 ScriptManager* script_manager = 0;
 
@@ -58,7 +58,7 @@
   sq_setprintfunc(v, printfunc);
   
   // register windstille API
-  register_windstille_wrapper(v);
+  Scripting::register_windstille_wrapper(v);
 }
 
 ScriptManager::~ScriptManager()

Modified: trunk/windstille/src/scriptable_object.cpp
===================================================================
--- trunk/windstille/src/scriptable_object.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/scriptable_object.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -23,7 +23,6 @@
 **  02111-1307, USA.
 */
 
-#include <config.h>
 
 #include "globals.hpp"
 #include "scriptable_object.hpp"

Modified: trunk/windstille/src/scripting/SConscript
===================================================================
--- trunk/windstille/src/scripting/SConscript	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/scripting/SConscript	2007-06-18 02:13:15 UTC (rev 1459)
@@ -11,7 +11,7 @@
             ['interface.hpp', 'game_objects.hpp'])
 
 env.Depends(env.Command(['wrapper.cpp', 'wrapper.hpp'], 'miniswig.tmp',
-                        ["$MINISWIG  --input $SOURCE --output-cpp ${TARGETS[0]} --output-hpp ${TARGETS[1]} --module windstille --select-namespace scripting"]),
+                        ["$MINISWIG  --input $SOURCE --output-cpp ${TARGETS[0]} --output-hpp ${TARGETS[1]} --module windstille --select-namespace Scripting"]),
             miniswig)
 
 # EOF #

Modified: trunk/windstille/src/scripting/game_objects.cpp
===================================================================
--- trunk/windstille/src/scripting/game_objects.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/scripting/game_objects.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -3,7 +3,7 @@
 #include "sector.hpp"
 #include "game_objects.hpp"
 
-namespace scripting
+namespace Scripting
 {
 
 const std::string&

Modified: trunk/windstille/src/scripting/game_objects.hpp
===================================================================
--- trunk/windstille/src/scripting/game_objects.hpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/scripting/game_objects.hpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -15,7 +15,7 @@
 typedef Entity _Entity;
 #endif
 
-namespace scripting
+namespace Scripting
 {
 
 class GameObject

Modified: trunk/windstille/src/scripting/interface.cpp
===================================================================
--- trunk/windstille/src/scripting/interface.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/scripting/interface.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -40,7 +40,7 @@
 #include "display/display.hpp"
 #include "controller_help_window.hpp"
 
-namespace scripting
+namespace Scripting
 {
 
 void set_sector(const std::string& filename)
@@ -338,6 +338,6 @@
   return 0;
 }
 
-} // namespace scripting
+} // namespace Scripting
 
 /* EOF */

Modified: trunk/windstille/src/scripting/interface.hpp
===================================================================
--- trunk/windstille/src/scripting/interface.hpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/scripting/interface.hpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -31,7 +31,7 @@
 #include <squirrel.h>
 #endif
 
-namespace scripting {
+namespace Scripting {
 
 void set_sector(const std::string& filename);
 
@@ -122,7 +122,7 @@
  */
 SQInteger spawn_object(HSQUIRRELVM v) __custom;
 
-} // namespace scripting
+} // namespace Scripting
 
 #endif
 

Modified: trunk/windstille/src/scripting/squirrel_error.cpp
===================================================================
--- trunk/windstille/src/scripting/squirrel_error.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/scripting/squirrel_error.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -3,7 +3,7 @@
 #include "squirrel_error.hpp"
 #include <sstream>
 
-namespace scripting
+namespace Scripting
 {
 
 SquirrelError::SquirrelError(HSQUIRRELVM v, const std::string& message) throw()

Modified: trunk/windstille/src/scripting/squirrel_error.hpp
===================================================================
--- trunk/windstille/src/scripting/squirrel_error.hpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/scripting/squirrel_error.hpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -4,7 +4,7 @@
 #include <squirrel.h>
 #include <stdexcept>
 
-namespace scripting
+namespace Scripting
 {
 
 /** Exception class for squirrel errors, it takes a squirrelvm and uses

Modified: trunk/windstille/src/scripting/util.cpp
===================================================================
--- trunk/windstille/src/scripting/util.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/scripting/util.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -35,7 +35,7 @@
 
 #include "util.hpp"
 
-namespace scripting {
+namespace Scripting {
 
 std::string sq_to_lisp_string(std::string sq_str)
 {
@@ -419,6 +419,6 @@
   writer.end_list("squirrel-state");
 }
 
-} // namespace scripting
+} // namespace Scripting
 
 /* EOF */

Modified: trunk/windstille/src/scripting/util.hpp
===================================================================
--- trunk/windstille/src/scripting/util.hpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/scripting/util.hpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -33,7 +33,7 @@
 class Writer;
 };
 
-namespace scripting {
+namespace Scripting {
 
 // Squirrel to Lisp
 void        table_to_lisp(HSQUIRRELVM v, int table_idx, std::vector<lisp::Lisp*>& entries);
@@ -51,7 +51,7 @@
 void save_squirrel_table(HSQUIRRELVM v, int table_idx, const std::string& file);
 void load_squirrel_table(HSQUIRRELVM v, int table_idx, const std::string& file);
 
-} // namespace scripting
+} // namespace Scripting
 
 #endif
 

Modified: trunk/windstille/src/scripting/wrapper.cpp
===================================================================
--- trunk/windstille/src/scripting/wrapper.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/scripting/wrapper.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -13,14 +13,14 @@
 #include "squirrel_error.hpp"
 #include "wrapper.interface.hpp"
 
-namespace scripting
+namespace Scripting
 {
 namespace Wrapper
 {
 
 static SQInteger GameObject_release_hook(SQUserPointer ptr, SQInteger )
 {
-  scripting::GameObject* _this = reinterpret_cast<scripting::GameObject*> (ptr);
+  Scripting::GameObject* _this = reinterpret_cast<Scripting::GameObject*> (ptr);
   delete _this;
   return 0;
 }
@@ -32,7 +32,7 @@
     sq_throwerror(vm, _SC("'get_name' called without instance"));
     return SQ_ERROR;
   }
-  scripting::GameObject* _this = reinterpret_cast<scripting::GameObject*> (data);
+  Scripting::GameObject* _this = reinterpret_cast<Scripting::GameObject*> (data);
   
   try {
     const std::string& return_value = _this->get_name();
@@ -57,7 +57,7 @@
     sq_throwerror(vm, _SC("'remove' called without instance"));
     return SQ_ERROR;
   }
-  scripting::GameObject* _this = reinterpret_cast<scripting::GameObject*> (data);
+  Scripting::GameObject* _this = reinterpret_cast<Scripting::GameObject*> (data);
   
   try {
     _this->remove();
@@ -81,7 +81,7 @@
     sq_throwerror(vm, _SC("'set_active' called without instance"));
     return SQ_ERROR;
   }
-  scripting::GameObject* _this = reinterpret_cast<scripting::GameObject*> (data);
+  Scripting::GameObject* _this = reinterpret_cast<Scripting::GameObject*> (data);
   SQBool arg0;
   if(SQ_FAILED(sq_getbool(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a bool"));
@@ -110,7 +110,7 @@
     sq_throwerror(vm, _SC("'set_parent' called without instance"));
     return SQ_ERROR;
   }
-  scripting::GameObject* _this = reinterpret_cast<scripting::GameObject*> (data);
+  Scripting::GameObject* _this = reinterpret_cast<Scripting::GameObject*> (data);
   const SQChar* arg0;
   if(SQ_FAILED(sq_getstring(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a string"));
@@ -134,7 +134,7 @@
 
 static SQInteger TestObject_release_hook(SQUserPointer ptr, SQInteger )
 {
-  scripting::TestObject* _this = reinterpret_cast<scripting::TestObject*> (ptr);
+  Scripting::TestObject* _this = reinterpret_cast<Scripting::TestObject*> (ptr);
   delete _this;
   return 0;
 }
@@ -146,7 +146,7 @@
     sq_throwerror(vm, _SC("'set_sprite' called without instance"));
     return SQ_ERROR;
   }
-  scripting::TestObject* _this = reinterpret_cast<scripting::TestObject*> (data);
+  Scripting::TestObject* _this = reinterpret_cast<Scripting::TestObject*> (data);
   const SQChar* arg0;
   if(SQ_FAILED(sq_getstring(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a string"));
@@ -175,7 +175,7 @@
     sq_throwerror(vm, _SC("'set_action' called without instance"));
     return SQ_ERROR;
   }
-  scripting::TestObject* _this = reinterpret_cast<scripting::TestObject*> (data);
+  Scripting::TestObject* _this = reinterpret_cast<Scripting::TestObject*> (data);
   const SQChar* arg0;
   if(SQ_FAILED(sq_getstring(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a string"));
@@ -204,7 +204,7 @@
     sq_throwerror(vm, _SC("'set_pos' called without instance"));
     return SQ_ERROR;
   }
-  scripting::TestObject* _this = reinterpret_cast<scripting::TestObject*> (data);
+  Scripting::TestObject* _this = reinterpret_cast<Scripting::TestObject*> (data);
   SQFloat arg0;
   if(SQ_FAILED(sq_getfloat(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a float"));
@@ -238,7 +238,7 @@
     sq_throwerror(vm, _SC("'set_vflip' called without instance"));
     return SQ_ERROR;
   }
-  scripting::TestObject* _this = reinterpret_cast<scripting::TestObject*> (data);
+  Scripting::TestObject* _this = reinterpret_cast<Scripting::TestObject*> (data);
   SQBool arg0;
   if(SQ_FAILED(sq_getbool(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a bool"));
@@ -267,7 +267,7 @@
     sq_throwerror(vm, _SC("'attach' called without instance"));
     return SQ_ERROR;
   }
-  scripting::TestObject* _this = reinterpret_cast<scripting::TestObject*> (data);
+  Scripting::TestObject* _this = reinterpret_cast<Scripting::TestObject*> (data);
   const SQChar* arg0;
   if(SQ_FAILED(sq_getstring(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a string"));
@@ -296,7 +296,7 @@
 
 static SQInteger Player_release_hook(SQUserPointer ptr, SQInteger )
 {
-  scripting::Player* _this = reinterpret_cast<scripting::Player*> (ptr);
+  Scripting::Player* _this = reinterpret_cast<Scripting::Player*> (ptr);
   delete _this;
   return 0;
 }
@@ -308,7 +308,7 @@
     sq_throwerror(vm, _SC("'start_listening' called without instance"));
     return SQ_ERROR;
   }
-  scripting::Player* _this = reinterpret_cast<scripting::Player*> (data);
+  Scripting::Player* _this = reinterpret_cast<Scripting::Player*> (data);
   
   try {
     _this->start_listening();
@@ -332,7 +332,7 @@
     sq_throwerror(vm, _SC("'stop_listening' called without instance"));
     return SQ_ERROR;
   }
-  scripting::Player* _this = reinterpret_cast<scripting::Player*> (data);
+  Scripting::Player* _this = reinterpret_cast<Scripting::Player*> (data);
   
   try {
     _this->stop_listening();
@@ -351,7 +351,7 @@
 
 static SQInteger ScriptableObject_release_hook(SQUserPointer ptr, SQInteger )
 {
-  scripting::ScriptableObject* _this = reinterpret_cast<scripting::ScriptableObject*> (ptr);
+  Scripting::ScriptableObject* _this = reinterpret_cast<Scripting::ScriptableObject*> (ptr);
   delete _this;
   return 0;
 }
@@ -363,7 +363,7 @@
     sq_throwerror(vm, _SC("'move_to' called without instance"));
     return SQ_ERROR;
   }
-  scripting::ScriptableObject* _this = reinterpret_cast<scripting::ScriptableObject*> (data);
+  Scripting::ScriptableObject* _this = reinterpret_cast<Scripting::ScriptableObject*> (data);
   SQFloat arg0;
   if(SQ_FAILED(sq_getfloat(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a float"));
@@ -407,7 +407,7 @@
     sq_throwerror(vm, _SC("'start_flash' called without instance"));
     return SQ_ERROR;
   }
-  scripting::ScriptableObject* _this = reinterpret_cast<scripting::ScriptableObject*> (data);
+  Scripting::ScriptableObject* _this = reinterpret_cast<Scripting::ScriptableObject*> (data);
   SQFloat arg0;
   if(SQ_FAILED(sq_getfloat(vm, 2, &arg0))) {
     sq_throwerror(vm, _SC("Argument 1 not a float"));
@@ -438,7 +438,7 @@
   }
   
   try {
-    scripting::set_sector(arg0);
+    Scripting::set_sector(arg0);
   
     return 0;
   
@@ -461,7 +461,7 @@
   }
   
   try {
-    scripting::play_music(arg0);
+    Scripting::play_music(arg0);
   
     return 0;
   
@@ -484,7 +484,7 @@
   }
   
   try {
-    scripting::stop_music(static_cast<float> (arg0));
+    Scripting::stop_music(static_cast<float> (arg0));
   
     return 0;
   
@@ -507,7 +507,7 @@
   }
   
   try {
-    scripting::play_sound(arg0);
+    Scripting::play_sound(arg0);
   
     return 0;
   
@@ -535,7 +535,7 @@
   }
   
   try {
-    scripting::caption_add(static_cast<int> (arg0), arg1);
+    Scripting::caption_add(static_cast<int> (arg0), arg1);
   
     return 0;
   
@@ -554,7 +554,7 @@
   (void) vm;
   
   try {
-    scripting::caption_clear();
+    Scripting::caption_clear();
   
     return 0;
   
@@ -573,7 +573,7 @@
   (void) vm;
   
   try {
-    scripting::caption_end();
+    Scripting::caption_end();
   
     return 0;
   
@@ -596,7 +596,7 @@
   }
   
   try {
-    scripting::camera_set_active(arg0 == SQTrue);
+    Scripting::camera_set_active(arg0 == SQTrue);
   
     return 0;
   
@@ -615,7 +615,7 @@
   (void) vm;
   
   try {
-    scripting::camera_continue_path();
+    Scripting::camera_continue_path();
   
     return 0;
   
@@ -634,7 +634,7 @@
   (void) vm;
   
   try {
-    scripting::camera_begin_path();
+    Scripting::camera_begin_path();
   
     return 0;
   
@@ -667,7 +667,7 @@
   }
   
   try {
-    scripting::camera_add_point(static_cast<float> (arg0), static_cast<float> (arg1), static_cast<float> (arg2));
+    Scripting::camera_add_point(static_cast<float> (arg0), static_cast<float> (arg1), static_cast<float> (arg2));
   
     return 0;
   
@@ -686,7 +686,7 @@
   (void) vm;
   
   try {
-    scripting::camera_end_path();
+    Scripting::camera_end_path();
   
     return 0;
   
@@ -714,7 +714,7 @@
   }
   
   try {
-    scripting::camera_set_pos(static_cast<float> (arg0), static_cast<float> (arg1));
+    Scripting::camera_set_pos(static_cast<float> (arg0), static_cast<float> (arg1));
   
     return 0;
   
@@ -737,7 +737,7 @@
   }
   
   try {
-    scripting::camera_set_zoom(static_cast<float> (arg0));
+    Scripting::camera_set_zoom(static_cast<float> (arg0));
   
     return 0;
   
@@ -760,7 +760,7 @@
   }
   
   try {
-    scripting::set_controller_help_active(arg0 == SQTrue);
+    Scripting::set_controller_help_active(arg0 == SQTrue);
   
     return 0;
   
@@ -798,7 +798,7 @@
   }
   
   try {
-    scripting::dialog_show(static_cast<int> (arg0), arg1, arg2, arg3);
+    Scripting::dialog_show(static_cast<int> (arg0), arg1, arg2, arg3);
   
     return 0;
   
@@ -817,7 +817,7 @@
   HSQUIRRELVM arg0 = vm;
   
   try {
-    scripting::wait_for_dialog(arg0);
+    Scripting::wait_for_dialog(arg0);
   
     return sq_suspendvm(vm);
   
@@ -836,7 +836,7 @@
   HSQUIRRELVM arg0 = vm;
   
   try {
-    scripting::wait_for_fade(arg0);
+    Scripting::wait_for_fade(arg0);
   
     return sq_suspendvm(vm);
   
@@ -855,7 +855,7 @@
   HSQUIRRELVM arg0 = vm;
   
   try {
-    scripting::wait_for_camera(arg0);
+    Scripting::wait_for_camera(arg0);
   
     return sq_suspendvm(vm);
   
@@ -878,7 +878,7 @@
   }
   
   try {
-    scripting::conversation_add(arg0);
+    Scripting::conversation_add(arg0);
   
     return 0;
   
@@ -897,7 +897,7 @@
   (void) vm;
   
   try {
-    scripting::conversation_show();
+    Scripting::conversation_show();
   
     return 0;
   
@@ -915,7 +915,7 @@
 {
   
   try {
-    int return_value = scripting::conversation_get_selection();
+    int return_value = Scripting::conversation_get_selection();
   
     sq_pushinteger(vm, return_value);
     return 1;
@@ -935,7 +935,7 @@
   HSQUIRRELVM arg0 = vm;
   
   try {
-    scripting::wait_for_conversation(arg0);
+    Scripting::wait_for_conversation(arg0);
   
     return sq_suspendvm(vm);
   
@@ -963,7 +963,7 @@
   }
   
   try {
-    scripting::add_objective(arg0, arg1);
+    Scripting::add_objective(arg0, arg1);
   
     return 0;
   
@@ -986,7 +986,7 @@
   }
   
   try {
-    scripting::objective_complete(arg0);
+    Scripting::objective_complete(arg0);
   
     return 0;
   
@@ -1009,7 +1009,7 @@
   }
   
   try {
-    bool return_value = scripting::is_objective_given(arg0);
+    bool return_value = Scripting::is_objective_given(arg0);
   
     sq_pushbool(vm, return_value);
     return 1;
@@ -1033,7 +1033,7 @@
   }
   
   try {
-    bool return_value = scripting::is_objective_complete(arg0);
+    bool return_value = Scripting::is_objective_complete(arg0);
   
     sq_pushbool(vm, return_value);
     return 1;
@@ -1053,7 +1053,7 @@
   HSQUIRRELVM arg0 = vm;
   
   try {
-    bool return_value = scripting::run_before(arg0);
+    bool return_value = Scripting::run_before(arg0);
   
     sq_pushbool(vm, return_value);
     return 1;
@@ -1078,7 +1078,7 @@
   }
   
   try {
-    scripting::save_state(arg0, arg1);
+    Scripting::save_state(arg0, arg1);
   
     return 0;
   
@@ -1102,7 +1102,7 @@
   }
   
   try {
-    scripting::load_state(arg0, arg1);
+    Scripting::load_state(arg0, arg1);
   
     return 0;
   
@@ -1121,7 +1121,7 @@
   (void) vm;
   
   try {
-    scripting::list_objects();
+    Scripting::list_objects();
   
     return 0;
   
@@ -1144,7 +1144,7 @@
   }
   
   try {
-    scripting::set_debug(arg0 == SQTrue);
+    Scripting::set_debug(arg0 == SQTrue);
   
     return 0;
   
@@ -1162,7 +1162,7 @@
 {
   
   try {
-    bool return_value = scripting::get_debug();
+    bool return_value = Scripting::get_debug();
   
     sq_pushbool(vm, return_value);
     return 1;
@@ -1181,7 +1181,7 @@
 {
   
   try {
-    float return_value = scripting::get_game_speed();
+    float return_value = Scripting::get_game_speed();
   
     sq_pushfloat(vm, return_value);
     return 1;
@@ -1205,7 +1205,7 @@
   }
   
   try {
-    scripting::set_game_speed(static_cast<float> (arg0));
+    Scripting::set_game_speed(static_cast<float> (arg0));
   
     return 0;
   
@@ -1229,7 +1229,7 @@
   }
   
   try {
-    scripting::wait(arg0, static_cast<float> (arg1));
+    Scripting::wait(arg0, static_cast<float> (arg1));
   
     return sq_suspendvm(vm);
   
@@ -1245,12 +1245,12 @@
 
 static SQInteger display_wrapper(HSQUIRRELVM vm)
 {
-  return scripting::display(vm);
+  return Scripting::display(vm);
 }
 
 static SQInteger println_wrapper(HSQUIRRELVM vm)
 {
-  return scripting::println(vm);
+  return Scripting::println(vm);
 }
 
 static SQInteger set_console_font_wrapper(HSQUIRRELVM vm)
@@ -1267,7 +1267,7 @@
   }
   
   try {
-    scripting::set_console_font(arg0, static_cast<int> (arg1));
+    Scripting::set_console_font(arg0, static_cast<int> (arg1));
   
     return 0;
   
@@ -1290,7 +1290,7 @@
   }
   
   try {
-    scripting::set_gamma(static_cast<float> (arg0));
+    Scripting::set_gamma(static_cast<float> (arg0));
   
     return 0;
   
@@ -1323,7 +1323,7 @@
   }
   
   try {
-    scripting::set_gamma_rgb(static_cast<float> (arg0), static_cast<float> (arg1), static_cast<float> (arg2));
+    Scripting::set_gamma_rgb(static_cast<float> (arg0), static_cast<float> (arg1), static_cast<float> (arg2));
   
     return 0;
   
@@ -1342,7 +1342,7 @@
   (void) vm;
   
   try {
-    scripting::show_config();
+    Scripting::show_config();
   
     return 0;
   
@@ -1361,7 +1361,7 @@
   (void) vm;
   
   try {
-    scripting::cutscene_begin();
+    Scripting::cutscene_begin();
   
     return 0;
   
@@ -1380,7 +1380,7 @@
   (void) vm;
   
   try {
-    scripting::cutscene_end();
+    Scripting::cutscene_end();
   
     return 0;
   
@@ -1418,7 +1418,7 @@
   }
   
   try {
-    scripting::internal_fadeout_rgb(static_cast<float> (arg0), static_cast<float> (arg1), static_cast<float> (arg2), static_cast<float> (arg3));
+    Scripting::internal_fadeout_rgb(static_cast<float> (arg0), static_cast<float> (arg1), static_cast<float> (arg2), static_cast<float> (arg3));
   
     return 0;
   
@@ -1441,7 +1441,7 @@
   }
   
   try {
-    scripting::internal_fadein(static_cast<float> (arg0));
+    Scripting::internal_fadein(static_cast<float> (arg0));
   
     return 0;
   
@@ -1459,7 +1459,7 @@
 {
   
   try {
-    int return_value = scripting::render_mask_get();
+    int return_value = Scripting::render_mask_get();
   
     sq_pushinteger(vm, return_value);
     return 1;
@@ -1483,7 +1483,7 @@
   }
   
   try {
-    scripting::render_mask_set(static_cast<int> (arg0));
+    Scripting::render_mask_set(static_cast<int> (arg0));
   
     return 0;
   
@@ -1499,12 +1499,12 @@
 
 static SQInteger spawn_object_wrapper(HSQUIRRELVM vm)
 {
-  return scripting::spawn_object(vm);
+  return Scripting::spawn_object(vm);
 }
 
 } // end of namespace Wrapper
 
-void create_squirrel_instance(HSQUIRRELVM v, scripting::GameObject* object, bool setup_releasehook)
+void create_squirrel_instance(HSQUIRRELVM v, Scripting::GameObject* object, bool setup_releasehook)
 {
   using namespace Wrapper;
 
@@ -1530,7 +1530,7 @@
   sq_remove(v, -2); // remove root table
 }
 
-void create_squirrel_instance(HSQUIRRELVM v, scripting::TestObject* object, bool setup_releasehook)
+void create_squirrel_instance(HSQUIRRELVM v, Scripting::TestObject* object, bool setup_releasehook)
 {
   using namespace Wrapper;
 
@@ -1556,7 +1556,7 @@
   sq_remove(v, -2); // remove root table
 }
 
-void create_squirrel_instance(HSQUIRRELVM v, scripting::Player* object, bool setup_releasehook)
+void create_squirrel_instance(HSQUIRRELVM v, Scripting::Player* object, bool setup_releasehook)
 {
   using namespace Wrapper;
 
@@ -1582,7 +1582,7 @@
   sq_remove(v, -2); // remove root table
 }
 
-void create_squirrel_instance(HSQUIRRELVM v, scripting::ScriptableObject* object, bool setup_releasehook)
+void create_squirrel_instance(HSQUIRRELVM v, Scripting::ScriptableObject* object, bool setup_releasehook)
 {
   using namespace Wrapper;
 
@@ -2072,5 +2072,5 @@
 
 }
 
-} // end of namespace scripting
+} // end of namespace Scripting
 

Modified: trunk/windstille/src/scripting/wrapper.hpp
===================================================================
--- trunk/windstille/src/scripting/wrapper.hpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/scripting/wrapper.hpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -9,15 +9,15 @@
 #include <squirrel.h>
 #include "wrapper.interface.hpp"
 
-namespace scripting
+namespace Scripting
 {
 
 void register_windstille_wrapper(HSQUIRRELVM v);
 
-void create_squirrel_instance(HSQUIRRELVM v, scripting::GameObject* object, bool setup_releasehook = false);
-void create_squirrel_instance(HSQUIRRELVM v, scripting::TestObject* object, bool setup_releasehook = false);
-void create_squirrel_instance(HSQUIRRELVM v, scripting::Player* object, bool setup_releasehook = false);
-void create_squirrel_instance(HSQUIRRELVM v, scripting::ScriptableObject* object, bool setup_releasehook = false);
+void create_squirrel_instance(HSQUIRRELVM v, Scripting::GameObject* object, bool setup_releasehook = false);
+void create_squirrel_instance(HSQUIRRELVM v, Scripting::TestObject* object, bool setup_releasehook = false);
+void create_squirrel_instance(HSQUIRRELVM v, Scripting::Player* object, bool setup_releasehook = false);
+void create_squirrel_instance(HSQUIRRELVM v, Scripting::ScriptableObject* object, bool setup_releasehook = false);
 
 }
 

Modified: trunk/windstille/src/sector.cpp
===================================================================
--- trunk/windstille/src/sector.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/sector.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -16,7 +16,6 @@
 //  You should have received a copy of the GNU General Public License
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-#include <config.h>
 
 #include <iostream>
 #include <sstream>
@@ -275,7 +274,7 @@
 void
 Sector::remove_object_from_squirrel(GameObject* object)
 {
-  using namespace scripting;
+  using namespace Scripting;
 
   // get objects table
   HSQUIRRELVM v = script_manager->get_vm();
@@ -307,30 +306,30 @@
 {
   ScriptableObject* script_obj = dynamic_cast<ScriptableObject*> (object);
   if(script_obj) {
-    create_squirrel_instance(v, new scripting::ScriptableObject(script_obj),
+    create_squirrel_instance(v, new Scripting::ScriptableObject(script_obj),
                              true);
     return;
   }
   
   TestObject* tobj = dynamic_cast<TestObject*> (object);
   if(tobj) {
-    create_squirrel_instance(v, new scripting::TestObject(tobj), true);
+    create_squirrel_instance(v, new Scripting::TestObject(tobj), true);
     return;
   }                                                                             
 
   Player* player = dynamic_cast<Player*> (object);
   if(player) {
-    create_squirrel_instance(v, new scripting::Player(player), true);
+    create_squirrel_instance(v, new Scripting::Player(player), true);
     return;
   }
 
-  create_squirrel_instance(v, new scripting::GameObject(object), true);
+  create_squirrel_instance(v, new Scripting::GameObject(object), true);
 }
 
 void
 Sector::expose_object_to_squirrel(GameObject* object)
 {
-  using namespace scripting;
+  using namespace Scripting;
 
   // get objects table
   HSQUIRRELVM v = script_manager->get_vm();

Modified: trunk/windstille/src/sprite2d/sprite.cpp
===================================================================
--- trunk/windstille/src/sprite2d/sprite.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/sprite2d/sprite.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -1,4 +1,3 @@
-#include <config.h>
 
 #include "sprite2d/sprite.hpp"
 

Modified: trunk/windstille/src/sprite3d/data.cpp
===================================================================
--- trunk/windstille/src/sprite3d/data.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/sprite3d/data.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -1,4 +1,3 @@
-#include <config.h>
 
 #include "sprite3d/data.hpp"
 

Modified: trunk/windstille/src/tile_factory.cpp
===================================================================
--- trunk/windstille/src/tile_factory.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/tile_factory.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -16,7 +16,6 @@
 //  You should have received a copy of the GNU General Public License
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-#include <config.h>
 
 #include <string>
 #include <sstream>

Modified: trunk/windstille/src/tile_packer.cpp
===================================================================
--- trunk/windstille/src/tile_packer.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/tile_packer.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -22,7 +22,6 @@
 **  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
 **  02111-1307, USA.
 */
-#include <config.h>
 
 #include <assert.h>
 #include <GL/glew.h>

Modified: trunk/windstille/src/timer.cpp
===================================================================
--- trunk/windstille/src/timer.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/timer.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -17,7 +17,6 @@
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
 //  02111-1307, USA.
-#include <config.h>
 
 #include <math.h>
 #include "timer.hpp"

Modified: trunk/windstille/src/windstille_main.cpp
===================================================================
--- trunk/windstille/src/windstille_main.cpp	2007-06-18 01:35:45 UTC (rev 1458)
+++ trunk/windstille/src/windstille_main.cpp	2007-06-18 02:13:15 UTC (rev 1459)
@@ -22,8 +22,9 @@
 **  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
 **  02111-1307, USA.
 */
-#include <config.h>
 
+#include "windstille.hpp"
+
 #include <stdio.h>
 #include <physfs.h>
 
@@ -276,9 +277,9 @@
 
   // Initialize physfs (this is a slightly modified version of
   // PHYSFS_setSaneConfig
-  const char* application = PACKAGE_NAME;
+  const char* application = "windstille";
   const char* userdir = PHYSFS_getUserDir();
-  const char* dirsep = PHYSFS_getDirSeparator();
+  const char* dirsep  = PHYSFS_getDirSeparator();
   char* writedir = new char[strlen(userdir) + strlen(application) + 2];
 
   // Set configuration directory



From grumbel at mail.berlios.de  Mon Jun 18 06:03:32 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 18 Jun 2007 06:03:32 +0200
Subject: [Windstille-commit] r1460 - in trunk/windstille: . src src/display
Message-ID: <200706180403.l5I43WkR009047@sheep.berlios.de>

Author: grumbel
Date: 2007-06-18 06:03:31 +0200 (Mon, 18 Jun 2007)
New Revision: 1460

Added:
   trunk/windstille/src/windstille.hpp
Modified:
   trunk/windstille/
   trunk/windstille/src/display/display.cpp
   trunk/windstille/src/display/display.hpp
   trunk/windstille/src/geometry_test.cpp
   trunk/windstille/src/math.hpp
Log:
- added functions for arc drawing
- added segments argument to change how many edges a circle has


Property changes on: trunk/windstille
___________________________________________________________________
Name: svn:ignore
   - 
aclocal.m4
autom4te.cache
cache
cache/
config.h.in
config.log
config.status
configure
custom.py
Jamconfig
Jamconfig.in
.sconf_temp
.sconf_temp/
.sconsign.dblite
windstille

   + 
aclocal.m4
autom4te.cache
cache
cache/
config.h.in
config.log
config.status
configure
custom.py
Jamconfig
Jamconfig.in
options.cache
.sconf_temp
.sconf_temp/
.sconsign.dblite
windstille


Modified: trunk/windstille/src/display/display.cpp
===================================================================
--- trunk/windstille/src/display/display.cpp	2007-06-18 02:13:15 UTC (rev 1459)
+++ trunk/windstille/src/display/display.cpp	2007-06-18 04:03:31 UTC (rev 1460)
@@ -32,6 +32,7 @@
 #include <SDL.h>
 #include "console.hpp"
 #include "config.hpp"
+#include "math.hpp"
 #include "display/opengl_state.hpp"
 #include "display.hpp"
 #include "util.hpp"
@@ -46,7 +47,7 @@
 {
   draw_line(line.p1, line.p2, color);
 }
-
+
 void
 Display::draw_segment(const Line& line, const Color& color)
 {
@@ -61,7 +62,7 @@
   draw_line(line,   color);
   draw_line(p3, p3 + normal, Color(0.0f, 1.0f, 1.0f));
 }
-
+
 void
 Display::draw_line(const Vector& pos1, const Vector& pos2, const Color& color)
 {
@@ -78,7 +79,7 @@
   glVertex2f(pos2.x, pos2.y);
   glEnd(); 
 }
-
+
 void
 Display::fill_rect(const Rectf& rect, const Color& color)
 {
@@ -96,7 +97,7 @@
   glVertex2f(rect.left,  rect.bottom);
   glEnd();
 }
-
+
 void
 Display::draw_rect(const Rectf& rect, const Color& color)
 {
@@ -115,7 +116,7 @@
   glVertex2f(rect.left,  rect.top);
   glEnd();
 }
-
+
 void
 Display::fill_rounded_rect(const Rectf& rect, float radius, const Color& color)
 {
@@ -157,7 +158,7 @@
     }
   glEnd();
 }
-
+
 void
 Display::draw_rounded_rect(const Rectf& rect, float radius, const Color& color)
 {
@@ -216,7 +217,7 @@
 
   glEnd();
 }
-
+
 int
 Display::get_width()
 {
@@ -228,7 +229,7 @@
 {
   return window->h;
 }
-
+
 void
 Display::init()
 {
@@ -254,16 +255,16 @@
 
   GLenum err = glewInit();
   if(err != GLEW_OK) {
-      std::ostringstream msg;
-      msg << "Display:: Couldn't initialize glew: " << glewGetString(err);
-      throw std::runtime_error(msg.str());
+    std::ostringstream msg;
+    msg << "Display:: Couldn't initialize glew: " << glewGetString(err);
+    throw std::runtime_error(msg.str());
   }
   /*
-  if(!GLEW_EXT_framebuffer_object) {
-      std::ostringstream msg;
-      msg << "Display:: Framebuffer opengl extension not supported";
-      throw std::runtime_error(msg.str());
-  }
+    if(!GLEW_EXT_framebuffer_object) {
+    std::ostringstream msg;
+    msg << "Display:: Framebuffer opengl extension not supported";
+    throw std::runtime_error(msg.str());
+    }
   */
 
   glViewport(0, 0, window->w, window->h);
@@ -285,7 +286,7 @@
 
   OpenGLState::init();
 }
-
+
 void
 Display::set_fullscreen(bool fullscreen)
 { 
@@ -300,10 +301,12 @@
       throw std::runtime_error("Display:: Couldn't create window");
     }
 }
-
+
 void
-Display::draw_circle(const Vector& pos, float radius, const Color& color)
+Display::draw_circle(const Vector& pos, float radius, const Color& color, int segments)
 {
+  assert(segments >= 0);
+
   OpenGLState state;
 
   state.enable(GL_BLEND);
@@ -312,10 +315,10 @@
   state.color(color);
   state.activate();
 
-  int n = 4;
+  float n = segments/4.0f;
   glBegin(GL_LINE_STRIP);
   glVertex2f(radius + pos.x, pos.y);
-  for(int i = 1; i < n * 4; ++i)
+  for(int i = 1; i < segments; ++i)
     {
       float x = cosf(i * (M_PI/2) / n) * radius;
       float y = sinf(i * (M_PI/2) / n) * radius;
@@ -325,10 +328,12 @@
   glVertex2f(radius + pos.x, pos.y);
   glEnd();
 }
-
+
 void
-Display::fill_circle(const Vector& pos, float radius, const Color& color)
+Display::fill_circle(const Vector& pos, float radius, const Color& color, int segments)
 {
+  assert(segments >= 0);
+
   OpenGLState state;
 
   state.enable(GL_BLEND);
@@ -336,11 +341,11 @@
   state.color(color);
   state.activate();
 
-  int n = 4;
+  float n = segments/4.0f;
   glBegin(GL_TRIANGLE_FAN);
   glVertex2f(pos.x, pos.y);
   glVertex2f(radius + pos.x, pos.y);
-  for(int i = 1; i < n * 4; ++i)
+  for(int i = 1; i < segments; ++i)
     {
       float x = cosf(i * (M_PI/2) / n) * radius;
       float y = sinf(i * (M_PI/2) / n) * radius;
@@ -350,8 +355,88 @@
   glVertex2f(radius + pos.x, pos.y);
   glEnd();
 }
+
+void
+Display::draw_arc(const Vector& pos, float radius, float start, float end, const Color& color, int segments)
+{
+  assert(segments >= 0);
 
+  if (fabs(end - start) >= 360.0f)
+    {
+      draw_circle(pos, radius, color, segments);
+    }
+  else
+    {
+      float step  = (2.0f * M_PI) / segments;
+
+      if (start > end) 
+        std::swap(start, end);
+
+      OpenGLState state;
+
+      state.enable(GL_BLEND);
+      state.set_blend_func(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
+      state.color(color);
+      state.activate();
+
+      start = math::deg2rad(start);
+      end   = math::deg2rad(end);
+
+      glBegin(GL_LINE_STRIP);
+      glVertex2f(pos.x, pos.y);
+
+      for(float angle = start; angle < end; angle += step)
+        glVertex2f(cosf(angle) * radius + pos.x,
+                   sinf(angle) * radius + pos.y);
+
+      glVertex2f(cosf(end) * radius + pos.x,
+                 sinf(end) * radius + pos.y);
+      glVertex2f(pos.x, pos.y);
+      glEnd();
+    }
+}
+
 void
+Display::fill_arc(const Vector& pos, float radius, float start, float end, const Color& color, int segments)
+{
+  assert(segments >= 0);
+
+  if (fabs(end - start) >= 360.0f)
+    {
+      fill_circle(pos, radius, color, segments);
+    }
+  else
+    {
+      float step  = (2.0f * M_PI) / segments;
+
+      if (start > end) 
+        std::swap(start, end);
+
+      OpenGLState state;
+
+      state.enable(GL_BLEND);
+      state.set_blend_func(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
+      state.color(color);
+      state.activate();
+
+      start = math::deg2rad(start);
+      end   = math::deg2rad(end);
+
+      glBegin(GL_TRIANGLE_FAN);
+      glVertex2f(pos.x, pos.y);
+
+      for(float angle = start; angle < end; angle += step)
+        glVertex2f(cosf(angle) * radius + pos.x,
+                   sinf(angle) * radius + pos.y);
+
+      glVertex2f(cosf(end) * radius + pos.x,
+                 sinf(end) * radius + pos.y);
+
+      glEnd();
+    }
+}
+
+void
 Display::push_cliprect(const Rect& rect_)
 {
   Rect rect = rect_;
@@ -391,7 +476,7 @@
       glDisable(GL_SCISSOR_TEST);
     }
 }
-
+
 void
 Display::set_gamma(float r, float g, float b)
 {
@@ -400,7 +485,7 @@
       // Couldn't set gamma
     }
 }
-
+
 void
 Display::save_screenshot(const std::string& filename)
 {
@@ -482,7 +567,7 @@
         }
     }
 }
-
+
 void
 Display::push_framebuffer(Framebuffer& framebuffer)
 {
@@ -491,7 +576,7 @@
   // to optimze some switches away
   glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, framebuffers.back().get_handle());
 }
-
+
 void
 Display::pop_framebuffer()
 {
@@ -505,10 +590,10 @@
     }
   else
     {
-          glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, 0);
+      glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, 0);
     }
 }
-
+
 Framebuffer
 Display::get_framebuffer()
 {
@@ -517,5 +602,5 @@
   else
     return framebuffers.back();
 }
-
+
 /* EOF */

Modified: trunk/windstille/src/display/display.hpp
===================================================================
--- trunk/windstille/src/display/display.hpp	2007-06-18 02:13:15 UTC (rev 1459)
+++ trunk/windstille/src/display/display.hpp	2007-06-18 04:03:31 UTC (rev 1460)
@@ -52,9 +52,12 @@
   static void draw_line(const Line& line, const Color& color);
   static void draw_line(const Vector& pos1, const Vector& pos2, const Color& color);
 
-  static void draw_circle(const Vector& pos, float radius, const Color& color);
-  static void fill_circle(const Vector& pos, float radius, const Color& color);
+  static void draw_circle(const Vector& pos, float radius, const Color& color, int segments = 16);
+  static void fill_circle(const Vector& pos, float radius, const Color& color, int segments = 16);
 
+  static void draw_arc(const Vector& pos, float radius, float start, float end, const Color& color, int segments = 16);
+  static void fill_arc(const Vector& pos, float radius, float start, float end, const Color& color, int segments = 16);
+
   static int  get_width();
   static int  get_height();
 

Modified: trunk/windstille/src/geometry_test.cpp
===================================================================
--- trunk/windstille/src/geometry_test.cpp	2007-06-18 02:13:15 UTC (rev 1459)
+++ trunk/windstille/src/geometry_test.cpp	2007-06-18 04:03:31 UTC (rev 1460)
@@ -68,6 +68,12 @@
   Vector c(a.project(b));
   
   Display::draw_line(line1.p1, line1.p1 + c, Color(1.0f, 1.0f, 1.0f, 0.5f));
+
+  int segments = std::max(0, int(cursor.y / 10));
+
+  Display::fill_arc(Vector(200, 200), 100.0f, cursor.x, cursor2.x, Color(1.0f, 1.0f, 1.0f, 0.5f), segments);
+  Display::draw_arc(Vector(200, 200), 100.0f, cursor.x, cursor2.x, Color(1.0f, 1.0f, 1.0f), segments);
+  Display::draw_circle(Vector(200, 200), 128.0f, Color(1.0f, 1.0f, 1.0f), segments);
 }
 
 void

Modified: trunk/windstille/src/math.hpp
===================================================================
--- trunk/windstille/src/math.hpp	2007-06-18 02:13:15 UTC (rev 1459)
+++ trunk/windstille/src/math.hpp	2007-06-18 04:03:31 UTC (rev 1460)
@@ -26,6 +26,9 @@
 #ifndef HEADER_MATH_HXX
 #define HEADER_MATH_HXX
 
+#include <assert.h>
+#include <math.h>
+
 namespace math {
 
 template<class T> 
@@ -52,6 +55,31 @@
   return max<T>((a), min<T>((b), (c)));
 }
 
+inline float normalize_angle(float radians)
+{
+  radians = fmod (radians, 2.0 * M_PI);
+  if (radians < 0.0)
+    radians += 2.0 * M_PI;
+  // Floating point math is so loathsome.  In sp98test, the assertion
+  // was barfing at P = 180 because a very small negative number plus
+  // 2 PI was equalling 2 PI.  Gakk!
+  if (radians == 2.0 * M_PI)
+    radians = 0.0;
+  
+  assert (radians >= 0.0 && radians < 2.0 * M_PI);
+  return radians;
+}
+
+inline float deg2rad(float degree)
+{
+  return degree / 180.0f * M_PI;
+}
+
+inline float rad2deg(float radians)
+{
+  return radians / M_PI * 180.0f;
+}
+
 } // namespace math
 
 #endif

Added: trunk/windstille/src/windstille.hpp
===================================================================
--- trunk/windstille/src/windstille.hpp	2007-06-18 02:13:15 UTC (rev 1459)
+++ trunk/windstille/src/windstille.hpp	2007-06-18 04:03:31 UTC (rev 1460)
@@ -0,0 +1,33 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_WINDSTILLE_HPP
+#define HEADER_WINDSTILLE_HPP
+
+#define WINDSTILLE_VERSION "0.3.1"
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/windstille.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Mon Jun 18 06:38:21 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 18 Jun 2007 06:38:21 +0200
Subject: [Windstille-commit] r1461 - in trunk/windstille/src: . sound
Message-ID: <200706180438.l5I4cLAH027269@sheep.berlios.de>

Author: grumbel
Date: 2007-06-18 06:38:19 +0200 (Mon, 18 Jun 2007)
New Revision: 1461

Modified:
   trunk/windstille/src/config.cpp
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/menu_manager.hpp
   trunk/windstille/src/sound/sound_manager.cpp
   trunk/windstille/src/sound/sound_manager.hpp
   trunk/windstille/src/windstille_main.cpp
Log:
- added master volume control

Modified: trunk/windstille/src/config.cpp
===================================================================
--- trunk/windstille/src/config.cpp	2007-06-18 04:03:31 UTC (rev 1460)
+++ trunk/windstille/src/config.cpp	2007-06-18 04:38:19 UTC (rev 1461)
@@ -61,6 +61,8 @@
 
   add(new ConfigValue<std::string>("recorder-file",   _("File to which demos are recorded"), false));
   add(new ConfigValue<std::string>("playback-file",   _("File from which a demo is played"), false));
+
+  add(new ConfigValue<int>("master-volume",  _("Master Volume"), true, 100));
 }
 
 Config::~Config()

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-18 04:03:31 UTC (rev 1460)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-18 04:38:19 UTC (rev 1461)
@@ -24,6 +24,7 @@
 */
 
 #include "config.hpp"
+#include "sound/sound_manager.hpp"
 #include "console.hpp"
 #include "display/display.hpp"
 #include "font/fonts.hpp"
@@ -66,7 +67,9 @@
 
   menu->set_font(Fonts::vera20);
 
-  SliderMenuItem* music_volume_item = new SliderMenuItem(menu,  "Music Volume", 100, 0, 100, 10);
+  SliderMenuItem* music_volume_item = new SliderMenuItem(menu,  "Master Volume",   
+                                                         config.get_int("master-volume"), 0, 100, 10);
+  slots.push_back(music_volume_item->sig_change().connect(this, &MenuManager::menu_music_volume));
   menu->add_item(music_volume_item);
 
   SliderMenuItem* sfx_volume_item   = new SliderMenuItem(menu,  "SFX Volume",   100, 0, 100, 10);
@@ -584,4 +587,11 @@
   SDL_SetGamma(gamma, gamma, gamma);
 }
 
+void
+MenuManager::menu_music_volume(int i)
+{
+  config.set_int("master-volume", i);
+  sound_manager->set_listener_gain((i/100.0f));
+}
+
 /* EOF */

Modified: trunk/windstille/src/menu_manager.hpp
===================================================================
--- trunk/windstille/src/menu_manager.hpp	2007-06-18 04:03:31 UTC (rev 1460)
+++ trunk/windstille/src/menu_manager.hpp	2007-06-18 04:38:19 UTC (rev 1461)
@@ -55,6 +55,7 @@
   void menu_show_fps(int i);
   void menu_fullscreen(int i);
   void menu_continue();
+  void menu_music_volume(int i);
   void menu_ambient_light(int i, int component);
   void menu_start_scenario(std::string scenario);
   void menu_show_model(std::string scenario);

Modified: trunk/windstille/src/sound/sound_manager.cpp
===================================================================
--- trunk/windstille/src/sound/sound_manager.cpp	2007-06-18 04:03:31 UTC (rev 1460)
+++ trunk/windstille/src/sound/sound_manager.cpp	2007-06-18 04:38:19 UTC (rev 1461)
@@ -214,6 +214,12 @@
 }
 
 void
+SoundManager::set_listener_gain(float volume)
+{
+  alListenerf(AL_GAIN, volume);
+}
+
+void
 SoundManager::update()
 {
   if (!sound_enabled)

Modified: trunk/windstille/src/sound/sound_manager.hpp
===================================================================
--- trunk/windstille/src/sound/sound_manager.hpp	2007-06-18 04:03:31 UTC (rev 1460)
+++ trunk/windstille/src/sound/sound_manager.hpp	2007-06-18 04:38:19 UTC (rev 1461)
@@ -38,6 +38,7 @@
 
   void set_listener_position(const Vector& position);
   void set_listener_velocity(const Vector& velocity);
+  void set_listener_gain(float volume);
 
   void enable_music(bool music_enabled);
   void play_music(const std::string& filename, bool fade = true);

Modified: trunk/windstille/src/windstille_main.cpp
===================================================================
--- trunk/windstille/src/windstille_main.cpp	2007-06-18 04:03:31 UTC (rev 1460)
+++ trunk/windstille/src/windstille_main.cpp	2007-06-18 04:38:19 UTC (rev 1461)
@@ -210,6 +210,7 @@
   if (debug) std::cout << "Initialising Fonts" << std::endl;
   Fonts::init(); 
   sound_manager = new SoundManager();
+  sound_manager->set_listener_gain(config.get_int("master-volume")/100.0f);
   sound_manager->enable_sound(config.get_bool("sound"));
   sound_manager->enable_music(config.get_bool("music"));
 



From grumbel at mail.berlios.de  Mon Jun 18 07:19:04 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 18 Jun 2007 07:19:04 +0200
Subject: [Windstille-commit] r1462 - trunk/windstille
Message-ID: <200706180519.l5I5J48p017300@sheep.berlios.de>

Author: grumbel
Date: 2007-06-18 07:19:03 +0200 (Mon, 18 Jun 2007)
New Revision: 1462

Modified:
   trunk/windstille/NEWS
   trunk/windstille/SConstruct
   trunk/windstille/TODO
Log:
- added yacc/lex checks

Modified: trunk/windstille/NEWS
===================================================================
--- trunk/windstille/NEWS	2007-06-18 04:38:19 UTC (rev 1461)
+++ trunk/windstille/NEWS	2007-06-18 05:19:03 UTC (rev 1462)
@@ -2,6 +2,10 @@
 ================
  - fixed crash when sound is disabled
  - more solid gamepad support
+ - added volume control
+ - added arc drawing
+ - added navigation graph
+ - added geometry test
 
 Windstille 0.3.0
 ================

Modified: trunk/windstille/SConstruct
===================================================================
--- trunk/windstille/SConstruct	2007-06-18 04:38:19 UTC (rev 1461)
+++ trunk/windstille/SConstruct	2007-06-18 05:19:03 UTC (rev 1462)
@@ -81,6 +81,63 @@
         context.Result('ok (cached)')
         return 1
 
+# YACC
+
+yacc_test_text = """
+%{
+#include <stdio.h>
+
+/* MSVC++ needs this before it can swallow Bison output */
+#ifdef _MSC_VER
+# define __STDC__
+#endif
+%}
+%token MSG
+%start ROOT
+%%
+ROOT:
+	MSG { printf("HELLO"); } 
+	;
+%%
+"""
+
+def CheckYacc(context):
+	context.Message("Checking for Yacc ('%s')... " % context.env.get('YACC'))
+	is_ok = context.TryCompile(yacc_test_text,".y")
+	context.Result(is_ok)
+	return is_ok
+
+# LEX
+
+lex_test_text = """
+%{
+#include <stdio.h>
+%}
+DIGIT	[0-9]
+ID		[a-z][a-z0-9]*
+%%
+{DIGIT}+	{
+		printf("A digit: %s\\n",yytext);
+	}
+
+[ \\t\\n]+    /* ignore */
+
+.			{
+		printf("Unrecognized guff");
+	}
+%%
+main(){
+	yylex();
+}
+"""
+
+def CheckLex(context):
+	context.Message("Checking for Lex ('%s')... " % context.env.get('LEX'))
+	is_ok = context.TryCompile(lex_test_text,".l")
+	context.Result(is_ok)
+	return is_ok
+
+
 def Check32bit(context):
     check32bit_test_source_file = """
 #include <stdio.h>
@@ -121,9 +178,20 @@
 opts.Save('options.cache', conf_env)
 Help(opts.GenerateHelpText(conf_env))
 
-conf = Configure(conf_env, custom_tests = { 'Check32bit' : Check32bit })
+conf = Configure(conf_env, custom_tests = { 'Check32bit' : Check32bit,
+                                            'CheckYacc'  : CheckYacc,
+                                            'CheckLex'   : CheckLex})
 if conf.Check32bit() == "64bit":
   conf.env.Append(CXXFLAGS="-D_SQ64")
+
+if not conf.CheckLex():
+    print "lex or flex not found, aborting."
+    Exit(1)
+    
+if not conf.CheckYacc():
+    print "yacc or bison not found, aborting."
+    Exit(1)
+    
 conf_env = conf.Finish()
 
 Export('conf_env')

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-18 04:38:19 UTC (rev 1461)
+++ trunk/windstille/TODO	2007-06-18 05:19:03 UTC (rev 1462)
@@ -1,4 +1,3 @@
-- incooperate the freebsd patches
 - add bison checks
 
 - collision detection
@@ -9,5 +8,25 @@
 ---------------
 - add option to invert axis
 - implement proper dead-zone in input handling
+- allow to load multiple controller config files
 
+Sound Handling:
+---------------
+- split music, voice and sound fx into seperate context or allow to
+  change their volume by other means
+
+Misc:
+-----
+- polish/test scripting interface
+- create doll class
+- figure out how to do background animation (coroutines, multiple VM, etc.)
+- provide decent default keyboard config
+- polish dialog system
+- a mission that is playable
+- polish PDA
+- bone animation
+- add "save options" button
+- reduce tilesize of the large sets, figure out a easy way to resize
+  them without messing up alpha
+
 # EOF #



From grumbel at mail.berlios.de  Mon Jun 18 08:04:13 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 18 Jun 2007 08:04:13 +0200
Subject: [Windstille-commit] r1463 - in trunk/windstille: . data/scripts src
	src/scripting
Message-ID: <200706180604.l5I64Dep027802@sheep.berlios.de>

Author: grumbel
Date: 2007-06-18 08:04:12 +0200 (Mon, 18 Jun 2007)
New Revision: 1463

Removed:
   trunk/windstille/data/scripts/init.nut
Modified:
   trunk/windstille/TODO
   trunk/windstille/data/scripts/windstille.nut
   trunk/windstille/src/scripting/util.cpp
   trunk/windstille/src/windstille_main.cpp
Log:
- removed init.nut

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-18 05:19:03 UTC (rev 1462)
+++ trunk/windstille/TODO	2007-06-18 06:04:12 UTC (rev 1463)
@@ -28,5 +28,6 @@
 - add "save options" button
 - reduce tilesize of the large sets, figure out a easy way to resize
   them without messing up alpha
+- print and println behave different on console
 
 # EOF #

Deleted: trunk/windstille/data/scripts/init.nut
===================================================================
--- trunk/windstille/data/scripts/init.nut	2007-06-18 05:19:03 UTC (rev 1462)
+++ trunk/windstille/data/scripts/init.nut	2007-06-18 06:04:12 UTC (rev 1463)
@@ -1,34 +0,0 @@
-/* -*- c++ -*-
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-/*
- * This script is automatically executed on Windstille startup, use
- * windstille.nut for function definitions, use this for things that
- * should get executed (console messages displayed on start up and such).
- */
-
-// FIXME: println does a 'inspect', print a to_s, unintuitive
-
-/* EOF */

Modified: trunk/windstille/data/scripts/windstille.nut
===================================================================
--- trunk/windstille/data/scripts/windstille.nut	2007-06-18 05:19:03 UTC (rev 1462)
+++ trunk/windstille/data/scripts/windstille.nut	2007-06-18 06:04:12 UTC (rev 1463)
@@ -96,9 +96,9 @@
   align = null;
   character = null;
   portrait = null;
-}
+};
 
-  function add_dialog(align, character, portrait, text)
+function add_dialog(align, character, portrait, text)
 {
   dialog_show(align, character, portrait, text);
   wait_for_dialog();  

Modified: trunk/windstille/src/scripting/util.cpp
===================================================================
--- trunk/windstille/src/scripting/util.cpp	2007-06-18 05:19:03 UTC (rev 1462)
+++ trunk/windstille/src/scripting/util.cpp	2007-06-18 06:04:12 UTC (rev 1463)
@@ -162,7 +162,7 @@
       while(SQ_SUCCEEDED(sq_next(v,i-1)))
         {
           if (!first) {
-            os << ", ";
+            os << ", \n";
           }
           first = false;
 

Modified: trunk/windstille/src/windstille_main.cpp
===================================================================
--- trunk/windstille/src/windstille_main.cpp	2007-06-18 05:19:03 UTC (rev 1462)
+++ trunk/windstille/src/windstille_main.cpp	2007-06-18 06:04:12 UTC (rev 1463)
@@ -222,7 +222,6 @@
   sprite3d_manager = new sprite3d::Manager();
 
   script_manager->run_script_file("scripts/windstille.nut");
-  script_manager->run_script_file("scripts/init.nut");
 }
 
 void



From grumbel at mail.berlios.de  Mon Jun 18 10:29:01 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 18 Jun 2007 10:29:01 +0200
Subject: [Windstille-commit] r1464 - trunk/windstille/src
Message-ID: <200706180829.l5I8T1qW005041@sheep.berlios.de>

Author: grumbel
Date: 2007-06-18 10:29:00 +0200 (Mon, 18 Jun 2007)
New Revision: 1464

Modified:
   trunk/windstille/src/console.cpp
   trunk/windstille/src/script_manager.cpp
Log:
- fixed command line blinking cursor

Modified: trunk/windstille/src/console.cpp
===================================================================
--- trunk/windstille/src/console.cpp	2007-06-18 06:04:12 UTC (rev 1463)
+++ trunk/windstille/src/console.cpp	2007-06-18 08:29:00 UTC (rev 1464)
@@ -181,7 +181,7 @@
   if (active)
     {
       std::string str = command_line;
-      if (int(game_time*1000) % 400 > 200)
+      if (SDL_GetTicks() % 300 > 150)
         {
           if (cursor_pos < int(str.size()))
             str[cursor_pos] = '_';
@@ -437,7 +437,7 @@
       history_position = history.size();
     }
                       
-  console << ">" << command_line << std::endl;
+  console << "> " << command_line << std::endl;
 
   if (command_line == "quit" || command_line == "exit")
     {
@@ -499,25 +499,31 @@
   const char* buffer = str.c_str();
 
   HSQUIRRELVM vm = script_manager->get_vm();
-  int oldtop=sq_gettop(vm); 
+  int oldtop = sq_gettop(vm); 
   try {
     int retval = 1;
 
-    if(i>0){
-      if(SQ_SUCCEEDED(sq_compilebuffer(vm,buffer,i,_SC("interactive console"),SQTrue))){
-        sq_pushroottable(vm);
-        if(SQ_SUCCEEDED(sq_call(vm,1, retval, true))) 
+    if(i > 0) 
+      {
+        if(SQ_SUCCEEDED(sq_compilebuffer(vm, buffer, i, _SC("interactive console"), SQTrue)))
           {
-            if (sq_gettype(vm, -1) != OT_NULL)
-              console << Scripting::squirrel2string(vm, -1) << std::endl;
+            sq_pushroottable(vm);
+            if(SQ_SUCCEEDED(sq_call(vm, 1, retval, true))) 
+              {
+                // FIXME: This does only work when somebody is doing a 'return', i.e. almost never
+                if (sq_gettype(vm, -1) != OT_NULL)
+                  console << Scripting::squirrel2string(vm, -1) << std::endl;
+                // else
+                //   console << "(null)" << std::endl;
+              }
           }
       }
-    }
   } catch(std::exception& e) {
     std::cerr << "Couldn't execute command '" << str_ << "': "
               << e.what() << "\n";
   }
-  sq_settop(vm,oldtop);
+
+  sq_settop(vm, oldtop);
 }
 
 //-------------------------------------------------------------------------------

Modified: trunk/windstille/src/script_manager.cpp
===================================================================
--- trunk/windstille/src/script_manager.cpp	2007-06-18 06:04:12 UTC (rev 1463)
+++ trunk/windstille/src/script_manager.cpp	2007-06-18 08:29:00 UTC (rev 1464)
@@ -114,7 +114,10 @@
   squirrel_vms.push_back(SquirrelVM(sourcename, vm, vm_obj));
   already_run_scripts[sourcename] = true;
 
+  // FIXME: a script that gets run shouldn't have direct access to the root table
+  // http://wiki.squirrel-lang.org/default.aspx/SquirrelWiki/MultiVMs.html
   sq_pushroottable(vm);
+  //sq_clone(vm, -1); //FIXME
   if(sq_call(vm, 1, false, true) < 0)
     throw SquirrelError(vm, "Couldn't start script");
 }



From grumbel at mail.berlios.de  Mon Jun 18 10:40:11 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 18 Jun 2007 10:40:11 +0200
Subject: [Windstille-commit] r1465 - trunk/windstille/src
Message-ID: <200706180840.l5I8eB3d006317@sheep.berlios.de>

Author: grumbel
Date: 2007-06-18 10:40:10 +0200 (Mon, 18 Jun 2007)
New Revision: 1465

Modified:
   trunk/windstille/src/pistol.cpp
   trunk/windstille/src/player.cpp
Log:
- fixed laserpointer

Modified: trunk/windstille/src/pistol.cpp
===================================================================
--- trunk/windstille/src/pistol.cpp	2007-06-18 08:29:00 UTC (rev 1464)
+++ trunk/windstille/src/pistol.cpp	2007-06-18 08:40:10 UTC (rev 1465)
@@ -37,8 +37,9 @@
 Pistol::draw(SceneContext& sc)
 {
   sprite.draw(sc.color(), Vector(0, 0), 1000);
-  if(laser_pointer)
-    laser_pointer->draw(sc);
+  // Disabled for now and done in the player class
+  //if(laser_pointer)
+  //  laser_pointer->draw(sc);
 }
 
 void

Modified: trunk/windstille/src/player.cpp
===================================================================
--- trunk/windstille/src/player.cpp	2007-06-18 08:29:00 UTC (rev 1464)
+++ trunk/windstille/src/player.cpp	2007-06-18 08:40:10 UTC (rev 1465)
@@ -123,6 +123,12 @@
   sc.mult_modelview(sprite.get_attachment_point_matrix(id));
   weapon->draw(sc);
   sc.pop_modelview();
+
+
+  sc.push_modelview();
+  sc.translate(pos.x, pos.y - 80);
+  laser_pointer->draw(sc);
+  sc.pop_modelview();
 }
 
 void



From grumbel at mail.berlios.de  Mon Jun 18 13:46:32 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 18 Jun 2007 13:46:32 +0200
Subject: [Windstille-commit] r1466 - trunk/windstille/src
Message-ID: <200706181146.l5IBkWRH003706@sheep.berlios.de>

Author: grumbel
Date: 2007-06-18 13:46:31 +0200 (Mon, 18 Jun 2007)
New Revision: 1466

Modified:
   trunk/windstille/src/conversation.cpp
   trunk/windstille/src/conversation.hpp
   trunk/windstille/src/math.hpp
Log:
- made conversation dialog a little pretier

Modified: trunk/windstille/src/conversation.cpp
===================================================================
--- trunk/windstille/src/conversation.cpp	2007-06-18 08:40:10 UTC (rev 1465)
+++ trunk/windstille/src/conversation.cpp	2007-06-18 11:46:31 UTC (rev 1466)
@@ -23,6 +23,7 @@
 **  02111-1307, USA.
 */
 
+#include "math.hpp"
 #include "input/controller.hpp"
 #include "input/input_manager.hpp"
 #include "font/fonts.hpp"
@@ -36,6 +37,7 @@
 Conversation* Conversation::current_ = 0;
 
 Conversation::Conversation()
+  : pos(400, 300)
 {
   current_ = this;
   active = false;
@@ -58,48 +60,106 @@
 {
   if (!active)
     return;
-    
-  int x = 100;
-  int y = 200;
-
-  Rect rect(Point(x - 20, y - 20 + Fonts::ttffont->get_height()/2 - 5),
-            Size(300 + 20, // FIXME:
-                 (Fonts::ttffont->get_height() + 10) * choices.size() + 20));
   
-  Display::fill_rect(rect, Color(0,0,0,0.5f));
-  Display::draw_rect(rect, Color(1.0f, 1.0f, 1.0f, 0.3f));
+  Display::fill_circle(pos, 42.0f, Color(1.0f, 1.0f, 1.0f, 0.25f), 24);
+  Display::draw_circle(pos, 42.0f, Color(1.0f, 1.0f, 1.0f, 0.25f), 24);
 
-  for(int i = 0; i < int(choices.size()); ++i)
-    {
+  float segment = 360.0f / choices.size();
+
+  for(int i = 0; i < choices.size(); ++i)
+    { // FIXME:
+      Vector offset(0.0f, 1.0f);
+      offset = offset.rotate(math::deg2rad(segment*i) - M_PI/2);
+
+      float start = -segment/2 - 90.0f + segment*i;
+      float end   = -segment/2 - 90.0f + segment*(i+1);
+      
+      // FIXME: Doesn't handle multi line text
+      Sizef size(Fonts::vera20->get_width(choices[i]) + 10,
+                 Fonts::vera20->get_height() + 10);
+      Rectf rect(pos + 128.0f * offset - Vector(size.width/2, size.height - 5), size);
+
       if (i == selection)
-        Fonts::vera20->draw(x, y, choices[i]);
+        {
+          Display::fill_arc(pos + (5.0f * offset), 32.0f, 
+                            start, end,
+                            Color(1.0f, 1.0f, 1.0f, 1.0f), 24);
+          Display::fill_rounded_rect(rect, 5.0f, Color(0.5f, 0.5f, 0.5f, 1.0f));
+          Fonts::vera20->draw_center(pos.x + 128.0f * offset.x, pos.y + 128.0f * offset.y, choices[i], Color(1.0f, 1.0f, 1.0f));
+        }
       else
-        Fonts::vera20->draw(x, y, choices[i], Color(0.5f, 0.5f, 0.5f));
+        {
+          Display::fill_rounded_rect(rect, 5.0f, Color(0.5f, 0.5f, 0.5f, 0.25f));
+          Fonts::vera20->draw_center(pos.x + 128.0f * offset.x, pos.y + 128.0f * offset.y, choices[i], Color(0.5f, 0.5f, 0.5f));
+        }
+
+      Display::draw_arc(pos + 5.0f * offset, 32.0f,
+                        start, end,
+                        Color(1.0f, 1.0f, 1.0f, 1.0f), 24);
+
+    }
+
+  Display::draw_line(pos, pos + direction*32.0f, Color(1.0f, 1.0f, 1.0f));
+
+  /*
+    cosf(angle) * radius + pos.x;
+    sinf(angle) * radius + pos.y;
+
+    Rect rect(Point(x - 20, y - 20 + Fonts::ttffont->get_height()/2 - 5),
+    Size(300 + 20, // FIXME:
+    (Fonts::ttffont->get_height() + 10) * choices.size() + 20));
   
-      y += Fonts::vera20->get_height() + 10;
+    Display::fill_rect(rect, Color(0,0,0,0.5f));
+    Display::draw_rect(rect, Color(1.0f, 1.0f, 1.0f, 0.3f));
+
+    for(int i = 0; i < int(choices.size()); ++i)
+    {
+    if (i == selection)
+    Fonts::vera20->draw(x, y, choices[i]);
+    else
+    Fonts::vera20->draw(x, y, choices[i], Color(0.5f, 0.5f, 0.5f));
+  
+    y += Fonts::vera20->get_height() + 10;
     }
+  */
 }
 
 void
 Conversation::update(float delta, const Controller& controller)
 {
-  (void) delta;
   if (!active)
     return;
 
-  if (controller.button_was_pressed(MENU_UP_BUTTON))
+  if (fabs(controller.get_axis_state(X_AXIS)) > 0.3f ||
+      fabs(controller.get_axis_state(Y_AXIS)) > 0.3f)
     {
-      selection -= 1;
-      if (selection < 0)
-        selection = choices.size() - 1;
+      direction = Vector(controller.get_axis_state(X_AXIS),
+                         controller.get_axis_state(Y_AXIS));
+
+      float segment = 360.0f / choices.size();
+      float angle = math::rad2deg(math::normalize_angle(atan2f(direction.y, direction.x) + M_PI/2 + math::deg2rad(segment/2.0f)));
+
+      selection = int(angle / segment);
+      selection = math::mid(0, selection, int(choices.size()));
     }
-  else if (controller.button_was_pressed(MENU_DOWN_BUTTON))
+  else
     {
-      selection += 1;
-      if (selection >= int(choices.size()))
-        selection = 0;
     }
-  
+
+  /*
+    if (controller.button_was_pressed(MENU_UP_BUTTON))
+    {
+    selection -= 1;
+    if (selection < 0)
+    selection = choices.size() - 1;
+    }
+    else if (controller.button_was_pressed(MENU_DOWN_BUTTON))
+    {
+    selection += 1;
+    if (selection >= int(choices.size()))
+    selection = 0;
+    }
+  */
   if (controller.button_was_pressed(OK_BUTTON))
     {
       active = false;

Modified: trunk/windstille/src/conversation.hpp
===================================================================
--- trunk/windstille/src/conversation.hpp	2007-06-18 08:40:10 UTC (rev 1465)
+++ trunk/windstille/src/conversation.hpp	2007-06-18 11:46:31 UTC (rev 1466)
@@ -35,8 +35,10 @@
 class Conversation : public Screen
 {
 private:
-  bool active;
-  int selection;
+  Vector pos;
+  Vector direction;
+  bool   active;
+  int    selection;
 
   typedef std::vector<std::string> Choices;
   Choices choices;

Modified: trunk/windstille/src/math.hpp
===================================================================
--- trunk/windstille/src/math.hpp	2007-06-18 08:40:10 UTC (rev 1465)
+++ trunk/windstille/src/math.hpp	2007-06-18 11:46:31 UTC (rev 1466)
@@ -66,7 +66,8 @@
   if (radians == 2.0 * M_PI)
     radians = 0.0;
   
-  assert (radians >= 0.0 && radians < 2.0 * M_PI);
+  // FIXME: This gets triggered from time to time!
+  //  assert (radians >= 0.0 && radians < 2.0 * M_PI);
   return radians;
 }
 



From grumbel at mail.berlios.de  Mon Jun 18 14:27:33 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 18 Jun 2007 14:27:33 +0200
Subject: [Windstille-commit] r1467 - trunk/windstille/src
Message-ID: <200706181227.l5ICRXg1006761@sheep.berlios.de>

Author: grumbel
Date: 2007-06-18 14:27:33 +0200 (Mon, 18 Jun 2007)
New Revision: 1467

Modified:
   trunk/windstille/src/conversation.cpp
Log:
- some more improvements to the conversation

Modified: trunk/windstille/src/conversation.cpp
===================================================================
--- trunk/windstille/src/conversation.cpp	2007-06-18 11:46:31 UTC (rev 1466)
+++ trunk/windstille/src/conversation.cpp	2007-06-18 12:27:33 UTC (rev 1467)
@@ -75,53 +75,37 @@
       float end   = -segment/2 - 90.0f + segment*(i+1);
       
       // FIXME: Doesn't handle multi line text
-      Sizef size(Fonts::vera20->get_width(choices[i]) + 10,
-                 Fonts::vera20->get_height() + 10);
-      Rectf rect(pos + 128.0f * offset - Vector(size.width/2, size.height - 5), size);
+      Sizef size(Fonts::vera20->get_width(choices[i]) + 60,
+                 Fonts::vera20->get_height() + 40);
+      float distance = 160.0f;
 
+      Vector textpos = pos + Vector(0, 16.0f);
+      Rectf  rect(textpos + distance * offset - Vector(size.width/2, size.height - 20), size);
+
       if (i == selection)
         {
           Display::fill_arc(pos + (5.0f * offset), 32.0f, 
                             start, end,
                             Color(1.0f, 1.0f, 1.0f, 1.0f), 24);
+          
           Display::fill_rounded_rect(rect, 5.0f, Color(0.5f, 0.5f, 0.5f, 1.0f));
-          Fonts::vera20->draw_center(pos.x + 128.0f * offset.x, pos.y + 128.0f * offset.y, choices[i], Color(1.0f, 1.0f, 1.0f));
+          Fonts::vera20->draw_center(textpos.x + distance * offset.x, textpos.y + distance * offset.y, choices[i], Color(1.0f, 1.0f, 1.0f));
         }
       else
         {
           Display::fill_rounded_rect(rect, 5.0f, Color(0.5f, 0.5f, 0.5f, 0.25f));
-          Fonts::vera20->draw_center(pos.x + 128.0f * offset.x, pos.y + 128.0f * offset.y, choices[i], Color(0.5f, 0.5f, 0.5f));
+          Fonts::vera20->draw_center(textpos.x + distance * offset.x, textpos.y + distance * offset.y, choices[i], Color(0.5f, 0.5f, 0.5f));
         }
 
+      Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f));
+
       Display::draw_arc(pos + 5.0f * offset, 32.0f,
                         start, end,
                         Color(1.0f, 1.0f, 1.0f, 1.0f), 24);
 
     }
 
-  Display::draw_line(pos, pos + direction*32.0f, Color(1.0f, 1.0f, 1.0f));
-
-  /*
-    cosf(angle) * radius + pos.x;
-    sinf(angle) * radius + pos.y;
-
-    Rect rect(Point(x - 20, y - 20 + Fonts::ttffont->get_height()/2 - 5),
-    Size(300 + 20, // FIXME:
-    (Fonts::ttffont->get_height() + 10) * choices.size() + 20));
-  
-    Display::fill_rect(rect, Color(0,0,0,0.5f));
-    Display::draw_rect(rect, Color(1.0f, 1.0f, 1.0f, 0.3f));
-
-    for(int i = 0; i < int(choices.size()); ++i)
-    {
-    if (i == selection)
-    Fonts::vera20->draw(x, y, choices[i]);
-    else
-    Fonts::vera20->draw(x, y, choices[i], Color(0.5f, 0.5f, 0.5f));
-  
-    y += Fonts::vera20->get_height() + 10;
-    }
-  */
+  Display::draw_line(pos, pos + direction*32.0f, Color(0.0f, 0.0f, 0.0f));
 }
 
 void
@@ -130,12 +114,12 @@
   if (!active)
     return;
 
+  direction = Vector(controller.get_axis_state(X_AXIS),
+                     controller.get_axis_state(Y_AXIS));
+
   if (fabs(controller.get_axis_state(X_AXIS)) > 0.3f ||
       fabs(controller.get_axis_state(Y_AXIS)) > 0.3f)
     {
-      direction = Vector(controller.get_axis_state(X_AXIS),
-                         controller.get_axis_state(Y_AXIS));
-
       float segment = 360.0f / choices.size();
       float angle = math::rad2deg(math::normalize_angle(atan2f(direction.y, direction.x) + M_PI/2 + math::deg2rad(segment/2.0f)));
 
@@ -144,6 +128,7 @@
     }
   else
     {
+      selection = -1;
     }
 
   /*
@@ -160,7 +145,8 @@
     selection = 0;
     }
   */
-  if (controller.button_was_pressed(OK_BUTTON))
+  
+  if (controller.button_was_pressed(OK_BUTTON) && selection != -1)
     {
       active = false;
       GameSession::current()->get_pda().add_dialog("Jane", choices[selection]);



From grumbel at mail.berlios.de  Mon Jun 18 20:09:23 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 18 Jun 2007 20:09:23 +0200
Subject: [Windstille-commit] r1468 - in trunk/windstille/src: . display
Message-ID: <200706181809.l5II9NA6021935@sheep.berlios.de>

Author: grumbel
Date: 2007-06-18 20:09:22 +0200 (Mon, 18 Jun 2007)
New Revision: 1468

Modified:
   trunk/windstille/src/conversation.cpp
   trunk/windstille/src/display/display.cpp
Log:
- more conversation prettying

Modified: trunk/windstille/src/conversation.cpp
===================================================================
--- trunk/windstille/src/conversation.cpp	2007-06-18 12:27:33 UTC (rev 1467)
+++ trunk/windstille/src/conversation.cpp	2007-06-18 18:09:22 UTC (rev 1468)
@@ -62,7 +62,6 @@
     return;
   
   Display::fill_circle(pos, 42.0f, Color(1.0f, 1.0f, 1.0f, 0.25f), 24);
-  Display::draw_circle(pos, 42.0f, Color(1.0f, 1.0f, 1.0f, 0.25f), 24);
 
   float segment = 360.0f / choices.size();
 
@@ -84,28 +83,27 @@
 
       if (i == selection)
         {
-          Display::fill_arc(pos + (5.0f * offset), 32.0f, 
-                            start, end,
-                            Color(1.0f, 1.0f, 1.0f, 1.0f), 24);
-          
-          Display::fill_rounded_rect(rect, 5.0f, Color(0.5f, 0.5f, 0.5f, 1.0f));
+          Display::fill_arc(pos, 42.0f, start, end, Color(1.0f, 1.0f, 1.0f, 0.5f), 24);
+          Display::fill_rounded_rect(rect, 5.0f, Color(0.5f, 0.5f, 0.5f, 0.75f));
           Fonts::vera20->draw_center(textpos.x + distance * offset.x, textpos.y + distance * offset.y, choices[i], Color(1.0f, 1.0f, 1.0f));
         }
       else
         {
-          Display::fill_rounded_rect(rect, 5.0f, Color(0.5f, 0.5f, 0.5f, 0.25f));
+          Display::fill_rounded_rect(rect, 5.0f, Color(0.25f, 0.25f, 0.25f, 0.75f));
           Fonts::vera20->draw_center(textpos.x + distance * offset.x, textpos.y + distance * offset.y, choices[i], Color(0.5f, 0.5f, 0.5f));
         }
 
       Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f));
 
-      Display::draw_arc(pos + 5.0f * offset, 32.0f,
-                        start, end,
-                        Color(1.0f, 1.0f, 1.0f, 1.0f), 24);
+      //Display::draw_arc(pos + 5.0f * offset, 32.0f,
+      //                  start, end,
+      //                  Color(1.0f, 1.0f, 1.0f, 1.0f), 24);
 
     }
+  Display::draw_circle(pos, 42.0f, Color(1.0f, 1.0f, 1.0f, 0.5f), 24);
 
-  Display::draw_line(pos, pos + direction*32.0f, Color(0.0f, 0.0f, 0.0f));
+  Display::fill_circle(pos + direction * 34.0f, 8.0f, Color(1.0f, 1.0f, 1.0f));
+  //Display::draw_line(pos, pos + direction*32.0f, Color(0.0f, 0.0f, 0.0f));
 }
 
 void

Modified: trunk/windstille/src/display/display.cpp
===================================================================
--- trunk/windstille/src/display/display.cpp	2007-06-18 12:27:33 UTC (rev 1467)
+++ trunk/windstille/src/display/display.cpp	2007-06-18 18:09:22 UTC (rev 1468)
@@ -274,7 +274,9 @@
   static const float cl_pixelcenter_constant = 0.375;
 
   //glOrtho(0.0, window->w, window->h, 0.0, -1000.0, 1000.0);
-  glOrtho(0.0, 800, 600, 0.0, 1000.0, -1000.0);
+  
+  // glOrtho(0.0, 800, 0.0, 600.0, 1000.0, -1000.0); // proper right-hand CO
+  glOrtho(0.0, 800, 600.0, 0.0, 1000.0, -1000.0);
   glMatrixMode(GL_MODELVIEW);
   glLoadIdentity();
   glTranslated(cl_pixelcenter_constant, cl_pixelcenter_constant, 0.0);
@@ -386,11 +388,11 @@
       glVertex2f(pos.x, pos.y);
 
       for(float angle = start; angle < end; angle += step)
-        glVertex2f(cosf(angle) * radius + pos.x,
-                   sinf(angle) * radius + pos.y);
+        glVertex2f((cosf(angle) * radius) + pos.x,
+                   (sinf(angle) * radius) + pos.y);
 
-      glVertex2f(cosf(end) * radius + pos.x,
-                 sinf(end) * radius + pos.y);
+      glVertex2f((cosf(end) * radius) + pos.x,
+                 (sinf(end) * radius) + pos.y);
       glVertex2f(pos.x, pos.y);
       glEnd();
     }
@@ -426,8 +428,8 @@
       glVertex2f(pos.x, pos.y);
 
       for(float angle = start; angle < end; angle += step)
-        glVertex2f(cosf(angle) * radius + pos.x,
-                   sinf(angle) * radius + pos.y);
+        glVertex2f((cosf(angle) * radius) + pos.x,
+                   (sinf(angle) * radius) + pos.y);
 
       glVertex2f(cosf(end) * radius + pos.x,
                  sinf(end) * radius + pos.y);



From grumbel at mail.berlios.de  Mon Jun 18 21:38:19 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 18 Jun 2007 21:38:19 +0200
Subject: [Windstille-commit] r1469 - in trunk/windstille: . data/images
	data/images/pda data/levels data/scripts
	data/scripts/apartment data/scripts/newformat2 src
Message-ID: <200706181938.l5IJcJ9F029897@sheep.berlios.de>

Author: grumbel
Date: 2007-06-18 21:38:17 +0200 (Mon, 18 Jun 2007)
New Revision: 1469

Added:
   trunk/windstille/data/images/pda/
   trunk/windstille/data/images/pda/pda.png
Modified:
   trunk/windstille/TODO
   trunk/windstille/data/levels/apartment.wst
   trunk/windstille/data/scripts/apartment/barrobot.nut
   trunk/windstille/data/scripts/apartment/init.nut
   trunk/windstille/data/scripts/init_script_vars.nut
   trunk/windstille/data/scripts/newformat2/bob.nut
   trunk/windstille/src/pda.cpp
   trunk/windstille/src/pda.hpp
Log:
- added PDA picture

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-18 18:09:22 UTC (rev 1468)
+++ trunk/windstille/TODO	2007-06-18 19:38:17 UTC (rev 1469)
@@ -29,5 +29,7 @@
 - reduce tilesize of the large sets, figure out a easy way to resize
   them without messing up alpha
 - print and println behave different on console
+- calling functions as character scripts instead of files doesn't work
+- change the game to a righthand coordinate system
 
 # EOF #

Added: trunk/windstille/data/images/pda/pda.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/images/pda/pda.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Modified: trunk/windstille/data/levels/apartment.wst
===================================================================
--- trunk/windstille/data/levels/apartment.wst	2007-06-18 18:09:22 UTC (rev 1468)
+++ trunk/windstille/data/levels/apartment.wst	2007-06-18 19:38:17 UTC (rev 1469)
@@ -202,8 +202,15 @@
       (sprite3d "models/characters/yagor/yagor.wsprite")
     )
 
+    (character
+      (name "barrobot")
+      (pos 370 256)
+      (z-pos -450)
+      (sprite3d "models/characters/yagor/yagor.wsprite")
+    )
+
     (scriptable-object
-      (name "Barrobot")
+      (name "Barrobot2")
       (pos 470 177)
       (z-pos -100)
       (sprite  "models/objects/barrobot/barrobotsprite.sprite")

Modified: trunk/windstille/data/scripts/apartment/barrobot.nut
===================================================================
--- trunk/windstille/data/scripts/apartment/barrobot.nut	2007-06-18 18:09:22 UTC (rev 1468)
+++ trunk/windstille/data/scripts/apartment/barrobot.nut	2007-06-18 19:38:17 UTC (rev 1469)
@@ -1,22 +1,97 @@
-cutscene_begin();
+conversation_add("Choice 1");
+conversation_get()
 
-barrobot <- Dialog(TOP, "Bar Robot", "images/portraits/barrobot.sprite");
-jane  <- Dialog(TOP, "Jane", "images/portraits/jane.sprite");
+conversation_add("Choice 1");
+conversation_add("Choice 2");
+conversation_get()
 
-barrobot.show("Hello how are you?")
+conversation_add("Choice 1");
+conversation_add("Choice 2");
+conversation_add("Choice 3");
+conversation_get()
 
-// yagor.show("How are you?<sleep>\nEverything fine today?")
-// jane.show("Jep, thanks for asking. Buts its a bit dark here. Do you have a flashlight?")
-// yagor.show("Sure, here take....")
-// fadeout()
-// wait_for_fade()
-// fadein();
-// yagor.show("Here it is.")
-// jane.show("Ok, thanks, time to explore this apartment a bit.")
+conversation_add("Choice 1");
+conversation_add("Choice 2");
+conversation_add("Choice 3");
+conversation_add("Choice 4");
+conversation_get()
 
-// objects.flashlight.set_active(true);
-// objects.flashlight.set_parent("player");
+conversation_add("Choice 1");
+conversation_add("Choice 2");
+conversation_add("Choice 3");
+conversation_add("Choice 4");
+conversation_add("Choice 5");
+conversation_get()
 
-cutscene_end();
+conversation_add("Choice 1");
+conversation_add("Choice 2");
+conversation_add("Choice 3");
+conversation_add("Choice 4");
+conversation_add("Choice 5");
+conversation_add("Choice 6");
+conversation_get()
 
+conversation_add("Choice 1");
+conversation_add("Choice 2");
+conversation_add("Choice 3");
+conversation_add("Choice 4");
+conversation_add("Choice 5");
+conversation_add("Choice 6");
+conversation_add("Choice 7");
+conversation_get()
+
+conversation_add("Choice 1");
+conversation_add("Choice 2");
+conversation_add("Choice 3");
+conversation_add("Choice 4");
+conversation_add("Choice 5");
+conversation_add("Choice 6");
+conversation_add("Choice 7");
+conversation_add("Choice 8");
+conversation_get()
+
+conversation_add("Choice 1");
+conversation_add("Choice 2");
+conversation_add("Choice 3");
+conversation_add("Choice 4");
+conversation_add("Choice 5");
+conversation_add("Choice 6");
+conversation_add("Choice 7");
+conversation_add("Choice 8");
+conversation_add("Choice 9");
+conversation_get()
+  
+conversation_add("Choice 1");
+conversation_add("Choice 2");
+conversation_add("Choice 3");
+conversation_add("Choice 4");
+conversation_add("Choice 5");
+conversation_add("Choice 6");
+conversation_add("Choice 7");
+conversation_add("Choice 8");
+conversation_add("Choice 9");
+conversation_add("Choice 10");
+conversation_get()
+  
+// cutscene_begin();
+
+// barrobot <- Dialog(TOP, "Bar Robot", "images/portraits/barrobot.sprite");
+// jane  <- Dialog(TOP, "Jane", "images/portraits/jane.sprite");
+
+// barrobot.show("Hello how are you?")
+
+// // yagor.show("How are you?<sleep>\nEverything fine today?")
+// // jane.show("Jep, thanks for asking. Buts its a bit dark here. Do you have a flashlight?")
+// // yagor.show("Sure, here take....")
+// // fadeout()
+// // wait_for_fade()
+// // fadein();
+// // yagor.show("Here it is.")
+// // jane.show("Ok, thanks, time to explore this apartment a bit.")
+
+// // objects.flashlight.set_active(true);
+// // objects.flashlight.set_parent("player");
+
+// cutscene_end();
+
 /* EOF */

Modified: trunk/windstille/data/scripts/apartment/init.nut
===================================================================
--- trunk/windstille/data/scripts/apartment/init.nut	2007-06-18 18:09:22 UTC (rev 1468)
+++ trunk/windstille/data/scripts/apartment/init.nut	2007-06-18 19:38:17 UTC (rev 1469)
@@ -1,27 +1,2 @@
-function barrobot()
-{
-  //cutscene_begin();
 
-  barrobot <- Dialog(BOTTOM, "Bar Robot", "images/portraits/barrobot.sprite");
-  jane  <- Dialog(TOP, "Jane", "images/portraits/jane.sprite");
-
-  barrobot.show("Hello how are you?\n" +
-                "<sleep>" +
-                "Do you want a drink?")
-
-    // yagor.show("How are you?<sleep>\nEverything fine today?")
-    // jane.show("Jep, thanks for asking. Buts its a bit dark here. Do you have a flashlight?")
-    // yagor.show("Sure, here take....")
-    // fadeout()
-    // wait_for_fade()
-    // fadein();
-    // yagor.show("Here it is.")
-    // jane.show("Ok, thanks, time to explore this apartment a bit.")
-
-    // objects.flashlight.set_active(true);
-    // objects.flashlight.set_parent("player");
-
-    //cutscene_end();
-}
-
 /* EOF */

Modified: trunk/windstille/data/scripts/init_script_vars.nut
===================================================================
--- trunk/windstille/data/scripts/init_script_vars.nut	2007-06-18 18:09:22 UTC (rev 1468)
+++ trunk/windstille/data/scripts/init_script_vars.nut	2007-06-18 19:38:17 UTC (rev 1469)
@@ -1,3 +1,5 @@
+// FIXME: Global variables are evil, so never use: "foo <- 5", instead use "local foo = 5"
+
 like_frank <- false;
 bob_seen_before <- false;
 bob_knows_you_mercenary <- false;

Modified: trunk/windstille/data/scripts/newformat2/bob.nut
===================================================================
--- trunk/windstille/data/scripts/newformat2/bob.nut	2007-06-18 18:09:22 UTC (rev 1468)
+++ trunk/windstille/data/scripts/newformat2/bob.nut	2007-06-18 19:38:17 UTC (rev 1469)
@@ -4,6 +4,9 @@
   dialog.show("Hey, my name's bob.  Are you new around here?"); 
   conversation_add("Yes, I am.");
   conversation_add("Go away"); 
+  conversation_add("Choice 1"); 
+  conversation_add("Choice 2"); 
+  conversation_add("Choice 3"); 
   if (!conversation_get())
   {
     ask_questions();

Modified: trunk/windstille/src/pda.cpp
===================================================================
--- trunk/windstille/src/pda.cpp	2007-06-18 18:09:22 UTC (rev 1468)
+++ trunk/windstille/src/pda.cpp	2007-06-18 19:38:17 UTC (rev 1469)
@@ -45,7 +45,8 @@
 PDA::PDA()
   : state(PDA_OBJECTIVES)
 { 
-  text_area = 0;
+  text_area  = 0;
+  background = Sprite("images/pda/pda.sprite");
 }
 
 void
@@ -53,8 +54,14 @@
 {
   if (text_area)
     {
-      const Rectf& rect = text_area->get_rect().grow(8.0f);
+      // Darken the background a bit
+      Display::fill_rect(Rect(0, 0, Display::get_width(), Display::get_height()), Color(0.0f, 0.0f, 0.0f, 0.25f));
 
+      Rectf rect = text_area->get_rect().grow(8.0f);
+
+      background.draw(Vector(30, 30));
+      
+      rect.top += 56;
       Display::fill_rounded_rect(rect, 16.0f, Color(0.3f, 0.3f, 0.5f, 0.5f));
       Display::draw_rounded_rect(rect, 16.0f, Color(1.0f, 1.0f, 1.0f, 0.5f));
 
@@ -83,10 +90,7 @@
           }
       }
   }
-  
-  int width  = 600;
-  int height = 400;
-  
+    
   switch (state) {
   case PDA_OBJECTIVES:
     show_objectives();
@@ -97,10 +101,8 @@
   }
  
   if (new_text != old_text) {
-    delete text_area;
-    text_area = new TextArea(Rect(Point(100,
-                                        100),
-                                  Size(width, height)), false);
+    delete text_area; // FIXME: Unneeded could just use set_text
+    text_area = new TextArea(Rectf(70, 83, 385, 520).grow(-12.0f), false);
     text_area->set_font(Fonts::ttffont);
     text_area->set_text(new_text);
     

Modified: trunk/windstille/src/pda.hpp
===================================================================
--- trunk/windstille/src/pda.hpp	2007-06-18 18:09:22 UTC (rev 1468)
+++ trunk/windstille/src/pda.hpp	2007-06-18 19:38:17 UTC (rev 1469)
@@ -26,6 +26,7 @@
 #ifndef HEADER_PDA_HPP
 #define HEADER_PDA_HPP
 
+#include "sprite2d/sprite.hpp"
 #include "screen.hpp"
 
 class TextArea;
@@ -52,6 +53,19 @@
 /** */
 class PDA : public Screen
 {
+private:
+  Sprite    background;
+  TextArea* text_area;
+  std::vector<DialogEntry> dialogs;
+  std::vector<ObjectiveEntry> objectives;   
+  
+  std::string new_text;  
+  std::string old_text;
+  enum pda_state { PDA_OBJECTIVES, PDA_DIALOGS } state;
+
+  void show_objectives();
+  void show_dialogs();
+
 public:
   PDA();
 
@@ -63,18 +77,6 @@
   void objective_complete(const std::string& name);
   bool is_objective_given(const std::string& name);
   bool is_objective_complete(const std::string& name);
-
-private:
-  void show_objectives();
-  void show_dialogs();
-  
-  TextArea* text_area;
-  std::vector<DialogEntry> dialogs;
-  std::vector<ObjectiveEntry> objectives;   
-  
-  std::string new_text;  
-  std::string old_text;
-  enum pda_state { PDA_OBJECTIVES, PDA_DIALOGS } state;
 };
 
 #endif



From grumbel at mail.berlios.de  Tue Jun 19 22:27:20 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Tue, 19 Jun 2007 22:27:20 +0200
Subject: [Windstille-commit] r1470 - in trunk: scripts windstille
	windstille/src windstille/tools windstille/tools/sdl-jstest
Message-ID: <200706192027.l5JKRKj2000703@sheep.berlios.de>

Author: grumbel
Date: 2007-06-19 22:27:19 +0200 (Tue, 19 Jun 2007)
New Revision: 1470

Added:
   trunk/scripts/README
   trunk/scripts/mime-fix.sh
   trunk/windstille/tools/sdl-jstest/
   trunk/windstille/tools/sdl-jstest/Makefile
   trunk/windstille/tools/sdl-jstest/SConscript
   trunk/windstille/tools/sdl-jstest/sdl-jstest.c
Modified:
   trunk/windstille/SConstruct
   trunk/windstille/src/scriptable_object.cpp
   trunk/windstille/tools/SConscript
Log:
- added SDL based jstest application

Added: trunk/scripts/README
===================================================================
--- trunk/scripts/README	2007-06-18 19:38:17 UTC (rev 1469)
+++ trunk/scripts/README	2007-06-19 20:27:19 UTC (rev 1470)
@@ -0,0 +1,6 @@
+scripts/
+========
+
+Miscellaneous scripts for managing and validating the SVN repository
+
+# EOF #
\ No newline at end of file

Added: trunk/scripts/mime-fix.sh
===================================================================
--- trunk/scripts/mime-fix.sh	2007-06-18 19:38:17 UTC (rev 1469)
+++ trunk/scripts/mime-fix.sh	2007-06-19 20:27:19 UTC (rev 1470)
@@ -0,0 +1,28 @@
+#!/bin/sh
+
+if [ $# -eq 0 ]; then
+  echo "Usage $0 DIRECTORY..."
+else
+  for i in "$@"; do
+    # XCF
+    find "$i" -type f -a -name "*.xcf" -print0 | \
+    while read -d $'\0' -r file; do
+      if svn ls "$file" && [ ! "$(svn propget svn:mime-type "$file")" = "application/x-xcf" ]; then
+         echo "$file"
+	 svn propset svn:mime-type "application/x-xcf" "$file"
+      fi
+    done
+
+    # PNG
+    find "$i" -type f -a -name "*.png" -print0 | \
+    while read -d $'\0' -r file; do
+      if svn ls "$file" && [ ! "$(svn propget svn:mime-type "$file")" = "image/png" ]; then
+         echo "$file"
+	 svn propset svn:mime-type "image/png" "$file"
+      fi
+    done
+
+done
+fi
+
+# EOF #


Property changes on: trunk/scripts/mime-fix.sh
___________________________________________________________________
Name: svn:executable
   + *

Modified: trunk/windstille/SConstruct
===================================================================
--- trunk/windstille/SConstruct	2007-06-18 19:38:17 UTC (rev 1469)
+++ trunk/windstille/SConstruct	2007-06-19 20:27:19 UTC (rev 1470)
@@ -202,6 +202,7 @@
 # SConscript('build/src/scripting/SConscript')
 
 SConscript('tools/SConscript')
+SConscript('tools/sdl-jstest/SConscript')
 SConscript('lib/SConscript')
 SConscript('src/SConscript')
 

Modified: trunk/windstille/src/scriptable_object.cpp
===================================================================
--- trunk/windstille/src/scriptable_object.cpp	2007-06-18 19:38:17 UTC (rev 1469)
+++ trunk/windstille/src/scriptable_object.cpp	2007-06-19 20:27:19 UTC (rev 1470)
@@ -49,7 +49,7 @@
   props.get("script", use_script);
   props.get("use-verb", use_verb);
   props.get("active", active);
-  props.get("flash-speed", flash_speed);
+  props.get("flash-speed", flash_speed); // FIXME: bad name, should be something more generic
   props.get("z-pos", z_pos);
   props.print_unused_warnings("scriptable-object");
   

Modified: trunk/windstille/tools/SConscript
===================================================================
--- trunk/windstille/tools/SConscript	2007-06-18 19:38:17 UTC (rev 1469)
+++ trunk/windstille/tools/SConscript	2007-06-19 20:27:19 UTC (rev 1470)
@@ -2,6 +2,8 @@
 
 import glob
 
+Import('conf_env')
+
 env = Environment(CPPPATH=['../..'],
                   CXXFILESUFFIX = ".cpp",
                   YACCFLAGS=['-d', '--no-lines'])


Property changes on: trunk/windstille/tools/sdl-jstest
___________________________________________________________________
Name: svn:ignore
   + sdl-jstest


Added: trunk/windstille/tools/sdl-jstest/Makefile
===================================================================
--- trunk/windstille/tools/sdl-jstest/Makefile	2007-06-18 19:38:17 UTC (rev 1469)
+++ trunk/windstille/tools/sdl-jstest/Makefile	2007-06-19 20:27:19 UTC (rev 1470)
@@ -0,0 +1,4 @@
+sdl-jstest: sdl-jstest.c
+	$(CC) -o $@ $< -std=c99 -Wall `sdl-config --cflags --libs` -lcurses
+
+# EOF #

Added: trunk/windstille/tools/sdl-jstest/SConscript
===================================================================
--- trunk/windstille/tools/sdl-jstest/SConscript	2007-06-18 19:38:17 UTC (rev 1469)
+++ trunk/windstille/tools/sdl-jstest/SConscript	2007-06-19 20:27:19 UTC (rev 1470)
@@ -0,0 +1,36 @@
+##  -*- python -*-
+##  $Id: windstille_main.hpp 1097 2005-09-23 16:01:59Z grumbel $
+##   __      __ __             ___        __   __ __   __
+##  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+##  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+##   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+##    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+##         \/          \/      \/    \/                         \/
+##  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+##
+##  This program is free software; you can redistribute it and/or
+##  modify it under the terms of the GNU General Public License
+##  as published by the Free Software Foundation; either version 2
+##  of the License, or (at your option) any later version.
+##
+##  This program is distributed in the hope that it will be useful,
+##  but WITHOUT ANY WARRANTY; without even the implied warranty of
+##  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+##  GNU General Public License for more details.
+## 
+##  You should have received a copy of the GNU General Public License
+##  along with this program; if not, write to the Free Software
+##  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+##  02111-1307, USA.
+##
+
+Import('conf_env')
+
+sdl_jstest_env = conf_env.Copy()
+sdl_jstest_env.Append(CCFLAGS=["-std=c99", "-Wall"])
+sdl_jstest_env.Append(LIBS=["curses"])
+sdl_jstest_env.ParseConfig('sdl-config --cflags --libs')
+sdl_jstest_env.Program('sdl-jstest', ['sdl-jstest.c'])
+
+# EOF #
+

Added: trunk/windstille/tools/sdl-jstest/sdl-jstest.c
===================================================================
--- trunk/windstille/tools/sdl-jstest/sdl-jstest.c	2007-06-18 19:38:17 UTC (rev 1469)
+++ trunk/windstille/tools/sdl-jstest/sdl-jstest.c	2007-06-19 20:27:19 UTC (rev 1470)
@@ -0,0 +1,355 @@
+/*  $Id$
+**  sdl-jstest - Joystick Test Program for SDL
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include <SDL/SDL.h>
+#include <assert.h>
+#include <curses.h>
+#include <errno.h>
+#include <limits.h>
+#include <stdio.h>
+#include <stdlib.h>
+
+void print_bar(int pos, int len)
+{
+  addch('[');
+  for(int i = 0; i < len; ++i)
+    {
+      if (i == pos)
+        addch('#');
+      else
+        addch(' ');
+    }
+  addch(']');
+}
+
+int str2int(const char* str, int* val)
+{
+  char* endptr;
+  errno = 0;    /* To distinguish success/failure after call */
+
+  *val = strtol(str, &endptr, 10);
+
+  /* Check for various possible errors */
+  if ((errno == ERANGE && (*val == LONG_MAX || *val == LONG_MIN))
+      || (errno != 0 && *val == 0)) {
+    return 0;
+  }
+
+  if (endptr == str) {
+    return 0;
+  }
+  
+  return 1;
+}
+
+void print_joystick_info(int joy_idx, SDL_Joystick* joy)
+{
+  printf("Joystick Name:     '%s'\n", SDL_JoystickName(joy_idx));
+  printf("Joystick Number:   %2d\n", joy_idx);
+  printf("Number of Axes:    %2d\n", SDL_JoystickNumAxes(joy));
+  printf("Number of Buttons: %2d\n", SDL_JoystickNumButtons(joy));
+  printf("Number of Hats:    %2d\n", SDL_JoystickNumHats(joy));
+  printf("Number of Balls:   %2d\n", SDL_JoystickNumBalls(joy));
+  printf("\n");
+}
+
+void print_help(const char* prg)
+{
+  printf("Usage: %s [OPTION]\n", prg);
+  printf("List available joysticks or test a  joystick.\n");
+  printf("This programm uses SDL for doing its test instead of using the raw\n"
+         "/dev/input/jsX interface\n");
+  printf("\n");
+  printf("Options:\n");
+  printf("  --list             Search for available joysticks and list their properties\n");
+  printf("  --test  JOYNUM     Display a graphical representation of the current joystick state\n");
+  printf("  --event JOYNUM     Display the events that are recieved by the joystick\n");
+  printf("  --help             Print this help\n");
+  printf("\n");
+  printf("Examples:\n");
+  printf("  %s --list\n", prg);
+  printf("  %s --test 1\n", prg);
+}
+
+int main(int argc, char** argv)
+{
+  if (argc == 1)
+    {
+      print_help(argv[0]);
+      exit(1);
+    }
+
+  // FIXME: We don't need video, but without it SDL will fail to work in SDL_WaitEvent()
+  if(SDL_Init(SDL_INIT_TIMER | SDL_INIT_VIDEO | SDL_INIT_JOYSTICK) < 0)  
+    {
+      fprintf(stderr, "Unable to init SDL: %s\n", SDL_GetError());
+      exit(1);
+    }
+  else
+    {
+      atexit(SDL_Quit);
+
+      if (argc == 2 && (strcmp(argv[1], "--help") == 0 ||
+                        strcmp(argv[1], "-h") == 0))
+        {
+          print_help(argv[0]);
+        }
+      else if (argc == 2 && (strcmp(argv[1], "--list") == 0 ||
+                             (strcmp(argv[1], "-l") == 0)))
+        {
+          int num_joysticks = SDL_NumJoysticks();
+          if (num_joysticks == 0)
+            {
+              printf("No joysticks were found\n");
+            }
+          else 
+            {
+              printf("Found %d joystick(s)\n\n", num_joysticks);
+              for(int joy_idx = 0; joy_idx < num_joysticks; ++joy_idx)
+                {
+                  SDL_Joystick* joy = SDL_JoystickOpen(joy_idx);
+                  if (!joy)
+                    {
+                      fprintf(stderr, "Unable to open joystick %d\n", joy_idx);
+                    }
+                  else
+                    {
+                      print_joystick_info(joy_idx, joy);
+                      SDL_JoystickClose(joy);
+                    }
+                }
+            }
+        }
+      else if (argc == 3 && (strcmp(argv[1], "--test") == 0 ||
+                             strcmp(argv[1], "-t") == 0))
+        {
+          int joy_idx;
+          if (!str2int(argv[2], &joy_idx))
+            {
+              fprintf(stderr, "Error: JOYSTICKNUM argument must be a number, but was '%s'\n", argv[2]);
+              exit(1);
+            }
+
+          SDL_Joystick* joy = SDL_JoystickOpen(joy_idx);
+          if (!joy)
+            {
+              fprintf(stderr, "Unable to open joystick %d\n", joy_idx);
+            }
+          else
+            {
+              initscr();
+
+              //cbreak(); 
+              //noecho();
+              //nonl();  
+              curs_set(0);
+
+              int num_axes    = SDL_JoystickNumAxes(joy);
+              int num_buttons = SDL_JoystickNumButtons(joy);
+              int num_hats    = SDL_JoystickNumHats(joy);
+              int num_balls   = SDL_JoystickNumBalls(joy);
+              
+              Sint16* axes    = calloc(num_axes,    sizeof(Sint16));
+              Uint8*  buttons = calloc(num_buttons, sizeof(Uint8));
+              Uint8*  hats    = calloc(num_hats,    sizeof(Uint8));
+              Uint8*  balls   = calloc(num_balls,   2*sizeof(Sint16));
+              
+              int quit = 0;
+              SDL_Event event;
+              while(!quit)
+                {
+                  if (SDL_WaitEvent(&event)) {
+                    switch(event.type)
+                      {
+                      case SDL_JOYAXISMOTION:
+                        assert(event.jaxis.axis < num_axes);
+                        axes[event.jaxis.axis] = event.jaxis.value;
+                        break;
+
+                      case SDL_JOYBUTTONDOWN:
+                      case SDL_JOYBUTTONUP:
+                        assert(event.jbutton.button < num_buttons);
+                        buttons[event.jbutton.button] = event.jbutton.state;
+                        break;
+
+                      case SDL_JOYHATMOTION:
+                        assert(event.jhat.hat < num_hats);
+                        hats[event.jhat.hat] = event.jhat.value;
+                        break;
+
+                      case SDL_JOYBALLMOTION:
+                        assert(event.jball.ball < num_balls);
+                        balls[2*event.jball.ball + 0] = event.jball.xrel;
+                        balls[2*event.jball.ball + 1] = event.jball.yrel;
+                        break;
+
+                      case SDL_QUIT:
+                        quit = 1;
+                        printf("Recieved interrupt, exiting\n");
+                        break;
+                      
+                      default:
+                        fprintf(stderr, "Error: Unhandled event type: %d\n", event.type);
+                      }                
+                  } else {
+                    fprintf(stderr, "Error in SDL_WaitEvent\n");
+                    quit = 1;
+                  }
+                  
+                  //clear();
+                  move(0,0);
+                  
+                  printw("Joystick Name:   '%s'\n", SDL_JoystickName(joy_idx));
+                  printw("Joystick Number: %d\n", joy_idx);
+                  printw("\n");
+
+                  printw("Axes %2d:\n", num_axes);
+                  for(int i = 0; i < num_axes; ++i)
+                    {
+                      int len = COLS - 20;
+                      printw("  %2d: %6d  ", i, axes[i]);
+                      print_bar((axes[i] + 32767) * (len-1) / 65534, len);
+                      addch('\n');
+                    }
+                  printw("\n");
+
+                  printw("Buttons %2d:\n", num_buttons);
+                  for(int i = 0; i < num_buttons; ++i)
+                    {
+                      printw("  %2d: %d  %s\n", i, buttons[i], buttons[i] ? "[#]":"[ ]");
+                    }
+                  printw("\n");
+
+                  printw("Hats %2d:\n", num_hats);
+                  for(int i = 0; i < num_hats; ++i)
+                    {
+                      printw("  %2d: %d\n", i, hats[i]);
+                      printw("  +---+\n"
+                             "  |%c%c%c|\n"
+                             "  |%c%c%c|\n"
+                             "  |%c%c%c|\n"
+                             "  +---+\n",
+                             ((hats[i] & SDL_HAT_UP) && (hats[i] & SDL_HAT_LEFT)) ? '#' : ' ',
+                             ((hats[i] & SDL_HAT_UP) && !(hats[i] & (SDL_HAT_LEFT | SDL_HAT_RIGHT))) ? '#' : ' ',
+                             ((hats[i] & SDL_HAT_UP) && (hats[i] & SDL_HAT_RIGHT)) ? '#' : ' ',
+
+                             (!(hats[i] & (SDL_HAT_UP | SDL_HAT_DOWN)) && (hats[i] & SDL_HAT_LEFT)) ? '#' : ' ',
+                             (!(hats[i] & (SDL_HAT_UP | SDL_HAT_DOWN)) && !(hats[i] & (SDL_HAT_LEFT | SDL_HAT_RIGHT))) ? '#' : ' ',
+                             (!(hats[i] & (SDL_HAT_UP | SDL_HAT_DOWN)) && (hats[i] & SDL_HAT_RIGHT)) ? '#' : ' ',
+
+                             ((hats[i] & SDL_HAT_DOWN) && (hats[i] & SDL_HAT_LEFT)) ? '#' : ' ',
+                             ((hats[i] & SDL_HAT_DOWN) && !(hats[i] & (SDL_HAT_LEFT | SDL_HAT_RIGHT))) ? '#' : ' ',
+                             ((hats[i] & SDL_HAT_DOWN) && (hats[i] & SDL_HAT_RIGHT)) ? '#' : ' ');                    }
+                  printw("\n");
+
+                  printw("Balls %2d: ", num_balls);
+                  for(int i = 0; i < num_balls; ++i)
+                    {
+                      printw("  %2d: %6d %6d\n", i, balls[2*i+0], balls[2*i+0]);
+                    }
+                  printw("\n");
+                  printw("\n");
+                  printw("Press Ctrl-c to exit\n");
+                  
+                  refresh();
+                } // while
+
+              free(balls);
+              free(hats);
+              free(buttons);
+              free(axes);
+              
+              endwin();
+            }
+        }
+      else if (argc == 3 && (strcmp(argv[1], "--event") == 0 ||
+                             strcmp(argv[1], "-e") == 0))
+        {
+          int joy_idx;
+          if (!str2int(argv[2], &joy_idx))
+            {
+              fprintf(stderr, "Error: JOYSTICKNUM argument must be a number, but was '%s'\n", argv[2]);
+              exit(1);
+            }
+
+          SDL_Joystick* joy = SDL_JoystickOpen(joy_idx);
+          if (!joy)
+            {
+              fprintf(stderr, "Unable to open joystick %d\n", joy_idx);
+            }
+          else
+            {
+              print_joystick_info(joy_idx, joy);
+
+              printf("Entering joystick test loop, press Ctrl-c to exit\n");
+              int quit = 0;
+              SDL_Event event;
+
+              while(!quit && SDL_WaitEvent(&event))
+                {
+                  switch(event.type)
+                    {
+                    case SDL_JOYAXISMOTION:
+                      printf("SDL_JOYAXISMOTION: joystick: %d axis: %d value: %d\n", 
+                             event.jaxis.which, event.jaxis.axis, event.jaxis.value);
+                      break;
+
+                    case SDL_JOYBUTTONDOWN:
+                      printf("SDL_JOYBUTTONUP: joystick: %d button: %d state: %d\n", 
+                             event.jbutton.which, event.jbutton.button, event.jbutton.state);
+                      break;
+                    case SDL_JOYBUTTONUP:
+                      printf("SDL_JOYBUTTONDOWN: joystick: %d button: %d state: %d\n", 
+                             event.jbutton.which, event.jbutton.button, event.jbutton.state);
+                      break;
+
+                    case SDL_JOYHATMOTION:
+                      printf("SDL_JOYHATMOTION: joystick: %d hat: %d value: %d\n", 
+                             event.jhat.which, event.jhat.hat, event.jhat.value);
+                      break;
+
+                    case SDL_JOYBALLMOTION:
+                      printf("SDL_JOYBALLMOTION: joystick: %d ball: %d x: %d y: %d\n", 
+                             event.jball.which, event.jball.ball, event.jball.xrel, event.jball.yrel);
+                      break;
+
+                    case SDL_QUIT:
+                      quit = 1;
+                      printf("Recieved interrupt, exiting\n");
+                      break;
+                      
+                    default:
+                      fprintf(stderr, "Error: Unhandled event type: %d\n", event.type);
+                    }
+                }
+              SDL_JoystickClose(joy);
+              
+            }      
+          fprintf(stderr, "Unable to init SDL: %s\n", SDL_GetError());
+        }
+      else
+        {
+          fprintf(stderr, "%s: unknown arguments\n", argv[0]);
+          fprintf(stderr, "Try '%s --help' for more informations\n", argv[0]);
+        }
+    }
+}
+
+  /* EOF */


Property changes on: trunk/windstille/tools/sdl-jstest/sdl-jstest.c
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Wed Jun 20 00:15:01 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 20 Jun 2007 00:15:01 +0200
Subject: [Windstille-commit] r1471 - trunk/windstille/tools/sdl-jstest
Message-ID: <200706192215.l5JMF1ud016069@sheep.berlios.de>

Author: grumbel
Date: 2007-06-20 00:15:01 +0200 (Wed, 20 Jun 2007)
New Revision: 1471

Modified:
   trunk/windstille/tools/sdl-jstest/sdl-jstest.c
Log:
- made sdl-jstest a little prettier

Modified: trunk/windstille/tools/sdl-jstest/sdl-jstest.c
===================================================================
--- trunk/windstille/tools/sdl-jstest/sdl-jstest.c	2007-06-19 20:27:19 UTC (rev 1470)
+++ trunk/windstille/tools/sdl-jstest/sdl-jstest.c	2007-06-19 22:15:01 UTC (rev 1471)
@@ -55,7 +55,7 @@
   if (endptr == str) {
     return 0;
   }
-  
+
   return 1;
 }
 
@@ -80,7 +80,7 @@
   printf("Options:\n");
   printf("  --list             Search for available joysticks and list their properties\n");
   printf("  --test  JOYNUM     Display a graphical representation of the current joystick state\n");
-  printf("  --event JOYNUM     Display the events that are recieved by the joystick\n");
+  printf("  --event JOYNUM     Display the events that are recieved from the joystick\n");
   printf("  --help             Print this help\n");
   printf("\n");
   printf("Examples:\n");
@@ -97,7 +97,7 @@
     }
 
   // FIXME: We don't need video, but without it SDL will fail to work in SDL_WaitEvent()
-  if(SDL_Init(SDL_INIT_TIMER | SDL_INIT_VIDEO | SDL_INIT_JOYSTICK) < 0)  
+  if(SDL_Init(SDL_INIT_TIMER | SDL_INIT_VIDEO | SDL_INIT_JOYSTICK) < 0)
     {
       fprintf(stderr, "Unable to init SDL: %s\n", SDL_GetError());
       exit(1);
@@ -119,7 +119,7 @@
             {
               printf("No joysticks were found\n");
             }
-          else 
+          else
             {
               printf("Found %d joystick(s)\n\n", num_joysticks);
               for(int joy_idx = 0; joy_idx < num_joysticks; ++joy_idx)
@@ -156,21 +156,21 @@
             {
               initscr();
 
-              //cbreak(); 
+              //cbreak();
               //noecho();
-              //nonl();  
+              //nonl();
               curs_set(0);
 
               int num_axes    = SDL_JoystickNumAxes(joy);
               int num_buttons = SDL_JoystickNumButtons(joy);
               int num_hats    = SDL_JoystickNumHats(joy);
               int num_balls   = SDL_JoystickNumBalls(joy);
-              
+
               Sint16* axes    = calloc(num_axes,    sizeof(Sint16));
               Uint8*  buttons = calloc(num_buttons, sizeof(Uint8));
               Uint8*  hats    = calloc(num_hats,    sizeof(Uint8));
               Uint8*  balls   = calloc(num_balls,   2*sizeof(Sint16));
-              
+
               int quit = 0;
               SDL_Event event;
               while(!quit)
@@ -204,18 +204,18 @@
                         quit = 1;
                         printf("Recieved interrupt, exiting\n");
                         break;
-                      
+
                       default:
                         fprintf(stderr, "Error: Unhandled event type: %d\n", event.type);
-                      }                
+                      }
                   } else {
                     fprintf(stderr, "Error in SDL_WaitEvent\n");
                     quit = 1;
                   }
-                  
+
                   //clear();
                   move(0,0);
-                  
+
                   printw("Joystick Name:   '%s'\n", SDL_JoystickName(joy_idx));
                   printw("Joystick Number: %d\n", joy_idx);
                   printw("\n");
@@ -240,23 +240,33 @@
                   printw("Hats %2d:\n", num_hats);
                   for(int i = 0; i < num_hats; ++i)
                     {
-                      printw("  %2d: %d\n", i, hats[i]);
-                      printw("  +---+\n"
-                             "  |%c%c%c|\n"
-                             "  |%c%c%c|\n"
-                             "  |%c%c%c|\n"
-                             "  +---+\n",
-                             ((hats[i] & SDL_HAT_UP) && (hats[i] & SDL_HAT_LEFT)) ? '#' : ' ',
-                             ((hats[i] & SDL_HAT_UP) && !(hats[i] & (SDL_HAT_LEFT | SDL_HAT_RIGHT))) ? '#' : ' ',
-                             ((hats[i] & SDL_HAT_UP) && (hats[i] & SDL_HAT_RIGHT)) ? '#' : ' ',
+                      printw("  %2d: value: %d\n", i, hats[i]);
+                      printw("  +-----+  up:    %c\n"
+                             "  |%c %c %c|  down:  %c\n"
+                             "  |%c %c %c|  left:  %c\n"
+                             "  |%c %c %c|  right: %c\n"
+                             "  +-----+\n",
 
-                             (!(hats[i] & (SDL_HAT_UP | SDL_HAT_DOWN)) && (hats[i] & SDL_HAT_LEFT)) ? '#' : ' ',
-                             (!(hats[i] & (SDL_HAT_UP | SDL_HAT_DOWN)) && !(hats[i] & (SDL_HAT_LEFT | SDL_HAT_RIGHT))) ? '#' : ' ',
-                             (!(hats[i] & (SDL_HAT_UP | SDL_HAT_DOWN)) && (hats[i] & SDL_HAT_RIGHT)) ? '#' : ' ',
+                             (hats[i] & SDL_HAT_UP)?'1':'0',
 
-                             ((hats[i] & SDL_HAT_DOWN) && (hats[i] & SDL_HAT_LEFT)) ? '#' : ' ',
-                             ((hats[i] & SDL_HAT_DOWN) && !(hats[i] & (SDL_HAT_LEFT | SDL_HAT_RIGHT))) ? '#' : ' ',
-                             ((hats[i] & SDL_HAT_DOWN) && (hats[i] & SDL_HAT_RIGHT)) ? '#' : ' ');                    }
+                             ((hats[i] & SDL_HAT_UP) && (hats[i] & SDL_HAT_LEFT)) ? 'O' : ' ',
+                             ((hats[i] & SDL_HAT_UP) && !(hats[i] & (SDL_HAT_LEFT | SDL_HAT_RIGHT))) ? 'O' : ' ',
+                             ((hats[i] & SDL_HAT_UP) && (hats[i] & SDL_HAT_RIGHT)) ? 'O' : ' ',
+
+                             (hats[i] & SDL_HAT_DOWN)?'1':'0',
+
+                             (!(hats[i] & (SDL_HAT_UP | SDL_HAT_DOWN)) && (hats[i] & SDL_HAT_LEFT)) ? 'O' : ' ',
+                             (!(hats[i] & (SDL_HAT_UP | SDL_HAT_DOWN)) && !(hats[i] & (SDL_HAT_LEFT | SDL_HAT_RIGHT))) ? 'O' : ' ',
+                             (!(hats[i] & (SDL_HAT_UP | SDL_HAT_DOWN)) && (hats[i] & SDL_HAT_RIGHT)) ? 'O' : ' ',
+
+                             (hats[i] & SDL_HAT_LEFT)?'1':'0',
+
+                             ((hats[i] & SDL_HAT_DOWN) && (hats[i] & SDL_HAT_LEFT)) ? 'O' : ' ',
+                             ((hats[i] & SDL_HAT_DOWN) && !(hats[i] & (SDL_HAT_LEFT | SDL_HAT_RIGHT))) ? 'O' : ' ',
+                             ((hats[i] & SDL_HAT_DOWN) && (hats[i] & SDL_HAT_RIGHT)) ? 'O' : ' ',
+
+                             (hats[i] & SDL_HAT_RIGHT)?'1':'0');
+                    }
                   printw("\n");
 
                   printw("Balls %2d: ", num_balls);
@@ -267,7 +277,7 @@
                   printw("\n");
                   printw("\n");
                   printw("Press Ctrl-c to exit\n");
-                  
+
                   refresh();
                 } // while
 
@@ -275,7 +285,7 @@
               free(hats);
               free(buttons);
               free(axes);
-              
+
               endwin();
             }
         }
@@ -307,26 +317,26 @@
                   switch(event.type)
                     {
                     case SDL_JOYAXISMOTION:
-                      printf("SDL_JOYAXISMOTION: joystick: %d axis: %d value: %d\n", 
+                      printf("SDL_JOYAXISMOTION: joystick: %d axis: %d value: %d\n",
                              event.jaxis.which, event.jaxis.axis, event.jaxis.value);
                       break;
 
                     case SDL_JOYBUTTONDOWN:
-                      printf("SDL_JOYBUTTONUP: joystick: %d button: %d state: %d\n", 
+                      printf("SDL_JOYBUTTONUP: joystick: %d button: %d state: %d\n",
                              event.jbutton.which, event.jbutton.button, event.jbutton.state);
                       break;
                     case SDL_JOYBUTTONUP:
-                      printf("SDL_JOYBUTTONDOWN: joystick: %d button: %d state: %d\n", 
+                      printf("SDL_JOYBUTTONDOWN: joystick: %d button: %d state: %d\n",
                              event.jbutton.which, event.jbutton.button, event.jbutton.state);
                       break;
 
                     case SDL_JOYHATMOTION:
-                      printf("SDL_JOYHATMOTION: joystick: %d hat: %d value: %d\n", 
+                      printf("SDL_JOYHATMOTION: joystick: %d hat: %d value: %d\n",
                              event.jhat.which, event.jhat.hat, event.jhat.value);
                       break;
 
                     case SDL_JOYBALLMOTION:
-                      printf("SDL_JOYBALLMOTION: joystick: %d ball: %d x: %d y: %d\n", 
+                      printf("SDL_JOYBALLMOTION: joystick: %d ball: %d x: %d y: %d\n",
                              event.jball.which, event.jball.ball, event.jball.xrel, event.jball.yrel);
                       break;
 
@@ -334,14 +344,14 @@
                       quit = 1;
                       printf("Recieved interrupt, exiting\n");
                       break;
-                      
+
                     default:
                       fprintf(stderr, "Error: Unhandled event type: %d\n", event.type);
                     }
                 }
               SDL_JoystickClose(joy);
-              
-            }      
+
+            }
           fprintf(stderr, "Unable to init SDL: %s\n", SDL_GetError());
         }
       else



From grumbel at mail.berlios.de  Wed Jun 20 00:16:43 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 20 Jun 2007 00:16:43 +0200
Subject: [Windstille-commit] r1472 - in trunk/windstille/src: . input
Message-ID: <200706192216.l5JMGh7j016207@sheep.berlios.de>

Author: grumbel
Date: 2007-06-20 00:16:42 +0200 (Wed, 20 Jun 2007)
New Revision: 1472

Modified:
   trunk/windstille/src/geometry_test.cpp
   trunk/windstille/src/input/input_configurator.cpp
   trunk/windstille/src/input/input_manager_sdl.cpp
   trunk/windstille/src/input/input_manager_sdl.hpp
   trunk/windstille/src/navigation_test.cpp
   trunk/windstille/src/view.cpp
Log:
- added option to invert an axis

Modified: trunk/windstille/src/geometry_test.cpp
===================================================================
--- trunk/windstille/src/geometry_test.cpp	2007-06-19 22:15:01 UTC (rev 1471)
+++ trunk/windstille/src/geometry_test.cpp	2007-06-19 22:16:42 UTC (rev 1472)
@@ -89,7 +89,7 @@
   cursor.y += controller.get_axis_state(Y_AXIS) * 500.0f * delta;
 
   cursor2.x += controller.get_axis_state(X2_AXIS) * 500.0f * delta;
-  cursor2.y -= controller.get_axis_state(Y2_AXIS) * 500.0f * delta;
+  cursor2.y += controller.get_axis_state(Y2_AXIS) * 500.0f * delta;
 
   if (controller.button_was_pressed(PRIMARY_BUTTON))
     {

Modified: trunk/windstille/src/input/input_configurator.cpp
===================================================================
--- trunk/windstille/src/input/input_configurator.cpp	2007-06-19 22:15:01 UTC (rev 1471)
+++ trunk/windstille/src/input/input_configurator.cpp	2007-06-19 22:16:42 UTC (rev 1472)
@@ -167,8 +167,8 @@
 
     case SDL_JOYAXISMOTION:
       if (items.back().mode == ConfigureItem::CONFIGURE_AXIS && (event.jaxis.value > 16384 || event.jaxis.value < -16384))
-        { // FIXME: This doesn't work with analog Axis!
-          InputManagerSDL::current()->bind_joystick_axis(items.back().event_id, event.jaxis.which, event.jaxis.axis);
+        { // FIXME: This doesn't work well with analog Axis!
+          InputManagerSDL::current()->bind_joystick_axis(items.back().event_id, event.jaxis.which, event.jaxis.axis, false);
           out << "(joystick-axis (device " << int(event.jaxis.which) << ")\n"
               << "               (axis   " << int(event.jaxis.axis) << "))" << std::endl;
           next_item();

Modified: trunk/windstille/src/input/input_manager_sdl.cpp
===================================================================
--- trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-19 22:15:01 UTC (rev 1471)
+++ trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-19 22:16:42 UTC (rev 1472)
@@ -32,7 +32,7 @@
 
 InputManagerSDL* InputManagerSDL::current_ = 0;
 
-#define DEAD_ZONE 4096
+const int dead_zone =  4096;
 
 class InputManagerSDLImpl
 {
@@ -144,13 +144,15 @@
                 {
                   int device = 0;
                   int axis   = 0;
+                  bool invert = false;
 
                   lisp::Properties props(*dev_iter);
                   props.get("device", device);
                   props.get("axis",   axis);
+                  props.get("invert", invert);
 
                   bind_joystick_axis(controller_description.get_definition(iter.item()).id,
-                                     device, axis);
+                                     device, axis, invert);
                 }
               else if (dev_iter.item() == "keyboard-axis")
                 {
@@ -317,13 +319,13 @@
       if (event.which  == i->device &&
           event.axis   == i->axis)
         {
-          if (event.value < -DEAD_ZONE)
+          if (event.value < -dead_zone)
             {
-              add_axis_event(i->event, event.value/32768.0f);
+              add_axis_event(i->event, event.value/(i->invert?-32768.0f:32768.0f));
             }
-          else if (event.value > DEAD_ZONE)
+          else if (event.value > dead_zone)
             {
-              add_axis_event(i->event, event.value/32767.0f);
+              add_axis_event(i->event, event.value/(i->invert?-32768.0f:32768.0f));
             }
           else
             {
@@ -416,6 +418,7 @@
 void
 InputManagerSDL::bind_joystick_hat_axis(int event, int device, int axis)
 {
+  
 }
 
 void
@@ -434,7 +437,7 @@
 }
 
 void
-InputManagerSDL::bind_joystick_axis(int event, int device, int axis)
+InputManagerSDL::bind_joystick_axis(int event, int device, int axis, bool invert)
 {
   ensure_open_joystick(device);
 
@@ -443,6 +446,7 @@
   binding.event  = event;
   binding.device = device;
   binding.axis   = axis;
+  binding.invert = invert;
 
   impl->joystick_axis_bindings.push_back(binding);
 }

Modified: trunk/windstille/src/input/input_manager_sdl.hpp
===================================================================
--- trunk/windstille/src/input/input_manager_sdl.hpp	2007-06-19 22:15:01 UTC (rev 1471)
+++ trunk/windstille/src/input/input_manager_sdl.hpp	2007-06-19 22:16:42 UTC (rev 1472)
@@ -41,9 +41,10 @@
 
 struct JoystickAxisBinding
 {
-  int event;
-  int device;
-  int axis;
+  int  event;
+  int  device;
+  int  axis;
+  bool invert;
 };
 
 struct JoystickButtonAxisBinding
@@ -98,7 +99,7 @@
 
   void bind_joystick_hat_axis(int event, int device, int axis);
 
-  void bind_joystick_axis(int event, int device, int axis);
+  void bind_joystick_axis(int event, int device, int axis, bool invert);
   void bind_joystick_button_axis(int event, int device, int minus, int plus);
   void bind_joystick_button(int event, int device, int button);
 

Modified: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-19 22:15:01 UTC (rev 1471)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-19 22:16:42 UTC (rev 1472)
@@ -110,9 +110,8 @@
   cursor += Vector(controller.get_axis_state(X_AXIS) * 500.0f * delta,
                    controller.get_axis_state(Y_AXIS) * 500.0f * delta);
 
-  // FIXME: xpad driver is buggy and reverses the Y2 axis
   stick = Vector(controller.get_axis_state(X2_AXIS),
-                 -controller.get_axis_state(Y2_AXIS));
+                 controller.get_axis_state(Y2_AXIS));
 
   if (controller.button_was_pressed(PRIMARY_BUTTON))
     {

Modified: trunk/windstille/src/view.cpp
===================================================================
--- trunk/windstille/src/view.cpp	2007-06-19 22:15:01 UTC (rev 1471)
+++ trunk/windstille/src/view.cpp	2007-06-19 22:16:42 UTC (rev 1472)
@@ -79,7 +79,7 @@
   }
 
   transform.x += 0.5f * controller.get_axis_state(X2_AXIS) / zoom;
-  transform.y -= 0.5f * controller.get_axis_state(Y2_AXIS) / zoom;
+  transform.y += 0.5f * controller.get_axis_state(Y2_AXIS) / zoom;
 }
 
 Rectf



From grumbel at mail.berlios.de  Wed Jun 20 00:19:35 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 20 Jun 2007 00:19:35 +0200
Subject: [Windstille-commit] r1473 - in trunk/windstille: . data/controller
Message-ID: <200706192219.l5JMJZ4r016642@sheep.berlios.de>

Author: grumbel
Date: 2007-06-20 00:19:35 +0200 (Wed, 20 Jun 2007)
New Revision: 1473

Modified:
   trunk/windstille/TODO
   trunk/windstille/data/controller/keyboard.scm
Log:
- added option to invert an axis

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-19 22:16:42 UTC (rev 1472)
+++ trunk/windstille/TODO	2007-06-19 22:19:35 UTC (rev 1473)
@@ -6,7 +6,7 @@
 
 Input Handling:
 ---------------
-- add option to invert axis
+- add option to configure dead zone
 - implement proper dead-zone in input handling
 - allow to load multiple controller config files
 

Modified: trunk/windstille/data/controller/keyboard.scm
===================================================================
--- trunk/windstille/data/controller/keyboard.scm	2007-06-19 22:16:42 UTC (rev 1472)
+++ trunk/windstille/data/controller/keyboard.scm	2007-06-19 22:19:35 UTC (rev 1473)
@@ -14,7 +14,7 @@
 
  (y2-axis
   (keyboard-axis (minus "[2]") (plus "[8]"))
-  (joystick-axis (device 0)  (axis 3)))
+  (joystick-axis (device 0)  (axis 3) (invert #t)))
 
  (view-center-button
   (keyboard-button (key "[5]"))



From grumbel at mail.berlios.de  Wed Jun 20 02:06:25 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 20 Jun 2007 02:06:25 +0200
Subject: [Windstille-commit] r1474 - in trunk/windstille: . data/controller
	src src/input src/lisp
Message-ID: <200706200006.l5K06Pc7007642@sheep.berlios.de>

Author: grumbel
Date: 2007-06-20 02:06:24 +0200 (Wed, 20 Jun 2007)
New Revision: 1474

Added:
   trunk/windstille/data/controller/xbox360.scm
Modified:
   trunk/windstille/TODO
   trunk/windstille/data/controller/keyboard.scm
   trunk/windstille/src/config.cpp
   trunk/windstille/src/input/input_manager.cpp
   trunk/windstille/src/input/input_manager.hpp
   trunk/windstille/src/input/input_manager_impl.hpp
   trunk/windstille/src/input/input_manager_sdl.cpp
   trunk/windstille/src/input/input_manager_sdl.hpp
   trunk/windstille/src/lisp/writer.cpp
   trunk/windstille/src/windstille_main.cpp
Log:
- added secondary controller file, this isn't pretty, but allows to keep keyboard and joystick mappings in seperate files

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-19 22:19:35 UTC (rev 1473)
+++ trunk/windstille/TODO	2007-06-20 00:06:24 UTC (rev 1474)
@@ -15,6 +15,12 @@
 - split music, voice and sound fx into seperate context or allow to
   change their volume by other means
 
+Screen Handling:
+----------------
+- using a screen size != 800x600 breaks the lighting
+- using a screen size != 800x600 loads to ugly fonts, should render
+  the fonts so that we get 1:1 pixel mapping
+
 Misc:
 -----
 - polish/test scripting interface

Modified: trunk/windstille/data/controller/keyboard.scm
===================================================================
--- trunk/windstille/data/controller/keyboard.scm	2007-06-19 22:19:35 UTC (rev 1473)
+++ trunk/windstille/data/controller/keyboard.scm	2007-06-20 00:06:24 UTC (rev 1474)
@@ -1,64 +1,29 @@
 ;; -*- scheme -*-
 (windstille-controller
- (x-axis
-  (keyboard-axis (minus "left") (plus "right"))
-  (joystick-axis (device 0)  (axis 0)))
+ (x-axis   (keyboard-axis (minus "left") (plus "right")))
+ (y-axis   (keyboard-axis (minus "up") (plus "down")))
+  
+ (x2-axis  (keyboard-axis (minus "[4]") (plus "[6]"))) 
+ (y2-axis  (keyboard-axis (minus "[2]") (plus "[8]")))
 
- (y-axis
-  (keyboard-axis (minus "up") (plus "down"))
-  (joystick-axis (device 0)  (axis 1)))
- 
- (x2-axis
-  (keyboard-axis (minus "[4]") (plus "[6]"))
-  (joystick-axis (device 0)  (axis 4)))
+ (view-center-button  (keyboard-button (key "[5]")))
 
- (y2-axis
-  (keyboard-axis (minus "[2]") (plus "[8]"))
-  (joystick-axis (device 0)  (axis 3) (invert #t)))
+ (primary-button      (keyboard-button (key "s")))
+ (secondary-button    (keyboard-button (key "d")))
+ (tertiary-button     (keyboard-button (key "a")))
 
- (view-center-button
-  (keyboard-button (key "[5]"))
-  (joystick-button (device 0)  (button 9)))
+ (pda-button          (keyboard-button (key "w")))
+ (aim-button          (keyboard-button (key "k")))
+ (pause-button        (keyboard-button (key "p")))
+ (inventory-button    (keyboard-button (key "e")))
 
- (primary-button
-  (keyboard-button (key "s"))
-  (joystick-button (device 0)  (button 0)))
-
- (secondary-button
-  (keyboard-button (key "d"))
-  (joystick-button (device 0)  (button 1)))
-
- (tertiary-button
-  (keyboard-button (key "a"))
-  (joystick-button (device 0)  (button 3)))
-
- (pda-button
-  (keyboard-button (key "w"))
-  (joystick-button (device 0)  (button 2)))
-
- (aim-button
-  (keyboard-button (key "k"))
-  (joystick-button (device 0)  (button 5)))
- 
- (pause-button
-  (keyboard-button (key "p"))
-  (joystick-button (device 0)  (button 6)))
-
- (inventory-button
-  (keyboard-button (key "e"))
-  (joystick-button (device 0)  (button 14)))
-
- (menu-up-button
-  (joystick-button (device 0)  (button 10)))
-
- (menu-down-button
-  (joystick-button (device 0)  (button 11)))
-
- (menu-left-button
-  (joystick-button (device 0)  (button 12)))
-
- (menu-right-button
-  (joystick-button (device 0)  (button 13)))
+ ;; don't bind those, since they only make sense on analog gamepads
+ ;; with an additional dpad, on digital devices x-axs and y-axis
+ ;; already serve the same purpose
+ (menu-up-button)
+ (menu-down-button)
+ (menu-left-button)
+ (menu-right-button)
  )
 
 ;; EOF ;;

Added: trunk/windstille/data/controller/xbox360.scm
===================================================================
--- trunk/windstille/data/controller/xbox360.scm	2007-06-19 22:19:35 UTC (rev 1473)
+++ trunk/windstille/data/controller/xbox360.scm	2007-06-20 00:06:24 UTC (rev 1474)
@@ -0,0 +1,30 @@
+;; -*- scheme -*-
+;; Configuration for a XBox360 pad which can be used with the xpad driver
+
+(windstille-controller
+ (x-axis  (joystick-axis (device 0)  (axis 0)))
+ (y-axis  (joystick-axis (device 0)  (axis 1)))
+ 
+ (x2-axis (joystick-axis (device 0)  (axis 4)))
+ (y2-axis (joystick-axis (device 0)  (axis 3) (invert #t)))
+
+ (view-center-button (joystick-button (device 0)  (button 9)))
+
+ (primary-button    (joystick-button (device 0)  (button 0)))
+ (secondary-button  (joystick-button (device 0)  (button 1)))
+ (tertiary-button   (joystick-button (device 0)  (button 3)))
+
+ (pda-button        (joystick-button (device 0)  (button 2)))
+
+ (aim-button        (joystick-button (device 0)  (button 5)))
+ (pause-button      (joystick-button (device 0)  (button 6)))
+ (inventory-button  (joystick-button (device 0)  (button 14)))
+
+ ;; allow to use the dpad for menu navigation
+ (menu-up-button    (joystick-button (device 0)  (button 10)))
+ (menu-down-button  (joystick-button (device 0)  (button 11)))
+ (menu-left-button  (joystick-button (device 0)  (button 12)))
+ (menu-right-button (joystick-button (device 0)  (button 13)))
+ )
+
+;; EOF ;;

Modified: trunk/windstille/src/config.cpp
===================================================================
--- trunk/windstille/src/config.cpp	2007-06-19 22:19:35 UTC (rev 1473)
+++ trunk/windstille/src/config.cpp	2007-06-20 00:06:24 UTC (rev 1474)
@@ -55,8 +55,11 @@
 
 
   add(new ConfigValue<std::string>("levelfile",       _("Levelfile to be used at startup"), false));
-  add(new ConfigValue<std::string>("controller-file", _("Controller Config file to load"), true));
 
+  // FIXME: There is no need to limit this to just two
+  add(new ConfigValue<std::string>("primary-controller-file", _("Controller Config file to load"), true));
+  add(new ConfigValue<std::string>("secondary-controller-file", _("Controller Config file to load"), true));
+
   add(new ConfigValue<std::string>("screenshot-dir",  _("Directory where Screenshots are saved"), false));
 
   add(new ConfigValue<std::string>("recorder-file",   _("File to which demos are recorded"), false));
@@ -139,6 +142,7 @@
   const int sprite3dview_flag = 258;
   const int particleview_flag = 259;
   const int sprite2dview_flag = 260;
+  const int secondary_controller_file = 261;
     
   argp.set_help_indent(24);
   argp.add_usage ("[LEVELFILE]");
@@ -160,6 +164,8 @@
 
   argp.add_group("Controlls Options:");
   argp.add_option('c', "controller", "FILE", "Use controller as defined in FILE");
+  argp.add_option(secondary_controller_file, "secondary-controller", "FILE",
+                  "Use controller as defined in FILE");
 
   argp.add_group("Misc Options:");
   argp.add_option('d', "datadir",    "DIR", "Fetch game data from DIR");
@@ -260,9 +266,13 @@
           break;  
 
         case 'c':
-          get<std::string>("controller-file") = argp.get_argument();
+          get<std::string>("primary-controller-file") = argp.get_argument();
           break;
 
+        case secondary_controller_file:
+          get<std::string>("secondary-controller-file") = argp.get_argument();
+          break;
+
         case 'v':
           std::cout << "Windstille " << WINDSTILLE_VERSION << std::endl;
           exit(EXIT_SUCCESS);
@@ -364,16 +374,23 @@
   try {
     lisp::Writer writer("config");
 
+    writer.write_comment(";; -*- scheme -*-");
+    writer.write_comment(";; Windstille Config - automatically read and written on startup/quit");
     writer.start_list("windstille-config");
 
     for(ConfigValues::iterator i = config_values.begin(); i != config_values.end(); ++i)
       {
         if (i->second->should_be_saved() && i->second->is_set())
-          i->second->write(writer);
+          {
+            writer.write_comment("  ;; " + i->second->get_docstring()); 
+            i->second->write(writer);
+            writer.write_comment("");
+          }
       }
     // TODO write controller config
     
     writer.end_list("windstille-config");
+    writer.write_comment(";; EOF ;;");
   } catch(std::exception& e) {
     std::cerr << "Couldn't write config file: " << e.what() << "\n";
   }

Modified: trunk/windstille/src/input/input_manager.cpp
===================================================================
--- trunk/windstille/src/input/input_manager.cpp	2007-06-19 22:19:35 UTC (rev 1473)
+++ trunk/windstille/src/input/input_manager.cpp	2007-06-20 00:06:24 UTC (rev 1474)
@@ -29,9 +29,6 @@
 #include <sstream>
 #include <memory>
 
-#include "lisp/parser.hpp"
-#include "lisp/lisp.hpp"
-#include "lisp/properties.hpp"
 #include "input_manager_sdl.hpp"
 #include "input_manager_impl.hpp"
 #include "input_manager.hpp"
@@ -39,21 +36,9 @@
 InputManagerImpl* InputManager::impl = 0;
 
 void
-InputManager::init(const std::string& filename)
+InputManager::init()
 {
-  std::auto_ptr<lisp::Lisp> root (lisp::Parser::parse(filename));
-  lisp::Properties rootp(root.get());
-
-  std::cout << "InputManager: " << filename << std::endl;
-
-  const lisp::Lisp* controller = 0;
-  if(rootp.get("windstille-controller", controller) == false) {
-    std::ostringstream msg;
-    msg << "'" << filename << "' is not a windstille-controller file";
-    throw std::runtime_error(msg.str());
-  }
-  
-  impl = new InputManagerSDL(controller);
+  impl = new InputManagerSDL();
 }
 
 void 
@@ -63,6 +48,12 @@
 }
 
 void
+InputManager::load(const std::string& filename)
+{
+  impl->load(filename);
+}
+
+void
 InputManager::update(float delta)
 {
   assert(impl);

Modified: trunk/windstille/src/input/input_manager.hpp
===================================================================
--- trunk/windstille/src/input/input_manager.hpp	2007-06-19 22:19:35 UTC (rev 1473)
+++ trunk/windstille/src/input/input_manager.hpp	2007-06-20 00:06:24 UTC (rev 1474)
@@ -40,11 +40,13 @@
   static InputManagerImpl* impl;
 
 public:
-  /** Init the InputManager with the data found in \a filename */
-  static void init(const std::string& filename = std::string());
-
+  /** Init the InputManager */
+  static void init();
   static void deinit();
 
+  /** Load configuration file \a filename */
+  static void load(const std::string& filename);
+
   static void update(float delta);
   static const Controller& get_controller();
   static void clear();

Modified: trunk/windstille/src/input/input_manager_impl.hpp
===================================================================
--- trunk/windstille/src/input/input_manager_impl.hpp	2007-06-19 22:19:35 UTC (rev 1473)
+++ trunk/windstille/src/input/input_manager_impl.hpp	2007-06-20 00:06:24 UTC (rev 1474)
@@ -39,6 +39,7 @@
   InputManagerImpl() {}
   virtual ~InputManagerImpl() {}
 
+  virtual void load(const std::string& filename) =0;
   virtual void update(float delta) =0;
   
   const Controller& get_controller() const;

Modified: trunk/windstille/src/input/input_manager_sdl.cpp
===================================================================
--- trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-19 22:19:35 UTC (rev 1473)
+++ trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-20 00:06:24 UTC (rev 1474)
@@ -25,6 +25,8 @@
 
 #include <iostream>
 #include <vector>
+#include "lisp/parser.hpp"
+#include "lisp/lisp.hpp"
 #include "lisp/properties.hpp"
 #include "lisp/property_iterator.hpp"
 #include "controller_def.hpp"
@@ -92,6 +94,24 @@
 }
 
 void
+InputManagerSDL::load(const std::string& filename)
+{
+  std::auto_ptr<lisp::Lisp> root (lisp::Parser::parse(filename));
+  lisp::Properties rootp(root.get());
+
+  std::cout << "InputManager: " << filename << std::endl;
+
+  const lisp::Lisp* controller = 0;
+  if(rootp.get("windstille-controller", controller) == false) {
+    std::ostringstream msg;
+    msg << "'" << filename << "' is not a windstille-controller file";
+    throw std::runtime_error(msg.str());
+  }
+  
+  parse_config(controller);
+}
+
+void
 InputManagerSDL::parse_config(const lisp::Lisp* lisp)
 {
   lisp::Properties cur(lisp);
@@ -177,7 +197,7 @@
 
 }
 
-InputManagerSDL::InputManagerSDL(const lisp::Lisp* lisp)
+InputManagerSDL::InputManagerSDL()
   : impl(new InputManagerSDLImpl)
 {
   current_ = this;
@@ -188,8 +208,6 @@
     // FIXME: Make the keynames somewhere user visible so that users can use them
     // std::cout << key_name << std::endl;
   }
-
-  parse_config(lisp);
 }
 
 InputManagerSDL::~InputManagerSDL()

Modified: trunk/windstille/src/input/input_manager_sdl.hpp
===================================================================
--- trunk/windstille/src/input/input_manager_sdl.hpp	2007-06-19 22:19:35 UTC (rev 1473)
+++ trunk/windstille/src/input/input_manager_sdl.hpp	2007-06-20 00:06:24 UTC (rev 1474)
@@ -92,9 +92,11 @@
 public:
   static InputManagerSDL* current() { return current_; }
 
-  InputManagerSDL(const lisp::Lisp* lisp);
+  InputManagerSDL();
   virtual ~InputManagerSDL();
 
+  void load(const std::string& filename);
+
   void update(float delta);
 
   void bind_joystick_hat_axis(int event, int device, int axis);

Modified: trunk/windstille/src/lisp/writer.cpp
===================================================================
--- trunk/windstille/src/lisp/writer.cpp	2007-06-19 22:19:35 UTC (rev 1473)
+++ trunk/windstille/src/lisp/writer.cpp	2007-06-20 00:06:24 UTC (rev 1474)
@@ -53,7 +53,7 @@
 void
 Writer::write_comment(const std::string& comment)
 {
-  *out << "; " << comment << "\n";
+  *out << comment << "\n";
 }
 
 void

Modified: trunk/windstille/src/windstille_main.cpp
===================================================================
--- trunk/windstille/src/windstille_main.cpp	2007-06-19 22:19:35 UTC (rev 1473)
+++ trunk/windstille/src/windstille_main.cpp	2007-06-20 00:06:24 UTC (rev 1474)
@@ -108,15 +108,18 @@
       controller_description.add_ball("mouse-motion-x", MOUSE_MOTION_X);
       controller_description.add_ball("mouse-motion-y", MOUSE_MOTION_Y);
     }
+    
+    {
+      InputManager::init();
+      
+      if (config.get<std::string>("primary-controller-file").is_set())
+        InputManager::load(config.get<std::string>("primary-controller-file").get());
+      else
+        InputManager::load("controller/keyboard.scm");
 
-      {
-        if (config.get<std::string>("controller-file").is_set())
-          InputManager::init(config.get<std::string>("controller-file").get());
-        else if (PHYSFS_exists("controller.cfg"))
-          InputManager::init("controller.cfg");
-        else
-          InputManager::init("controller/keyboard.scm");
-      }
+      if (config.get<std::string>("secondary-controller-file").is_set())
+        InputManager::load(config.get<std::string>("secondary-controller-file").get());
+    }
 
     if (debug) std::cout << "Initialising TileFactory" << std::endl;
     TileFactory::init();



From grumbel at mail.berlios.de  Wed Jun 20 02:15:37 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 20 Jun 2007 02:15:37 +0200
Subject: [Windstille-commit] r1475 - in trunk/windstille: . src
Message-ID: <200706200015.l5K0Fbol009277@sheep.berlios.de>

Author: grumbel
Date: 2007-06-20 02:15:36 +0200 (Wed, 20 Jun 2007)
New Revision: 1475

Modified:
   trunk/windstille/TODO
   trunk/windstille/src/config.cpp
Log:
- small cleanup

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-20 00:06:24 UTC (rev 1474)
+++ trunk/windstille/TODO	2007-06-20 00:15:36 UTC (rev 1475)
@@ -19,7 +19,9 @@
 ----------------
 - using a screen size != 800x600 breaks the lighting
 - using a screen size != 800x600 loads to ugly fonts, should render
-  the fonts so that we get 1:1 pixel mapping
+  the fonts so that we get 1:1 pixel mapping, can be just calculate
+  their needed size and blit with floats, or do we need magic to blit
+  with ints to avoid rounding errors?
 
 Misc:
 -----

Modified: trunk/windstille/src/config.cpp
===================================================================
--- trunk/windstille/src/config.cpp	2007-06-20 00:06:24 UTC (rev 1474)
+++ trunk/windstille/src/config.cpp	2007-06-20 00:15:36 UTC (rev 1475)
@@ -171,12 +171,12 @@
   argp.add_option('d', "datadir",    "DIR", "Fetch game data from DIR");
   argp.add_option(debug_flag, "debug",      "", "Turn on debug output");
   argp.add_option(nodebug_flag, "nodebug",      "", "Turn off debug output");
-  argp.add_option('x', "version",       "", "Print Windstille Version");
+  argp.add_option('v', "version",       "", "Print Windstille Version");
   argp.add_option('h', "help",       "", "Print this help");
 
   argp.add_group("Demo Recording/Playback Options:");
   argp.add_option('r', "record",      "FILE", "Record input events to FILE");
-  argp.add_option('v', "record-video","DIR",  "Record a gameplay video to DIR");
+  //argp.add_option('x', "record-video","DIR",  "Record a gameplay video to DIR");
   argp.add_option('p', "play",        "FILE", "Playback input events from FILE");
 
   argp.parse_args(argc, argv);
@@ -247,8 +247,9 @@
                 get<int>("screen-width")  = screen_width;
                 get<int>("screen-height") = screen_height;
               
-                std::cout << "Geometry: " << screen_width
-                          << "x" << screen_height << std::endl;
+                // FIXME: Why does this get printed twice?!
+                // Is the argument parser buggy?
+                std::cout << "Geometry: " << screen_width << "x" << screen_height << std::endl;
               }
             else
               {



From grumbel at mail.berlios.de  Wed Jun 20 06:23:15 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 20 Jun 2007 06:23:15 +0200
Subject: [Windstille-commit] r1476 - in trunk/windstille: . data/controller
	src src/navigation src/particles src/scripting test/physics
	tools/sdl-jstest
Message-ID: <200706200423.l5K4NF3h024350@sheep.berlios.de>

Author: grumbel
Date: 2007-06-20 06:23:13 +0200 (Wed, 20 Jun 2007)
New Revision: 1476

Added:
   trunk/windstille/data/controller/dvorak.scm
   trunk/windstille/src/file_reader.cpp
   trunk/windstille/src/file_reader_impl.hpp
   trunk/windstille/src/sexpr_file_reader.cpp
   trunk/windstille/src/sexpr_file_reader.hpp
   trunk/windstille/tools/sdl-jstest/README
Modified:
   trunk/windstille/NEWS
   trunk/windstille/SConstruct
   trunk/windstille/TODO
   trunk/windstille/src/SConscript
   trunk/windstille/src/config.cpp
   trunk/windstille/src/file_reader.hpp
   trunk/windstille/src/navigation/navigation_graph.cpp
   trunk/windstille/src/navigation/navigation_graph.hpp
   trunk/windstille/src/particle_viewer.cpp
   trunk/windstille/src/particles/particle_system.cpp
   trunk/windstille/src/particles/surface_drawer.cpp
   trunk/windstille/src/scripting/interface.cpp
   trunk/windstille/src/sector.cpp
   trunk/windstille/src/sector.hpp
   trunk/windstille/src/tile_factory.cpp
   trunk/windstille/src/tile_factory.hpp
   trunk/windstille/src/windstille_main.cpp
   trunk/windstille/test/physics/
Log:
- switched from lisp::Properties to FileReader (easier to read and more flexible due to not being limited to a single file type)

Modified: trunk/windstille/NEWS
===================================================================
--- trunk/windstille/NEWS	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/NEWS	2007-06-20 04:23:13 UTC (rev 1476)
@@ -6,6 +6,7 @@
  - added arc drawing
  - added navigation graph
  - added geometry test
+ - added sdl-jstest application
 
 Windstille 0.3.0
 ================

Modified: trunk/windstille/SConstruct
===================================================================
--- trunk/windstille/SConstruct	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/SConstruct	2007-06-20 04:23:13 UTC (rev 1476)
@@ -171,6 +171,7 @@
 opts.Add('LIBPATH', 'Additional library paths')
 opts.Add('LIBS', 'Additional libraries')
 opts.Add('CCFLAGS', 'C Compiler flags')
+opts.Add('CXXFLAGS', 'C++ Compiler flags')
 opts.Add('LINKFLAGS', 'Linker Compiler flags')
 opts.Add('CC', 'C Compiler')
 opts.Add('CXX', 'C++ Compiler')  
@@ -178,6 +179,9 @@
 opts.Save('options.cache', conf_env)
 Help(opts.GenerateHelpText(conf_env))
 
+# FIXME: Giving multiple CCFLAGS doesn't work since they have to be
+# broken down to a list
+
 conf = Configure(conf_env, custom_tests = { 'Check32bit' : Check32bit,
                                             'CheckYacc'  : CheckYacc,
                                             'CheckLex'   : CheckLex})

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/TODO	2007-06-20 04:23:13 UTC (rev 1476)
@@ -25,6 +25,10 @@
 
 Misc:
 -----
+
+- rewrite the file reading/writing to look more like that in Pingus
+  (i.e. no toying around with evil pointers, weirdo iter objects,
+  etc. just FileReader)
 - polish/test scripting interface
 - create doll class
 - figure out how to do background animation (coroutines, multiple VM, etc.)

Added: trunk/windstille/data/controller/dvorak.scm
===================================================================
--- trunk/windstille/data/controller/dvorak.scm	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/data/controller/dvorak.scm	2007-06-20 04:23:13 UTC (rev 1476)
@@ -0,0 +1,29 @@
+;; -*- scheme -*-
+(windstille-controller
+ (x-axis   (keyboard-axis (minus "left") (plus "right")))
+ (y-axis   (keyboard-axis (minus "up") (plus "down")))
+  
+ (x2-axis  (keyboard-axis (minus "[4]") (plus "[6]"))) 
+ (y2-axis  (keyboard-axis (minus "[2]") (plus "[8]")))
+
+ (view-center-button  (keyboard-button (key "[5]")))
+
+ (primary-button      (keyboard-button (key "o")))
+ (secondary-button    (keyboard-button (key "a")))
+ (tertiary-button     (keyboard-button (key "e")))
+
+ (pda-button          (keyboard-button (key ",")))
+ (aim-button          (keyboard-button (key "'")))
+ (pause-button        (keyboard-button (key "p")))
+ (inventory-button    (keyboard-button (key ".")))
+
+ ;; don't bind those, since they only make sense on analog gamepads
+ ;; with an additional dpad, on digital devices x-axs and y-axis
+ ;; already serve the same purpose
+ (menu-up-button)
+ (menu-down-button)
+ (menu-left-button)
+ (menu-right-button)
+ )
+
+;; EOF ;;

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/SConscript	2007-06-20 04:23:13 UTC (rev 1476)
@@ -57,6 +57,8 @@
 'elevator.cpp',
 'energy_bar.cpp',
 'entity.cpp',
+'file_reader.cpp',
+'sexpr_file_reader.cpp',
 'config.cpp',
 'game_object.cpp',
 'game_session.cpp',

Modified: trunk/windstille/src/config.cpp
===================================================================
--- trunk/windstille/src/config.cpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/config.cpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -30,10 +30,7 @@
 #include <iostream>
 #include "config.hpp"
 #include "tinygettext/gettext.hpp"
-#include "lisp/lisp.hpp"
-#include "lisp/parser.hpp"
-#include "lisp/writer.hpp"
-#include "lisp/properties.hpp"
+#include "sexpr_file_reader.hpp"
 #include "command_line.hpp"
 #include "globals.hpp"
 
@@ -57,7 +54,7 @@
   add(new ConfigValue<std::string>("levelfile",       _("Levelfile to be used at startup"), false));
 
   // FIXME: There is no need to limit this to just two
-  add(new ConfigValue<std::string>("primary-controller-file", _("Controller Config file to load"), true));
+  add(new ConfigValue<std::string>("primary-controller-file",   _("Controller Config file to load"), true));
   add(new ConfigValue<std::string>("secondary-controller-file", _("Controller Config file to load"), true));
 
   add(new ConfigValue<std::string>("screenshot-dir",  _("Directory where Screenshots are saved"), false));
@@ -316,51 +313,47 @@
 void
 Config::load()
 {
-  using namespace lisp;
-  
   try {
-    std::auto_ptr<Lisp> root(lisp::Parser::parse("config"));
-    Properties rootp(root.get());
-    
-    const Lisp* config_lisp = 0;
-    if(rootp.get("windstille-config", config_lisp) == false) {
+    SExprFileReader reader("config");
+
+    if(reader.get_name() != "windstille-config") {
       std::cerr << "Warning: Config file is not a windstille-config file.\n";
       return;
     }
     
-    Properties props(config_lisp);
-    PropertyIterator<const lisp::Lisp*> iter = props.get_iter();
+    for(ConfigValues::iterator i = config_values.begin(); i != config_values.end(); ++i)
+      { // FIXME: all this dynamic_casting is overcomplicated crap
+        if (dynamic_cast<ConfigValue<int>*>(i->second))
+          {
+            int v;
+            if (reader.get(i->first.c_str(), v))
+              set_int(i->first, v);
+          }
+        else if (dynamic_cast<ConfigValue<bool>*>(i->second))
+          {
+            bool v;
+            if (reader.get(i->first.c_str(), v))
+              set_bool(i->first, v);
+          }
+        else if (dynamic_cast<ConfigValue<float>*>(i->second))
+          {
+            float v;
+            if (reader.get(i->first.c_str(), v))
+              set_float(i->first, v);
+          }
+        else if (dynamic_cast<ConfigValue<std::string>*>(i->second))
+          {
+            std::string v;
+            if (reader.get(i->first.c_str(), v))
+              set_string(i->first, v);
+          }
+        else 
+          {
+            std::cout << "Config: Unknown type for: " << i->first << std::endl;
+          }
+      }
+    reader.print_unused_warnings("configfile");
 
-    while(iter.next()) {
-      // FIXME: this is a little hacky PropertyIterator should be a bit rewritten
-      lisp::Lisp* lisp = (*iter)->get_list_elem(1);
-      switch (lisp->get_type())
-        {
-        case Lisp::TYPE_BOOL:
-          set_bool(iter.item(), lisp->get_bool());
-          break;
-
-        case Lisp::TYPE_INT:
-          set_int(iter.item(), lisp->get_int());
-          break;
-
-        case Lisp::TYPE_FLOAT:
-          set_float(iter.item(), lisp->get_float());
-          break;
-
-        case Lisp::TYPE_STRING:
-          set_string(iter.item(), lisp->get_string());
-          break;
-
-        default:
-          std::cout << "Config: Unhandled type: ";
-          lisp->print();
-          std::cout << std::endl;
-        }
-    }
-
-    props.print_unused_warnings("configfile");
-
     // TODO read controller config
   } catch(std::exception& e) {
     std::cerr << "Couldn't open config file: " << e.what() << "\n"

Added: trunk/windstille/src/file_reader.cpp
===================================================================
--- trunk/windstille/src/file_reader.cpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/file_reader.cpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -0,0 +1,191 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include "sexpr_file_reader.hpp"
+#include "lisp/parser.hpp"
+#include "lisp/lisp.hpp"
+#include "file_reader.hpp"
+#include "file_reader_impl.hpp"
+
+FileReader::FileReader(SharedPtr<FileReaderImpl> impl_)
+  : impl(impl_)
+{
+}
+
+FileReader::FileReader()
+  : impl(0)
+{
+}
+
+std::string
+FileReader::get_name() const
+{
+  if (impl.get())
+    return impl->get_name();
+  else
+    return "";
+}
+
+bool
+FileReader::read_int(const char* name, int& value) const
+{
+  if (impl.get())
+    return impl->read_int(name, value);
+  else
+    return false;
+}
+
+bool
+FileReader::read_float (const char* name, float& value) const
+{
+  if (impl.get())
+    return impl->read_float(name, value);
+  else
+    return false;
+}
+
+bool
+FileReader::read_bool  (const char* name, bool& value) const
+{
+  if (impl.get())
+    return impl->read_bool(name, value);
+  else
+    return false;
+}
+
+bool
+FileReader::read_string(const char* name, std::string& value) const
+{
+  if (impl.get())
+    return impl->read_string(name, value);
+  else
+    return false;
+}
+
+bool
+FileReader::read_vector3(const char* name, Vector3& value) const
+{
+  if (impl.get())
+    return impl->read_vector3(name, value);
+  else
+    return false;
+}
+
+bool
+FileReader::read_color(const char* name, Color& value) const
+{
+  if (impl.get())
+    return impl->read_color(name, value);
+  else
+    return false;
+}
+
+bool
+FileReader::read_size  (const char* name, Size& value) const
+{
+  if (impl.get())
+    return impl->read_size(name, value);
+  else
+    return false;
+}
+
+bool
+FileReader::get(const char* name, std::vector<int>& value) const
+{
+  if (impl.get())
+    return impl->get(name, value);
+  else
+    return false;
+}
+
+bool
+FileReader::get(const char* name, std::vector<float>& value) const
+{
+  if (impl.get())
+    return impl->get(name, value);
+  else
+    return false;
+}
+
+bool
+FileReader::read_vector(const char* name, Vector& value) const
+{
+  if (impl.get())
+    return impl->read_vector(name, value);
+  else
+    return false;
+}
+
+bool
+FileReader::read_section(const char* name, FileReader& reader) const
+{
+  if (impl.get())
+    return impl->read_section(name, reader);
+  else
+    return false;
+}
+
+std::vector<std::string>
+FileReader::get_section_names() const
+{
+  if (impl.get())
+    return impl->get_section_names();
+  else
+    return std::vector<std::string>();
+}
+
+std::vector<FileReader>
+FileReader::get_sections() const
+{
+  if (impl.get())
+    return impl->get_sections();
+  else
+    return std::vector<FileReader>();
+}
+
+FileReader
+FileReader::read_section(const char* name)   const
+{
+  FileReader reader;
+  read_section(name, reader);
+  return reader;
+}
+
+FileReader
+FileReader::parse(const std::string& filename)
+{
+  // FIXME: memory leak, somebody must delete the lisp::Lisp
+  lisp::Lisp* sexpr = lisp::Parser::parse(filename);
+  if (sexpr)
+    {
+      return SExprFileReader(sexpr->get_list_elem(0));
+    }
+  else
+    {
+      return FileReader();
+    }
+}
+
+void
+FileReader::print_unused_warnings(const std::string& title)
+{
+  // unimplemented
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/file_reader.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/file_reader.hpp
===================================================================
--- trunk/windstille/src/file_reader.hpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/file_reader.hpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -1,36 +1,97 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
+//  $Id: file_reader.hxx,v 1.4 2003/10/18 23:17:27 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
-#ifndef HEADER_FILE_READER_HPP
-#define HEADER_FILE_READER_HPP
+#ifndef HEADER_PINGUS_FILE_READER_HXX
+#define HEADER_PINGUS_FILE_READER_HXX
 
-#include "lisp/properties.hpp"
-#include "lisp_getters.hpp"
+#include <string>
+#include <vector>
+#include "sharedptr.hpp"
 
-typedef lisp::Properties FileReader;
+class Size;
+class Color;
+class Vector;
+class Vector3;
 
+class ResDescriptor;
+class FileReaderImpl;
+
+/** Interface to read name/value pairs out of some kind of file or
+    structure */
+class FileReader
+{
+public:
+  FileReader(SharedPtr<FileReaderImpl> impl_);
+  FileReader();
+
+  /** Name of the current section, ie. in the case of
+      <groundpiece><pos>...</groundpiece> it would be 'groundpiece' */
+  std::string get_name() const;
+
+  bool read_int    (const char* name, int&)           const;
+  bool read_float  (const char* name, float&)         const;
+  bool read_bool   (const char* name, bool&)          const;
+  bool read_string (const char* name, std::string&)   const;
+  bool read_vector3(const char* name, Vector3&)      const;
+  bool read_vector (const char* name, Vector&)    const;
+  bool read_size   (const char* name, Size&)          const;
+  bool read_color  (const char* name, Color&)         const;
+  bool read_section(const char* name, FileReader&)   const;
+  FileReader read_section(const char* name)   const;
+
+  template<class E, class T>
+  bool read_enum  (const char* name, E& value, T enum2string) const
+  {
+    std::string str;
+    if (read_string(name, str))
+      {
+        value = enum2string(str);
+        return true;
+      }
+
+    return false;
+  }
+
+  bool get(const char* name, std::vector<int>&   v) const;
+  bool get(const char* name, std::vector<float>& v) const;
+
+  bool get(const char* name, FileReader& v) { return read_section(name, v); }
+  bool get(const char* name, int&   v) { return read_int(name, v); }
+  bool get(const char* name, float& v) { return read_float(name, v); }
+  bool get(const char* name, bool& v) { return read_bool(name, v); }
+  bool get(const char* name, std::string& v) { return read_string(name, v); }
+  bool get(const char* name, Vector3& v) { return read_vector3(name, v); }
+  bool get(const char* name, Vector& v) { return read_vector(name, v); }
+  bool get(const char* name, Size& v) { return read_size(name, v); }
+  bool get(const char* name, Color& v) { return read_color(name, v); } 
+
+  std::vector<std::string> get_section_names() const;
+  std::vector<FileReader>  get_sections() const;
+
+  static FileReader parse(const std::string& filename);
+
+  void print_unused_warnings(const std::string& title);
+
+private:
+  SharedPtr<FileReaderImpl> impl;
+};
+
 #endif
 
 /* EOF */

Added: trunk/windstille/src/file_reader_impl.hpp
===================================================================
--- trunk/windstille/src/file_reader_impl.hpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/file_reader_impl.hpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -0,0 +1,62 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_FILE_READER_IMPL_HXX
+#define HEADER_FILE_READER_IMPL_HXX
+
+#include <vector>
+#include <string>
+
+class Size;
+class Color;
+class Vector;
+class Vector3;
+
+class FileReader;
+class ResDescriptor;
+
+/** */
+class FileReaderImpl
+{
+public:
+  FileReaderImpl() {}
+  virtual ~FileReaderImpl() {}
+
+  virtual std::string get_name()                           const =0;
+  virtual bool read_int   (const char* name, int&)         const =0;
+  virtual bool read_float (const char* name, float&)       const =0;
+  virtual bool read_bool  (const char* name, bool&)        const =0;
+  virtual bool read_string(const char* name, std::string&) const =0;
+  virtual bool read_vector3(const char* name, Vector3&)    const =0;
+  virtual bool read_size  (const char* name, Size&)        const =0;
+  virtual bool read_vector(const char* name, Vector&)      const =0;
+  virtual bool read_color (const char* name, Color&)       const =0;
+
+  virtual bool get(const char* name, std::vector<int>&   v) const =0;
+  virtual bool get(const char* name, std::vector<float>& v) const =0;
+
+  virtual bool read_section(const char* name, FileReader&)   const =0;
+  virtual std::vector<FileReader> get_sections() const =0;
+  virtual std::vector<std::string> get_section_names() const =0;
+};
+
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/file_reader_impl.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/navigation/navigation_graph.cpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -24,6 +24,7 @@
 */
 
 #include <iostream>
+#include <iomanip>
 #include <map>
 #include <algorithm>
 #include "display/display.hpp"
@@ -242,6 +243,12 @@
 }
 
 void
+NavigationGraph::load(FileReader& reader)
+{
+  
+}
+
+void
 NavigationGraph::save(std::ostream& out)
 {
   int id = 1;
@@ -250,22 +257,24 @@
   for(Nodes::iterator i = nodes.begin(); i != nodes.end(); ++i)
     ptr2id[*i] = id++;
 
+  std::ios_base::fmtflags old_flags = out.flags();
   out << "(navigation\n";
-
   out << "  (segments\n";
   for(Segments::iterator i = segments.begin(); i != segments.end(); ++i)  
     out << "    (segment "
-        << "(node " << ptr2id[(*i)->get_node1()] << ") "
-        << "(node " << ptr2id[(*i)->get_node2()] << ") "
+        << "(node " << std::setw(3) << ptr2id[(*i)->get_node1()] << ") "
+        << "(node " << std::setw(3) << ptr2id[(*i)->get_node2()] << ") "
         << "(properties " << (*i)->get_properties() << "))\n";
   out << " )\n";
       
     out << "  (nodes\n"; 
   for(Nodes::iterator i = nodes.begin(); i != nodes.end(); ++i)
-    out << "    (node (id " << ptr2id[*i] << ") (pos " << (*i)->get_pos().x << " " << (*i)->get_pos().y << "))\n";
+    out << "    (node (id " << std::setw(3) << ptr2id[*i] << ") (pos " 
+        << std::setw(3) << (*i)->get_pos().x << " " << (*i)->get_pos().y << "))\n";
   out << " )\n";
 
   out << ")\n";
+  out.flags(old_flags);
 }
 
 bool

Modified: trunk/windstille/src/navigation/navigation_graph.hpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/navigation/navigation_graph.hpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -32,6 +32,7 @@
 #include "math/line.hpp"
 
 class Node;
+class FileReader;
 class Segment;
 class SegmentPosition;
 
@@ -113,6 +114,7 @@
   /** Draw the navigation graph, for debugging only */
   void draw();
 
+  void load(FileReader& reader);
   void save(std::ostream& out);
 
   bool valid(Segment* segment);

Modified: trunk/windstille/src/particle_viewer.cpp
===================================================================
--- trunk/windstille/src/particle_viewer.cpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/particle_viewer.cpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -25,8 +25,7 @@
 
 #include "lisp/lisp.hpp"
 #include "lisp/parser.hpp"
-#include "lisp/properties.hpp"
-#include "file_reader.hpp"
+#include "sexpr_file_reader.hpp"
 #include "input/controller.hpp"
 #include "screen_manager.hpp"
 #include "gui/gui_manager.hpp"
@@ -113,30 +112,24 @@
 ParticleViewer::load(const std::string& filename)
 {
   std::cout << "ParticleViewer: loading " << filename << std::endl;
-  using namespace lisp;
   
   for(Systems::iterator i = systems.begin(); i != systems.end(); ++i)
     delete *i;
   systems.clear();
   
-  std::auto_ptr<Lisp> root(Parser::parse(filename));
-  Properties rootp(root.get());
-
-  const Lisp* sector = 0;
-  if(!rootp.get("particle-systems", sector)) {
+  SExprFileReader root_reader(filename);
+  if(root_reader.get_name() != "particle-systems") {
     std::ostringstream msg;
     msg << "'" << filename << "' is not a particle-system file";
     throw std::runtime_error(msg.str());
   }
-  rootp.print_unused_warnings("sector");
-  
-  Properties props(sector);
-  PropertyIterator<const Lisp*> iter = props.get_iter();
-  while(iter.next()) {
-    if (iter.item() == "particle-system")
+
+  std::vector<FileReader> sections = root_reader.get_sections();
+  for(std::vector<FileReader>::iterator i = sections.begin(); i != sections.end(); ++i)
+    { 
+      if (i->get_name() == "particle-system")
       {
-        FileReader reader(*iter);
-        systems.push_back(new ParticleSystem(reader));
+        systems.push_back(new ParticleSystem(*i));
 
         guis.push_back(new ParticleSystemGUI(tab, systems.back()));
         tab->pack("Testomap", guis.back()->get_component());

Modified: trunk/windstille/src/particles/particle_system.cpp
===================================================================
--- trunk/windstille/src/particles/particle_system.cpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/particles/particle_system.cpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -134,70 +134,82 @@
   }
 
   {
-    const lisp::Lisp* drawer_lisp = 0;
-    if (props.get("drawer", drawer_lisp))
+    FileReader drawer_reader;
+    if (props.get("drawer", drawer_reader))
       {
-        lisp::Properties drawer_props(drawer_lisp);
-        lisp::PropertyIterator<const lisp::Lisp*> iter = drawer_props.get_iter();
-        while(iter.next()) {
-          if (iter.item() == "surface-drawer") 
-            {
-              lisp::Properties props(*iter);
-              set_drawer(new SurfaceDrawer(props));
-            } 
-          else if (iter.item() == "spark-drawer") 
-            {
-              lisp::Properties props(*iter);
-              set_drawer(new SparkDrawer(props));
-            } 
-          else if (iter.item() == "deform-drawer")
-            {
-              lisp::Properties props(*iter);
-              set_drawer(new DeformDrawer(props));
-            }
-          else 
-            {
-              std::cout << "Unknown drawer: " << iter.item() << std::endl;
-            }
-        }
+        std::vector<FileReader> sections = drawer_reader.get_sections();
+
+        if (sections.size() > 1)
+          std::cout << "ParticleSystem: Only one drawer allowed" << std::endl;
+        
+        if (sections.size() == 0)
+          std::cout << "ParticleSystem: You must specify a drawer" << std::endl;
+
+        if (sections.size() >= 1)
+          {
+            FileReader& reader  = sections.front();
+            if (reader.get_name() == "surface-drawer") 
+              {
+                set_drawer(new SurfaceDrawer(reader));
+              } 
+            else if (reader.get_name() == "spark-drawer") 
+              {
+                set_drawer(new SparkDrawer(reader));
+              } 
+            else if (reader.get_name() == "deform-drawer")
+              {
+                set_drawer(new DeformDrawer(reader));
+              }
+            else 
+              {
+                std::cout << "Unknown drawer: " << reader.get_name() << std::endl;
+              }
+          }
       }
   }
 
   {
-    const lisp::Lisp* distribution_lisp = 0;
-    if (props.get("distribution", distribution_lisp))
+    FileReader distribution_reader;
+    if (props.get("distribution", distribution_reader))
       {
-        lisp::Properties distribution_props(distribution_lisp);
-        lisp::PropertyIterator<const lisp::Lisp*> iter = distribution_props.get_iter();
-        if (iter.next()) {
-          lisp::Properties prop(*iter);
+        std::vector<FileReader> sections = distribution_reader.get_sections();
 
-          if (iter.item() == "point-distribution") {
-            set_point_distribution();
-          } else if (iter.item() == "line-distribution") {
-            float x1, y1, x2, y2;
-            prop.get("x1", x1);
-            prop.get("y1", y1);
-            prop.get("x2", x2);
-            prop.get("y2", y2);
+        if (sections.size() > 1)
+          std::cout << "ParticleSystem: Only one distribution allowed" << std::endl;
+        
+        if (sections.size() == 0)
+          std::cout << "ParticleSystem: You must specify a distribution" << std::endl;
+
+        if (sections.size() >= 1)
+          {
+            FileReader& reader  = sections.front();
+
+            if (reader.get_name() == "point-distribution") {
+              set_point_distribution();
+            } else if (reader.get_name() == "line-distribution") {
+              float x1, y1, x2, y2;
+              reader.get("x1", x1);
+              reader.get("y1", y1);
+              reader.get("x2", x2);
+              reader.get("y2", y2);
           
-            set_line_distribution(x1, y1, x2, y2);
-          } else if (iter.item() == "rect-distribution") {
-            Rectf rect;
-            prop.get("x1", rect.left);
-            prop.get("y1", rect.top);
-            prop.get("x2", rect.right);
-            prop.get("y2", rect.bottom);
+              set_line_distribution(x1, y1, x2, y2);
+            } else if (reader.get_name() == "rect-distribution") {
+              Rectf rect;
+              reader.get("x1", rect.left);
+              reader.get("y1", rect.top);
+              reader.get("x2", rect.right);
+              reader.get("y2", rect.bottom);
           
-            set_rect_distribution(rect);
+              set_rect_distribution(rect);
 
-          } else {
-            std::cout << "Unknown distribution: " << iter.item() << std::endl;
+            } else {
+              std::cout << "Unknown distribution: " << reader.get_name() << std::endl;
+            }
           }
-        }
       }
   }
-
+  
   int p_count = 70;
   props.get("count", p_count);
   set_count(p_count);

Modified: trunk/windstille/src/particles/surface_drawer.cpp
===================================================================
--- trunk/windstille/src/particles/surface_drawer.cpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/particles/surface_drawer.cpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -31,7 +31,7 @@
 #include "surface_drawer.hpp"
 
 SurfaceDrawer::SurfaceDrawer(Surface surface_)
-  :surface(surface_)
+  : surface(surface_)
 {
   
 }

Modified: trunk/windstille/src/scripting/interface.cpp
===================================================================
--- trunk/windstille/src/scripting/interface.cpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/scripting/interface.cpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -37,6 +37,7 @@
 #include "camera.hpp"
 #include "config.hpp"
 #include "pda.hpp"
+#include "sexpr_file_reader.hpp"
 #include "display/display.hpp"
 #include "controller_help_window.hpp"
 
@@ -327,9 +328,10 @@
   std::vector<lisp::Lisp*> entries;
   entries.push_back(new Lisp(Lisp::TYPE_SYMBOL, objname));
   table_to_lisp(v, 3, entries);
-  std::auto_ptr<Lisp> lisp (new Lisp(entries));
+
   try {
-    Sector::current()->add_object(objname, lisp.get());
+    SExprFileReader reader(new Lisp(entries), true);
+    Sector::current()->add_object(reader);
   } catch(std::exception& e) {
     std::cerr << "Error parsing object in spawn_object: " << e.what()
       << "\n";

Modified: trunk/windstille/src/sector.cpp
===================================================================
--- trunk/windstille/src/sector.cpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/sector.cpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -23,6 +23,7 @@
 #include "lisp/properties.hpp"
 #include "lisp/parser.hpp"
 #include "lisp_getters.hpp"
+#include "sexpr_file_reader.hpp"
 #include "globals.hpp"
 #include "display/scene_context.hpp"
 #include "objects/background_gradient.hpp"
@@ -107,92 +108,84 @@
   if (debug) std::cout << "Sector:parse_file '" << filename << "'" << std::endl;
   using namespace lisp;
   
-  std::auto_ptr<Lisp> root(Parser::parse(filename));
-  Properties rootp(root.get());
-
-  const Lisp* sector = 0;
-  if(!rootp.get("windstille-sector", sector)) {
+  SExprFileReader reader(filename);
+  if(reader.get_name() != "windstille-sector") {
     std::ostringstream msg;
     msg << "'" << filename << "' is not a windstille-sector file";
     throw std::runtime_error(msg.str());
   }
-  rootp.print_unused_warnings("sector");
   
-  Properties props(sector);
-
   int version = 1;
-  if(!props.get("version", version))
+  if(!reader.get("version", version))
     std::cerr << "Warning no version specified in levelformat.\n";
   if(version > 1)
     std::cerr << "Warning: format version is newer than game.\n";
 
-  props.get("name", name);
-  props.get("music", music);
-  props.get("init-script", init_script);
-  props.get("ambient-color", ambient_light);
+  reader.get("name",          name);
+  reader.get("music",         music);
+  reader.get("init-script",   init_script);
+  reader.get("ambient-color", ambient_light);
   
-  PropertyIterator<const Lisp*> iter;
-  const Lisp* objects = 0;
-  if(props.get("objects", objects) == false)
+  FileReader objects_reader;
+  if(reader.get("objects", objects_reader) == false)
     throw std::runtime_error("No objects specified");
-  Properties pobjects(objects);
-  iter = pobjects.get_iter();
-  while(iter.next()) {
-    add_object(iter.item(), *iter);
-  }
 
-  props.print_unused_warnings("sector");
+  std::vector<FileReader> objects_readers = objects_reader.get_sections();
+  for(std::vector<FileReader>::iterator i = objects_readers.begin(); i != objects_readers.end(); ++i)
+    {
+      add_object(*i);
+    }
+
+  reader.print_unused_warnings("sector");
   if (debug) std::cout << "Finished parsing" << std::endl;
 }
 
 void
-Sector::add_object(const std::string& name, const lisp::Lisp* lisp)
+Sector::add_object(FileReader& reader)
 {
-  lisp::Properties props(lisp);
-
-  if(name == "tilemap") {
-    TileMap* tilemap = new TileMap(props);
+  if(reader.get_name() == "tilemap") {
+    TileMap* tilemap = new TileMap(reader);
     add(tilemap);
     if (tilemap->get_name() == "interactive")
       interactive_tilemap = tilemap;
     else if (tilemap->get_name() == "interactivebackground")
       interactivebackground_tilemap = tilemap;
-  } else if(name == "background") {
+  } else if(reader.get_name() == "background") {
     // TODO
-  } else if (name == "background-gradient") {
-    add(new BackgroundGradient(props));
-  } else if(name == "trigger") {
-    add(new Trigger(props));
-  } else if(name == "box") {
-    add(new Box(props));
-  } else if(name == "shockwave") {
-    add(new Shockwave(props));
-  } else if(name == "elevator") {
-    add(new Elevator(props));
-  } else if(name == "character") {    
-    add(new Character(props));
-  } else if(name == "spider-mine") {
-    add(new SpiderMine(props));
-  } else if(name == "hedgehog") {
-    add(new Hedgehog(props));
-  } else if(name == "test-object") {
-    add(new TestObject(props));
-  } else if (name == "nightvision") {
-    add(new Nightvision(props));
-  } else if (name == "particle-system") {
-    add(new ParticleSystem(props));
-  } else if(name == "scriptable-object") {    
-    add(new ScriptableObject(props));
-  } else if (name == "vrdummy") {
-    add(new VRDummy(props));
-  } else if (name == "swarm") {
-    add(new Swarm(props));
-  } else if (name == "laserpointer") {
+  } else if (reader.get_name() == "background-gradient") {
+    add(new BackgroundGradient(reader));
+  } else if(reader.get_name() == "trigger") {
+    add(new Trigger(reader));
+  } else if(reader.get_name() == "box") {
+    add(new Box(reader));
+  } else if(reader.get_name() == "shockwave") {
+    add(new Shockwave(reader));
+  } else if(reader.get_name() == "elevator") {
+    add(new Elevator(reader));
+  } else if(reader.get_name() == "character") {    
+    add(new Character(reader));
+  } else if(reader.get_name() == "spider-mine") {
+    add(new SpiderMine(reader));
+  } else if(reader.get_name() == "hedgehog") {
+    add(new Hedgehog(reader));
+  } else if(reader.get_name() == "test-object") {
+    add(new TestObject(reader));
+  } else if (reader.get_name() == "nightvision") {
+    add(new Nightvision(reader));
+  } else if (reader.get_name() == "particle-system") {
+    add(new ParticleSystem(reader));
+  } else if(reader.get_name() == "scriptable-object") {    
+    add(new ScriptableObject(reader));
+  } else if (reader.get_name() == "vrdummy") {
+    add(new VRDummy(reader));
+  } else if (reader.get_name() == "swarm") {
+    add(new Swarm(reader));
+  } else if (reader.get_name() == "laserpointer") {
     add(new LaserPointer());
-  } else if (name == "liquid") {
-    add(new Liquid(props));
+  } else if (reader.get_name() == "liquid") {
+    add(new Liquid(reader));
   } else {
-    std::cout << "Skipping unknown Object: " << name << "\n";
+    std::cout << "Skipping unknown Object: " << reader.get_name() << "\n";
   }
 }
 

Modified: trunk/windstille/src/sector.hpp
===================================================================
--- trunk/windstille/src/sector.hpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/sector.hpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -22,9 +22,9 @@
 
 #include <string>
 #include <vector>
-#include "lisp/lisp.hpp"
 #include "color.hpp"
 
+class FileReader;
 class GameObject;
 class TileMap;
 class Player;
@@ -98,7 +98,7 @@
   Color get_ambient_light() const;
 
   void add(GameObject*);
-  void add_object(const std::string& name, const lisp::Lisp* lisp);
+  void add_object(FileReader& reader);
 
   CollisionEngine* get_collision_engine() const { return collision_engine; }
 

Added: trunk/windstille/src/sexpr_file_reader.cpp
===================================================================
--- trunk/windstille/src/sexpr_file_reader.cpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/sexpr_file_reader.cpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -0,0 +1,312 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include <assert.h>
+#include "lisp/parser.hpp"
+#include "lisp/getters.hpp"
+#include "color.hpp"
+#include "math/size.hpp"
+#include "math/vector.hpp"
+#include "math/vector3.hpp"
+#include "file_reader_impl.hpp"
+#include "sexpr_file_reader.hpp"
+
+class SExprFileReaderImpl: public FileReaderImpl
+{
+public:
+  bool delete_sexpr;
+  const lisp::Lisp* sexpr;
+
+  SExprFileReaderImpl(const lisp::Lisp* sexpr_, bool delete_sexpr_) 
+    : sexpr(sexpr_), 
+      delete_sexpr(delete_sexpr_)
+  {
+    assert(sexpr && 
+           sexpr->get_type() == lisp::Lisp::TYPE_LIST &&
+           sexpr->get_list_size() >= 1);
+    
+    // FIXME: I don't think this is good for anything
+    // for(size_t i = 1; i < sexpr->get_list_size(); ++i)
+    // { // iterate over subsections
+    //  sexpr->get_list_elem(i);
+    // }
+  }
+
+  ~SExprFileReaderImpl()
+  {
+    if (delete_sexpr)
+      {
+        delete sexpr;
+      }
+  }
+
+  std::string get_name() const 
+  {
+    return sexpr->get_list_elem(0)->get_symbol();
+  }
+
+  bool read_int(const char* name, int& v) const 
+  {
+    lisp::Lisp* item = get_subsection_item(name);
+    if (item && item->get_type() == lisp::Lisp::TYPE_INT)
+      {
+        v = item->get_int();
+        return true;
+      }
+    return false;
+  }
+
+  bool read_float(const char* name, float& v) const 
+  {
+    lisp::Lisp* item = get_subsection_item(name);
+    if (item)
+      {
+        if (item->get_type() == lisp::Lisp::TYPE_FLOAT)
+          {
+            v = item->get_float();
+            return true;
+          }
+        else if (item->get_type() == lisp::Lisp::TYPE_INT)
+          {
+            v = item->get_int();
+            return true;
+          }
+        else
+          {
+            return false;
+          }
+      }
+    return false;
+  }
+
+  bool read_bool  (const char* name, bool& v) const 
+  {
+    lisp::Lisp* item = get_subsection_item(name);
+    if (item && item->get_type() == lisp::Lisp::TYPE_BOOL)
+      {
+        v = item->get_bool();
+        return true;
+      }
+    return false;
+  }
+
+  bool read_string(const char* name, std::string& v) const 
+  {
+    lisp::Lisp* sub = get_subsection(name);
+    if (sub)
+      {
+        v = "";
+        for(size_t i = 1; i < sub->get_list_size(); ++i)
+          {
+            lisp::Lisp* item = sub->get_list_elem(i);
+            if (item->get_type() == lisp::Lisp::TYPE_STRING)
+              {
+                v += item->get_string();
+              }
+            else if (item->get_type() == lisp::Lisp::TYPE_SYMBOL)
+              {
+                v += item->get_symbol();
+              }
+          }
+        return true;
+      }
+    return false;
+  }
+
+  bool read_vector3(const char* name, Vector3& v) const
+  {
+    lisp::Lisp* sub = get_subsection(name);
+    if (sub && sub->get_list_size() == 4)
+      {
+        lisp::get(sub->get_list_elem(1), v.x);
+        lisp::get(sub->get_list_elem(2), v.y);
+        lisp::get(sub->get_list_elem(3), v.z);
+        return true;
+      }    
+    return false;
+  }
+
+  bool read_size(const char* name, Size& v) const
+  {
+    lisp::Lisp* sub = get_subsection(name);
+    if (sub && sub->get_list_size() == 3)
+      {
+        v.width  = sub->get_list_elem(1)->get_int();
+        v.height = sub->get_list_elem(2)->get_int();
+        return true;
+      }    
+    return false;
+  }
+
+  bool read_vector(const char* name, Vector& v) const
+  {
+    lisp::Lisp* sub = get_subsection(name);
+    if (sub && sub->get_list_size() == 3)
+      {
+        lisp::get(sub->get_list_elem(1), v.x);
+        lisp::get(sub->get_list_elem(2), v.y);
+        return true;
+      }    
+    return false;
+  }
+
+  bool read_color (const char* name, Color& v) const
+  {
+    lisp::Lisp* sub = get_subsection(name);
+    if (sub)
+      {
+        if (sub->get_list_size() == 5)
+          {
+            lisp::get(sub->get_list_elem(1), v.r);
+            lisp::get(sub->get_list_elem(2), v.g);
+            lisp::get(sub->get_list_elem(3), v.b);
+            lisp::get(sub->get_list_elem(4), v.a);
+            return true;
+          }
+        else if (sub->get_list_size() == 4)
+          {
+            lisp::get(sub->get_list_elem(1), v.r);
+            lisp::get(sub->get_list_elem(2), v.g);
+            lisp::get(sub->get_list_elem(3), v.b);
+            v.a = 1.0f;
+            return true;
+          }
+        else
+          {
+            return false;
+          }
+      }
+    return false;
+  }
+
+  bool get(const char* name, std::vector<int>&   v) const
+  {
+    lisp::Lisp* sub = get_subsection(name);
+    if (sub)
+      return property_get(sub, v);
+    else 
+      return false;
+  }
+
+  bool get(const char* name, std::vector<float>& v) const
+  {
+    lisp::Lisp* sub = get_subsection(name);
+    if (sub)
+      return property_get(sub, v);
+    else 
+      return false;
+  }
+
+  bool read_section(const char* name, FileReader& v) const 
+  {
+    lisp::Lisp* cur = get_subsection(name);
+    if (cur)
+      {
+        v = SExprFileReader(cur);
+        return true;
+      }
+    return false;
+  }
+
+  std::vector<FileReader> get_sections() const 
+  {
+    std::vector<FileReader> lst;
+    for(size_t i = 1; i < sexpr->get_list_size(); ++i)
+      { // iterate over subsections
+        lst.push_back(SExprFileReader(sexpr->get_list_elem(i)));
+      }
+    return lst;
+  }
+
+  std::vector<std::string> get_section_names() const 
+  {
+    std::vector<std::string> lst;
+
+    for(size_t i = 1; i < sexpr->get_list_size(); ++i)
+      { // iterate over subsections
+        lisp::Lisp* sub = sexpr->get_list_elem(i);
+        lst.push_back(sub->get_list_elem(0)->get_symbol());
+      }
+
+    return lst;
+  }
+
+private:
+  lisp::Lisp* get_subsection_item(const char* name) const
+  {
+    lisp::Lisp* sub = get_subsection(name);
+    if (sub && sub->get_list_size() == 2)
+      {
+        return sub->get_list_elem(1);
+      }
+    return 0;
+  }
+
+  lisp::Lisp* get_subsection(const char* name) const
+  {
+    for(size_t i = 1; i < sexpr->get_list_size(); ++i)
+      { // iterate over subsections
+        lisp::Lisp* sub = sexpr->get_list_elem(i);
+        if (strcmp(sub->get_list_elem(0)->get_symbol(), name) == 0)
+          return sub;
+      }
+    return 0;
+  } 
+
+};
+
+SExprFileReader::SExprFileReader(const lisp::Lisp* sexpr, bool delete_sexpr)
+  : FileReader(SharedPtr<FileReaderImpl>(new SExprFileReaderImpl(sexpr, delete_sexpr)))
+{
+}
+
+static lisp::Lisp* read_lisp_file(const std::string& filename)
+{
+  lisp::Lisp* sexpr = lisp::Parser::parse(filename);
+  if (!sexpr)
+    {
+      std::ostringstream msg;
+      msg << "'" << filename << "': file not found";
+      throw std::runtime_error(msg.str());
+    }
+  else if (sexpr && sexpr->get_type() == lisp::Lisp::TYPE_LIST && sexpr->get_list_size() >= 1)
+    {
+      return sexpr->get_list_elem(0);
+    }
+  else
+    {
+      std::ostringstream msg;
+      msg << "'" << filename << "': not a valid sexpr file";
+      throw std::runtime_error(msg.str());
+    }
+}
+
+SExprFileReader::SExprFileReader(const std::string& filename)
+  : FileReader(SharedPtr<FileReaderImpl>(new SExprFileReaderImpl(read_lisp_file(filename),
+                                                                 true)))
+{
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/sexpr_file_reader.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/sexpr_file_reader.hpp
===================================================================
--- trunk/windstille/src/sexpr_file_reader.hpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/sexpr_file_reader.hpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -0,0 +1,43 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_SEXPR_FILE_READER_HPP
+#define HEADER_SEXPR_FILE_READER_HPP
+
+#include "file_reader.hpp"
+#include "lisp/lisp.hpp"
+
+/** */
+class SExprFileReader : public FileReader
+{
+private:
+public:
+  SExprFileReader(const lisp::Lisp* lisp, bool delete_sexpr = false);
+  SExprFileReader(const std::string& filename);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/sexpr_file_reader.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/tile_factory.cpp
===================================================================
--- trunk/windstille/src/tile_factory.cpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/tile_factory.cpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -30,9 +30,7 @@
 #include "tile_packer.hpp"
 #include "tile_factory.hpp"
 #include "tile_description.hpp"
-#include "lisp/lisp.hpp"
-#include "lisp/parser.hpp"
-#include "lisp/properties.hpp"
+#include "sexpr_file_reader.hpp"
 #include "display/surface_manager.hpp"
 #include "display/texture.hpp"
 #include "physfs/physfs_sdl.hpp"
@@ -64,29 +62,28 @@
 
 TileFactory::TileFactory (const std::string& filename)
 {
-  using namespace lisp;
-
   packers.push_back(new TilePacker(1024, 1024));
   packers.push_back(new TilePacker(1024, 1024));
   color_packer     = 0;
 
-  std::auto_ptr<Lisp> root (Parser::parse(filename));
-  Properties rootp(root.get());
+  SExprFileReader reader(filename);
+  if(reader.get_name() != "windstille-tiles")
+    {
+      std::ostringstream msg;
+      msg << "'" << filename << "' is not a windstille tiles file";
+      throw std::runtime_error(msg.str());
+    }
   
-  const lisp::Lisp* tiles_lisp = 0;
-  if(rootp.get("windstille-tiles", tiles_lisp) == false) {
-    std::ostringstream msg;
-    msg << "'" << filename << "' is not a windstille tiles file";
-    throw std::runtime_error(msg.str());
-  }
-  
-  Properties props(tiles_lisp);
-  PropertyIterator<const lisp::Lisp*> iter;
-  props.get_iter("tiles", iter);
-  while(iter.next()) {
-    parse_tiles(*iter);
-  }
-  props.print_unused_warnings("windstille-tiles");
+  std::vector<FileReader> sections = reader.get_sections();
+  for(std::vector<FileReader>::iterator i = sections.begin(); i != sections.end(); ++i)
+    {
+      if (i->get_name() == "tiles") {
+        parse_tiles(*i);
+      } else if (i->get_name() == "tilegroup") {
+        // ignore
+      }
+    }
+  reader.print_unused_warnings("TileFactory");
 }
 
 TileFactory::~TileFactory()
@@ -104,14 +101,10 @@
 }
 
 void
-TileFactory::parse_tiles(const lisp::Lisp* data)
+TileFactory::parse_tiles(FileReader& reader)
 {
-  using namespace lisp;
-  assert(data);
+  descriptions.push_back(new TileDescription(reader));
 
-  lisp::Properties props(data);
-
-  descriptions.push_back(new TileDescription(props));
   TileDescription& desc = *descriptions.back();
   
   if (0)

Modified: trunk/windstille/src/tile_factory.hpp
===================================================================
--- trunk/windstille/src/tile_factory.hpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/tile_factory.hpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -77,7 +77,7 @@
   static TileFactory* current() { return current_; }
 
 private:
-  void parse_tiles(const lisp::Lisp* data);
+  void parse_tiles(FileReader& reader);
 };
 
 #endif

Modified: trunk/windstille/src/windstille_main.cpp
===================================================================
--- trunk/windstille/src/windstille_main.cpp	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/src/windstille_main.cpp	2007-06-20 04:23:13 UTC (rev 1476)
@@ -134,7 +134,6 @@
         std::string leveldir = dirname(config.get_string("levelfile"));
         PHYSFS_addToSearchPath(leveldir.c_str(), true);
         levelfile = basename(config.get_string("levelfile"));
-        std::cout << "XXX: " << leveldir << std::endl;
       }
 
     if (sprite3dview)


Property changes on: trunk/windstille/test/physics
___________________________________________________________________
Name: svn:ignore
   - 
main
.sconsign

   + 
main
.sconsign
.sconsign.dblite


Added: trunk/windstille/tools/sdl-jstest/README
===================================================================
--- trunk/windstille/tools/sdl-jstest/README	2007-06-20 00:15:36 UTC (rev 1475)
+++ trunk/windstille/tools/sdl-jstest/README	2007-06-20 04:23:13 UTC (rev 1476)
@@ -0,0 +1,10 @@
+sdl-jstest
+==========
+
+sdl-jstest is a simple program that lets you find out how many
+joysticks SDL detected on your system, how many axes, buttons, hats
+and balls they have each. It also lets you test the joysticks by
+displaying the events they send or by displaying their current button,
+axis, hat or ball state.
+
+# EOF #



From grumbel at mail.berlios.de  Wed Jun 20 07:08:26 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 20 Jun 2007 07:08:26 +0200
Subject: [Windstille-commit] r1477 - in trunk/windstille: . data src
	src/navigation
Message-ID: <200706200508.l5K58Q6Q015667@sheep.berlios.de>

Author: grumbel
Date: 2007-06-20 07:08:24 +0200 (Wed, 20 Jun 2007)
New Revision: 1477

Added:
   trunk/windstille/data/navigation.nav
Modified:
   trunk/windstille/TODO
   trunk/windstille/src/navigation/navigation_graph.cpp
   trunk/windstille/src/navigation/node.hpp
   trunk/windstille/src/navigation_test.cpp
Log:
- added loading of navigation graph

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-20 04:23:13 UTC (rev 1476)
+++ trunk/windstille/TODO	2007-06-20 05:08:24 UTC (rev 1477)
@@ -43,5 +43,9 @@
 - print and println behave different on console
 - calling functions as character scripts instead of files doesn't work
 - change the game to a righthand coordinate system
+- rewrite Config class and properly seperate config from command line
+  and config done via option menu, i.e. command line settings
+  shouldn't be persistent unless told so
+- add line numbers to error messages from lisp
 
 # EOF #

Added: trunk/windstille/data/navigation.nav
===================================================================
--- trunk/windstille/data/navigation.nav	2007-06-20 04:23:13 UTC (rev 1476)
+++ trunk/windstille/data/navigation.nav	2007-06-20 05:08:24 UTC (rev 1477)
@@ -0,0 +1,39 @@
+(navigation
+  (nodes
+    (node (id   1) (pos 100 200))
+    (node (id   2) (pos 300 400))
+    (node (id   3) (pos 444.861 410.437))
+    (node (id   4) (pos 534.858 436.132))
+    (node (id   5) (pos 615.372 436.622))
+    (node (id   6) (pos 681.084 263.793))
+    (node (id   7) (pos 597.783 288.682))
+    (node (id   8) (pos 491.216 288.682))
+    (node (id   9) (pos 421.02 285.146))
+    (node (id  10) (pos 332.645 268.294))
+    (node (id  11) (pos 362.944 159.5))
+    (node (id  12) (pos 436.191 163.735))
+    (node (id  13) (pos 513.665 163.235))
+    (node (id  14) (pos 594.374 162.168))
+    (node (id  15) (pos 132.505 83.9459))
+    (node (id  16) (pos 193.368 83.9459))
+    (node (id  17) (pos 161.409 177.94))
+    (node (id  18) (pos 283.341 177.94))
+ )
+
+  (segments
+    (segment (node1   1) (node2   2) (properties 0))
+    (segment (node1   2) (node2   3) (properties 0))
+    (segment (node1   3) (node2   4) (properties 0))
+    (segment (node1   4) (node2   5) (properties 0))
+    (segment (node1   5) (node2   6) (properties 0))
+    (segment (node1  10) (node2   9) (properties 0))
+    (segment (node1   9) (node2   8) (properties 0))
+    (segment (node1   8) (node2   7) (properties 0))
+    (segment (node1  11) (node2  12) (properties 0))
+    (segment (node1  12) (node2  13) (properties 0))
+    (segment (node1  13) (node2  14) (properties 0))
+    (segment (node1  15) (node2  16) (properties 0))
+    (segment (node1  17) (node2  18) (properties 0))
+ )
+)
+

Modified: trunk/windstille/src/navigation/navigation_graph.cpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-20 04:23:13 UTC (rev 1476)
+++ trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-20 05:08:24 UTC (rev 1477)
@@ -30,6 +30,7 @@
 #include "display/display.hpp"
 #include "node.hpp"
 #include "segment.hpp"
+#include "file_reader.hpp"
 #include "segment_position.hpp"
 #include "navigation_graph.hpp"
 
@@ -245,7 +246,77 @@
 void
 NavigationGraph::load(FileReader& reader)
 {
+  int id_count = 1;
+  std::map<int, Node*> id2ptr;
+
+  FileReader nodes_group_reader;
+  if (reader.read_section("nodes", nodes_group_reader))
+    {
+      std::vector<FileReader> nodes_reader = nodes_group_reader.get_sections();
+      for(std::vector<FileReader>::iterator i = nodes_reader.begin(); i != nodes_reader.end(); ++i)
+        {
+          if (i->get_name() == "node")
+            {
+              Vector pos;
+              if (i->get("pos", pos))
+                {
+                  Node* node = new Node(pos);
+                  id2ptr[id_count++] = node;
+                  nodes.push_back(node);
+                }
+              else
+                {
+                  std::cout << "NavigationGraph:load: nodes: node: Couldn't read pos attribute" << std::endl;
+                }
+            }
+          else
+            {
+              std::cout << "NavigationGraph:load: nodes: Unknown tag: " << i->get_name() << std::endl;
+            }
+        }
+    }
   
+  FileReader segments_group_reader;
+  if (reader.read_section("segments", segments_group_reader))
+    {
+      std::vector<FileReader> segments_reader = segments_group_reader.get_sections();
+      for(std::vector<FileReader>::iterator i = segments_reader.begin(); i != segments_reader.end(); ++i)
+        {
+          if (i->get_name() == "segment")
+            {
+              int node_left;
+              int node_right;
+              int properties;
+
+              if (i->get("node1", node_left) &&
+                  i->get("node2", node_right) &&
+                  i->get("properties", properties)) // FIXME: we might want to read a unsigned int instead
+                {
+                  std::map<int, Node*>::iterator node_left_ptr  = id2ptr.find(node_left);
+                  std::map<int, Node*>::iterator node_right_ptr = id2ptr.find(node_right);
+
+                  if (node_left_ptr != id2ptr.end() && node_right_ptr != id2ptr.end())
+                    {
+                      Segment* segment = new Segment(node_left_ptr->second, node_right_ptr->second, properties);
+                      segments.push_back(segment);
+                    }
+                  else
+                    {
+                      std::cout << "NavigationGraph: segment: Couldn't lookup ids: "
+                                << node_left << " " << node_right << std::endl;
+                    }
+                }
+              else
+                {
+                  std::cout << "NavigationGraph:load: segments: segment: parse error" << std::endl;
+                }
+            }
+          else
+            {
+              std::cout << "NavigationGraph:load: segments: Unknown tag: " << i->get_name() << std::endl;
+            }
+        }      
+    }
 }
 
 void
@@ -257,24 +328,26 @@
   for(Nodes::iterator i = nodes.begin(); i != nodes.end(); ++i)
     ptr2id[*i] = id++;
 
-  std::ios_base::fmtflags old_flags = out.flags();
+  std::ios_base::fmtflags old_flags = out.flags(); // save flags
+
   out << "(navigation\n";
+  out << "  (nodes\n"; 
+  for(Nodes::iterator i = nodes.begin(); i != nodes.end(); ++i)
+    out << "    (node (id " << std::setw(3) << ptr2id[*i] << ") (pos " 
+        << std::setw(3) << (*i)->get_pos().x << " " << (*i)->get_pos().y << "))\n";
+  out << " )\n";
+
   out << "  (segments\n";
   for(Segments::iterator i = segments.begin(); i != segments.end(); ++i)  
     out << "    (segment "
-        << "(node " << std::setw(3) << ptr2id[(*i)->get_node1()] << ") "
-        << "(node " << std::setw(3) << ptr2id[(*i)->get_node2()] << ") "
+        << "(node1 " << std::setw(3) << ptr2id[(*i)->get_node1()] << ") "
+        << "(node2 " << std::setw(3) << ptr2id[(*i)->get_node2()] << ") "
         << "(properties " << (*i)->get_properties() << "))\n";
   out << " )\n";
       
-    out << "  (nodes\n"; 
-  for(Nodes::iterator i = nodes.begin(); i != nodes.end(); ++i)
-    out << "    (node (id " << std::setw(3) << ptr2id[*i] << ") (pos " 
-        << std::setw(3) << (*i)->get_pos().x << " " << (*i)->get_pos().y << "))\n";
-  out << " )\n";
+  out << ")\n";
 
-  out << ")\n";
-  out.flags(old_flags);
+  out.flags(old_flags); // restore flags
 }
 
 bool

Modified: trunk/windstille/src/navigation/node.hpp
===================================================================
--- trunk/windstille/src/navigation/node.hpp	2007-06-20 04:23:13 UTC (rev 1476)
+++ trunk/windstille/src/navigation/node.hpp	2007-06-20 05:08:24 UTC (rev 1477)
@@ -35,7 +35,6 @@
 class Node
 {
 private:
-  int    id;
   Vector pos;
   
 public:

Modified: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-20 04:23:13 UTC (rev 1476)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-20 05:08:24 UTC (rev 1477)
@@ -27,6 +27,7 @@
 #include <iostream>
 #include <GL/glew.h>
 #include <GL/gl.h>
+#include "sexpr_file_reader.hpp"
 #include "input/controller.hpp"
 #include "display/display.hpp"
 #include "screen_manager.hpp"
@@ -47,6 +48,13 @@
 {
   graph = new NavigationGraph();
 
+  try {
+    SExprFileReader reader("navigation.nav");
+    graph->load(reader);
+  } catch(std::exception& err) {
+    std::cout << "NavigationTest: " << err.what() << std::endl;
+  }
+
   NodeHandle node1 = graph->add_node(Vector(100, 200));
   NodeHandle node2 = graph->add_node(Vector(300, 400));
   //Node* node3 = graph->add_node(Vector(500, 300));



From grumbel at mail.berlios.de  Wed Jun 20 10:44:44 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 20 Jun 2007 10:44:44 +0200
Subject: [Windstille-commit] r1478 - in trunk/windstille: . src src/gui
	src/input src/objects src/particles src/scripting src/sprite2d
Message-ID: <200706200844.l5K8iiwO019917@sheep.berlios.de>

Author: grumbel
Date: 2007-06-20 10:44:42 +0200 (Wed, 20 Jun 2007)
New Revision: 1478

Removed:
   trunk/windstille/src/lisp_getters.cpp
   trunk/windstille/src/lisp_getters.hpp
Modified:
   trunk/windstille/TODO
   trunk/windstille/src/SConscript
   trunk/windstille/src/box.cpp
   trunk/windstille/src/box.hpp
   trunk/windstille/src/character.cpp
   trunk/windstille/src/character.hpp
   trunk/windstille/src/config.cpp
   trunk/windstille/src/elevator.cpp
   trunk/windstille/src/elevator.hpp
   trunk/windstille/src/file_reader.cpp
   trunk/windstille/src/file_reader.hpp
   trunk/windstille/src/file_reader_impl.hpp
   trunk/windstille/src/gui/automap.cpp
   trunk/windstille/src/gui/automap.hpp
   trunk/windstille/src/gui/button.cpp
   trunk/windstille/src/gui/button.hpp
   trunk/windstille/src/gui/component.hpp
   trunk/windstille/src/gui/component_factory.cpp
   trunk/windstille/src/gui/component_factory.hpp
   trunk/windstille/src/gui/grid_component.cpp
   trunk/windstille/src/gui/grid_component.hpp
   trunk/windstille/src/gui/tab_component.cpp
   trunk/windstille/src/gui/tab_component.hpp
   trunk/windstille/src/input/controller_description.cpp
   trunk/windstille/src/input/input_configurator.cpp
   trunk/windstille/src/input/input_configurator.hpp
   trunk/windstille/src/input/input_manager_sdl.cpp
   trunk/windstille/src/input/input_manager_sdl.hpp
   trunk/windstille/src/liquid.cpp
   trunk/windstille/src/liquid.hpp
   trunk/windstille/src/navigation_test.cpp
   trunk/windstille/src/objects/background_gradient.cpp
   trunk/windstille/src/objects/background_gradient.hpp
   trunk/windstille/src/objects/nightvision.hpp
   trunk/windstille/src/objects/test_object.cpp
   trunk/windstille/src/objects/test_object.hpp
   trunk/windstille/src/particle_viewer.cpp
   trunk/windstille/src/particles/particle_system.cpp
   trunk/windstille/src/particles/particle_system.hpp
   trunk/windstille/src/particles/spark_drawer.cpp
   trunk/windstille/src/particles/surface_drawer.cpp
   trunk/windstille/src/scriptable_object.cpp
   trunk/windstille/src/scriptable_object.hpp
   trunk/windstille/src/scripting/util.hpp
   trunk/windstille/src/sector.cpp
   trunk/windstille/src/sexpr_file_reader.cpp
   trunk/windstille/src/sprite2d/data.cpp
   trunk/windstille/src/sprite2d/data.hpp
   trunk/windstille/src/sprite2d/manager.cpp
   trunk/windstille/src/sprite2d/manager.hpp
   trunk/windstille/src/sprite2d/sprite.cpp
   trunk/windstille/src/sprite2d/sprite.hpp
   trunk/windstille/src/tile_description.cpp
   trunk/windstille/src/tile_factory.cpp
   trunk/windstille/src/tile_factory.hpp
   trunk/windstille/src/tile_map.cpp
   trunk/windstille/src/tile_map.hpp
   trunk/windstille/src/trigger.cpp
Log:
- replaced some more lisp::Lisp with FileReader

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/TODO	2007-06-20 08:44:42 UTC (rev 1478)
@@ -47,5 +47,6 @@
   and config done via option menu, i.e. command line settings
   shouldn't be persistent unless told so
 - add line numbers to error messages from lisp
+- fix memory leak in SExprFileReader
 
 # EOF #

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/SConscript	2007-06-20 08:44:42 UTC (rev 1478)
@@ -95,7 +95,6 @@
 'title_screen.cpp',
 'util.cpp',
 'view.cpp',
-'lisp_getters.cpp',
 'windstille_main.cpp',
 'objects/shockwave.cpp',
 'objects/test_object.cpp',

Modified: trunk/windstille/src/box.cpp
===================================================================
--- trunk/windstille/src/box.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/box.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -17,11 +17,9 @@
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
+#include <stdexcept>
 #include "box.hpp"
 #include "globals.hpp"
-#include "lisp/lisp.hpp"
-#include "lisp/properties.hpp"
-#include "lisp_getters.hpp"
 #include "collision/collision_engine.hpp"
 #include "math/vector.hpp"
 #include "tile_map.hpp"

Modified: trunk/windstille/src/box.hpp
===================================================================
--- trunk/windstille/src/box.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/box.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -21,7 +21,6 @@
 #define HEADER_WINDSTILLE_BOX_HXX
 
 #include "entity.hpp"
-#include "lisp/lisp.hpp"
 #include "collision/collision_object.hpp"
 #include "sector.hpp"
 #include "particles/particle_system.hpp"

Modified: trunk/windstille/src/character.cpp
===================================================================
--- trunk/windstille/src/character.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/character.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -26,9 +26,7 @@
 #include "physfs/physfs_stream.hpp"
 #include "console.hpp"
 #include "sprite3d/manager.hpp"
-#include "lisp/properties.hpp"
 #include "util.hpp"
-#include "lisp_getters.hpp"
 
 #include <exception>
 

Modified: trunk/windstille/src/character.hpp
===================================================================
--- trunk/windstille/src/character.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/character.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -22,7 +22,6 @@
 
 #include "entity.hpp"
 #include "sprite3d/sprite3d.hpp"
-#include "lisp/lisp.hpp"
 
 class Character : public Entity
 {

Modified: trunk/windstille/src/config.cpp
===================================================================
--- trunk/windstille/src/config.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/config.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -314,8 +314,7 @@
 Config::load()
 {
   try {
-    SExprFileReader reader("config");
-
+    FileReader reader = FileReader::parse("config");
     if(reader.get_name() != "windstille-config") {
       std::cerr << "Warning: Config file is not a windstille-config file.\n";
       return;

Modified: trunk/windstille/src/elevator.cpp
===================================================================
--- trunk/windstille/src/elevator.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/elevator.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -22,12 +22,11 @@
 **  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */
 
+#include <stdexcept>
 #include "elevator.hpp"
 #include "sector.hpp"
 #include "collision/collision_engine.hpp"
 #include "sprite2d/manager.hpp"
-#include "lisp/properties.hpp"
-#include "lisp_getters.hpp"
 
 Elevator::Elevator(FileReader& props)
 {

Modified: trunk/windstille/src/elevator.hpp
===================================================================
--- trunk/windstille/src/elevator.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/elevator.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -25,7 +25,6 @@
 #ifndef HEADER_ELEVATOR_HXX
 #define HEADER_ELEVATOR_HXX
 
-#include "lisp/lisp.hpp"
 #include "entity.hpp"
 #include "sprite2d/sprite.hpp"
 

Modified: trunk/windstille/src/file_reader.cpp
===================================================================
--- trunk/windstille/src/file_reader.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/file_reader.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -18,11 +18,15 @@
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
 #include "sexpr_file_reader.hpp"
-#include "lisp/parser.hpp"
-#include "lisp/lisp.hpp"
 #include "file_reader.hpp"
 #include "file_reader_impl.hpp"
 
+FileReader
+FileReader::parse(const std::string& filename)
+{
+  return SExprFileReader(filename);
+}
+
 FileReader::FileReader(SharedPtr<FileReaderImpl> impl_)
   : impl(impl_)
 {
@@ -115,6 +119,15 @@
 }
 
 bool
+FileReader::get(const char* name, std::vector<std::string>& value) const
+{
+  if (impl.get())
+    return impl->get(name, value);
+  else
+    return false;
+}
+
+bool
 FileReader::get(const char* name, std::vector<float>& value) const
 {
   if (impl.get())
@@ -167,21 +180,6 @@
   return reader;
 }
 
-FileReader
-FileReader::parse(const std::string& filename)
-{
-  // FIXME: memory leak, somebody must delete the lisp::Lisp
-  lisp::Lisp* sexpr = lisp::Parser::parse(filename);
-  if (sexpr)
-    {
-      return SExprFileReader(sexpr->get_list_elem(0));
-    }
-  else
-    {
-      return FileReader();
-    }
-}
-
 void
 FileReader::print_unused_warnings(const std::string& title)
 {

Modified: trunk/windstille/src/file_reader.hpp
===================================================================
--- trunk/windstille/src/file_reader.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/file_reader.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -37,6 +37,8 @@
 class FileReader
 {
 public:
+  static FileReader parse(const std::string& filename);
+
   FileReader(SharedPtr<FileReaderImpl> impl_);
   FileReader();
 
@@ -70,6 +72,7 @@
 
   bool get(const char* name, std::vector<int>&   v) const;
   bool get(const char* name, std::vector<float>& v) const;
+  bool get(const char* name, std::vector<std::string>& v) const;
 
   bool get(const char* name, FileReader& v) { return read_section(name, v); }
   bool get(const char* name, int&   v) { return read_int(name, v); }
@@ -84,8 +87,6 @@
   std::vector<std::string> get_section_names() const;
   std::vector<FileReader>  get_sections() const;
 
-  static FileReader parse(const std::string& filename);
-
   void print_unused_warnings(const std::string& title);
 
 private:

Modified: trunk/windstille/src/file_reader_impl.hpp
===================================================================
--- trunk/windstille/src/file_reader_impl.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/file_reader_impl.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -50,7 +50,7 @@
 
   virtual bool get(const char* name, std::vector<int>&   v) const =0;
   virtual bool get(const char* name, std::vector<float>& v) const =0;
-
+  virtual bool get(const char* name, std::vector<std::string>& v) const =0;
   virtual bool read_section(const char* name, FileReader&)   const =0;
   virtual std::vector<FileReader> get_sections() const =0;
   virtual std::vector<std::string> get_section_names() const =0;

Modified: trunk/windstille/src/gui/automap.cpp
===================================================================
--- trunk/windstille/src/gui/automap.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/gui/automap.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -32,7 +32,7 @@
 
 namespace gui {
 
-Automap::Automap(const lisp::Lisp* lisp, Component* parent)
+Automap::Automap(FileReader& reader, Component* parent)
   : Component(parent)
 {
   assert(0);

Modified: trunk/windstille/src/gui/automap.hpp
===================================================================
--- trunk/windstille/src/gui/automap.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/gui/automap.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -40,7 +40,7 @@
   float   zoom;
 
 public:
-  Automap(const lisp::Lisp* lisp, Component* parent);
+  Automap(FileReader& reader, Component* parent);
   Automap(const Rectf& rect, Component* parent);
   ~Automap();
 

Modified: trunk/windstille/src/gui/button.cpp
===================================================================
--- trunk/windstille/src/gui/button.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/gui/button.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -23,6 +23,7 @@
 **  02111-1307, USA.
 */
 
+#include <assert.h>
 #include "display/display.hpp"
 #include "font/fonts.hpp"
 #include "input/controller.hpp"
@@ -30,7 +31,7 @@
 
 namespace gui {
 
-Button::Button(const lisp::Lisp* lisp, Component* parent)
+Button::Button(FileReader& reader, Component* parent)
   : Component(parent)
 {
   assert(0);

Modified: trunk/windstille/src/gui/button.hpp
===================================================================
--- trunk/windstille/src/gui/button.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/gui/button.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -27,7 +27,6 @@
 #define HEADER_WINDSTILLE_GUI_BUTTON_HPP
 
 #include <string>
-#include "lisp/lisp.hpp"
 #include "component.hpp"
 
 namespace gui {
@@ -39,7 +38,7 @@
   std::string label;
 
 public:
-  Button(const lisp::Lisp* lisp, Component* parent);
+  Button(FileReader& reader, Component* parent);
   Button(const std::string& label, Component* parent);
   ~Button();
 

Modified: trunk/windstille/src/gui/component.hpp
===================================================================
--- trunk/windstille/src/gui/component.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/gui/component.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -28,6 +28,7 @@
 
 #include "math/rect.hpp"
 
+class FileReader;
 class Controller;
 
 namespace gui {

Modified: trunk/windstille/src/gui/component_factory.cpp
===================================================================
--- trunk/windstille/src/gui/component_factory.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/gui/component_factory.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -41,23 +41,23 @@
 }
 
 Component*
-ComponentFactory::create(const std::string& name, const lisp::Lisp* lisp, Component* parent)
+ComponentFactory::create(const std::string& name, FileReader& reader, Component* parent)
 {
   if (name == "tab")
     {
-      return new TabComponent(lisp, parent);
+      return new TabComponent(reader, parent);
     }
   else if (name == "automap")
     {
-      return new Automap(lisp, parent);
+      return new Automap(reader, parent);
     }
   else if (name == "grid")
     {
-      return new GridComponent(lisp, parent);
+      return new GridComponent(reader, parent);
     }
   else if (name == "button")
     {
-      return new Button(lisp, parent);
+      return new Button(reader, parent);
     }
   else
     {

Modified: trunk/windstille/src/gui/component_factory.hpp
===================================================================
--- trunk/windstille/src/gui/component_factory.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/gui/component_factory.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -27,7 +27,6 @@
 #define HEADER_COMPONENT_FACTORY_HPP
 
 #include <string>
-#include "lisp/lisp.hpp"
 
 namespace gui {
 
@@ -41,7 +40,7 @@
   ComponentFactory();
   ~ComponentFactory();
 
-  Component* create(const std::string& name, const lisp::Lisp* lisp, Component* parent);
+  Component* create(const std::string& name, FileReader& reader, Component* parent);
   
 private:
   ComponentFactory (const ComponentFactory&);

Modified: trunk/windstille/src/gui/grid_component.cpp
===================================================================
--- trunk/windstille/src/gui/grid_component.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/gui/grid_component.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -30,7 +30,7 @@
 
 namespace gui {
 
-GridComponent::GridComponent(const lisp::Lisp* lisp, Component* parent)
+GridComponent::GridComponent(FileReader& reader, Component* parent)
   : Component(parent)
 {
   assert(0);  

Modified: trunk/windstille/src/gui/grid_component.hpp
===================================================================
--- trunk/windstille/src/gui/grid_component.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/gui/grid_component.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -26,7 +26,6 @@
 #ifndef HEADER_WINDSTILLE_GUI_GRID_COMPONENT_HPP
 #define HEADER_WINDSTILLE_GUI_GRID_COMPONENT_HPP
 
-#include "lisp/lisp.hpp"
 #include "field.hpp"
 #include "component.hpp"
 
@@ -61,7 +60,7 @@
   float padding;
 
 public:
-  GridComponent(const lisp::Lisp* lisp, Component* parent);
+  GridComponent(FileReader& reader, Component* parent);
   GridComponent(const Rectf& rect, int weight, int height, Component* parent);
   ~GridComponent();
   

Modified: trunk/windstille/src/gui/tab_component.cpp
===================================================================
--- trunk/windstille/src/gui/tab_component.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/gui/tab_component.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -23,6 +23,7 @@
 **  02111-1307, USA.
 */
 
+#include <assert.h>
 #include "input/controller.hpp"
 #include "font/fonts.hpp"
 #include "display/display.hpp"
@@ -30,7 +31,7 @@
 
 namespace gui {
 
-TabComponent::TabComponent(const lisp::Lisp* lisp, Component* parent)
+TabComponent::TabComponent(FileReader& reader, Component* parent)
   : Component(parent)
 {
   assert(0);

Modified: trunk/windstille/src/gui/tab_component.hpp
===================================================================
--- trunk/windstille/src/gui/tab_component.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/gui/tab_component.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -28,7 +28,6 @@
 
 #include <string>
 #include <vector>
-#include "lisp/lisp.hpp"
 #include "component.hpp"
 
 namespace gui {
@@ -54,7 +53,7 @@
   int current_tab;
 
 public:
-  TabComponent(const lisp::Lisp* lisp, Component* parent);
+  TabComponent(FileReader& reader, Component* parent);
   TabComponent(const Rectf& rect, Component* parent);
   ~TabComponent();
 

Modified: trunk/windstille/src/input/controller_description.cpp
===================================================================
--- trunk/windstille/src/input/controller_description.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/input/controller_description.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -89,7 +89,7 @@
 {
   std::map<std::string, InputEventDefinition>::const_iterator i = str_to_event.find(name);
   if (i == str_to_event.end())
-    throw std::runtime_error("Unknown event str");
+    throw std::runtime_error("Unknown event str: " + name);
 
   return i->second;
 }

Modified: trunk/windstille/src/input/input_configurator.cpp
===================================================================
--- trunk/windstille/src/input/input_configurator.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/input/input_configurator.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -23,6 +23,8 @@
 **  02111-1307, USA.
 */
 
+#include <iostream>
+#include <stdexcept>
 #include "display/display.hpp"
 #include "math/rect.hpp"
 #include "controller_def.hpp"

Modified: trunk/windstille/src/input/input_configurator.hpp
===================================================================
--- trunk/windstille/src/input/input_configurator.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/input/input_configurator.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -26,6 +26,7 @@
 #ifndef HEADER_INPUT_CONFIGURATOR_HPP
 #define HEADER_INPUT_CONFIGURATOR_HPP
 
+#include <sstream>
 #include "screen.hpp"
 #include "text_area.hpp"
 

Modified: trunk/windstille/src/input/input_manager_sdl.cpp
===================================================================
--- trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -5,7 +5,7 @@
 **   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
 **    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
 **         \/          \/      \/    \/                         \/
-**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**  Copyright (C) 2005,2007 Ingo Ruhnke <grumbel at gmx.de>
 **
 **  This program is free software; you can redistribute it and/or
 **  modify it under the terms of the GNU General Public License
@@ -24,11 +24,10 @@
 */
 
 #include <iostream>
+#include <sstream>
+#include <stdexcept>
 #include <vector>
-#include "lisp/parser.hpp"
-#include "lisp/lisp.hpp"
-#include "lisp/properties.hpp"
-#include "lisp/property_iterator.hpp"
+#include "file_reader.hpp"
 #include "controller_def.hpp"
 #include "input_manager_sdl.hpp"
 
@@ -96,105 +95,94 @@
 void
 InputManagerSDL::load(const std::string& filename)
 {
-  std::auto_ptr<lisp::Lisp> root (lisp::Parser::parse(filename));
-  lisp::Properties rootp(root.get());
+  FileReader reader = FileReader::parse(filename);
 
   std::cout << "InputManager: " << filename << std::endl;
 
-  const lisp::Lisp* controller = 0;
-  if(rootp.get("windstille-controller", controller) == false) {
+  if (reader.get_name() != "windstille-controller") {
     std::ostringstream msg;
     msg << "'" << filename << "' is not a windstille-controller file";
     throw std::runtime_error(msg.str());
   }
   
-  parse_config(controller);
+  parse_config(reader);
 }
 
 void
-InputManagerSDL::parse_config(const lisp::Lisp* lisp)
+InputManagerSDL::parse_config(FileReader& reader)
 {
-  lisp::Properties cur(lisp);
-  lisp::PropertyIterator<const lisp::Lisp*> iter = cur.get_iter();
-
-  while(iter.next()) 
+  std::vector<FileReader> sections = reader.get_sections();
+  
+  for(std::vector<FileReader>::iterator i = sections.begin(); i != sections.end(); ++i)
     {
-      if (has_suffix(iter.item(), "-button"))
+      if (has_suffix(i->get_name(), "-button"))
         {
-          lisp::Properties dev_prop(*iter);
-          lisp::PropertyIterator<const lisp::Lisp*> dev_iter = dev_prop.get_iter();
-          while(dev_iter.next())
+          std::vector<FileReader> dev_sections = i->get_sections();
+          for(std::vector<FileReader>::iterator j = dev_sections.begin(); j != dev_sections.end(); ++j)
             {
-              if (dev_iter.item() == "joystick-button")
+              if (j->get_name() == "joystick-button")
                 {
                   int device = 0;
                   int button = 0;
 
-                  lisp::Properties props(*dev_iter);
-                  props.get("device", device);
-                  props.get("button", button);
+                  j->get("device", device);
+                  j->get("button", button);
 
-                  bind_joystick_button(controller_description.get_definition(iter.item()).id,
+                  bind_joystick_button(controller_description.get_definition(i->get_name()).id,
                                        device, button);
                 }
-              else if (dev_iter.item() == "keyboard-button")
+              else if (j->get_name() == "keyboard-button")
                 {
                   std::string key;
 
-                  lisp::Properties props(*dev_iter);
-                  props.get("key", key);
+                  j->get("key", key);
 
-                  bind_keyboard_button(controller_description.get_definition(iter.item()).id,
+                  bind_keyboard_button(controller_description.get_definition(i->get_name()).id,
                                        string_to_keyid(key));
                 }
               else
                 {
-                  std::cout << "InputManagerSDL: Unknown tag: " << dev_iter.item() << std::endl;
+                  std::cout << "InputManagerSDL: Unknown tag: " << j->get_name() << std::endl;
                 }
             }
         }
-      else if (has_suffix(iter.item(), "-axis"))
+      else if (has_suffix(i->get_name(), "-axis"))
         {
-          lisp::Properties dev_prop(*iter);
-          lisp::PropertyIterator<const lisp::Lisp*> dev_iter = dev_prop.get_iter();
-
-          while(dev_iter.next())
+          std::vector<FileReader> dev_sections = i->get_sections();
+          for(std::vector<FileReader>::iterator j = dev_sections.begin(); j != dev_sections.end(); ++j)
             {
-              if (dev_iter.item() == "joystick-axis")
+              if (j->get_name() == "joystick-axis")
                 {
-                  int device = 0;
-                  int axis   = 0;
+                  int  device = 0;
+                  int  axis   = 0;
                   bool invert = false;
 
-                  lisp::Properties props(*dev_iter);
-                  props.get("device", device);
-                  props.get("axis",   axis);
-                  props.get("invert", invert);
+                  j->get("device", device);
+                  j->get("axis",   axis);
+                  j->get("invert", invert);
 
-                  bind_joystick_axis(controller_description.get_definition(iter.item()).id,
+                  bind_joystick_axis(controller_description.get_definition(i->get_name()).id,
                                      device, axis, invert);
                 }
-              else if (dev_iter.item() == "keyboard-axis")
+              else if (j->get_name() == "keyboard-axis")
                 {
                   std::string minus;
                   std::string plus;
 
-                  lisp::Properties props(*dev_iter);
-                  props.get("minus", minus);
-                  props.get("plus",  plus);
+                  j->get("minus", minus);
+                  j->get("plus",  plus);
 
-                  bind_keyboard_axis(controller_description.get_definition(iter.item()).id, 
+                  bind_keyboard_axis(controller_description.get_definition(i->get_name()).id, 
                                      string_to_keyid(minus), string_to_keyid(plus));
                 }
               else
                 {
-                  std::cout << "InputManagerSDL: Unknown tag: " << dev_iter.item() << std::endl;
+                  std::cout << "InputManagerSDL: Unknown tag: " << j->get_name() << std::endl;
                 }
             }
 
         }
     }
-
 }
 
 InputManagerSDL::InputManagerSDL()

Modified: trunk/windstille/src/input/input_manager_sdl.hpp
===================================================================
--- trunk/windstille/src/input/input_manager_sdl.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/input/input_manager_sdl.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -5,7 +5,7 @@
 **   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
 **    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
 **         \/          \/      \/    \/                         \/
-**  Copyright (C) 2005 Ingo Ruhnke <grumbel at gmx.de>
+**  Copyright (C) 2005,2007 Ingo Ruhnke <grumbel at gmx.de>
 **
 **  This program is free software; you can redistribute it and/or
 **  modify it under the terms of the GNU General Public License
@@ -28,8 +28,8 @@
 
 #include <SDL.h>
 #include "input_manager_impl.hpp"
-#include "lisp/lisp.hpp"
 
+class FileReader;
 class InputManagerSDLImpl;
 
 struct JoystickButtonBinding
@@ -126,7 +126,7 @@
   /** Ensure that the joystick device \a device is open */
   void ensure_open_joystick(int device);
 
-  void parse_config(const lisp::Lisp* lisp);
+  void parse_config(FileReader& reader);
 
   std::auto_ptr<InputManagerSDLImpl> impl;
 

Modified: trunk/windstille/src/liquid.cpp
===================================================================
--- trunk/windstille/src/liquid.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/liquid.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -23,8 +23,6 @@
 **  02111-1307, USA.
 */
 
-#include "lisp/properties.hpp"
-#include "lisp_getters.hpp"
 #include "display/vertex_array_drawing_request.hpp"
 #include "random.hpp"
 #include "liquid.hpp"

Modified: trunk/windstille/src/liquid.hpp
===================================================================
--- trunk/windstille/src/liquid.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/liquid.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -27,7 +27,6 @@
 #define HEADER_WINDSTILLE_LIQUID_HPP
 
 #include <vector>
-#include "lisp/lisp.hpp"
 #include "entity.hpp"
 
 /** */

Deleted: trunk/windstille/src/lisp_getters.cpp
===================================================================
--- trunk/windstille/src/lisp_getters.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/lisp_getters.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -1,65 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2000,2005 Matthias Braun <matze at braunis.de>
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-
-#include "lisp/lisp.hpp"
-#include "lisp/getters.hpp"
-#include "lisp_getters.hpp"
-#include "math/vector.hpp"
-#include "color.hpp"
-
-namespace lisp
-{
-
-bool property_get(const lisp::Lisp* lisp, Color& color)
-{
-  std::vector<float> col;
-  if(property_get(lisp, col) == false)
-    return false;
-  if(col.size() == 3)
-    color = Color(col[0], col[1], col[2]);
-  else if(col.size() == 4)
-    color = Color(col[0], col[1], col[2], col[3]);
-  else
-    return false;
-  
-  return true;
-}
-
-bool property_get(const lisp::Lisp* lisp, Vector& vec)
-{
-  size_t size = lisp->get_list_size();
-  if(size != 4 && size != 3)
-    return false;
-  if(get(lisp->get_list_elem(1), vec.x) == false)
-    return false;
-  if(get(lisp->get_list_elem(2), vec.y) == false)
-    return false;
-  return true;
-}
-
-}
-
-/* EOF */

Deleted: trunk/windstille/src/lisp_getters.hpp
===================================================================
--- trunk/windstille/src/lisp_getters.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/lisp_getters.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -1,42 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2000,2005 Matthias Braun <matze at braunis.de>
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef __WINDSTILLE_GETTERS_HPP__
-#define __WINDSTILLE_GETTERS_HPP__
-
-#include "math/vector.hpp"
-
-class Color;
-
-namespace lisp
-{
-
-bool property_get(const lisp::Lisp* lisp, Color& col);
-bool property_get(const lisp::Lisp* lisp, Vector& vec);
-
-}
-
-#endif
-

Modified: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -49,7 +49,7 @@
   graph = new NavigationGraph();
 
   try {
-    SExprFileReader reader("navigation.nav");
+    FileReader reader = FileReader::parse("navigation.nav");
     graph->load(reader);
   } catch(std::exception& err) {
     std::cout << "NavigationTest: " << err.what() << std::endl;

Modified: trunk/windstille/src/objects/background_gradient.cpp
===================================================================
--- trunk/windstille/src/objects/background_gradient.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/objects/background_gradient.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -23,6 +23,7 @@
 **  02111-1307, USA.
 */
 
+#include <iostream>
 #include "display/vertex_array_drawing_request.hpp"
 #include "background_gradient.hpp"
 

Modified: trunk/windstille/src/objects/background_gradient.hpp
===================================================================
--- trunk/windstille/src/objects/background_gradient.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/objects/background_gradient.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -26,7 +26,6 @@
 #ifndef HEADER_BACKGROUND_GRADIENT_HPP
 #define HEADER_BACKGROUND_GRADIENT_HPP
 
-#include "lisp/lisp.hpp"
 #include "game_object.hpp"
 
 /** */

Modified: trunk/windstille/src/objects/nightvision.hpp
===================================================================
--- trunk/windstille/src/objects/nightvision.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/objects/nightvision.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -26,7 +26,6 @@
 #ifndef HEADER_NIGHTVISION_HPP
 #define HEADER_NIGHTVISION_HPP
 
-#include "lisp/lisp.hpp"
 #include "display/texture.hpp"
 #include "sprite2d/sprite.hpp"
 #include "game_object.hpp"

Modified: trunk/windstille/src/objects/test_object.cpp
===================================================================
--- trunk/windstille/src/objects/test_object.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/objects/test_object.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -1,3 +1,5 @@
+#include <iostream>
+#include <stdexcept>
 #include <config.h>
 
 #include "test_object.hpp"
@@ -2,8 +4,5 @@
 #include "sprite3d/manager.hpp"
-#include "lisp/properties.hpp"
-#include "lisp_getters.hpp"
 
 TestObject::TestObject(FileReader& props)
 {
-  using namespace lisp;
   pos = Vector(0, 0);

Modified: trunk/windstille/src/objects/test_object.hpp
===================================================================
--- trunk/windstille/src/objects/test_object.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/objects/test_object.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -5,7 +5,6 @@
 #include "game_object.hpp"
 #include "sprite3d/sprite3d.hpp"
 #include "math/vector.hpp"
-#include "lisp/lisp.hpp"
 
 class TestObject : public GameObject
 {

Modified: trunk/windstille/src/particle_viewer.cpp
===================================================================
--- trunk/windstille/src/particle_viewer.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/particle_viewer.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -23,8 +23,6 @@
 **  02111-1307, USA.
 */
 
-#include "lisp/lisp.hpp"
-#include "lisp/parser.hpp"
 #include "sexpr_file_reader.hpp"
 #include "input/controller.hpp"
 #include "screen_manager.hpp"
@@ -117,7 +115,7 @@
     delete *i;
   systems.clear();
   
-  SExprFileReader root_reader(filename);
+  FileReader root_reader = FileReader::parse(filename);
   if(root_reader.get_name() != "particle-systems") {
     std::ostringstream msg;
     msg << "'" << filename << "' is not a particle-system file";

Modified: trunk/windstille/src/particles/particle_system.cpp
===================================================================
--- trunk/windstille/src/particles/particle_system.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/particles/particle_system.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -29,9 +29,6 @@
 #include "display/scene_context.hpp"
 #include "math/vector.hpp"
 #include "color.hpp"
-#include "lisp/properties.hpp"
-#include "lisp/property_iterator.hpp"
-#include "lisp_getters.hpp"
 #include "file_reader.hpp"
 #include "spark_drawer.hpp"
 #include "deform_drawer.hpp"

Modified: trunk/windstille/src/particles/particle_system.hpp
===================================================================
--- trunk/windstille/src/particles/particle_system.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/particles/particle_system.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -30,7 +30,6 @@
 
 #include "color.hpp"
 #include "drawer.hpp"
-#include "lisp/lisp.hpp"
 #include "entity.hpp"
 
 class SceneContext;

Modified: trunk/windstille/src/particles/spark_drawer.cpp
===================================================================
--- trunk/windstille/src/particles/spark_drawer.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/particles/spark_drawer.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -26,8 +26,6 @@
 #include "display/drawing_request.hpp"
 #include "display/vertex_array_drawing_request.hpp"
 #include "particle_system.hpp"
-#include "lisp/properties.hpp"
-#include "lisp_getters.hpp"
 #include "color.hpp"
 #include "spark_drawer.hpp"
 

Modified: trunk/windstille/src/particles/surface_drawer.cpp
===================================================================
--- trunk/windstille/src/particles/surface_drawer.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/particles/surface_drawer.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -26,7 +26,6 @@
 #include "display/vertex_array_drawing_request.hpp"
 #include "particle_system.hpp"
 #include "../console.hpp" 
-#include "lisp/properties.hpp"
 #include "display/surface_manager.hpp"
 #include "surface_drawer.hpp"
 

Modified: trunk/windstille/src/scriptable_object.cpp
===================================================================
--- trunk/windstille/src/scriptable_object.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/scriptable_object.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -26,8 +26,6 @@
 
 #include "globals.hpp"
 #include "scriptable_object.hpp"
-#include "lisp/properties.hpp"
-#include "lisp_getters.hpp"
 #include "sprite2d/manager.hpp"
 #include "script_manager.hpp"
 

Modified: trunk/windstille/src/scriptable_object.hpp
===================================================================
--- trunk/windstille/src/scriptable_object.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/scriptable_object.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -29,7 +29,6 @@
 
 #include <string>
 #include "entity.hpp"
-#include "lisp/lisp.hpp"
 #include "sprite2d/sprite.hpp"
 
 /** Can represent any generic object that the player may see or interact with that

Modified: trunk/windstille/src/scripting/util.hpp
===================================================================
--- trunk/windstille/src/scripting/util.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/scripting/util.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -31,6 +31,7 @@
 
 namespace lisp {
 class Writer;
+class Lisp;
 };
 
 namespace Scripting {

Modified: trunk/windstille/src/sector.cpp
===================================================================
--- trunk/windstille/src/sector.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/sector.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -20,9 +20,6 @@
 #include <iostream>
 #include <sstream>
 #include <stdexcept>
-#include "lisp/properties.hpp"
-#include "lisp/parser.hpp"
-#include "lisp_getters.hpp"
 #include "sexpr_file_reader.hpp"
 #include "globals.hpp"
 #include "display/scene_context.hpp"
@@ -106,9 +103,8 @@
 Sector::parse_file(const std::string& filename)
 {
   if (debug) std::cout << "Sector:parse_file '" << filename << "'" << std::endl;
-  using namespace lisp;
   
-  SExprFileReader reader(filename);
+  FileReader reader = FileReader::parse(filename);
   if(reader.get_name() != "windstille-sector") {
     std::ostringstream msg;
     msg << "'" << filename << "' is not a windstille-sector file";

Modified: trunk/windstille/src/sexpr_file_reader.cpp
===================================================================
--- trunk/windstille/src/sexpr_file_reader.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/sexpr_file_reader.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -46,12 +46,6 @@
     assert(sexpr && 
            sexpr->get_type() == lisp::Lisp::TYPE_LIST &&
            sexpr->get_list_size() >= 1);
-    
-    // FIXME: I don't think this is good for anything
-    // for(size_t i = 1; i < sexpr->get_list_size(); ++i)
-    // { // iterate over subsections
-    //  sexpr->get_list_elem(i);
-    // }
   }
 
   ~SExprFileReaderImpl()
@@ -210,6 +204,15 @@
       return false;
   }
 
+  bool get(const char* name, std::vector<std::string>&   v) const
+  {
+    lisp::Lisp* sub = get_subsection(name);
+    if (sub)
+      return property_get(sub, v);
+    else 
+      return false;
+  }
+
   bool get(const char* name, std::vector<float>& v) const
   {
     lisp::Lisp* sub = get_subsection(name);
@@ -293,6 +296,7 @@
     }
   else if (sexpr && sexpr->get_type() == lisp::Lisp::TYPE_LIST && sexpr->get_list_size() >= 1)
     {
+      // FIXME: Memory leak! We are only cleaning up a subset of the whole lisp objects
       return sexpr->get_list_elem(0);
     }
   else

Modified: trunk/windstille/src/sprite2d/data.cpp
===================================================================
--- trunk/windstille/src/sprite2d/data.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/sprite2d/data.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -1,3 +1,29 @@
+/*  $Id: windstille.hpp 1460 2007-06-18 04:03:31Z grumbel $
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005,2007 Matthias Braun <matze at braunis.de>,
+**                          Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
 #include <config.h>
 
 #include "sprite2d/data.hpp"
@@ -8,10 +34,6 @@
 #include <sstream>
 #include <stdexcept>
 #include "util.hpp"
-#include "lisp/lisp.hpp"
-#include "lisp/parser.hpp"
-#include "lisp/properties.hpp"
-#include "lisp_getters.hpp"
 #include "display/surface.hpp"
 #include "display/surface_manager.hpp"
 
@@ -39,17 +61,16 @@
     {
       if (has_suffix(filename, ".sprite"))
         {
-          std::auto_ptr<lisp::Lisp> root (lisp::Parser::parse(filename));
-          lisp::Properties rootp(root.get());
-          const lisp::Lisp* sprite = 0;
-          if(rootp.get("sprite", sprite) == false) {
+          FileReader reader = FileReader::parse(filename);
+
+          if(reader.get_name() != "sprite") {
             std::ostringstream msg;
             msg << "File '" << filename << "' is not a windstille sprite";
             throw std::runtime_error(msg.str());
           }
     
           std::string dir = dirname(filename);
-          parse(dir, sprite);
+          parse(dir, reader);
         }
       else if (has_suffix(tolowercase(filename), ".png") || has_suffix(tolowercase(filename), ".jpg"))
         {
@@ -106,41 +127,59 @@
 }
 
 void
-Data::parse(const std::string& dir, const lisp::Lisp* lisp)
+Data::parse(const std::string& dir, FileReader& reader)
 {
-  lisp::Properties props(lisp);
-  lisp::PropertyIterator<const lisp::Lisp*> iter;
-  props.get_iter("action", iter);
-  while(iter.next()) {
-    actions.push_back(parse_action(dir, *iter));
-  }
-  props.print_unused_warnings("sprite");
-
+  std::vector<FileReader> sections = reader.get_sections();
+  for(std::vector<FileReader>::iterator i = sections.begin(); i != sections.end(); ++i)
+    actions.push_back(parse_action(dir, *i));
+  
   if(actions.size() == 0)
     throw std::runtime_error("Sprite contains no actions");
 }
 
 Action*
-Data::parse_action(const std::string& dir, const lisp::Lisp* lisp)
+Data::parse_action(const std::string& dir, FileReader& reader)
 {
   std::auto_ptr<Action> action (new Action);
   action->speed = 1.0;
   action->scale = 1.0f;
   action->offset = Vector(0, 0);
  
-  lisp::Properties props(lisp);
-  props.get("name", action->name);
-  props.get("speed", action->speed);
-  props.get("scale", action->scale);
-  props.get("offset", action->offset);
+  reader.get("name", action->name);
+  reader.get("speed", action->speed);
+  reader.get("scale", action->scale);
+  reader.get("offset", action->offset);
   
-  const lisp::Lisp* ilisp = 0;
-  if(props.get("images", ilisp)) {
-    parse_images(action.get(), dir, ilisp);
-  } else if(props.get("image-grid", ilisp)) {
-    parse_image_grid(action.get(), dir, ilisp);
-  }
-  props.print_unused_warnings("sprite action");
+  FileReader grid_reader;
+  std::vector<std::string> image_files;
+  if(reader.get("images", image_files))
+    {
+      //parse_images(action.get(), dir, images);
+
+      for(std::vector<std::string>::iterator file = image_files.begin(); file != image_files.end(); ++file)
+        {
+          action->surfaces.push_back(surface_manager->get(dir + "/" + *file));
+        }
+    }
+  else if(reader.get("image-grid", grid_reader)) 
+    {
+      std::string filename;
+      int x_size = -1;
+      int y_size = -1;
+      
+      grid_reader.get("file", filename);
+      grid_reader.get("x-size", x_size);
+      grid_reader.get("y-size", y_size);
+
+      grid_reader.print_unused_warnings("action image-grid");
+
+      if(filename == "" || x_size <= 0 || y_size <= 0)
+        throw std::runtime_error("Invalid or too few data in image-grid");
+      
+      surface_manager->load_grid(dir + "/" + filename,
+                                 action->surfaces, x_size, y_size);
+    }
+  reader.print_unused_warnings("sprite action");
   
   if(action->name == "")
     throw std::runtime_error("No Name defined for action");
@@ -154,36 +193,16 @@
 
 void
 Data::parse_images(Action* action, const std::string& dir,
-                   const lisp::Lisp* lisp)
+                   FileReader& reader)
 {
-  for(size_t n = 1; n < lisp->get_list_size(); ++n) {
-    std::string file = lisp->get_list_elem(n)->get_string();
-    Surface surface = surface_manager->get(dir + "/" + file);
-    action->surfaces.push_back(surface);
-  }
+
 }
 
 void
 Data::parse_image_grid(Action* action, const std::string& dir,
-                       const lisp::Lisp* lisp)
+                       FileReader& reader)
 {
-  std::string filename;
-  int x_size = -1;
-  int y_size = -1;
- 
-  lisp::Properties props(lisp);
 
-  props.get("file", filename);
-  props.get("x-size", x_size);
-  props.get("y-size", y_size);
-
-  props.print_unused_warnings("action image-grid");
-
-  if(filename == "" || x_size <= 0 || y_size <= 0)
-    throw std::runtime_error("Invalid or too few data in image-grid");
-
-  surface_manager->load_grid(dir + "/" + filename,
-                             action->surfaces, x_size, y_size);
 }
  
 } // namespace sprite2d

Modified: trunk/windstille/src/sprite2d/data.hpp
===================================================================
--- trunk/windstille/src/sprite2d/data.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/sprite2d/data.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -1,3 +1,29 @@
+/*  $Id: windstille.hpp 1460 2007-06-18 04:03:31Z grumbel $
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005,2007 Matthias Braun <matze at braunis.de>,
+**                          Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
 #ifndef __SPRITE_DATA_HPP__
 #define __SPRITE_DATA_HPP__
 
@@ -5,9 +31,9 @@
 #include <vector>
 #include <GL/glew.h>
 #include <GL/gl.h>
+#include "file_reader.hpp"
 #include "math/vector.hpp"
 #include "display/surface.hpp"
-#include "lisp/lisp.hpp"
 #include "ref.hpp"
 
 namespace sprite2d
@@ -16,21 +42,21 @@
 
 class Data
 {
+private:
+  void parse(const std::string& dir, FileReader& lisp);
+  
+  Action* parse_action(const std::string& dir, FileReader& reader);
+  void parse_images(Action* action, const std::string& dir, 
+                    FileReader& reader);
+  void parse_image_grid(Action* action, const std::string& dir,
+                        FileReader& reader); 
+
 public:
   Data(const std::string& filename);
   virtual ~Data();
 
   typedef std::vector<Action*> Actions;
   Actions actions;
-
-private:
-  void parse(const std::string& dir, const lisp::Lisp* lisp);
-  
-  Action* parse_action(const std::string& dir, const lisp::Lisp* lisp);
-  void parse_images(Action* action, const std::string& dir, 
-                    const lisp::Lisp* lisp);
-  void parse_image_grid(Action* action, const std::string& dir,
-                        const lisp::Lisp* lisp); 
 };
 
 struct Action

Modified: trunk/windstille/src/sprite2d/manager.cpp
===================================================================
--- trunk/windstille/src/sprite2d/manager.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/sprite2d/manager.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -1,3 +1,29 @@
+/*  $Id: windstille.hpp 1460 2007-06-18 04:03:31Z grumbel $
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005,2007 Matthias Braun <matze at braunis.de>,
+**                          Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
 #include <config.h>
 
 #include "sprite2d/manager.hpp"

Modified: trunk/windstille/src/sprite2d/manager.hpp
===================================================================
--- trunk/windstille/src/sprite2d/manager.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/sprite2d/manager.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -1,3 +1,29 @@
+/*  $Id: windstille.hpp 1460 2007-06-18 04:03:31Z grumbel $
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005,2007 Matthias Braun <matze at braunis.de>,
+**                          Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
 #ifndef __SPRITE2D_MANAGER_HPP__
 #define __SPRITE2D_MANAGER_HPP__
 

Modified: trunk/windstille/src/sprite2d/sprite.cpp
===================================================================
--- trunk/windstille/src/sprite2d/sprite.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/sprite2d/sprite.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -1,3 +1,28 @@
+/*  $Id: windstille.hpp 1460 2007-06-18 04:03:31Z grumbel $
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005,2007 Matthias Braun <matze at braunis.de>,
+**                          Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
 
 #include "sprite2d/sprite.hpp"
 

Modified: trunk/windstille/src/sprite2d/sprite.hpp
===================================================================
--- trunk/windstille/src/sprite2d/sprite.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/sprite2d/sprite.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -1,3 +1,29 @@
+/*  $Id: windstille.hpp 1460 2007-06-18 04:03:31Z grumbel $
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005,2007 Matthias Braun <matze at braunis.de>,
+**                          Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
 #ifndef __SPRITE2D_SPRITE_HPP__
 #define __SPRITE2D_SPRITE_HPP__
 
@@ -19,6 +45,24 @@
 
 class Sprite
 {
+private:
+  /** Pointer to the Sprites data which is shared among all sprites
+      with are loaded from the same file */
+  sprite2d::DataPtr data;
+  const sprite2d::Action* current_action;
+
+  float frame;
+  float speed;
+  float alpha;
+
+  bool   pingpong;
+  bool   reverse;
+  bool   vflip;
+  GLenum blend_sfactor;
+  GLenum blend_dfactor;
+  float  scale;
+  Color  color;
+
 public:
   Sprite();
 
@@ -49,7 +93,7 @@
   
   bool is_finished() const;
 
-  void set_blend_func(GLenum sfactor, GLenum dfactor);
+  void   set_blend_func(GLenum sfactor, GLenum dfactor);
   GLenum get_blend_sfactor() const;
   GLenum get_blend_dfactor() const;
 
@@ -68,24 +112,6 @@
 
   /** true if the Sprite is valid and usable, false if not */
   operator bool() const;
-
-private:
-  /** Pointer to the Sprites data which is shared among all sprites
-      with are loaded from the same file */
-  sprite2d::DataPtr data;
-  const sprite2d::Action* current_action;
-
-  float frame;
-  float speed;
-  float alpha;
-
-  bool pingpong;
-  bool reverse;
-  bool vflip;
-  GLenum blend_sfactor;
-  GLenum blend_dfactor;
-  float scale;
-  Color color;
 };
 
 #endif

Modified: trunk/windstille/src/tile_description.cpp
===================================================================
--- trunk/windstille/src/tile_description.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/tile_description.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -23,6 +23,9 @@
 **  02111-1307, USA.
 */
 
+#include <iostream>
+#include <sstream>
+#include <stdexcept>
 #include <SDL.h>
 #include <SDL_image.h>
 #include "physfs/physfs_sdl.hpp"

Modified: trunk/windstille/src/tile_factory.cpp
===================================================================
--- trunk/windstille/src/tile_factory.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/tile_factory.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -66,7 +66,7 @@
   packers.push_back(new TilePacker(1024, 1024));
   color_packer     = 0;
 
-  SExprFileReader reader(filename);
+  FileReader reader = FileReader::parse(filename);
   if(reader.get_name() != "windstille-tiles")
     {
       std::ostringstream msg;

Modified: trunk/windstille/src/tile_factory.hpp
===================================================================
--- trunk/windstille/src/tile_factory.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/tile_factory.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -22,7 +22,6 @@
 
 #include <map>
 #include <string>
-#include "lisp/lisp.hpp"
 #include "tile_description.hpp"
 
 class Tile;

Modified: trunk/windstille/src/tile_map.cpp
===================================================================
--- trunk/windstille/src/tile_map.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/tile_map.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -18,6 +18,7 @@
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
 #include <sstream>
+#include <stdexcept>
 #include <physfs.h>
 #include "tile_map.hpp"
 #include "tile.hpp"
@@ -26,12 +27,10 @@
 #include "view.hpp"
 #include "display/vertex_array_drawing_request.hpp"
 #include "collision/collision_engine.hpp"
-#include "lisp/properties.hpp"
 #include <inttypes.h>
 
 TileMap::TileMap(FileReader& props)
 {
-  using namespace lisp;
   int width = -1;
   int height = -1;
   z_pos = 0;

Modified: trunk/windstille/src/tile_map.hpp
===================================================================
--- trunk/windstille/src/tile_map.hpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/tile_map.hpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -24,7 +24,6 @@
 
 #include "globals.hpp"
 #include "field.hpp"
-#include "lisp/lisp.hpp"
 #include "game_object.hpp"
 #include "display/scene_context.hpp"
 

Modified: trunk/windstille/src/trigger.cpp
===================================================================
--- trunk/windstille/src/trigger.cpp	2007-06-20 05:08:24 UTC (rev 1477)
+++ trunk/windstille/src/trigger.cpp	2007-06-20 08:44:42 UTC (rev 1478)
@@ -17,13 +17,12 @@
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
+#include <stdexcept>
 #include <list>
 #include "sector.hpp"
 #include "trigger.hpp"
 #include "player.hpp"
 #include "script_manager.hpp"
-#include "lisp/lisp.hpp"
-#include "lisp/properties.hpp"
 
 Trigger::Trigger(FileReader& props)
   : triggered(false), one_time_trigger(false)



From grumbel at mail.berlios.de  Wed Jun 20 10:52:44 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 20 Jun 2007 10:52:44 +0200
Subject: [Windstille-commit] r1479 - trunk/windstille/src
Message-ID: <200706200852.l5K8qiqh020854@sheep.berlios.de>

Author: grumbel
Date: 2007-06-20 10:52:44 +0200 (Wed, 20 Jun 2007)
New Revision: 1479

Modified:
   trunk/windstille/src/file_reader.cpp
   trunk/windstille/src/sexpr_file_reader.cpp
   trunk/windstille/src/sexpr_file_reader.hpp
Log:
- fixed memleak in SExprFileReader

Modified: trunk/windstille/src/file_reader.cpp
===================================================================
--- trunk/windstille/src/file_reader.cpp	2007-06-20 08:44:42 UTC (rev 1478)
+++ trunk/windstille/src/file_reader.cpp	2007-06-20 08:52:44 UTC (rev 1479)
@@ -17,6 +17,7 @@
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
+#include "lisp/parser.hpp"
 #include "sexpr_file_reader.hpp"
 #include "file_reader.hpp"
 #include "file_reader_impl.hpp"
@@ -24,7 +25,23 @@
 FileReader
 FileReader::parse(const std::string& filename)
 {
-  return SExprFileReader(filename);
+  lisp::Lisp* root = lisp::Parser::parse(filename);
+  if (!root)
+    {
+      std::ostringstream msg;
+      msg << "'" << filename << "': file not found";
+      throw std::runtime_error(msg.str());
+    }
+  else if (root && root->get_type() == lisp::Lisp::TYPE_LIST && root->get_list_size() >= 1)
+    {
+      return SExprFileReader(root, root->get_list_elem(0));
+    }
+  else
+    {
+      std::ostringstream msg;
+      msg << "'" << filename << "': not a valid sexpr file";
+      throw std::runtime_error(msg.str());
+    }
 }
 
 FileReader::FileReader(SharedPtr<FileReaderImpl> impl_)

Modified: trunk/windstille/src/sexpr_file_reader.cpp
===================================================================
--- trunk/windstille/src/sexpr_file_reader.cpp	2007-06-20 08:44:42 UTC (rev 1478)
+++ trunk/windstille/src/sexpr_file_reader.cpp	2007-06-20 08:52:44 UTC (rev 1479)
@@ -36,11 +36,26 @@
 class SExprFileReaderImpl: public FileReaderImpl
 {
 public:
-  bool delete_sexpr;
+  /** Pointer to the top-most lisp element, only here for purpose of
+      being able to delete it */
+  const lisp::Lisp* root;
+
+  bool  delete_sexpr;
   const lisp::Lisp* sexpr;
 
+  SExprFileReaderImpl(const lisp::Lisp* root_, const lisp::Lisp* sexpr_)
+    : root(root_),
+      sexpr(sexpr_), 
+      delete_sexpr(false)
+  {
+    assert(sexpr && 
+           sexpr->get_type() == lisp::Lisp::TYPE_LIST &&
+           sexpr->get_list_size() >= 1);
+  }
+
   SExprFileReaderImpl(const lisp::Lisp* sexpr_, bool delete_sexpr_) 
-    : sexpr(sexpr_), 
+    : root(0),
+      sexpr(sexpr_), 
       delete_sexpr(delete_sexpr_)
   {
     assert(sexpr && 
@@ -50,10 +65,11 @@
 
   ~SExprFileReaderImpl()
   {
+    if (root)
+      delete root;
+
     if (delete_sexpr)
-      {
-        delete sexpr;
-      }
+      delete sexpr;
   }
 
   std::string get_name() const 
@@ -285,32 +301,9 @@
 {
 }
 
-static lisp::Lisp* read_lisp_file(const std::string& filename)
+SExprFileReader::SExprFileReader(const lisp::Lisp* root, const lisp::Lisp* sexpr)
+  : FileReader(SharedPtr<FileReaderImpl>(new SExprFileReaderImpl(root, sexpr)))
 {
-  lisp::Lisp* sexpr = lisp::Parser::parse(filename);
-  if (!sexpr)
-    {
-      std::ostringstream msg;
-      msg << "'" << filename << "': file not found";
-      throw std::runtime_error(msg.str());
-    }
-  else if (sexpr && sexpr->get_type() == lisp::Lisp::TYPE_LIST && sexpr->get_list_size() >= 1)
-    {
-      // FIXME: Memory leak! We are only cleaning up a subset of the whole lisp objects
-      return sexpr->get_list_elem(0);
-    }
-  else
-    {
-      std::ostringstream msg;
-      msg << "'" << filename << "': not a valid sexpr file";
-      throw std::runtime_error(msg.str());
-    }
 }
 
-SExprFileReader::SExprFileReader(const std::string& filename)
-  : FileReader(SharedPtr<FileReaderImpl>(new SExprFileReaderImpl(read_lisp_file(filename),
-                                                                 true)))
-{
-}
-
 /* EOF */

Modified: trunk/windstille/src/sexpr_file_reader.hpp
===================================================================
--- trunk/windstille/src/sexpr_file_reader.hpp	2007-06-20 08:44:42 UTC (rev 1478)
+++ trunk/windstille/src/sexpr_file_reader.hpp	2007-06-20 08:52:44 UTC (rev 1479)
@@ -34,8 +34,8 @@
 {
 private:
 public:
+  SExprFileReader(const lisp::Lisp* root, const lisp::Lisp* lisp);
   SExprFileReader(const lisp::Lisp* lisp, bool delete_sexpr = false);
-  SExprFileReader(const std::string& filename);
 };
 
 #endif



From grumbel at mail.berlios.de  Wed Jun 20 18:42:42 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 20 Jun 2007 18:42:42 +0200
Subject: [Windstille-commit] r1480 - in trunk/windstille/src: . sprite2d
Message-ID: <200706201642.l5KGggZE026777@sheep.berlios.de>

Author: grumbel
Date: 2007-06-20 18:42:40 +0200 (Wed, 20 Jun 2007)
New Revision: 1480

Modified:
   trunk/windstille/src/sprite2d/data.cpp
   trunk/windstille/src/sprite2d/data.hpp
   trunk/windstille/src/sprite2d/manager.cpp
   trunk/windstille/src/sprite2d/manager.hpp
   trunk/windstille/src/sprite2d/sprite.cpp
   trunk/windstille/src/sprite2d/sprite.hpp
   trunk/windstille/src/util.cpp
   trunk/windstille/src/util.hpp
   trunk/windstille/src/windstille_main.cpp
Log:
- removed sprite2D namespace, mode it flat

Modified: trunk/windstille/src/sprite2d/data.cpp
===================================================================
--- trunk/windstille/src/sprite2d/data.cpp	2007-06-20 08:52:44 UTC (rev 1479)
+++ trunk/windstille/src/sprite2d/data.cpp	2007-06-20 16:42:40 UTC (rev 1480)
@@ -37,26 +37,8 @@
 #include "display/surface.hpp"
 #include "display/surface_manager.hpp"
 
-namespace sprite2d {
-
-static bool has_suffix(const std::string& str, const std::string& suffix)
+SpriteData::SpriteData(const std::string& filename)
 {
-  if (str.length() >= suffix.length())
-    return str.compare(str.length() - suffix.length(), suffix.length(), suffix) == 0;
-  else
-    return false;
-}
-
-static std::string tolowercase(const std::string& str)
-{
-  std::string out;
-  for(std::string::const_iterator i = str.begin();  i != str.end(); ++i)
-    out += tolower(*i);
-  return out;
-}
-
-Data::Data(const std::string& filename)
-{
   if (PHYSFS_exists(filename.c_str()))
     {
       if (has_suffix(filename, ".sprite"))
@@ -76,7 +58,7 @@
         {
           if (PHYSFS_exists(filename.c_str()))
             {
-              std::auto_ptr<Action> action(new Action);
+              std::auto_ptr<SpriteAction> action(new SpriteAction());
               action->name   = "default";
               action->speed  = 1.0;
               action->scale  = 1.0f;
@@ -101,7 +83,7 @@
 
       if (PHYSFS_exists(pngfile.c_str()))
         {
-          std::auto_ptr<Action> action(new Action);
+          std::auto_ptr<SpriteAction> action(new SpriteAction);
           action->name   = "default";
           action->speed  = 1.0;
           action->scale  = 1.0f;
@@ -120,14 +102,14 @@
     }
 }
 
-Data::~Data()
+SpriteData::~SpriteData()
 {
   for(Actions::iterator i = actions.begin(); i != actions.end(); ++i)
     delete *i;
 }
 
 void
-Data::parse(const std::string& dir, FileReader& reader)
+SpriteData::parse(const std::string& dir, FileReader& reader)
 {
   std::vector<FileReader> sections = reader.get_sections();
   for(std::vector<FileReader>::iterator i = sections.begin(); i != sections.end(); ++i)
@@ -137,10 +119,10 @@
     throw std::runtime_error("Sprite contains no actions");
 }
 
-Action*
-Data::parse_action(const std::string& dir, FileReader& reader)
+SpriteAction*
+SpriteData::parse_action(const std::string& dir, FileReader& reader)
 {
-  std::auto_ptr<Action> action (new Action);
+  std::auto_ptr<SpriteAction> action (new SpriteAction);
   action->speed = 1.0;
   action->scale = 1.0f;
   action->offset = Vector(0, 0);
@@ -190,21 +172,5 @@
   }
   return action.release();
 }
-
-void
-Data::parse_images(Action* action, const std::string& dir,
-                   FileReader& reader)
-{
-
-}
-
-void
-Data::parse_image_grid(Action* action, const std::string& dir,
-                       FileReader& reader)
-{
-
-}
  
-} // namespace sprite2d
-
 /* EOF */

Modified: trunk/windstille/src/sprite2d/data.hpp
===================================================================
--- trunk/windstille/src/sprite2d/data.hpp	2007-06-20 08:52:44 UTC (rev 1479)
+++ trunk/windstille/src/sprite2d/data.hpp	2007-06-20 16:42:40 UTC (rev 1480)
@@ -31,36 +31,14 @@
 #include <vector>
 #include <GL/glew.h>
 #include <GL/gl.h>
+#include "util.hpp"
 #include "file_reader.hpp"
 #include "math/vector.hpp"
 #include "display/surface.hpp"
 #include "ref.hpp"
 
-namespace sprite2d
+struct SpriteAction
 {
-struct Action;
-
-class Data
-{
-private:
-  void parse(const std::string& dir, FileReader& lisp);
-  
-  Action* parse_action(const std::string& dir, FileReader& reader);
-  void parse_images(Action* action, const std::string& dir, 
-                    FileReader& reader);
-  void parse_image_grid(Action* action, const std::string& dir,
-                        FileReader& reader); 
-
-public:
-  Data(const std::string& filename);
-  virtual ~Data();
-
-  typedef std::vector<Action*> Actions;
-  Actions actions;
-};
-
-struct Action
-{
   typedef std::vector<Surface> Surfaces;
 
   std::string name;
@@ -70,7 +48,19 @@
   Surfaces    surfaces;
 };
 
-}
+class SpriteData
+{
+private:
+  void    parse(const std::string& dir, FileReader& lisp);
+  SpriteAction* parse_action(const std::string& dir, FileReader& reader);
 
+public:
+  SpriteData(const std::string& filename);
+  virtual ~SpriteData();
+
+  typedef std::vector<SpriteAction*> Actions;
+  Actions actions;
+};
+
 #endif
 

Modified: trunk/windstille/src/sprite2d/manager.cpp
===================================================================
--- trunk/windstille/src/sprite2d/manager.cpp	2007-06-20 08:52:44 UTC (rev 1479)
+++ trunk/windstille/src/sprite2d/manager.cpp	2007-06-20 16:42:40 UTC (rev 1480)
@@ -31,21 +31,18 @@
 #include "sprite2d/sprite.hpp"
 #include <iostream>
 
-sprite2d::Manager* sprite2d_manager = 0;
+SpriteManager* sprite2d_manager = 0;
 
-namespace sprite2d
+SpriteManager::SpriteManager()
 {
-
-Manager::Manager()
-{
 }
 
-Manager::~Manager()
+SpriteManager::~SpriteManager()
 {
 }
 
-DataPtr
-Manager::create_data(const std::string& filename)
+SpriteDataPtr
+SpriteManager::create_data(const std::string& filename)
 {
   Datas::iterator i = datas.find(filename);
   if(i != datas.end())
@@ -54,14 +51,14 @@
     }
   else
     {  
-      DataPtr data(new Data(filename));
+      SpriteDataPtr data(new SpriteData(filename));
       datas.insert(std::make_pair(filename, data));
       return data;
     }
 }
 
 void
-Manager::cleanup()
+SpriteManager::cleanup()
 {
   for(Datas::iterator i = datas.begin(); i != datas.end(); ++i)
     {
@@ -72,6 +69,4 @@
     }
 }
 
-} // namespace sprite2d
-
 /* EOF */

Modified: trunk/windstille/src/sprite2d/manager.hpp
===================================================================
--- trunk/windstille/src/sprite2d/manager.hpp	2007-06-20 08:52:44 UTC (rev 1479)
+++ trunk/windstille/src/sprite2d/manager.hpp	2007-06-20 16:42:40 UTC (rev 1480)
@@ -31,31 +31,25 @@
 #include <map>
 #include <boost/shared_ptr.hpp>
 
-namespace sprite2d
-{
-typedef 
+class SpriteData;
+typedef boost::shared_ptr<SpriteData> SpriteDataPtr;
 
-class Data;
-typedef boost::shared_ptr<Data> DataPtr;
-
-class Manager
+class SpriteManager
 {
 public:
-  Manager();
-  ~Manager();
+  SpriteManager();
+  ~SpriteManager();
 
-  DataPtr create_data(const std::string& filename);
+  SpriteDataPtr create_data(const std::string& filename);
   
   /** Removes all cached Sprites that are no longer in use */
   void cleanup();
 private:
-  typedef std::map<std::string, DataPtr> Datas;
+  typedef std::map<std::string, SpriteDataPtr> Datas;
   Datas datas;
 };
 
-}
+extern SpriteManager* sprite2d_manager;
 
-extern sprite2d::Manager* sprite2d_manager;
-
 #endif
 

Modified: trunk/windstille/src/sprite2d/sprite.cpp
===================================================================
--- trunk/windstille/src/sprite2d/sprite.cpp	2007-06-20 08:52:44 UTC (rev 1479)
+++ trunk/windstille/src/sprite2d/sprite.cpp	2007-06-20 16:42:40 UTC (rev 1480)
@@ -57,7 +57,7 @@
   blend_dfactor = GL_ONE_MINUS_SRC_ALPHA;
 }
 
-Sprite::Sprite(const sprite2d::DataPtr data)
+Sprite::Sprite(const SpriteDataPtr data)
   : data(data)
 {
   current_action = data->actions[0];
@@ -85,31 +85,33 @@
     step = -step;
 
   frame = fmodf(frame + current_action->surfaces.size() + step,
-      current_action->surfaces.size());
+                current_action->surfaces.size());
 }
 
 void
 Sprite::set_action(const std::string& name)
 {
-  for(sprite2d::Data::Actions::const_iterator i = data->actions.begin();
-      i != data->actions.end(); ++i) {
-    const sprite2d::Action* action = *i;
-    if(action->name == name) {
-      // FIXME: This should be per-action and not get reset, shouldn't they?
-      current_action = action;
-      pingpong = false;
-      reverse = false;
-      speed = 1.0;
-      frame = 0;
-      vflip = false;
-      alpha = 0.0;
-      scale = current_action->scale;
-      color = Color(1.0f, 1.0f, 1.0f);
-      blend_sfactor = GL_SRC_ALPHA;
-      blend_dfactor = GL_ONE_MINUS_SRC_ALPHA;
-      return;
+  for(SpriteData::Actions::const_iterator i = data->actions.begin();
+      i != data->actions.end(); ++i) 
+    {
+      const SpriteAction* action = *i;
+      if(action->name == name) 
+        {
+          // FIXME: This should be per-action and not get reset, shouldn't they?
+          current_action = action;
+          pingpong = false;
+          reverse  = false;
+          speed    = 1.0;
+          frame    = 0;
+          vflip    = false;
+          alpha    = 0.0;
+          scale    = current_action->scale;
+          color    = Color(1.0f, 1.0f, 1.0f);
+          blend_sfactor = GL_SRC_ALPHA;
+          blend_dfactor = GL_ONE_MINUS_SRC_ALPHA;
+          return;
+        }
     }
-  }
 
   std::ostringstream msg;
   msg << "No action '" << name << "' defined";

Modified: trunk/windstille/src/sprite2d/sprite.hpp
===================================================================
--- trunk/windstille/src/sprite2d/sprite.hpp	2007-06-20 08:52:44 UTC (rev 1479)
+++ trunk/windstille/src/sprite2d/sprite.hpp	2007-06-20 16:42:40 UTC (rev 1480)
@@ -39,17 +39,15 @@
 class DrawingContext;
 class Color;
 
-namespace sprite2d {
-struct Action;
-} 
+struct SpriteAction;
 
 class Sprite
 {
 private:
   /** Pointer to the Sprites data which is shared among all sprites
       with are loaded from the same file */
-  sprite2d::DataPtr data;
-  const sprite2d::Action* current_action;
+  SpriteDataPtr data;
+  const SpriteAction* current_action;
 
   float frame;
   float speed;
@@ -70,7 +68,7 @@
       search for a .png with the same name and use that as a simple
       one-file sprite */
   Sprite(const std::string& filename);
-  Sprite(const sprite2d::DataPtr data);
+  Sprite(const SpriteDataPtr data);
   ~Sprite();
 
   void update(float delta);

Modified: trunk/windstille/src/util.cpp
===================================================================
--- trunk/windstille/src/util.cpp	2007-06-20 08:52:44 UTC (rev 1479)
+++ trunk/windstille/src/util.cpp	2007-06-20 16:42:40 UTC (rev 1480)
@@ -31,4 +31,20 @@
     }
 }
 
+bool has_suffix(const std::string& str, const std::string& suffix)
+{
+  if (str.length() >= suffix.length())
+    return str.compare(str.length() - suffix.length(), suffix.length(), suffix) == 0;
+  else
+    return false;
+}
+
+std::string tolowercase(const std::string& str)
+{
+  std::string out;
+  for(std::string::const_iterator i = str.begin();  i != str.end(); ++i)
+    out += tolower(*i);
+  return out;
+}
+
 /* EOF */

Modified: trunk/windstille/src/util.hpp
===================================================================
--- trunk/windstille/src/util.hpp	2007-06-20 08:52:44 UTC (rev 1479)
+++ trunk/windstille/src/util.hpp	2007-06-20 16:42:40 UTC (rev 1480)
@@ -10,8 +10,14 @@
 
 std::string dirname(const std::string& filename);
 std::string basename(const std::string& filename);
+
+/** Loads a file from \a filename and places its content in \a str
+    FIXME: doesn't use PhysFS */
 void file_to_string(const std::string& filename, std::string& str);
 
+bool has_suffix(const std::string& str, const std::string& suffix);
+std::string tolowercase(const std::string& str);
+
 template<class T>
 std::string to_string(const T& data)
 {

Modified: trunk/windstille/src/windstille_main.cpp
===================================================================
--- trunk/windstille/src/windstille_main.cpp	2007-06-20 08:52:44 UTC (rev 1479)
+++ trunk/windstille/src/windstille_main.cpp	2007-06-20 16:42:40 UTC (rev 1480)
@@ -220,7 +220,7 @@
   texture_manager  = new TextureManager();
   surface_manager  = new SurfaceManager();
   script_manager   = new ScriptManager();
-  sprite2d_manager = new sprite2d::Manager();
+  sprite2d_manager = new SpriteManager();
   sprite3d_manager = new sprite3d::Manager();
 
   script_manager->run_script_file("scripts/windstille.nut");



From grumbel at mail.berlios.de  Wed Jun 20 21:58:49 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 20 Jun 2007 21:58:49 +0200
Subject: [Windstille-commit] r1481 - in trunk/windstille: src src/navigation
	tools
Message-ID: <200706201958.l5KJwnkm009287@sheep.berlios.de>

Author: grumbel
Date: 2007-06-20 21:58:47 +0200 (Wed, 20 Jun 2007)
New Revision: 1481

Added:
   trunk/windstille/src/getter.cpp
   trunk/windstille/src/getter.hpp
Modified:
   trunk/windstille/src/SConscript
   trunk/windstille/src/file_reader.cpp
   trunk/windstille/src/file_reader.hpp
   trunk/windstille/src/file_reader_impl.hpp
   trunk/windstille/src/navigation/navigation_graph.cpp
   trunk/windstille/src/sexpr_file_reader.cpp
   trunk/windstille/tools/bone_export.py
Log:
- added some template mess to FileReader

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-20 16:42:40 UTC (rev 1480)
+++ trunk/windstille/src/SConscript	2007-06-20 19:58:47 UTC (rev 1481)
@@ -63,6 +63,7 @@
 'game_object.cpp',
 'game_session.cpp',
 'globals.cpp',
+'getter.cpp',
 'geometry_test.cpp',
 'graphic_context_state.cpp',
 'grenade.cpp',

Modified: trunk/windstille/src/file_reader.cpp
===================================================================
--- trunk/windstille/src/file_reader.cpp	2007-06-20 16:42:40 UTC (rev 1480)
+++ trunk/windstille/src/file_reader.cpp	2007-06-20 19:58:47 UTC (rev 1481)
@@ -64,7 +64,7 @@
 }
 
 bool
-FileReader::read_int(const char* name, int& value) const
+FileReader::read(const char* name, int& value)
 {
   if (impl.get())
     return impl->read_int(name, value);
@@ -73,7 +73,7 @@
 }
 
 bool
-FileReader::read_float (const char* name, float& value) const
+FileReader::read(const char* name, float& value)
 {
   if (impl.get())
     return impl->read_float(name, value);
@@ -82,7 +82,7 @@
 }
 
 bool
-FileReader::read_bool  (const char* name, bool& value) const
+FileReader::read(const char* name, bool& value)
 {
   if (impl.get())
     return impl->read_bool(name, value);
@@ -91,7 +91,7 @@
 }
 
 bool
-FileReader::read_string(const char* name, std::string& value) const
+FileReader::read(const char* name, std::string& value)
 {
   if (impl.get())
     return impl->read_string(name, value);
@@ -100,43 +100,25 @@
 }
 
 bool
-FileReader::read_vector3(const char* name, Vector3& value) const
+FileReader::read(const char* name, std::vector<int>& value)
 {
   if (impl.get())
-    return impl->read_vector3(name, value);
+    return impl->get(name, value);
   else
     return false;
 }
 
 bool
-FileReader::read_color(const char* name, Color& value) const
+FileReader::read(const char* name, std::vector<bool>&   value)
 {
   if (impl.get())
-    return impl->read_color(name, value);
-  else
-    return false;
-}
-
-bool
-FileReader::read_size  (const char* name, Size& value) const
-{
-  if (impl.get())
-    return impl->read_size(name, value);
-  else
-    return false;
-}
-
-bool
-FileReader::get(const char* name, std::vector<int>& value) const
-{
-  if (impl.get())
     return impl->get(name, value);
   else
-    return false;
+    return false;  
 }
 
 bool
-FileReader::get(const char* name, std::vector<std::string>& value) const
+FileReader::read(const char* name, std::vector<std::string>& value)
 {
   if (impl.get())
     return impl->get(name, value);
@@ -145,7 +127,7 @@
 }
 
 bool
-FileReader::get(const char* name, std::vector<float>& value) const
+FileReader::read(const char* name, std::vector<float>& value)
 {
   if (impl.get())
     return impl->get(name, value);
@@ -154,18 +136,9 @@
 }
 
 bool
-FileReader::read_vector(const char* name, Vector& value) const
+FileReader::read(const char* name, FileReader& reader)
 {
   if (impl.get())
-    return impl->read_vector(name, value);
-  else
-    return false;
-}
-
-bool
-FileReader::read_section(const char* name, FileReader& reader) const
-{
-  if (impl.get())
     return impl->read_section(name, reader);
   else
     return false;
@@ -189,16 +162,8 @@
     return std::vector<FileReader>();
 }
 
-FileReader
-FileReader::read_section(const char* name)   const
-{
-  FileReader reader;
-  read_section(name, reader);
-  return reader;
-}
-
 void
-FileReader::print_unused_warnings(const std::string& title)
+FileReader::print_unused_warnings(const std::string& title) const
 {
   // unimplemented
 }

Modified: trunk/windstille/src/file_reader.hpp
===================================================================
--- trunk/windstille/src/file_reader.hpp	2007-06-20 16:42:40 UTC (rev 1480)
+++ trunk/windstille/src/file_reader.hpp	2007-06-20 19:58:47 UTC (rev 1481)
@@ -22,14 +22,9 @@
 
 #include <string>
 #include <vector>
+#include "getter.hpp"
 #include "sharedptr.hpp"
 
-class Size;
-class Color;
-class Vector;
-class Vector3;
-
-class ResDescriptor;
 class FileReaderImpl;
 
 /** Interface to read name/value pairs out of some kind of file or
@@ -46,22 +41,20 @@
       <groundpiece><pos>...</groundpiece> it would be 'groundpiece' */
   std::string get_name() const;
 
-  bool read_int    (const char* name, int&)           const;
-  bool read_float  (const char* name, float&)         const;
-  bool read_bool   (const char* name, bool&)          const;
-  bool read_string (const char* name, std::string&)   const;
-  bool read_vector3(const char* name, Vector3&)      const;
-  bool read_vector (const char* name, Vector&)    const;
-  bool read_size   (const char* name, Size&)          const;
-  bool read_color  (const char* name, Color&)         const;
-  bool read_section(const char* name, FileReader&)   const;
-  FileReader read_section(const char* name)   const;
+  std::vector<std::string> get_section_names() const;
+  std::vector<FileReader>  get_sections() const;
 
+  /** Generic getter function for non-standard types, see getter.hpp */
+  template<typename T>
+  bool get(const char* name, T& v) {
+    return ::get(*this, name, v);
+  }
+ 
   template<class E, class T>
-  bool read_enum  (const char* name, E& value, T enum2string) const
+  bool get(const char* name, E& value, T enum2string)
   {
     std::string str;
-    if (read_string(name, str))
+    if (get(name, str))
       {
         value = enum2string(str);
         return true;
@@ -70,24 +63,21 @@
     return false;
   }
 
-  bool get(const char* name, std::vector<int>&   v) const;
-  bool get(const char* name, std::vector<float>& v) const;
-  bool get(const char* name, std::vector<std::string>& v) const;
+  // Primitive types
+  // FIXME: Is there any nice way to not use two different names?
+  bool read(const char* name, FileReader& v);
 
-  bool get(const char* name, FileReader& v) { return read_section(name, v); }
-  bool get(const char* name, int&   v) { return read_int(name, v); }
-  bool get(const char* name, float& v) { return read_float(name, v); }
-  bool get(const char* name, bool& v) { return read_bool(name, v); }
-  bool get(const char* name, std::string& v) { return read_string(name, v); }
-  bool get(const char* name, Vector3& v) { return read_vector3(name, v); }
-  bool get(const char* name, Vector& v) { return read_vector(name, v); }
-  bool get(const char* name, Size& v) { return read_size(name, v); }
-  bool get(const char* name, Color& v) { return read_color(name, v); } 
+  bool read(const char* name, int&   v);
+  bool read(const char* name, float& v);
+  bool read(const char* name, bool& v);
+  bool read(const char* name, std::string& v);
 
-  std::vector<std::string> get_section_names() const;
-  std::vector<FileReader>  get_sections() const;
+  bool read(const char* name, std::vector<bool>&   v);
+  bool read(const char* name, std::vector<int>&   v);
+  bool read(const char* name, std::vector<float>& v);
+  bool read(const char* name, std::vector<std::string>& v);
 
-  void print_unused_warnings(const std::string& title);
+  void print_unused_warnings(const std::string& title) const;
 
 private:
   SharedPtr<FileReaderImpl> impl;

Modified: trunk/windstille/src/file_reader_impl.hpp
===================================================================
--- trunk/windstille/src/file_reader_impl.hpp	2007-06-20 16:42:40 UTC (rev 1480)
+++ trunk/windstille/src/file_reader_impl.hpp	2007-06-20 19:58:47 UTC (rev 1481)
@@ -39,18 +39,17 @@
   virtual ~FileReaderImpl() {}
 
   virtual std::string get_name()                           const =0;
+
+  virtual bool read_bool  (const char* name, bool&)        const =0;
   virtual bool read_int   (const char* name, int&)         const =0;
   virtual bool read_float (const char* name, float&)       const =0;
-  virtual bool read_bool  (const char* name, bool&)        const =0;
   virtual bool read_string(const char* name, std::string&) const =0;
-  virtual bool read_vector3(const char* name, Vector3&)    const =0;
-  virtual bool read_size  (const char* name, Size&)        const =0;
-  virtual bool read_vector(const char* name, Vector&)      const =0;
-  virtual bool read_color (const char* name, Color&)       const =0;
 
+  virtual bool get(const char* name, std::vector<bool>&   v) const =0;
   virtual bool get(const char* name, std::vector<int>&   v) const =0;
   virtual bool get(const char* name, std::vector<float>& v) const =0;
   virtual bool get(const char* name, std::vector<std::string>& v) const =0;
+
   virtual bool read_section(const char* name, FileReader&)   const =0;
   virtual std::vector<FileReader> get_sections() const =0;
   virtual std::vector<std::string> get_section_names() const =0;

Added: trunk/windstille/src/getter.cpp
===================================================================
--- trunk/windstille/src/getter.cpp	2007-06-20 16:42:40 UTC (rev 1480)
+++ trunk/windstille/src/getter.cpp	2007-06-20 19:58:47 UTC (rev 1481)
@@ -0,0 +1,116 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include "math/vector.hpp"
+#include "math/vector3.hpp"
+#include "math/quaternion.hpp"
+#include "math/matrix.hpp"
+#include "color.hpp"
+#include "file_reader.hpp"
+#include "getter.hpp"
+
+bool get(FileReader& reader, const char* name, Vector&  value)
+{
+  std::vector<float> floats;
+  if (reader.get(name, floats) && floats.size() == 2) {
+    value.x = floats[0];
+    value.y = floats[1];
+    return true;
+  } else {
+    return false;
+  }  
+}
+
+bool get(FileReader& reader, const char* name, Vector3& value)
+{
+  std::vector<float> floats;
+  if (reader.get(name, floats) && floats.size() == 3) {
+    value.x = floats[0];
+    value.y = floats[1];
+    value.z = floats[2];
+    return true;
+  } else {
+    return false;
+  }
+}
+
+bool get(FileReader& reader, const char* name, Quaternion& value)
+{
+  std::vector<float> floats;
+  if (reader.get(name, floats) && floats.size() == 4) {
+    value.x = floats[0];
+    value.y = floats[1];
+    value.z = floats[2];
+    value.w = floats[3];
+    return true;
+  } else {
+    return false;
+  }
+}
+
+bool get(FileReader& reader, const char* name, Color& value)
+{
+  std::vector<float> floats;
+  if (reader.get(name, floats)) {
+    if (floats.size() == 3)
+      {
+        value.r = floats[0];
+        value.g = floats[1];
+        value.b = floats[2];
+        value.a = 1.0f;
+        return true;
+      }
+    else if (floats.size() == 4)
+      {
+        value.r = floats[0];
+        value.b = floats[1];
+        value.g = floats[2];
+        value.a = floats[3];
+        return true;
+      }
+    else
+      {
+        return false;
+      }
+  } else {
+    return false;
+  } 
+}
+
+// Getters for primitive types
+// FIXME: Ugly, maybe there is a better way then to have different read/get names for the function
+bool get(FileReader& reader, const char* name, FileReader& v) { return reader.read(name, v); }
+
+bool get(FileReader& reader, const char* name, int&   v) { return reader.read(name, v); }
+bool get(FileReader& reader, const char* name, float& v) { return reader.read(name, v); }
+bool get(FileReader& reader, const char* name, bool& v) { return reader.read(name, v); }
+bool get(FileReader& reader, const char* name, std::string& v) { return reader.read(name, v); }
+
+bool get(FileReader& reader, const char* name, std::vector<bool>&   v) { return reader.read(name, v); }
+bool get(FileReader& reader, const char* name, std::vector<int>&   v) { return reader.read(name, v); }
+bool get(FileReader& reader, const char* name, std::vector<float>& v) { return reader.read(name, v); }
+bool get(FileReader& reader, const char* name, std::vector<std::string>& v) { return reader.read(name, v); }
+
+/* EOF */


Property changes on: trunk/windstille/src/getter.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/getter.hpp
===================================================================
--- trunk/windstille/src/getter.hpp	2007-06-20 16:42:40 UTC (rev 1480)
+++ trunk/windstille/src/getter.hpp	2007-06-20 19:58:47 UTC (rev 1481)
@@ -0,0 +1,57 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_WINDSTILLE_GETTER_HPP
+#define HEADER_WINDSTILLE_GETTER_HPP
+
+#include "file_reader.hpp"
+
+class FileReader;
+class Quaternion;
+class Color;
+class Vector;
+class Vector3;
+
+bool get(FileReader& reader, const char* name, Quaternion& value);
+bool get(FileReader& reader, const char* name, Color& value);
+bool get(FileReader& reader, const char* name, Vector&  value);
+bool get(FileReader& reader, const char* name, Vector3& value);
+
+// Primitive types
+bool get(FileReader& reader, const char* name, FileReader& v);
+
+bool get(FileReader& reader, const char* name, int&   v);
+bool get(FileReader& reader, const char* name, float& v);
+bool get(FileReader& reader, const char* name, bool& v);
+bool get(FileReader& reader, const char* name, std::string& v);
+
+bool get(FileReader& reader, const char* name, std::vector<bool>&   v);
+bool get(FileReader& reader, const char* name, std::vector<int>&   v); 
+bool get(FileReader& reader, const char* name, std::vector<float>& v);
+bool get(FileReader& reader, const char* name, std::vector<std::string>& v);
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/getter.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/navigation/navigation_graph.cpp
===================================================================
--- trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-20 16:42:40 UTC (rev 1480)
+++ trunk/windstille/src/navigation/navigation_graph.cpp	2007-06-20 19:58:47 UTC (rev 1481)
@@ -250,7 +250,7 @@
   std::map<int, Node*> id2ptr;
 
   FileReader nodes_group_reader;
-  if (reader.read_section("nodes", nodes_group_reader))
+  if (reader.get("nodes", nodes_group_reader))
     {
       std::vector<FileReader> nodes_reader = nodes_group_reader.get_sections();
       for(std::vector<FileReader>::iterator i = nodes_reader.begin(); i != nodes_reader.end(); ++i)
@@ -277,7 +277,7 @@
     }
   
   FileReader segments_group_reader;
-  if (reader.read_section("segments", segments_group_reader))
+  if (reader.get("segments", segments_group_reader))
     {
       std::vector<FileReader> segments_reader = segments_group_reader.get_sections();
       for(std::vector<FileReader>::iterator i = segments_reader.begin(); i != segments_reader.end(); ++i)

Modified: trunk/windstille/src/sexpr_file_reader.cpp
===================================================================
--- trunk/windstille/src/sexpr_file_reader.cpp	2007-06-20 16:42:40 UTC (rev 1480)
+++ trunk/windstille/src/sexpr_file_reader.cpp	2007-06-20 19:58:47 UTC (rev 1481)
@@ -145,73 +145,16 @@
     return false;
   }
 
-  bool read_vector3(const char* name, Vector3& v) const
+  bool get(const char* name, std::vector<int>&   v) const
   {
     lisp::Lisp* sub = get_subsection(name);
-    if (sub && sub->get_list_size() == 4)
-      {
-        lisp::get(sub->get_list_elem(1), v.x);
-        lisp::get(sub->get_list_elem(2), v.y);
-        lisp::get(sub->get_list_elem(3), v.z);
-        return true;
-      }    
-    return false;
-  }
-
-  bool read_size(const char* name, Size& v) const
-  {
-    lisp::Lisp* sub = get_subsection(name);
-    if (sub && sub->get_list_size() == 3)
-      {
-        v.width  = sub->get_list_elem(1)->get_int();
-        v.height = sub->get_list_elem(2)->get_int();
-        return true;
-      }    
-    return false;
-  }
-
-  bool read_vector(const char* name, Vector& v) const
-  {
-    lisp::Lisp* sub = get_subsection(name);
-    if (sub && sub->get_list_size() == 3)
-      {
-        lisp::get(sub->get_list_elem(1), v.x);
-        lisp::get(sub->get_list_elem(2), v.y);
-        return true;
-      }    
-    return false;
-  }
-
-  bool read_color (const char* name, Color& v) const
-  {
-    lisp::Lisp* sub = get_subsection(name);
     if (sub)
-      {
-        if (sub->get_list_size() == 5)
-          {
-            lisp::get(sub->get_list_elem(1), v.r);
-            lisp::get(sub->get_list_elem(2), v.g);
-            lisp::get(sub->get_list_elem(3), v.b);
-            lisp::get(sub->get_list_elem(4), v.a);
-            return true;
-          }
-        else if (sub->get_list_size() == 4)
-          {
-            lisp::get(sub->get_list_elem(1), v.r);
-            lisp::get(sub->get_list_elem(2), v.g);
-            lisp::get(sub->get_list_elem(3), v.b);
-            v.a = 1.0f;
-            return true;
-          }
-        else
-          {
-            return false;
-          }
-      }
-    return false;
+      return property_get(sub, v);
+    else 
+      return false;
   }
 
-  bool get(const char* name, std::vector<int>&   v) const
+  bool get(const char* name, std::vector<bool>&   v) const
   {
     lisp::Lisp* sub = get_subsection(name);
     if (sub)

Modified: trunk/windstille/tools/bone_export.py
===================================================================
--- trunk/windstille/tools/bone_export.py	2007-06-20 16:42:40 UTC (rev 1480)
+++ trunk/windstille/tools/bone_export.py	2007-06-20 19:58:47 UTC (rev 1481)
@@ -1,25 +1,73 @@
+import os
 import Blender
 import Blender.Armature
 
+os.system('clear')
 arms = Blender.Armature.Get()
-print "####################################"
-for arm in arms.values():
-	print "Armature: %s" % arm.name
+print ";;;;;;;;;;;;; Start of File ;;;;;;;;;;;;;;;;"
+
+def vec2str(vec):
+	return "%f %f %f" % (vec.x,vec.y,vec.z)
+
+def quat2str(quat):
+	return "%f %f %f %f" % (quat.x, quat.y, quat.z, quat.w)
+
+def matrix2str(indent, m):
+	return          ("%9f %9f %9f\n" % (m[0][0], m[0][1], m[0][2])) + \
+           indent + ("%9f %9f %9f\n" % (m[1][0], m[1][1], m[1][2])) + \
+           indent + ("%9f %9f %9f" % (m[2][0], m[2][1], m[2][2]))
+
+def list2str(lst):
+	str = ""
+	for i in lst:
+		str += " \"%s\"" % i
+	return str
+
+for arm in arms.values():	
+	print "(armature"
+	print "  (name \"%s\")" % (arm.name,)
+	print "  (bones "
+	
 	for bone in arm.bones.values():
-		print "  Bone: %s" % bone
-		print "  BoneSpace:"
-		print bone.matrix['BONESPACE']
-		print
-		print "  ArmatureSpace:"
-		print bone.matrix['ARMATURESPACE']
-		print
-	print
+		if bone.name[:3] == "IK_": # ignore helper bones
+			print "    ;; ignoring bone: %s" % bone.name
+			print
+		else:
+			if bone.parent:
+				print "    (bone"
+			else:
+				print "    (bone ;; Parentless bone, aka Master bone XXXXXXXXXXXXXXXXXXXXXXXXXXXX"
+				
+			print "      (name      \"%s\")" % bone.name
+			
+			print "      (children %s)" % list2str(map(lambda b: b.name, bone.children))
+							
+			# If a bone lacks parent its head is in armature space,
+			# else in local bonespace
+			if bone.parent:
+				print "      (parent    \"%s\")" % bone.parent.name
+				print "      (head      %s)" % (vec2str(bone.head['BONESPACE']),)
+			else:
+				print "      (parent )"
+				print "      (head      %s)" % (vec2str(bone.head['ARMATURESPACE']),)				
+			
+			print "      (length    %s)" % bone.length
+			# print "      (matrix   %s)" % matrix2str(" "*16, bone.matrix['BONESPACE'])
+			print "      (quat      %s)" % quat2str(bone.matrix['BONESPACE'].toQuat())
+			# print "###  BoneSpace:"
+			# print bone.matrix['BONESPACE']
+			# print
+			# print "  ArmatureSpace:"
+			#  print bone.matrix['ARMATURESPACE']
+			print "     )\n"
 
-mesh = Blender.NMesh.GetRaw("Cube.001")
-print mesh.faces[0].v[0].index
+	print "  ) ;; bones"
+print " ) ;; armature"
 
-for v in mesh.verts:
-	mesh.getVertexInfluences(v.index)
+# mesh = Blender.NMesh.GetRaw("Cube.001")
+# print mesh.faces[0].v[0].index
+
+# for v in mesh.verts:
+#	mesh.getVertexInfluences(v.index)
 	
 # EOF #
-



From grumbel at mail.berlios.de  Wed Jun 20 23:56:14 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Wed, 20 Jun 2007 23:56:14 +0200
Subject: [Windstille-commit] r1482 - in trunk/windstille: . tools
Message-ID: <200706202156.l5KLuEU5021903@sheep.berlios.de>

Author: grumbel
Date: 2007-06-20 23:56:14 +0200 (Wed, 20 Jun 2007)
New Revision: 1482

Modified:
   trunk/windstille/TODO
   trunk/windstille/tools/bone_export.py
Log:
- some work on the bone exporter

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-20 19:58:47 UTC (rev 1481)
+++ trunk/windstille/TODO	2007-06-20 21:56:14 UTC (rev 1482)
@@ -48,5 +48,6 @@
   shouldn't be persistent unless told so
 - add line numbers to error messages from lisp
 - fix memory leak in SExprFileReader
+- use non-euler angles in the model viewer
 
 # EOF #

Modified: trunk/windstille/tools/bone_export.py
===================================================================
--- trunk/windstille/tools/bone_export.py	2007-06-20 19:58:47 UTC (rev 1481)
+++ trunk/windstille/tools/bone_export.py	2007-06-20 21:56:14 UTC (rev 1482)
@@ -1,73 +1,78 @@
-import os
 import Blender
 import Blender.Armature
 
-os.system('clear')
 arms = Blender.Armature.Get()
-print ";;;;;;;;;;;;; Start of File ;;;;;;;;;;;;;;;;"
 
 def vec2str(vec):
-	return "%f %f %f" % (vec.x,vec.y,vec.z)
+    return "%f %f %f" % (vec.x,vec.y,vec.z)
 
+def euler2str(euler):
+    return "%f %f %f" % (euler.x, euler.y, euler.z)
+
 def quat2str(quat):
-	return "%f %f %f %f" % (quat.x, quat.y, quat.z, quat.w)
+    return "%f %f %f %f" % (quat.x, quat.y, quat.z, quat.w)
 
 def matrix2str(indent, m):
-	return          ("%9f %9f %9f\n" % (m[0][0], m[0][1], m[0][2])) + \
+        return          ("%9f %9f %9f\n" % (m[0][0], m[0][1], m[0][2])) + \
            indent + ("%9f %9f %9f\n" % (m[1][0], m[1][1], m[1][2])) + \
            indent + ("%9f %9f %9f" % (m[2][0], m[2][1], m[2][2]))
 
 def list2str(lst):
-	str = ""
-	for i in lst:
-		str += " \"%s\"" % i
-	return str
+    str = ""
+    for i in lst:
+        str += " \"%s\"" % i
+    return str
 
-for arm in arms.values():	
-	print "(armature"
-	print "  (name \"%s\")" % (arm.name,)
-	print "  (bones "
-	
-	for bone in arm.bones.values():
-		if bone.name[:3] == "IK_": # ignore helper bones
-			print "    ;; ignoring bone: %s" % bone.name
-			print
-		else:
-			if bone.parent:
-				print "    (bone"
-			else:
-				print "    (bone ;; Parentless bone, aka Master bone XXXXXXXXXXXXXXXXXXXXXXXXXXXX"
-				
-			print "      (name      \"%s\")" % bone.name
-			
-			print "      (children %s)" % list2str(map(lambda b: b.name, bone.children))
-							
-			# If a bone lacks parent its head is in armature space,
-			# else in local bonespace
-			if bone.parent:
-				print "      (parent    \"%s\")" % bone.parent.name
-				print "      (head      %s)" % (vec2str(bone.head['BONESPACE']),)
-			else:
-				print "      (parent )"
-				print "      (head      %s)" % (vec2str(bone.head['ARMATURESPACE']),)				
-			
-			print "      (length    %s)" % bone.length
-			# print "      (matrix   %s)" % matrix2str(" "*16, bone.matrix['BONESPACE'])
-			print "      (quat      %s)" % quat2str(bone.matrix['BONESPACE'].toQuat())
-			# print "###  BoneSpace:"
-			# print bone.matrix['BONESPACE']
-			# print
-			# print "  ArmatureSpace:"
-			#  print bone.matrix['ARMATURESPACE']
-			print "     )\n"
+def export_armature(out, armature):
+    out.write(";; -*- scheme -*-\n")
+    out.write("(armature\n")
+    out.write("  (name \"%s\")\n" % armature.name)
+    out.write("  (bones\n")
 
-	print "  ) ;; bones"
-print " ) ;; armature"
+    for bone in armature.bones.values():
+        if bone.name[:3] == "IK_": # ignore helper bones
+            out.write("    ;; ignoring bone: %s\n" % bone.name)
+            out.write("\n")
+        else:
+            if bone.parent:
+                out.write("    (bone\n")
+            else:
+                out.write("    (bone ;; a root bone\n")
 
-# mesh = Blender.NMesh.GetRaw("Cube.001")
-# print mesh.faces[0].v[0].index
+            out.write("      (name      \"%s\")\n" % bone.name)
 
-# for v in mesh.verts:
-#	mesh.getVertexInfluences(v.index)
-	
+            out.write("      (children %s)\n" % list2str(map(lambda b: b.name, bone.children)))
+
+            # If a bone lacks parent its head is in armature space,
+            # else in local bonespace
+            if bone.parent:
+                out.write("      (parent    \"%s\")\n" % bone.parent.name)
+                out.write("      (head      %s)\n" % (vec2str(bone.head['BONESPACE']),))
+            else:
+                out.write("      (parent )\n")
+                out.write("      (head      %s)\n" % (vec2str(bone.head['ARMATURESPACE']),))
+
+            out.write("      (length    %s)\n" % bone.length)
+            out.write("      (matrix   %s)\n" % matrix2str(" "*16, bone.matrix['BONESPACE']))
+            out.write("      (quat      %s)\n" % quat2str(bone.matrix['BONESPACE'].toQuat()))
+            out.write("      (euler     %s)\n" % euler2str(bone.matrix['BONESPACE'].toEuler()))
+            # out.write("###  BoneSpace:"
+            # out.write(bone.matrix['BONESPACE']
+            # print
+            # out.write("  ArmatureSpace:"
+            #  out.write(bone.matrix['ARMATURESPACE']
+            out.write("     )\n\n")
+    out.write("  ) ;; bones\n")
+    out.write(" ) ;; armature\n")
+
+print "Windstille Bone Exporter:"
+for armature in arms.values():
+    filename = "/tmp/bone-%s.scm" % armature.name
+    out = file(filename, "w")
+    print "  - exporting to '%s'..." % filename,
+    export_armature(out, armature)
+    out.close()
+    print "done"
+print
+
 # EOF #



From grumbel at mail.berlios.de  Thu Jun 21 00:25:53 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 21 Jun 2007 00:25:53 +0200
Subject: [Windstille-commit] r1483 - in trunk/windstille/src: . armature
Message-ID: <200706202225.l5KMPrTt025144@sheep.berlios.de>

Author: grumbel
Date: 2007-06-21 00:25:53 +0200 (Thu, 21 Jun 2007)
New Revision: 1483

Added:
   trunk/windstille/src/armature/
   trunk/windstille/src/armature/armature.cpp
   trunk/windstille/src/armature/armature.hpp
   trunk/windstille/src/armature/bone.cpp
   trunk/windstille/src/armature/bone.hpp
Modified:
   trunk/windstille/src/SConscript
Log:
- some armature parsing code

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-20 21:56:14 UTC (rev 1482)
+++ trunk/windstille/src/SConscript	2007-06-20 22:25:53 UTC (rev 1483)
@@ -42,6 +42,8 @@
 # env['ENV']['LSBCC_SHAREDLIBS'] = 'png2:SDL:SDL_image:vorbis:ogg:openal:physfs'
 
 env.Program('../windstille', [
+'armature/armature.cpp',
+'armature/bone.cpp',
 'baby_xml.cpp',
 'blitter.cpp',
 'box.cpp',

Added: trunk/windstille/src/armature/armature.cpp
===================================================================
--- trunk/windstille/src/armature/armature.cpp	2007-06-20 21:56:14 UTC (rev 1482)
+++ trunk/windstille/src/armature/armature.cpp	2007-06-20 22:25:53 UTC (rev 1483)
@@ -0,0 +1,69 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include <iostream>
+#include <stdexcept>
+#include "armature.hpp"
+
+Armature::Armature(FileReader& reader)
+{
+  parse(reader);
+}
+
+void
+Armature::parse(FileReader& reader)
+{
+  if (reader.get_name() != "armature")
+    {
+      throw std::runtime_error("Not an armature file: " + reader.get_name());
+    }
+  else
+    {
+      reader.get("name", name);
+      
+      FileReader bones_section;
+      reader.get("bones", bones_section);
+
+      std::vector<FileReader> bone_sections = bones_section.get_sections();
+      for(std::vector<FileReader>::iterator i = bone_sections.begin(); i != bone_sections.end(); ++i)
+        {
+          if (i->get_name() == "bone")
+            {
+              Bone bone;
+              i->get("name",     bone.name);
+              i->get("children", bone.children);
+              i->get("length",   bone.length);
+              i->get("quat",     bone.quat);
+              i->get("head",     bone.head);
+            }
+          else
+            {
+              std::cout << "Armature: unknown tag: " << i->get_name() << std::endl;
+            }
+        }
+    }
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/armature/armature.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/armature/armature.hpp
===================================================================
--- trunk/windstille/src/armature/armature.hpp	2007-06-20 21:56:14 UTC (rev 1482)
+++ trunk/windstille/src/armature/armature.hpp	2007-06-20 22:25:53 UTC (rev 1483)
@@ -0,0 +1,52 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_ARMATURE_HPP
+#define HEADER_ARMATURE_HPP
+
+#include <vector>
+#include "bone.hpp"
+#include "file_reader.hpp"
+
+/** */
+class Armature
+{
+private:
+  std::string name;
+  typedef std::vector<Bone> Bones;
+  Bones bones;
+public:
+  Armature(FileReader& reader);
+  ~Armature();
+  
+  void parse(FileReader& reader);
+private:
+  Armature (const Armature&);
+  Armature& operator= (const Armature&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/armature/armature.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/armature/bone.cpp
===================================================================
--- trunk/windstille/src/armature/bone.cpp	2007-06-20 21:56:14 UTC (rev 1482)
+++ trunk/windstille/src/armature/bone.cpp	2007-06-20 22:25:53 UTC (rev 1483)
@@ -0,0 +1,36 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include "bone.hpp"
+
+Bone::Bone()
+{
+}
+
+Bone::~Bone()
+{
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/armature/bone.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/armature/bone.hpp
===================================================================
--- trunk/windstille/src/armature/bone.hpp	2007-06-20 21:56:14 UTC (rev 1482)
+++ trunk/windstille/src/armature/bone.hpp	2007-06-20 22:25:53 UTC (rev 1483)
@@ -0,0 +1,55 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_SKELETON_BONE_HPP
+#define HEADER_SKELETON_BONE_HPP
+
+#include <string>
+#include <vector>
+#include "math/quaternion.hpp"
+#include "math/vector3.hpp"
+
+/** */
+class Bone
+{
+private:
+public:
+  std::string name;
+  std::vector<std::string> children;
+  float      length;
+  Quaternion quat;
+  Vector3    head;
+  
+  Bone();
+  ~Bone();
+
+private:
+  Bone (const Bone&);
+  Bone& operator= (const Bone&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/armature/bone.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native



From grumbel at mail.berlios.de  Thu Jun 21 04:00:53 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 21 Jun 2007 04:00:53 +0200
Subject: [Windstille-commit] r1484 - in trunk/windstille: data src
	src/armature src/math tools
Message-ID: <200706210200.l5L20rxD018845@sheep.berlios.de>

Author: grumbel
Date: 2007-06-21 04:00:52 +0200 (Thu, 21 Jun 2007)
New Revision: 1484

Added:
   trunk/windstille/data/armature.arm
   trunk/windstille/src/armature_test.cpp
   trunk/windstille/src/armature_test.hpp
Modified:
   trunk/windstille/src/SConscript
   trunk/windstille/src/armature/armature.cpp
   trunk/windstille/src/armature/armature.hpp
   trunk/windstille/src/armature/bone.cpp
   trunk/windstille/src/armature/bone.hpp
   trunk/windstille/src/geometry_test.cpp
   trunk/windstille/src/math/matrix.cpp
   trunk/windstille/src/math/matrix.hpp
   trunk/windstille/src/math/vector3.hpp
   trunk/windstille/src/menu_manager.cpp
   trunk/windstille/src/menu_manager.hpp
   trunk/windstille/src/navigation_test.cpp
   trunk/windstille/tools/bone_export.py
Log:
- some armature testing code, obviously not working yet


Added: trunk/windstille/data/armature.arm
===================================================================
--- trunk/windstille/data/armature.arm	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/data/armature.arm	2007-06-21 02:00:52 UTC (rev 1484)
@@ -0,0 +1,495 @@
+;; -*- scheme -*-
+(armature
+  (name "Armature")
+  (bones
+    (bone
+      (name      "LegNull.L")
+      (children )
+      (parent    "Lower Leg.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    19.4823303223)
+      (matrix    0.999972  0.005368  0.005170
+                -0.007122  0.892687  0.450621
+                -0.002196 -0.450645  0.892701)
+      (quat      0.231616 -0.001893 0.003210 0.972800)
+      (euler     26.783907 -0.296202 0.307589)
+     )
+
+    (bone
+      (name      "Hip.R")
+      (children  "Upper Leg.R")
+      (parent    "Base")
+      (head      0.040620 -0.025407 0.039311)
+      (length    27.6306285858)
+      (matrix    0.464598  0.621588  0.630696
+                 0.637704 -0.729017  0.248729
+                 0.614396  0.286638 -0.735090)
+      (quat      -0.855673 -0.367924 -0.363776 0.011077)
+      (euler     161.305908 -39.101467 53.224209)
+     )
+
+    (bone
+      (name      "Foot.L")
+      (children  "Toes.L")
+      (parent    "Lower Leg.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    25.8882045746)
+      (matrix    0.906031  0.404751  0.123628
+                -0.132580  0.548869 -0.825327
+                -0.401908  0.731382  0.550955)
+      (quat      -0.448945 -0.151561 0.154963 0.866870)
+      (euler     -56.274559 -7.101538 24.071741)
+     )
+
+    (bone
+      (name      "Upper Arm.L")
+      (children  "Forearm.L")
+      (parent    "Shoulder.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    34.0862197876)
+      (matrix    0.910775 -0.272327  0.310365
+                 0.149809  0.918392  0.366215
+                -0.384766 -0.287044  0.877246)
+      (quat      0.169659 -0.180534 -0.109634 0.962602)
+      (euler     22.658556 -18.081205 -16.646954)
+     )
+
+    (bone
+      (name      "Belly")
+      (children )
+      (parent    "Base")
+      (head      0.000000 -0.023287 0.366125)
+      (length    22.6078624725)
+      (matrix    1.000000  0.000000  0.000000
+                 0.000000 -0.210548  0.977584
+                 0.000000 -0.977584 -0.210548)
+      (quat      0.777994 0.000000 0.000000 0.628272)
+      (euler     102.154457 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Upper Arm.R")
+      (children  "Forearm.R")
+      (parent    "Shoulder.R")
+      (head      0.000000 0.000000 -0.000000)
+      (length    34.0863990784)
+      (matrix    0.910775  0.272328 -0.310364
+                -0.149811  0.918392  0.366214
+                 0.384766 -0.287042  0.877246)
+      (quat      0.169659 0.180534 0.109635 0.962602)
+      (euler     22.658512 18.081173 16.647051)
+     )
+
+    (bone
+      (name      "Foot.R")
+      (children  "Toes.R")
+      (parent    "Lower Leg.R")
+      (head      0.000000 0.000000 0.000000)
+      (length    25.8882312775)
+      (matrix    0.906031 -0.404752 -0.123628
+                 0.132580  0.548869 -0.825328
+                 0.401909  0.731382  0.550954)
+      (quat      -0.448946 0.151562 -0.154963 0.866870)
+      (euler     -56.274597 7.101557 -24.071774)
+     )
+
+    (bone
+      (name      "Hip.L")
+      (children  "Upper Leg.L")
+      (parent    "Base")
+      (head      -0.039261 -0.025407 0.039311)
+      (length    27.6306190491)
+      (matrix    0.464597 -0.621588 -0.630696
+                -0.637704 -0.729017  0.248730
+                -0.614396  0.286638 -0.735089)
+      (quat      -0.855672 0.367926 0.363776 0.011075)
+      (euler     161.305908 39.101479 -53.224247)
+     )
+
+    (bone
+      (name      "LegNull.R")
+      (children )
+      (parent    "Lower Leg.R")
+      (head      0.000000 0.000000 0.000000)
+      (length    19.4823417664)
+      (matrix    0.999972 -0.005368 -0.005170
+                 0.007122  0.892687  0.450622
+                 0.002196 -0.450646  0.892700)
+      (quat      0.231617 0.001893 -0.003210 0.972800)
+      (euler     26.783953 0.296212 -0.307584)
+     )
+
+    (bone
+      (name      "Neck")
+      (children  "Head")
+      (parent    "Shoulders")
+      (head      0.000000 -0.000000 -0.000000)
+      (length    16.9650382996)
+      (matrix    1.000000  0.000000  0.000000
+                 0.000000  0.779716  0.626133
+                 0.000000 -0.626133  0.779716)
+      (quat      0.331876 0.000000 0.000000 0.943323)
+      (euler     38.765385 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Hip")
+      (children  "Body")
+      (parent    "Base")
+      (head      0.000000 0.003058 0.001977)
+      (length    23.6622543335)
+      (matrix    1.000000  0.000000  0.000000
+                 0.000000  0.997063  0.076591
+                 0.000000 -0.076591  0.997063)
+      (quat      0.038324 0.000000 0.000000 0.999265)
+      (euler     4.392665 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Shoulders")
+      (children  "Shoulder.R" "Neck" "Shoulder.L")
+      (parent    "Body")
+      (head      0.000000 0.000000 -0.000000)
+      (length    17.489074707)
+      (matrix    1.000000  0.000000  0.000000
+                 0.000000  0.999747  0.022513
+                 0.000000 -0.022513  0.999747)
+      (quat      0.011257 0.000000 0.000000 0.999937)
+      (euler     1.289991 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Shoulder.L")
+      (children  "Upper Arm.L")
+      (parent    "Shoulders")
+      (head      -0.133504 0.016665 -0.103217)
+      (length    30.0338306427)
+      (matrix   -0.211033 -0.390486 -0.896095
+                -0.881235 -0.320670  0.347270
+                -0.422954  0.862955 -0.276438)
+      (quat      -0.588658 0.540093 0.560193 0.219009)
+      (euler     -51.479073 116.350624 61.611572)
+     )
+
+    (bone
+      (name      "FingerTips.L")
+      (children )
+      (parent    "Fingers.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    6.92211341858)
+      (matrix    0.972665 -0.148898 -0.178189
+                 0.118982  0.978544 -0.168213
+                 0.199413  0.142414  0.969512)
+      (quat      -0.078438 0.095350 -0.067644 0.990040)
+      (euler     -9.843002 10.264314 -8.703428)
+     )
+
+    (bone ;; a root bone
+      (name      "Base")
+      (children  "Belly" "Hip.R" "Hip.L" "Hip")
+      (parent )
+      (head      -0.134862 -0.098326 -1.250145)
+      (length    14.4880990982)
+      (matrix    1.000000  0.000000  0.000000
+                 0.000000 -0.011341  0.999936
+                 0.000000 -0.999936 -0.011341)
+      (quat      0.711105 0.000000 0.000000 0.703086)
+      (euler     90.649788 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "FingerTips.R")
+      (children )
+      (parent    "Fingers.R")
+      (head      0.000000 0.000000 -0.000000)
+      (length    7.42318964005)
+      (matrix    0.983139  0.129103  0.129499
+                -0.114041  0.986481 -0.117684
+                -0.142942  0.100931  0.984571)
+      (quat      -0.054969 -0.068504 0.061137 0.994257)
+      (euler     -6.816104 -7.440645 7.481118)
+     )
+
+    (bone
+      (name      "Shoulder.R")
+      (children  "Upper Arm.R")
+      (parent    "Shoulders")
+      (head      0.134862 0.016665 -0.103217)
+      (length    30.0339851379)
+      (matrix   -0.211032  0.390486  0.896095
+                 0.881236 -0.320668  0.347269
+                 0.422952  0.862956 -0.276439)
+      (quat      -0.588658 -0.540093 -0.560192 0.219010)
+      (euler     -51.478905 -116.350578 -61.611633)
+     )
+
+    (bone
+      (name      "Body")
+      (children  "Shoulders")
+      (parent    "Hip")
+      (head      0.000000 -0.000000 0.000000)
+      (length    23.4960784912)
+      (matrix    1.000000  0.000000  0.000000
+                 0.000000  0.989207 -0.146523
+                 0.000000  0.146523  0.989207)
+      (quat      -0.073460 0.000000 0.000000 0.997298)
+      (euler     -8.425456 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Toes.R")
+      (children )
+      (parent    "Foot.R")
+      (head      0.000000 0.000000 -0.000000)
+      (length    14.4431037903)
+      (matrix   -0.908818 -0.133897 -0.395123
+                 0.133896  0.803379 -0.580218
+                 0.395123 -0.580218 -0.712197)
+      (quat      -0.000000 0.925256 -0.313545 0.213521)
+      (euler     39.169296 156.726379 8.381138)
+     )
+
+    ;; ignoring bone: IK_Foot.R
+
+    (bone
+      (name      "Hand.L")
+      (children  "Fingers.L" "LowerThumb.L")
+      (parent    "Forearm.L")
+      (head      0.006394 0.036837 -0.005415)
+      (length    16.1714401245)
+      (matrix    0.997139 -0.069244 -0.030322
+                 0.068329  0.997204 -0.030248
+                 0.032331  0.028089  0.999082)
+      (quat      -0.014596 0.015676 -0.034421 0.999178)
+      (euler     -1.734119 1.737577 -3.972397)
+     )
+
+    (bone
+      (name      "Fingers.R")
+      (children  "FingerTips.R")
+      (parent    "Hand.R")
+      (head      0.000000 0.000000 0.000000)
+      (length    7.75397825241)
+      (matrix    0.991391 -0.084731  0.099820
+                 0.094134  0.991150 -0.093592
+                -0.091006  0.102183  0.990594)
+      (quat      -0.049109 -0.047867 -0.044867 0.996636)
+      (euler     -5.397344 -5.728780 -4.885022)
+     )
+
+    (bone
+      (name      "Head")
+      (children )
+      (parent    "Neck")
+      (head      0.000000 0.000000 -0.000000)
+      (length    17.0246181488)
+      (matrix    1.000000  0.000000  0.000000
+                 0.000000  0.612928  0.790139
+                 0.000000 -0.790139  0.612928)
+      (quat      0.439927 0.000000 0.000000 0.898033)
+      (euler     52.198494 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Fingers.L")
+      (children  "FingerTips.L")
+      (parent    "Hand.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    7.87261009216)
+      (matrix    0.990993  0.081849 -0.105986
+                -0.092456  0.990746 -0.099367
+                 0.096872  0.108271  0.989390)
+      (quat      -0.052098 0.050899 0.043734 0.996385)
+      (euler     -5.735134 6.083975 4.721491)
+     )
+
+    ;; ignoring bone: IK_Foot.L
+
+    (bone
+      (name      "Hand.R")
+      (children  "Fingers.R" "LowerThumb.R")
+      (parent    "Forearm.R")
+      (head      -0.006394 0.036837 -0.005415)
+      (length    16.1715164185)
+      (matrix    0.997139  0.069244  0.030321
+                -0.068329  0.997204 -0.030247
+                -0.032331  0.028089  0.999082)
+      (quat      -0.014596 -0.015676 0.034421 0.999178)
+      (euler     -1.734102 -1.737557 3.972392)
+     )
+
+    (bone
+      (name      "Toes.L")
+      (children )
+      (parent    "Foot.L")
+      (head      -0.000000 0.000000 -0.000000)
+      (length    14.4430961609)
+      (matrix   -0.908818  0.133897  0.395121
+                -0.133896  0.803379 -0.580219
+                -0.395121 -0.580219 -0.712197)
+      (quat      -0.000000 -0.925256 0.313545 0.213520)
+      (euler     39.169323 -156.726471 -8.381126)
+     )
+
+    (bone
+      (name      "Thumb.R")
+      (children )
+      (parent    "LowerThumb.R")
+      (head      0.000000 0.000000 -0.000000)
+      (length    7.98016500473)
+      (matrix    0.802273  0.596654  0.019051
+                -0.568548  0.753975  0.329051
+                 0.181965 -0.274820  0.944120)
+      (quat      0.161383 0.043538 0.311397 0.935463)
+      (euler     19.214796 -1.091607 36.638348)
+     )
+
+    (bone
+      (name      "Lower Leg.L")
+      (children  "Foot.L" "LegNull.L")
+      (parent    "Upper Leg.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    53.7671737671)
+      (matrix    0.999287 -0.025255 -0.028072
+                 0.028426  0.992486  0.119011
+                 0.024856 -0.119724  0.992496)
+      (quat      0.059802 0.013258 -0.013447 0.998032)
+      (euler     6.837742 1.608633 -1.447702)
+     )
+
+    (bone
+      (name      "Upper Leg.R")
+      (children  "Lower Leg.R")
+      (parent    "Hip.R")
+      (head      -0.000384 0.012505 -0.020905)
+      (length    56.2413978577)
+      (matrix    0.491190  0.626030  0.605656
+                -0.550237  0.762022 -0.341411
+                -0.675257 -0.165557  0.718762)
+      (quat      -0.051004 -0.371507 0.341156 0.861971)
+      (euler     -25.407665 -37.276051 51.881889)
+     )
+
+    (bone
+      (name      "ArmNull.R")
+      (children )
+      (parent    "Forearm.R")
+      (head      0.000000 0.000000 0.000000)
+      (length    14.4419641495)
+      (matrix   -0.071245  0.997459  0.000002
+                 0.000000 -0.000002  1.000000
+                 0.997459  0.071245 -0.000000)
+      (quat      0.481860 0.517504 0.517505 0.481859)
+      (euler     90.000008 -0.000116 94.085503)
+     )
+
+    (bone
+      (name      "LowerThumb.R")
+      (children  "Thumb.R")
+      (parent    "Hand.R")
+      (head      0.018833 -0.247973 -0.030859)
+      (length    11.9381313324)
+      (matrix    0.641058 -0.448957  0.622481
+                 0.720677  0.631054 -0.287045
+                -0.263948  0.632620  0.728095)
+      (quat      -0.265475 -0.255881 -0.337633 0.866055)
+      (euler     -21.516397 -38.497532 -35.004974)
+     )
+
+    ;; ignoring bone: IK_Arm.L
+
+    (bone
+      (name      "Thumb.L")
+      (children )
+      (parent    "LowerThumb.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    7.9801197052)
+      (matrix    0.802273 -0.596653 -0.019056
+                 0.568549  0.753976  0.329048
+                -0.181960 -0.274820  0.944121)
+      (quat      0.161382 -0.043536 -0.311397 0.935464)
+      (euler     19.214613 1.091876 -36.638294)
+     )
+
+    (bone
+      (name      "Forearm.L")
+      (children  "ArmNull.L" "Hand.L")
+      (parent    "Upper Arm.L")
+      (head      -0.000000 -0.000000 -0.000000)
+      (length    33.7863006592)
+      (matrix    0.999244 -0.013579  0.036439
+                 0.012327  0.999333  0.034372
+                -0.036882 -0.033897  0.998745)
+      (quat      0.017073 -0.018336 -0.006479 0.999665)
+      (euler     1.971078 -2.088269 -0.778556)
+     )
+
+    (bone
+      (name      "Forearm.R")
+      (children  "ArmNull.R" "Hand.R")
+      (parent    "Upper Arm.R")
+      (head      0.000000 0.000000 0.000000)
+      (length    33.7864570618)
+      (matrix    0.999244  0.013579 -0.036439
+                -0.012327  0.999333  0.034372
+                 0.036881 -0.033897  0.998745)
+      (quat      0.017073 0.018336 0.006479 0.999665)
+      (euler     1.971067 2.088262 0.778585)
+     )
+
+    ;; ignoring bone: IK_Arm.R
+
+    (bone
+      (name      "LowerThumb.L")
+      (children  "Thumb.L")
+      (parent    "Hand.L")
+      (head      -0.018833 -0.247972 -0.030859)
+      (length    11.9381809235)
+      (matrix    0.641059  0.448959 -0.622479
+                -0.720678  0.631053 -0.287046
+                 0.263946  0.632620  0.728097)
+      (quat      -0.265475 0.255880 0.337633 0.866055)
+      (euler     -21.516415 38.497387 35.005066)
+     )
+
+    (bone
+      (name      "ArmNull.L")
+      (children )
+      (parent    "Forearm.L")
+      (head      0.000000 0.000000 0.000000)
+      (length    14.4419927597)
+      (matrix   -0.071247 -0.997459 -0.000002
+                -0.000001 -0.000002  1.000000
+                -0.997459  0.071247 -0.000000)
+      (quat      0.481860 -0.517505 -0.517506 0.481859)
+      (euler     90.000023 0.000118 -94.085602)
+     )
+
+    (bone
+      (name      "Lower Leg.R")
+      (children  "Foot.R" "LegNull.R")
+      (parent    "Upper Leg.R")
+      (head      0.000000 0.000000 0.000000)
+      (length    53.7671432495)
+      (matrix    0.999287  0.025254  0.028076
+                -0.028426  0.992486  0.119011
+                -0.024860 -0.119724  0.992496)
+      (quat      0.059802 -0.013260 0.013447 0.998032)
+      (euler     6.837743 -1.608866 1.447679)
+     )
+
+    (bone
+      (name      "Upper Leg.L")
+      (children  "Lower Leg.L")
+      (parent    "Hip.L")
+      (head      0.000384 0.012505 -0.020905)
+      (length    56.241355896)
+      (matrix    0.491187 -0.626029 -0.605659
+                 0.550237  0.762022 -0.341411
+                 0.675259 -0.165560  0.718760)
+      (quat      -0.051003 0.371509 -0.341157 0.861970)
+      (euler     -25.407747 37.276279 -51.882050)
+     )
+
+  ) ;; bones
+ ) ;; armature

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/src/SConscript	2007-06-21 02:00:52 UTC (rev 1484)
@@ -42,6 +42,7 @@
 # env['ENV']['LSBCC_SHAREDLIBS'] = 'png2:SDL:SDL_image:vorbis:ogg:openal:physfs'
 
 env.Program('../windstille', [
+'armature_test.cpp',
 'armature/armature.cpp',
 'armature/bone.cpp',
 'baby_xml.cpp',

Modified: trunk/windstille/src/armature/armature.cpp
===================================================================
--- trunk/windstille/src/armature/armature.cpp	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/src/armature/armature.cpp	2007-06-21 02:00:52 UTC (rev 1484)
@@ -25,6 +25,8 @@
 
 #include <iostream>
 #include <stdexcept>
+#include "display/display.hpp"
+#include "math/vector3.hpp"
 #include "armature.hpp"
 
 Armature::Armature(FileReader& reader)
@@ -51,12 +53,14 @@
         {
           if (i->get_name() == "bone")
             {
-              Bone bone;
-              i->get("name",     bone.name);
-              i->get("children", bone.children);
-              i->get("length",   bone.length);
-              i->get("quat",     bone.quat);
-              i->get("head",     bone.head);
+              Bone* bone = new Bone();
+              i->get("name",     bone->name);
+              i->get("children", bone->children_names);
+              i->get("parent",   bone->parent_name);
+              i->get("length",   bone->length);
+              i->get("quat",     bone->quat);
+              i->get("head",     bone->head);
+              bones.push_back(bone);
             }
           else
             {
@@ -64,6 +68,72 @@
             }
         }
     }
+  
+  // insert code here to connet parent bones
+  for(Bones::iterator i = bones.begin(); i != bones.end(); ++i)
+    {
+      Bone& bone = **i;
+      for(std::vector<std::string>::iterator j = bone.children_names.begin(); j != bone.children_names.end(); ++j)
+        {
+          Bone* child = get_bone(*j);
+          if (child)
+            bone.children.push_back(child);
+        }
+
+      if (bone.parent_name.empty())
+        {
+          root_bone = &bone;
+        }
+      else
+        {
+          Bone* parent = get_bone(bone.parent_name);
+          if (parent)
+            bone.parent = parent;
+        }
+    }
+
+  if (!root_bone)
+    std::cout << "Root Bone Missing!" << std::endl;
 }
 
+Bone*
+Armature::get_bone(const std::string& name)
+{
+  for(Bones::iterator i = bones.begin(); i != bones.end(); ++i)
+    {
+      if ((*i)->name == name)
+        return *i;
+    }
+  std::cout << "Error: Bone: '" << name << "' not found" << std::endl;
+  return 0;
+}
+
+void
+Armature::draw()
+{
+  std::cout << "Draw" << std::endl;
+  draw_bone(root_bone, Vector3(400,300, 0), Matrix::identity());
+}
+
+void
+Armature::draw_bone(Bone* bone, Vector3 p, Matrix cur)
+{
+  // FIXME: not taking head into account
+  Vector3 vec = Vector3(bone->length, 0.0f, 0.0f) + bone->head;
+  Matrix  mat = cur.multiply(bone->quat.to_matrix());
+  
+  vec = p + mat.multiply(vec);  
+
+  // std::cout << "vec: " << vec << std::endl;
+
+  Display::draw_line(Vector(p.x,   p.y),
+                     Vector(vec.x, vec.y),
+                     Color(1.0f, 1.0f, 1.0f));
+
+  for(std::vector<Bone*>::iterator i = bone->children.begin(); i != bone->children.end(); ++i)  
+    {
+      draw_bone(*i, vec, cur);
+    }
+}
+
 /* EOF */

Modified: trunk/windstille/src/armature/armature.hpp
===================================================================
--- trunk/windstille/src/armature/armature.hpp	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/src/armature/armature.hpp	2007-06-21 02:00:52 UTC (rev 1484)
@@ -35,13 +35,18 @@
 {
 private:
   std::string name;
-  typedef std::vector<Bone> Bones;
+  typedef std::vector<Bone*> Bones;
   Bones bones;
+  
+  Bone* root_bone;
 public:
   Armature(FileReader& reader);
   ~Armature();
   
-  void parse(FileReader& reader);
+  void  parse(FileReader& reader);
+  Bone* get_bone(const std::string& name);
+  void  draw();
+  void  draw_bone(Bone* bone, Vector3 p, Matrix matrix);
 private:
   Armature (const Armature&);
   Armature& operator= (const Armature&);

Modified: trunk/windstille/src/armature/bone.cpp
===================================================================
--- trunk/windstille/src/armature/bone.cpp	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/src/armature/bone.cpp	2007-06-21 02:00:52 UTC (rev 1484)
@@ -26,6 +26,7 @@
 #include "bone.hpp"
 
 Bone::Bone()
+  : parent(0)
 {
 }
 

Modified: trunk/windstille/src/armature/bone.hpp
===================================================================
--- trunk/windstille/src/armature/bone.hpp	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/src/armature/bone.hpp	2007-06-21 02:00:52 UTC (rev 1484)
@@ -37,7 +37,13 @@
 private:
 public:
   std::string name;
-  std::vector<std::string> children;
+
+  std::vector<std::string> children_names;
+  std::string parent_name;
+
+  std::vector<Bone*> children;
+  Bone*      parent;
+
   float      length;
   Quaternion quat;
   Vector3    head;

Added: trunk/windstille/src/armature_test.cpp
===================================================================
--- trunk/windstille/src/armature_test.cpp	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/src/armature_test.cpp	2007-06-21 02:00:52 UTC (rev 1484)
@@ -0,0 +1,60 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include <GL/glew.h>
+#include <GL/gl.h>
+#include "input/controller.hpp"
+#include "display/display.hpp"
+#include "screen_manager.hpp"
+#include "display/display.hpp"
+#include "armature_test.hpp"
+
+ArmatureTest::ArmatureTest()
+{
+  FileReader reader = FileReader::parse("armature.arm");
+  armature = new Armature(reader);
+}
+
+void
+ArmatureTest::draw()
+{
+  glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
+  glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
+  
+  armature->draw();
+}
+
+void
+ArmatureTest::update(float delta, const Controller& controller)
+{
+  if (controller.button_was_pressed(ESCAPE_BUTTON) ||
+      controller.button_was_pressed(PAUSE_BUTTON))
+    {
+      screen_manager.pop_screen();
+    }
+ 
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/armature_test.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/armature_test.hpp
===================================================================
--- trunk/windstille/src/armature_test.hpp	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/src/armature_test.hpp	2007-06-21 02:00:52 UTC (rev 1484)
@@ -0,0 +1,51 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_ARMATURE_TEST_HPP
+#define HEADER_ARMATURE_TEST_HPP
+
+#include "armature/armature.hpp"
+#include "screen.hpp"
+
+/** */
+class ArmatureTest : public Screen
+{
+private:
+  Armature* armature;
+
+public:
+  ArmatureTest();
+
+  void draw();
+  void update(float delta, const Controller& controller);
+
+private:
+  ArmatureTest (const ArmatureTest&);
+  ArmatureTest& operator= (const ArmatureTest&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/armature_test.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/geometry_test.cpp
===================================================================
--- trunk/windstille/src/geometry_test.cpp	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/src/geometry_test.cpp	2007-06-21 02:00:52 UTC (rev 1484)
@@ -52,6 +52,7 @@
 void
 GeometryTest::draw()
 {
+  glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
   glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
 
   Display::draw_line(line1, Color(0.0f, 1.0f, 0.0f));

Modified: trunk/windstille/src/math/matrix.cpp
===================================================================
--- trunk/windstille/src/math/matrix.cpp	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/src/math/matrix.cpp	2007-06-21 02:00:52 UTC (rev 1484)
@@ -30,6 +30,7 @@
 #include <string.h>
 #include <iostream>
 #include <math.h>
+#include "vector3.hpp"
 #include "matrix.hpp"
 
 /////////////////////////////////////////////////////////////////////////////
@@ -37,32 +38,32 @@
 
 Matrix::Matrix()
 {
-	memset(matrix, 0, sizeof(float[16]));
+  memset(matrix, 0, sizeof(float[16]));
 }
 
 Matrix
 Matrix::identity()
 {
-	Matrix matrix;
+  Matrix matrix;
 
-	matrix.matrix[0] = 1.0;
-	matrix.matrix[5] = 1.0;
-	matrix.matrix[10] = 1.0;
-	matrix.matrix[15] = 1.0;
+  matrix.matrix[0] = 1.0;
+  matrix.matrix[5] = 1.0;
+  matrix.matrix[10] = 1.0;
+  matrix.matrix[15] = 1.0;
 	
-	return matrix;
+  return matrix;
 }
 
 Matrix::Matrix(const Matrix &copy)
 {
-	for (int i=0; i<16; i++)
-		matrix[i] = copy.matrix[i];
+  for (int i=0; i<16; i++)
+    matrix[i] = copy.matrix[i];
 }
 
 Matrix::Matrix(const float *init_matrix)
 {
-	for (int i=0; i<16; i++)
-		matrix[i] = init_matrix[i];
+  for (int i=0; i<16; i++)
+    matrix[i] = init_matrix[i];
 }
 
 /////////////////////////////////////////////////////////////////////////////
@@ -70,17 +71,17 @@
 
 float Matrix::get_origin_x() const
 {
-	return matrix[12];
+  return matrix[12];
 }
 
 float Matrix::get_origin_y() const
 {
-	return matrix[13];
+  return matrix[13];
 }
 
 float Matrix::get_origin_z() const
 {
-	return matrix[14];
+  return matrix[14];
 }
 
 /////////////////////////////////////////////////////////////////////////////
@@ -88,42 +89,56 @@
 
 bool Matrix::operator==(const Matrix &other) const 
 {
-	for (int i=0; i<16; i++)
-		if (matrix[i] != other.matrix[i]) return false;
-	return true;
+  for (int i=0; i<16; i++)
+    if (matrix[i] != other.matrix[i]) return false;
+  return true;
 }
 
 bool Matrix::operator!=(const Matrix &other) const
 {
-	for (int i=0; i<16; i++)
-		if (matrix[i] != other.matrix[i]) return true;
-	return false;
+  for (int i=0; i<16; i++)
+    if (matrix[i] != other.matrix[i]) return true;
+  return false;
 }
 
 Matrix &Matrix::operator =(const Matrix &copy)
 {
-	for (int i=0; i<16; i++)
-		matrix[i] = copy.matrix[i];
-	return *this;
+  for (int i=0; i<16; i++)
+    matrix[i] = copy.matrix[i];
+  return *this;
 }
 
 Matrix Matrix::multiply(const Matrix &mult) const
 {
-	Matrix result;
-	for (int x=0; x<4; x++)
-	{
-		for (int y=0; y<4; y++)
-		{
-			result.matrix[x+y*4] =
-				matrix[x]*mult.matrix[y*4] +
-				matrix[x+4]*mult.matrix[y*4+1] +
-				matrix[x+8]*mult.matrix[y*4+2] +
-				matrix[x+12]*mult.matrix[y*4+3];
-		}
-	}
-	return result;
+  Matrix result;
+  for (int x=0; x<4; x++)
+    {
+      for (int y=0; y<4; y++)
+        {
+          result.matrix[x+y*4] =
+            matrix[x   ] * mult.matrix[y*4  ] +
+            matrix[x+ 4] * mult.matrix[y*4+1] +
+            matrix[x+ 8] * mult.matrix[y*4+2] +
+            matrix[x+12] * mult.matrix[y*4+3];
+        }
+    }
+  return result;
 }
 
+Vector3
+Matrix::multiply(const Vector3& v) const
+{ // assuming Vector3 is a homogenous vector (x,y,z,1)
+  // FIXME: Test me
+  const Matrix& m = *this;
+
+  float x = m(0,0)*v.x + m(0,1)*v.x + m(0,2)*v.x + m(0,3)*v.x;
+  float y = m(1,0)*v.y + m(1,1)*v.y + m(1,2)*v.y + m(1,3)*v.y;
+  float z = m(2,0)*v.z + m(2,1)*v.z + m(2,2)*v.z + m(2,3)*v.z;
+  float w = m(3,0)*1   + m(3,1)*1   + m(3,2)*1   + m(3,3)*1  ;
+
+  return Vector3(x/w, y/w, z/w);
+}
+
 Matrix
 Matrix::scale(float x, float y, float z)
 {

Modified: trunk/windstille/src/math/matrix.hpp
===================================================================
--- trunk/windstille/src/math/matrix.hpp	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/src/math/matrix.hpp	2007-06-21 02:00:52 UTC (rev 1484)
@@ -32,66 +32,73 @@
 
 #include <iosfwd>
 
+class Vector3;
+
 //: 4x4 Matrix.
 class Matrix
 {
-//! Construction:
+  //! Construction:
 public:
-	//: Constructs a 4x4 matrix.
-	Matrix();
+  //: Constructs a 4x4 matrix.
+  Matrix();
 
-	Matrix(const Matrix &copy);
+  Matrix(const Matrix &copy);
 
-	Matrix(const float *matrix);
+  Matrix(const float *matrix);
 
-	/** Returns identity matrix */
-	static Matrix identity();
+  /** Returns identity matrix */
+  static Matrix identity();
 
-//! Attributes:
+  //! Attributes:
 public:
-	float matrix[16];
+  float matrix[16];
 
-	//: Operator that returns the matrix cell at the given index.
-	float &operator[](int i) { return matrix[i]; }
+  //: Operator that returns the matrix cell at the given index.
+  float &operator[](int i) { return matrix[i]; }
 
-	//: Operator that returns the matrix cell at the given index.
-	const float &operator[](int i) const { return matrix[i]; }
+  //: Operator that returns the matrix cell at the given index.
+  const float &operator[](int i) const { return matrix[i]; }
 
-	//: Operator that returns the matrix cell at the given index.
-	float &operator[](unsigned int i) { return matrix[i]; }
+  inline float&       operator()(int row, int col) { return matrix[4*row + col]; }
+  inline const float& operator()(int row, int col) const { return matrix[4*row + col]; }
 
-	//: Operator that returns the matrix cell at the given index.
-	const float &operator[](unsigned int i) const { return matrix[i]; }
+  //: Operator that returns the matrix cell at the given index.
+  float &operator[](unsigned int i) { return matrix[i]; }
 
-	//: Returns the x coordinate for the point (0,0,0) multiplied with this matrix.
-	float get_origin_x() const;
+  //: Operator that returns the matrix cell at the given index.
+  const float &operator[](unsigned int i) const { return matrix[i]; }
 
-	//: Returns the y coordinate for the point (0,0,0) multiplied with this matrix.
-	float get_origin_y() const;
+  //: Returns the x coordinate for the point (0,0,0) multiplied with this matrix.
+  float get_origin_x() const;
 
-	//: Returns the z coordinate for the point (0,0,0) multiplied with this matrix.
-	float get_origin_z() const;
+  //: Returns the y coordinate for the point (0,0,0) multiplied with this matrix.
+  float get_origin_y() const;
 
-//! Operations:
+  //: Returns the z coordinate for the point (0,0,0) multiplied with this matrix.
+  float get_origin_z() const;
+
+  //! Operations:
 public:
-	//: Copy assignment operator.
-	Matrix &operator =(const Matrix &copy);
+  //: Copy assignment operator.
+  Matrix &operator =(const Matrix &copy);
 
-	//: Equality operator.
-	bool operator==(const Matrix &other) const;
+  //: Equality operator.
+  bool operator==(const Matrix &other) const;
 
-	//: Not-equal operator.
-	bool operator!=(const Matrix &other) const;
+  //: Not-equal operator.
+  bool operator!=(const Matrix &other) const;
 
-	//: Multiply two matrices.
-	Matrix multiply(const Matrix &matrix) const;
+  //: Multiply two matrices.
+  Matrix multiply(const Matrix &matrix) const;
 
-	//: Multiply the matrix with the given scale/translate/rotate matrix
-	Matrix scale(float x, float y, float z);
-	Matrix translate(float x, float y, float z);
-	Matrix rotate(float angle, float x, float y, float z);
+  Vector3 multiply(const Vector3& vector) const;
 
-//! Implementation:
+  //: Multiply the matrix with the given scale/translate/rotate matrix
+  Matrix scale(float x, float y, float z);
+  Matrix translate(float x, float y, float z);
+  Matrix rotate(float angle, float x, float y, float z);
+
+  //! Implementation:
 private:
 };
 

Modified: trunk/windstille/src/math/vector3.hpp
===================================================================
--- trunk/windstille/src/math/vector3.hpp	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/src/math/vector3.hpp	2007-06-21 02:00:52 UTC (rev 1484)
@@ -19,6 +19,7 @@
 #ifndef __VECTOR3_HPP__
 #define __VECTOR3_HPP__
 
+#include <iostream>
 #include "math/matrix.hpp"
 
 /**
@@ -103,5 +104,9 @@
   }
 };
 
+inline std::ostream& operator<<(std::ostream& s, const Vector3& v) {
+  return (s << "[" << v.x << ", " << v.y << ", " << v.z << "]");
+}
+
 #endif
 

Modified: trunk/windstille/src/menu_manager.cpp
===================================================================
--- trunk/windstille/src/menu_manager.cpp	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/src/menu_manager.cpp	2007-06-21 02:00:52 UTC (rev 1484)
@@ -40,6 +40,7 @@
 #include "sprite3d/manager.hpp"
 #include "sprite3dview.hpp"
 #include "geometry_test.hpp"
+#include "armature_test.hpp"
 #include "navigation_test.hpp"
 #include "gui/menu_item.hpp"
 #include "menu_manager.hpp"
@@ -153,6 +154,10 @@
   slots.push_back(navigation_test_button->sig_click().connect(this, &MenuManager::menu_show_navigation_test));
   menu->add_item(navigation_test_button);
 
+  ButtonMenuItem* armature_test_button = new ButtonMenuItem(menu,  "Armature Test");
+  slots.push_back(armature_test_button->sig_click().connect(this, &MenuManager::menu_show_armature_test));
+  menu->add_item(armature_test_button);
+
   ButtonMenuItem* geometry_test_button = new ButtonMenuItem(menu,  "Geometry Test");
   slots.push_back(geometry_test_button->sig_click().connect(this, &MenuManager::menu_show_geometry_test));
   menu->add_item(geometry_test_button);
@@ -574,6 +579,13 @@
 }
 
 void
+MenuManager::menu_show_armature_test()
+{
+  screen_manager.push_screen(new ArmatureTest());
+  screen_manager.clear_overlay();  
+}
+
+void
 MenuManager::menu_show_navigation_test()
 {
   screen_manager.push_screen(new NavigationTest());

Modified: trunk/windstille/src/menu_manager.hpp
===================================================================
--- trunk/windstille/src/menu_manager.hpp	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/src/menu_manager.hpp	2007-06-21 02:00:52 UTC (rev 1484)
@@ -60,6 +60,7 @@
   void menu_start_scenario(std::string scenario);
   void menu_show_model(std::string scenario);
   void menu_show_geometry_test();
+  void menu_show_armature_test();
   void menu_show_navigation_test();
   void menu_show_particle_system(std::string file);
   void menu_gamma(int i);

Modified: trunk/windstille/src/navigation_test.cpp
===================================================================
--- trunk/windstille/src/navigation_test.cpp	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/src/navigation_test.cpp	2007-06-21 02:00:52 UTC (rev 1484)
@@ -69,6 +69,7 @@
 void
 NavigationTest::draw()
 {
+  glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
   glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
   graph->draw();
 

Modified: trunk/windstille/tools/bone_export.py
===================================================================
--- trunk/windstille/tools/bone_export.py	2007-06-20 22:25:53 UTC (rev 1483)
+++ trunk/windstille/tools/bone_export.py	2007-06-21 02:00:52 UTC (rev 1484)
@@ -52,7 +52,7 @@
                 out.write("      (parent )\n")
                 out.write("      (head      %s)\n" % (vec2str(bone.head['ARMATURESPACE']),))
 
-            out.write("      (length    %s)\n" % bone.length)
+            out.write("      (length    %s)\n" % (bone.length*64))
             out.write("      (matrix   %s)\n" % matrix2str(" "*16, bone.matrix['BONESPACE']))
             out.write("      (quat      %s)\n" % quat2str(bone.matrix['BONESPACE'].toQuat()))
             out.write("      (euler     %s)\n" % euler2str(bone.matrix['BONESPACE'].toEuler()))
@@ -75,4 +75,4 @@
     print "done"
 print
 
-# EOF #
+# EOF #
\ No newline at end of file



From grumbel at mail.berlios.de  Thu Jun 21 07:25:04 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 21 Jun 2007 07:25:04 +0200
Subject: [Windstille-commit] r1485 - in trunk/windstille: data src
	src/armature src/math tools
Message-ID: <200706210525.l5L5P4SE009203@sheep.berlios.de>

Author: grumbel
Date: 2007-06-21 07:25:03 +0200 (Thu, 21 Jun 2007)
New Revision: 1485

Modified:
   trunk/windstille/data/armature.arm
   trunk/windstille/src/armature/armature.cpp
   trunk/windstille/src/armature/bone.hpp
   trunk/windstille/src/armature_test.cpp
   trunk/windstille/src/armature_test.hpp
   trunk/windstille/src/getter.cpp
   trunk/windstille/src/getter.hpp
   trunk/windstille/src/math/matrix.cpp
   trunk/windstille/src/math/matrix.hpp
   trunk/windstille/tools/bone_export.py
Log:
- some bug fixes and other tweaks, now somewhat working

Modified: trunk/windstille/data/armature.arm
===================================================================
--- trunk/windstille/data/armature.arm	2007-06-21 02:00:52 UTC (rev 1484)
+++ trunk/windstille/data/armature.arm	2007-06-21 05:25:03 UTC (rev 1485)
@@ -1,495 +1,62 @@
 ;; -*- scheme -*-
 (armature
-  (name "Armature")
+  (name "Armature.001")
   (bones
     (bone
-      (name      "LegNull.L")
-      (children )
-      (parent    "Lower Leg.L")
-      (head      0.000000 -0.000000 0.000000)
-      (length    19.4823303223)
-      (matrix    0.999972  0.005368  0.005170
-                -0.007122  0.892687  0.450621
-                -0.002196 -0.450645  0.892701)
-      (quat      0.231616 -0.001893 0.003210 0.972800)
-      (euler     26.783907 -0.296202 0.307589)
-     )
-
-    (bone
-      (name      "Hip.R")
-      (children  "Upper Leg.R")
+      (name      "Base.001")
+      (children  "Base.002")
       (parent    "Base")
-      (head      0.040620 -0.025407 0.039311)
-      (length    27.6306285858)
-      (matrix    0.464598  0.621588  0.630696
-                 0.637704 -0.729017  0.248729
-                 0.614396  0.286638 -0.735090)
-      (quat      -0.855673 -0.367924 -0.363776 0.011077)
-      (euler     161.305908 -39.101467 53.224209)
+      (head      0.000000 0.000000 0.000000)
+      (length    49.66381073)
+      (matrix    0.653362  0.757046  0.000013  0.000000
+                -0.757046  0.653362  0.000028  0.000000
+                 0.000013 -0.000028  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.000016 -0.000000 0.416316 0.909220)
+      (euler     0.001619 -0.000743 49.204468)
      )
 
     (bone
-      (name      "Foot.L")
-      (children  "Toes.L")
-      (parent    "Lower Leg.L")
-      (head      0.000000 -0.000000 0.000000)
-      (length    25.8882045746)
-      (matrix    0.906031  0.404751  0.123628
-                -0.132580  0.548869 -0.825327
-                -0.401908  0.731382  0.550955)
-      (quat      -0.448945 -0.151561 0.154963 0.866870)
-      (euler     -56.274559 -7.101538 24.071741)
-     )
-
-    (bone
-      (name      "Upper Arm.L")
-      (children  "Forearm.L")
-      (parent    "Shoulder.L")
-      (head      0.000000 -0.000000 0.000000)
-      (length    34.0862197876)
-      (matrix    0.910775 -0.272327  0.310365
-                 0.149809  0.918392  0.366215
-                -0.384766 -0.287044  0.877246)
-      (quat      0.169659 -0.180534 -0.109634 0.962602)
-      (euler     22.658556 -18.081205 -16.646954)
-     )
-
-    (bone
-      (name      "Belly")
-      (children )
-      (parent    "Base")
-      (head      0.000000 -0.023287 0.366125)
-      (length    22.6078624725)
-      (matrix    1.000000  0.000000  0.000000
-                 0.000000 -0.210548  0.977584
-                 0.000000 -0.977584 -0.210548)
-      (quat      0.777994 0.000000 0.000000 0.628272)
-      (euler     102.154457 -0.000000 0.000000)
-     )
-
-    (bone
-      (name      "Upper Arm.R")
-      (children  "Forearm.R")
-      (parent    "Shoulder.R")
-      (head      0.000000 0.000000 -0.000000)
-      (length    34.0863990784)
-      (matrix    0.910775  0.272328 -0.310364
-                -0.149811  0.918392  0.366214
-                 0.384766 -0.287042  0.877246)
-      (quat      0.169659 0.180534 0.109635 0.962602)
-      (euler     22.658512 18.081173 16.647051)
-     )
-
-    (bone
-      (name      "Foot.R")
-      (children  "Toes.R")
-      (parent    "Lower Leg.R")
+      (name      "Base.002")
+      (children  "Base.003")
+      (parent    "Base.001")
       (head      0.000000 0.000000 0.000000)
-      (length    25.8882312775)
-      (matrix    0.906031 -0.404752 -0.123628
-                 0.132580  0.548869 -0.825328
-                 0.401909  0.731382  0.550954)
-      (quat      -0.448946 0.151562 -0.154963 0.866870)
-      (euler     -56.274597 7.101557 -24.071774)
+      (length    54.4462547302)
+      (matrix    0.000000  1.000000  0.000000  0.000000
+                -1.000000  0.000000 -0.000000  0.000000
+                -0.000000 -0.000000  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.000000 -0.000000 0.707107 0.707107)
+      (euler     -0.000003 -0.000000 90.000000)
      )
 
     (bone
-      (name      "Hip.L")
-      (children  "Upper Leg.L")
-      (parent    "Base")
-      (head      -0.039261 -0.025407 0.039311)
-      (length    27.6306190491)
-      (matrix    0.464597 -0.621588 -0.630696
-                -0.637704 -0.729017  0.248730
-                -0.614396  0.286638 -0.735089)
-      (quat      -0.855672 0.367926 0.363776 0.011075)
-      (euler     161.305908 39.101479 -53.224247)
-     )
-
-    (bone
-      (name      "LegNull.R")
+      (name      "Base.003")
       (children )
-      (parent    "Lower Leg.R")
+      (parent    "Base.002")
       (head      0.000000 0.000000 0.000000)
-      (length    19.4823417664)
-      (matrix    0.999972 -0.005368 -0.005170
-                 0.007122  0.892687  0.450622
-                 0.002196 -0.450646  0.892700)
-      (quat      0.231617 0.001893 -0.003210 0.972800)
-      (euler     26.783953 0.296212 -0.307584)
+      (length    66.5862960815)
+      (matrix    0.000000 -1.000000 -0.000000  0.000000
+                -0.000000 -0.000000  1.000000  0.000000
+                -1.000000 -0.000000 -0.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.500000 -0.500000 -0.500000 0.500000)
+      (euler     90.000008 0.000000 -90.000000)
      )
 
-    (bone
-      (name      "Neck")
-      (children  "Head")
-      (parent    "Shoulders")
-      (head      0.000000 -0.000000 -0.000000)
-      (length    16.9650382996)
-      (matrix    1.000000  0.000000  0.000000
-                 0.000000  0.779716  0.626133
-                 0.000000 -0.626133  0.779716)
-      (quat      0.331876 0.000000 0.000000 0.943323)
-      (euler     38.765385 -0.000000 0.000000)
-     )
-
-    (bone
-      (name      "Hip")
-      (children  "Body")
-      (parent    "Base")
-      (head      0.000000 0.003058 0.001977)
-      (length    23.6622543335)
-      (matrix    1.000000  0.000000  0.000000
-                 0.000000  0.997063  0.076591
-                 0.000000 -0.076591  0.997063)
-      (quat      0.038324 0.000000 0.000000 0.999265)
-      (euler     4.392665 -0.000000 0.000000)
-     )
-
-    (bone
-      (name      "Shoulders")
-      (children  "Shoulder.R" "Neck" "Shoulder.L")
-      (parent    "Body")
-      (head      0.000000 0.000000 -0.000000)
-      (length    17.489074707)
-      (matrix    1.000000  0.000000  0.000000
-                 0.000000  0.999747  0.022513
-                 0.000000 -0.022513  0.999747)
-      (quat      0.011257 0.000000 0.000000 0.999937)
-      (euler     1.289991 -0.000000 0.000000)
-     )
-
-    (bone
-      (name      "Shoulder.L")
-      (children  "Upper Arm.L")
-      (parent    "Shoulders")
-      (head      -0.133504 0.016665 -0.103217)
-      (length    30.0338306427)
-      (matrix   -0.211033 -0.390486 -0.896095
-                -0.881235 -0.320670  0.347270
-                -0.422954  0.862955 -0.276438)
-      (quat      -0.588658 0.540093 0.560193 0.219009)
-      (euler     -51.479073 116.350624 61.611572)
-     )
-
-    (bone
-      (name      "FingerTips.L")
-      (children )
-      (parent    "Fingers.L")
-      (head      0.000000 -0.000000 0.000000)
-      (length    6.92211341858)
-      (matrix    0.972665 -0.148898 -0.178189
-                 0.118982  0.978544 -0.168213
-                 0.199413  0.142414  0.969512)
-      (quat      -0.078438 0.095350 -0.067644 0.990040)
-      (euler     -9.843002 10.264314 -8.703428)
-     )
-
     (bone ;; a root bone
       (name      "Base")
-      (children  "Belly" "Hip.R" "Hip.L" "Hip")
+      (children  "Base.001")
       (parent )
-      (head      -0.134862 -0.098326 -1.250145)
-      (length    14.4880990982)
-      (matrix    1.000000  0.000000  0.000000
-                 0.000000 -0.011341  0.999936
-                 0.000000 -0.999936 -0.011341)
-      (quat      0.711105 0.000000 0.000000 0.703086)
-      (euler     90.649788 -0.000000 0.000000)
+      (head      0.247892 6.338192 0.331998)
+      (length    67.0597305298)
+      (matrix    0.653362 -0.757046  0.000013  0.000000
+                 0.757046  0.653362 -0.000028  0.000000
+                 0.000013  0.000028  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.000016 0.000000 -0.416316 0.909220)
+      (euler     -0.001622 -0.000743 -49.204472)
      )
 
-    (bone
-      (name      "FingerTips.R")
-      (children )
-      (parent    "Fingers.R")
-      (head      0.000000 0.000000 -0.000000)
-      (length    7.42318964005)
-      (matrix    0.983139  0.129103  0.129499
-                -0.114041  0.986481 -0.117684
-                -0.142942  0.100931  0.984571)
-      (quat      -0.054969 -0.068504 0.061137 0.994257)
-      (euler     -6.816104 -7.440645 7.481118)
-     )
-
-    (bone
-      (name      "Shoulder.R")
-      (children  "Upper Arm.R")
-      (parent    "Shoulders")
-      (head      0.134862 0.016665 -0.103217)
-      (length    30.0339851379)
-      (matrix   -0.211032  0.390486  0.896095
-                 0.881236 -0.320668  0.347269
-                 0.422952  0.862956 -0.276439)
-      (quat      -0.588658 -0.540093 -0.560192 0.219010)
-      (euler     -51.478905 -116.350578 -61.611633)
-     )
-
-    (bone
-      (name      "Body")
-      (children  "Shoulders")
-      (parent    "Hip")
-      (head      0.000000 -0.000000 0.000000)
-      (length    23.4960784912)
-      (matrix    1.000000  0.000000  0.000000
-                 0.000000  0.989207 -0.146523
-                 0.000000  0.146523  0.989207)
-      (quat      -0.073460 0.000000 0.000000 0.997298)
-      (euler     -8.425456 -0.000000 0.000000)
-     )
-
-    (bone
-      (name      "Toes.R")
-      (children )
-      (parent    "Foot.R")
-      (head      0.000000 0.000000 -0.000000)
-      (length    14.4431037903)
-      (matrix   -0.908818 -0.133897 -0.395123
-                 0.133896  0.803379 -0.580218
-                 0.395123 -0.580218 -0.712197)
-      (quat      -0.000000 0.925256 -0.313545 0.213521)
-      (euler     39.169296 156.726379 8.381138)
-     )
-
-    ;; ignoring bone: IK_Foot.R
-
-    (bone
-      (name      "Hand.L")
-      (children  "Fingers.L" "LowerThumb.L")
-      (parent    "Forearm.L")
-      (head      0.006394 0.036837 -0.005415)
-      (length    16.1714401245)
-      (matrix    0.997139 -0.069244 -0.030322
-                 0.068329  0.997204 -0.030248
-                 0.032331  0.028089  0.999082)
-      (quat      -0.014596 0.015676 -0.034421 0.999178)
-      (euler     -1.734119 1.737577 -3.972397)
-     )
-
-    (bone
-      (name      "Fingers.R")
-      (children  "FingerTips.R")
-      (parent    "Hand.R")
-      (head      0.000000 0.000000 0.000000)
-      (length    7.75397825241)
-      (matrix    0.991391 -0.084731  0.099820
-                 0.094134  0.991150 -0.093592
-                -0.091006  0.102183  0.990594)
-      (quat      -0.049109 -0.047867 -0.044867 0.996636)
-      (euler     -5.397344 -5.728780 -4.885022)
-     )
-
-    (bone
-      (name      "Head")
-      (children )
-      (parent    "Neck")
-      (head      0.000000 0.000000 -0.000000)
-      (length    17.0246181488)
-      (matrix    1.000000  0.000000  0.000000
-                 0.000000  0.612928  0.790139
-                 0.000000 -0.790139  0.612928)
-      (quat      0.439927 0.000000 0.000000 0.898033)
-      (euler     52.198494 -0.000000 0.000000)
-     )
-
-    (bone
-      (name      "Fingers.L")
-      (children  "FingerTips.L")
-      (parent    "Hand.L")
-      (head      0.000000 -0.000000 0.000000)
-      (length    7.87261009216)
-      (matrix    0.990993  0.081849 -0.105986
-                -0.092456  0.990746 -0.099367
-                 0.096872  0.108271  0.989390)
-      (quat      -0.052098 0.050899 0.043734 0.996385)
-      (euler     -5.735134 6.083975 4.721491)
-     )
-
-    ;; ignoring bone: IK_Foot.L
-
-    (bone
-      (name      "Hand.R")
-      (children  "Fingers.R" "LowerThumb.R")
-      (parent    "Forearm.R")
-      (head      -0.006394 0.036837 -0.005415)
-      (length    16.1715164185)
-      (matrix    0.997139  0.069244  0.030321
-                -0.068329  0.997204 -0.030247
-                -0.032331  0.028089  0.999082)
-      (quat      -0.014596 -0.015676 0.034421 0.999178)
-      (euler     -1.734102 -1.737557 3.972392)
-     )
-
-    (bone
-      (name      "Toes.L")
-      (children )
-      (parent    "Foot.L")
-      (head      -0.000000 0.000000 -0.000000)
-      (length    14.4430961609)
-      (matrix   -0.908818  0.133897  0.395121
-                -0.133896  0.803379 -0.580219
-                -0.395121 -0.580219 -0.712197)
-      (quat      -0.000000 -0.925256 0.313545 0.213520)
-      (euler     39.169323 -156.726471 -8.381126)
-     )
-
-    (bone
-      (name      "Thumb.R")
-      (children )
-      (parent    "LowerThumb.R")
-      (head      0.000000 0.000000 -0.000000)
-      (length    7.98016500473)
-      (matrix    0.802273  0.596654  0.019051
-                -0.568548  0.753975  0.329051
-                 0.181965 -0.274820  0.944120)
-      (quat      0.161383 0.043538 0.311397 0.935463)
-      (euler     19.214796 -1.091607 36.638348)
-     )
-
-    (bone
-      (name      "Lower Leg.L")
-      (children  "Foot.L" "LegNull.L")
-      (parent    "Upper Leg.L")
-      (head      0.000000 -0.000000 0.000000)
-      (length    53.7671737671)
-      (matrix    0.999287 -0.025255 -0.028072
-                 0.028426  0.992486  0.119011
-                 0.024856 -0.119724  0.992496)
-      (quat      0.059802 0.013258 -0.013447 0.998032)
-      (euler     6.837742 1.608633 -1.447702)
-     )
-
-    (bone
-      (name      "Upper Leg.R")
-      (children  "Lower Leg.R")
-      (parent    "Hip.R")
-      (head      -0.000384 0.012505 -0.020905)
-      (length    56.2413978577)
-      (matrix    0.491190  0.626030  0.605656
-                -0.550237  0.762022 -0.341411
-                -0.675257 -0.165557  0.718762)
-      (quat      -0.051004 -0.371507 0.341156 0.861971)
-      (euler     -25.407665 -37.276051 51.881889)
-     )
-
-    (bone
-      (name      "ArmNull.R")
-      (children )
-      (parent    "Forearm.R")
-      (head      0.000000 0.000000 0.000000)
-      (length    14.4419641495)
-      (matrix   -0.071245  0.997459  0.000002
-                 0.000000 -0.000002  1.000000
-                 0.997459  0.071245 -0.000000)
-      (quat      0.481860 0.517504 0.517505 0.481859)
-      (euler     90.000008 -0.000116 94.085503)
-     )
-
-    (bone
-      (name      "LowerThumb.R")
-      (children  "Thumb.R")
-      (parent    "Hand.R")
-      (head      0.018833 -0.247973 -0.030859)
-      (length    11.9381313324)
-      (matrix    0.641058 -0.448957  0.622481
-                 0.720677  0.631054 -0.287045
-                -0.263948  0.632620  0.728095)
-      (quat      -0.265475 -0.255881 -0.337633 0.866055)
-      (euler     -21.516397 -38.497532 -35.004974)
-     )
-
-    ;; ignoring bone: IK_Arm.L
-
-    (bone
-      (name      "Thumb.L")
-      (children )
-      (parent    "LowerThumb.L")
-      (head      0.000000 -0.000000 0.000000)
-      (length    7.9801197052)
-      (matrix    0.802273 -0.596653 -0.019056
-                 0.568549  0.753976  0.329048
-                -0.181960 -0.274820  0.944121)
-      (quat      0.161382 -0.043536 -0.311397 0.935464)
-      (euler     19.214613 1.091876 -36.638294)
-     )
-
-    (bone
-      (name      "Forearm.L")
-      (children  "ArmNull.L" "Hand.L")
-      (parent    "Upper Arm.L")
-      (head      -0.000000 -0.000000 -0.000000)
-      (length    33.7863006592)
-      (matrix    0.999244 -0.013579  0.036439
-                 0.012327  0.999333  0.034372
-                -0.036882 -0.033897  0.998745)
-      (quat      0.017073 -0.018336 -0.006479 0.999665)
-      (euler     1.971078 -2.088269 -0.778556)
-     )
-
-    (bone
-      (name      "Forearm.R")
-      (children  "ArmNull.R" "Hand.R")
-      (parent    "Upper Arm.R")
-      (head      0.000000 0.000000 0.000000)
-      (length    33.7864570618)
-      (matrix    0.999244  0.013579 -0.036439
-                -0.012327  0.999333  0.034372
-                 0.036881 -0.033897  0.998745)
-      (quat      0.017073 0.018336 0.006479 0.999665)
-      (euler     1.971067 2.088262 0.778585)
-     )
-
-    ;; ignoring bone: IK_Arm.R
-
-    (bone
-      (name      "LowerThumb.L")
-      (children  "Thumb.L")
-      (parent    "Hand.L")
-      (head      -0.018833 -0.247972 -0.030859)
-      (length    11.9381809235)
-      (matrix    0.641059  0.448959 -0.622479
-                -0.720678  0.631053 -0.287046
-                 0.263946  0.632620  0.728097)
-      (quat      -0.265475 0.255880 0.337633 0.866055)
-      (euler     -21.516415 38.497387 35.005066)
-     )
-
-    (bone
-      (name      "ArmNull.L")
-      (children )
-      (parent    "Forearm.L")
-      (head      0.000000 0.000000 0.000000)
-      (length    14.4419927597)
-      (matrix   -0.071247 -0.997459 -0.000002
-                -0.000001 -0.000002  1.000000
-                -0.997459  0.071247 -0.000000)
-      (quat      0.481860 -0.517505 -0.517506 0.481859)
-      (euler     90.000023 0.000118 -94.085602)
-     )
-
-    (bone
-      (name      "Lower Leg.R")
-      (children  "Foot.R" "LegNull.R")
-      (parent    "Upper Leg.R")
-      (head      0.000000 0.000000 0.000000)
-      (length    53.7671432495)
-      (matrix    0.999287  0.025254  0.028076
-                -0.028426  0.992486  0.119011
-                -0.024860 -0.119724  0.992496)
-      (quat      0.059802 -0.013260 0.013447 0.998032)
-      (euler     6.837743 -1.608866 1.447679)
-     )
-
-    (bone
-      (name      "Upper Leg.L")
-      (children  "Lower Leg.L")
-      (parent    "Hip.L")
-      (head      0.000384 0.012505 -0.020905)
-      (length    56.241355896)
-      (matrix    0.491187 -0.626029 -0.605659
-                 0.550237  0.762022 -0.341411
-                 0.675259 -0.165560  0.718760)
-      (quat      -0.051003 0.371509 -0.341157 0.861970)
-      (euler     -25.407747 37.276279 -51.882050)
-     )
-
   ) ;; bones
  ) ;; armature

Modified: trunk/windstille/src/armature/armature.cpp
===================================================================
--- trunk/windstille/src/armature/armature.cpp	2007-06-21 02:00:52 UTC (rev 1484)
+++ trunk/windstille/src/armature/armature.cpp	2007-06-21 05:25:03 UTC (rev 1485)
@@ -23,8 +23,11 @@
 **  02111-1307, USA.
 */
 
+#include <GL/glew.h>
+#include <GL/gl.h>
 #include <iostream>
 #include <stdexcept>
+#include "display/opengl_state.hpp"
 #include "display/display.hpp"
 #include "math/vector3.hpp"
 #include "armature.hpp"
@@ -54,13 +57,21 @@
           if (i->get_name() == "bone")
             {
               Bone* bone = new Bone();
-              i->get("name",     bone->name);
-              i->get("children", bone->children_names);
-              i->get("parent",   bone->parent_name);
-              i->get("length",   bone->length);
-              i->get("quat",     bone->quat);
-              i->get("head",     bone->head);
-              bones.push_back(bone);
+              if (!(i->get("name",     bone->name) &&
+                    i->get("children", bone->children_names) &&
+                    i->get("parent",   bone->parent_name) &&
+                    i->get("length",   bone->length) &&
+                    i->get("quat",     bone->quat) &&
+                    i->get("matrix",   bone->matrix) &&
+                    i->get("head",     bone->head)))
+                {
+                  std::cout << "Error: some Bone attribute missing" << std::endl;
+                  delete bone;
+                }
+              else
+                {
+                  bones.push_back(bone);
+                }
             }
           else
             {
@@ -111,28 +122,35 @@
 void
 Armature::draw()
 {
-  std::cout << "Draw" << std::endl;
-  draw_bone(root_bone, Vector3(400,300, 0), Matrix::identity());
+  OpenGLState state;
+  state.color(Color(1.0f, 0.0f, 0.0f));
+  state.activate();
+
+  glBegin(GL_LINES);
+  draw_bone(root_bone, Vector3(0,0, 0), Matrix::identity());
+  glEnd();
+
 }
 
 void
 Armature::draw_bone(Bone* bone, Vector3 p, Matrix cur)
 {
-  // FIXME: not taking head into account
-  Vector3 vec = Vector3(bone->length, 0.0f, 0.0f) + bone->head;
-  Matrix  mat = cur.multiply(bone->quat.to_matrix());
+  Vector3 vec = Vector3(bone->length, 0.0f, 0.0f);
+  Matrix  mat = bone->matrix.multiply(cur);
   
-  vec = p + mat.multiply(vec);  
+  //std::cout << "draw_bone" << std::endl;
+  //std::cout << "matrix: \n" << mat << std::endl;
+  //std::cout << "before: " << vec << std::endl;
+  vec = mat.multiply(vec);
+  //std::cout << "after: " << vec << std::endl;
 
-  // std::cout << "vec: " << vec << std::endl;
+  
+  glVertex3f(  p.x,   p.y,   p.z);
+  glVertex3f(vec.x, vec.y, vec.z);
 
-  Display::draw_line(Vector(p.x,   p.y),
-                     Vector(vec.x, vec.y),
-                     Color(1.0f, 1.0f, 1.0f));
-
   for(std::vector<Bone*>::iterator i = bone->children.begin(); i != bone->children.end(); ++i)  
     {
-      draw_bone(*i, vec, cur);
+      draw_bone(*i, vec, mat);
     }
 }
 

Modified: trunk/windstille/src/armature/bone.hpp
===================================================================
--- trunk/windstille/src/armature/bone.hpp	2007-06-21 02:00:52 UTC (rev 1484)
+++ trunk/windstille/src/armature/bone.hpp	2007-06-21 05:25:03 UTC (rev 1485)
@@ -30,6 +30,7 @@
 #include <vector>
 #include "math/quaternion.hpp"
 #include "math/vector3.hpp"
+#include "math/matrix.hpp"
 
 /** */
 class Bone
@@ -45,7 +46,9 @@
   Bone*      parent;
 
   float      length;
+
   Quaternion quat;
+  Matrix     matrix;
   Vector3    head;
   
   Bone();

Modified: trunk/windstille/src/armature_test.cpp
===================================================================
--- trunk/windstille/src/armature_test.cpp	2007-06-21 02:00:52 UTC (rev 1484)
+++ trunk/windstille/src/armature_test.cpp	2007-06-21 05:25:03 UTC (rev 1485)
@@ -35,15 +35,31 @@
 {
   FileReader reader = FileReader::parse("armature.arm");
   armature = new Armature(reader);
+  
+  xrot = 0;
+  yrot = 0;
 }
 
 void
 ArmatureTest::draw()
 {
+  SDL_Delay(30);
   glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
   glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
   
+  glPushMatrix();
+
+  glTranslatef(400.0f, 300.0f, 0.0f);
+ 
+  glRotatef(xrot, 1.0f, 0.0f, 0.0f);
+  glRotatef(yrot, 0.0f, 1.0f, 0.0f);
+  glRotatef(zrot, 0.0f, 0.0f, 1.0f);
+
   armature->draw();
+
+  glPopMatrix();
+
+  // std::cout << xrot << " " << yrot << std::endl;
 }
 
 void
@@ -55,6 +71,9 @@
       screen_manager.pop_screen();
     }
  
+  xrot += controller.get_axis_state(X_AXIS) * 90 * delta;
+  yrot += controller.get_axis_state(Y_AXIS) * 90 * delta;
+  zrot += controller.get_axis_state(X2_AXIS) * 90 * delta;
 }
 
 /* EOF */

Modified: trunk/windstille/src/armature_test.hpp
===================================================================
--- trunk/windstille/src/armature_test.hpp	2007-06-21 02:00:52 UTC (rev 1484)
+++ trunk/windstille/src/armature_test.hpp	2007-06-21 05:25:03 UTC (rev 1485)
@@ -34,7 +34,9 @@
 {
 private:
   Armature* armature;
-
+  float xrot;
+  float yrot;
+  float zrot;
 public:
   ArmatureTest();
 

Modified: trunk/windstille/src/getter.cpp
===================================================================
--- trunk/windstille/src/getter.cpp	2007-06-21 02:00:52 UTC (rev 1484)
+++ trunk/windstille/src/getter.cpp	2007-06-21 05:25:03 UTC (rev 1485)
@@ -70,6 +70,33 @@
   }
 }
 
+bool get(FileReader& reader, const char* name, Matrix& m)
+{
+  std::vector<float> floats;
+  if (reader.get(name, floats) && floats.size() == 16) {  
+    m[ 0] = floats[0];
+    m[ 4] = floats[1];
+    m[ 8] = floats[2];
+    m[12] = floats[3];
+    m[ 1] = floats[4];
+    m[ 5] = floats[5];
+    m[ 9] = floats[6];
+    m[13] = floats[7];
+    m[ 2] = floats[8];
+    m[ 6] = floats[9];
+    m[10] = floats[10];
+    m[14] = floats[11];
+    m[ 3] = floats[12];
+    m[ 7] = floats[13];
+    m[11] = floats[14];
+    m[15] = floats[15];
+    return true;
+    // FIXME: Could add code to handel 3x3 matrixes
+  } else {
+    return false;
+  }
+}
+
 bool get(FileReader& reader, const char* name, Color& value)
 {
   std::vector<float> floats;

Modified: trunk/windstille/src/getter.hpp
===================================================================
--- trunk/windstille/src/getter.hpp	2007-06-21 02:00:52 UTC (rev 1484)
+++ trunk/windstille/src/getter.hpp	2007-06-21 05:25:03 UTC (rev 1485)
@@ -33,7 +33,9 @@
 class Color;
 class Vector;
 class Vector3;
+class Matrix;
 
+bool get(FileReader& reader, const char* name, Matrix& value);
 bool get(FileReader& reader, const char* name, Quaternion& value);
 bool get(FileReader& reader, const char* name, Color& value);
 bool get(FileReader& reader, const char* name, Vector&  value);

Modified: trunk/windstille/src/math/matrix.cpp
===================================================================
--- trunk/windstille/src/math/matrix.cpp	2007-06-21 02:00:52 UTC (rev 1484)
+++ trunk/windstille/src/math/matrix.cpp	2007-06-21 05:25:03 UTC (rev 1485)
@@ -131,12 +131,15 @@
   // FIXME: Test me
   const Matrix& m = *this;
 
-  float x = m(0,0)*v.x + m(0,1)*v.x + m(0,2)*v.x + m(0,3)*v.x;
-  float y = m(1,0)*v.y + m(1,1)*v.y + m(1,2)*v.y + m(1,3)*v.y;
-  float z = m(2,0)*v.z + m(2,1)*v.z + m(2,2)*v.z + m(2,3)*v.z;
-  float w = m(3,0)*1   + m(3,1)*1   + m(3,2)*1   + m(3,3)*1  ;
+  float x = m(0,0)*v.x + m(0,1)*v.y + m(0,2)*v.z;
+  float y = m(1,0)*v.x + m(1,1)*v.y + m(1,2)*v.z;
+  float z = m(2,0)*v.x + m(2,1)*v.y + m(2,2)*v.z;
 
-  return Vector3(x/w, y/w, z/w);
+  //float w = m(3,0)*1 + m(3,1)*1 + m(3,2)*1 + m(3,3)*1 ; // since we
+  //are multiplying with a rot matrix this stays 1 and can be ignored
+  //for now
+
+  return Vector3(x, y, z);
 }
 
 Matrix

Modified: trunk/windstille/src/math/matrix.hpp
===================================================================
--- trunk/windstille/src/math/matrix.hpp	2007-06-21 02:00:52 UTC (rev 1484)
+++ trunk/windstille/src/math/matrix.hpp	2007-06-21 05:25:03 UTC (rev 1485)
@@ -59,8 +59,8 @@
   //: Operator that returns the matrix cell at the given index.
   const float &operator[](int i) const { return matrix[i]; }
 
-  inline float&       operator()(int row, int col) { return matrix[4*row + col]; }
-  inline const float& operator()(int row, int col) const { return matrix[4*row + col]; }
+  inline float&       operator()(int row, int col) { return matrix[4*col + row]; }
+  inline const float& operator()(int row, int col) const { return matrix[4*col + row]; }
 
   //: Operator that returns the matrix cell at the given index.
   float &operator[](unsigned int i) { return matrix[i]; }

Modified: trunk/windstille/tools/bone_export.py
===================================================================
--- trunk/windstille/tools/bone_export.py	2007-06-21 02:00:52 UTC (rev 1484)
+++ trunk/windstille/tools/bone_export.py	2007-06-21 05:25:03 UTC (rev 1485)
@@ -13,9 +13,10 @@
     return "%f %f %f %f" % (quat.x, quat.y, quat.z, quat.w)
 
 def matrix2str(indent, m):
-        return          ("%9f %9f %9f\n" % (m[0][0], m[0][1], m[0][2])) + \
-           indent + ("%9f %9f %9f\n" % (m[1][0], m[1][1], m[1][2])) + \
-           indent + ("%9f %9f %9f" % (m[2][0], m[2][1], m[2][2]))
+        return          ("%9f %9f %9f %9f\n" % (m[0][0], m[0][1], m[0][2], 0)) + \
+               indent + ("%9f %9f %9f %9f\n" % (m[1][0], m[1][1], m[1][2], 0)) + \
+               indent + ("%9f %9f %9f %9f\n" % (m[2][0], m[2][1], m[2][2], 0)) + \
+               indent + ("%9f %9f %9f %9f"   % (      0,       0,       0, 1))
 
 def list2str(lst):
     str = ""
@@ -47,10 +48,10 @@
             # else in local bonespace
             if bone.parent:
                 out.write("      (parent    \"%s\")\n" % bone.parent.name)
-                out.write("      (head      %s)\n" % (vec2str(bone.head['BONESPACE']),))
+                out.write("      (head      %s)\n" % (vec2str(64*bone.head['BONESPACE']),))
             else:
                 out.write("      (parent )\n")
-                out.write("      (head      %s)\n" % (vec2str(bone.head['ARMATURESPACE']),))
+                out.write("      (head      %s)\n" % (vec2str(64*bone.head['ARMATURESPACE'])))
 
             out.write("      (length    %s)\n" % (bone.length*64))
             out.write("      (matrix   %s)\n" % matrix2str(" "*16, bone.matrix['BONESPACE']))
@@ -75,4 +76,4 @@
     print "done"
 print
 
-# EOF #
\ No newline at end of file
+# EOF #



From grumbel at mail.berlios.de  Thu Jun 21 08:45:01 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 21 Jun 2007 08:45:01 +0200
Subject: [Windstille-commit] r1486 - in trunk/windstille: data src
	src/armature tools
Message-ID: <200706210645.l5L6j1Gk013729@sheep.berlios.de>

Author: grumbel
Date: 2007-06-21 08:45:00 +0200 (Thu, 21 Jun 2007)
New Revision: 1486

Modified:
   trunk/windstille/data/armature.arm
   trunk/windstille/src/armature/armature.cpp
   trunk/windstille/src/armature_test.cpp
   trunk/windstille/tools/bone_export.py
Log:
- some more bug fixing, now works a little bit better

Modified: trunk/windstille/data/armature.arm
===================================================================
--- trunk/windstille/data/armature.arm	2007-06-21 05:25:03 UTC (rev 1485)
+++ trunk/windstille/data/armature.arm	2007-06-21 06:45:00 UTC (rev 1486)
@@ -1,62 +1,532 @@
 ;; -*- scheme -*-
 (armature
-  (name "Armature.001")
+  (name "Armature")
   (bones
     (bone
-      (name      "Base.001")
-      (children  "Base.002")
+      (name      "LegNull.L")
+      (children )
+      (parent    "Lower Leg.L")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.304411500692)
+      (matrix    0.999972 -0.007122 -0.002196  0.000000
+                 0.005368  0.892687 -0.450645  0.000000
+                 0.005170  0.450621  0.892701  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.231616 -0.001893 0.003210 0.972800)
+      (euler     26.783901 -0.296208 0.307588)
+     )
+
+    (bone
+      (name      "Hip.R")
+      (children  "Upper Leg.R")
       (parent    "Base")
+      (head      0.040620 -0.025407 0.039311)
+      (length    0.431728333235)
+      (matrix    0.464597  0.637705  0.614396  0.000000
+                 0.621588 -0.729017  0.286639  0.000000
+                 0.630696  0.248730 -0.735089  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.855673 -0.367926 -0.363775 0.011075)
+      (euler     161.305908 -39.101479 53.224243)
+     )
+
+    (bone
+      (name      "Foot.L")
+      (children  "Toes.L")
+      (parent    "Lower Leg.L")
       (head      0.000000 0.000000 0.000000)
-      (length    49.66381073)
-      (matrix    0.653362  0.757046  0.000013  0.000000
-                -0.757046  0.653362  0.000028  0.000000
-                 0.000013 -0.000028  1.000000  0.000000
+      (length    0.404503166676)
+      (matrix    0.906031 -0.132580 -0.401908  0.000000
+                 0.404751  0.548869  0.731382  0.000000
+                 0.123628 -0.825328  0.550954  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000016 -0.000000 0.416316 0.909220)
-      (euler     0.001619 -0.000743 49.204468)
+      (quat      -0.448946 -0.151561 0.154963 0.866870)
+      (euler     -56.274590 -7.101517 24.071728)
      )
 
     (bone
-      (name      "Base.002")
-      (children  "Base.003")
-      (parent    "Base.001")
+      (name      "Upper Arm.L")
+      (children  "Forearm.L")
+      (parent    "Shoulder.L")
+      (head      0.000000 -0.000000 -0.000000)
+      (length    0.532597243786)
+      (matrix    0.910775  0.149810 -0.384767  0.000000
+                -0.272327  0.918392 -0.287044  0.000000
+                 0.310365  0.366215  0.877246  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.169659 -0.180534 -0.109634 0.962602)
+      (euler     22.658560 -18.081207 -16.646976)
+     )
+
+    (bone
+      (name      "Belly")
+      (children )
+      (parent    "Base")
+      (head      0.000000 -0.023287 0.366125)
+      (length    0.353247851133)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000 -0.210548 -0.977584  0.000000
+                 0.000000  0.977584 -0.210548  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.777994 0.000000 0.000000 0.628272)
+      (euler     102.154457 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Upper Arm.R")
+      (children  "Forearm.R")
+      (parent    "Shoulder.R")
+      (head      0.000000 -0.000000 -0.000000)
+      (length    0.532600045204)
+      (matrix    0.910775 -0.149812  0.384766  0.000000
+                 0.272329  0.918392 -0.287043  0.000000
+                -0.310364  0.366214  0.877246  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.169659 0.180534 0.109635 0.962602)
+      (euler     22.658524 18.081169 16.647068)
+     )
+
+    (bone
+      (name      "Foot.R")
+      (children  "Toes.R")
+      (parent    "Lower Leg.R")
       (head      0.000000 0.000000 0.000000)
-      (length    54.4462547302)
-      (matrix    0.000000  1.000000  0.000000  0.000000
-                -1.000000  0.000000 -0.000000  0.000000
-                -0.000000 -0.000000  1.000000  0.000000
+      (length    0.40450361371)
+      (matrix    0.906031  0.132580  0.401908  0.000000
+                -0.404752  0.548868  0.731382  0.000000
+                -0.123628 -0.825328  0.550954  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.000000 -0.000000 0.707107 0.707107)
-      (euler     -0.000003 -0.000000 90.000000)
+      (quat      -0.448946 0.151562 -0.154963 0.866870)
+      (euler     -56.274628 7.101544 -24.071772)
      )
 
     (bone
-      (name      "Base.003")
+      (name      "Hip.L")
+      (children  "Upper Leg.L")
+      (parent    "Base")
+      (head      -0.039261 -0.025407 0.039311)
+      (length    0.431728303432)
+      (matrix    0.464598 -0.637705 -0.614396  0.000000
+                -0.621588 -0.729017  0.286638  0.000000
+                -0.630696  0.248730 -0.735089  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.855673 0.367926 0.363775 0.011075)
+      (euler     161.305908 39.101467 -53.224239)
+     )
+
+    (bone
+      (name      "LegNull.R")
       (children )
-      (parent    "Base.002")
+      (parent    "Lower Leg.R")
       (head      0.000000 0.000000 0.000000)
-      (length    66.5862960815)
-      (matrix    0.000000 -1.000000 -0.000000  0.000000
-                -0.000000 -0.000000  1.000000  0.000000
-                -1.000000 -0.000000 -0.000000  0.000000
+      (length    0.304411649704)
+      (matrix    0.999972  0.007122  0.002196  0.000000
+                -0.005368  0.892687 -0.450646  0.000000
+                -0.005170  0.450622  0.892700  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.500000 -0.500000 -0.500000 0.500000)
-      (euler     90.000008 0.000000 -90.000000)
+      (quat      0.231617 0.001893 -0.003210 0.972800)
+      (euler     26.783953 0.296216 -0.307581)
      )
 
+    (bone
+      (name      "Neck")
+      (children  "Head")
+      (parent    "Shoulders")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.265078783035)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000  0.779716 -0.626133  0.000000
+                 0.000000  0.626133  0.779716  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.331876 0.000000 0.000000 0.943323)
+      (euler     38.765373 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Hip")
+      (children  "Body")
+      (parent    "Base")
+      (head      0.000000 0.003058 0.001977)
+      (length    0.369722664356)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000  0.997063 -0.076591  0.000000
+                 0.000000  0.076591  0.997063  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.038324 0.000000 0.000000 0.999265)
+      (euler     4.392666 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Shoulders")
+      (children  "Shoulder.R" "Neck" "Shoulder.L")
+      (parent    "Body")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.273266792297)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000  0.999747 -0.022513  0.000000
+                 0.000000  0.022513  0.999747  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.011257 0.000000 0.000000 0.999937)
+      (euler     1.290010 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Shoulder.L")
+      (children  "Upper Arm.L")
+      (parent    "Shoulders")
+      (head      -0.133504 0.016665 -0.103217)
+      (length    0.469278693199)
+      (matrix   -0.211033 -0.881235 -0.422954  0.000000
+                -0.390487 -0.320669  0.862955  0.000000
+                -0.896094  0.347270 -0.276438  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.588658 0.540093 0.560193 0.219009)
+      (euler     -51.479076 116.350647 61.611572)
+     )
+
+    (bone
+      (name      "FingerTips.L")
+      (children )
+      (parent    "Fingers.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    0.108158022165)
+      (matrix    0.972665  0.118983  0.199413  0.000000
+                -0.148899  0.978544  0.142414  0.000000
+                -0.178189 -0.168213  0.969512  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.078438 0.095350 -0.067644 0.990040)
+      (euler     -9.842998 10.264305 -8.703465)
+     )
+
     (bone ;; a root bone
       (name      "Base")
-      (children  "Base.001")
+      (children  "Belly" "Hip.R" "Hip.L" "Hip")
       (parent )
-      (head      0.247892 6.338192 0.331998)
-      (length    67.0597305298)
-      (matrix    0.653362 -0.757046  0.000013  0.000000
-                 0.757046  0.653362 -0.000028  0.000000
-                 0.000013  0.000028  1.000000  0.000000
+      (head      -0.134862 -0.098326 -1.250145)
+      (length    0.226376548409)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000 -0.011341 -0.999936  0.000000
+                 0.000000  0.999936 -0.011341  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.000016 0.000000 -0.416316 0.909220)
-      (euler     -0.001622 -0.000743 -49.204472)
+      (quat      0.711105 0.000000 0.000000 0.703086)
+      (euler     90.649788 -0.000000 0.000000)
      )
 
+    (bone
+      (name      "FingerTips.R")
+      (children )
+      (parent    "Fingers.R")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.115987345576)
+      (matrix    0.983139 -0.114041 -0.142942  0.000000
+                 0.129104  0.986481  0.100931  0.000000
+                 0.129499 -0.117684  0.984571  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.054969 -0.068504 0.061137 0.994257)
+      (euler     -6.816106 -7.440639 7.481158)
+     )
+
+    (bone
+      (name      "Shoulder.R")
+      (children  "Upper Arm.R")
+      (parent    "Shoulders")
+      (head      0.134862 0.016665 -0.103217)
+      (length    0.469281166792)
+      (matrix   -0.211033  0.881236  0.422952  0.000000
+                 0.390486 -0.320668  0.862956  0.000000
+                 0.896095  0.347269 -0.276439  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.588658 -0.540093 -0.560192 0.219009)
+      (euler     -51.478897 -116.350609 -61.611641)
+     )
+
+    (bone
+      (name      "Body")
+      (children  "Shoulders")
+      (parent    "Hip")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.367126226425)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000  0.989207  0.146523  0.000000
+                 0.000000 -0.146523  0.989207  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.073460 0.000000 0.000000 0.997298)
+      (euler     -8.425457 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Toes.R")
+      (children )
+      (parent    "Foot.R")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.225673496723)
+      (matrix   -0.908818  0.133896  0.395123  0.000000
+                -0.133897  0.803379 -0.580218  0.000000
+                -0.395123 -0.580219 -0.712197  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.000000 0.925256 -0.313545 0.213521)
+      (euler     39.169296 156.726379 8.381133)
+     )
+
+    ;; ignoring bone: IK_Foot.R
+
+    (bone
+      (name      "Hand.L")
+      (children  "Fingers.L" "LowerThumb.L")
+      (parent    "Forearm.L")
+      (head      0.006394 0.036836 -0.005415)
+      (length    0.252678871155)
+      (matrix    0.997139  0.068329  0.032331  0.000000
+                -0.069244  0.997204  0.028089  0.000000
+                -0.030322 -0.030247  0.999082  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.014596 0.015676 -0.034421 0.999178)
+      (euler     -1.734116 1.737575 -3.972393)
+     )
+
+    (bone
+      (name      "Fingers.R")
+      (children  "FingerTips.R")
+      (parent    "Hand.R")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.121155895293)
+      (matrix    0.991391  0.094134 -0.091006  0.000000
+                -0.084731  0.991150  0.102183  0.000000
+                 0.099819 -0.093592  0.990594  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.049109 -0.047867 -0.044867 0.996636)
+      (euler     -5.397348 -5.728770 -4.885022)
+     )
+
+    (bone
+      (name      "Head")
+      (children )
+      (parent    "Neck")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.266009747982)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000  0.612928 -0.790139  0.000000
+                 0.000000  0.790139  0.612928  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.439927 0.000000 0.000000 0.898033)
+      (euler     52.198490 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Fingers.L")
+      (children  "FingerTips.L")
+      (parent    "Hand.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    0.123009525239)
+      (matrix    0.990993 -0.092455  0.096872  0.000000
+                 0.081849  0.990746  0.108271  0.000000
+                -0.105986 -0.099367  0.989390  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.052098 0.050899 0.043734 0.996385)
+      (euler     -5.735141 6.083977 4.721482)
+     )
+
+    ;; ignoring bone: IK_Foot.L
+
+    (bone
+      (name      "Hand.R")
+      (children  "Fingers.R" "LowerThumb.R")
+      (parent    "Forearm.R")
+      (head      -0.006394 0.036837 -0.005415)
+      (length    0.252679914236)
+      (matrix    0.997139 -0.068329 -0.032331  0.000000
+                 0.069244  0.997204  0.028089  0.000000
+                 0.030321 -0.030247  0.999082  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.014596 -0.015676 0.034422 0.999178)
+      (euler     -1.734102 -1.737553 3.972412)
+     )
+
+    (bone
+      (name      "Toes.L")
+      (children )
+      (parent    "Foot.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    0.225673496723)
+      (matrix   -0.908818 -0.133896 -0.395122  0.000000
+                 0.133897  0.803379 -0.580219  0.000000
+                 0.395121 -0.580219 -0.712197  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.000000 -0.925256 0.313545 0.213520)
+      (euler     39.169323 -156.726471 -8.381129)
+     )
+
+    (bone
+      (name      "Thumb.R")
+      (children )
+      (parent    "LowerThumb.R")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.124690048397)
+      (matrix    0.802272 -0.568549  0.181966  0.000000
+                 0.596654  0.753975 -0.274820  0.000000
+                 0.019050  0.329051  0.944120  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.161383 0.043539 0.311397 0.935463)
+      (euler     19.214825 -1.091575 36.638378)
+     )
+
+    (bone
+      (name      "Lower Leg.L")
+      (children  "Foot.L" "LegNull.L")
+      (parent    "Upper Leg.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    0.840111851692)
+      (matrix    0.999287  0.028426  0.024856  0.000000
+                -0.025254  0.992486 -0.119725  0.000000
+                -0.028072  0.119011  0.992496  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.059802 0.013258 -0.013447 0.998032)
+      (euler     6.837760 1.608639 -1.447701)
+     )
+
+    (bone
+      (name      "Upper Leg.R")
+      (children  "Lower Leg.R")
+      (parent    "Hip.R")
+      (head      -0.000384 0.012505 -0.020905)
+      (length    0.878771483898)
+      (matrix    0.491190 -0.550237 -0.675257  0.000000
+                 0.626030  0.762022 -0.165557  0.000000
+                 0.605656 -0.341411  0.718762  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.051004 -0.371507 0.341156 0.861971)
+      (euler     -25.407673 -37.276039 51.881908)
+     )
+
+    (bone
+      (name      "ArmNull.R")
+      (children )
+      (parent    "Forearm.R")
+      (head      -0.000000 0.000000 0.000000)
+      (length    0.225655779243)
+      (matrix   -0.071245  0.000001  0.997459  0.000000
+                 0.997459 -0.000002  0.071245  0.000000
+                 0.000002  1.000000 -0.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.481860 0.517504 0.517505 0.481859)
+      (euler     90.000023 -0.000106 94.085487)
+     )
+
+    (bone
+      (name      "LowerThumb.R")
+      (children  "Thumb.R")
+      (parent    "Hand.R")
+      (head      0.018833 -0.247973 -0.030859)
+      (length    0.186533346772)
+      (matrix    0.641058  0.720677 -0.263949  0.000000
+                -0.448956  0.631054  0.632621  0.000000
+                 0.622481 -0.287045  0.728095  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.265475 -0.255881 -0.337633 0.866055)
+      (euler     -21.516403 -38.497559 -35.004967)
+     )
+
+    ;; ignoring bone: IK_Arm.L
+
+    (bone
+      (name      "Thumb.L")
+      (children )
+      (parent    "LowerThumb.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    0.124689467251)
+      (matrix    0.802273  0.568549 -0.181960  0.000000
+                -0.596653  0.753976 -0.274820  0.000000
+                -0.019055  0.329048  0.944121  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.161382 -0.043536 -0.311397 0.935464)
+      (euler     19.214617 1.091853 -36.638290)
+     )
+
+    (bone
+      (name      "Forearm.L")
+      (children  "ArmNull.L" "Hand.L")
+      (parent    "Upper Arm.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    0.527911424637)
+      (matrix    0.999244  0.012327 -0.036882  0.000000
+                -0.013579  0.999333 -0.033897  0.000000
+                 0.036439  0.034372  0.998745  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.017073 -0.018336 -0.006479 0.999665)
+      (euler     1.971079 -2.088269 -0.778568)
+     )
+
+    (bone
+      (name      "Forearm.R")
+      (children  "ArmNull.R" "Hand.R")
+      (parent    "Upper Arm.R")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.527913451195)
+      (matrix    0.999244 -0.012328  0.036881  0.000000
+                 0.013580  0.999333 -0.033897  0.000000
+                -0.036439  0.034372  0.998745  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.017073 0.018336 0.006479 0.999665)
+      (euler     1.971067 2.088262 0.778603)
+     )
+
+    ;; ignoring bone: IK_Arm.R
+
+    (bone
+      (name      "LowerThumb.L")
+      (children  "Thumb.L")
+      (parent    "Hand.L")
+      (head      -0.018833 -0.247972 -0.030859)
+      (length    0.186534196138)
+      (matrix    0.641059 -0.720677  0.263946  0.000000
+                 0.448958  0.631054  0.632620  0.000000
+                -0.622479 -0.287046  0.728096  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.265475 0.255880 0.337633 0.866056)
+      (euler     -21.516415 38.497402 35.005032)
+     )
+
+    (bone
+      (name      "ArmNull.L")
+      (children )
+      (parent    "Forearm.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    0.225656166673)
+      (matrix   -0.071247 -0.000001 -0.997459  0.000000
+                -0.997459 -0.000002  0.071247  0.000000
+                -0.000002  1.000000 -0.000001  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.481860 -0.517505 -0.517506 0.481859)
+      (euler     90.000038 0.000113 -94.085594)
+     )
+
+    (bone
+      (name      "Lower Leg.R")
+      (children  "Foot.R" "LegNull.R")
+      (parent    "Upper Leg.R")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.840111613274)
+      (matrix    0.999287 -0.028426 -0.024860  0.000000
+                 0.025254  0.992486 -0.119725  0.000000
+                 0.028076  0.119011  0.992496  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.059802 -0.013260 0.013447 0.998032)
+      (euler     6.837764 -1.608874 1.447679)
+     )
+
+    (bone
+      (name      "Upper Leg.L")
+      (children  "Lower Leg.L")
+      (parent    "Hip.L")
+      (head      0.000384 0.012505 -0.020905)
+      (length    0.878771066666)
+      (matrix    0.491187  0.550237  0.675259  0.000000
+                -0.626029  0.762022 -0.165560  0.000000
+                -0.605659 -0.341411  0.718760  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.051003 0.371509 -0.341157 0.861970)
+      (euler     -25.407726 37.276268 -51.882030)
+     )
+
   ) ;; bones
  ) ;; armature

Modified: trunk/windstille/src/armature/armature.cpp
===================================================================
--- trunk/windstille/src/armature/armature.cpp	2007-06-21 05:25:03 UTC (rev 1485)
+++ trunk/windstille/src/armature/armature.cpp	2007-06-21 06:45:00 UTC (rev 1486)
@@ -122,36 +122,37 @@
 void
 Armature::draw()
 {
+  // For some reason OpenGL sometimes doesn't draw the lines properly,
+  // going to NavigationTester and then back fixes the issue
   OpenGLState state;
   state.color(Color(1.0f, 0.0f, 0.0f));
   state.activate();
 
+  //std::cout << "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX-" << std::endl;
   glBegin(GL_LINES);
   draw_bone(root_bone, Vector3(0,0, 0), Matrix::identity());
   glEnd();
-
 }
 
 void
 Armature::draw_bone(Bone* bone, Vector3 p, Matrix cur)
 {
-  Vector3 vec = Vector3(bone->length, 0.0f, 0.0f);
+  Vector3 vec = Vector3(0.0f, bone->length, 0.0f); // Where shall we apply bone length to?
   Matrix  mat = bone->matrix.multiply(cur);
   
-  //std::cout << "draw_bone" << std::endl;
-  //std::cout << "matrix: \n" << mat << std::endl;
-  //std::cout << "before: " << vec << std::endl;
-  vec = mat.multiply(vec);
-  //std::cout << "after: " << vec << std::endl;
-
-  
+  // std::cout << "--------------------------------------------------------------" << std::endl;
+  // std::cout << "draw_bone: " << bone->name << std::endl;
+  // std::cout << "bone matrix: \n" << bone->matrix << std::endl;
+  // std::cout << "matrix: \n" << mat << std::endl;
+  // std::cout << "before: " << vec << std::endl;
+  vec = bone->matrix.multiply(vec) + p;
+  // std::cout << "after: " << vec << std::endl;
+ 
   glVertex3f(  p.x,   p.y,   p.z);
   glVertex3f(vec.x, vec.y, vec.z);
 
   for(std::vector<Bone*>::iterator i = bone->children.begin(); i != bone->children.end(); ++i)  
-    {
-      draw_bone(*i, vec, mat);
-    }
+    draw_bone(*i, vec, mat);
 }
 
 /* EOF */

Modified: trunk/windstille/src/armature_test.cpp
===================================================================
--- trunk/windstille/src/armature_test.cpp	2007-06-21 05:25:03 UTC (rev 1485)
+++ trunk/windstille/src/armature_test.cpp	2007-06-21 06:45:00 UTC (rev 1486)
@@ -43,13 +43,13 @@
 void
 ArmatureTest::draw()
 {
-  SDL_Delay(30);
   glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
   glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
-  
+
   glPushMatrix();
 
   glTranslatef(400.0f, 300.0f, 0.0f);
+  glScalef(128.0f, 128.0f, 128.0f);
  
   glRotatef(xrot, 1.0f, 0.0f, 0.0f);
   glRotatef(yrot, 0.0f, 1.0f, 0.0f);

Modified: trunk/windstille/tools/bone_export.py
===================================================================
--- trunk/windstille/tools/bone_export.py	2007-06-21 05:25:03 UTC (rev 1485)
+++ trunk/windstille/tools/bone_export.py	2007-06-21 06:45:00 UTC (rev 1486)
@@ -48,12 +48,12 @@
             # else in local bonespace
             if bone.parent:
                 out.write("      (parent    \"%s\")\n" % bone.parent.name)
-                out.write("      (head      %s)\n" % (vec2str(64*bone.head['BONESPACE']),))
+                out.write("      (head      %s)\n" % (vec2str(bone.head['BONESPACE']),))
             else:
                 out.write("      (parent )\n")
-                out.write("      (head      %s)\n" % (vec2str(64*bone.head['ARMATURESPACE'])))
+                out.write("      (head      %s)\n" % (vec2str(bone.head['ARMATURESPACE'])))
 
-            out.write("      (length    %s)\n" % (bone.length*64))
+            out.write("      (length    %s)\n" % (bone.length))
             out.write("      (matrix   %s)\n" % matrix2str(" "*16, bone.matrix['BONESPACE']))
             out.write("      (quat      %s)\n" % quat2str(bone.matrix['BONESPACE'].toQuat()))
             out.write("      (euler     %s)\n" % euler2str(bone.matrix['BONESPACE'].toEuler()))



From grumbel at mail.berlios.de  Thu Jun 21 08:53:19 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 21 Jun 2007 08:53:19 +0200
Subject: [Windstille-commit] r1487 - in trunk/windstille: data src/armature
Message-ID: <200706210653.l5L6rJQ0014239@sheep.berlios.de>

Author: grumbel
Date: 2007-06-21 08:53:18 +0200 (Thu, 21 Jun 2007)
New Revision: 1487

Modified:
   trunk/windstille/data/armature.arm
   trunk/windstille/src/armature/armature.cpp
Log:
- now working, at least with this simple armature.arm

Modified: trunk/windstille/data/armature.arm
===================================================================
--- trunk/windstille/data/armature.arm	2007-06-21 06:45:00 UTC (rev 1486)
+++ trunk/windstille/data/armature.arm	2007-06-21 06:53:18 UTC (rev 1487)
@@ -1,532 +1,258 @@
 ;; -*- scheme -*-
 (armature
-  (name "Armature")
+  (name "Armature.002")
   (bones
     (bone
-      (name      "LegNull.L")
+      (name      "Bone.010")
       (children )
-      (parent    "Lower Leg.L")
+      (parent    "Bone.009")
       (head      0.000000 0.000000 0.000000)
-      (length    0.304411500692)
-      (matrix    0.999972 -0.007122 -0.002196  0.000000
-                 0.005368  0.892687 -0.450645  0.000000
-                 0.005170  0.450621  0.892701  0.000000
+      (length    0.643892884254)
+      (matrix   -0.123724 -0.992317  0.000001  0.000000
+                 0.992317 -0.123724  0.000000  0.000000
+                -0.000000  0.000001  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.231616 -0.001893 0.003210 0.972800)
-      (euler     26.783901 -0.296208 0.307588)
+      (quat      0.000000 0.000000 0.749575 0.661920)
+      (euler     0.000032 0.000001 97.107079)
      )
 
     (bone
-      (name      "Hip.R")
-      (children  "Upper Leg.R")
-      (parent    "Base")
-      (head      0.040620 -0.025407 0.039311)
-      (length    0.431728333235)
-      (matrix    0.464597  0.637705  0.614396  0.000000
-                 0.621588 -0.729017  0.286639  0.000000
-                 0.630696  0.248730 -0.735089  0.000000
+      (name      "Bone.004")
+      (children  "Bone.008")
+      (parent    "Bone.017")
+      (head      0.120711 -0.025305 0.000000)
+      (length    0.669082939625)
+      (matrix   -0.798968  0.601373 -0.000000  0.000000
+                -0.601373 -0.798968 -0.000000  0.000000
+                -0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.855673 -0.367926 -0.363775 0.011075)
-      (euler     161.305908 -39.101479 53.224243)
+      (quat      0.000000 0.000000 -0.948411 0.317042)
+      (euler     0.000004 0.000012 -143.031693)
      )
 
     (bone
-      (name      "Foot.L")
-      (children  "Toes.L")
-      (parent    "Lower Leg.L")
-      (head      0.000000 0.000000 0.000000)
-      (length    0.404503166676)
-      (matrix    0.906031 -0.132580 -0.401908  0.000000
-                 0.404751  0.548869  0.731382  0.000000
-                 0.123628 -0.825328  0.550954  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.448946 -0.151561 0.154963 0.866870)
-      (euler     -56.274590 -7.101517 24.071728)
-     )
-
-    (bone
-      (name      "Upper Arm.L")
-      (children  "Forearm.L")
-      (parent    "Shoulder.L")
-      (head      0.000000 -0.000000 -0.000000)
-      (length    0.532597243786)
-      (matrix    0.910775  0.149810 -0.384767  0.000000
-                -0.272327  0.918392 -0.287044  0.000000
-                 0.310365  0.366215  0.877246  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      0.169659 -0.180534 -0.109634 0.962602)
-      (euler     22.658560 -18.081207 -16.646976)
-     )
-
-    (bone
-      (name      "Belly")
+      (name      "Bone.007")
       (children )
-      (parent    "Base")
-      (head      0.000000 -0.023287 0.366125)
-      (length    0.353247851133)
-      (matrix    1.000000  0.000000  0.000000  0.000000
-                 0.000000 -0.210548 -0.977584  0.000000
-                 0.000000  0.977584 -0.210548  0.000000
+      (parent    "Bone.006")
+      (head      -0.000000 0.000000 0.000000)
+      (length    0.412145078182)
+      (matrix    0.089845  0.995956 -0.000002  0.000000
+                -0.995956  0.089845  0.000000  0.000000
+                 0.000000  0.000002  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.777994 0.000000 0.000000 0.628272)
-      (euler     102.154457 -0.000000 0.000000)
+      (quat      0.000001 -0.000001 -0.674594 0.738189)
+      (euler     0.000125 -0.000012 -84.845291)
      )
 
     (bone
-      (name      "Upper Arm.R")
-      (children  "Forearm.R")
-      (parent    "Shoulder.R")
-      (head      0.000000 -0.000000 -0.000000)
-      (length    0.532600045204)
-      (matrix    0.910775 -0.149812  0.384766  0.000000
-                 0.272329  0.918392 -0.287043  0.000000
-                -0.310364  0.366214  0.877246  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      0.169659 0.180534 0.109635 0.962602)
-      (euler     22.658524 18.081169 16.647068)
-     )
-
-    (bone
-      (name      "Foot.R")
-      (children  "Toes.R")
-      (parent    "Lower Leg.R")
+      (name      "Bone.006")
+      (children  "Bone.007")
+      (parent    "Bone.005")
       (head      0.000000 0.000000 0.000000)
-      (length    0.40450361371)
-      (matrix    0.906031  0.132580  0.401908  0.000000
-                -0.404752  0.548868  0.731382  0.000000
-                -0.123628 -0.825328  0.550954  0.000000
+      (length    0.460424602032)
+      (matrix    0.975521 -0.219906  0.000003  0.000000
+                 0.219906  0.975521  0.000000  0.000000
+                -0.000003  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.448946 0.151562 -0.154963 0.866870)
-      (euler     -56.274628 7.101544 -24.071772)
+      (quat      -0.000000 0.000001 0.110632 0.993861)
+      (euler     0.000007 0.000158 12.703509)
      )
 
     (bone
-      (name      "Hip.L")
-      (children  "Upper Leg.L")
-      (parent    "Base")
-      (head      -0.039261 -0.025407 0.039311)
-      (length    0.431728303432)
-      (matrix    0.464598 -0.637705 -0.614396  0.000000
-                -0.621588 -0.729017  0.286638  0.000000
-                -0.630696  0.248730 -0.735089  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.855673 0.367926 0.363775 0.011075)
-      (euler     161.305908 39.101467 -53.224239)
-     )
-
-    (bone
-      (name      "LegNull.R")
+      (name      "Bone.016")
       (children )
-      (parent    "Lower Leg.R")
+      (parent    "Bone.015")
       (head      0.000000 0.000000 0.000000)
-      (length    0.304411649704)
-      (matrix    0.999972  0.007122  0.002196  0.000000
-                -0.005368  0.892687 -0.450646  0.000000
-                -0.005170  0.450622  0.892700  0.000000
+      (length    0.380072444677)
+      (matrix   -0.162390 -0.986727 -0.000000  0.000000
+                 0.986727 -0.162390 -0.000000  0.000000
+                 0.000000 -0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.231617 0.001893 -0.003210 0.972800)
-      (euler     26.783953 0.296216 -0.307581)
+      (quat      -0.000000 -0.000000 0.762361 0.647151)
+      (euler     -0.000003 -0.000000 99.345650)
      )
 
     (bone
-      (name      "Neck")
-      (children  "Head")
-      (parent    "Shoulders")
-      (head      0.000000 0.000000 0.000000)
-      (length    0.265078783035)
-      (matrix    1.000000  0.000000  0.000000  0.000000
-                 0.000000  0.779716 -0.626133  0.000000
-                 0.000000  0.626133  0.779716  0.000000
+      (name      "Bone.008")
+      (children  "Bone.009")
+      (parent    "Bone.004")
+      (head      -0.000000 0.000000 0.000000)
+      (length    0.534853696823)
+      (matrix    0.817942  0.575301  0.000002  0.000000
+                -0.575301  0.817942 -0.000002  0.000000
+                -0.000003  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.331876 0.000000 0.000000 0.943323)
-      (euler     38.765373 -0.000000 0.000000)
+      (quat      0.000000 0.000001 -0.301710 0.953400)
+      (euler     0.000006 0.000148 -35.120697)
      )
 
     (bone
-      (name      "Hip")
-      (children  "Body")
-      (parent    "Base")
-      (head      0.000000 0.003058 0.001977)
-      (length    0.369722664356)
-      (matrix    1.000000  0.000000  0.000000  0.000000
-                 0.000000  0.997063 -0.076591  0.000000
-                 0.000000  0.076591  0.997063  0.000000
+      (name      "Bone.009")
+      (children  "Bone.010")
+      (parent    "Bone.008")
+      (head      -0.000000 0.000000 0.000000)
+      (length    0.528390049934)
+      (matrix    0.984875  0.173265 -0.000003  0.000000
+                -0.173265  0.984875  0.000000  0.000000
+                 0.000003  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.038324 0.000000 0.000000 0.999265)
-      (euler     4.392666 -0.000000 0.000000)
+      (quat      0.000000 -0.000002 -0.086962 0.996212)
+      (euler     0.000027 -0.000188 -9.977681)
      )
 
     (bone
-      (name      "Shoulders")
-      (children  "Shoulder.R" "Neck" "Shoulder.L")
-      (parent    "Body")
+      (name      "Bone.015")
+      (children  "Bone.016")
+      (parent    "Bone")
       (head      0.000000 0.000000 0.000000)
-      (length    0.273266792297)
-      (matrix    1.000000  0.000000  0.000000  0.000000
-                 0.000000  0.999747 -0.022513  0.000000
-                 0.000000  0.022513  0.999747  0.000000
+      (length    0.392938047647)
+      (matrix    0.994743  0.102400  0.000000  0.000000
+                -0.102400  0.994743  0.000000  0.000000
+                 0.000000 -0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.011257 0.000000 0.000000 0.999937)
-      (euler     1.290010 -0.000000 0.000000)
+      (quat      -0.000000 0.000000 -0.051267 0.998685)
+      (euler     -0.000003 -0.000000 -5.877396)
      )
 
     (bone
-      (name      "Shoulder.L")
-      (children  "Upper Arm.L")
-      (parent    "Shoulders")
-      (head      -0.133504 0.016665 -0.103217)
-      (length    0.469278693199)
-      (matrix   -0.211033 -0.881235 -0.422954  0.000000
-                -0.390487 -0.320669  0.862955  0.000000
-                -0.896094  0.347270 -0.276438  0.000000
+      (name      "Bone.005")
+      (children  "Bone.006")
+      (parent    "Bone.003")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.571729123592)
+      (matrix    0.782333 -0.622860 -0.000000  0.000000
+                 0.622860  0.782333 -0.000000  0.000000
+                 0.000001  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.588658 0.540093 0.560193 0.219009)
-      (euler     -51.479076 116.350647 61.611572)
+      (quat      0.000000 -0.000000 0.329899 0.944016)
+      (euler     0.000003 -0.000030 38.525307)
      )
 
     (bone
-      (name      "FingerTips.L")
+      (name      "Bone.012")
       (children )
-      (parent    "Fingers.L")
-      (head      0.000000 -0.000000 0.000000)
-      (length    0.108158022165)
-      (matrix    0.972665  0.118983  0.199413  0.000000
-                -0.148899  0.978544  0.142414  0.000000
-                -0.178189 -0.168213  0.969512  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.078438 0.095350 -0.067644 0.990040)
-      (euler     -9.842998 10.264305 -8.703465)
-     )
-
-    (bone ;; a root bone
-      (name      "Base")
-      (children  "Belly" "Hip.R" "Hip.L" "Hip")
-      (parent )
-      (head      -0.134862 -0.098326 -1.250145)
-      (length    0.226376548409)
-      (matrix    1.000000  0.000000  0.000000  0.000000
-                 0.000000 -0.011341 -0.999936  0.000000
-                 0.000000  0.999936 -0.011341  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      0.711105 0.000000 0.000000 0.703086)
-      (euler     90.649788 -0.000000 0.000000)
-     )
-
-    (bone
-      (name      "FingerTips.R")
-      (children )
-      (parent    "Fingers.R")
+      (parent    "Bone.011")
       (head      0.000000 0.000000 0.000000)
-      (length    0.115987345576)
-      (matrix    0.983139 -0.114041 -0.142942  0.000000
-                 0.129104  0.986481  0.100931  0.000000
-                 0.129499 -0.117684  0.984571  0.000000
+      (length    0.673586189747)
+      (matrix    0.962826  0.270121  0.000000  0.000000
+                -0.270121  0.962826  0.000000  0.000000
+                -0.000000 -0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.054969 -0.068504 0.061137 0.994257)
-      (euler     -6.816106 -7.440639 7.481158)
+      (quat      -0.000000 0.000000 -0.136333 0.990663)
+      (euler     -0.000007 0.000016 -15.671446)
      )
 
     (bone
-      (name      "Shoulder.R")
-      (children  "Upper Arm.R")
-      (parent    "Shoulders")
-      (head      0.134862 0.016665 -0.103217)
-      (length    0.469281166792)
-      (matrix   -0.211033  0.881236  0.422952  0.000000
-                 0.390486 -0.320668  0.862956  0.000000
-                 0.896095  0.347269 -0.276439  0.000000
+      (name      "Bone.013")
+      (children  "Bone.014")
+      (parent    "Bone.001")
+      (head      -0.000000 0.000000 0.000000)
+      (length    0.552089571953)
+      (matrix    0.497525  0.867449  0.000000  0.000000
+                -0.867449  0.497525 -0.000000  0.000000
+                -0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.588658 -0.540093 -0.560192 0.219009)
-      (euler     -51.478897 -116.350609 -61.611641)
+      (quat      0.000000 0.000000 -0.501236 0.865311)
+      (euler     0.000006 0.000023 -60.163593)
      )
 
     (bone
-      (name      "Body")
-      (children  "Shoulders")
-      (parent    "Hip")
+      (name      "Bone.001")
+      (children  "Bone.013")
+      (parent    "Bone")
       (head      0.000000 0.000000 0.000000)
-      (length    0.367126226425)
-      (matrix    1.000000  0.000000  0.000000  0.000000
-                 0.000000  0.989207  0.146523  0.000000
-                 0.000000 -0.146523  0.989207  0.000000
+      (length    0.780920624733)
+      (matrix   -0.264986  0.964252 -0.000000  0.000000
+                -0.964252 -0.264986 -0.000000  0.000000
+                -0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.073460 0.000000 0.000000 0.997298)
-      (euler     -8.425457 -0.000000 0.000000)
+      (quat      0.000000 0.000000 -0.795294 0.606224)
+      (euler     0.000003 0.000004 -105.366104)
      )
 
     (bone
-      (name      "Toes.R")
-      (children )
-      (parent    "Foot.R")
+      (name      "Bone.002")
+      (children  "Bone.011")
+      (parent    "Bone")
       (head      0.000000 0.000000 0.000000)
-      (length    0.225673496723)
-      (matrix   -0.908818  0.133896  0.395123  0.000000
-                -0.133897  0.803379 -0.580218  0.000000
-                -0.395123 -0.580219 -0.712197  0.000000
+      (length    0.73281288147)
+      (matrix   -0.290226 -0.956958  0.000000  0.000000
+                 0.956958 -0.290226 -0.000000  0.000000
+                 0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.000000 0.925256 -0.313545 0.213521)
-      (euler     39.169296 156.726379 8.381133)
+      (quat      0.000000 -0.000000 0.803189 0.595724)
+      (euler     0.000003 -0.000005 106.871460)
      )
 
-    ;; ignoring bone: IK_Foot.R
-
     (bone
-      (name      "Hand.L")
-      (children  "Fingers.L" "LowerThumb.L")
-      (parent    "Forearm.L")
-      (head      0.006394 0.036836 -0.005415)
-      (length    0.252678871155)
-      (matrix    0.997139  0.068329  0.032331  0.000000
-                -0.069244  0.997204  0.028089  0.000000
-                -0.030322 -0.030247  0.999082  0.000000
+      (name      "Bone.003")
+      (children  "Bone.005")
+      (parent    "Bone.017")
+      (head      -0.080474 -0.013809 -0.000000)
+      (length    0.692165970802)
+      (matrix   -0.664364 -0.747409  0.000000  0.000000
+                 0.747409 -0.664364 -0.000000  0.000000
+                 0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.014596 0.015676 -0.034421 0.999178)
-      (euler     -1.734116 1.737575 -3.972393)
+      (quat      0.000000 0.000000 0.912240 0.409656)
+      (euler     0.000000 -0.000000 131.633560)
      )
 
-    (bone
-      (name      "Fingers.R")
-      (children  "FingerTips.R")
-      (parent    "Hand.R")
-      (head      0.000000 0.000000 0.000000)
-      (length    0.121155895293)
-      (matrix    0.991391  0.094134 -0.091006  0.000000
-                -0.084731  0.991150  0.102183  0.000000
-                 0.099819 -0.093592  0.990594  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.049109 -0.047867 -0.044867 0.996636)
-      (euler     -5.397348 -5.728770 -4.885022)
-     )
-
-    (bone
-      (name      "Head")
-      (children )
-      (parent    "Neck")
-      (head      0.000000 0.000000 0.000000)
-      (length    0.266009747982)
+    (bone ;; a root bone
+      (name      "Bone.017")
+      (children  "Bone" "Bone.003" "Bone.004")
+      (parent )
+      (head      0.000000 0.979157 -0.000000)
+      (length    0.259003162384)
       (matrix    1.000000  0.000000  0.000000  0.000000
-                 0.000000  0.612928 -0.790139  0.000000
-                 0.000000  0.790139  0.612928  0.000000
+                 0.000000  1.000000  0.000000  0.000000
+                 0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.439927 0.000000 0.000000 0.898033)
-      (euler     52.198490 -0.000000 0.000000)
+      (quat      0.000000 0.000000 0.000000 1.000000)
+      (euler     0.000000 -0.000000 0.000000)
      )
 
     (bone
-      (name      "Fingers.L")
-      (children  "FingerTips.L")
-      (parent    "Hand.L")
-      (head      0.000000 -0.000000 0.000000)
-      (length    0.123009525239)
-      (matrix    0.990993 -0.092455  0.096872  0.000000
-                 0.081849  0.990746  0.108271  0.000000
-                -0.105986 -0.099367  0.989390  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.052098 0.050899 0.043734 0.996385)
-      (euler     -5.735141 6.083977 4.721482)
-     )
-
-    ;; ignoring bone: IK_Foot.L
-
-    (bone
-      (name      "Hand.R")
-      (children  "Fingers.R" "LowerThumb.R")
-      (parent    "Forearm.R")
-      (head      -0.006394 0.036837 -0.005415)
-      (length    0.252679914236)
-      (matrix    0.997139 -0.068329 -0.032331  0.000000
-                 0.069244  0.997204  0.028089  0.000000
-                 0.030321 -0.030247  0.999082  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.014596 -0.015676 0.034422 0.999178)
-      (euler     -1.734102 -1.737553 3.972412)
-     )
-
-    (bone
-      (name      "Toes.L")
-      (children )
-      (parent    "Foot.L")
-      (head      0.000000 -0.000000 0.000000)
-      (length    0.225673496723)
-      (matrix   -0.908818 -0.133896 -0.395122  0.000000
-                 0.133897  0.803379 -0.580219  0.000000
-                 0.395121 -0.580219 -0.712197  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.000000 -0.925256 0.313545 0.213520)
-      (euler     39.169323 -156.726471 -8.381129)
-     )
-
-    (bone
-      (name      "Thumb.R")
-      (children )
-      (parent    "LowerThumb.R")
+      (name      "Bone.011")
+      (children  "Bone.012")
+      (parent    "Bone.002")
       (head      0.000000 0.000000 0.000000)
-      (length    0.124690048397)
-      (matrix    0.802272 -0.568549  0.181966  0.000000
-                 0.596654  0.753975 -0.274820  0.000000
-                 0.019050  0.329051  0.944120  0.000000
+      (length    0.563668251038)
+      (matrix    0.479301 -0.877651 -0.000000  0.000000
+                 0.877651  0.479301 -0.000000  0.000000
+                 0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.161383 0.043539 0.311397 0.935463)
-      (euler     19.214825 -1.091575 36.638378)
+      (quat      0.000000 -0.000000 0.510245 0.860029)
+      (euler     0.000005 -0.000019 61.360249)
      )
 
     (bone
-      (name      "Lower Leg.L")
-      (children  "Foot.L" "LegNull.L")
-      (parent    "Upper Leg.L")
-      (head      0.000000 -0.000000 0.000000)
-      (length    0.840111851692)
-      (matrix    0.999287  0.028426  0.024856  0.000000
-                -0.025254  0.992486 -0.119725  0.000000
-                -0.028072  0.119011  0.992496  0.000000
+      (name      "Bone")
+      (children  "Bone.001" "Bone.002" "Bone.015")
+      (parent    "Bone.017")
+      (head      0.000000 0.106902 -0.000000)
+      (length    0.844800710678)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000  1.000000  0.000000  0.000000
+                 0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.059802 0.013258 -0.013447 0.998032)
-      (euler     6.837760 1.608639 -1.447701)
+      (quat      0.000000 0.000000 0.000000 1.000000)
+      (euler     0.000000 -0.000000 0.000000)
      )
 
     (bone
-      (name      "Upper Leg.R")
-      (children  "Lower Leg.R")
-      (parent    "Hip.R")
-      (head      -0.000384 0.012505 -0.020905)
-      (length    0.878771483898)
-      (matrix    0.491190 -0.550237 -0.675257  0.000000
-                 0.626030  0.762022 -0.165557  0.000000
-                 0.605656 -0.341411  0.718762  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.051004 -0.371507 0.341156 0.861971)
-      (euler     -25.407673 -37.276039 51.881908)
-     )
-
-    (bone
-      (name      "ArmNull.R")
+      (name      "Bone.014")
       (children )
-      (parent    "Forearm.R")
+      (parent    "Bone.013")
       (head      -0.000000 0.000000 0.000000)
-      (length    0.225655779243)
-      (matrix   -0.071245  0.000001  0.997459  0.000000
-                 0.997459 -0.000002  0.071245  0.000000
-                 0.000002  1.000000 -0.000000  0.000000
+      (length    0.492631494999)
+      (matrix    0.998603  0.052845  0.000000  0.000000
+                -0.052845  0.998603 -0.000000  0.000000
+                -0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.481860 0.517504 0.517505 0.481859)
-      (euler     90.000023 -0.000106 94.085487)
+      (quat      0.000000 0.000000 -0.026432 0.999651)
+      (euler     0.000001 0.000007 -3.029227)
      )
 
-    (bone
-      (name      "LowerThumb.R")
-      (children  "Thumb.R")
-      (parent    "Hand.R")
-      (head      0.018833 -0.247973 -0.030859)
-      (length    0.186533346772)
-      (matrix    0.641058  0.720677 -0.263949  0.000000
-                -0.448956  0.631054  0.632621  0.000000
-                 0.622481 -0.287045  0.728095  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.265475 -0.255881 -0.337633 0.866055)
-      (euler     -21.516403 -38.497559 -35.004967)
-     )
-
-    ;; ignoring bone: IK_Arm.L
-
-    (bone
-      (name      "Thumb.L")
-      (children )
-      (parent    "LowerThumb.L")
-      (head      0.000000 -0.000000 0.000000)
-      (length    0.124689467251)
-      (matrix    0.802273  0.568549 -0.181960  0.000000
-                -0.596653  0.753976 -0.274820  0.000000
-                -0.019055  0.329048  0.944121  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      0.161382 -0.043536 -0.311397 0.935464)
-      (euler     19.214617 1.091853 -36.638290)
-     )
-
-    (bone
-      (name      "Forearm.L")
-      (children  "ArmNull.L" "Hand.L")
-      (parent    "Upper Arm.L")
-      (head      0.000000 -0.000000 0.000000)
-      (length    0.527911424637)
-      (matrix    0.999244  0.012327 -0.036882  0.000000
-                -0.013579  0.999333 -0.033897  0.000000
-                 0.036439  0.034372  0.998745  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      0.017073 -0.018336 -0.006479 0.999665)
-      (euler     1.971079 -2.088269 -0.778568)
-     )
-
-    (bone
-      (name      "Forearm.R")
-      (children  "ArmNull.R" "Hand.R")
-      (parent    "Upper Arm.R")
-      (head      0.000000 0.000000 0.000000)
-      (length    0.527913451195)
-      (matrix    0.999244 -0.012328  0.036881  0.000000
-                 0.013580  0.999333 -0.033897  0.000000
-                -0.036439  0.034372  0.998745  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      0.017073 0.018336 0.006479 0.999665)
-      (euler     1.971067 2.088262 0.778603)
-     )
-
-    ;; ignoring bone: IK_Arm.R
-
-    (bone
-      (name      "LowerThumb.L")
-      (children  "Thumb.L")
-      (parent    "Hand.L")
-      (head      -0.018833 -0.247972 -0.030859)
-      (length    0.186534196138)
-      (matrix    0.641059 -0.720677  0.263946  0.000000
-                 0.448958  0.631054  0.632620  0.000000
-                -0.622479 -0.287046  0.728096  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.265475 0.255880 0.337633 0.866056)
-      (euler     -21.516415 38.497402 35.005032)
-     )
-
-    (bone
-      (name      "ArmNull.L")
-      (children )
-      (parent    "Forearm.L")
-      (head      0.000000 -0.000000 0.000000)
-      (length    0.225656166673)
-      (matrix   -0.071247 -0.000001 -0.997459  0.000000
-                -0.997459 -0.000002  0.071247  0.000000
-                -0.000002  1.000000 -0.000001  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      0.481860 -0.517505 -0.517506 0.481859)
-      (euler     90.000038 0.000113 -94.085594)
-     )
-
-    (bone
-      (name      "Lower Leg.R")
-      (children  "Foot.R" "LegNull.R")
-      (parent    "Upper Leg.R")
-      (head      0.000000 0.000000 0.000000)
-      (length    0.840111613274)
-      (matrix    0.999287 -0.028426 -0.024860  0.000000
-                 0.025254  0.992486 -0.119725  0.000000
-                 0.028076  0.119011  0.992496  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      0.059802 -0.013260 0.013447 0.998032)
-      (euler     6.837764 -1.608874 1.447679)
-     )
-
-    (bone
-      (name      "Upper Leg.L")
-      (children  "Lower Leg.L")
-      (parent    "Hip.L")
-      (head      0.000384 0.012505 -0.020905)
-      (length    0.878771066666)
-      (matrix    0.491187  0.550237  0.675259  0.000000
-                -0.626029  0.762022 -0.165560  0.000000
-                -0.605659 -0.341411  0.718760  0.000000
-                 0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.051003 0.371509 -0.341157 0.861970)
-      (euler     -25.407726 37.276268 -51.882030)
-     )
-
   ) ;; bones
  ) ;; armature

Modified: trunk/windstille/src/armature/armature.cpp
===================================================================
--- trunk/windstille/src/armature/armature.cpp	2007-06-21 06:45:00 UTC (rev 1486)
+++ trunk/windstille/src/armature/armature.cpp	2007-06-21 06:53:18 UTC (rev 1487)
@@ -137,7 +137,8 @@
 void
 Armature::draw_bone(Bone* bone, Vector3 p, Matrix cur)
 {
-  Vector3 vec = Vector3(0.0f, bone->length, 0.0f); // Where shall we apply bone length to?
+  // In theory we should be using Z, but Y seems to work?!
+  Vector3 vec = Vector3(0.0f, bone->length,  0.0f); 
   Matrix  mat = bone->matrix.multiply(cur);
   
   // std::cout << "--------------------------------------------------------------" << std::endl;
@@ -145,7 +146,7 @@
   // std::cout << "bone matrix: \n" << bone->matrix << std::endl;
   // std::cout << "matrix: \n" << mat << std::endl;
   // std::cout << "before: " << vec << std::endl;
-  vec = bone->matrix.multiply(vec) + p;
+  vec = mat.multiply(vec) + p;
   // std::cout << "after: " << vec << std::endl;
  
   glVertex3f(  p.x,   p.y,   p.z);



From grumbel at mail.berlios.de  Thu Jun 21 09:20:00 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 21 Jun 2007 09:20:00 +0200
Subject: [Windstille-commit] r1488 - in trunk/windstille: src/armature tools
Message-ID: <200706210720.l5L7K07C016133@sheep.berlios.de>

Author: grumbel
Date: 2007-06-21 09:19:59 +0200 (Thu, 21 Jun 2007)
New Revision: 1488

Added:
   trunk/windstille/tools/bone_test.blend
Modified:
   trunk/windstille/src/armature/armature.cpp
   trunk/windstille/src/armature/bone.hpp
Log:
- added some offset support (might be buggy)
- added some test cases in form of a .blend

Modified: trunk/windstille/src/armature/armature.cpp
===================================================================
--- trunk/windstille/src/armature/armature.cpp	2007-06-21 06:53:18 UTC (rev 1487)
+++ trunk/windstille/src/armature/armature.cpp	2007-06-21 07:19:59 UTC (rev 1488)
@@ -63,7 +63,7 @@
                     i->get("length",   bone->length) &&
                     i->get("quat",     bone->quat) &&
                     i->get("matrix",   bone->matrix) &&
-                    i->get("head",     bone->head)))
+                    i->get("head",     bone->offset)))
                 {
                   std::cout << "Error: some Bone attribute missing" << std::endl;
                   delete bone;
@@ -141,15 +141,31 @@
   Vector3 vec = Vector3(0.0f, bone->length,  0.0f); 
   Matrix  mat = bone->matrix.multiply(cur);
   
+  // Issues: 
+  // - don't mess with the root bone
+  // - offsets are ignored
+
   // std::cout << "--------------------------------------------------------------" << std::endl;
   // std::cout << "draw_bone: " << bone->name << std::endl;
   // std::cout << "bone matrix: \n" << bone->matrix << std::endl;
   // std::cout << "matrix: \n" << mat << std::endl;
   // std::cout << "before: " << vec << std::endl;
-  vec = mat.multiply(vec) + p;
+  vec = mat.multiply(vec) + p + bone->offset;
   // std::cout << "after: " << vec << std::endl;
- 
-  glVertex3f(  p.x,   p.y,   p.z);
+
+ // do we need to rotate the offset?
+  Vector3 p_ = p + bone->offset;
+
+  // p to p+offset
+  glColor3f(0.0f, 0.5f, 0.0f);
+  glVertex3f(  p.x, p.y, p.z);
+  glColor3f(0.0f, 1.0f, 0.0f);
+  glVertex3f( p_.x, p_.y, p_.z);  
+
+  // p to vec
+  glColor3f(0.7f, 0.0f, 0.0f);
+  glVertex3f(  p_.x,   p_.y,   p_.z);
+  glColor3f(1.0f, 0.0f, 0.0f);
   glVertex3f(vec.x, vec.y, vec.z);
 
   for(std::vector<Bone*>::iterator i = bone->children.begin(); i != bone->children.end(); ++i)  

Modified: trunk/windstille/src/armature/bone.hpp
===================================================================
--- trunk/windstille/src/armature/bone.hpp	2007-06-21 06:53:18 UTC (rev 1487)
+++ trunk/windstille/src/armature/bone.hpp	2007-06-21 07:19:59 UTC (rev 1488)
@@ -49,7 +49,7 @@
 
   Quaternion quat;
   Matrix     matrix;
-  Vector3    head;
+  Vector3    offset;
   
   Bone();
   ~Bone();

Added: trunk/windstille/tools/bone_test.blend
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/tools/bone_test.blend
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From grumbel at mail.berlios.de  Thu Jun 21 19:43:09 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 21 Jun 2007 19:43:09 +0200
Subject: [Windstille-commit] r1489 - in trunk/windstille: . data src
	src/armature tools
Message-ID: <200706211743.l5LHh9Y1007647@sheep.berlios.de>

Author: grumbel
Date: 2007-06-21 19:43:08 +0200 (Thu, 21 Jun 2007)
New Revision: 1489

Modified:
   trunk/windstille/TODO
   trunk/windstille/data/armature.arm
   trunk/windstille/src/armature/armature.cpp
   trunk/windstille/src/armature_test.cpp
   trunk/windstille/tools/bone_test.blend
Log:
- as it seems, bone import now fully working! *<:-)

Modified: trunk/windstille/TODO
===================================================================
--- trunk/windstille/TODO	2007-06-21 07:19:59 UTC (rev 1488)
+++ trunk/windstille/TODO	2007-06-21 17:43:08 UTC (rev 1489)
@@ -49,5 +49,7 @@
 - add line numbers to error messages from lisp
 - fix memory leak in SExprFileReader
 - use non-euler angles in the model viewer
+- setting glLineWidth() leads to some interesting artefacts on the
+  menus which might be a cool effect
 
 # EOF #

Modified: trunk/windstille/data/armature.arm
===================================================================
--- trunk/windstille/data/armature.arm	2007-06-21 07:19:59 UTC (rev 1488)
+++ trunk/windstille/data/armature.arm	2007-06-21 17:43:08 UTC (rev 1489)
@@ -4,119 +4,161 @@
   (bones
     (bone
       (name      "Bone.010")
-      (children )
+    	  (children )
       (parent    "Bone.009")
-      (head      0.000000 0.000000 0.000000)
-      (length    0.643892884254)
-      (matrix   -0.123724 -0.992317  0.000001  0.000000
-                 0.992317 -0.123724  0.000000  0.000000
-                -0.000000  0.000001  1.000000  0.000000
+      (head      -0.000000 -0.000000 0.000000)
+      (length    0.609991371632)
+      (matrix   -0.885632 -0.399715  0.236399  0.000000
+                 0.281300 -0.056720  0.957942  0.000000
+                -0.369496  0.914883  0.162673  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 0.000000 0.749575 0.661920)
-      (euler     0.000032 0.000001 97.107079)
+      (quat      -0.045868 0.645414 0.725435 0.234692)
+      (euler     79.917725 21.684511 162.378754)
      )
 
     (bone
+      (name      "Bone.009")
+    	  (children  "Bone.010")
+      (parent    "Bone.008")
+      (head      0.000000 -0.000000 -0.000000)
+      (length    0.528390169144)
+      (matrix    0.984876  0.173264 -0.000002  0.000000
+                -0.173264  0.984876 -0.000000  0.000000
+                 0.000002  0.000000  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.000000 -0.000001 -0.086961 0.996212)
+      (euler     0.000021 -0.000104 -9.977630)
+     )
+
+    (bone
       (name      "Bone.004")
-      (children  "Bone.008")
+    	  (children  "Bone.008")
       (parent    "Bone.017")
       (head      0.120711 -0.025305 0.000000)
       (length    0.669082939625)
-      (matrix   -0.798968  0.601373 -0.000000  0.000000
-                -0.601373 -0.798968 -0.000000  0.000000
+      (matrix   -0.798969  0.601373 -0.000000  0.000000
+                -0.601373 -0.798969 -0.000000  0.000000
                 -0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 0.000000 -0.948411 0.317042)
-      (euler     0.000004 0.000012 -143.031693)
+      (quat      0.000000 -0.000000 -0.948411 0.317042)
+      (euler     0.000004 0.000012 -143.031738)
      )
 
     (bone
       (name      "Bone.007")
-      (children )
+    	  (children )
       (parent    "Bone.006")
-      (head      -0.000000 0.000000 0.000000)
-      (length    0.412145078182)
-      (matrix    0.089845  0.995956 -0.000002  0.000000
-                -0.995956  0.089845  0.000000  0.000000
-                 0.000000  0.000002  1.000000  0.000000
+      (head      -0.000000 -0.000000 -0.000000)
+      (length    0.580758810043)
+      (matrix   -0.940337  0.255785 -0.224367  0.000000
+                -0.203484  0.105733  0.973352  0.000000
+                 0.272692  0.960934 -0.047377  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000001 -0.000001 -0.674594 0.738189)
-      (euler     0.000125 -0.000012 -84.845291)
+      (quat      -0.018074 -0.723437 -0.668436 0.171770)
+      (euler     -87.177452 -164.175507 12.210252)
      )
 
     (bone
       (name      "Bone.006")
-      (children  "Bone.007")
+    	  (children  "Bone.007")
       (parent    "Bone.005")
-      (head      0.000000 0.000000 0.000000)
-      (length    0.460424602032)
-      (matrix    0.975521 -0.219906  0.000003  0.000000
-                 0.219906  0.975521  0.000000  0.000000
+      (head      0.000000 -0.000000 -0.000000)
+      (length    0.460424661636)
+      (matrix    0.975521 -0.219905  0.000003  0.000000
+                 0.219905  0.975521  0.000000  0.000000
                 -0.000003  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
       (quat      -0.000000 0.000001 0.110632 0.993861)
-      (euler     0.000007 0.000158 12.703509)
+      (euler     0.000007 0.000158 12.703480)
      )
 
     (bone
       (name      "Bone.016")
-      (children )
+    	  (children  "Bone.018")
       (parent    "Bone.015")
-      (head      0.000000 0.000000 0.000000)
-      (length    0.380072444677)
-      (matrix   -0.162390 -0.986727 -0.000000  0.000000
-                 0.986727 -0.162390 -0.000000  0.000000
-                 0.000000 -0.000000  1.000000  0.000000
+      (head      0.000000 -0.000000 -0.000000)
+      (length    0.7483959198)
+      (matrix    0.992324  0.020425 -0.121970  0.000000
+                 0.120612 -0.377748  0.918019  0.000000
+                -0.027324 -0.925683 -0.377312  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.000000 -0.000000 0.762361 0.647151)
-      (euler     -0.000003 -0.000000 99.345650)
+      (quat      -0.828762 -0.042544 0.045035 0.556162)
+      (euler     -112.175995 1.565737 6.930044)
      )
 
     (bone
       (name      "Bone.008")
-      (children  "Bone.009")
+    	  (children  "Bone.009")
       (parent    "Bone.004")
       (head      -0.000000 0.000000 0.000000)
-      (length    0.534853696823)
-      (matrix    0.817942  0.575301  0.000002  0.000000
-                -0.575301  0.817942 -0.000002  0.000000
+      (length    0.534853637218)
+      (matrix    0.817942  0.575300  0.000002  0.000000
+                -0.575300  0.817942 -0.000002  0.000000
                 -0.000003  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
       (quat      0.000000 0.000001 -0.301710 0.953400)
-      (euler     0.000006 0.000148 -35.120697)
+      (euler     0.000006 0.000148 -35.120655)
      )
 
     (bone
-      (name      "Bone.009")
-      (children  "Bone.010")
-      (parent    "Bone.008")
-      (head      -0.000000 0.000000 0.000000)
-      (length    0.528390049934)
-      (matrix    0.984875  0.173265 -0.000003  0.000000
-                -0.173265  0.984875  0.000000  0.000000
-                 0.000003  0.000000  1.000000  0.000000
+      (name      "Bone.020")
+    	  (children )
+      (parent    "Bone.019")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.783167004585)
+      (matrix    1.000000 -0.000000 -0.000000  0.000000
+                -0.000000  0.786170 -0.618010  0.000000
+                 0.000000  0.618010  0.786170  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 -0.000002 -0.086962 0.996212)
-      (euler     0.000027 -0.000188 -9.977681)
+      (quat      0.326978 -0.000000 0.000000 0.945032)
+      (euler     38.170948 -0.000017 -0.000002)
      )
 
     (bone
+      (name      "Bone.019")
+    	  (children  "Bone.020")
+      (parent    "Bone.018")
+      (head      0.000000 -0.000000 0.000000)
+      (length    0.885059058666)
+      (matrix    1.000000 -0.000000  0.000000  0.000000
+                -0.000000  0.904786  0.425867  0.000000
+                -0.000000 -0.425867  0.904786  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.218191 0.000000 -0.000000 0.975906)
+      (euler     -25.205584 0.000023 -0.000006)
+     )
+
+    (bone
+      (name      "Bone.018")
+    	  (children  "Bone.019")
+      (parent    "Bone.016")
+      (head      0.000000 -0.000000 0.000000)
+      (length    0.711826086044)
+      (matrix    0.999458 -0.011594  0.030813  0.000000
+                -0.018364  0.580457  0.814084  0.000000
+                -0.027324 -0.814208  0.579930  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      -0.458004 0.016353 -0.001904 0.888798)
+      (euler     -54.539162 1.565734 -1.052638)
+     )
+
+    (bone
       (name      "Bone.015")
-      (children  "Bone.016")
+    	  (children  "Bone.016")
       (parent    "Bone")
       (head      0.000000 0.000000 0.000000)
       (length    0.392938047647)
-      (matrix    0.994743  0.102400  0.000000  0.000000
-                -0.102400  0.994743  0.000000  0.000000
-                 0.000000 -0.000000  1.000000  0.000000
+      (matrix    0.994743  0.102400 -0.000000  0.000000
+                -0.102400  0.994743 -0.000000  0.000000
+                -0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.000000 0.000000 -0.051267 0.998685)
-      (euler     -0.000003 -0.000000 -5.877396)
+      (quat      0.000000 -0.000000 -0.051267 0.998685)
+      (euler     0.000007 0.000000 -5.877398)
      )
 
     (bone
       (name      "Bone.005")
-      (children  "Bone.006")
+    	  (children  "Bone.006")
       (parent    "Bone.003")
       (head      0.000000 0.000000 0.000000)
       (length    0.571729123592)
@@ -130,24 +172,24 @@
 
     (bone
       (name      "Bone.012")
-      (children )
+    	  (children )
       (parent    "Bone.011")
       (head      0.000000 0.000000 0.000000)
-      (length    0.673586189747)
-      (matrix    0.962826  0.270121  0.000000  0.000000
-                -0.270121  0.962826  0.000000  0.000000
-                -0.000000 -0.000000  1.000000  0.000000
+      (length    0.616347193718)
+      (matrix   -0.601701  0.473509 -0.643230  0.000000
+                -0.639778  0.196392  0.743044  0.000000
+                 0.478163  0.858615  0.184771  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.000000 0.000000 -0.136333 0.990663)
-      (euler     -0.000007 0.000016 -15.671446)
+      (quat      0.065452 -0.635083 -0.630492 0.441436)
+      (euler     77.855347 -28.565483 -133.243271)
      )
 
     (bone
       (name      "Bone.013")
-      (children  "Bone.014")
+    	  (children  "Bone.014")
       (parent    "Bone.001")
-      (head      -0.000000 0.000000 0.000000)
-      (length    0.552089571953)
+      (head      0.000000 -0.000000 -0.000000)
+      (length    0.552089452744)
       (matrix    0.497525  0.867449  0.000000  0.000000
                 -0.867449  0.497525 -0.000000  0.000000
                 -0.000000  0.000000  1.000000  0.000000
@@ -158,7 +200,7 @@
 
     (bone
       (name      "Bone.001")
-      (children  "Bone.013")
+    	  (children  "Bone.013")
       (parent    "Bone")
       (head      0.000000 0.000000 0.000000)
       (length    0.780920624733)
@@ -172,21 +214,21 @@
 
     (bone
       (name      "Bone.002")
-      (children  "Bone.011")
+    	  (children  "Bone.011")
       (parent    "Bone")
       (head      0.000000 0.000000 0.000000)
-      (length    0.73281288147)
+      (length    0.732812821865)
       (matrix   -0.290226 -0.956958  0.000000  0.000000
                  0.956958 -0.290226 -0.000000  0.000000
                  0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 -0.000000 0.803189 0.595724)
-      (euler     0.000003 -0.000005 106.871460)
+      (quat      0.000000 0.000000 0.803189 0.595724)
+      (euler     0.000003 -0.000005 106.871468)
      )
 
     (bone
       (name      "Bone.003")
-      (children  "Bone.005")
+    	  (children  "Bone.005")
       (parent    "Bone.017")
       (head      -0.080474 -0.013809 -0.000000)
       (length    0.692165970802)
@@ -200,7 +242,7 @@
 
     (bone ;; a root bone
       (name      "Bone.017")
-      (children  "Bone" "Bone.003" "Bone.004")
+    	  (children  "Bone" "Bone.003" "Bone.004")
       (parent )
       (head      0.000000 0.979157 -0.000000)
       (length    0.259003162384)
@@ -214,21 +256,21 @@
 
     (bone
       (name      "Bone.011")
-      (children  "Bone.012")
+    	  (children  "Bone.012")
       (parent    "Bone.002")
-      (head      0.000000 0.000000 0.000000)
+      (head      0.000000 -0.000000 -0.000000)
       (length    0.563668251038)
-      (matrix    0.479301 -0.877651 -0.000000  0.000000
-                 0.877651  0.479301 -0.000000  0.000000
-                 0.000000  0.000000  1.000000  0.000000
+      (matrix    0.479301 -0.877651  0.000000  0.000000
+                 0.877651  0.479301  0.000000  0.000000
+                -0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 -0.000000 0.510245 0.860029)
-      (euler     0.000005 -0.000019 61.360249)
+      (quat      0.000000 0.000000 0.510245 0.860029)
+      (euler     0.000003 0.000003 61.360241)
      )
 
     (bone
       (name      "Bone")
-      (children  "Bone.001" "Bone.002" "Bone.015")
+    	  (children  "Bone.001" "Bone.002" "Bone.015")
       (parent    "Bone.017")
       (head      0.000000 0.106902 -0.000000)
       (length    0.844800710678)
@@ -242,16 +284,16 @@
 
     (bone
       (name      "Bone.014")
-      (children )
+    	  (children )
       (parent    "Bone.013")
-      (head      -0.000000 0.000000 0.000000)
-      (length    0.492631494999)
-      (matrix    0.998603  0.052845  0.000000  0.000000
-                -0.052845  0.998603 -0.000000  0.000000
-                -0.000000  0.000000  1.000000  0.000000
+      (head      0.000000 0.000000 0.000000)
+      (length    0.541055619717)
+      (matrix   -0.894525 -0.200734  0.399413  0.000000
+                 0.417369 -0.055060  0.907067  0.000000
+                -0.160087  0.978097  0.133033  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 0.000000 -0.026432 0.999651)
-      (euler     0.000001 0.000007 -3.029227)
+      (quat      0.082919 0.653152 0.721564 0.214154)
+      (euler     82.254608 9.211949 154.987091)
      )
 
   ) ;; bones

Modified: trunk/windstille/src/armature/armature.cpp
===================================================================
--- trunk/windstille/src/armature/armature.cpp	2007-06-21 07:19:59 UTC (rev 1488)
+++ trunk/windstille/src/armature/armature.cpp	2007-06-21 17:43:08 UTC (rev 1489)
@@ -128,6 +128,7 @@
   state.color(Color(1.0f, 0.0f, 0.0f));
   state.activate();
 
+  glLineWidth(6.0f);
   //std::cout << "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX-" << std::endl;
   glBegin(GL_LINES);
   draw_bone(root_bone, Vector3(0,0, 0), Matrix::identity());
@@ -135,41 +136,40 @@
 }
 
 void
-Armature::draw_bone(Bone* bone, Vector3 p, Matrix cur)
+Armature::draw_bone(Bone* bone, Vector3 p, Matrix m)
 {
-  // In theory we should be using Z, but Y seems to work?!
-  Vector3 vec = Vector3(0.0f, bone->length,  0.0f); 
-  Matrix  mat = bone->matrix.multiply(cur);
-  
+  Matrix  m_  = m.multiply(bone->matrix);
+  Vector3 p_  = p + m.multiply(bone->offset);
+  Vector3 p__ = p_ + m_.multiply(Vector3(0.0f, bone->length, 0.0f));
+
+  // In theory we should be using length in the Z component, but only
+  // Y seems to work?! -> Blenders matrix are weird
+
   // Issues: 
   // - don't mess with the root bone
-  // - offsets are ignored
 
   // std::cout << "--------------------------------------------------------------" << std::endl;
   // std::cout << "draw_bone: " << bone->name << std::endl;
   // std::cout << "bone matrix: \n" << bone->matrix << std::endl;
   // std::cout << "matrix: \n" << mat << std::endl;
   // std::cout << "before: " << vec << std::endl;
-  vec = mat.multiply(vec) + p + bone->offset;
+  ////  vec = mat.multiply(vec) + p + offset;
   // std::cout << "after: " << vec << std::endl;
 
- // do we need to rotate the offset?
-  Vector3 p_ = p + bone->offset;
-
   // p to p+offset
   glColor3f(0.0f, 0.5f, 0.0f);
   glVertex3f(  p.x, p.y, p.z);
   glColor3f(0.0f, 1.0f, 0.0f);
   glVertex3f( p_.x, p_.y, p_.z);  
 
-  // p to vec
-  glColor3f(0.7f, 0.0f, 0.0f);
+  // p+offset to new endpoint
+  glColor3f(0.0f, 0.0f, 1.0f);
   glVertex3f(  p_.x,   p_.y,   p_.z);
   glColor3f(1.0f, 0.0f, 0.0f);
-  glVertex3f(vec.x, vec.y, vec.z);
+  glVertex3f(  p__.x,  p__.y, p__.z);
 
   for(std::vector<Bone*>::iterator i = bone->children.begin(); i != bone->children.end(); ++i)  
-    draw_bone(*i, vec, mat);
+    draw_bone(*i, p__, m_);
 }
 
 /* EOF */

Modified: trunk/windstille/src/armature_test.cpp
===================================================================
--- trunk/windstille/src/armature_test.cpp	2007-06-21 07:19:59 UTC (rev 1488)
+++ trunk/windstille/src/armature_test.cpp	2007-06-21 17:43:08 UTC (rev 1489)
@@ -49,7 +49,7 @@
   glPushMatrix();
 
   glTranslatef(400.0f, 300.0f, 0.0f);
-  glScalef(128.0f, 128.0f, 128.0f);
+  glScalef(64.0f, 64.0f, 64.0f);
  
   glRotatef(xrot, 1.0f, 0.0f, 0.0f);
   glRotatef(yrot, 0.0f, 1.0f, 0.0f);
@@ -70,10 +70,31 @@
     {
       screen_manager.pop_screen();
     }
- 
-  xrot += controller.get_axis_state(X_AXIS) * 90 * delta;
-  yrot += controller.get_axis_state(Y_AXIS) * 90 * delta;
-  zrot += controller.get_axis_state(X2_AXIS) * 90 * delta;
+
+  if (controller.button_was_pressed(PRIMARY_BUTTON))
+    {
+      xrot = 90;
+      yrot = 0;
+      zrot = 0;
+    }
+  else if (controller.button_was_pressed(SECONDARY_BUTTON))
+      {
+      xrot = 0;
+      yrot = 90;
+      zrot = 0;
+      }
+  if (controller.button_was_pressed(TERTIARY_BUTTON))
+    {
+      xrot = 0;
+      yrot = 0;
+      zrot = 90;
+    }
+  else
+    { 
+      xrot += controller.get_axis_state(X_AXIS) * 90 * delta;
+      yrot += controller.get_axis_state(Y_AXIS) * 90 * delta;
+      zrot += controller.get_axis_state(X2_AXIS) * 90 * delta;
+    }
 }
 
 /* EOF */

Modified: trunk/windstille/tools/bone_test.blend
===================================================================
(Binary files differ)



From grumbel at mail.berlios.de  Thu Jun 21 22:06:56 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Thu, 21 Jun 2007 22:06:56 +0200
Subject: [Windstille-commit] r1490 - trunk/windstille/tools
Message-ID: <200706212006.l5LK6uTB021134@sheep.berlios.de>

Author: grumbel
Date: 2007-06-21 22:06:56 +0200 (Thu, 21 Jun 2007)
New Revision: 1490

Added:
   trunk/windstille/tools/pose_export.py
Log:
- added pose exporter (not so useful right now due to IK)

Added: trunk/windstille/tools/pose_export.py
===================================================================
--- trunk/windstille/tools/pose_export.py	2007-06-21 17:43:08 UTC (rev 1489)
+++ trunk/windstille/tools/pose_export.py	2007-06-21 20:06:56 UTC (rev 1490)
@@ -0,0 +1,33 @@
+import Blender
+import Blender.Armature
+from Blender import Ipo
+
+def vec2str(vec):
+    return "%f %f %f" % (vec.x,vec.y,vec.z)
+
+def export_action(out, action):
+    out.write(";; -*- scheme -*-\n")
+    out.write("(action\n")
+    out.write("  (name \"%s\")\n" % action.getName())
+    out.write("  (bones\n")
+    for ipo in action.getAllChannelIpos().values():
+        out.write("    (bone\n")
+        out.write("      (name \"%s\")\n" % ipo.getName())
+        for (v, k) in [('quatw', Ipo.PO_QUATW), ('quatx', Ipo.PO_QUATX),
+                       ('quaty', Ipo.PO_QUATY), ('quatz', Ipo.PO_QUATZ)]:
+            if ipo[k]:
+                out.write("      (%s " % v)
+                for point in ipo[k].bezierPoints:
+                    for v in point.vec:
+                        out.write("%f %f %f" % (v[0], v[1], v[2]))
+                out.write(")\n")                    
+        out.write("     ) ;; bone \n")
+    out.write("   ) ;; bones \n")
+    out.write(" ) ;; action\n")    
+
+for action in Blender.Armature.NLA.GetActions().values():
+    out = file("/tmp/action-%s.scm" % action.getName(), "w")
+    export_action(out, action)
+    out.close
+
+# EOF #



From grumbel at mail.berlios.de  Fri Jun 22 01:12:04 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 22 Jun 2007 01:12:04 +0200
Subject: [Windstille-commit] r1491 - in trunk/windstille: . src tools
Message-ID: <200706212312.l5LNC4QU020954@sheep.berlios.de>

Author: grumbel
Date: 2007-06-22 01:12:01 +0200 (Fri, 22 Jun 2007)
New Revision: 1491

Added:
   trunk/windstille/tools/ipo_export.py
Modified:
   trunk/windstille/NEWS
   trunk/windstille/src/getter.cpp
   trunk/windstille/tools/bone_export.py
   trunk/windstille/tools/bone_test.blend
   trunk/windstille/tools/pose_export.py
Log:
- pose export try two

Modified: trunk/windstille/NEWS
===================================================================
--- trunk/windstille/NEWS	2007-06-21 20:06:56 UTC (rev 1490)
+++ trunk/windstille/NEWS	2007-06-21 23:12:01 UTC (rev 1491)
@@ -1,13 +1,17 @@
 Windstille 0.3.1
 ================
  - fixed crash when sound is disabled
- - more solid gamepad support
+ - more solid input configuration support (xbox360, dvorak settings
+   provided)
  - added volume control
  - added arc drawing
  - added navigation graph
  - added geometry test
  - added sdl-jstest application
+ - added armature test
+ - added skeletal animations along with blender export scripts
 
+
 Windstille 0.3.0
 ================
  - near complete rewrite of the engine

Modified: trunk/windstille/src/getter.cpp
===================================================================
--- trunk/windstille/src/getter.cpp	2007-06-21 20:06:56 UTC (rev 1490)
+++ trunk/windstille/src/getter.cpp	2007-06-21 23:12:01 UTC (rev 1491)
@@ -60,10 +60,10 @@
 {
   std::vector<float> floats;
   if (reader.get(name, floats) && floats.size() == 4) {
-    value.x = floats[0];
-    value.y = floats[1];
-    value.z = floats[2];
-    value.w = floats[3];
+    value.w = floats[0];
+    value.x = floats[1];
+    value.y = floats[2];
+    value.z = floats[3];
     return true;
   } else {
     return false;

Modified: trunk/windstille/tools/bone_export.py
===================================================================
--- trunk/windstille/tools/bone_export.py	2007-06-21 20:06:56 UTC (rev 1490)
+++ trunk/windstille/tools/bone_export.py	2007-06-21 23:12:01 UTC (rev 1491)
@@ -10,7 +10,7 @@
     return "%f %f %f" % (euler.x, euler.y, euler.z)
 
 def quat2str(quat):
-    return "%f %f %f %f" % (quat.x, quat.y, quat.z, quat.w)
+    return "%f %f %f %f" % (quat.w, quat.x, quat.y, quat.z)
 
 def matrix2str(indent, m):
         return          ("%9f %9f %9f %9f\n" % (m[0][0], m[0][1], m[0][2], 0)) + \

Modified: trunk/windstille/tools/bone_test.blend
===================================================================
(Binary files differ)

Added: trunk/windstille/tools/ipo_export.py
===================================================================
--- trunk/windstille/tools/ipo_export.py	2007-06-21 20:06:56 UTC (rev 1490)
+++ trunk/windstille/tools/ipo_export.py	2007-06-21 23:12:01 UTC (rev 1491)
@@ -0,0 +1,33 @@
+import Blender
+import Blender.Armature
+from Blender import Ipo
+
+def vec2str(vec):
+    return "%f %f %f" % (vec.x,vec.y,vec.z)
+
+def export_action(out, action):
+    out.write(";; -*- scheme -*-\n")
+    out.write("(action\n")
+    out.write("  (name \"%s\")\n" % action.getName())
+    out.write("  (bones\n")
+    for ipo in action.getAllChannelIpos().values():
+        out.write("    (bone\n")
+        out.write("      (name \"%s\")\n" % ipo.getName())
+        for (v, k) in [('quatw', Ipo.PO_QUATW), ('quatx', Ipo.PO_QUATX),
+                       ('quaty', Ipo.PO_QUATY), ('quatz', Ipo.PO_QUATZ)]:
+            if ipo[k]:
+                out.write("      (%s " % v)
+                for point in ipo[k].bezierPoints:
+                    for v in point.vec:
+                        out.write("%f %f %f" % (v[0], v[1], v[2]))
+                out.write(")\n")                    
+        out.write("     ) ;; bone \n")
+    out.write("   ) ;; bones \n")
+    out.write(" ) ;; action\n")    
+
+for action in Blender.Armature.NLA.GetActions().values():
+    out = file("/tmp/action-%s.scm" % action.getName(), "w")
+    export_action(out, action)
+    out.close
+
+# EOF #

Modified: trunk/windstille/tools/pose_export.py
===================================================================
--- trunk/windstille/tools/pose_export.py	2007-06-21 20:06:56 UTC (rev 1490)
+++ trunk/windstille/tools/pose_export.py	2007-06-21 23:12:01 UTC (rev 1491)
@@ -1,33 +1,23 @@
 import Blender
-import Blender.Armature
-from Blender import Ipo
+from Blender import *
 
-def vec2str(vec):
-    return "%f %f %f" % (vec.x,vec.y,vec.z)
+print "-------------------------------------------"
+for obj in Blender.Object.Get():
+	if obj.type == "Armature":
+		print "-------------", obj.getName()
+		pose = obj.getPose()
+		for bone in pose.bones.values():
+			print bone.quat
 
-def export_action(out, action):
-    out.write(";; -*- scheme -*-\n")
-    out.write("(action\n")
-    out.write("  (name \"%s\")\n" % action.getName())
-    out.write("  (bones\n")
-    for ipo in action.getAllChannelIpos().values():
-        out.write("    (bone\n")
-        out.write("      (name \"%s\")\n" % ipo.getName())
-        for (v, k) in [('quatw', Ipo.PO_QUATW), ('quatx', Ipo.PO_QUATX),
-                       ('quaty', Ipo.PO_QUATY), ('quatz', Ipo.PO_QUATZ)]:
-            if ipo[k]:
-                out.write("      (%s " % v)
-                for point in ipo[k].bezierPoints:
-                    for v in point.vec:
-                        out.write("%f %f %f" % (v[0], v[1], v[2]))
-                out.write(")\n")                    
-        out.write("     ) ;; bone \n")
-    out.write("   ) ;; bones \n")
-    out.write(" ) ;; action\n")    
+def export_pose(out, obj):
+	pose = obj
+	for bone in pose.bones.values():
+		
 
-for action in Blender.Armature.NLA.GetActions().values():
-    out = file("/tmp/action-%s.scm" % action.getName(), "w")
-    export_action(out, action)
-    out.close
+for obj in Blender.Object.Get():
+	if obj.type == "Armature":
+		out = file("/tmp/pose-%s.scm" % obj.getName(), "w")
+		export_pose(out, obj)
+		out.close()
 
-# EOF #
+# EOF #
\ No newline at end of file



From grumbel at mail.berlios.de  Fri Jun 22 02:25:20 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 22 Jun 2007 02:25:20 +0200
Subject: [Windstille-commit] r1492 - in trunk/windstille: data src
	src/armature tools
Message-ID: <200706220025.l5M0PK92021901@sheep.berlios.de>

Author: grumbel
Date: 2007-06-22 02:25:15 +0200 (Fri, 22 Jun 2007)
New Revision: 1492

Added:
   trunk/windstille/data/pose.pose
   trunk/windstille/src/armature/action.hpp
   trunk/windstille/src/armature/ipo_curve.cpp
   trunk/windstille/src/armature/ipo_curve.hpp
   trunk/windstille/src/armature/pose.cpp
   trunk/windstille/src/armature/pose.hpp
   trunk/windstille/src/armature/pose_bone.hpp
Modified:
   trunk/windstille/data/armature.arm
   trunk/windstille/src/SConscript
   trunk/windstille/src/armature/armature.cpp
   trunk/windstille/src/armature/armature.hpp
   trunk/windstille/src/armature/bone.hpp
   trunk/windstille/src/armature_test.cpp
   trunk/windstille/src/armature_test.hpp
   trunk/windstille/tools/
   trunk/windstille/tools/bone_test.blend
   trunk/windstille/tools/pose_export.py
Log:
- implemented basic handling of poses (matrix handling still seems to be broken here and there)

Modified: trunk/windstille/data/armature.arm
===================================================================
--- trunk/windstille/data/armature.arm	2007-06-21 23:12:01 UTC (rev 1491)
+++ trunk/windstille/data/armature.arm	2007-06-22 00:25:15 UTC (rev 1492)
@@ -4,245 +4,245 @@
   (bones
     (bone
       (name      "Bone.010")
-    	  (children )
+      (children )
       (parent    "Bone.009")
       (head      -0.000000 -0.000000 0.000000)
       (length    0.609991371632)
-      (matrix   -0.885632 -0.399715  0.236399  0.000000
-                 0.281300 -0.056720  0.957942  0.000000
-                -0.369496  0.914883  0.162673  0.000000
+      (matrix   -0.885632  0.281300 -0.369496  0.000000
+                -0.399715 -0.056720  0.914883  0.000000
+                 0.236399  0.957942  0.162673  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.045868 0.645414 0.725435 0.234692)
+      (quat      0.234692 -0.045868 0.645414 0.725435)
       (euler     79.917725 21.684511 162.378754)
      )
 
     (bone
       (name      "Bone.009")
-    	  (children  "Bone.010")
+      (children  "Bone.010")
       (parent    "Bone.008")
       (head      0.000000 -0.000000 -0.000000)
       (length    0.528390169144)
-      (matrix    0.984876  0.173264 -0.000002  0.000000
-                -0.173264  0.984876 -0.000000  0.000000
-                 0.000002  0.000000  1.000000  0.000000
+      (matrix    0.984876 -0.173264  0.000002  0.000000
+                 0.173264  0.984876  0.000000  0.000000
+                -0.000002 -0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 -0.000001 -0.086961 0.996212)
+      (quat      0.996212 0.000000 -0.000001 -0.086961)
       (euler     0.000021 -0.000104 -9.977630)
      )
 
     (bone
       (name      "Bone.004")
-    	  (children  "Bone.008")
+      (children  "Bone.008")
       (parent    "Bone.017")
       (head      0.120711 -0.025305 0.000000)
       (length    0.669082939625)
-      (matrix   -0.798969  0.601373 -0.000000  0.000000
-                -0.601373 -0.798969 -0.000000  0.000000
-                -0.000000  0.000000  1.000000  0.000000
+      (matrix   -0.798969 -0.601373 -0.000000  0.000000
+                 0.601373 -0.798969  0.000000  0.000000
+                -0.000000 -0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 -0.000000 -0.948411 0.317042)
+      (quat      0.317042 0.000000 -0.000000 -0.948411)
       (euler     0.000004 0.000012 -143.031738)
      )
 
     (bone
       (name      "Bone.007")
-    	  (children )
+      (children )
       (parent    "Bone.006")
       (head      -0.000000 -0.000000 -0.000000)
       (length    0.580758810043)
-      (matrix   -0.940337  0.255785 -0.224367  0.000000
-                -0.203484  0.105733  0.973352  0.000000
-                 0.272692  0.960934 -0.047377  0.000000
+      (matrix   -0.940337 -0.203484  0.272692  0.000000
+                 0.255785  0.105733  0.960934  0.000000
+                -0.224367  0.973352 -0.047377  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.018074 -0.723437 -0.668436 0.171770)
+      (quat      0.171770 -0.018074 -0.723437 -0.668436)
       (euler     -87.177452 -164.175507 12.210252)
      )
 
     (bone
       (name      "Bone.006")
-    	  (children  "Bone.007")
+      (children  "Bone.007")
       (parent    "Bone.005")
       (head      0.000000 -0.000000 -0.000000)
       (length    0.460424661636)
-      (matrix    0.975521 -0.219905  0.000003  0.000000
-                 0.219905  0.975521  0.000000  0.000000
-                -0.000003  0.000000  1.000000  0.000000
+      (matrix    0.975521  0.219905 -0.000003  0.000000
+                -0.219905  0.975521  0.000000  0.000000
+                 0.000003  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.000000 0.000001 0.110632 0.993861)
+      (quat      0.993861 -0.000000 0.000001 0.110632)
       (euler     0.000007 0.000158 12.703480)
      )
 
     (bone
       (name      "Bone.016")
-    	  (children  "Bone.018")
+      (children  "Bone.018")
       (parent    "Bone.015")
       (head      0.000000 -0.000000 -0.000000)
       (length    0.7483959198)
-      (matrix    0.992324  0.020425 -0.121970  0.000000
-                 0.120612 -0.377748  0.918019  0.000000
-                -0.027324 -0.925683 -0.377312  0.000000
+      (matrix    0.992324  0.120612 -0.027324  0.000000
+                 0.020425 -0.377748 -0.925683  0.000000
+                -0.121970  0.918019 -0.377312  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.828762 -0.042544 0.045035 0.556162)
+      (quat      0.556162 -0.828762 -0.042544 0.045035)
       (euler     -112.175995 1.565737 6.930044)
      )
 
     (bone
       (name      "Bone.008")
-    	  (children  "Bone.009")
+      (children  "Bone.009")
       (parent    "Bone.004")
       (head      -0.000000 0.000000 0.000000)
       (length    0.534853637218)
-      (matrix    0.817942  0.575300  0.000002  0.000000
-                -0.575300  0.817942 -0.000002  0.000000
-                -0.000003  0.000000  1.000000  0.000000
+      (matrix    0.817942 -0.575300 -0.000003  0.000000
+                 0.575300  0.817942  0.000000  0.000000
+                 0.000002 -0.000002  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 0.000001 -0.301710 0.953400)
+      (quat      0.953400 0.000000 0.000001 -0.301710)
       (euler     0.000006 0.000148 -35.120655)
      )
 
     (bone
       (name      "Bone.020")
-    	  (children )
+      (children )
       (parent    "Bone.019")
       (head      0.000000 0.000000 0.000000)
       (length    0.783167004585)
-      (matrix    1.000000 -0.000000 -0.000000  0.000000
-                -0.000000  0.786170 -0.618010  0.000000
-                 0.000000  0.618010  0.786170  0.000000
+      (matrix    1.000000 -0.000000  0.000000  0.000000
+                -0.000000  0.786170  0.618010  0.000000
+                -0.000000 -0.618010  0.786170  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.326978 -0.000000 0.000000 0.945032)
+      (quat      0.945032 0.326978 -0.000000 0.000000)
       (euler     38.170948 -0.000017 -0.000002)
      )
 
     (bone
       (name      "Bone.019")
-    	  (children  "Bone.020")
+      (children  "Bone.020")
       (parent    "Bone.018")
       (head      0.000000 -0.000000 0.000000)
       (length    0.885059058666)
-      (matrix    1.000000 -0.000000  0.000000  0.000000
-                -0.000000  0.904786  0.425867  0.000000
-                -0.000000 -0.425867  0.904786  0.000000
+      (matrix    1.000000 -0.000000 -0.000000  0.000000
+                -0.000000  0.904786 -0.425867  0.000000
+                 0.000000  0.425867  0.904786  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.218191 0.000000 -0.000000 0.975906)
+      (quat      0.975906 -0.218191 0.000000 -0.000000)
       (euler     -25.205584 0.000023 -0.000006)
      )
 
     (bone
       (name      "Bone.018")
-    	  (children  "Bone.019")
+      (children  "Bone.019")
       (parent    "Bone.016")
       (head      0.000000 -0.000000 0.000000)
       (length    0.711826086044)
-      (matrix    0.999458 -0.011594  0.030813  0.000000
-                -0.018364  0.580457  0.814084  0.000000
-                -0.027324 -0.814208  0.579930  0.000000
+      (matrix    0.999458 -0.018364 -0.027324  0.000000
+                -0.011594  0.580457 -0.814208  0.000000
+                 0.030813  0.814084  0.579930  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      -0.458004 0.016353 -0.001904 0.888798)
+      (quat      0.888798 -0.458004 0.016353 -0.001904)
       (euler     -54.539162 1.565734 -1.052638)
      )
 
     (bone
       (name      "Bone.015")
-    	  (children  "Bone.016")
+      (children  "Bone.016")
       (parent    "Bone")
       (head      0.000000 0.000000 0.000000)
       (length    0.392938047647)
-      (matrix    0.994743  0.102400 -0.000000  0.000000
-                -0.102400  0.994743 -0.000000  0.000000
-                -0.000000  0.000000  1.000000  0.000000
+      (matrix    0.994743 -0.102400 -0.000000  0.000000
+                 0.102400  0.994743  0.000000  0.000000
+                -0.000000 -0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 -0.000000 -0.051267 0.998685)
+      (quat      0.998685 0.000000 -0.000000 -0.051267)
       (euler     0.000007 0.000000 -5.877398)
      )
 
     (bone
       (name      "Bone.005")
-    	  (children  "Bone.006")
+      (children  "Bone.006")
       (parent    "Bone.003")
       (head      0.000000 0.000000 0.000000)
       (length    0.571729123592)
-      (matrix    0.782333 -0.622860 -0.000000  0.000000
-                 0.622860  0.782333 -0.000000  0.000000
-                 0.000001  0.000000  1.000000  0.000000
+      (matrix    0.782333  0.622860  0.000001  0.000000
+                -0.622860  0.782333  0.000000  0.000000
+                -0.000000 -0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 -0.000000 0.329899 0.944016)
+      (quat      0.944016 0.000000 -0.000000 0.329899)
       (euler     0.000003 -0.000030 38.525307)
      )
 
     (bone
       (name      "Bone.012")
-    	  (children )
+      (children )
       (parent    "Bone.011")
       (head      0.000000 0.000000 0.000000)
       (length    0.616347193718)
-      (matrix   -0.601701  0.473509 -0.643230  0.000000
-                -0.639778  0.196392  0.743044  0.000000
-                 0.478163  0.858615  0.184771  0.000000
+      (matrix   -0.601701 -0.639778  0.478163  0.000000
+                 0.473509  0.196392  0.858615  0.000000
+                -0.643230  0.743044  0.184771  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.065452 -0.635083 -0.630492 0.441436)
+      (quat      0.441436 0.065452 -0.635083 -0.630492)
       (euler     77.855347 -28.565483 -133.243271)
      )
 
     (bone
       (name      "Bone.013")
-    	  (children  "Bone.014")
+      (children  "Bone.014")
       (parent    "Bone.001")
       (head      0.000000 -0.000000 -0.000000)
       (length    0.552089452744)
-      (matrix    0.497525  0.867449  0.000000  0.000000
-                -0.867449  0.497525 -0.000000  0.000000
-                -0.000000  0.000000  1.000000  0.000000
+      (matrix    0.497525 -0.867449 -0.000000  0.000000
+                 0.867449  0.497525  0.000000  0.000000
+                 0.000000 -0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 0.000000 -0.501236 0.865311)
+      (quat      0.865311 0.000000 0.000000 -0.501236)
       (euler     0.000006 0.000023 -60.163593)
      )
 
     (bone
       (name      "Bone.001")
-    	  (children  "Bone.013")
+      (children  "Bone.013")
       (parent    "Bone")
       (head      0.000000 0.000000 0.000000)
       (length    0.780920624733)
-      (matrix   -0.264986  0.964252 -0.000000  0.000000
-                -0.964252 -0.264986 -0.000000  0.000000
-                -0.000000  0.000000  1.000000  0.000000
+      (matrix   -0.264986 -0.964252 -0.000000  0.000000
+                 0.964252 -0.264986  0.000000  0.000000
+                -0.000000 -0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 0.000000 -0.795294 0.606224)
+      (quat      0.606224 0.000000 0.000000 -0.795294)
       (euler     0.000003 0.000004 -105.366104)
      )
 
     (bone
       (name      "Bone.002")
-    	  (children  "Bone.011")
+      (children  "Bone.011")
       (parent    "Bone")
       (head      0.000000 0.000000 0.000000)
       (length    0.732812821865)
-      (matrix   -0.290226 -0.956958  0.000000  0.000000
-                 0.956958 -0.290226 -0.000000  0.000000
-                 0.000000  0.000000  1.000000  0.000000
+      (matrix   -0.290226  0.956958  0.000000  0.000000
+                -0.956958 -0.290226  0.000000  0.000000
+                 0.000000 -0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 0.000000 0.803189 0.595724)
+      (quat      0.595724 0.000000 0.000000 0.803189)
       (euler     0.000003 -0.000005 106.871468)
      )
 
     (bone
       (name      "Bone.003")
-    	  (children  "Bone.005")
+      (children  "Bone.005")
       (parent    "Bone.017")
       (head      -0.080474 -0.013809 -0.000000)
       (length    0.692165970802)
-      (matrix   -0.664364 -0.747409  0.000000  0.000000
-                 0.747409 -0.664364 -0.000000  0.000000
-                 0.000000  0.000000  1.000000  0.000000
+      (matrix   -0.664364  0.747409  0.000000  0.000000
+                -0.747409 -0.664364  0.000000  0.000000
+                 0.000000 -0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 0.000000 0.912240 0.409656)
+      (quat      0.409656 0.000000 0.000000 0.912240)
       (euler     0.000000 -0.000000 131.633560)
      )
 
     (bone ;; a root bone
       (name      "Bone.017")
-    	  (children  "Bone" "Bone.003" "Bone.004")
+      (children  "Bone" "Bone.003" "Bone.004")
       (parent )
       (head      0.000000 0.979157 -0.000000)
       (length    0.259003162384)
@@ -250,27 +250,27 @@
                  0.000000  1.000000  0.000000  0.000000
                  0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 0.000000 0.000000 1.000000)
+      (quat      1.000000 0.000000 0.000000 0.000000)
       (euler     0.000000 -0.000000 0.000000)
      )
 
     (bone
       (name      "Bone.011")
-    	  (children  "Bone.012")
+      (children  "Bone.012")
       (parent    "Bone.002")
       (head      0.000000 -0.000000 -0.000000)
       (length    0.563668251038)
-      (matrix    0.479301 -0.877651  0.000000  0.000000
-                 0.877651  0.479301  0.000000  0.000000
-                -0.000000  0.000000  1.000000  0.000000
+      (matrix    0.479301  0.877651 -0.000000  0.000000
+                -0.877651  0.479301  0.000000  0.000000
+                 0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 0.000000 0.510245 0.860029)
+      (quat      0.860029 0.000000 0.000000 0.510245)
       (euler     0.000003 0.000003 61.360241)
      )
 
     (bone
       (name      "Bone")
-    	  (children  "Bone.001" "Bone.002" "Bone.015")
+      (children  "Bone.001" "Bone.002" "Bone.015")
       (parent    "Bone.017")
       (head      0.000000 0.106902 -0.000000)
       (length    0.844800710678)
@@ -278,21 +278,21 @@
                  0.000000  1.000000  0.000000  0.000000
                  0.000000  0.000000  1.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.000000 0.000000 0.000000 1.000000)
+      (quat      1.000000 0.000000 0.000000 0.000000)
       (euler     0.000000 -0.000000 0.000000)
      )
 
     (bone
       (name      "Bone.014")
-    	  (children )
+      (children )
       (parent    "Bone.013")
       (head      0.000000 0.000000 0.000000)
       (length    0.541055619717)
-      (matrix   -0.894525 -0.200734  0.399413  0.000000
-                 0.417369 -0.055060  0.907067  0.000000
-                -0.160087  0.978097  0.133033  0.000000
+      (matrix   -0.894525  0.417369 -0.160087  0.000000
+                -0.200734 -0.055060  0.978097  0.000000
+                 0.399413  0.907067  0.133033  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.082919 0.653152 0.721564 0.214154)
+      (quat      0.214154 0.082919 0.653152 0.721564)
       (euler     82.254608 9.211949 154.987091)
      )
 

Added: trunk/windstille/data/pose.pose
===================================================================
--- trunk/windstille/data/pose.pose	2007-06-21 23:12:01 UTC (rev 1491)
+++ trunk/windstille/data/pose.pose	2007-06-22 00:25:15 UTC (rev 1492)
@@ -0,0 +1,71 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    (bone
+      (name "Bone.010")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.009")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.004")
+      (quat 0.548134 0.668250 -0.502982 0.000000))
+    (bone
+      (name "Bone.007")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.006")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.016")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.008")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.020")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.019")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.018")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.015")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.005")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.012")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.013")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.001")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.002")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.003")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.017")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.011")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Bone.014")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-21 23:12:01 UTC (rev 1491)
+++ trunk/windstille/src/SConscript	2007-06-22 00:25:15 UTC (rev 1492)
@@ -44,6 +44,7 @@
 env.Program('../windstille', [
 'armature_test.cpp',
 'armature/armature.cpp',
+'armature/pose.cpp',
 'armature/bone.cpp',
 'baby_xml.cpp',
 'blitter.cpp',

Added: trunk/windstille/src/armature/action.hpp
===================================================================
--- trunk/windstille/src/armature/action.hpp	2007-06-21 23:12:01 UTC (rev 1491)
+++ trunk/windstille/src/armature/action.hpp	2007-06-22 00:25:15 UTC (rev 1492)
@@ -0,0 +1,42 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_ACTION_HPP
+#define HEADER_ACTION_HPP
+
+/** */
+class Action
+{
+private:
+public:
+
+private:
+  Action (const Action&);
+  Action& operator= (const Action&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/armature/action.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/armature/armature.cpp
===================================================================
--- trunk/windstille/src/armature/armature.cpp	2007-06-21 23:12:01 UTC (rev 1491)
+++ trunk/windstille/src/armature/armature.cpp	2007-06-22 00:25:15 UTC (rev 1492)
@@ -29,6 +29,7 @@
 #include <stdexcept>
 #include "display/opengl_state.hpp"
 #include "display/display.hpp"
+#include "pose.hpp"
 #include "math/vector3.hpp"
 #include "armature.hpp"
 
@@ -70,6 +71,10 @@
                 }
               else
                 {
+                  // FIXME: experimental
+                  bone->matrix = bone->quat.to_matrix();
+                  bone->render_matrix = bone->quat.to_matrix();
+
                   bones.push_back(bone);
                 }
             }
@@ -138,24 +143,12 @@
 void
 Armature::draw_bone(Bone* bone, Vector3 p, Matrix m)
 {
-  Matrix  m_  = m.multiply(bone->matrix);
+  Matrix  m_  = m.multiply(bone->render_matrix);
   Vector3 p_  = p + m.multiply(bone->offset);
+  // FIXME: In theory we should be using length in the Z component, but only
+  // Y seems to work?! -> Blenders matrix are weird
   Vector3 p__ = p_ + m_.multiply(Vector3(0.0f, bone->length, 0.0f));
 
-  // In theory we should be using length in the Z component, but only
-  // Y seems to work?! -> Blenders matrix are weird
-
-  // Issues: 
-  // - don't mess with the root bone
-
-  // std::cout << "--------------------------------------------------------------" << std::endl;
-  // std::cout << "draw_bone: " << bone->name << std::endl;
-  // std::cout << "bone matrix: \n" << bone->matrix << std::endl;
-  // std::cout << "matrix: \n" << mat << std::endl;
-  // std::cout << "before: " << vec << std::endl;
-  ////  vec = mat.multiply(vec) + p + offset;
-  // std::cout << "after: " << vec << std::endl;
-
   // p to p+offset
   glColor3f(0.0f, 0.5f, 0.0f);
   glVertex3f(  p.x, p.y, p.z);
@@ -172,4 +165,28 @@
     draw_bone(*i, p__, m_);
 }
 
+void
+Armature::apply(const Pose& pose)
+{
+  if (pose.get_name() != name)
+    {
+      std::cout << "Can't apply pose '" << pose.get_name() << "' to armature '" << name << "'" << std::endl;
+    }
+  else
+    {                                           
+      for(std::vector<PoseBone>::const_iterator pbone = pose.bones.begin(); pbone != pose.bones.end(); ++pbone)
+        {
+          Bone* bone = get_bone(pbone->name);
+          if (!bone)
+            {
+              std::cout << "Error: Couldn't find bone: " << pbone->name << std::endl;
+            }
+          else
+            {
+              bone->render_matrix = bone->matrix.multiply(pbone->quat.to_matrix());
+            }
+        }
+    }
+}
+
 /* EOF */

Modified: trunk/windstille/src/armature/armature.hpp
===================================================================
--- trunk/windstille/src/armature/armature.hpp	2007-06-21 23:12:01 UTC (rev 1491)
+++ trunk/windstille/src/armature/armature.hpp	2007-06-22 00:25:15 UTC (rev 1492)
@@ -30,6 +30,8 @@
 #include "bone.hpp"
 #include "file_reader.hpp"
 
+class Pose;
+
 /** */
 class Armature
 {
@@ -43,6 +45,8 @@
   Armature(FileReader& reader);
   ~Armature();
   
+  void apply(const Pose& pose);
+
   void  parse(FileReader& reader);
   Bone* get_bone(const std::string& name);
   void  draw();

Modified: trunk/windstille/src/armature/bone.hpp
===================================================================
--- trunk/windstille/src/armature/bone.hpp	2007-06-21 23:12:01 UTC (rev 1491)
+++ trunk/windstille/src/armature/bone.hpp	2007-06-22 00:25:15 UTC (rev 1492)
@@ -50,6 +50,8 @@
   Quaternion quat;
   Matrix     matrix;
   Vector3    offset;
+
+  Matrix     render_matrix;
   
   Bone();
   ~Bone();

Added: trunk/windstille/src/armature/ipo_curve.cpp
===================================================================
--- trunk/windstille/src/armature/ipo_curve.cpp	2007-06-21 23:12:01 UTC (rev 1491)
+++ trunk/windstille/src/armature/ipo_curve.cpp	2007-06-22 00:25:15 UTC (rev 1492)
@@ -0,0 +1,62 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include "ipo_curve.hpp"
+
+IpoCurve::IpoCurve()
+{
+}
+
+IpoCurve::~IpoCurve()
+{
+}
+
+float
+IpoCurve::evalutate(float x)
+{
+  // find bezier points left and right from t
+  Vector left;
+  Vector right;
+
+  // calculate the value t from x
+  float t;
+
+  // calculate the result
+
+  //def bezier(p0, p1, p2, p3, t):
+  //    return p0*(1-t)**3 + 3*p1*t*((1-t)**2) + 3*p2*(t**2)*(1-t) + p3*t**3
+}
+
+void
+IpoCurve::add_point(const BezierPoint& p)
+{
+  assert(points.empty() ||
+         points.back().point.x < p.x &&
+         p.handle_left.x < p.x &&
+         p.x < p.handle_right.x);
+  points.push_back(p);
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/armature/ipo_curve.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/armature/ipo_curve.hpp
===================================================================
--- trunk/windstille/src/armature/ipo_curve.hpp	2007-06-21 23:12:01 UTC (rev 1491)
+++ trunk/windstille/src/armature/ipo_curve.hpp	2007-06-22 00:25:15 UTC (rev 1492)
@@ -0,0 +1,57 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_IPO_CURVE_HPP
+#define HEADER_IPO_CURVE_HPP
+
+struct BezierPoint
+{
+  Vector handle_left;
+  Vector handle_right;
+
+  Vector pos;
+};
+
+/** */
+class IpoCurve
+{
+private:
+  std::vector<BezierPoint> points;
+public:
+  IpoCurve();
+  ~IpoCurve();
+  
+  float evalutate(float t);
+
+  void add_point(const BezierPoint& p);
+
+private:
+  IpoCurve (const IpoCurve&);
+  IpoCurve& operator= (const IpoCurve&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/armature/ipo_curve.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/armature/pose.cpp
===================================================================
--- trunk/windstille/src/armature/pose.cpp	2007-06-21 23:12:01 UTC (rev 1491)
+++ trunk/windstille/src/armature/pose.cpp	2007-06-22 00:25:15 UTC (rev 1492)
@@ -0,0 +1,70 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include <iostream>
+#include <stdexcept>
+#include "file_reader.hpp"
+#include "pose.hpp"
+
+Pose::Pose(FileReader& reader)
+{
+  if (reader.get_name() != "pose")
+    {
+      throw std::runtime_error("not a pose file");
+    }
+  else
+    {
+      reader.get("name",  name);
+
+      FileReader bones_reader;
+      if (!reader.get("bones", bones_reader))
+        {
+          std::cout << "Bones section missing" << std::endl;
+        }
+      else
+        {
+          std::vector<FileReader> sections = bones_reader.get_sections();
+          std::cout << sections.size() << std::endl;
+          for(std::vector<FileReader>::iterator i = sections.begin(); i != sections.end(); ++i)
+            {
+              if (i->get_name() == "bone")
+                {
+                  PoseBone bone;
+                  i->get("name", bone.name);
+                  i->get("quat", bone.quat);
+                  bones.push_back(bone);
+                }
+              else
+                {
+                  std::cout << "Unhandled tag: " << i->get_name() << std::endl;
+                }
+            }
+        }
+    }
+
+  std::cout << "Pose: " << name << " " << bones.size() << std::endl;
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/armature/pose.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/armature/pose.hpp
===================================================================
--- trunk/windstille/src/armature/pose.hpp	2007-06-21 23:12:01 UTC (rev 1491)
+++ trunk/windstille/src/armature/pose.hpp	2007-06-22 00:25:15 UTC (rev 1492)
@@ -0,0 +1,58 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_POSE_HPP
+#define HEADER_POSE_HPP
+
+#include <string>
+#include <vector>
+
+#include "pose_bone.hpp"
+
+class FileReader;
+
+/** */
+class Pose
+{
+private:
+  std::string name;
+
+public:
+  std::vector<PoseBone> bones;
+  
+public:
+  Pose(FileReader& reader);
+  ~Pose();  
+
+  std::string get_name() const { return name; }
+  
+private:
+  Pose (const Pose&);
+  Pose& operator= (const Pose&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/armature/pose.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/armature/pose_bone.hpp
===================================================================
--- trunk/windstille/src/armature/pose_bone.hpp	2007-06-21 23:12:01 UTC (rev 1491)
+++ trunk/windstille/src/armature/pose_bone.hpp	2007-06-22 00:25:15 UTC (rev 1492)
@@ -0,0 +1,43 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_POSE_BONE_HPP
+#define HEADER_POSE_BONE_HPP
+
+#include <string>
+#include "math/quaternion.hpp"
+
+/** */
+class PoseBone
+{
+public:
+  std::string name;
+  int         bone_id;
+  Quaternion  quat;
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/armature/pose_bone.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/src/armature_test.cpp
===================================================================
--- trunk/windstille/src/armature_test.cpp	2007-06-21 23:12:01 UTC (rev 1491)
+++ trunk/windstille/src/armature_test.cpp	2007-06-22 00:25:15 UTC (rev 1492)
@@ -29,15 +29,22 @@
 #include "display/display.hpp"
 #include "screen_manager.hpp"
 #include "display/display.hpp"
+#include "armature/pose.hpp"
 #include "armature_test.hpp"
 
 ArmatureTest::ArmatureTest()
 {
-  FileReader reader = FileReader::parse("armature.arm");
-  armature = new Armature(reader);
-  
-  xrot = 0;
+  FileReader armature_reader = FileReader::parse("armature.arm");
+  armature = new Armature(armature_reader);
+
+  FileReader pose_reader = FileReader::parse("pose.pose");
+  pose = new Pose(pose_reader);
+
+  armature->apply(*pose);
+
+  xrot = 180;
   yrot = 0;
+  zrot = 0;
 }
 
 void
@@ -91,8 +98,8 @@
     }
   else
     { 
-      xrot += controller.get_axis_state(X_AXIS) * 90 * delta;
-      yrot += controller.get_axis_state(Y_AXIS) * 90 * delta;
+      yrot += controller.get_axis_state(X_AXIS) * 90 * delta;
+      xrot += controller.get_axis_state(Y_AXIS) * 90 * delta;
       zrot += controller.get_axis_state(X2_AXIS) * 90 * delta;
     }
 }

Modified: trunk/windstille/src/armature_test.hpp
===================================================================
--- trunk/windstille/src/armature_test.hpp	2007-06-21 23:12:01 UTC (rev 1491)
+++ trunk/windstille/src/armature_test.hpp	2007-06-22 00:25:15 UTC (rev 1492)
@@ -34,9 +34,11 @@
 {
 private:
   Armature* armature;
+  Pose*     pose;
   float xrot;
   float yrot;
   float zrot;
+
 public:
   ArmatureTest();
 


Property changes on: trunk/windstille/tools
___________________________________________________________________
Name: svn:ignore
   - semantic.cache

   + 


From grumbel at mail.berlios.de  Fri Jun 22 04:22:51 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 22 Jun 2007 04:22:51 +0200
Subject: [Windstille-commit] r1493 - in trunk/windstille: data data/armature
	data/armature/pose src src/armature tools
Message-ID: <200706220222.l5M2MpRE030200@sheep.berlios.de>

Author: grumbel
Date: 2007-06-22 04:22:50 +0200 (Fri, 22 Jun 2007)
New Revision: 1493

Added:
   trunk/windstille/data/armature/
   trunk/windstille/data/armature/armature.arm
   trunk/windstille/data/armature/pose/
   trunk/windstille/data/armature/pose/pose-Armature.002-frame001.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame002.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame003.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame004.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame005.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame006.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame007.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame008.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame009.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame010.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame011.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame012.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame013.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame014.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame015.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame016.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame017.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame018.scm
   trunk/windstille/data/armature/pose/pose-Armature.002-frame019.scm
Modified:
   trunk/windstille/data/armature.arm
   trunk/windstille/data/pose.pose
   trunk/windstille/src/armature/armature.cpp
   trunk/windstille/src/armature/armature.hpp
   trunk/windstille/src/armature/pose.cpp
   trunk/windstille/src/armature_test.cpp
   trunk/windstille/src/armature_test.hpp
   trunk/windstille/tools/bone_export.py
   trunk/windstille/tools/ipo_export.py
   trunk/windstille/tools/pose_export.py
   trunk/windstille/tools/windstille_export.py
Log:
- some simple animation support

Added: trunk/windstille/data/armature/armature.arm
===================================================================
--- trunk/windstille/data/armature/armature.arm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/armature.arm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,300 @@
+;; -*- scheme -*-
+(armature
+  (name "Armature.002")
+  (bones
+    (bone
+      (name      "Bone.010")
+      (children )
+      (parent    "Bone.009")
+      (head      0.000000 0.000000 -0.000000)
+      (length    0.609991073608)
+      (matrix   -0.885631  0.281301 -0.369496  0.000000
+                -0.399716 -0.056720  0.914883  0.000000
+                 0.236400  0.957942  0.162673  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.234692 -0.045868 0.645414 0.725435)
+      (euler     79.917725 21.684511 162.378693)
+     )
+
+    (bone
+      (name      "Bone.009")
+      (children  "Bone.010")
+      (parent    "Bone.008")
+      (head      -0.000000 0.000000 0.000000)
+      (length    0.528390228748)
+      (matrix    0.984876 -0.173263  0.000002  0.000000
+                 0.173263  0.984876  0.000000  0.000000
+                -0.000002 -0.000000  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.996212 0.000000 -0.000001 -0.086961)
+      (euler     0.000021 -0.000104 -9.977577)
+     )
+
+    (bone
+      (name      "Bone.004")
+      (children  "Bone.008")
+      (parent    "Bone.017")
+      (head      0.120711 -0.025305 0.000000)
+      (length    0.669082939625)
+      (matrix   -0.798969 -0.601373 -0.000000  0.000000
+                 0.601373 -0.798969  0.000000  0.000000
+                -0.000000 -0.000000  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.317042 0.000000 -0.000000 -0.948411)
+      (euler     0.000001 0.000003 -143.031738)
+     )
+
+    (bone
+      (name      "Bone.007")
+      (children )
+      (parent    "Bone.006")
+      (head      -0.000000 0.000000 0.000000)
+      (length    0.580758750439)
+      (matrix   -0.940337 -0.203485  0.272691  0.000000
+                 0.255785  0.105733  0.960934  0.000000
+                -0.224368  0.973352 -0.047376  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.171770 -0.018073 -0.723437 -0.668436)
+      (euler     -87.177460 -164.175507 12.210286)
+     )
+
+    (bone
+      (name      "Bone.006")
+      (children  "Bone.007")
+      (parent    "Bone.005")
+      (head      0.000000 -0.000000 -0.000000)
+      (length    0.460424721241)
+      (matrix    0.975521  0.219905 -0.000003  0.000000
+                -0.219905  0.975521  0.000000  0.000000
+                 0.000003  0.000000  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.993861 -0.000000 0.000001 0.110632)
+      (euler     0.000007 0.000158 12.703450)
+     )
+
+    (bone
+      (name      "Bone.016")
+      (children  "Bone.018")
+      (parent    "Bone.015")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.7483959198)
+      (matrix    0.992324  0.120612 -0.027324  0.000000
+                 0.020425 -0.377748 -0.925683  0.000000
+                -0.121970  0.918019 -0.377312  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.556162 -0.828762 -0.042545 0.045035)
+      (euler     -112.175987 1.565737 6.930047)
+     )
+
+    (bone
+      (name      "Bone.008")
+      (children  "Bone.009")
+      (parent    "Bone.004")
+      (head      -0.000000 0.000000 0.000000)
+      (length    0.534853637218)
+      (matrix    0.817942 -0.575300 -0.000003  0.000000
+                 0.575300  0.817942  0.000000  0.000000
+                 0.000002 -0.000002  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.953400 0.000000 0.000001 -0.301710)
+      (euler     0.000003 0.000157 -35.120655)
+     )
+
+    (bone
+      (name      "Bone.020")
+      (children )
+      (parent    "Bone.019")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.78316706419)
+      (matrix    1.000000 -0.000000  0.000000  0.000000
+                -0.000000  0.786170  0.618010  0.000000
+                -0.000000 -0.618010  0.786170  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.945032 0.326978 -0.000000 0.000000)
+      (euler     38.170944 -0.000017 -0.000001)
+     )
+
+    (bone
+      (name      "Bone.019")
+      (children  "Bone.020")
+      (parent    "Bone.018")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.885059118271)
+      (matrix    1.000000 -0.000000 -0.000000  0.000000
+                -0.000000  0.904786 -0.425867  0.000000
+                 0.000000  0.425867  0.904786  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.975906 -0.218191 0.000000 -0.000000)
+      (euler     -25.205572 0.000022 -0.000006)
+     )
+
+    (bone
+      (name      "Bone.018")
+      (children  "Bone.019")
+      (parent    "Bone.016")
+      (head      0.000000 -0.000000 0.000000)
+      (length    0.71182602644)
+      (matrix    0.999458 -0.018364 -0.027324  0.000000
+                -0.011594  0.580457 -0.814208  0.000000
+                 0.030813  0.814084  0.579929  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.888798 -0.458004 0.016353 -0.001904)
+      (euler     -54.539196 1.565734 -1.052639)
+     )
+
+    (bone
+      (name      "Bone.015")
+      (children  "Bone.016")
+      (parent    "Bone")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.392938047647)
+      (matrix    0.994743 -0.102400  0.000000  0.000000
+                 0.102400  0.994743  0.000000  0.000000
+                -0.000000 -0.000000  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.998685 0.000000 -0.000000 -0.051268)
+      (euler     0.000000 -0.000000 -5.877400)
+     )
+
+    (bone
+      (name      "Bone.005")
+      (children  "Bone.006")
+      (parent    "Bone.003")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.571729123592)
+      (matrix    0.782333  0.622860  0.000001  0.000000
+                -0.622860  0.782333  0.000000  0.000000
+                -0.000000 -0.000000  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.944016 0.000000 -0.000000 0.329899)
+      (euler     0.000003 -0.000030 38.525307)
+     )
+
+    (bone
+      (name      "Bone.012")
+      (children )
+      (parent    "Bone.011")
+      (head      -0.000000 -0.000000 -0.000000)
+      (length    0.616346955299)
+      (matrix   -0.601701 -0.639778  0.478163  0.000000
+                 0.473508  0.196392  0.858615  0.000000
+                -0.643230  0.743044  0.184771  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.441436 0.065452 -0.635083 -0.630492)
+      (euler     77.855347 -28.565475 -133.243271)
+     )
+
+    (bone
+      (name      "Bone.013")
+      (children  "Bone.014")
+      (parent    "Bone.001")
+      (head      0.000000 -0.000000 0.000000)
+      (length    0.552089631557)
+      (matrix    0.828948 -0.559326 -0.000001  0.000000
+                 0.559326  0.828948  0.000000  0.000000
+                 0.000000 -0.000000  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.956281 0.000000 0.000000 -0.292448)
+      (euler     0.000002 0.000034 -34.009186)
+     )
+
+    (bone
+      (name      "Bone.001")
+      (children  "Bone.013")
+      (parent    "Bone")
+      (head      0.486525 0.028998 0.000000)
+      (length    0.355913609266)
+      (matrix   -0.662888 -0.748718  0.000000  0.000000
+                 0.748718 -0.662888 -0.000000  0.000000
+                 0.000000  0.000000  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.410556 -0.000000 0.000000 -0.911836)
+      (euler     -0.000003 -0.000007 -131.520508)
+     )
+
+    (bone
+      (name      "Bone.002")
+      (children  "Bone.011")
+      (parent    "Bone")
+      (head      -0.360867 -0.016110 -0.000000)
+      (length    0.393084317446)
+      (matrix   -0.500073  0.865983  0.000000  0.000000
+                -0.865983 -0.500073  0.000000  0.000000
+                 0.000000 -0.000000  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.499964 0.000000 0.000000 0.866046)
+      (euler     0.000002 -0.000003 120.004814)
+     )
+
+    (bone
+      (name      "Bone.003")
+      (children  "Bone.005")
+      (parent    "Bone.017")
+      (head      -0.080474 -0.013809 -0.000000)
+      (length    0.692165970802)
+      (matrix   -0.664364  0.747409  0.000000  0.000000
+                -0.747409 -0.664364  0.000000  0.000000
+                 0.000000 -0.000000  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.409656 0.000000 0.000000 0.912240)
+      (euler     0.000000 -0.000000 131.633560)
+     )
+
+    (bone ;; a root bone
+      (name      "Bone.017")
+      (children  "Bone" "Bone.003" "Bone.004")
+      (parent )
+      (head      0.000000 0.979157 -0.000000)
+      (length    0.259003162384)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000  1.000000  0.000000  0.000000
+                 0.000000  0.000000  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      1.000000 0.000000 0.000000 0.000000)
+      (euler     0.000000 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Bone.011")
+      (children  "Bone.012")
+      (parent    "Bone.002")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.563668131828)
+      (matrix    0.666182  0.745789 -0.000000  0.000000
+                -0.745789  0.666182  0.000000  0.000000
+                 0.000000 -0.000000  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.912738 0.000000 0.000000 0.408545)
+      (euler     0.000001 0.000001 48.226898)
+     )
+
+    (bone
+      (name      "Bone")
+      (children  "Bone.001" "Bone.002" "Bone.015")
+      (parent    "Bone.017")
+      (head      -0.000000 0.106902 0.000000)
+      (length    0.844800710678)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000  1.000000  0.000000  0.000000
+                 0.000000  0.000000  1.000000  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      1.000000 0.000000 0.000000 0.000000)
+      (euler     0.000000 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Bone.014")
+      (children )
+      (parent    "Bone.013")
+      (head      -0.000000 0.000000 0.000000)
+      (length    0.541055560112)
+      (matrix   -0.894525  0.417369 -0.160087  0.000000
+                -0.200734 -0.055060  0.978097  0.000000
+                 0.399413  0.907067  0.133033  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.214154 0.082919 0.653152 0.721564)
+      (euler     82.254608 9.211948 154.987091)
+     )
+
+  ) ;; bones
+ ) ;; armature

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame001.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame001.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame001.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.736380 0.540556 -0.406869 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.846600 0.436540 -0.036300 -0.302296))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.715425 0.000000 -0.100495 0.691424))
+    (bone
+      (name "Bone.019")
+      (quat 0.664517 0.000000 0.541520 -0.514949))
+    (bone
+      (name "Bone.018")
+      (quat 0.772098 0.000000 -0.230177 0.592354))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.950125 -0.020398 0.084046 0.299639))
+    (bone
+      (name "Bone.001")
+      (quat 0.568982 0.560086 -0.438783 -0.412350))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.717549 -0.462735 -0.520576 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.671091 0.710779 0.138496 -0.158901))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame002.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame002.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame002.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.739070 0.538207 -0.405102 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.848401 0.433207 -0.037753 -0.301865))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.717480 -0.001788 -0.101162 0.689191))
+    (bone
+      (name "Bone.019")
+      (quat 0.665072 0.000559 0.541572 -0.514177))
+    (bone
+      (name "Bone.018")
+      (quat 0.772393 0.003023 -0.230445 0.591857))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.951001 -0.021817 0.083613 0.296866))
+    (bone
+      (name "Bone.001")
+      (quat 0.569026 0.560027 -0.439345 -0.411771))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.720260 -0.460872 -0.518480 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.669841 0.713037 0.135383 -0.156725))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame003.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame003.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame003.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.746589 0.531541 -0.400086 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.853400 0.423773 -0.041848 -0.300623))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.723215 -0.006820 -0.103032 0.682860))
+    (bone
+      (name "Bone.019")
+      (quat 0.666623 0.002125 0.541716 -0.512009))
+    (bone
+      (name "Bone.018")
+      (quat 0.773183 0.011522 -0.231188 0.590430))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.953412 -0.025807 0.082389 0.289052))
+    (bone
+      (name "Bone.001")
+      (quat 0.569146 0.559858 -0.440925 -0.410142))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.727841 -0.455586 -0.512532 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.666231 0.719339 0.126569 -0.150557))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame004.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame004.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame004.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.758214 0.520929 -0.392101 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.861032 0.408826 -0.048275 -0.298588))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.732056 -0.014707 -0.105943 0.672795))
+    (bone
+      (name "Bone.019")
+      (quat 0.669023 0.004561 0.541928 -0.508627))
+    (bone
+      (name "Bone.018")
+      (quat 0.774301 0.024809 -0.232314 0.588109))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.957025 -0.032048 0.080459 0.276773))
+    (bone
+      (name "Bone.001")
+      (quat 0.569328 0.559590 -0.443386 -0.407594))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.739569 -0.447172 -0.503066 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.660296 0.729052 0.112602 -0.140761))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame005.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame005.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame005.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.773314 0.506562 -0.381289 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.870756 0.388720 -0.056808 -0.295727))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.743497 -0.025160 -0.109761 0.659190))
+    (bone
+      (name "Bone.019")
+      (quat 0.672148 0.007756 0.542188 -0.504171))
+    (bone
+      (name "Bone.018")
+      (quat 0.775560 0.042361 -0.233736 0.584876))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.961500 -0.040295 0.077880 0.260441))
+    (bone
+      (name "Bone.001")
+      (quat 0.569557 0.559227 -0.446619 -0.404229))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.754818 -0.435781 -0.490249 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.651902 0.741591 0.093811 -0.127539))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame006.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame006.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame006.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.791297 0.488510 -0.367705 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.882033 0.363659 -0.067269 -0.291968))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.757066 -0.037949 -0.114372 0.642130))
+    (bone
+      (name "Bone.019")
+      (quat 0.675893 0.011622 0.542473 -0.498755))
+    (bone
+      (name "Bone.018")
+      (quat 0.776757 0.063758 -0.235370 0.580675))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.966495 -0.050351 0.074691 0.240362))
+    (bone
+      (name "Bone.001")
+      (quat 0.569819 0.558768 -0.450534 -0.400129))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.773011 -0.421470 -0.474149 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.640796 0.756376 0.070397 -0.110999))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame007.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame007.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame007.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.811581 0.466784 -0.351354 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.894303 0.333779 -0.079496 -0.287218))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.772301 -0.052875 -0.119671 0.621638))
+    (bone
+      (name "Bone.019")
+      (quat 0.680165 0.016082 0.542764 -0.492468))
+    (bone
+      (name "Bone.018")
+      (quat 0.777682 0.088637 -0.237131 0.575433))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.971662 -0.062044 0.070921 0.216781))
+    (bone
+      (name "Bone.001")
+      (quat 0.570100 0.558214 -0.455056 -0.395358))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.793577 -0.404249 -0.454774 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.626644 0.772782 0.042511 -0.091205))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame008.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame008.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame008.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.833553 0.441375 -0.332231 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.906972 0.299200 -0.093327 -0.281373))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.788738 -0.069749 -0.125549 0.597716))
+    (bone
+      (name "Bone.019")
+      (quat 0.684883 0.021070 0.543038 -0.485388))
+    (bone
+      (name "Bone.018")
+      (quat 0.778119 0.116664 -0.238934 0.569062))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.976646 -0.075214 0.066594 0.189922))
+    (bone
+      (name "Bone.001")
+      (quat 0.570386 0.557563 -0.460117 -0.389969))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.815928 -0.384107 -0.432114 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.609066 0.790112 0.010317 -0.068227))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame009.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame009.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame009.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.856562 0.412295 -0.310344 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.919409 0.260079 -0.108578 -0.274329))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.805897 -0.088369 -0.131899 0.570372))
+    (bone
+      (name "Bone.019")
+      (quat 0.689971 0.026529 0.543278 -0.477584))
+    (bone
+      (name "Bone.018")
+      (quat 0.777851 0.147505 -0.240695 0.561476))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.981091 -0.089697 0.061736 0.160011))
+    (bone
+      (name "Bone.001")
+      (quat 0.570665 0.556810 -0.465664 -0.384007))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.839441 -0.361053 -0.406177 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.587684 0.807574 -0.025947 -0.042184))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame010.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame010.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame010.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.879910 0.379615 -0.285747 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.930951 0.216663 -0.125031 -0.265997))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.823279 -0.108511 -0.138602 0.539654))
+    (bone
+      (name "Bone.019")
+      (quat 0.695360 0.032405 0.543465 -0.469116))
+    (bone
+      (name "Bone.018")
+      (quat 0.776670 0.180809 -0.242331 0.552601))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.984644 -0.105319 0.056376 0.127298))
+    (bone
+      (name "Bone.001")
+      (quat 0.570926 0.555951 -0.471645 -0.377510))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.863447 -0.335135 -0.377019 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.562175 0.824281 -0.065906 -0.013291))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame011.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame011.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame011.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.902857 0.343502 -0.258566 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.940927 0.169326 -0.142425 -0.256320))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.840375 -0.129917 -0.145533 0.505680))
+    (bone
+      (name "Bone.019")
+      (quat 0.700987 0.038647 0.543584 -0.460044))
+    (bone
+      (name "Bone.018")
+      (quat 0.774382 0.216193 -0.243761 0.542378))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.986969 -0.121888 0.050553 0.092083))
+    (bone
+      (name "Bone.001")
+      (quat 0.571156 0.554982 -0.478015 -0.370509))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.887244 -0.306475 -0.344777 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.532343 0.839286 -0.109006 0.018108))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame012.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame012.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame012.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.924651 0.304252 -0.229022 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.948695 0.118606 -0.160450 -0.245287))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.856675 -0.152287 -0.152556 0.468662))
+    (bone
+      (name "Bone.019")
+      (quat 0.706788 0.045204 0.543619 -0.450428))
+    (bone
+      (name "Bone.018")
+      (quat 0.770820 0.253234 -0.244910 0.530781))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.987759 -0.139187 0.044314 0.054722))
+    (bone
+      (name "Bone.001")
+      (quat 0.571345 0.553899 -0.484735 -0.363033))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.910110 -0.275294 -0.309698 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.498192 0.851639 -0.154478 0.051507))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame013.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame013.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame013.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.944566 0.262312 -0.197453 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.953690 0.065224 -0.178756 -0.232952))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.871691 -0.175282 -0.159531 0.428930))
+    (bone
+      (name "Bone.019")
+      (quat 0.712703 0.052025 0.543558 -0.440333))
+    (bone
+      (name "Bone.018")
+      (quat 0.765856 0.291458 -0.245712 0.517825))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.986757 -0.156979 0.037724 0.015644))
+    (bone
+      (name "Bone.001")
+      (quat 0.571481 0.552697 -0.491765 -0.355109))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.931344 -0.241925 -0.272159 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.459991 0.860483 -0.201347 0.086234))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame014.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame014.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame014.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.961948 0.218298 -0.164323 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.955483 0.010084 -0.196961 -0.219446))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.884983 -0.198523 -0.166315 0.386953))
+    (bone
+      (name "Bone.019")
+      (quat 0.718669 0.059054 0.543390 -0.429831))
+    (bone
+      (name "Bone.018")
+      (quat 0.759416 0.330338 -0.246113 0.503579))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.983777 -0.174997 0.030861 -0.024642))
+    (bone
+      (name "Bone.001")
+      (quat 0.571556 0.551371 -0.499069 -0.346760))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.950304 -0.206836 -0.232684 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.418325 0.865165 -0.248469 0.121479))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame015.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame015.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame015.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.976275 0.172998 -0.130224 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.953838 -0.045737 -0.214666 -0.204987))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.896187 -0.221595 -0.172771 0.343357))
+    (bone
+      (name "Bone.019")
+      (quat 0.724620 0.066223 0.543109 -0.419014))
+    (bone
+      (name "Bone.018")
+      (quat 0.751499 0.369286 -0.246078 0.488183))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.978728 -0.192950 0.023822 -0.065535))
+    (bone
+      (name "Bone.001")
+      (quat 0.571561 0.549918 -0.506613 -0.338011))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.966458 -0.170629 -0.191952 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.374105 0.865341 -0.294603 0.156330))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame016.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame016.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame016.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.987208 0.127380 -0.095885 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.948768 -0.101000 -0.231473 -0.189890))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.905046 -0.244048 -0.178766 0.298956))
+    (bone
+      (name "Bone.019")
+      (quat 0.730479 0.073449 0.542713 -0.408005))
+    (bone
+      (name "Bone.018")
+      (quat 0.742198 0.407634 -0.245595 0.471869))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.971648 -0.210515 0.016729 -0.106319))
+    (bone
+      (name "Bone.001")
+      (quat 0.571486 0.548335 -0.514359 -0.328888))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.979432 -0.134055 -0.150808 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.328548 0.861069 -0.338493 0.189839))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame017.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame017.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame017.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.994636 0.082637 -0.062205 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.940592 -0.154278 -0.246988 -0.174589))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.911438 -0.265377 -0.184177 0.254823))
+    (bone
+      (name "Bone.019")
+      (quat 0.736148 0.080610 0.542208 -0.396987))
+    (bone
+      (name "Bone.018")
+      (quat 0.731743 0.444580 -0.244684 0.455006))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.962750 -0.227316 0.009739 -0.146097))
+    (bone
+      (name "Bone.001")
+      (quat 0.571324 0.546623 -0.522266 -0.319422))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.989048 -0.098058 -0.110312 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.283173 0.852860 -0.378920 0.221048))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame018.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame018.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame018.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.998722 0.040376 -0.030393 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.930040 -0.203752 -0.260776 -0.159709))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.915408 -0.284939 -0.188874 0.212519))
+    (bone
+      (name "Bone.019")
+      (quat 0.741474 0.087503 0.541615 -0.386281))
+    (bone
+      (name "Bone.018")
+      (quat 0.720600 0.479010 -0.243418 0.438216))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.952526 -0.242851 0.003085 -0.183599))
+    (bone
+      (name "Bone.001")
+      (quat 0.571073 0.544785 -0.530278 -0.309661))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.995360 -0.063928 -0.071917 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.239925 0.841768 -0.414609 0.248922))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Added: trunk/windstille/data/armature/pose/pose-Armature.002-frame019.scm
===================================================================
--- trunk/windstille/data/armature/pose/pose-Armature.002-frame019.scm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature/pose/pose-Armature.002-frame019.scm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -0,0 +1,57 @@
+;; -*- scheme -*-
+(pose
+  (name "Armature.002")
+  (bones
+    ;; ignoring 'Bone.010' due to having the identity Quaternion
+    ;; ignoring 'Bone.009' due to having the identity Quaternion
+    (bone
+      (name "Bone.004")
+      (quat 0.999991 0.003416 -0.002572 0.000000))
+    ;; ignoring 'Bone.007' due to having the identity Quaternion
+    ;; ignoring 'Bone.006' due to having the identity Quaternion
+    (bone
+      (name "Bone.016")
+      (quat 0.918602 -0.246338 -0.272150 -0.146366))
+    ;; ignoring 'Bone.008' due to having the identity Quaternion
+    (bone
+      (name "Bone.020")
+      (quat 0.917227 -0.301606 -0.192656 0.174963))
+    (bone
+      (name "Bone.019")
+      (quat 0.746138 0.093681 0.540994 -0.376600))
+    (bone
+      (name "Bone.018")
+      (quat 0.709783 0.508838 -0.241974 0.422778))
+    (bone
+      (name "Bone.015")
+      (quat 0.997297 -0.045054 -0.014857 -0.056114))
+    ;; ignoring 'Bone.005' due to having the identity Quaternion
+    (bone
+      (name "Bone.012")
+      (quat 0.772734 0.447621 0.051084 0.447110))
+    (bone
+      (name "Bone.013")
+      (quat 0.942078 -0.256202 -0.002795 -0.216431))
+    (bone
+      (name "Bone.001")
+      (quat 0.570734 0.542843 -0.538293 -0.299707))
+    (bone
+      (name "Bone.002")
+      (quat 0.748372 0.657628 -0.061520 -0.060665))
+    (bone
+      (name "Bone.003")
+      (quat 0.998692 -0.033965 -0.038210 0.000000))
+    ;; ignoring 'Bone.017' due to having the identity Quaternion
+    (bone
+      (name "Bone.011")
+      (quat 0.739131 0.246644 0.536565 -0.323960))
+    (bone
+      (name "Bone")
+      (quat 0.995361 -0.020720 -0.008488 -0.093572))
+    (bone
+      (name "Bone.014")
+      (quat 0.201918 0.829736 -0.443665 0.271898))
+   ) ;; bones
+ ) ;; pose
+
+;; EOF ;;

Modified: trunk/windstille/data/armature.arm
===================================================================
--- trunk/windstille/data/armature.arm	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/armature.arm	2007-06-22 02:22:50 UTC (rev 1493)
@@ -1,300 +1,532 @@
 ;; -*- scheme -*-
 (armature
-  (name "Armature.002")
+  (name "Armature")
   (bones
     (bone
-      (name      "Bone.010")
+      (name      "LegNull.L")
       (children )
-      (parent    "Bone.009")
-      (head      -0.000000 -0.000000 0.000000)
-      (length    0.609991371632)
-      (matrix   -0.885632  0.281300 -0.369496  0.000000
-                -0.399715 -0.056720  0.914883  0.000000
-                 0.236399  0.957942  0.162673  0.000000
+      (parent    "Lower Leg.L")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.304411530495)
+      (matrix    0.999972  0.005368  0.005170  0.000000
+                -0.007122  0.892687  0.450621  0.000000
+                -0.002196 -0.450645  0.892701  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.234692 -0.045868 0.645414 0.725435)
-      (euler     79.917725 21.684511 162.378754)
+      (quat      0.972800 0.231616 -0.001893 0.003210)
+      (euler     26.783894 -0.296207 0.307582)
      )
 
     (bone
-      (name      "Bone.009")
-      (children  "Bone.010")
-      (parent    "Bone.008")
-      (head      0.000000 -0.000000 -0.000000)
-      (length    0.528390169144)
-      (matrix    0.984876 -0.173264  0.000002  0.000000
-                 0.173264  0.984876  0.000000  0.000000
-                -0.000002 -0.000000  1.000000  0.000000
+      (name      "Hip.R")
+      (children  "Upper Leg.R")
+      (parent    "Base")
+      (head      0.040620 -0.025407 0.039311)
+      (length    0.431728333235)
+      (matrix    0.464597  0.621588  0.630696  0.000000
+                 0.637705 -0.729017  0.248730  0.000000
+                 0.614396  0.286639 -0.735089  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.996212 0.000000 -0.000001 -0.086961)
-      (euler     0.000021 -0.000104 -9.977630)
+      (quat      0.011075 -0.855673 -0.367925 -0.363775)
+      (euler     161.305908 -39.101479 53.224251)
      )
 
     (bone
-      (name      "Bone.004")
-      (children  "Bone.008")
-      (parent    "Bone.017")
-      (head      0.120711 -0.025305 0.000000)
-      (length    0.669082939625)
-      (matrix   -0.798969 -0.601373 -0.000000  0.000000
-                 0.601373 -0.798969  0.000000  0.000000
-                -0.000000 -0.000000  1.000000  0.000000
+      (name      "Foot.L")
+      (children  "Toes.L")
+      (parent    "Lower Leg.L")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.404503107071)
+      (matrix    0.906031  0.404751  0.123627  0.000000
+                -0.132580  0.548868 -0.825328  0.000000
+                -0.401907  0.731382  0.550954  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.317042 0.000000 -0.000000 -0.948411)
-      (euler     0.000004 0.000012 -143.031738)
+      (quat      0.866870 -0.448946 -0.151561 0.154963)
+      (euler     -56.274601 -7.101489 24.071722)
      )
 
     (bone
-      (name      "Bone.007")
+      (name      "Upper Arm.L")
+      (children  "Forearm.L")
+      (parent    "Shoulder.L")
+      (head      0.000000 -0.000000 -0.000000)
+      (length    0.532597184181)
+      (matrix    0.910775 -0.272327  0.310365  0.000000
+                 0.149810  0.918392  0.366215  0.000000
+                -0.384767 -0.287044  0.877246  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.962602 0.169659 -0.180534 -0.109634)
+      (euler     22.658567 -18.081202 -16.646996)
+     )
+
+    (bone
+      (name      "Belly")
       (children )
-      (parent    "Bone.006")
-      (head      -0.000000 -0.000000 -0.000000)
-      (length    0.580758810043)
-      (matrix   -0.940337 -0.203484  0.272692  0.000000
-                 0.255785  0.105733  0.960934  0.000000
-                -0.224367  0.973352 -0.047377  0.000000
+      (parent    "Base")
+      (head      0.000000 -0.023287 0.366125)
+      (length    0.353247731924)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000 -0.210548  0.977583  0.000000
+                 0.000000 -0.977583 -0.210548  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.171770 -0.018074 -0.723437 -0.668436)
-      (euler     -87.177452 -164.175507 12.210252)
+      (quat      0.628272 0.777994 0.000000 0.000000)
+      (euler     102.154480 -0.000000 0.000000)
      )
 
     (bone
-      (name      "Bone.006")
-      (children  "Bone.007")
-      (parent    "Bone.005")
+      (name      "Upper Arm.R")
+      (children  "Forearm.R")
+      (parent    "Shoulder.R")
       (head      0.000000 -0.000000 -0.000000)
-      (length    0.460424661636)
-      (matrix    0.975521  0.219905 -0.000003  0.000000
-                -0.219905  0.975521  0.000000  0.000000
-                 0.000003  0.000000  1.000000  0.000000
+      (length    0.532600164413)
+      (matrix    0.910775  0.272329 -0.310364  0.000000
+                -0.149812  0.918392  0.366214  0.000000
+                 0.384767 -0.287043  0.877246  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.993861 -0.000000 0.000001 0.110632)
-      (euler     0.000007 0.000158 12.703480)
+      (quat      0.962602 0.169659 0.180534 0.109635)
+      (euler     22.658527 18.081165 16.647091)
      )
 
     (bone
-      (name      "Bone.016")
-      (children  "Bone.018")
-      (parent    "Bone.015")
-      (head      0.000000 -0.000000 -0.000000)
-      (length    0.7483959198)
-      (matrix    0.992324  0.120612 -0.027324  0.000000
-                 0.020425 -0.377748 -0.925683  0.000000
-                -0.121970  0.918019 -0.377312  0.000000
+      (name      "Foot.R")
+      (children  "Toes.R")
+      (parent    "Lower Leg.R")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.404503583908)
+      (matrix    0.906031 -0.404751 -0.123628  0.000000
+                 0.132580  0.548868 -0.825328  0.000000
+                 0.401908  0.731382  0.550954  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.556162 -0.828762 -0.042544 0.045035)
-      (euler     -112.175995 1.565737 6.930044)
+      (quat      0.866870 -0.448946 0.151561 -0.154963)
+      (euler     -56.274616 7.101521 -24.071732)
      )
 
     (bone
-      (name      "Bone.008")
-      (children  "Bone.009")
-      (parent    "Bone.004")
-      (head      -0.000000 0.000000 0.000000)
-      (length    0.534853637218)
-      (matrix    0.817942 -0.575300 -0.000003  0.000000
-                 0.575300  0.817942  0.000000  0.000000
-                 0.000002 -0.000002  1.000000  0.000000
+      (name      "Hip.L")
+      (children  "Upper Leg.L")
+      (parent    "Base")
+      (head      -0.039261 -0.025407 0.039311)
+      (length    0.431728303432)
+      (matrix    0.464598 -0.621588 -0.630696  0.000000
+                -0.637705 -0.729017  0.248730  0.000000
+                -0.614396  0.286638 -0.735089  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.953400 0.000000 0.000001 -0.301710)
-      (euler     0.000006 0.000148 -35.120655)
+      (quat      0.011075 -0.855673 0.367926 0.363775)
+      (euler     161.305908 39.101467 -53.224239)
      )
 
     (bone
-      (name      "Bone.020")
+      (name      "LegNull.R")
       (children )
-      (parent    "Bone.019")
+      (parent    "Lower Leg.R")
       (head      0.000000 0.000000 0.000000)
-      (length    0.783167004585)
-      (matrix    1.000000 -0.000000  0.000000  0.000000
-                -0.000000  0.786170  0.618010  0.000000
-                -0.000000 -0.618010  0.786170  0.000000
+      (length    0.304411709309)
+      (matrix    0.999972 -0.005368 -0.005170  0.000000
+                 0.007122  0.892687  0.450621  0.000000
+                 0.002196 -0.450646  0.892700  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.945032 0.326978 -0.000000 0.000000)
-      (euler     38.170948 -0.000017 -0.000002)
+      (quat      0.972800 0.231617 0.001893 -0.003210)
+      (euler     26.783947 0.296225 -0.307576)
      )
 
     (bone
-      (name      "Bone.019")
-      (children  "Bone.020")
-      (parent    "Bone.018")
+      (name      "Neck")
+      (children  "Head")
+      (parent    "Shoulders")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.265078753233)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000  0.779717  0.626133  0.000000
+                 0.000000 -0.626133  0.779717  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.943323 0.331876 0.000000 0.000000)
+      (euler     38.765362 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Hip")
+      (children  "Body")
+      (parent    "Base")
+      (head      0.000000 0.003058 0.001977)
+      (length    0.369722664356)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000  0.997063  0.076591  0.000000
+                 0.000000 -0.076591  0.997063  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.999265 0.038324 0.000000 0.000000)
+      (euler     4.392666 -0.000000 0.000000)
+     )
+
+    (bone
+      (name      "Shoulders")
+      (children  "Shoulder.R" "Neck" "Shoulder.L")
+      (parent    "Body")
       (head      0.000000 -0.000000 0.000000)
-      (length    0.885059058666)
-      (matrix    1.000000 -0.000000 -0.000000  0.000000
-                -0.000000  0.904786 -0.425867  0.000000
-                 0.000000  0.425867  0.904786  0.000000
+      (length    0.273266792297)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000  0.999747  0.022513  0.000000
+                 0.000000 -0.022513  0.999747  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.975906 -0.218191 0.000000 -0.000000)
-      (euler     -25.205584 0.000023 -0.000006)
+      (quat      0.999937 0.011257 0.000000 0.000000)
+      (euler     1.290035 -0.000000 0.000000)
      )
 
     (bone
-      (name      "Bone.018")
-      (children  "Bone.019")
-      (parent    "Bone.016")
+      (name      "Shoulder.L")
+      (children  "Upper Arm.L")
+      (parent    "Shoulders")
+      (head      -0.133503 0.016665 -0.103217)
+      (length    0.469278484583)
+      (matrix   -0.211034 -0.390487 -0.896094  0.000000
+                -0.881235 -0.320669  0.347271  0.000000
+                -0.422954  0.862955 -0.276439  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.219008 -0.588658 0.540093 0.560193)
+      (euler     -51.479080 116.350693 61.611565)
+     )
+
+    (bone
+      (name      "FingerTips.L")
+      (children )
+      (parent    "Fingers.L")
       (head      0.000000 -0.000000 0.000000)
-      (length    0.711826086044)
-      (matrix    0.999458 -0.018364 -0.027324  0.000000
-                -0.011594  0.580457 -0.814208  0.000000
-                 0.030813  0.814084  0.579930  0.000000
+      (length    0.108158022165)
+      (matrix    0.972665 -0.148899 -0.178189  0.000000
+                 0.118983  0.978544 -0.168213  0.000000
+                 0.199413  0.142414  0.969512  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.888798 -0.458004 0.016353 -0.001904)
-      (euler     -54.539162 1.565734 -1.052638)
+      (quat      0.990040 -0.078438 0.095350 -0.067644)
+      (euler     -9.843000 10.264305 -8.703487)
      )
 
+    (bone ;; a root bone
+      (name      "Base")
+      (children  "Belly" "Hip.R" "Hip.L" "Hip")
+      (parent )
+      (head      -0.134862 -0.098326 -1.250145)
+      (length    0.226376548409)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000 -0.011341  0.999936  0.000000
+                 0.000000 -0.999936 -0.011341  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.703086 0.711105 0.000000 0.000000)
+      (euler     90.649788 -0.000000 0.000000)
+     )
+
     (bone
-      (name      "Bone.015")
-      (children  "Bone.016")
-      (parent    "Bone")
+      (name      "FingerTips.R")
+      (children )
+      (parent    "Fingers.R")
       (head      0.000000 0.000000 0.000000)
-      (length    0.392938047647)
-      (matrix    0.994743 -0.102400 -0.000000  0.000000
-                 0.102400  0.994743  0.000000  0.000000
-                -0.000000 -0.000000  1.000000  0.000000
+      (length    0.115987353027)
+      (matrix    0.983139  0.129105  0.129499  0.000000
+                -0.114042  0.986481 -0.117684  0.000000
+                -0.142942  0.100931  0.984571  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.998685 0.000000 -0.000000 -0.051267)
-      (euler     0.000007 0.000000 -5.877398)
+      (quat      0.994257 -0.054969 -0.068503 0.061138)
+      (euler     -6.816101 -7.440626 7.481205)
      )
 
     (bone
-      (name      "Bone.005")
-      (children  "Bone.006")
-      (parent    "Bone.003")
+      (name      "Shoulder.R")
+      (children  "Upper Arm.R")
+      (parent    "Shoulders")
+      (head      0.134862 0.016665 -0.103217)
+      (length    0.469281196594)
+      (matrix   -0.211033  0.390487  0.896095  0.000000
+                 0.881236 -0.320668  0.347269  0.000000
+                 0.422952  0.862956 -0.276439  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.219009 -0.588658 -0.540094 -0.560192)
+      (euler     -51.478901 -116.350647 -61.611626)
+     )
+
+    (bone
+      (name      "Body")
+      (children  "Shoulders")
+      (parent    "Hip")
       (head      0.000000 0.000000 0.000000)
-      (length    0.571729123592)
-      (matrix    0.782333  0.622860  0.000001  0.000000
-                -0.622860  0.782333  0.000000  0.000000
-                -0.000000 -0.000000  1.000000  0.000000
+      (length    0.367126226425)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000  0.989207 -0.146523  0.000000
+                 0.000000  0.146523  0.989207  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.944016 0.000000 -0.000000 0.329899)
-      (euler     0.000003 -0.000030 38.525307)
+      (quat      0.997298 -0.073460 0.000000 0.000000)
+      (euler     -8.425456 -0.000000 0.000000)
      )
 
     (bone
-      (name      "Bone.012")
+      (name      "Toes.R")
       (children )
-      (parent    "Bone.011")
-      (head      0.000000 0.000000 0.000000)
-      (length    0.616347193718)
-      (matrix   -0.601701 -0.639778  0.478163  0.000000
-                 0.473509  0.196392  0.858615  0.000000
-                -0.643230  0.743044  0.184771  0.000000
+      (parent    "Foot.R")
+      (head      0.000000 0.000000 -0.000000)
+      (length    0.225673496723)
+      (matrix   -0.908818 -0.133897 -0.395122  0.000000
+                 0.133896  0.803379 -0.580218  0.000000
+                 0.395123 -0.580218 -0.712197  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.441436 0.065452 -0.635083 -0.630492)
-      (euler     77.855347 -28.565483 -133.243271)
+      (quat      0.213521 -0.000000 0.925256 -0.313545)
+      (euler     39.169266 156.726395 8.381133)
      )
 
+    ;; ignoring bone: IK_Foot.R
+
     (bone
-      (name      "Bone.013")
-      (children  "Bone.014")
-      (parent    "Bone.001")
-      (head      0.000000 -0.000000 -0.000000)
-      (length    0.552089452744)
-      (matrix    0.497525 -0.867449 -0.000000  0.000000
-                 0.867449  0.497525  0.000000  0.000000
-                 0.000000 -0.000000  1.000000  0.000000
+      (name      "Hand.L")
+      (children  "Fingers.L" "LowerThumb.L")
+      (parent    "Forearm.L")
+      (head      0.006394 0.036837 -0.005415)
+      (length    0.252678990364)
+      (matrix    0.997139 -0.069244 -0.030322  0.000000
+                 0.068329  0.997204 -0.030247  0.000000
+                 0.032331  0.028089  0.999082  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.865311 0.000000 0.000000 -0.501236)
-      (euler     0.000006 0.000023 -60.163593)
+      (quat      0.999178 -0.014596 0.015676 -0.034421)
+      (euler     -1.734115 1.737576 -3.972393)
      )
 
     (bone
-      (name      "Bone.001")
-      (children  "Bone.013")
-      (parent    "Bone")
+      (name      "Fingers.R")
+      (children  "FingerTips.R")
+      (parent    "Hand.R")
       (head      0.000000 0.000000 0.000000)
-      (length    0.780920624733)
-      (matrix   -0.264986 -0.964252 -0.000000  0.000000
-                 0.964252 -0.264986  0.000000  0.000000
-                -0.000000 -0.000000  1.000000  0.000000
+      (length    0.121155880392)
+      (matrix    0.991391 -0.084731  0.099819  0.000000
+                 0.094134  0.991150 -0.093593  0.000000
+                -0.091006  0.102183  0.990594  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.606224 0.000000 0.000000 -0.795294)
-      (euler     0.000003 0.000004 -105.366104)
+      (quat      0.996636 -0.049109 -0.047867 -0.044867)
+      (euler     -5.397351 -5.728763 -4.885005)
      )
 
     (bone
-      (name      "Bone.002")
-      (children  "Bone.011")
-      (parent    "Bone")
-      (head      0.000000 0.000000 0.000000)
-      (length    0.732812821865)
-      (matrix   -0.290226  0.956958  0.000000  0.000000
-                -0.956958 -0.290226  0.000000  0.000000
-                 0.000000 -0.000000  1.000000  0.000000
+      (name      "Head")
+      (children )
+      (parent    "Neck")
+      (head      0.000000 0.000000 -0.000000)
+      (length    0.266009777784)
+      (matrix    1.000000  0.000000  0.000000  0.000000
+                 0.000000  0.612928  0.790139  0.000000
+                 0.000000 -0.790139  0.612928  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.595724 0.000000 0.000000 0.803189)
-      (euler     0.000003 -0.000005 106.871468)
+      (quat      0.898033 0.439927 0.000000 0.000000)
+      (euler     52.198494 -0.000000 0.000000)
      )
 
     (bone
-      (name      "Bone.003")
-      (children  "Bone.005")
-      (parent    "Bone.017")
-      (head      -0.080474 -0.013809 -0.000000)
-      (length    0.692165970802)
-      (matrix   -0.664364  0.747409  0.000000  0.000000
-                -0.747409 -0.664364  0.000000  0.000000
-                 0.000000 -0.000000  1.000000  0.000000
+      (name      "Fingers.L")
+      (children  "FingerTips.L")
+      (parent    "Hand.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    0.123009525239)
+      (matrix    0.990993  0.081848 -0.105986  0.000000
+                -0.092455  0.990746 -0.099367  0.000000
+                 0.096872  0.108271  0.989390  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.409656 0.000000 0.000000 0.912240)
-      (euler     0.000000 -0.000000 131.633560)
+      (quat      0.996385 -0.052098 0.050899 0.043734)
+      (euler     -5.735142 6.083978 4.721476)
      )
 
-    (bone ;; a root bone
-      (name      "Bone.017")
-      (children  "Bone" "Bone.003" "Bone.004")
-      (parent )
-      (head      0.000000 0.979157 -0.000000)
-      (length    0.259003162384)
-      (matrix    1.000000  0.000000  0.000000  0.000000
-                 0.000000  1.000000  0.000000  0.000000
-                 0.000000  0.000000  1.000000  0.000000
+    ;; ignoring bone: IK_Foot.L
+
+    (bone
+      (name      "Hand.R")
+      (children  "Fingers.R" "LowerThumb.R")
+      (parent    "Forearm.R")
+      (head      -0.006394 0.036837 -0.005415)
+      (length    0.252679944038)
+      (matrix    0.997139  0.069245  0.030321  0.000000
+                -0.068330  0.997204 -0.030247  0.000000
+                -0.032331  0.028089  0.999083  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      1.000000 0.000000 0.000000 0.000000)
-      (euler     0.000000 -0.000000 0.000000)
+      (quat      0.999178 -0.014596 -0.015676 0.034422)
+      (euler     -1.734105 -1.737553 3.972439)
      )
 
     (bone
-      (name      "Bone.011")
-      (children  "Bone.012")
-      (parent    "Bone.002")
+      (name      "Toes.L")
+      (children )
+      (parent    "Foot.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    0.225673481822)
+      (matrix   -0.908818  0.133897  0.395121  0.000000
+                -0.133896  0.803379 -0.580220  0.000000
+                -0.395122 -0.580219 -0.712197  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.213520 -0.000000 -0.925256 0.313545)
+      (euler     39.169338 -156.726486 -8.381155)
+     )
+
+    (bone
+      (name      "Thumb.R")
+      (children )
+      (parent    "LowerThumb.R")
       (head      0.000000 -0.000000 -0.000000)
-      (length    0.563668251038)
-      (matrix    0.479301  0.877651 -0.000000  0.000000
-                -0.877651  0.479301  0.000000  0.000000
-                 0.000000  0.000000  1.000000  0.000000
+      (length    0.124690033495)
+      (matrix    0.802272  0.596655  0.019050  0.000000
+                -0.568549  0.753974  0.329051  0.000000
+                 0.181966 -0.274819  0.944120  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.860029 0.000000 0.000000 0.510245)
-      (euler     0.000003 0.000003 61.360241)
+      (quat      0.935463 0.161383 0.043539 0.311397)
+      (euler     19.214809 -1.091573 36.638412)
      )
 
     (bone
-      (name      "Bone")
-      (children  "Bone.001" "Bone.002" "Bone.015")
-      (parent    "Bone.017")
-      (head      0.000000 0.106902 -0.000000)
-      (length    0.844800710678)
-      (matrix    1.000000  0.000000  0.000000  0.000000
-                 0.000000  1.000000  0.000000  0.000000
-                 0.000000  0.000000  1.000000  0.000000
+      (name      "Lower Leg.L")
+      (children  "Foot.L" "LegNull.L")
+      (parent    "Upper Leg.L")
+      (head      -0.000000 -0.000000 -0.000000)
+      (length    0.840111851692)
+      (matrix    0.999287 -0.025254 -0.028072  0.000000
+                 0.028426  0.992486  0.119012  0.000000
+                 0.024856 -0.119725  0.992496  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      1.000000 0.000000 0.000000 0.000000)
-      (euler     0.000000 -0.000000 0.000000)
+      (quat      0.998032 0.059802 0.013258 -0.013447)
+      (euler     6.837777 1.608627 -1.447700)
      )
 
     (bone
-      (name      "Bone.014")
+      (name      "Upper Leg.R")
+      (children  "Lower Leg.R")
+      (parent    "Hip.R")
+      (head      -0.000384 0.012505 -0.020905)
+      (length    0.878771603107)
+      (matrix    0.491190  0.626030  0.605656  0.000000
+                -0.550237  0.762022 -0.341411  0.000000
+                -0.675256 -0.165557  0.718763  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.861971 -0.051003 -0.371507 0.341156)
+      (euler     -25.407631 -37.276051 51.881889)
+     )
+
+    (bone
+      (name      "ArmNull.R")
       (children )
-      (parent    "Bone.013")
+      (parent    "Forearm.R")
+      (head      -0.000000 0.000000 0.000000)
+      (length    0.225655809045)
+      (matrix   -0.071245  0.997459  0.000002  0.000000
+                 0.000001 -0.000002  1.000000  0.000000
+                 0.997459  0.071245 -0.000001  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.481859 0.481860 0.517505 0.517505)
+      (euler     90.000046 -0.000100 94.085472)
+     )
+
+    (bone
+      (name      "LowerThumb.R")
+      (children  "Thumb.R")
+      (parent    "Hand.R")
+      (head      0.018833 -0.247973 -0.030859)
+      (length    0.18653345108)
+      (matrix    0.641058 -0.448956  0.622481  0.000000
+                 0.720677  0.631055 -0.287045  0.000000
+                -0.263949  0.632620  0.728095  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.866055 -0.265475 -0.255881 -0.337632)
+      (euler     -21.516390 -38.497547 -35.004948)
+     )
+
+    ;; ignoring bone: IK_Arm.L
+
+    (bone
+      (name      "Thumb.L")
+      (children )
+      (parent    "LowerThumb.L")
+      (head      0.000000 -0.000000 0.000000)
+      (length    0.124689802527)
+      (matrix    0.802273 -0.596653 -0.019055  0.000000
+                 0.568549  0.753975  0.329049  0.000000
+                -0.181961 -0.274821  0.944120  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.935464 0.161383 -0.043536 -0.311397)
+      (euler     19.214701 1.091854 -36.638298)
+     )
+
+    (bone
+      (name      "Forearm.L")
+      (children  "ArmNull.L" "Hand.L")
+      (parent    "Upper Arm.L")
       (head      0.000000 0.000000 0.000000)
-      (length    0.541055619717)
-      (matrix   -0.894525  0.417369 -0.160087  0.000000
-                -0.200734 -0.055060  0.978097  0.000000
-                 0.399413  0.907067  0.133033  0.000000
+      (length    0.527911424637)
+      (matrix    0.999244 -0.013579  0.036439  0.000000
+                 0.012327  0.999333  0.034372  0.000000
+                -0.036882 -0.033897  0.998745  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.214154 0.082919 0.653152 0.721564)
-      (euler     82.254608 9.211949 154.987091)
+      (quat      0.999665 0.017073 -0.018336 -0.006479)
+      (euler     1.971080 -2.088271 -0.778577)
      )
 
+    (bone
+      (name      "Forearm.R")
+      (children  "ArmNull.R" "Hand.R")
+      (parent    "Upper Arm.R")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.52791339159)
+      (matrix    0.999244  0.013580 -0.036439  0.000000
+                -0.012328  0.999333  0.034372  0.000000
+                 0.036881 -0.033897  0.998745  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.999665 0.017073 0.018336 0.006479)
+      (euler     1.971067 2.088254 0.778619)
+     )
+
+    ;; ignoring bone: IK_Arm.R
+
+    (bone
+      (name      "LowerThumb.L")
+      (children  "Thumb.L")
+      (parent    "Hand.L")
+      (head      -0.018833 -0.247972 -0.030859)
+      (length    0.186534255743)
+      (matrix    0.641059  0.448958 -0.622479  0.000000
+                -0.720678  0.631053 -0.287046  0.000000
+                 0.263946  0.632620  0.728096  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.866055 -0.265475 0.255880 0.337633)
+      (euler     -21.516422 38.497414 35.005035)
+     )
+
+    (bone
+      (name      "ArmNull.L")
+      (children )
+      (parent    "Forearm.L")
+      (head      0.000000 0.000000 0.000000)
+      (length    0.225656166673)
+      (matrix   -0.071246 -0.997459 -0.000002  0.000000
+                -0.000001 -0.000002  1.000000  0.000000
+                -0.997459  0.071246 -0.000001  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.481859 0.481860 -0.517505 -0.517505)
+      (euler     90.000053 0.000107 -94.085587)
+     )
+
+    (bone
+      (name      "Lower Leg.R")
+      (children  "Foot.R" "LegNull.R")
+      (parent    "Upper Leg.R")
+      (head      -0.000000 0.000000 0.000000)
+      (length    0.840111792088)
+      (matrix    0.999287  0.025254  0.028077  0.000000
+                -0.028426  0.992486  0.119012  0.000000
+                -0.024860 -0.119725  0.992496  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.998032 0.059802 -0.013260 0.013446)
+      (euler     6.837786 -1.608881 1.447677)
+     )
+
+    (bone
+      (name      "Upper Leg.L")
+      (children  "Lower Leg.L")
+      (parent    "Hip.L")
+      (head      0.000384 0.012505 -0.020905)
+      (length    0.87877124548)
+      (matrix    0.491187 -0.626029 -0.605659  0.000000
+                 0.550238  0.762022 -0.341411  0.000000
+                 0.675259 -0.165560  0.718760  0.000000
+                 0.000000  0.000000  0.000000  1.000000)
+      (quat      0.861970 -0.051003 0.371509 -0.341157)
+      (euler     -25.407711 37.276279 -51.882030)
+     )
+
   ) ;; bones
  ) ;; armature

Modified: trunk/windstille/data/pose.pose
===================================================================
--- trunk/windstille/data/pose.pose	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/data/pose.pose	2007-06-22 02:22:50 UTC (rev 1493)
@@ -1,70 +1,122 @@
 ;; -*- scheme -*-
 (pose
-  (name "Armature.002")
+  (name "Armature")
   (bones
     (bone
-      (name "Bone.010")
+      (name "LegNull.L")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.009")
+      (name "Hip.R")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.004")
-      (quat 0.548134 0.668250 -0.502982 0.000000))
+      (name "Foot.L")
+      (quat 0.981134 -0.178468 0.019928 0.071610))
     (bone
-      (name "Bone.007")
+      (name "Upper Arm.L")
+      (quat 0.998861 -0.024739 0.032929 0.024101))
+    (bone
+      (name "Belly")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.006")
+      (name "Upper Arm.R")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.016")
+      (name "Foot.R")
+      (quat 0.982884 -0.170392 -0.017590 -0.067794))
+    (bone
+      (name "Hip.L")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.008")
+      (name "LegNull.R")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.020")
+      (name "Toes.R")
+      (quat 0.996146 0.087286 -0.001040 0.008563))
+    (bone
+      (name "Hip")
+      (quat 0.994097 0.108492 -0.000000 -0.000000))
+    (bone
+      (name "Shoulders")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.019")
+      (name "Shoulder.L")
+      (quat 0.995713 0.082223 -0.042187 -0.003781))
+    (bone
+      (name "FingerTips.L")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.018")
+      (name "Base")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.015")
+      (name "FingerTips.R")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.005")
+      (name "Shoulder.R")
+      (quat 0.978040 -0.058752 0.080541 -0.183029))
+    (bone
+      (name "Body")
+      (quat 0.992664 0.031935 0.114502 -0.022083))
+    (bone
+      (name "Neck")
+      (quat 0.995636 -0.093322 0.000000 0.000000))
+    ;; ignoring 'IK_Foot.R'
+    (bone
+      (name "Hand.L")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.012")
+      (name "Fingers.R")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.013")
+      (name "Head")
+      (quat 0.999629 0.027239 -0.000000 -0.000000))
+    (bone
+      (name "Fingers.L")
       (quat 1.000000 0.000000 0.000000 0.000000))
+    ;; ignoring 'IK_Foot.L'
     (bone
-      (name "Bone.001")
+      (name "Hand.R")
+      (quat 0.916991 -0.251808 -0.260843 -0.166376))
+    (bone
+      (name "Toes.L")
+      (quat 0.999787 -0.019559 0.000860 -0.006569))
+    (bone
+      (name "Thumb.R")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.002")
+      (name "Lower Leg.L")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.003")
+      (name "Upper Leg.R")
+      (quat 0.863445 -0.504211 -0.010364 -0.011251))
+    (bone
+      (name "ArmNull.R")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.017")
+      (name "LowerThumb.R")
       (quat 1.000000 0.000000 0.000000 0.000000))
+    ;; ignoring 'IK_Arm.L'
     (bone
-      (name "Bone.011")
+      (name "Thumb.L")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone")
+      (name "Forearm.L")
+      (quat 0.881179 0.401351 0.238638 0.074114))
+    (bone
+      (name "Forearm.R")
+      (quat 0.899349 0.406663 -0.154142 0.045121))
+    ;; ignoring 'IK_Arm.R'
+    (bone
+      (name "LowerThumb.L")
       (quat 1.000000 0.000000 0.000000 0.000000))
     (bone
-      (name "Bone.014")
+      (name "ArmNull.L")
       (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Lower Leg.R")
+      (quat 1.000000 0.000000 0.000000 0.000000))
+    (bone
+      (name "Upper Leg.L")
+      (quat 0.936424 -0.350708 0.007208 0.007827))
    ) ;; bones
  ) ;; pose
 

Modified: trunk/windstille/src/armature/armature.cpp
===================================================================
--- trunk/windstille/src/armature/armature.cpp	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/src/armature/armature.cpp	2007-06-22 02:22:50 UTC (rev 1493)
@@ -150,9 +150,9 @@
   Vector3 p__ = p_ + m_.multiply(Vector3(0.0f, bone->length, 0.0f));
 
   // p to p+offset
-  glColor3f(0.0f, 0.5f, 0.0f);
+  glColor4f(0.0f, 0.5f, 0.0f, 0.5f);
   glVertex3f(  p.x, p.y, p.z);
-  glColor3f(0.0f, 1.0f, 0.0f);
+  glColor4f(0.0f, 1.0f, 0.0f, 0.5f);
   glVertex3f( p_.x, p_.y, p_.z);  
 
   // p+offset to new endpoint
@@ -189,4 +189,14 @@
     }
 }
 
+void
+Armature::reset()
+{
+  for(Bones::iterator i = bones.begin(); i != bones.end(); ++i)
+    {
+      Bone* bone = *i;
+      bone->render_matrix = bone->quat.to_matrix();
+    }
+}
+
 /* EOF */

Modified: trunk/windstille/src/armature/armature.hpp
===================================================================
--- trunk/windstille/src/armature/armature.hpp	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/src/armature/armature.hpp	2007-06-22 02:22:50 UTC (rev 1493)
@@ -45,7 +45,11 @@
   Armature(FileReader& reader);
   ~Armature();
   
+  /** Applies the given Pose */
   void apply(const Pose& pose);
+  
+  /** Sets the armature back into neutral position */
+  void reset();
 
   void  parse(FileReader& reader);
   Bone* get_bone(const std::string& name);

Modified: trunk/windstille/src/armature/pose.cpp
===================================================================
--- trunk/windstille/src/armature/pose.cpp	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/src/armature/pose.cpp	2007-06-22 02:22:50 UTC (rev 1493)
@@ -46,7 +46,6 @@
       else
         {
           std::vector<FileReader> sections = bones_reader.get_sections();
-          std::cout << sections.size() << std::endl;
           for(std::vector<FileReader>::iterator i = sections.begin(); i != sections.end(); ++i)
             {
               if (i->get_name() == "bone")
@@ -64,7 +63,7 @@
         }
     }
 
-  std::cout << "Pose: " << name << " " << bones.size() << std::endl;
+  //std::cout << "Pose: " << name << " " << bones.size() << std::endl;
 }
 
 /* EOF */

Modified: trunk/windstille/src/armature_test.cpp
===================================================================
--- trunk/windstille/src/armature_test.cpp	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/src/armature_test.cpp	2007-06-22 02:22:50 UTC (rev 1493)
@@ -25,6 +25,8 @@
 
 #include <GL/glew.h>
 #include <GL/gl.h>
+#include <physfs.h>
+
 #include "input/controller.hpp"
 #include "display/display.hpp"
 #include "screen_manager.hpp"
@@ -34,17 +36,30 @@
 
 ArmatureTest::ArmatureTest()
 {
-  FileReader armature_reader = FileReader::parse("armature.arm");
+  FileReader armature_reader = FileReader::parse("armature/armature.arm");
   armature = new Armature(armature_reader);
 
-  FileReader pose_reader = FileReader::parse("pose.pose");
-  pose = new Pose(pose_reader);
+  std::vector<std::string> file_lst;
+  {
+    char** dirlist = PHYSFS_enumerateFiles("armature/pose/");
+    for (char **i = dirlist; *i != NULL; ++i)
+      if (!PHYSFS_isDirectory((std::string("armature/pose/") + *i).c_str())) {
+        std::cout << "PoseFile: " << *i << std::endl;
+        FileReader pose_reader = FileReader::parse(std::string("armature/pose/") + *i);
+        poses.push_back(new Pose(pose_reader));       
+      }
+    PHYSFS_freeList(dirlist);
+  }
 
-  armature->apply(*pose);
+  pose_idx = 0;
 
+  armature->apply(*poses[pose_idx]);
+
   xrot = 180;
   yrot = 0;
   zrot = 0;
+  
+  time = 0.0f;
 }
 
 void
@@ -72,6 +87,11 @@
 void
 ArmatureTest::update(float delta, const Controller& controller)
 {
+  time += delta;
+
+  pose_idx = int(time * 20.0f) % poses.size();
+  armature->apply(*poses[pose_idx]);
+
   if (controller.button_was_pressed(ESCAPE_BUTTON) ||
       controller.button_was_pressed(PAUSE_BUTTON))
     {
@@ -90,7 +110,7 @@
       yrot = 90;
       zrot = 0;
       }
-  if (controller.button_was_pressed(TERTIARY_BUTTON))
+  else if (controller.button_was_pressed(TERTIARY_BUTTON))
     {
       xrot = 0;
       yrot = 0;
@@ -102,6 +122,10 @@
       xrot += controller.get_axis_state(Y_AXIS) * 90 * delta;
       zrot += controller.get_axis_state(X2_AXIS) * 90 * delta;
     }
+
+  if (controller.button_was_pressed(AIM_BUTTON))
+    {
+    }
 }
 
 /* EOF */

Modified: trunk/windstille/src/armature_test.hpp
===================================================================
--- trunk/windstille/src/armature_test.hpp	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/src/armature_test.hpp	2007-06-22 02:22:50 UTC (rev 1493)
@@ -34,7 +34,11 @@
 {
 private:
   Armature* armature;
-  Pose*     pose;
+  std::vector<Pose*> poses;
+  
+  int pose_idx;
+  float time;
+
   float xrot;
   float yrot;
   float zrot;

Modified: trunk/windstille/tools/bone_export.py
===================================================================
--- trunk/windstille/tools/bone_export.py	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/tools/bone_export.py	2007-06-22 02:22:50 UTC (rev 1493)
@@ -1,5 +1,5 @@
 import Blender
-import Blender.Armature
+from Blender import *
 
 arms = Blender.Armature.Get()
 
@@ -76,4 +76,6 @@
     print "done"
 print
 
+Draw.PupMenu("Export ok")
+
 # EOF #

Modified: trunk/windstille/tools/ipo_export.py
===================================================================
--- trunk/windstille/tools/ipo_export.py	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/tools/ipo_export.py	2007-06-22 02:22:50 UTC (rev 1493)
@@ -30,4 +30,6 @@
     export_action(out, action)
     out.close
 
+Draw.PupMenu("Export ok")
+
 # EOF #

Modified: trunk/windstille/tools/pose_export.py
===================================================================
--- trunk/windstille/tools/pose_export.py	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/tools/pose_export.py	2007-06-22 02:22:50 UTC (rev 1493)
@@ -1,29 +1,41 @@
 import Blender
 from Blender import *
 
+def is_identity(quat):
+    return quat.w == 1.0 and quat.x == 0.0 and quat.y == 0.0 and quat.z == 0.0
+
 def export_pose(out, obj):
-	pose = obj.getPose()
-	
-	out.write(";; -*- scheme -*-\n")
-	out.write("(pose\n")
-	out.write("  (name \"%s\")\n" % obj.getName())
-	out.write("  (bones\n")
-	for bone in pose.bones.values():
-		out.write("    (bone\n")
-		out.write("      (name \"%s\")\n" % bone.name)
-		out.write("      (quat %f %f %f %f))\n" % 
-			(bone.quat.w, bone.quat.x, bone.quat.y, bone.quat.z))
-	out.write("   ) ;; bones\n")
-	out.write(" ) ;; pose\n")
-	out.write("\n;; EOF ;;\n")
+    pose = obj.getPose()
 
+    out.write(";; -*- scheme -*-\n")
+    out.write("(pose\n")
+    out.write("  (name \"%s\")\n" % obj.getName())
+    out.write("  (bones\n")
+    for bone in pose.bones.values():
+        if bone.name[:3] == "IK_":
+            out.write("    ;; ignoring '%s' due to being IK control bone\n" % bone.name)
+        elif is_identity(bone.quat):
+            out.write("    ;; ignoring '%s' due to having the identity Quaternion\n" % bone.name)        
+        else: 
+            out.write("    (bone\n")
+            out.write("      (name \"%s\")\n" % bone.name)
+            out.write("      (quat %f %f %f %f))\n" % 
+                      (bone.quat.w, bone.quat.x, bone.quat.y, bone.quat.z))
+    out.write("   ) ;; bones\n")
+    out.write(" ) ;; pose\n")
+    out.write("\n;; EOF ;;\n")
+
 print "Windstille Pose Exporter:"
-for obj in Blender.Object.Get():
-	if obj.type == "Armature":
-                filename = "/tmp/pose-%s.scm" % obj.getName()
-		out = file(filename, "w")
-		export_pose(out, obj)
-		out.close()
-                print "Wrote:", filename
+for frame in xrange(1, 20):
+    Blender.Set("curframe", frame)
+    for obj in Blender.Object.Get():
+        if obj.type == "Armature":
+            filename = "/tmp/pose-%s-frame%03d.scm" % (obj.getName(), frame)
+            out = file(filename, "w")
+            export_pose(out, obj)
+            out.close()
+            print "Wrote:", filename
 
+Draw.PupMenu("Export ok")
+
 # EOF #

Modified: trunk/windstille/tools/windstille_export.py
===================================================================
--- trunk/windstille/tools/windstille_export.py	2007-06-22 00:25:15 UTC (rev 1492)
+++ trunk/windstille/tools/windstille_export.py	2007-06-22 02:22:50 UTC (rev 1493)
@@ -35,6 +35,7 @@
 
 ### TODO ###
 # - add handling of meshes with armatures, but without actions
+# - change the code to use some more MathUtil instead of its own quaternion/matrix code 
 ############
 
 import string



From grumbel at mail.berlios.de  Fri Jun 22 07:14:37 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 22 Jun 2007 07:14:37 +0200
Subject: [Windstille-commit] r1494 - trunk/windstille/tools
Message-ID: <200706220514.l5M5Ebi9001467@sheep.berlios.de>

Author: grumbel
Date: 2007-06-22 07:14:33 +0200 (Fri, 22 Jun 2007)
New Revision: 1494

Added:
   trunk/windstille/tools/mesh_export.py
   trunk/windstille/tools/model_test.blend
Modified:
   trunk/windstille/tools/bone_test.blend
Log:
- started a mesh export script to be used in combination with the skeleton stuff

Modified: trunk/windstille/tools/bone_test.blend
===================================================================
(Binary files differ)

Added: trunk/windstille/tools/mesh_export.py
===================================================================
--- trunk/windstille/tools/mesh_export.py	2007-06-22 02:22:50 UTC (rev 1493)
+++ trunk/windstille/tools/mesh_export.py	2007-06-22 05:14:33 UTC (rev 1494)
@@ -0,0 +1,40 @@
+import Blender
+from Blender import *
+
+print "---------------------------------------------------"
+
+def export_mesh(out, mesh):
+	print ""
+
+	out.write("  (vertices\n")
+	for v in mesh.verts:
+		out.write("    %f %f %f ;; %d\n" % (v.co[0], v.co[1], v.co[2], v.index))
+	out.write("   ) ;; vertices\n")
+
+	out.write("  (texcoords\n")
+	for v in mesh.verts:
+		out.write("    %f %f" % (v.uvco.x, v.uvco.y))	
+	out.write("   ) ;; texcoords\n")
+
+	out.write("  (faces\n")
+	for face in mesh.faces:	
+		out.write("    ")
+		for v in face.verts:
+			out.write("%d " % v.index)
+		out.write("\n")
+	out.write("   ) ;; faces\n")
+
+print "Windstille Mesh Exporter:"
+for mesh in Blender.Mesh.Get():
+	filename = "/tmp/mesh-%s.scm" % mesh.name
+	out = file(filename, "w")
+	print "  - exporting to '%s'..." % filename,
+ 	export_mesh(out, mesh)
+ 	out.close()
+	print "done"
+print
+
+
+# Draw.PupMenu("Export ok")
+
+# EOF #
\ No newline at end of file

Added: trunk/windstille/tools/model_test.blend
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/tools/model_test.blend
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From grumbel at mail.berlios.de  Fri Jun 22 22:00:12 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 22 Jun 2007 22:00:12 +0200
Subject: [Windstille-commit] r1495 - in trunk/windstille: src/display tools
Message-ID: <200706222000.l5MK0CNX010789@sheep.berlios.de>

Author: grumbel
Date: 2007-06-22 22:00:08 +0200 (Fri, 22 Jun 2007)
New Revision: 1495

Modified:
   trunk/windstille/src/display/vertex_array_drawing_request.cpp
   trunk/windstille/tools/bone_test.blend
   trunk/windstille/tools/mesh_export.py
   trunk/windstille/tools/model_test.blend
   trunk/windstille/tools/pose_export.py
   trunk/windstille/tools/windstille_export.py
Log:
- made mesh exporter working (untested)

Modified: trunk/windstille/src/display/vertex_array_drawing_request.cpp
===================================================================
--- trunk/windstille/src/display/vertex_array_drawing_request.cpp	2007-06-22 05:14:33 UTC (rev 1494)
+++ trunk/windstille/src/display/vertex_array_drawing_request.cpp	2007-06-22 20:00:08 UTC (rev 1495)
@@ -94,7 +94,7 @@
   state.disable_client_state(GL_NORMAL_ARRAY);
   state.enable_client_state(GL_VERTEX_ARRAY);
 
-  glVertexPointer  (3, GL_FLOAT, 0, &*vertices.begin());
+  glVertexPointer(3, GL_FLOAT, 0, &*vertices.begin());
 
   state.activate();
 

Modified: trunk/windstille/tools/bone_test.blend
===================================================================
(Binary files differ)

Modified: trunk/windstille/tools/mesh_export.py
===================================================================
--- trunk/windstille/tools/mesh_export.py	2007-06-22 05:14:33 UTC (rev 1494)
+++ trunk/windstille/tools/mesh_export.py	2007-06-22 20:00:08 UTC (rev 1495)
@@ -1,40 +1,183 @@
 import Blender
 from Blender import *
+
+class MeshData:
+    """Data structure that holds a list of faces"""
 
-print "---------------------------------------------------"
+    def __init__(self, texture_filename):
+        # Filename of the used texture
+        self.texture_filename = texture_filename
 
-def export_mesh(out, mesh):
-	print ""
+        # [FaceData, ...]
+        self.faces            = []
+
+    def add(self, face):
+        self.faces.append(face)
+
+    def finalize(self):
+        """Reorders vertex indexes and merge vertexes which have the
+        same UV coordinates, thus bringing the MeshData into a stage
+        where it is ready to be written out to file"""
 
-	out.write("  (vertices\n")
-	for v in mesh.verts:
-		out.write("    %f %f %f ;; %d\n" % (v.co[0], v.co[1], v.co[2], v.index))
-	out.write("   ) ;; vertices\n")
+        # Generate a list of uniq vertices
+        uniq_vertices = {}
+        for face in self.faces:
+            for vert in face.verts:
+                uniq_vertices[vert.key()] = vert
 
-	out.write("  (texcoords\n")
-	for v in mesh.verts:
-		out.write("    %f %f" % (v.uvco.x, v.uvco.y))	
-	out.write("   ) ;; texcoords\n")
+        # Merge duplicate vertices
+        for face in self.faces:
+            for i in xrange(0, len(face.verts)):
+                face.verts[i] = uniq_vertices[face.verts[i].key()]
 
-	out.write("  (faces\n")
-	for face in mesh.faces:	
-		out.write("    ")
-		for v in face.verts:
-			out.write("%d " % v.index)
-		out.write("\n")
-	out.write("   ) ;; faces\n")
+        # Generate new index numbering
+        self.vertices = uniq_vertices.values()
+        for i, vert in enumerate(self.vertices):
+            vert.index = i
 
-print "Windstille Mesh Exporter:"
-for mesh in Blender.Mesh.Get():
-	filename = "/tmp/mesh-%s.scm" % mesh.name
-	out = file(filename, "w")
-	print "  - exporting to '%s'..." % filename,
- 	export_mesh(out, mesh)
- 	out.close()
-	print "done"
-print
+        ## Remove '//' infront of the filename that Blender inserts there
+        self.texture_filename = self.texture_filename[2:]
+      
+class FaceData:
+    def __init__(self, verts):
+        self.verts   = verts
+
+class VertexData:
+    def __init__(self, co, uv, normal):
+        self.co        = co
+        self.uv        = uv
+        self.normal    = normal
+        self.index     = -1
 
+    def key(self):
+        return (self.co[1], self.co[2],
+                self.normal[0], self.normal[1], self.normal[2],
+                self.uv[0], self.uv[1])
+    
+
+class WindstilleModel:
+    """WindstilleMesh is used to collect data vertex and face data
+    from Blender internals and convert it to a form usable by
+    OpenGL/Windstille"""  
+
+    def __init__(self):
+        # dictionary of { "texture_filename.png" : MeshData, ... } 
+        self.mesh_data   = {}
+
+    def add(self, blender_mesh):
+        """Convert Blender data structures into something that is used by
+        this export script"""
 
+        for face in blender_mesh.faces:
+            if face.image:
+                texture_filename = face.image.filename
+            else:
+                texture_filename = "//404.png"
+            
+            if not self.mesh_data.has_key(texture_filename):
+                mesh = self.mesh_data[texture_filename] = MeshData(texture_filename)
+            else:
+                mesh = self.mesh_data[texture_filename]
+
+            if face.uv == []:
+                raise "Face doesn't have UV"
+
+            verts = []
+            for i in [0, 1, 2]:
+                verts.append(VertexData([face.v[i].co[0], face.v[i].co[1], face.v[i].co[2]],
+                                        [face.uv[i][0], 1.0 - face.uv[i][1]],
+                                        [face.v[i].no[1], -face.v[i].no[2], -face.v[i].no[0]]))
+            mesh.add(FaceData(verts))
+
+            # Write out another triangle in case we have a quad
+            if len(face.v) == 4:
+                verts = []
+                for i in [0, 2, 3]:
+                    verts.append(VertexData([face.v[i].co[0], face.v[i].co[1], face.v[i].co[2]],
+                                            [face.uv[i][0], 1.0 - face.uv[i][1]],
+                                            [face.v[i].no[1], -face.v[i].no[2], -face.v[i].no[0]]))
+                mesh.add(FaceData(verts))
+
+    def finalize(self):
+        for (texture, mesh) in self.mesh_data.iteritems():
+            mesh.finalize()
+
+    def write(self, out):
+        out.write(";; -*- scheme -*-\n")
+        out.write("(windstille-model\n")
+        out.write("  (name \"\")\n")
+    
+        for (texture, mesh) in self.mesh_data.iteritems():
+            out.write("  (mesh\n")
+            out.write("    (name \"\")\n")
+            out.write("    (texture \"%s\")\n\n" % texture)
+            out.write("    (vertices\n")
+            for v in mesh.vertices:
+                out.write("      %10f %10f %10f ;; %d\n" % (v.co[0], v.co[1], v.co[2], v.index))
+            out.write("     ) ;; vertices\n\n")
+
+            out.write("    (normals\n") 
+            for vert in mesh.vertices:
+                out.write("      %9f %9f %9f\n" % (vert.normal[0],
+                                              vert.normal[1],
+                                              vert.normal[2]))
+            out.write("     ) ;; normals\n\n")
+
+            out.write("    (texcoords\n")
+            for vert in mesh.vertices:
+                out.write("      %f %f\n" % (vert.uv[0], vert.uv[1]))
+            out.write("     ) ;; texcoords\n\n")
+
+            out.write("    (triangles\n")
+            for face in mesh.faces:
+                out.write("      %d %d %d\n" % (face.verts[0].index,
+                                                face.verts[1].index,
+                                                face.verts[2].index))
+            out.write("     ) ;; triangles\n\n")
+            out.write("   ) ;; mesh\n\n")
+        out.write(" ) ;; windstille-model\n")
+        out.write("\n;; EOF ;;\n")
+
+    def print_stats(self):
+        """Print some stats, vertex count, face count and such"""
+        print "+===================================================================="
+        print "| WindstilleSprite"
+        print "+===================================================================="
+        print "| Model:" 
+        for i, mesh in enumerate(self.mesh_data.values()):
+            print "|   Mesh:        %d/%d" % (i+1, len(self.mesh_data))
+            print "|     Texture:  ", mesh.texture_filename
+            print "|     Faces:    ", len(mesh.faces)
+            print "|     Vertices: ", len(mesh.vertices)
+            print "|"
+        print "+===================================================================="
+
+
+def export(filename):
+    model = WindstilleModel()
+
+    layers = Blender.Scene.getCurrent().Layers
+
+    for obj in Blender.Object.Get():
+        mesh = obj.getData()
+        if (type(mesh) is not Blender.Types.NMeshType) or not mesh.faces:
+            pass # ignore anything that isn't a mesh
+        elif (obj.Layers & layers) == 0:
+            print "Skipping \"%s\" because it is on an inactive layer" % obj.getName()
+        else:
+            model.add(mesh)
+
+    model.finalize()
+
+    file = open(filename, "w")
+
+    model.write(file)
+    file.close()
+
+    model.print_stats()
+
+export("/tmp/mesh.scm")
+
 # Draw.PupMenu("Export ok")
 
-# EOF #
\ No newline at end of file
+# EOF #

Modified: trunk/windstille/tools/model_test.blend
===================================================================
(Binary files differ)

Modified: trunk/windstille/tools/pose_export.py
===================================================================
--- trunk/windstille/tools/pose_export.py	2007-06-22 05:14:33 UTC (rev 1494)
+++ trunk/windstille/tools/pose_export.py	2007-06-22 20:00:08 UTC (rev 1495)
@@ -4,6 +4,9 @@
 def is_identity(quat):
     return quat.w == 1.0 and quat.x == 0.0 and quat.y == 0.0 and quat.z == 0.0
 
+def is_null_loc(loc):
+    return loc.x == 0 and loc.y == 0 and loc.z == 0
+
 def export_pose(out, obj):
     pose = obj.getPose()
 
@@ -13,12 +16,14 @@
     out.write("  (bones\n")
     for bone in pose.bones.values():
         if bone.name[:3] == "IK_":
-            out.write("    ;; ignoring '%s' due to being IK control bone\n" % bone.name)
-        elif is_identity(bone.quat):
-            out.write("    ;; ignoring '%s' due to having the identity Quaternion\n" % bone.name)        
+            out.write("    ;; ignoring '%s', IK control bone\n" % bone.name)
+        elif is_identity(bone.quat) and is_null_loc(bone.loc):
+            out.write("    ;; ignoring '%s', neutral position\n" % bone.name)        
         else: 
             out.write("    (bone\n")
             out.write("      (name \"%s\")\n" % bone.name)
+            out.write("      (loc %f %f %f)\n" %
+                      (bone.loc.x, bone.loc.y, bone.loc.z))
             out.write("      (quat %f %f %f %f))\n" % 
                       (bone.quat.w, bone.quat.x, bone.quat.y, bone.quat.z))
     out.write("   ) ;; bones\n")

Modified: trunk/windstille/tools/windstille_export.py
===================================================================
--- trunk/windstille/tools/windstille_export.py	2007-06-22 05:14:33 UTC (rev 1494)
+++ trunk/windstille/tools/windstille_export.py	2007-06-22 20:00:08 UTC (rev 1495)
@@ -52,7 +52,7 @@
 SPEED_MULTIPLIER = 9.8
 # DO NOT change this
 FORMAT_VERSION = 2
-
+
 def progress(percent, str):
 #    print "%3.2f%% - %s" % (percent*100, str)
     Window.DrawProgressBar(percent, str)
@@ -101,8 +101,7 @@
   sin_a = math.sqrt(1.0 - cos_a * cos_a)
   if(sin_a < .0005 or sin_a > .0005): sin_a = 1
   return angle, q[1]/sin_a, q[2]/sin_a, q[3]/sin_a
-
-##########################################################
+
 def get_text(textname):
   """Little shortcut function to return the content of
   Blender.Text.get(textname) as a single string and do a little error
@@ -114,7 +113,7 @@
     return ""
   else:
     return string.join(textobj.asLines(), "\n")
-
+
 ### Data Structures to hold the Mesh ###
 class MeshData:
   def __init__(self, texture_filename):
@@ -180,7 +179,7 @@
         self.uv        = uv
         self.normal    = normal
         self.new_index = -1
-
+
 class AttachmentPointData:
     """Data for an attachment point, its location and its rotation"""
     def __init__(self, loc, quat):
@@ -195,8 +194,7 @@
 
         # [AttachmentPointData, ...]
         self.attachment_points = attachment_points
-
-
+
 class ActionConfig:
     """ActionConfig handles the properties of a single
     action, ie. when it starts, when it stops, its speed, how many
@@ -283,7 +281,7 @@
 
         return actionconfig
     parse = staticmethod(parse)
-
+
 class ActionData:
   def __init__(self, name, config, frame_data):
     # name as string
@@ -296,7 +294,7 @@
     self.frame_data = frame_data
 
 ### end: Data Structures to hold the Mesh ###
-
+
 class WindstilleSprite:
   ########################################################
   def __init__(self):
@@ -406,7 +404,7 @@
     self.mesh_data = {}
     for obj in self.mesh_objects:
       ### Convert mesh_objects to MeshData and merge all meshes with
-      ### the same texture     
+      ### the same texture
       for (texture, mesh) in self.collect_mesh_data(obj).iteritems():
         if self.mesh_data.has_key(texture):
           self.mesh_data[texture].merge(mesh)
@@ -597,8 +595,7 @@
     file.close()
 
     data.print_stats()
-
-########################################################
+
 def fs_callback(filename):
     print "=== Exporting: %s ===" % (filename)
     export(filename)



From grumbel at mail.berlios.de  Fri Jun 22 23:26:11 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 22 Jun 2007 23:26:11 +0200
Subject: [Windstille-commit] r1496 - trunk/windstille/tools
Message-ID: <200706222126.l5MLQBiO016231@sheep.berlios.de>

Author: grumbel
Date: 2007-06-22 23:26:10 +0200 (Fri, 22 Jun 2007)
New Revision: 1496

Modified:
   trunk/windstille/tools/mesh_export.py
Log:
- added influence export to the mesh exporter

Modified: trunk/windstille/tools/mesh_export.py
===================================================================
--- trunk/windstille/tools/mesh_export.py	2007-06-22 20:00:08 UTC (rev 1495)
+++ trunk/windstille/tools/mesh_export.py	2007-06-22 21:26:10 UTC (rev 1496)
@@ -9,11 +9,27 @@
         self.texture_filename = texture_filename
 
         # [FaceData, ...]
-        self.faces            = []
+        self.faces    = []
+
+        # [VerticeData, ...]
+        self.vertices = []
+
+        # { orig_index : VerticeData, ... }
+        self.vertmap = {}
 
     def add(self, face):
         self.faces.append(face)
+        
+        for vert in face.verts:
+            self.vertmap[vert.orig_idx] = vert
 
+    def add_influences(self, orig_idx, influences):
+        if not self.vertmap.has_key(orig_idx):
+            pass # this is normal due to MeshData not being a complete
+                 # Blender mesh when multiple textures are in play       
+        else:
+            self.vertmap[orig_idx].influences = influences
+
     def finalize(self):
         """Reorders vertex indexes and merge vertexes which have the
         same UV coordinates, thus bringing the MeshData into a stage
@@ -43,11 +59,13 @@
         self.verts   = verts
 
 class VertexData:
-    def __init__(self, co, uv, normal):
-        self.co        = co
-        self.uv        = uv
-        self.normal    = normal
-        self.index     = -1
+    def __init__(self, orig_idx, co, uv, normal):
+        self.orig_idx   = orig_idx
+        self.co         = co
+        self.uv         = uv
+        self.normal     = normal
+        self.index      = -1
+        self.influences = []
 
     def key(self):
         return (self.co[1], self.co[2],
@@ -67,7 +85,8 @@
     def add(self, blender_mesh):
         """Convert Blender data structures into something that is used by
         this export script"""
-
+        
+        # Convert blender meshes to MeshData
         for face in blender_mesh.faces:
             if face.image:
                 texture_filename = face.image.filename
@@ -84,7 +103,8 @@
 
             verts = []
             for i in [0, 1, 2]:
-                verts.append(VertexData([face.v[i].co[0], face.v[i].co[1], face.v[i].co[2]],
+                verts.append(VertexData(face.v[i].index,
+                                        [face.v[i].co[0], face.v[i].co[1], face.v[i].co[2]],
                                         [face.uv[i][0], 1.0 - face.uv[i][1]],
                                         [face.v[i].no[1], -face.v[i].no[2], -face.v[i].no[0]]))
             mesh.add(FaceData(verts))
@@ -93,10 +113,16 @@
             if len(face.v) == 4:
                 verts = []
                 for i in [0, 2, 3]:
-                    verts.append(VertexData([face.v[i].co[0], face.v[i].co[1], face.v[i].co[2]],
+                    verts.append(VertexData(face.v[i].index,
+                                            [face.v[i].co[0], face.v[i].co[1], face.v[i].co[2]],
                                             [face.uv[i][0], 1.0 - face.uv[i][1]],
                                             [face.v[i].no[1], -face.v[i].no[2], -face.v[i].no[0]]))
                 mesh.add(FaceData(verts))
+
+        for mesh in self.mesh_data.values():
+            for vert in blender_mesh.verts:
+                mesh.add_influences(vert.index, blender_mesh.getVertexInfluences(vert.index))
+
 
     def finalize(self):
         for (texture, mesh) in self.mesh_data.iteritems():
@@ -134,6 +160,18 @@
                                                 face.verts[1].index,
                                                 face.verts[2].index))
             out.write("     ) ;; triangles\n\n")
+
+            out.write("    (influences\n")
+            for vert in mesh.vertices:
+                if vert.influences != []:
+                    out.write("      (vertex\n")
+                    out.write("        (index %d)\n" % vert.index)
+                    out.write("        (influeces\n")
+                    for (bone, weight) in vert.influences:
+                        out.write("          (influence (weigth %f) (bone \"%s\"))\n" % (weight, bone))
+                    out.write("         )) ;; vertex\n")
+            out.write("     ) ;; influencs\n\n")
+            
             out.write("   ) ;; mesh\n\n")
         out.write(" ) ;; windstille-model\n")
         out.write("\n;; EOF ;;\n")



From grumbel at mail.berlios.de  Fri Jun 22 23:31:06 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Fri, 22 Jun 2007 23:31:06 +0200
Subject: [Windstille-commit] r1497 - trunk/windstille/tools
Message-ID: <200706222131.l5MLV6Gp016559@sheep.berlios.de>

Author: grumbel
Date: 2007-06-22 23:31:06 +0200 (Fri, 22 Jun 2007)
New Revision: 1497

Modified:
   trunk/windstille/tools/mesh_export.py
Log:
- fixed texture_filename export

Modified: trunk/windstille/tools/mesh_export.py
===================================================================
--- trunk/windstille/tools/mesh_export.py	2007-06-22 21:26:10 UTC (rev 1496)
+++ trunk/windstille/tools/mesh_export.py	2007-06-22 21:31:06 UTC (rev 1497)
@@ -133,10 +133,10 @@
         out.write("(windstille-model\n")
         out.write("  (name \"\")\n")
     
-        for (texture, mesh) in self.mesh_data.iteritems():
+        for mesh in self.mesh_data.values():
             out.write("  (mesh\n")
             out.write("    (name \"\")\n")
-            out.write("    (texture \"%s\")\n\n" % texture)
+            out.write("    (texture \"%s\")\n\n" % mesh.texture_filename)
             out.write("    (vertices\n")
             for v in mesh.vertices:
                 out.write("      %10f %10f %10f ;; %d\n" % (v.co[0], v.co[1], v.co[2], v.index))
@@ -166,10 +166,10 @@
                 if vert.influences != []:
                     out.write("      (vertex\n")
                     out.write("        (index %d)\n" % vert.index)
-                    out.write("        (influeces\n")
+                    out.write("        (influeces")
                     for (bone, weight) in vert.influences:
-                        out.write("          (influence (weigth %f) (bone \"%s\"))\n" % (weight, bone))
-                    out.write("         )) ;; vertex\n")
+                        out.write("\n          (influence (weigth %f) (bone \"%s\"))" % (weight, bone))
+                    out.write("))\n")
             out.write("     ) ;; influencs\n\n")
             
             out.write("   ) ;; mesh\n\n")



From grumbel at mail.berlios.de  Sat Jun 23 01:54:21 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 23 Jun 2007 01:54:21 +0200
Subject: [Windstille-commit] r1498 - in trunk/windstille: src src/armature
	tools
Message-ID: <200706222354.l5MNsLxX006341@sheep.berlios.de>

Author: grumbel
Date: 2007-06-23 01:54:19 +0200 (Sat, 23 Jun 2007)
New Revision: 1498

Added:
   trunk/windstille/src/armature/mesh.cpp
   trunk/windstille/src/armature/mesh.hpp
   trunk/windstille/src/armature/model.cpp
   trunk/windstille/src/armature/model.hpp
Modified:
   trunk/windstille/src/SConscript
   trunk/windstille/tools/mesh_export.py
Log:
- mesh/model loading code (untested)

Modified: trunk/windstille/src/SConscript
===================================================================
--- trunk/windstille/src/SConscript	2007-06-22 21:31:06 UTC (rev 1497)
+++ trunk/windstille/src/SConscript	2007-06-22 23:54:19 UTC (rev 1498)
@@ -44,6 +44,8 @@
 env.Program('../windstille', [
 'armature_test.cpp',
 'armature/armature.cpp',
+'armature/mesh.cpp',
+'armature/model.cpp',
 'armature/pose.cpp',
 'armature/bone.cpp',
 'baby_xml.cpp',

Added: trunk/windstille/src/armature/mesh.cpp
===================================================================
--- trunk/windstille/src/armature/mesh.cpp	2007-06-22 21:31:06 UTC (rev 1497)
+++ trunk/windstille/src/armature/mesh.cpp	2007-06-22 23:54:19 UTC (rev 1498)
@@ -0,0 +1,91 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include <assert.h>
+#include "util.hpp"
+#include "display/opengl_state.hpp"
+#include <stdexcept>
+#include "file_reader.hpp"
+#include "mesh.hpp"
+
+Mesh::Mesh(FileReader& reader)
+  : blend_sfactor(GL_ONE),
+    blend_dfactor(GL_ZERO)
+{
+  if (reader.get_name() != "mesh")
+    throw std::runtime_error("Not a 'mesh' type, its '" + reader.get_name() + "'");
+  
+  reader.get("name",      name);
+  reader.get("vertices",  vertices);
+  reader.get("normals",   normals);
+  reader.get("texcoords", texcoords);
+  reader.get("triangles", triangles);
+  
+  // FIXME: add 'influences' tag parsing
+
+  // Check that all vectors have the same right modulo
+  assert(vertices.size()  % 3 == 0);
+  assert(normals.size()   % 3 == 0);
+  assert(texcoords.size() % 2 == 0);
+
+  // Check that all vectors contain enough values for the given number
+  // of vertices
+  assert(vertices.size()/3 == normals.size()/3);
+  assert(vertices.size()/3 == texcoords.size()/2);
+}
+
+Mesh::~Mesh()
+{
+  
+}
+
+void
+Mesh::draw()
+{
+  OpenGLState state;
+
+  if (blend_sfactor != GL_ONE || blend_dfactor != GL_ZERO)
+    {
+      state.enable(GL_BLEND);
+      state.set_blend_func(blend_sfactor, blend_dfactor);
+    }
+  else
+    {
+      state.enable(GL_DEPTH_TEST);
+    }
+
+  state.enable_client_state(GL_VERTEX_ARRAY);
+  state.enable_client_state(GL_NORMAL_ARRAY);
+  state.enable_client_state(GL_TEXTURE_COORD_ARRAY);  
+
+  assert_gl("gl init before sprite");
+
+  glVertexPointer(3, GL_FLOAT, 0, &*vertices.begin());
+  glNormalPointer(GL_FLOAT, 0, &*normals.begin());
+  glTexCoordPointer(2, GL_FLOAT, 0, &*texcoords.begin());
+  glDrawElements(GL_TRIANGLES, triangles.size(), GL_INT, &*triangles.begin());
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/armature/mesh.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/armature/mesh.hpp
===================================================================
--- trunk/windstille/src/armature/mesh.hpp	2007-06-22 21:31:06 UTC (rev 1497)
+++ trunk/windstille/src/armature/mesh.hpp	2007-06-22 23:54:19 UTC (rev 1498)
@@ -0,0 +1,62 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_MESH_HPP
+#define HEADER_MESH_HPP
+
+#include <GL/glew.h>
+#include <GL/gl.h>
+#include <string>
+#include <vector>
+
+class FileReader;
+
+/** */
+class Mesh
+{
+private:
+  std::string name;
+
+  std::vector<float> vertices;
+  std::vector<float> normals;
+  std::vector<float> texcoords;
+  std::vector<int>   triangles;
+
+  GLenum blend_sfactor;
+  GLenum blend_dfactor;
+
+public:
+  Mesh(FileReader& reader);
+  ~Mesh();
+
+  void draw();
+private:
+  Mesh (const Mesh&);
+  Mesh& operator= (const Mesh&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/armature/mesh.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/armature/model.cpp
===================================================================
--- trunk/windstille/src/armature/model.cpp	2007-06-22 21:31:06 UTC (rev 1497)
+++ trunk/windstille/src/armature/model.cpp	2007-06-22 23:54:19 UTC (rev 1498)
@@ -0,0 +1,57 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include "file_reader.hpp"
+#include "mesh.hpp"
+#include "model.hpp"
+
+Model::Model(FileReader& reader)
+{
+  reader.get("name", name);
+
+  std::vector<FileReader> sections = reader.get_sections();
+  for(std::vector<FileReader>::iterator i = sections.begin(); i != sections.end(); ++i)
+    {
+      Mesh* mesh = new Mesh(*i);
+      meshes.push_back(mesh);
+    }
+}
+
+Model::~Model()
+{
+  for(Meshes::iterator i = meshes.begin(); i != meshes.end(); ++i)
+    delete *i;
+}
+
+void
+Model::draw()
+{
+  for(Meshes::iterator i = meshes.begin(); i != meshes.end(); ++i)
+    {
+      (*i)->draw();
+    }
+}
+
+/* EOF */


Property changes on: trunk/windstille/src/armature/model.cpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Added: trunk/windstille/src/armature/model.hpp
===================================================================
--- trunk/windstille/src/armature/model.hpp	2007-06-22 21:31:06 UTC (rev 1497)
+++ trunk/windstille/src/armature/model.hpp	2007-06-22 23:54:19 UTC (rev 1498)
@@ -0,0 +1,55 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  > |__| |__|____/____/\___  >
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke <grumbel at gmx.de>
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_MODEL_HPP
+#define HEADER_MODEL_HPP
+
+#include <string>
+#include <vector>
+
+class FileReader;
+class Mesh;
+
+/** */
+class Model
+{
+private:
+  std::string name;
+  typedef std::vector<Mesh*> Meshes;
+  Meshes meshes;
+
+public:
+  Model(FileReader& reader);
+  ~Model();
+
+  void draw();
+private:
+  Model (const Model&);
+  Model& operator= (const Model&);
+};
+
+#endif
+
+/* EOF */


Property changes on: trunk/windstille/src/armature/model.hpp
___________________________________________________________________
Name: svn:keywords
   + Id
Name: svn:eol-style
   + native

Modified: trunk/windstille/tools/mesh_export.py
===================================================================
--- trunk/windstille/tools/mesh_export.py	2007-06-22 21:31:06 UTC (rev 1497)
+++ trunk/windstille/tools/mesh_export.py	2007-06-22 23:54:19 UTC (rev 1498)
@@ -168,7 +168,7 @@
                     out.write("        (index %d)\n" % vert.index)
                     out.write("        (influeces")
                     for (bone, weight) in vert.influences:
-                        out.write("\n          (influence (weigth %f) (bone \"%s\"))" % (weight, bone))
+                        out.write("\n          (influence (weight %f) (bone \"%s\"))" % (weight, bone))
                     out.write("))\n")
             out.write("     ) ;; influencs\n\n")
             



From grumbel at mail.berlios.de  Sat Jun 23 02:31:15 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 23 Jun 2007 02:31:15 +0200
Subject: [Windstille-commit] r1499 - in trunk/windstille: src src/armature
	tools
Message-ID: <200706230031.l5N0VFmp012607@sheep.berlios.de>

Author: grumbel
Date: 2007-06-23 02:31:11 +0200 (Sat, 23 Jun 2007)
New Revision: 1499

Modified:
   trunk/windstille/src/armature/mesh.cpp
   trunk/windstille/src/armature/model.cpp
   trunk/windstille/src/armature_test.cpp
   trunk/windstille/src/armature_test.hpp
   trunk/windstille/tools/model_test.blend
Log:
 added some code to test mesh drawing (not working yet)

Modified: trunk/windstille/src/armature/mesh.cpp
===================================================================
--- trunk/windstille/src/armature/mesh.cpp	2007-06-22 23:54:19 UTC (rev 1498)
+++ trunk/windstille/src/armature/mesh.cpp	2007-06-23 00:31:11 UTC (rev 1499)
@@ -24,9 +24,10 @@
 */
 
 #include <assert.h>
+#include <stdexcept>
+#include <iostream>
 #include "util.hpp"
 #include "display/opengl_state.hpp"
-#include <stdexcept>
 #include "file_reader.hpp"
 #include "mesh.hpp"
 
@@ -54,6 +55,11 @@
   // of vertices
   assert(vertices.size()/3 == normals.size()/3);
   assert(vertices.size()/3 == texcoords.size()/2);
+
+  std::cout << "Number of normals:   " << normals.size()   << std::endl;
+  std::cout << "Number of texcoords: " << texcoords.size() << std::endl;
+  std::cout << "Number of vertices:  " << vertices.size()  << std::endl;
+  std::cout << "Number of triangles: " << triangles.size() << std::endl;
 }
 
 Mesh::~Mesh()
@@ -64,6 +70,7 @@
 void
 Mesh::draw()
 {
+  std::cout << "Mesh: Drawing: " << vertices.size() << std::endl;
   OpenGLState state;
 
   if (blend_sfactor != GL_ONE || blend_dfactor != GL_ZERO)
@@ -75,17 +82,28 @@
     {
       state.enable(GL_DEPTH_TEST);
     }
+  
+  glLineWidth(1.0f);
+  glColor4f(1.0f, 1.0f, 1.0f, 0.5f);
+  //state.enable_client_state(GL_VERTEX_ARRAY);
+  //state.enable_client_state(GL_NORMAL_ARRAY);
+  //state.enable_client_state(GL_TEXTURE_COORD_ARRAY);  
+  state.activate();
 
-  state.enable_client_state(GL_VERTEX_ARRAY);
-  state.enable_client_state(GL_NORMAL_ARRAY);
-  state.enable_client_state(GL_TEXTURE_COORD_ARRAY);  
-
   assert_gl("gl init before sprite");
 
-  glVertexPointer(3, GL_FLOAT, 0, &*vertices.begin());
-  glNormalPointer(GL_FLOAT, 0, &*normals.begin());
-  glTexCoordPointer(2, GL_FLOAT, 0, &*texcoords.begin());
-  glDrawElements(GL_TRIANGLES, triangles.size(), GL_INT, &*triangles.begin());
+  //  glVertexPointer(3, GL_FLOAT, 0, &*vertices.begin());
+  //glNormalPointer(GL_FLOAT, 0, &*normals.begin());
+  //glTexCoordPointer(2, GL_FLOAT, 0, &*texcoords.begin());
+  //glDrawElements(GL_LINE_STRIP, triangles.size(), GL_INT, &*triangles.begin());
+  glBegin(GL_TRIANGLES);
+  for(int i = 0; i < int(triangles.size()); i += 3)
+    {
+      glVertex3f(vertices[i+0], 
+                 vertices[i+1],
+                 vertices[i+2]);
+    }
+  glEnd();
 }
 
 /* EOF */

Modified: trunk/windstille/src/armature/model.cpp
===================================================================
--- trunk/windstille/src/armature/model.cpp	2007-06-22 23:54:19 UTC (rev 1498)
+++ trunk/windstille/src/armature/model.cpp	2007-06-23 00:31:11 UTC (rev 1499)
@@ -23,19 +23,31 @@
 **  02111-1307, USA.
 */
 
+#include <iostream>
+#include <stdexcept>
 #include "file_reader.hpp"
 #include "mesh.hpp"
 #include "model.hpp"
 
 Model::Model(FileReader& reader)
 {
+  if (reader.get_name() != "windstille-model")
+    throw std::runtime_error("Not a 'windstille-model' file, its '" + reader.get_name() + "'");
+
   reader.get("name", name);
 
   std::vector<FileReader> sections = reader.get_sections();
   for(std::vector<FileReader>::iterator i = sections.begin(); i != sections.end(); ++i)
     {
-      Mesh* mesh = new Mesh(*i);
-      meshes.push_back(mesh);
+      if (i->get_name() == "mesh")
+        {
+          Mesh* mesh = new Mesh(*i);
+          meshes.push_back(mesh);
+        }
+      else
+        {
+          std::cout << "Ignoring unhandled tag: " << i->get_name() << std::endl;
+        }
     }
 }
 

Modified: trunk/windstille/src/armature_test.cpp
===================================================================
--- trunk/windstille/src/armature_test.cpp	2007-06-22 23:54:19 UTC (rev 1498)
+++ trunk/windstille/src/armature_test.cpp	2007-06-23 00:31:11 UTC (rev 1499)
@@ -32,10 +32,14 @@
 #include "screen_manager.hpp"
 #include "display/display.hpp"
 #include "armature/pose.hpp"
+#include "armature/model.hpp"
 #include "armature_test.hpp"
 
 ArmatureTest::ArmatureTest()
 {
+  FileReader model_reader = FileReader::parse("armature/mesh.mesh");
+  model = new Model(model_reader);
+
   FileReader armature_reader = FileReader::parse("armature/armature.arm");
   armature = new Armature(armature_reader);
 
@@ -79,6 +83,8 @@
 
   armature->draw();
 
+  model->draw();
+
   glPopMatrix();
 
   // std::cout << xrot << " " << yrot << std::endl;

Modified: trunk/windstille/src/armature_test.hpp
===================================================================
--- trunk/windstille/src/armature_test.hpp	2007-06-22 23:54:19 UTC (rev 1498)
+++ trunk/windstille/src/armature_test.hpp	2007-06-23 00:31:11 UTC (rev 1499)
@@ -27,12 +27,14 @@
 #define HEADER_ARMATURE_TEST_HPP
 
 #include "armature/armature.hpp"
+#include "armature/model.hpp"
 #include "screen.hpp"
 
 /** */
 class ArmatureTest : public Screen
 {
 private:
+  Model* model;
   Armature* armature;
   std::vector<Pose*> poses;
   

Modified: trunk/windstille/tools/model_test.blend
===================================================================
(Binary files differ)



From grumbel at mail.berlios.de  Sat Jun 23 04:35:11 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 23 Jun 2007 04:35:11 +0200
Subject: [Windstille-commit] r1500 - in trunk/windstille: data/armature src
	src/armature tools
Message-ID: <200706230235.l5N2ZBF3019281@sheep.berlios.de>

Author: grumbel
Date: 2007-06-23 04:35:07 +0200 (Sat, 23 Jun 2007)
New Revision: 1500

Added:
   trunk/windstille/data/armature/mesh.mesh
   trunk/windstille/data/armature/powersuittexture.png
Modified:
   trunk/windstille/src/armature/mesh.cpp
   trunk/windstille/src/armature/mesh.hpp
   trunk/windstille/src/armature_test.cpp
   trunk/windstille/tools/mesh_export.py
Log:
- fixed model load and display

Added: trunk/windstille/data/armature/mesh.mesh
===================================================================
--- trunk/windstille/data/armature/mesh.mesh	2007-06-23 00:31:11 UTC (rev 1499)
+++ trunk/windstille/data/armature/mesh.mesh	2007-06-23 02:35:07 UTC (rev 1500)
@@ -0,0 +1,6175 @@
+;; -*- scheme -*-
+(windstille-model
+  (name "")
+  (mesh
+    (name "")
+    (texture "armature/powersuittexture.png")
+
+    (vertices
+        0.991082   0.183809   0.297031 ;; 0
+       -0.213938  -0.370557  -0.546021 ;; 1
+        0.176633  -0.003543  -1.474674 ;; 2
+       -0.325454  -0.112389  -2.580805 ;; 3
+       -0.000117   0.124363   0.716293 ;; 4
+       -0.079640  -0.347091  -0.747023 ;; 5
+        0.014988   0.015320  -0.872209 ;; 6
+        0.543572  -0.112081  -2.239584 ;; 7
+        0.236938  -0.213920   0.601996 ;; 8
+        0.548741  -0.230433  -1.470031 ;; 9
+        0.404882  -0.175349  -2.376508 ;; 10
+        0.469622  -0.299058  -1.036510 ;; 11
+       -0.330819  -0.194766  -0.296250 ;; 12
+       -0.386858   0.028411  -0.375533 ;; 13
+        1.724493   0.042835   0.378634 ;; 14
+       -0.068086  -0.130962  -0.871460 ;; 15
+       -0.342637  -0.112082  -2.239584 ;; 16
+       -0.250232  -0.311273   0.049379 ;; 17
+        0.302798  -0.406601  -2.657734 ;; 18
+        0.343323  -0.281008  -2.490092 ;; 19
+        1.578010  -0.241931   0.264843 ;; 20
+       -0.554648   0.022792  -1.494555 ;; 21
+        0.432994   0.253283   0.349726 ;; 22
+        0.611789  -0.406601  -2.580805 ;; 23
+        0.749328  -0.235119   0.298182 ;; 24
+        0.015887  -0.285396  -1.036405 ;; 25
+       -0.219121  -0.196914   0.906318 ;; 26
+       -1.307463  -0.140618   0.281020 ;; 27
+       -0.375952   0.183340  -2.580805 ;; 28
+       -1.591672  -0.142608   0.305261 ;; 29
+       -1.333868   0.085693   0.280632 ;; 30
+       -0.223624   0.455001   0.212811 ;; 31
+        0.392635   0.154621  -2.239584 ;; 32
+       -1.723113   0.042834   0.305672 ;; 33
+        1.016323  -0.170440   0.334845 ;; 34
+        0.340292  -0.510440  -2.657734 ;; 35
+       -0.223624   0.432698   0.725390 ;; 36
+        0.189632  -0.294946   0.893263 ;; 37
+       -0.001698   0.088099  -0.296566 ;; 38
+        1.139702   0.098194   0.241037 ;; 39
+       -0.554648   0.022792  -1.494555 ;; 40
+       -0.097111  -0.392621   0.881072 ;; 41
+       -0.458755  -0.192209   0.589549 ;; 42
+       -0.768311  -0.177569   0.271714 ;; 43
+        0.301856   0.209797  -1.738257 ;; 44
+        1.585673   0.066442   0.305261 ;; 45
+        0.000196   0.455001   0.563486 ;; 46
+       -0.372635  -0.226958  -0.376024 ;; 47
+        0.518301   0.183340  -2.657734 ;; 48
+        0.329345   0.256358   0.684079 ;; 49
+        0.202524  -0.115309   0.991398 ;; 50
+        0.404882  -0.175349  -2.376508 ;; 51
+       -0.115790   0.101056   0.621000 ;; 52
+       -1.875103   0.011151   0.340744 ;; 53
+        0.705515  -0.241841   0.534120 ;; 54
+        0.275810  -0.335526  -0.296344 ;; 55
+       -0.156925   0.082376  -0.277381 ;; 56
+        0.093699   0.163834   0.872885 ;; 57
+        0.142148  -0.249144   1.164897 ;; 58
+       -0.325453   0.106697  -2.657734 ;; 59
+        1.403575  -0.144055   0.293894 ;; 60
+       -0.517855  -0.282461  -2.440612 ;; 61
+        0.319454  -0.112389  -2.657734 ;; 62
+        0.330660  -0.194766  -0.296250 ;; 63
+       -0.866903  -0.188340   0.323266 ;; 64
+       -0.250013   0.097354  -1.474261 ;; 65
+        0.241995   0.257910   0.208687 ;; 66
+        0.270667  -0.101848   0.624940 ;; 67
+        0.339516   0.081069  -2.239584 ;; 68
+       -0.287437  -0.169043   0.816981 ;; 69
+       -0.004703   0.185714   0.865374 ;; 70
+       -0.370355  -0.130197   0.215585 ;; 71
+        0.549442   0.022792  -1.494555 ;; 72
+        0.339190   0.196053   0.406372 ;; 73
+       -0.075297   0.142900   0.771553 ;; 74
+        0.202719   0.047158   1.152124 ;; 75
+        0.541374  -0.510440  -2.657734 ;; 76
+        0.274789  -0.020381   0.582863 ;; 77
+        0.404882  -0.175349  -2.239584 ;; 78
+       -0.600401  -0.112389  -2.657734 ;; 79
+        0.225192   0.455001   0.212811 ;; 80
+       -0.864548  -0.133461   0.299112 ;; 81
+        0.491985   0.154621  -2.239584 ;; 82
+        0.370196  -0.130197   0.215585 ;; 83
+        0.198826  -0.091096   0.901390 ;; 84
+        0.372362  -0.270258   0.269407 ;; 85
+        0.218047  -0.009455   0.707039 ;; 86
+       -1.027619  -0.126922   0.315253 ;; 87
+       -0.338822   0.038513  -2.150817 ;; 88
+       -0.325453  -0.112389  -2.657734 ;; 89
+        0.199475   0.168859   0.934908 ;; 90
+       -0.276758  -0.101848   0.624940 ;; 91
+       -0.293591   0.081849   0.672687 ;; 92
+        0.380699   0.105234  -2.150436 ;; 93
+        0.197719   0.339094   0.832408 ;; 94
+        0.061590   0.017896  -0.846083 ;; 95
+       -0.167059  -0.228087   0.686729 ;; 96
+       -0.243029  -0.213920   0.601996 ;; 97
+       -0.004703  -0.389118   0.959097 ;; 98
+        0.084763   0.351249   0.810637 ;; 99
+       -0.867569  -0.135583   0.507773 ;; 100
+       -0.318085   0.049646   0.563822 ;; 101
+        0.094483  -0.457038   0.803349 ;; 102
+       -0.000155   0.259903   0.548652 ;; 103
+        0.268620  -0.065801   0.874451 ;; 104
+       -0.001777  -0.371379  -0.296539 ;; 105
+        1.390205   0.027968   0.327090 ;; 106
+       -0.000103  -0.273557   0.606713 ;; 107
+        0.672072  -0.248970   0.617540 ;; 108
+       -0.340665  -0.135798  -1.703386 ;; 109
+        0.511856  -0.282461  -2.440612 ;; 110
+        1.390206  -0.132967   0.327244 ;; 111
+       -0.526085  -0.466102  -2.490092 ;; 112
+        1.005974   0.186657   0.478340 ;; 113
+       -0.427379  -0.138177  -2.376924 ;; 114
+       -0.320260   0.113865   0.046509 ;; 115
+       -1.031477  -0.168690   0.446304 ;; 116
+        0.381790  -0.282461  -2.440612 ;; 117
+       -0.668420   0.241421   0.368433 ;; 118
+       -0.391904  -0.161620  -2.149219 ;; 119
+        0.672072  -0.292604   0.368433 ;; 120
+       -0.547373  -0.510440  -2.580805 ;; 121
+       -1.869160   0.011151   0.281993 ;; 122
+       -0.258290   0.159751   0.575604 ;; 123
+       -1.113093  -0.161996   0.321012 ;; 124
+       -0.367136   0.196053   0.563264 ;; 125
+       -0.346291  -0.510440  -2.657734 ;; 126
+       -1.170110   0.098164   0.518664 ;; 127
+       -0.004703  -0.325254   0.654436 ;; 128
+       -1.396647  -0.120398   0.403038 ;; 129
+        0.392635   0.154621  -2.376508 ;; 130
+        0.497633   0.157800  -2.490092 ;; 131
+       -0.004703  -0.419379   1.046560 ;; 132
+       -1.450377   0.048735   0.306485 ;; 133
+       -0.196321  -0.115531   0.671183 ;; 134
+       -0.069630  -0.372340   1.114703 ;; 135
+        0.542578   0.030428  -2.378750 ;; 136
+       -0.036563  -0.255421   0.651047 ;; 137
+       -1.353158   0.084491   0.446475 ;; 138
+       -0.004703  -0.406258   0.976967 ;; 139
+       -1.333868   0.085693   0.280632 ;; 140
+       -0.423905  -0.135507  -1.703337 ;; 141
+       -1.685515  -0.249800   0.255279 ;; 142
+        0.274352   0.286391   0.778669 ;; 143
+       -1.723112  -0.147854   0.305672 ;; 144
+       -0.206124  -0.054179   0.757241 ;; 145
+       -0.000089  -0.382869   0.128751 ;; 146
+        1.454924   0.047482   0.421278 ;; 147
+        0.228299  -0.018768   0.712533 ;; 148
+       -0.151517   0.144303   1.117140 ;; 149
+       -0.214730  -0.307435  -1.611132 ;; 150
+       -1.052726  -0.146912   0.296241 ;; 151
+        0.178439  -0.230433  -1.492275 ;; 152
+       -0.275678  -0.001283   1.087063 ;; 153
+        0.350305   0.095329  -2.490092 ;; 154
+       -0.205466   0.232441   0.047762 ;; 155
+       -0.295620   0.152794  -1.576903 ;; 156
+       -1.145701   0.098194   0.241037 ;; 157
+       -0.119968  -0.401947   0.977689 ;; 158
+       -0.716079  -0.187741   0.564994 ;; 159
+       -1.067502   0.137019   0.538971 ;; 160
+        1.444378  -0.169492   0.306486 ;; 161
+       -0.325453   0.106697  -2.657734 ;; 162
+       -0.083195   0.351249   0.810637 ;; 163
+        0.361553   0.199311   0.199064 ;; 164
+        0.333616   0.038513  -2.150817 ;; 165
+       -0.337622   0.196053   0.406372 ;; 166
+        1.060490  -0.197056   0.455681 ;; 167
+        0.861570  -0.135583   0.507773 ;; 168
+        0.510788  -0.073754  -2.151605 ;; 169
+        0.189632  -0.294946   0.893263 ;; 170
+        0.081616  -0.426170   0.690404 ;; 171
+        0.290415   0.152794  -1.576903 ;; 172
+       -0.482458  -0.175349  -2.376508 ;; 173
+        0.493773   0.013403  -1.035692 ;; 174
+       -1.591672  -0.142608   0.305261 ;; 175
+       -0.600401  -0.112389  -2.580805 ;; 176
+        0.294506  -0.256905   0.066449 ;; 177
+       -0.320846  -0.208900   0.385204 ;; 178
+        1.390205   0.027968   0.327090 ;; 179
+       -0.499843   0.013403  -1.035692 ;; 180
+        0.125243  -0.371379  -0.296442 ;; 181
+        0.326237  -0.392562  -0.730315 ;; 182
+       -0.262461  -0.100834   0.566538 ;; 183
+        0.449107   0.108856   0.268487 ;; 184
+        0.465476   0.008962  -1.703220 ;; 185
+       -0.177611  -0.005072   0.723684 ;; 186
+        0.301856   0.209797  -1.738257 ;; 187
+       -0.180476  -0.321333  -0.161438 ;; 188
+        0.863240   0.175831   0.323140 ;; 189
+        0.340292  -0.510440  -2.580805 ;; 190
+        0.226279  -0.211849   0.886254 ;; 191
+        0.312086   0.049646   0.563822 ;; 192
+       -0.551103   0.081069  -2.239584 ;; 193
+       -0.429342  -0.304467   0.349726 ;; 194
+        0.369953   0.183340  -2.657734 ;; 195
+       -0.308797  -0.406601  -2.657734 ;; 196
+       -0.003079  -0.303112   0.675664 ;; 197
+        0.377259  -0.093852   0.446799 ;; 198
+        0.859660  -0.188788   0.479190 ;; 199
+        1.679516  -0.249800   0.255280 ;; 200
+        0.369953   0.183340  -2.657734 ;; 201
+       -0.586974  -0.202933  -1.793326 ;; 202
+        0.543572  -0.112081  -2.239584 ;; 203
+        0.324666   0.011741  -0.296154 ;; 204
+       -0.104584  -0.384723   0.959686 ;; 205
+        0.371963  -0.265407   0.420989 ;; 206
+       -0.302142  -0.082642  -1.703470 ;; 207
+        1.156139   0.166043   0.274364 ;; 208
+       -0.004703  -0.178471   1.230875 ;; 209
+        0.367602   0.068540  -1.036392 ;; 210
+        0.233465  -0.011509   1.138145 ;; 211
+        1.444378  -0.169492   0.306486 ;; 212
+        0.724273   0.191328   0.292086 ;; 213
+        0.491985   0.154621  -2.239584 ;; 214
+       -0.077600  -0.184995   0.655160 ;; 215
+       -0.345515   0.081069  -2.239584 ;; 216
+        1.156139   0.166043   0.274364 ;; 217
+        0.330660  -0.194766  -0.296250 ;; 218
+       -0.004703   0.207264   0.952920 ;; 219
+        0.339516   0.081069  -2.376508 ;; 220
+       -0.755327  -0.235119   0.298182 ;; 221
+       -0.377102  -0.466102  -2.490092 ;; 222
+        0.354008   0.121975   0.674038 ;; 223
+       -1.066489  -0.197056   0.455681 ;; 224
+        1.106566  -0.122240   0.299157 ;; 225
+        0.276829  -0.363609   0.427038 ;; 226
+        1.033955   0.141180   0.235471 ;; 227
+       -0.263204  -0.294027  -1.748076 ;; 228
+       -0.387789  -0.282461  -2.440612 ;; 229
+        0.220493  -0.129756   1.139826 ;; 230
+        0.446740   0.172566   0.553271 ;; 231
+       -0.982968   0.119644   0.267077 ;; 232
+       -0.464411  -0.161620  -2.149632 ;; 233
+       -0.261641   0.101724  -0.443544 ;; 234
+       -0.743215   0.138849   0.265589 ;; 235
+       -0.229800   0.071884   0.735994 ;; 236
+       -1.584427  -0.241931   0.336434 ;; 237
+        0.073571  -0.347091  -0.747023 ;; 238
+       -0.617788  -0.317595  -2.657734 ;; 239
+       -0.867431   0.126253   0.298920 ;; 240
+        0.194022   0.084994  -1.750749 ;; 241
+        0.710080  -0.187741   0.564994 ;; 242
+       -0.431642   0.093489  -1.474181 ;; 243
+       -0.553946  -0.230433  -1.470031 ;; 244
+       -0.158841  -0.220130   0.676210 ;; 245
+       -0.316902   0.048431   0.361420 ;; 246
+        1.679516  -0.249800   0.255280 ;; 247
+        0.454220  -0.254343   0.299324 ;; 248
+       -1.869160  -0.142400   0.281993 ;; 249
+        0.449107  -0.190632   0.268487 ;; 250
+       -0.668420  -0.292604   0.368433 ;; 251
+       -0.006324  -0.251503   0.588245 ;; 252
+        0.372214  -0.063284  -2.379229 ;; 253
+        0.737216   0.138849   0.265589 ;; 254
+       -0.668420   0.197787   0.617540 ;; 255
+        1.061503   0.137019   0.538971 ;; 256
+        0.132012  -0.388980  -0.440121 ;; 257
+       -1.396203   0.027968   0.327089 ;; 258
+        0.182330   0.102956   0.833341 ;; 259
+       -0.003411  -0.130962  -0.877838 ;; 260
+       -0.211400  -0.057093   0.975098 ;; 261
+       -0.097590  -0.213188   0.588257 ;; 262
+       -1.003755   0.125139   0.516657 ;; 263
+        0.145795  -0.307277   0.659792 ;; 264
+       -1.592601  -0.190827   0.326839 ;; 265
+        0.252199   0.159751   0.575604 ;; 266
+       -0.276988  -0.363609   0.427038 ;; 267
+       -0.306669  -0.151695   0.054136 ;; 268
+        0.478704  -0.153845  -1.474121 ;; 269
+        1.026670  -0.125606   0.468638 ;; 270
+       -0.319364   0.300624   0.249479 ;; 271
+       -0.124926  -0.170648   0.588264 ;; 272
+       -0.004703  -0.258142   1.196669 ;; 273
+        1.717114  -0.147854   0.305673 ;; 274
+        0.181215  -0.261802   0.597216 ;; 275
+        0.298818  -0.332774  -0.441886 ;; 276
+        0.976969   0.119644   0.267077 ;; 277
+       -1.145701   0.098194   0.241037 ;; 278
+        0.263925  -0.322318  -1.438223 ;; 279
+        0.476459  -0.175349  -2.239584 ;; 280
+       -0.524300   0.183340  -2.580805 ;; 281
+       -0.156925   0.286868   0.042039 ;; 282
+       -0.380636   0.047800  -0.375852 ;; 283
+       -0.982968   0.119644   0.267077 ;; 284
+       -0.227456  -0.009455   0.707040 ;; 285
+        0.223612  -0.193058   0.546710 ;; 286
+       -0.316726   0.208995   0.718699 ;; 287
+        0.545104   0.081069  -2.376508 ;; 288
+        0.369953   0.183340  -2.657734 ;; 289
+       -0.183645  -0.230433  -1.492275 ;; 290
+        0.425573   0.093489  -1.474181 ;; 291
+       -0.455106   0.108856   0.268487 ;; 292
+       -0.070343  -0.280303   0.665049 ;; 293
+       -0.375952   0.183340  -2.657734 ;; 294
+       -0.006289  -0.318428   0.662747 ;; 295
+        0.194022  -0.202933  -1.817734 ;; 296
+       -0.223717  -0.204496   0.978502 ;; 297
+       -0.000080  -0.325364   0.045181 ;; 298
+       -0.398959   0.113003  -0.677778 ;; 299
+       -0.006289  -0.347773   0.685244 ;; 300
+       -1.145701   0.098194   0.241037 ;; 301
+        0.260540  -0.025165   0.993435 ;; 302
+       -0.393719   0.157800  -2.490092 ;; 303
+       -0.541047  -0.114952  -2.490092 ;; 304
+        0.392889   0.113003  -0.677778 ;; 305
+        0.158433   0.286868   0.042039 ;; 306
+       -0.452740   0.172566   0.553271 ;; 307
+        0.354008   0.121975   0.674038 ;; 308
+       -0.410881  -0.175349  -2.239584 ;; 309
+       -0.073038  -0.455001   0.263522 ;; 310
+       -0.074577   0.171979   0.831353 ;; 311
+        0.976969   0.119644   0.267077 ;; 312
+        0.611789  -0.406601  -2.657734 ;; 313
+        0.044312  -0.241609   0.588256 ;; 314
+       -0.245447   0.077429   1.101658 ;; 315
+        0.432994  -0.025592   0.349726 ;; 316
+        0.319454  -0.112389  -2.580805 ;; 317
+        0.167040   0.166069   1.018417 ;; 318
+        0.151691  -0.102737   1.216843 ;; 319
+       -0.179088  -0.240302   0.542395 ;; 320
+        0.177599  -0.174906   0.682182 ;; 321
+       -1.409574  -0.144055   0.293894 ;; 322
+        0.302798  -0.317595  -2.580805 ;; 323
+       -1.095109   0.128129   0.231484 ;; 324
+       -0.308797  -0.317595  -2.657734 ;; 325
+       -0.574799   0.106697  -2.657734 ;; 326
+       -0.000141   0.161080   0.011390 ;; 327
+        0.226279  -0.211849   0.886254 ;; 328
+        0.243944   0.097354  -1.474261 ;; 329
+        0.687262   0.131227   0.569201 ;; 330
+       -0.211400  -0.057093   0.975098 ;; 331
+       -0.272254   0.106704   0.767211 ;; 332
+       -0.176449   0.166069   1.018417 ;; 333
+       -0.375995   0.159138   0.491721 ;; 334
+        0.611789  -0.317595  -2.580805 ;; 335
+       -1.685515  -0.249800   0.255279 ;; 336
+       -0.003381   0.109456  -0.402310 ;; 337
+       -0.372522  -0.270258   0.269407 ;; 338
+       -0.318064   0.132416  -0.436828 ;; 339
+       -0.865659  -0.188788   0.479190 ;; 340
+        0.195696  -0.317259   0.876501 ;; 341
+       -0.176426  -0.154916   0.664987 ;; 342
+        0.449107   0.108856   0.268487 ;; 343
+        0.176633  -0.003543  -1.474674 ;; 344
+       -0.335043   0.208280   0.632112 ;; 345
+        0.482849   0.106332  -2.148535 ;; 346
+        0.520086  -0.466102  -2.490092 ;; 347
+       -1.096100  -0.130691   0.480245 ;; 348
+       -0.004703  -0.167658   0.655401 ;; 349
+        1.687793  -0.198695   0.263325 ;; 350
+        0.263925  -0.322318  -1.438223 ;; 351
+        0.417836  -0.135507  -1.703337 ;; 352
+       -0.279596   0.074727   0.688582 ;; 353
+        1.426687   0.046346   0.291309 ;; 354
+        0.976969   0.119644   0.267077 ;; 355
+       -0.272784   0.286391   0.778669 ;; 356
+        0.179141   0.022792  -1.516799 ;; 357
+        0.380699   0.105234  -2.150436 ;; 358
+        0.224487   0.110006  -0.156248 ;; 359
+       -0.468500   0.156083  -1.557609 ;; 360
+       -1.437608  -0.144589   0.423886 ;; 361
+        0.227494   0.061547  -0.296461 ;; 362
+        0.223709   0.071884   0.735994 ;; 363
+        0.014988   0.015320  -0.872209 ;; 364
+        1.164111   0.098164   0.518664 ;; 365
+       -0.345515   0.081069  -2.239584 ;; 366
+        0.491985   0.154621  -2.376508 ;; 367
+       -0.003075  -0.301878   0.533236 ;; 368
+        0.319114   0.296407   0.403765 ;; 369
+       -0.288162   0.022422  -0.151934 ;; 370
+       -0.104584  -0.384723   0.959686 ;; 371
+        0.201991  -0.057093   0.975098 ;; 372
+        0.029258  -0.337918   0.685779 ;; 373
+       -0.316726   0.208995   0.718699 ;; 374
+        1.444378   0.048735   0.306486 ;; 375
+        0.404882  -0.175349  -2.239584 ;; 376
+        0.200554  -0.324334   0.986087 ;; 377
+       -0.429342  -0.304467   0.349726 ;; 378
+        0.336638  -0.112082  -2.239584 ;; 379
+       -1.112566  -0.122240   0.299157 ;; 380
+       -0.150734   0.083907   1.191943 ;; 381
+        0.167017  -0.154916   0.664987 ;; 382
+        1.390648  -0.120398   0.403038 ;; 383
+       -1.450950   0.048735   0.404541 ;; 384
+       -1.875103  -0.142400   0.340744 ;; 385
+        0.000196   0.432698   0.721081 ;; 386
+        0.295144   0.105934   0.918667 ;; 387
+        0.279436   0.074727   0.688582 ;; 388
+        0.273466   0.071038   0.593495 ;; 389
+       -0.482458  -0.175349  -2.376508 ;; 390
+       -1.132551   0.199240   0.488391 ;; 391
+        0.128213  -0.415016  -1.035903 ;; 392
+        1.083044  -0.198680   0.317613 ;; 393
+       -0.004703  -0.451144   0.858007 ;; 394
+       -1.396203   0.027968   0.327089 ;; 395
+        1.717114   0.042835   0.305673 ;; 396
+        0.334596  -0.135798  -1.703386 ;; 397
+        1.585673   0.066442   0.305261 ;; 398
+       -0.300320   0.008727  -1.703525 ;; 399
+       -0.199041  -0.294946   0.893264 ;; 400
+       -0.393719   0.157800  -2.490092 ;; 401
+       -0.277882  -0.201597   0.582581 ;; 402
+       -0.398634   0.154621  -2.376508 ;; 403
+       -0.021057   0.015320  -0.872209 ;; 404
+        0.225192   0.167094   0.678161 ;; 405
+        0.432994   0.253283   0.349726 ;; 406
+        0.307446  -0.208900   0.535841 ;; 407
+       -0.021956  -0.285396  -1.036405 ;; 408
+       -1.591672   0.066441   0.305261 ;; 409
+       -1.022322  -0.170440   0.334845 ;; 410
+       -0.451828  -0.349518  -1.386618 ;; 411
+        0.518301   0.183340  -2.580805 ;; 412
+        0.861432   0.126253   0.298920 ;; 413
+       -0.308797  -0.406601  -2.580805 ;; 414
+       -0.868181   0.172314   0.478999 ;; 415
+       -0.004703  -0.389118   0.959097 ;; 416
+       -0.000155   0.259903   0.548652 ;; 417
+        0.210063  -0.096090   0.690048 ;; 418
+       -0.668420  -0.292604   0.368433 ;; 419
+       -0.003076  -0.328477   0.586866 ;; 420
+       -0.318085  -0.160978   0.563822 ;; 421
+        0.019604   0.015320  -1.035847 ;; 422
+       -0.211933  -0.115309   0.991398 ;; 423
+        1.335453   0.127707   0.301432 ;; 424
+       -0.000275   0.286868   0.037730 ;; 425
+       -0.205105  -0.317259   0.876501 ;; 426
+        1.869104  -0.142400   0.340745 ;; 427
+       -0.870546   0.123645   0.507510 ;; 428
+        0.520086  -0.466102  -2.490092 ;; 429
+       -0.197016  -0.182088   0.696562 ;; 430
+       -0.342637  -0.112082  -2.376508 ;; 431
+        1.717114   0.042835   0.305673 ;; 432
+       -0.245584   0.038738  -0.172063 ;; 433
+        1.863162  -0.142400   0.281993 ;; 434
+       -0.327597   0.011741  -0.296154 ;; 435
+       -0.346291  -0.510440  -2.657734 ;; 436
+       -1.592601  -0.190827   0.326839 ;; 437
+        0.295753  -0.428765   0.262840 ;; 438
+       -0.219121  -0.196914   0.906318 ;; 439
+        0.262844   0.106704   0.767211 ;; 440
+       -0.308797  -0.317595  -2.580805 ;; 441
+        0.476459  -0.175349  -2.376508 ;; 442
+       -0.547373  -0.510440  -2.657734 ;; 443
+       -0.352440   0.121975   0.674038 ;; 444
+       -0.340802   0.196053   0.249479 ;; 445
+       -0.000141   0.161080   0.011390 ;; 446
+        1.173636   0.164760   0.476047 ;; 447
+        1.717114  -0.147854   0.305673 ;; 448
+        0.189824  -0.307422   0.965828 ;; 449
+       -0.006274  -0.265276   0.650512 ;; 450
+        0.518301   0.183340  -2.657734 ;; 451
+       -0.004703  -0.394380   0.882201 ;; 452
+       -1.396646   0.015863   0.402935 ;; 453
+       -0.278030  -0.065801   0.874451 ;; 454
+        0.065223  -0.184995   0.655160 ;; 455
+        0.277723  -0.201597   0.582581 ;; 456
+       -0.471545   0.008962  -1.703220 ;; 457
+       -1.723113   0.042834   0.305672 ;; 458
+       -1.031477  -0.168690   0.446304 ;; 459
+       -0.089525  -0.267492   0.689892 ;; 460
+        0.271496   0.095258   0.999418 ;; 461
+        0.201991  -0.057093   0.975098 ;; 462
+        0.123662  -0.304982   1.132034 ;; 463
+       -0.123108  -0.218723   0.693033 ;; 464
+       -0.387789  -0.282461  -2.440612 ;; 465
+        0.672072  -0.025592   0.368433 ;; 466
+        0.236038   0.077429   1.101658 ;; 467
+        0.134076   0.247741   0.532985 ;; 468
+       -1.450376  -0.169493   0.306486 ;; 469
+       -1.432687   0.046346   0.291309 ;; 470
+        0.581769  -0.202933  -1.793326 ;; 471
+       -0.346291  -0.510440  -2.580805 ;; 472
+        1.164111   0.098164   0.518664 ;; 473
+        0.446623  -0.349518  -1.386618 ;; 474
+        0.387720   0.157800  -2.490092 ;; 475
+        1.586201  -0.142608   0.395578 ;; 476
+       -0.247739  -0.218025   1.006827 ;; 477
+       -0.132725   0.196822   0.850507 ;; 478
+        1.688108  -0.198695   0.317277 ;; 479
+        0.527313   0.038704  -2.151188 ;; 480
+        0.997756   0.125139   0.516657 ;; 481
+       -0.429342  -0.304467   0.349726 ;; 482
+       -0.549571  -0.112081  -2.239584 ;; 483
+        1.120667  -0.121063   0.469854 ;; 484
+       -0.182703  -0.003543  -1.474674 ;; 485
+       -0.398634   0.154621  -2.376508 ;; 486
+       -1.591672   0.066441   0.305261 ;; 487
+        0.497633   0.157800  -2.490092 ;; 488
+        0.142108   0.144303   1.117140 ;; 489
+       -0.997081   0.183809   0.297031 ;; 490
+        0.511856  -0.282461  -2.440612 ;; 491
+       -0.242875  -0.011509   1.138145 ;; 492
+        0.310903   0.048431   0.361420 ;; 493
+       -1.095109   0.128129   0.231484 ;; 494
+       -0.097111  -0.392621   0.881072 ;; 495
+        0.862182   0.172314   0.478999 ;; 496
+       -0.140168   0.247741   0.532985 ;; 497
+        0.319454   0.106697  -2.657734 ;; 498
+       -1.685515  -0.249800   0.255279 ;; 499
+        0.336638  -0.112082  -2.376508 ;; 500
+        0.110731  -0.218723   0.693034 ;; 501
+       -0.997081   0.183809   0.297031 ;; 502
+       -0.205602   0.212032  -0.601705 ;; 503
+       -1.869160   0.011151   0.281993 ;; 504
+       -0.227456  -0.009455   0.707040 ;; 505
+        0.495620  -0.138177  -2.376724 ;; 506
+       -1.121409  -0.145958   0.444972 ;; 507
+       -1.089043  -0.198680   0.317613 ;; 508
+       -0.497984   0.154621  -2.239584 ;; 509
+       -0.256561  -0.262176  -1.474398 ;; 510
+        0.594402  -0.112389  -2.657734 ;; 511
+       -0.003411   0.180399  -0.786474 ;; 512
+        0.256370  -0.100834   0.566538 ;; 513
+        0.319454   0.106697  -2.657734 ;; 514
+        0.518301   0.183340  -2.657734 ;; 515
+        0.072637   0.186885  -0.751402 ;; 516
+       -0.223717  -0.204496   0.978502 ;; 517
+        1.320175  -0.142358   0.446818 ;; 518
+       -0.000275   0.228042  -0.188933 ;; 519
+        0.094000  -0.136226   0.658301 ;; 520
+        0.545104   0.081069  -2.376508 ;; 521
+        0.463295   0.156083  -1.557609 ;; 522
+       -1.326174  -0.142358   0.446818 ;; 523
+        0.062240  -0.130962  -0.871460 ;; 524
+        0.279436   0.074727   0.688582 ;; 525
+        0.494562   0.127651  -2.378647 ;; 526
+       -0.352440   0.121975   0.674038 ;; 527
+        0.085224  -0.213188   0.588256 ;; 528
+       -0.497984   0.154621  -2.376508 ;; 529
+        0.432994  -0.304467   0.349726 ;; 530
+       -0.183645  -0.230433  -1.492275 ;; 531
+        0.594402  -0.112389  -2.657734 ;; 532
+       -0.003410   0.208119  -0.599499 ;; 533
+       -0.192475  -0.352509  -0.582486 ;; 534
+       -0.316902  -0.122667   0.820649 ;; 535
+       -0.064237   0.165695   0.627706 ;; 536
+        0.257998  -0.294027  -1.748076 ;; 537
+       -0.398634   0.154621  -2.239584 ;; 538
+        0.682390   0.184118   0.538288 ;; 539
+       -0.004703   0.102156   1.197689 ;; 540
+       -0.235689  -0.211849   0.886254 ;; 541
+        1.090101  -0.130691   0.480245 ;; 542
+        0.238329  -0.218025   1.006827 ;; 543
+       -0.000136  -0.392272   0.427940 ;; 544
+       -1.304814  -0.183765   0.301940 ;; 545
+       -0.287437  -0.169043   0.816981 ;; 546
+       -0.269130  -0.322318  -1.438223 ;; 547
+        0.095174  -0.384723   0.959686 ;; 548
+        0.320932   0.300624   0.249479 ;; 549
+       -0.324826   0.011741  -0.296154 ;; 550
+       -1.145701   0.098194   0.241037 ;; 551
+        1.869104   0.011151   0.340745 ;; 552
+        0.611789  -0.406601  -2.657734 ;; 553
+        0.266269  -0.001283   1.087063 ;; 554
+        0.062936   0.142900   0.771554 ;; 555
+        1.107303   0.201230   0.267917 ;; 556
+       -1.076515   0.216496   0.492370 ;; 557
+       -0.317546   0.296407   0.403765 ;; 558
+       -0.294665  -0.256905   0.066449 ;; 559
+       -1.032669  -0.125606   0.468638 ;; 560
+        0.179968  -0.155864  -1.474566 ;; 561
+       -0.308797  -0.406601  -2.657734 ;; 562
+        1.062072  -0.145299   0.482840 ;; 563
+       -0.222979   0.110006  -0.156248 ;; 564
+       -0.000086   0.092855  -0.157727 ;; 565
+        0.288002   0.022422  -0.151934 ;; 566
+        0.294251   0.008727  -1.703525 ;; 567
+        0.089051  -0.413657   1.048272 ;; 568
+       -0.244451   0.080927   0.769196 ;; 569
+        0.340292  -0.510440  -2.580805 ;; 570
+       -0.349322  -0.366436  -2.490092 ;; 571
+        0.276622  -0.349518  -1.396902 ;; 572
+       -0.280609   0.174328   0.709547 ;; 573
+        0.381790  -0.282461  -2.440612 ;; 574
+        0.336638  -0.112082  -2.376508 ;; 575
+        0.307492  -0.122667   0.820649 ;; 576
+       -0.346574   0.292189   0.558050 ;; 577
+        0.672072  -0.292604   0.368433 ;; 578
+       -0.410881  -0.175349  -2.376508 ;; 579
+       -0.307062   0.209797  -1.738257 ;; 580
+       -0.128174  -0.371379  -0.296442 ;; 581
+       -0.345678  -0.286862  -0.369237 ;; 582
+       -0.524300   0.183340  -2.657734 ;; 583
+        0.189824  -0.307422   0.965828 ;; 584
+        0.189721   0.150880   0.820237 ;; 585
+        1.586288  -0.190826   0.272887 ;; 586
+       -0.345515   0.081069  -2.376508 ;; 587
+       -1.039954   0.141180   0.235471 ;; 588
+       -0.269130  -0.322318  -1.438223 ;; 589
+       -0.468500   0.156083  -1.557609 ;; 590
+        0.077253  -0.294666   0.535425 ;; 591
+        0.548741  -0.230433  -1.470031 ;; 592
+       -0.458755   0.110432   0.589549 ;; 593
+        0.243985  -0.096281   1.039692 ;; 594
+       -0.089525  -0.238147   0.667394 ;; 595
+        1.426687   0.046346   0.291309 ;; 596
+       -0.325453  -0.112389  -2.657734 ;; 597
+        0.180317  -0.321333  -0.161438 ;; 598
+        0.380789   0.028411  -0.375533 ;; 599
+        0.490372   0.020907  -0.645886 ;; 600
+        1.139702   0.098194   0.241037 ;; 601
+        0.387720   0.157800  -2.490092 ;; 602
+       -0.460219   0.172566   0.299324 ;; 603
+        0.392635   0.154621  -2.376508 ;; 604
+       -0.078453  -0.265786   0.683015 ;; 605
+       -0.000275   0.082376  -0.281690 ;; 606
+       -0.338822  -0.073754  -2.151191 ;; 607
+        0.541374  -0.510440  -2.657734 ;; 608
+        0.541374  -0.510440  -2.580805 ;; 609
+       -0.344493  -0.414568  -1.034063 ;; 610
+       -0.160602  -0.002857   1.221000 ;; 611
+        0.518301   0.183340  -2.580805 ;; 612
+        0.369953   0.183340  -2.580805 ;; 613
+       -1.039954   0.141180   0.235471 ;; 614
+       -0.342637  -0.112082  -2.376508 ;; 615
+        0.178379  -0.323130   1.071322 ;; 616
+       -0.150237   0.009233   0.606217 ;; 617
+       -0.356304   0.095329  -2.490092 ;; 618
+       -0.134282  -0.415016  -1.035903 ;; 619
+       -0.526085  -0.466102  -2.490092 ;; 620
+        1.349378   0.126043   0.421894 ;; 621
+       -0.304553   0.105934   0.918667 ;; 622
+        0.330660  -0.194766  -0.296250 ;; 623
+       -0.743215   0.138849   0.265589 ;; 624
+       -1.460756   0.080347   0.401605 ;; 625
+        1.431609  -0.144589   0.423886 ;; 626
+       -0.475692  -0.299058  -1.036510 ;; 627
+        0.060939   0.147545  -0.757309 ;; 628
+       -0.277882  -0.201597   0.582581 ;; 629
+        1.126552   0.199240   0.488391 ;; 630
+        1.107094  -0.161996   0.321012 ;; 631
+       -0.316902   0.048431   0.361420 ;; 632
+       -0.103892  -0.457038   0.803349 ;; 633
+        0.029258  -0.308573   0.663281 ;; 634
+       -0.004703  -0.325254   0.654436 ;; 635
+        0.206645   0.156781   0.817439 ;; 636
+       -0.693261   0.131227   0.569201 ;; 637
+        0.197719   0.339094   0.832408 ;; 638
+       -0.067389  -0.405363   0.110496 ;; 639
+        1.578429  -0.241931   0.336434 ;; 640
+       -0.537122  -0.307435  -1.590425 ;; 641
+       -0.375952   0.183340  -2.657734 ;; 642
+       -0.000157   0.281407   0.233603 ;; 643
+        0.294251   0.008727  -1.703525 ;; 644
+        1.070516   0.216496   0.492370 ;; 645
+        0.432994  -0.304467   0.349726 ;; 646
+       -0.003321   0.235940   0.864071 ;; 647
+       -0.617788  -0.406601  -2.657734 ;; 648
+       -0.455106  -0.190632   0.268487 ;; 649
+       -0.333591  -0.194766  -0.296249 ;; 650
+       -1.096388  -0.196554   0.453104 ;; 651
+       -0.003243   0.199025   0.847551 ;; 652
+        0.062240  -0.289119  -0.808849 ;; 653
+       -0.488248  -0.241871  -1.849660 ;; 654
+       -1.170110   0.098164   0.518664 ;; 655
+        0.338694  -0.259464   0.632112 ;; 656
+        0.375836   0.159138   0.491721 ;; 657
+       -0.574799   0.106697  -2.657734 ;; 658
+        0.368705   0.160222   0.630700 ;; 659
+        1.586201   0.066442   0.395578 ;; 660
+       -0.586974   0.084994  -1.726342 ;; 661
+       -0.668420  -0.025592   0.667381 ;; 662
+        0.342371   0.196053   0.249479 ;; 663
+        0.531917  -0.307435  -1.590425 ;; 664
+       -0.361713   0.199311   0.199064 ;; 665
+        0.392635   0.154621  -2.239584 ;; 666
+        0.480523  -0.288043  -1.748337 ;; 667
+       -1.162138   0.166043   0.274364 ;; 668
+        0.302798  -0.406601  -2.580805 ;; 669
+       -0.199234  -0.307423   0.965828 ;; 670
+        0.491985   0.154621  -2.376508 ;; 671
+        0.319454   0.106697  -2.580805 ;; 672
+       -0.265983  -0.241930  -1.851025 ;; 673
+        1.586603  -0.190826   0.326840 ;; 674
+       -0.319006  -0.020318   0.864772 ;; 675
+        0.483042  -0.241871  -1.849660 ;; 676
+        0.314847   0.097569   0.385204 ;; 677
+        0.457519  -0.322318  -1.421651 ;; 678
+       -0.001698   0.088099  -0.296566 ;; 679
+        0.542578  -0.063284  -2.379029 ;; 680
+       -0.006473   0.182180   0.877838 ;; 681
+       -0.345515   0.081069  -2.376508 ;; 682
+       -0.021057   0.015320  -0.872209 ;; 683
+        0.074458  -0.296013   0.679862 ;; 684
+       -0.004703   0.095853   0.749953 ;; 685
+       -0.325453   0.106697  -2.580805 ;; 686
+        0.209711  -0.196914   0.906318 ;; 687
+        0.276622  -0.349518  -1.396902 ;; 688
+       -0.308161   0.016851   0.968631 ;; 689
+       -0.155205  -0.307277   0.659792 ;; 690
+       -1.126666  -0.121063   0.469854 ;; 691
+       -0.098461  -0.413657   1.048272 ;; 692
+        0.077148  -0.238147   0.667394 ;; 693
+       -0.219121  -0.196914   0.906318 ;; 694
+        1.586603  -0.190826   0.326840 ;; 695
+       -0.273072  -0.387840   0.121076 ;; 696
+        0.543572  -0.112081  -2.376508 ;; 697
+       -1.122406   0.125169   0.534982 ;; 698
+       -0.617788  -0.406601  -2.580805 ;; 699
+       -0.482458  -0.175349  -2.239584 ;; 700
+        0.179141   0.022792  -1.516799 ;; 701
+        1.115410  -0.145958   0.444972 ;; 702
+        0.207868  -0.370557  -0.546021 ;; 703
+        0.208456   0.138755   0.016049 ;; 704
+        1.089110   0.128129   0.231484 ;; 705
+       -0.574799   0.106697  -2.580805 ;; 706
+        1.046727  -0.146912   0.296241 ;; 707
+       -0.617788  -0.406601  -2.657734 ;; 708
+       -0.001777  -0.371379  -0.296539 ;; 709
+       -1.003755   0.125139   0.516657 ;; 710
+        0.190925  -0.182088   0.696562 ;; 711
+       -0.668420  -0.025592   0.368433 ;; 712
+       -1.113093  -0.161996   0.321012 ;; 713
+       -0.547783   0.030428  -2.378750 ;; 714
+       -0.004703  -0.437448   0.692340 ;; 715
+       -1.450376  -0.169493   0.306486 ;; 716
+        0.338694  -0.025592   0.688972 ;; 717
+        0.446740  -0.254343   0.553271 ;; 718
+        0.568800   0.106697  -2.580805 ;; 719
+       -0.272254   0.106704   0.767211 ;; 720
+       -0.196321  -0.115531   0.671183 ;; 721
+       -0.001698   0.088099  -0.296566 ;; 722
+        0.259186  -0.272663  -0.164584 ;; 723
+       -0.373671   0.068540  -1.036392 ;; 724
+       -0.004703  -0.023209   0.691914 ;; 725
+        0.348142   0.292189   0.558050 ;; 726
+        0.402877  -0.261593  -1.474299 ;; 727
+        0.366775  -0.226958  -0.376024 ;; 728
+        0.068408   0.171979   0.831353 ;; 729
+        0.324666   0.011741  -0.296154 ;; 730
+        0.062240  -0.130962  -0.871460 ;; 731
+        1.585673  -0.142608   0.305261 ;; 732
+       -0.551103   0.081069  -2.376508 ;; 733
+        1.454757   0.080347   0.401605 ;; 734
+       -1.592286  -0.190827   0.272887 ;; 735
+       -0.688389   0.184118   0.538288 ;; 736
+        0.417818   0.129004  -2.380735 ;; 737
+       -0.492965   0.205734  -1.736496 ;; 738
+        0.122160  -0.120787   0.589089 ;; 739
+        0.227494   0.061547  -0.296461 ;; 740
+       -0.730272   0.191328   0.292086 ;; 741
+       -0.292673  -0.012945   0.653522 ;; 742
+        1.586201  -0.142608   0.395578 ;; 743
+        0.370453   0.031416  -2.380329 ;; 744
+        1.005974   0.186657   0.478340 ;; 745
+       -0.462724  -0.322318  -1.421651 ;; 746
+       -0.363486  -0.247994   0.149043 ;; 747
+        0.309597  -0.020318   0.864772 ;; 748
+       -0.158916  -0.169895   1.197641 ;; 749
+        0.290415   0.152794  -1.576903 ;; 750
+       -0.367136   0.160222   0.630700 ;; 751
+       -0.067436   0.017896  -0.846083 ;; 752
+       -0.204641   0.102549   0.716299 ;; 753
+       -0.377418  -0.093852   0.446799 ;; 754
+       -0.208236  -0.091096   0.901390 ;; 755
+       -0.110123   0.100195  -1.036922 ;; 756
+        0.340292  -0.510440  -2.657734 ;; 757
+       -1.869160  -0.142400   0.281993 ;; 758
+        0.287500   0.081849   0.672687 ;; 759
+       -0.208884   0.168859   0.934908 ;; 760
+        0.286581  -0.012945   0.653522 ;; 761
+       -0.242154   0.257910   0.208687 ;; 762
+        0.310903  -0.159762   0.361420 ;; 763
+       -1.460923   0.047482   0.421278 ;; 764
+       -0.003243   0.199025   0.847551 ;; 765
+       -1.162138   0.166043   0.274364 ;; 766
+       -0.025673   0.015320  -1.035847 ;; 767
+       -0.356304  -0.114952  -2.490092 ;; 768
+       -1.179635   0.164760   0.476047 ;; 769
+       -1.685933  -0.249800   0.326871 ;; 770
+       -1.027619  -0.126922   0.315253 ;; 771
+        0.204481   0.102549   0.716299 ;; 772
+       -0.280905   0.095258   0.999418 ;; 773
+       -0.549571  -0.112081  -2.239584 ;; 774
+        0.432994  -0.304467   0.349726 ;; 775
+       -0.000157   0.281407   0.233603 ;; 776
+       -0.372122  -0.265407   0.420989 ;; 777
+        0.672071   0.197787   0.617540 ;; 778
+       -0.004703  -0.376784   1.113413 ;; 779
+        0.858549  -0.133461   0.299112 ;; 780
+        0.463295   0.156083  -1.557609 ;; 781
+       -1.584009  -0.241931   0.264842 ;; 782
+        1.327869   0.085693   0.280632 ;; 783
+       -0.408946  -0.261593  -1.474299 ;; 784
+        0.541374  -0.510440  -2.580805 ;; 785
+       -1.429451  -0.177542   0.405106 ;; 786
+        1.403016  -0.177762   0.310694 ;; 787
+        0.672072   0.241421   0.368433 ;; 788
+        0.167017  -0.154916   0.664987 ;; 789
+       -0.455106   0.108856   0.268487 ;; 790
+       -0.259345  -0.272663  -0.164584 ;; 791
+       -0.460219  -0.254343   0.299324 ;; 792
+        0.368705   0.196053   0.563264 ;; 793
+       -0.617788  -0.317595  -2.580805 ;; 794
+       -0.083344  -0.294666   0.535425 ;; 795
+        0.339516   0.081069  -2.239584 ;; 796
+        0.976969   0.119644   0.267077 ;; 797
+       -0.229903  -0.129756   1.139826 ;; 798
+       -0.497984   0.154621  -2.239584 ;; 799
+        0.275810  -0.335526  -0.296344 ;; 800
+        0.077148  -0.267492   0.689892 ;; 801
+       -1.723112  -0.147854   0.305672 ;; 802
+        0.000196   0.167094   0.673853 ;; 803
+       -0.385904   0.105234  -2.150436 ;; 804
+        0.338424  -0.414568  -1.034063 ;; 805
+       -0.041635  -0.337919   0.685779 ;; 806
+       -0.377102  -0.466102  -2.490092 ;; 807
+        0.186911  -0.115531   0.671183 ;; 808
+       -0.088286  -0.447118   0.857359 ;; 809
+        0.095174  -0.384723   0.959686 ;; 810
+        0.545104   0.081069  -2.239584 ;; 811
+        0.312086  -0.160978   0.563822 ;; 812
+       -0.133072  -0.304982   1.132034 ;; 813
+       -1.730492  -0.147854   0.378633 ;; 814
+       -0.375952   0.183340  -2.657734 ;; 815
+       -0.156925   0.228042  -0.184624 ;; 816
+        0.452756  -0.192209   0.589549 ;; 817
+       -0.549571  -0.112081  -2.376508 ;; 818
+       -0.208236  -0.091096   0.901390 ;; 819
+       -0.056678  -0.241609   0.588256 ;; 820
+       -0.497984   0.154621  -2.376508 ;; 821
+        0.861432   0.126253   0.298920 ;; 822
+        0.487760   0.205734  -1.736496 ;; 823
+       -1.396204  -0.132968   0.327243 ;; 824
+       -0.137872  -0.388980  -0.440121 ;; 825
+       -0.234390  -0.018768   0.712533 ;; 826
+       -0.982968   0.119644   0.267077 ;; 827
+       -1.440320   0.080128   0.307193 ;; 828
+       -1.693792  -0.198696   0.263324 ;; 829
+       -0.227653   0.061547  -0.296461 ;; 830
+        0.991082   0.183809   0.297031 ;; 831
+        0.238360   0.080927   0.769196 ;; 832
+       -0.429342   0.253283   0.349726 ;; 833
+        1.390648   0.015863   0.402936 ;; 834
+        0.000196   0.337718   0.795976 ;; 835
+        1.139702   0.098194   0.241037 ;; 836
+        0.307446   0.097569   0.535841 ;; 837
+        1.090389  -0.196554   0.453104 ;; 838
+        1.301464  -0.140618   0.281020 ;; 839
+       -0.327776   0.256358   0.684079 ;; 840
+        0.594402  -0.112389  -2.580805 ;; 841
+        0.057966  -0.309648   0.687547 ;; 842
+        0.459206  -0.161620  -2.149632 ;; 843
+        0.430233   0.057244  -1.703278 ;; 844
+        0.087702  -0.392621   0.881072 ;; 845
+       -0.006349   0.187675   0.629331 ;; 846
+        0.220516   0.238317   0.552081 ;; 847
+       -0.003077  -0.272650   0.678845 ;; 848
+       -1.693792  -0.198696   0.263324 ;; 849
+        1.049359  -0.199185   0.320153 ;; 850
+       -1.068071  -0.145299   0.482840 ;; 851
+       -0.398634   0.154621  -2.376508 ;; 852
+       -0.436303   0.057244  -1.703278 ;; 853
+       -0.155205  -0.307277   0.659792 ;; 854
+        0.202524  -0.115309   0.991398 ;; 855
+        0.000196   0.337718   0.795976 ;; 856
+       -0.000184  -0.336035  -0.156353 ;; 857
+        0.209525  -0.307435  -1.611132 ;; 858
+        0.202352   0.177189  -0.610215 ;; 859
+        1.115410  -0.145958   0.444972 ;; 860
+       -0.452739  -0.254343   0.553271 ;; 861
+        0.864547   0.123645   0.507510 ;; 862
+        0.611789  -0.317595  -2.657734 ;; 863
+       -0.869239   0.175831   0.323140 ;; 864
+        0.247093   0.038738  -0.172064 ;; 865
+       -0.004703   0.095853   0.749953 ;; 866
+       -0.199228   0.084994  -1.750749 ;; 867
+       -0.091025  -0.426170   0.690404 ;; 868
+       -0.451828  -0.349518  -1.386618 ;; 869
+       -1.126666  -0.121063   0.469854 ;; 870
+       -0.004703  -0.122231   0.660260 ;; 871
+       -0.161101  -0.102737   1.216843 ;; 872
+        1.687793  -0.198695   0.263325 ;; 873
+        0.568800   0.106697  -2.657734 ;; 874
+        0.184327   0.151400   0.777135 ;; 875
+       -0.385904   0.105234  -2.150436 ;; 876
+        0.204481   0.102549   0.716299 ;; 877
+       -0.204641   0.102549   0.716299 ;; 878
+       -0.220675   0.238317   0.552081 ;; 879
+       -0.308797  -0.317595  -2.657734 ;; 880
+       -0.463776  -0.292960  -0.643146 ;; 881
+        0.280734  -0.183836  -0.166305 ;; 882
+       -0.003411  -0.130962  -0.877838 ;; 883
+       -0.209964  -0.324334   0.986087 ;; 884
+        0.737216   0.138849   0.265589 ;; 885
+       -0.668420  -0.248970   0.617540 ;; 886
+        0.260778  -0.241930  -1.851025 ;; 887
+        0.219017  -0.320485   0.817189 ;; 888
+        0.314847  -0.208900   0.385204 ;; 889
+        0.371103  -0.466102  -2.490092 ;; 890
+       -0.000086   0.092855  -0.157727 ;; 891
+        0.302798  -0.317595  -2.657734 ;; 892
+        0.209711  -0.196914   0.906318 ;; 893
+       -0.068086  -0.289119  -0.808849 ;; 894
+        0.225192   0.432698   0.725390 ;; 895
+       -0.499768   0.127651  -2.378647 ;; 896
+       -1.121409  -0.145958   0.444972 ;; 897
+        0.167017  -0.154916   0.664987 ;; 898
+        1.585673  -0.142608   0.305261 ;; 899
+       -0.313445  -0.208900   0.535841 ;; 900
+        1.089110   0.128129   0.231484 ;; 901
+        0.572257  -0.281007  -2.490092 ;; 902
+        0.338694   0.208280   0.632112 ;; 903
+       -0.229703  -0.193058   0.546710 ;; 904
+        0.278027  -0.169043   0.816981 ;; 905
+        0.392635   0.154621  -2.376508 ;; 906
+       -0.199041  -0.294946   0.893264 ;; 907
+       -0.269949  -0.025165   0.993435 ;; 908
+        1.586288  -0.190826   0.272887 ;; 909
+       -0.482458  -0.175349  -2.239584 ;; 910
+       -0.295620   0.152794  -1.576903 ;; 911
+        0.302798  -0.406601  -2.657734 ;; 912
+       -0.280893  -0.183836  -0.166305 ;; 913
+       -1.179635   0.164760   0.476047 ;; 914
+        0.302798  -0.317595  -2.657734 ;; 915
+       -0.134526  -0.120787   0.589089 ;; 916
+       -0.070343  -0.309648   0.687546 ;; 917
+        0.149507  -0.169895   1.197641 ;; 918
+       -0.462724  -0.322318  -1.421651 ;; 919
+        0.422174  -0.138177  -2.376924 ;; 920
+        1.444378   0.048735   0.306486 ;; 921
+       -0.003321   0.249365   0.537429 ;; 922
+       -0.316902  -0.159762   0.361420 ;; 923
+        0.221236   0.070900  -0.157713 ;; 924
+        0.199533   0.212032  -0.601705 ;; 925
+        0.067230  -0.405363   0.110496 ;; 926
+       -0.279557   0.071038   0.593495 ;; 927
+       -0.229952  -0.100600   0.714890 ;; 928
+        0.051876   0.165695   0.627706 ;; 929
+       -0.187306  -0.261802   0.597216 ;; 930
+        0.072361  -0.265786   0.683015 ;; 931
+        1.120667  -0.121063   0.469854 ;; 932
+        0.272913  -0.387840   0.121076 ;; 933
+       -0.485728  -0.288043  -1.748337 ;; 934
+        1.298815  -0.183765   0.301940 ;; 935
+        0.250073  -0.311273   0.049379 ;; 936
+       -0.187789  -0.323130   1.071322 ;; 937
+       -0.497984   0.154621  -2.376508 ;; 938
+        0.012475  -0.285684  -0.877845 ;; 939
+       -0.003321   0.297035   0.748482 ;; 940
+       -0.278741  -0.335526  -0.296344 ;; 941
+       -0.484773  -0.153845  -1.474121 ;; 942
+        0.319454  -0.112389  -2.657734 ;; 943
+        1.016323  -0.170440   0.334845 ;; 944
+       -0.235689  -0.211849   0.886254 ;; 945
+       -0.524300   0.183340  -2.657734 ;; 946
+       -0.199131   0.150880   0.820237 ;; 947
+        0.214307  -0.204496   0.978502 ;; 948
+        0.139184   0.246944   0.727663 ;; 949
+        0.457707  -0.292960  -0.643146 ;; 950
+        1.578010  -0.241931   0.264843 ;; 951
+        1.312438  -0.183968   0.422358 ;; 952
+       -0.003381  -0.388980  -0.440121 ;; 953
+       -0.223624   0.455001   0.567794 ;; 954
+       -0.068086  -0.130962  -0.871460 ;; 955
+       -0.018544  -0.285684  -0.877845 ;; 956
+        1.863162   0.011151   0.281993 ;; 957
+       -0.000146  -0.422365   0.259928 ;; 958
+       -0.004703  -0.394380   0.882201 ;; 959
+       -1.450950  -0.169493   0.404541 ;; 960
+       -1.592286  -0.190827   0.272887 ;; 961
+        0.057966  -0.280303   0.665049 ;; 962
+        0.568800   0.106697  -2.657734 ;; 963
+       -1.584009  -0.241931   0.264842 ;; 964
+        0.392635   0.154621  -2.376508 ;; 965
+        1.863162  -0.142400   0.281993 ;; 966
+       -0.300320   0.008727  -1.703525 ;; 967
+        1.724493  -0.147854   0.378634 ;; 968
+        1.444951   0.048735   0.404541 ;; 969
+       -0.342637  -0.112082  -2.239584 ;; 970
+       -0.190418   0.151400   0.777135 ;; 971
+       -0.524300   0.183340  -2.580805 ;; 972
+        0.310903   0.048431   0.361420 ;; 973
+       -0.337089   0.059176  -1.703318 ;; 974
+        0.432994  -0.025592   0.349726 ;; 975
+       -0.549571  -0.112081  -2.376508 ;; 976
+        0.198826  -0.091096   0.901390 ;; 977
+       -0.547373  -0.510440  -2.657734 ;; 978
+       -0.145275   0.246944   0.727663 ;; 979
+        1.679516  -0.249800   0.255280 ;; 980
+       -0.003321   0.235940   0.864071 ;; 981
+        0.549442   0.022792  -1.494555 ;; 982
+        0.452756   0.110432   0.589549 ;; 983
+        0.209711  -0.196914   0.906318 ;; 984
+       -0.320846   0.097569   0.385204 ;; 985
+       -0.333591  -0.194766  -0.296249 ;; 986
+       -0.335043  -0.259464   0.632112 ;; 987
+       -0.003411  -0.289119  -0.815228 ;; 988
+       -0.253395  -0.096281   1.039692 ;; 989
+       -0.295620   0.152794  -1.576903 ;; 990
+        0.491985   0.154621  -2.376508 ;; 991
+        1.327869   0.085693   0.280632 ;; 992
+       -1.057116   0.219202   0.271894 ;; 993
+       -0.541047   0.095329  -2.490092 ;; 994
+       -1.341452   0.127707   0.301432 ;; 995
+        0.060221  -0.372340   1.114703 ;; 996
+        0.241326  -0.018583   0.736490 ;; 997
+       -1.086427  -0.146488   0.293702 ;; 998
+       -1.055358  -0.199185   0.320153 ;; 999
+        1.423452  -0.177542   0.405106 ;; 1000
+       -0.377419  -0.063284  -2.379229 ;; 1001
+        1.347159   0.084491   0.446475 ;; 1002
+        0.178439  -0.230433  -1.492275 ;; 1003
+       -0.335043  -0.025592   0.688972 ;; 1004
+        0.152749  -0.220130   0.676210 ;; 1005
+        0.333616  -0.073754  -2.151191 ;; 1006
+        0.110559  -0.401947   0.977689 ;; 1007
+        0.298752   0.016851   0.968631 ;; 1008
+       -1.355377   0.126043   0.421894 ;; 1009
+        0.318294   0.208994   0.718699 ;; 1010
+       -0.423024   0.129004  -2.380735 ;; 1011
+        0.343323  -0.366436  -2.490092 ;; 1012
+       -1.113302   0.201230   0.267917 ;; 1013
+        0.296073  -0.082642  -1.703470 ;; 1014
+       -0.004703  -0.006024   1.244894 ;; 1015
+       -1.693792  -0.198696   0.263324 ;; 1016
+       -0.553946  -0.230433  -1.470031 ;; 1017
+       -0.277882  -0.201597   0.582581 ;; 1018
+        0.126633   0.196822   0.850507 ;; 1019
+       -1.396204  -0.132968   0.327243 ;; 1020
+       -0.488055   0.106332  -2.148535 ;; 1021
+       -0.004703  -0.464498   0.806715 ;; 1022
+        0.160967  -0.228087   0.686729 ;; 1023
+        1.434321   0.080128   0.307193 ;; 1024
+        1.021620  -0.126922   0.315253 ;; 1025
+       -1.694107  -0.198696   0.317276 ;; 1026
+        0.306510  -0.151695   0.054136 ;; 1027
+       -0.279596   0.074727   0.688582 ;; 1028
+        0.125243  -0.371379  -0.296442 ;; 1029
+       -0.061740  -0.325364   0.045181 ;; 1030
+        0.363327  -0.247994   0.149043 ;; 1031
+       -0.304678  -0.332774  -0.441886 ;; 1032
+        0.274352   0.286391   0.778669 ;; 1033
+        0.110731  -0.189378   0.670536 ;; 1034
+        0.417818   0.129004  -2.380735 ;; 1035
+        0.223860  -0.100600   0.714890 ;; 1036
+        0.165250  -0.005072   0.723684 ;; 1037
+        1.051116   0.219202   0.271894 ;; 1038
+       -1.592200  -0.142608   0.395578 ;; 1039
+        0.366775  -0.226958  -0.376024 ;; 1040
+       -0.281827  -0.349518  -1.396902 ;; 1041
+       -1.112566  -0.122240   0.299157 ;; 1042
+       -0.375658   0.031416  -2.380329 ;; 1043
+       -0.524300   0.183340  -2.657734 ;; 1044
+        0.262844   0.106704   0.767211 ;; 1045
+        0.187909  -0.236420   0.584024 ;; 1046
+       -0.196151   0.339094   0.832408 ;; 1047
+       -0.429342   0.253283   0.349726 ;; 1048
+        0.084763   0.351249   0.810637 ;; 1049
+        0.278027  -0.169043   0.816981 ;; 1050
+       -0.398634   0.154621  -2.239584 ;; 1051
+       -0.429342  -0.025592   0.349726 ;; 1052
+       -0.003411   0.024838  -0.869267 ;; 1053
+       -0.346291  -0.510440  -2.657734 ;; 1054
+       -0.281827  -0.349518  -1.396902 ;; 1055
+       -0.982968   0.119644   0.267077 ;; 1056
+       -1.032669  -0.125606   0.468638 ;; 1057
+        0.103429   0.101056   0.621000 ;; 1058
+       -0.004703  -0.111877   1.245475 ;; 1059
+       -0.668420   0.241421   0.368433 ;; 1060
+        1.106566  -0.122240   0.299157 ;; 1061
+        0.762312  -0.177569   0.271714 ;; 1062
+       -0.004703   0.176638   1.117921 ;; 1063
+        0.535047  -0.114952  -2.490092 ;; 1064
+       -0.183690  -0.174906   0.682182 ;; 1065
+        0.476459  -0.175349  -2.239584 ;; 1066
+        0.141325   0.083907   1.191943 ;; 1067
+        0.274517   0.174328   0.709547 ;; 1068
+        0.225192   0.455001   0.567794 ;; 1069
+       -0.199228  -0.202933  -1.817734 ;; 1070
+       -0.503632   0.157800  -2.490092 ;; 1071
+        0.336638  -0.112082  -2.376508 ;; 1072
+        0.000196   0.455001   0.208502 ;; 1073
+       -0.061163  -0.227151   0.652815 ;; 1074
+        1.026670  -0.125606   0.468638 ;; 1075
+        0.072879  -0.455001   0.263522 ;; 1076
+        0.048786  -0.227151   0.652815 ;; 1077
+        0.079350  -0.320862   0.591125 ;; 1078
+       -0.375952   0.183340  -2.580805 ;; 1079
+        0.432994   0.253283   0.349726 ;; 1080
+       -0.532518   0.038704  -2.151188 ;; 1081
+       -0.221395   0.070900  -0.157713 ;; 1082
+       -0.006383   0.164144   0.777857 ;; 1083
+        0.331019   0.059176  -1.703318 ;; 1084
+       -0.547783  -0.063284  -2.379029 ;; 1085
+       -0.398634   0.154621  -2.239584 ;; 1086
+       -0.247417  -0.018583   0.736490 ;; 1087
+       -0.212736   0.156781   0.817439 ;; 1088
+       -0.600401  -0.112389  -2.657734 ;; 1089
+       -0.410881  -0.175349  -2.239584 ;; 1090
+       -0.199234  -0.307423   0.965828 ;; 1091
+       -0.223624   0.167094   0.678161 ;; 1092
+       -0.123108  -0.189378   0.670536 ;; 1093
+        0.218047  -0.009455   0.707039 ;; 1094
+       -0.515993  -0.073754  -2.151605 ;; 1095
+       -0.196151   0.339094   0.832408 ;; 1096
+        0.186629  -0.352509  -0.582486 ;; 1097
+       -0.496441   0.020907  -0.645885 ;; 1098
+        0.860904  -0.188340   0.323266 ;; 1099
+       -1.409015  -0.177762   0.310694 ;; 1100
+       -0.578256  -0.281007  -2.490092 ;; 1101
+        0.457519  -0.322318  -1.421651 ;; 1102
+       -0.578256  -0.366436  -2.490092 ;; 1103
+       -0.025673   0.015320  -1.035847 ;; 1104
+       -0.176426  -0.154916   0.664987 ;; 1105
+       -0.551103   0.081069  -2.239584 ;; 1106
+        0.350305  -0.114952  -2.490092 ;; 1107
+       -0.212128   0.047158   1.152124 ;; 1108
+        1.080428  -0.146488   0.293702 ;; 1109
+       -0.423024   0.129004  -2.380735 ;; 1110
+       -1.432687   0.046346   0.291309 ;; 1111
+       -0.867431   0.126253   0.298920 ;; 1112
+       -0.500826  -0.138177  -2.376724 ;; 1113
+        0.186911  -0.115531   0.671183 ;; 1114
+        0.541374  -0.510440  -2.657734 ;; 1115
+       -0.000117   0.124363   0.716293 ;; 1116
+       -0.003321   0.297035   0.748482 ;; 1117
+        1.107094  -0.161996   0.321012 ;; 1118
+        0.019604   0.015320  -1.035847 ;; 1119
+       -0.211933  -0.115309   0.991398 ;; 1120
+        0.087702  -0.392621   0.881072 ;; 1121
+       -0.106377  -0.136226   0.658301 ;; 1122
+       -0.551103   0.081069  -2.376508 ;; 1123
+        1.139702   0.098194   0.241037 ;; 1124
+        0.078877  -0.447118   0.857359 ;; 1125
+       -0.176426  -0.154916   0.664987 ;; 1126
+        0.250491  -0.262176  -1.474398 ;; 1127
+       -0.313445   0.097569   0.535841 ;; 1128
+        1.863162   0.011151   0.281993 ;; 1129
+       -0.711514  -0.241841   0.534120 ;; 1130
+        1.444951  -0.169492   0.404541 ;; 1131
+        1.021620  -0.126922   0.315253 ;; 1132
+        0.145795  -0.307277   0.659792 ;; 1133
+        0.611789  -0.317595  -2.657734 ;; 1134
+       -1.011973   0.186657   0.478340 ;; 1135
+       -0.066785   0.147545  -0.757309 ;; 1136
+        0.386699  -0.161620  -2.149219 ;; 1137
+        0.104054   0.100194  -1.036922 ;; 1138
+        0.672072   0.241421   0.368433 ;; 1139
+       -0.496159  -0.003074  -1.474065 ;; 1140
+        0.446623  -0.349518  -1.386618 ;; 1141
+        0.392635   0.154621  -2.239584 ;; 1142
+       -0.215256  -0.232049   1.119648 ;; 1143
+       -0.372635  -0.226958  -0.376024 ;; 1144
+       -0.186038  -0.155864  -1.474566 ;; 1145
+        0.490090  -0.003074  -1.474065 ;; 1146
+       -0.208615   0.138755   0.016049 ;; 1147
+       -0.503632   0.157800  -2.490092 ;; 1148
+       -0.280881  -0.020381   0.582863 ;; 1149
+        0.454220   0.172566   0.299324 ;; 1150
+       -0.398634   0.154621  -2.376508 ;; 1151
+       -0.410881  -0.175349  -2.376508 ;; 1152
+       -0.307062   0.209797  -1.738257 ;; 1153
+        0.124269   0.081607   0.753362 ;; 1154
+       -1.022322  -0.170440   0.334845 ;; 1155
+       -0.085441  -0.320862   0.591125 ;; 1156
+        0.277723  -0.201597   0.582581 ;; 1157
+       -0.429342   0.253283   0.349726 ;; 1158
+       -0.222979   0.093593   0.036231 ;; 1159
+       -0.549571  -0.112081  -2.376508 ;; 1160
+       -0.228427  -0.320485   0.817189 ;; 1161
+        1.687793  -0.198695   0.263325 ;; 1162
+        0.476459  -0.175349  -2.376508 ;; 1163
+        0.672072  -0.025592   0.667381 ;; 1164
+       -0.342637  -0.112082  -2.376508 ;; 1165
+        0.255782   0.101724  -0.443544 ;; 1166
+        0.061581  -0.325364   0.045181 ;; 1167
+       -0.295912  -0.428765   0.262840 ;; 1168
+        1.025478  -0.168690   0.446304 ;; 1169
+        0.224487   0.093593   0.036231 ;; 1170
+        0.371103  -0.466102  -2.490092 ;; 1171
+        1.679934  -0.249800   0.326872 ;; 1172
+        0.024186  -0.255421   0.651047 ;; 1173
+        0.318294   0.208994   0.718699 ;; 1174
+        1.390206  -0.132967   0.327244 ;; 1175
+       -0.517855  -0.282461  -2.440612 ;; 1176
+       -0.003411  -0.397253  -0.596409 ;; 1177
+       -0.151558  -0.249144   1.164897 ;; 1178
+       -0.004703  -0.310476   1.166222 ;; 1179
+        0.151193  -0.002857   1.221001 ;; 1180
+        0.137876   0.009233   0.606216 ;; 1181
+        0.339516   0.081069  -2.376508 ;; 1182
+        0.158433   0.228042  -0.184624 ;; 1183
+       -0.041635  -0.308574   0.663281 ;; 1184
+        0.172997  -0.240302   0.542395 ;; 1185
+        0.193763  -0.054179   0.757241 ;; 1186
+       -0.547373  -0.510440  -2.580805 ;; 1187
+       -1.592200   0.066441   0.395578 ;; 1188
+        0.543572  -0.112081  -2.376508 ;; 1189
+        0.545104   0.081069  -2.239584 ;; 1190
+        0.459256  -0.081633  -1.703248 ;; 1191
+        0.572257  -0.366436  -2.490092 ;; 1192
+       -0.216154  -0.096090   0.690048 ;; 1193
+        0.997756   0.125139   0.516657 ;; 1194
+       -0.346291  -0.510440  -2.580805 ;; 1195
+        0.311995   0.132416  -0.436828 ;; 1196
+        0.112560  -0.170648   0.588264 ;; 1197
+        0.543572  -0.112081  -2.376508 ;; 1198
+        0.290415   0.152794  -1.576903 ;; 1199
+       -0.184346   0.022792  -1.516799 ;; 1200
+       -0.349322  -0.281008  -2.490092 ;; 1201
+        0.339609  -0.286863  -0.369237 ;; 1202
+       -0.125402  -0.371379  -0.296442 ;; 1203
+       -0.136630   0.081607   0.753362 ;; 1204
+       -0.000117   0.124363   0.716293 ;; 1205
+       -0.272784   0.286391   0.778669 ;; 1206
+       -0.003321   0.249365   0.537429 ;; 1207
+       -0.184346   0.022792  -1.516799 ;; 1208
+       -0.230581   0.061547  -0.296461 ;; 1209
+       -0.547373  -0.510440  -2.657734 ;; 1210
+        1.025478  -0.168690   0.446304 ;; 1211
+       -1.592200  -0.142608   0.395578 ;; 1212
+       -1.318437  -0.183968   0.422358 ;; 1213
+       -0.004703   0.208596   1.023260 ;; 1214
+       -1.450377   0.048735   0.306485 ;; 1215
+       -0.465325  -0.081632  -1.703248 ;; 1216
+        0.535047   0.095329  -2.490092 ;; 1217
+        0.206975   0.232441   0.047762 ;; 1218
+       -0.188068  -0.236420   0.584024 ;; 1219
+        0.320101   0.113865   0.046509 ;; 1220
+       -0.080550  -0.296013   0.679862 ;; 1221
+       -0.078706   0.186885  -0.751402 ;; 1222
+        1.173636   0.164760   0.476047 ;; 1223
+        0.205846  -0.232049   1.119648 ;; 1224
+        0.581769   0.084994  -1.726342 ;; 1225
+       -0.617788  -0.317595  -2.657734 ;; 1226
+        1.033955   0.141180   0.235471 ;; 1227
+       -0.106059   0.163834   0.872885 ;; 1228
+       -0.194691   0.102956   0.833340 ;; 1229
+       -1.730492   0.042834   0.378633 ;; 1230
+        1.116406   0.125169   0.534982 ;; 1231
+       -0.429342  -0.025592   0.349726 ;; 1232
+       -0.275969  -0.335526  -0.296344 ;; 1233
+        0.214307  -0.204496   0.978502 ;; 1234
+       -0.332306  -0.392562  -0.730315 ;; 1235
+       -1.011973   0.186657   0.478340 ;; 1236
+        0.369953   0.183340  -2.580805 ;; 1237
+        0.277723  -0.201597   0.582581 ;; 1238
+       -0.182703  -0.003543  -1.474674 ;; 1239
+        0.336638  -0.112082  -2.239584 ;; 1240
+       -0.083195   0.351249   0.810637 ;; 1241
+       -0.208197   0.177189  -0.610215 ;; 1242
+        0.374776   0.047800  -0.375852 ;; 1243
+        0.340292  -0.510440  -2.657734 ;; 1244
+        0.158433   0.082376  -0.277381 ;; 1245
+     ) ;; vertices
+
+    (normals
+       0.809961  0.445021  0.381939
+      -0.985839 -0.131962  0.103183
+       0.293863  0.378674  0.877621
+       0.035615 -0.172124 -0.984405
+       0.278176 -0.960509 -0.000000
+      -0.918943 -0.070193 -0.388043
+       0.285836  0.101688  0.952849
+      -0.270699 -0.736015 -0.620441
+      -0.541612 -0.074343 -0.837306
+      -0.062197 -0.666707 -0.742698
+      -0.800378 -0.507096  0.319681
+      -0.436293  0.026551 -0.899380
+      -0.157323 -0.310953  0.937284
+       0.323740 -0.334269  0.885098
+       0.687521 -0.676199 -0.264687
+      -0.133274  0.977264  0.164830
+      -0.265206 -0.738304 -0.620075
+      -0.797845  0.412366  0.439741
+      -0.120945  0.712394  0.691244
+       0.023347 -0.502640  0.864162
+      -0.543474  0.774346  0.324015
+       0.373089 -0.757775  0.535295
+      -0.562609 -0.660878 -0.496658
+      -0.271462 -0.231025 -0.934294
+      -0.824458  0.509964 -0.245216
+      -0.329386  0.210669  0.920377
+      -0.098148 -0.421033  0.901700
+      -0.268899  0.962615  0.031678
+       0.866482 -0.168981 -0.469649
+      -0.194769  0.946043  0.258889
+       0.160192  0.974151  0.159124
+       0.751152  0.303781  0.586047
+       0.776299 -0.489639  0.396924
+       0.695303  0.714316  0.079226
+      -0.796655  0.496933  0.344005
+      -0.698386  0.521317  0.490341
+       0.746574 -0.493728  0.445845
+      -0.479019 -0.402509 -0.780053
+       0.998810  0.048311  0.000366
+       0.092349  0.973724 -0.208106
+       0.373089 -0.757775  0.535295
+      -0.780908 -0.534684  0.322855
+      -0.255531 -0.964415 -0.067537
+      -0.220099  0.959319  0.176641
+       0.908475  0.028657  0.416913
+       0.701621  0.712363 -0.014893
+       0.997528 -0.070223 -0.000000
+      -0.255104 -0.414624  0.873470
+       0.765526  0.493820 -0.412366
+       0.298349 -0.328715 -0.896054
+      -0.033174  0.376873 -0.925657
+      -0.800378 -0.507096  0.319681
+       0.545946  0.052278  0.836177
+       0.501938 -0.434126  0.748039
+      -0.836116 -0.476394 -0.271889
+      -0.779168 -0.193365 -0.596179
+       0.445448  0.678365  0.584246
+       0.881191  0.320627 -0.347392
+      -0.443159 -0.787561 -0.428114
+       0.198645  0.722129 -0.662587
+      -0.236702  0.965514 -0.108097
+      -0.231544 -0.833247  0.502029
+       0.028596  0.707389  0.706229
+      -0.254311 -0.391736 -0.884213
+      -0.813074  0.506333  0.287210
+       0.889859  0.214728 -0.402509
+       0.937651  0.235481 -0.255623
+      -0.284982 -0.120701 -0.950896
+       0.217200 -0.723624  0.655080
+      -0.336528  0.030519  0.941160
+       0.906064  0.423109 -0.000000
+       0.027345  0.167608  0.985443
+       0.373089 -0.757775 -0.535295
+       0.196539  0.080630 -0.977142
+       0.877468  0.126102  0.462722
+       0.296793 -0.656667 -0.693289
+      -0.768914  0.492508 -0.407605
+      -0.058657  0.181829 -0.981567
+      -0.820124 -0.473159  0.321665
+       0.070864  0.707144  0.703482
+       0.751152  0.303842 -0.586016
+      -0.236579  0.954222  0.182806
+       0.776299 -0.489639 -0.396924
+       0.027345  0.167608 -0.985443
+      -0.232002 -0.361095 -0.903195
+      -0.269936  0.035920 -0.962188
+       0.258827  0.806513 -0.531510
+      -0.274392  0.915006 -0.295633
+       0.302774  0.246956 -0.920499
+       0.028596  0.707389 -0.706229
+       0.929838  0.004578 -0.367931
+      -0.284982 -0.120701  0.950896
+       0.026185 -0.158483  0.986999
+       0.876339  0.162236  0.453505
+      -0.048769 -0.980712 -0.189215
+       0.292611  0.890805 -0.347514
+      -0.372539 -0.917295  0.140507
+      -0.541612 -0.074343  0.837306
+      -0.940855  0.338786 -0.000000
+       0.055879 -0.990570  0.125034
+      -0.258431 -0.922178  0.287729
+       0.231544 -0.934324 -0.270943
+      -0.893857  0.013031 -0.448134
+       0.929685 -0.368328 -0.000000
+      -0.475936 -0.560503 -0.677694
+      -0.957884 -0.287057  0.000275
+       0.607654  0.587725  0.534104
+      -0.574633 -0.818384 -0.000000
+       0.607990  0.573687  0.548784
+      -0.743492  0.547594 -0.383831
+      -0.231544 -0.833247 -0.502029
+      -0.517624  0.573077  0.635304
+      -0.522355 -0.784173  0.334880
+       0.833155 -0.476424  0.280770
+      -0.867306  0.157506 -0.472152
+       0.457015  0.398022  0.795404
+      -0.811945 -0.526170 -0.252632
+      -0.258309 -0.761101  0.594928
+       0.578600  0.485488  0.655354
+      -0.856319  0.284707 -0.430799
+       0.578600 -0.485488  0.655354
+      -0.847560 -0.263222  0.460768
+       0.540300  0.612751  0.576678
+       0.563555  0.145299  0.813166
+      -0.760002  0.523453  0.385174
+       0.225013 -0.003052  0.974334
+      -0.698386  0.521317 -0.490341
+       0.132176 -0.924314  0.357952
+      -0.141911  0.989868 -0.000000
+      -0.536973 -0.722068 -0.436110
+       0.829585 -0.017090  0.558092
+       0.856746 -0.200415 -0.475143
+      -0.979827 -0.199683 -0.000000
+       0.671957  0.663961 -0.327952
+       0.044465  0.881710  0.469619
+      -0.686026 -0.686453  0.241005
+       0.188086 -0.075808 -0.979217
+      -0.673391  0.628163  0.389752
+       0.203436 -0.931883  0.300241
+      -0.891049  0.453902 -0.000000
+       0.160192  0.974151  0.159124
+      -0.801538  0.408307  0.436750
+      -0.608020  0.607715  0.510819
+      -0.079470 -0.765130 -0.638905
+      -0.707663  0.704276 -0.056276
+       0.030152  0.558306  0.829066
+      -0.832392  0.554155 -0.000061
+       0.234657 -0.926542 -0.293924
+      -0.053804 -0.471389  0.880245
+       0.782311 -0.478225  0.399060
+      -0.814417  0.108341 -0.570025
+      -0.300882  0.888668 -0.345988
+      -0.057314 -0.557909  0.827876
+      -0.132878 -0.285165  0.949187
+       0.339213 -0.125340  0.932279
+       0.325022  0.337168  0.883541
+       0.791131 -0.522172 -0.318430
+       0.092349  0.973724  0.208106
+      -0.836909  0.423078  0.347209
+      -0.250832 -0.934751  0.251564
+       0.166906 -0.977508 -0.128727
+      -0.371471  0.803369  0.465377
+       0.198645  0.722129 -0.662587
+       0.055788 -0.990448 -0.125889
+       0.502304  0.241279 -0.830317
+       0.302774  0.246956  0.920499
+       0.196539  0.080630  0.977142
+      -0.791650 -0.535569  0.293985
+      -0.258431 -0.922178 -0.287729
+      -0.340953  0.074221 -0.937132
+      -0.479019 -0.402509 -0.780053
+      -0.718802  0.601733 -0.348125
+       0.791131 -0.522172  0.318430
+      -0.795312 -0.516098  0.317911
+       0.414258  0.003357 -0.910123
+      -0.194769  0.946043  0.258889
+       0.098514 -0.235420  0.966857
+      -0.391858  0.384869 -0.835627
+      -0.760521  0.413648 -0.500473
+       0.607654  0.587725  0.534104
+       0.414258  0.003357  0.910123
+      -0.930998 -0.310099 -0.192480
+      -0.983428 -0.120914 -0.135014
+      -0.196570  0.231605  0.952727
+       0.217811  0.917508  0.332743
+       0.261544  0.092349 -0.960753
+       0.133824  0.376171  0.916807
+       0.908475  0.028657  0.416913
+      -0.946562 -0.139592  0.290658
+       0.863857  0.503464 -0.016236
+      -0.782067 -0.279885  0.556780
+      -0.212867 -0.658986 -0.721366
+       0.231544 -0.934324  0.270943
+       0.209326 -0.724876  0.656270
+      -0.562609  0.660878 -0.496658
+       0.765526  0.493820  0.412366
+      -0.120975  0.712394 -0.691244
+      -0.615772 -0.732871  0.289285
+      -0.058840 -0.239998 -0.968963
+      -0.816492 -0.475448 -0.327433
+      -0.608020  0.607715 -0.510819
+       0.765526  0.493820  0.412366
+      -0.479171  0.167577  0.861538
+      -0.270699 -0.736015 -0.620441
+       0.490188 -0.185369 -0.851650
+      -0.845515  0.408246  0.344066
+      -0.352611 -0.364910 -0.861660
+      -0.259407  0.504379 -0.823542
+       0.741630  0.534867 -0.404767
+      -0.323435 -0.946226 -0.000000
+       0.937040  0.115696 -0.329417
+      -0.015015 -0.584796 -0.811029
+      -0.371471  0.803369  0.465377
+       0.858669  0.507859 -0.068911
+       0.776299 -0.489639 -0.396924
+      -0.370800  0.369579  0.851985
+       0.217200 -0.723624 -0.655080
+       0.741630  0.534867 -0.404767
+      -0.157323 -0.310953 -0.937284
+       0.997314  0.073000 -0.000000
+       0.251778  0.045686  0.966674
+      -0.824458  0.509964  0.245216
+      -0.469497 -0.771996 -0.428419
+      -0.239937 -0.841609 -0.483810
+      -0.791650 -0.535569 -0.293985
+      -0.310617  0.935545 -0.168035
+      -0.770714 -0.485855 -0.412152
+       0.120518  0.943510  0.308542
+      -0.885250  0.327464 -0.330241
+      -0.258309 -0.761101 -0.594928
+      -0.197699 -0.490646 -0.848598
+       0.832881 -0.493515  0.250404
+       0.154271  0.919797 -0.360759
+      -0.886898  0.164220  0.431715
+       0.917875 -0.353069  0.181158
+       0.229041  0.965728  0.122013
+      -0.380566 -0.465224 -0.799188
+      -0.779229 -0.625904 -0.031648
+      -0.918943 -0.070193  0.388043
+       0.029847  0.707419  0.706137
+       0.210974  0.975097  0.068026
+       0.361461  0.152165  0.919858
+      -0.250832 -0.934751 -0.251564
+       0.906735  0.036134  0.420118
+      -0.062197 -0.666707  0.742698
+       0.221809 -0.891263 -0.395459
+       0.194281  0.772546 -0.604450
+      -0.608020  0.607715 -0.510819
+      -0.834803  0.494675  0.241523
+      -0.581866  0.635487  0.507492
+      -0.223853  0.928404  0.296518
+      -0.578600  0.485488  0.655354
+      -0.983978  0.178167  0.000641
+      -0.280038  0.175115  0.943876
+       0.229041  0.965728 -0.122013
+       0.607990 -0.573687  0.548784
+       0.166906 -0.977508  0.128727
+      -0.982604 -0.002930 -0.185583
+       0.607654  0.587725 -0.534104
+       0.599780  0.471419 -0.646504
+      -0.135075  0.990814  0.001190
+      -0.516465  0.148473  0.843318
+      -0.605731 -0.278939  0.745140
+       0.202857 -0.961028 -0.187780
+      -0.310587  0.815577 -0.488144
+       0.279855 -0.723014  0.631550
+       0.563555  0.145299 -0.813166
+      -0.770714 -0.485855  0.412183
+      -0.049013  0.319437  0.946318
+      -0.365459  0.140782 -0.920103
+      -0.301981 -0.942351  0.143956
+       0.336131  0.285409  0.897519
+      -0.386853 -0.407849  0.827021
+      -0.466872 -0.884304 -0.000000
+      -0.707663  0.704276  0.056276
+      -0.789727 -0.004425 -0.613392
+      -0.855953 -0.085574 -0.509873
+       0.154271  0.919797  0.360759
+       0.092349  0.973724  0.208106
+       0.381481 -0.806604  0.451491
+      -0.818476 -0.473739 -0.324961
+       0.865993 -0.175665  0.468123
+       0.740471  0.496292  0.453139
+       0.692099 -0.483963  0.535447
+       0.154271  0.919797 -0.360759
+       0.258827  0.806513  0.531510
+      -0.475845  0.340098 -0.811090
+      -0.278451 -0.817103  0.504746
+       0.242683  0.033845 -0.969512
+       0.765526  0.493820  0.412366
+      -0.057314 -0.557909 -0.827876
+       0.906735  0.036134 -0.420118
+       0.217811  0.917508 -0.332743
+      -0.308390  0.784478  0.538011
+       0.765526  0.493820 -0.412366
+      -0.423078  0.906064  0.000366
+      -0.388653  0.291971  0.873867
+      -0.015412  0.365215  0.930754
+      -0.962432  0.271432 -0.000000
+       0.838710 -0.024964  0.543962
+      -0.608417  0.793603  0.000488
+       0.092349  0.973724  0.208106
+      -0.599628 -0.009400 -0.800195
+       0.857631 -0.192175 -0.476943
+       0.028291 -0.260445  0.965056
+       0.838710 -0.024964 -0.543962
+       0.740471  0.496353 -0.453047
+       0.832881 -0.493515 -0.250404
+      -0.239937 -0.841609 -0.483810
+      -0.820124 -0.473159 -0.321665
+      -0.987518  0.006836 -0.157201
+      -0.698141 -0.714927 -0.037843
+       0.154271  0.919797  0.360759
+      -0.202826  0.722831 -0.660543
+      -0.888363  0.025910 -0.458357
+       0.467330 -0.473342  0.746635
+       0.000000 -0.826594 -0.562761
+       0.035615 -0.172124  0.984405
+       0.882717 -0.236396 -0.406018
+      -0.085238 -0.875973 -0.474715
+      -0.734092  0.385723  0.558824
+       0.240974 -0.660634  0.710959
+      -0.236702  0.965514  0.108097
+       0.035768 -0.194800  0.980163
+       0.081362  0.988281  0.128971
+       0.028596  0.707389 -0.706229
+       0.238746  0.716727  0.655171
+       0.899838  0.436140 -0.000000
+      -0.212867 -0.658986 -0.721366
+       0.889859  0.214728  0.402509
+       0.262795 -0.943999 -0.199438
+      -0.516465  0.148473  0.843318
+       0.652303  0.614460  0.443739
+       0.882717 -0.236396  0.406018
+       0.422742 -0.312540  0.850612
+       0.054903 -0.219550 -0.974029
+      -0.608020  0.607715  0.510819
+       0.942961 -0.332865  0.000183
+      -0.269936  0.035920  0.962188
+       0.789605 -0.157994  0.592883
+      -0.816492 -0.475448  0.327433
+      -0.440138 -0.584918 -0.681265
+      -0.121586  0.874874  0.468795
+       0.217811  0.917508  0.332743
+       0.293863  0.378674  0.877621
+       0.697501 -0.503281 -0.510056
+       0.927152  0.025025 -0.373821
+      -0.522355 -0.784173 -0.334880
+      -0.328043 -0.892972  0.308176
+       0.067354  0.997711 -0.000000
+       0.584552  0.574847 -0.572558
+       0.381481 -0.806604  0.451491
+      -0.801538  0.408307 -0.436750
+       0.065310 -0.770989  0.633442
+       0.185644  0.965667 -0.181616
+       0.154271  0.919797  0.360759
+      -0.079470 -0.765130  0.638905
+       0.399976 -0.668844  0.626576
+       0.876339  0.162236  0.453505
+       0.360088  0.307474 -0.880764
+       0.777642 -0.573290  0.258065
+      -0.279244 -0.940611  0.192969
+       0.926756 -0.322275 -0.192846
+      -0.380566 -0.465224  0.799188
+       0.285836  0.101688  0.952849
+       0.132176 -0.924314 -0.357952
+       0.217200 -0.723624 -0.655080
+       0.829554 -0.019501 -0.558031
+      -0.803949  0.389935  0.448988
+       0.415937  0.054720 -0.907712
+       0.492447  0.054720  0.868587
+      -0.845515  0.408246  0.344066
+      -0.516465  0.148473 -0.843318
+      -0.565722  0.737907 -0.367962
+      -0.278451 -0.817103  0.504746
+       0.671957  0.663961  0.327952
+      -0.820124 -0.473159  0.321665
+      -0.500748  0.295053 -0.813715
+      -0.562609  0.660878 -0.496658
+      -0.265206 -0.738304  0.620075
+      -0.310617  0.935545  0.168035
+       0.527146 -0.754357  0.391186
+      -0.121586  0.874874 -0.468795
+      -0.536973 -0.722068  0.436110
+       0.664235 -0.724601 -0.183538
+      -0.542344 -0.468368  0.697439
+       0.826624 -0.562731 -0.000549
+       0.525468  0.023194 -0.850490
+       0.065310 -0.770989 -0.633442
+       0.116062  0.181280 -0.976531
+      -0.795312 -0.516098  0.317911
+       0.770470 -0.447645  0.453841
+      -0.924223  0.105869  0.366832
+      -0.722922  0.530045 -0.443159
+      -0.767815 -0.640614 -0.000000
+       0.607654  0.587725 -0.534104
+       0.695303  0.714316 -0.079226
+      -0.743492  0.547594  0.383831
+       0.701621  0.712363 -0.014893
+       0.264840  0.432203 -0.861995
+      -0.479019 -0.402478  0.780053
+       0.857631 -0.192175 -0.476943
+      -0.328867 -0.689413  0.645375
+       0.829585 -0.017090 -0.558092
+       0.285867  0.101688 -0.952849
+      -0.615253 -0.785058  0.071474
+      -0.562609 -0.660878 -0.496658
+      -0.814417 -0.478622  0.327982
+      -0.329386  0.210669 -0.920377
+       0.701621  0.712363  0.014893
+      -0.796655  0.496933 -0.344005
+      -0.521958 -0.567492  0.636769
+       0.865993 -0.175665 -0.468123
+       0.210974  0.975097 -0.068026
+      -0.158727 -0.225227 -0.961272
+       0.867489 -0.492019  0.073122
+      -0.940855  0.338786 -0.000000
+       0.929685 -0.368328 -0.000000
+       0.139958 -0.544786  0.826807
+      -0.578600  0.485488  0.655354
+      -0.962127  0.083499  0.259438
+      -0.241646 -0.943602 -0.226203
+       0.305918  0.213141  0.927854
+      -0.033174  0.376873  0.925657
+       0.778252  0.542589 -0.316019
+       0.869350  0.494125  0.000031
+      -0.440138 -0.584918  0.681265
+      -0.542344 -0.468368 -0.697439
+       0.247353 -0.951598  0.182287
+      -0.522355 -0.784173 -0.334880
+      -0.232246 -0.972625  0.002594
+      -0.310953 -0.139134 -0.940153
+       0.695303  0.714316 -0.079226
+       0.285806  0.257759  0.922941
+      -0.581866  0.635487 -0.507492
+       0.508133 -0.528733  0.679861
+      -0.698386  0.521317 -0.490341
+       0.279855 -0.723014  0.631550
+      -0.835597 -0.011780 -0.549181
+      -0.098148 -0.421033  0.901700
+       0.652303  0.614460 -0.443739
+       0.035768 -0.194800 -0.980163
+      -0.795312 -0.516098 -0.317911
+      -0.768914  0.492508  0.407605
+      -0.239937 -0.841609  0.483810
+       0.186254  0.266945  0.945524
+       0.899838  0.436140 -0.000000
+       0.765587 -0.435560 -0.473434
+      -0.707663  0.704276  0.056276
+      -0.434400  0.414991 -0.799402
+      -0.716483  0.697562  0.000519
+       0.765526  0.493820 -0.412366
+      -0.812220 -0.583300 -0.000000
+       0.612507 -0.725181 -0.314463
+      -0.475936 -0.560503  0.677694
+      -0.370800  0.369518 -0.852016
+      -0.328867 -0.689413 -0.645375
+       0.261544  0.092349  0.960753
+       0.695303  0.714316  0.079226
+      -0.811945 -0.526170 -0.252632
+      -0.395611  0.516037  0.759697
+       0.509507 -0.284494 -0.812037
+      -0.516465  0.148473 -0.843318
+      -0.559862 -0.742210 -0.368297
+      -0.370464  0.483230  0.793207
+      -0.258309 -0.761101 -0.594928
+       0.000000 -0.678945  0.734153
+       0.467330 -0.473342 -0.746635
+       0.926878  0.099643 -0.361888
+      -0.371471  0.803369 -0.465377
+       0.185644  0.965667  0.181616
+      -0.479171  0.167577 -0.861538
+      -0.782067 -0.279885 -0.556780
+       0.132176 -0.924314 -0.357952
+      -0.521958 -0.567492 -0.636769
+       0.857631 -0.192175  0.476943
+      -0.424604 -0.796045 -0.431288
+      -0.137150  0.236579  0.961852
+       0.117283 -0.938688  0.324107
+       0.551042 -0.533952 -0.641255
+       0.310800  0.016511 -0.950316
+       0.202857 -0.961028  0.187780
+      -0.562609  0.660878 -0.496658
+      -0.270699 -0.736015  0.620441
+      -0.364452 -0.880825 -0.302133
+       0.293863  0.378674 -0.877621
+       0.829585 -0.017090 -0.558092
+       0.701621  0.712363  0.014893
+       0.856746 -0.200415 -0.475143
+       0.782311 -0.478225 -0.399060
+       0.809961  0.445021 -0.381939
+      -0.231544 -0.833247 -0.502029
+      -0.015015 -0.584796  0.811029
+       0.194281  0.772546  0.604450
+       0.081362  0.988281  0.128971
+      -0.780908 -0.534684  0.322855
+       0.867489 -0.492019 -0.073122
+       0.926756  0.099612  0.362194
+       0.198645  0.722129  0.662587
+      -0.608020  0.607715  0.510819
+      -0.310953 -0.139134  0.940153
+      -0.370495  0.483261 -0.793176
+       0.809961  0.445021 -0.381939
+       0.931822  0.107791  0.346446
+       0.540300  0.612751  0.576678
+       0.258827  0.806513  0.531510
+      -0.870510  0.007447 -0.492050
+      -0.771569 -0.468276  0.430525
+      -0.722922  0.530045  0.443159
+       0.776299 -0.489639  0.396924
+      -0.786676  0.479202 -0.389172
+       0.070864  0.707144 -0.703482
+       0.805811  0.592120  0.002045
+      -0.196570  0.231605 -0.952727
+       0.198645  0.722129  0.662587
+       0.765526  0.493820 -0.412366
+       0.935575  0.272958  0.223914
+      -0.015412  0.365215  0.930754
+      -0.331370 -0.930387 -0.156560
+       0.808710  0.588153  0.000092
+      -0.246712  0.406201 -0.879818
+       0.242683  0.033845 -0.969512
+       0.777642 -0.573290 -0.258065
+      -0.331370 -0.930387  0.156560
+      -0.133244  0.977660 -0.162481
+       0.065310 -0.770989 -0.633442
+       0.747887 -0.086703 -0.658101
+      -0.239937 -0.841609  0.483810
+      -0.605701 -0.279061 -0.745109
+       0.829554 -0.019501  0.558031
+       0.562609 -0.660878 -0.496658
+      -0.057314 -0.557909 -0.827876
+       0.070864  0.707144 -0.703482
+       0.996582 -0.082430  0.000549
+      -0.955535  0.198279  0.218238
+      -0.326121  0.011658  0.945219
+       0.828028 -0.078310  0.555162
+      -0.885250  0.327464  0.330241
+       0.776299 -0.489639 -0.396924
+       0.862667 -0.494919 -0.104007
+       0.576861 -0.816828 -0.000000
+      -0.212867 -0.658986  0.721366
+      -0.328043 -0.892972 -0.308176
+      -0.137150  0.236579 -0.961852
+      -0.913572 -0.406629 -0.000092
+      -0.859706  0.509537 -0.035554
+      -0.336528  0.030519  0.941160
+       0.381481 -0.806604 -0.451491
+      -0.845515  0.408246 -0.344066
+       0.336100  0.285501 -0.897488
+       0.490188 -0.185369  0.851650
+       0.092349  0.973724  0.208106
+       0.501938 -0.434126 -0.748009
+      -0.202826  0.722831 -0.660543
+      -0.132878 -0.285165 -0.949187
+       0.877834  0.125980 -0.462050
+       0.747429  0.541887 -0.384259
+       0.860897 -0.497208 -0.107852
+       0.415937  0.054720  0.907712
+      -0.391858  0.384869  0.835627
+      -0.301981 -0.942351 -0.143956
+      -0.276193  0.452315  0.847987
+      -0.120975  0.712394 -0.691244
+      -0.316660 -0.935270  0.157933
+       0.360088  0.307474  0.880764
+       0.977722  0.209845  0.000183
+       0.492447  0.054720 -0.868587
+       0.264840  0.432203  0.861995
+      -0.885342 -0.311258 -0.345286
+      -0.423536 -0.901059  0.092990
+      -0.782067 -0.279885  0.556780
+      -0.113315 -0.575823 -0.809656
+      -0.542344 -0.480575  0.689077
+       0.520768 -0.182287  0.833979
+      -0.258309 -0.761101  0.594928
+      -0.310953 -0.139134  0.940153
+      -0.326121  0.011658 -0.945219
+       0.407392 -0.009919  0.913175
+       0.578600 -0.485488  0.655354
+      -0.800378 -0.507096 -0.319681
+       0.908475  0.028657 -0.416913
+      -0.984649 -0.103549  0.140385
+      -0.569323 -0.362377  0.737907
+       0.765526  0.493820  0.412366
+      -0.434400  0.414991 -0.799402
+       0.915555  0.333445 -0.224738
+       0.601581  0.730583 -0.322947
+       0.251778  0.045686 -0.966674
+       0.120518  0.943510 -0.308542
+       0.381481 -0.806604 -0.451491
+       0.777642 -0.573290  0.258065
+      -0.859340  0.418043 -0.294443
+      -0.062197 -0.666707 -0.742698
+       0.249702 -0.962493 -0.105899
+      -0.185644  0.181219 -0.965728
+      -0.276681  0.758599  0.589862
+       0.185644  0.965667 -0.181616
+       0.028596  0.707389 -0.706229
+      -0.946623 -0.139470 -0.290506
+       0.323740 -0.334269 -0.885098
+       0.382000 -0.159673 -0.910245
+       0.092349  0.973724 -0.208106
+       0.857631 -0.192175  0.476943
+       0.803095  0.473006 -0.362255
+       0.829585 -0.017090  0.558092
+       0.027528 -0.996582 -0.077670
+       0.537095  0.843501  0.000122
+      -0.270302  0.306619 -0.912625
+      -0.768914  0.492508 -0.407605
+      -0.847560 -0.263222 -0.460768
+      -0.924406  0.100772  0.367779
+       0.191076 -0.880978  0.432783
+       0.865993 -0.175665 -0.468123
+       0.866482 -0.168981  0.469649
+       0.120518  0.943510 -0.308542
+      -0.310953 -0.139134 -0.940153
+      -0.593646 -0.421613 -0.685385
+       0.058138  0.087405  0.994446
+       0.339213 -0.125340 -0.932279
+      -0.924223  0.105869 -0.366832
+      -0.522355 -0.784173  0.334880
+       0.810358 -0.444227 -0.382031
+       0.525468  0.023194  0.850490
+      -0.254311 -0.391736 -0.884213
+       0.229041  0.965728  0.122013
+       0.790063 -0.428266  0.438551
+      -0.279244 -0.940611 -0.192969
+      -0.436293  0.026551  0.899380
+       0.748619  0.550188 -0.369915
+      -0.328867 -0.689413  0.645375
+       0.770470 -0.447645 -0.453841
+      -0.760002  0.523453 -0.385174
+       0.194281  0.772546 -0.604450
+      -0.893857  0.013031  0.448134
+      -0.393872  0.876675 -0.276131
+      -0.141911  0.989868 -0.000000
+      -0.331614 -0.891507 -0.308542
+       0.262795 -0.943999  0.199438
+      -0.048769 -0.980712 -0.189215
+      -0.824976  0.543199 -0.155950
+      -0.779229 -0.625904  0.031648
+      -0.835261  0.045442  0.547960
+       0.765526  0.493820 -0.412366
+       0.973266  0.229621 -0.000000
+       0.264840  0.432203  0.861995
+       0.860897 -0.497208  0.107852
+       0.562609 -0.660878 -0.496658
+       0.274667 -0.961516  0.000397
+      -0.202826  0.722831  0.660543
+      -0.223853  0.928404 -0.296518
+      -0.255104 -0.414624  0.873470
+      -0.707205 -0.468734  0.529252
+      -0.480148 -0.877163 -0.000031
+      -0.682546  0.715171 -0.150456
+      -0.878780  0.356639  0.316996
+       0.132176 -0.924314  0.357952
+       0.697501  0.503281 -0.510056
+       0.422742 -0.312540 -0.850612
+       0.238746  0.716727  0.655171
+       0.192206 -0.314310 -0.929624
+       0.703665 -0.705679 -0.082736
+       0.313425 -0.017975  0.949431
+       0.000000 -0.677236  0.735740
+       0.186254  0.267037 -0.945494
+      -0.835261  0.045442 -0.547960
+       0.502304  0.241279  0.830317
+       0.776299 -0.489639  0.396924
+      -0.909421  0.304788 -0.282907
+       0.741630  0.534867  0.404767
+      -0.158727 -0.225227  0.961272
+      -0.434400  0.414991  0.799402
+       0.829554 -0.019501 -0.558031
+       0.278787 -0.168798  0.945372
+      -0.841212  0.415387 -0.346019
+       0.279855 -0.723014 -0.631550
+      -0.068239  0.072451  0.995025
+      -0.878780  0.356639 -0.316996
+       0.694174  0.385723  0.607715
+       0.395459 -0.851527 -0.344157
+       0.969176 -0.246315  0.000153
+      -0.304971 -0.098483 -0.947233
+       0.975158  0.221412  0.000549
+       0.251778  0.045686 -0.966674
+       0.285867  0.101688 -0.952849
+      -0.544206 -0.827448 -0.138279
+       0.628498  0.777795 -0.000000
+       0.278787 -0.168798 -0.945372
+      -0.098148 -0.421033 -0.901700
+      -0.542344 -0.480575  0.689077
+      -0.292886 -0.300058  0.907804
+      -0.310587  0.815577  0.488144
+      -0.364452 -0.880825  0.302133
+      -0.885342 -0.311258  0.345286
+      -0.276681  0.758599 -0.589862
+      -0.098148 -0.421033  0.901700
+       0.279855 -0.723014 -0.631550
+      -0.685568  0.527909  0.501236
+      -0.299936 -0.163732 -0.939787
+       0.123875 -0.951781  0.280557
+      -0.271462 -0.231025  0.934294
+      -0.818476 -0.473739  0.324961
+       0.399976 -0.668844  0.626576
+      -0.771569 -0.468276 -0.430525
+      -0.985839 -0.131962 -0.103183
+       0.862056  0.450942 -0.231178
+       0.081362  0.988281 -0.128971
+       0.321299 -0.210364  0.923307
+      -0.300882  0.888668  0.345988
+      -0.202826  0.722831  0.660543
+      -0.992553 -0.121616 -0.000000
+       0.202857 -0.961028 -0.187780
+      -0.232246 -0.972625 -0.002594
+       0.000000  0.678945  0.734153
+      -0.760002  0.523453  0.385174
+       0.188086 -0.075808  0.979217
+      -0.723045  0.690756 -0.000000
+      -0.371471  0.803369 -0.465377
+       0.000000  0.603015 -0.797693
+      -0.859432 -0.495682  0.125004
+       0.321299 -0.210364 -0.923307
+       0.652303  0.614460  0.443739
+       0.044465  0.881710  0.469619
+       0.998810  0.048311  0.000366
+      -0.591632 -0.116733 -0.797693
+       0.937040  0.115696  0.329417
+       0.375988  0.926603 -0.000000
+       0.407392 -0.009919 -0.913175
+      -0.843196  0.339183 -0.417005
+      -0.254311 -0.391736 -0.884213
+      -0.698172 -0.714896  0.037782
+       0.510300 -0.512070 -0.690878
+      -0.133244  0.977660 -0.162481
+      -0.194769  0.946043 -0.258889
+       0.242683  0.033845  0.969512
+       0.790063 -0.428266 -0.438551
+       0.601581  0.730583  0.322947
+       0.862667 -0.494919  0.104007
+       0.944853 -0.027802  0.326273
+       0.894864 -0.048708  0.443617
+      -0.333567 -0.180456 -0.925260
+       0.947996  0.016114 -0.317850
+       0.858669  0.507859  0.068911
+      -0.139805 -0.143651  0.979675
+      -0.424604 -0.796045 -0.431288
+       0.251534  0.146641  0.956664
+       0.833155 -0.476424  0.280770
+       0.395459 -0.851527  0.344157
+      -0.176519  0.398175  0.900143
+      -0.068239  0.072451 -0.995025
+      -0.270394 -0.841700  0.467299
+       0.791131 -0.522172  0.318430
+       0.192206 -0.314310  0.929624
+       0.291879  0.889279  0.352031
+       0.230110 -0.938810  0.256172
+      -0.058840 -0.239998  0.968963
+      -0.232002 -0.361095  0.903195
+       0.896115  0.194464 -0.398907
+      -0.698386  0.521317  0.490341
+      -0.581866  0.635487  0.507492
+       0.026185 -0.158483 -0.986999
+       0.929838  0.004578  0.367931
+      -0.139805 -0.143651 -0.979675
+       0.937620  0.235481  0.255654
+      -0.201331  0.791406  0.577136
+       0.234657 -0.926542  0.293924
+      -0.480148 -0.877163 -0.000031
+       0.741630  0.534867  0.404767
+       0.305918  0.213141 -0.927854
+      -0.018891 -0.169195 -0.985382
+       0.765587 -0.435560  0.473434
+      -0.574786 -0.566759  0.590228
+      -0.274392  0.915006 -0.295633
+       0.230110 -0.938810 -0.256172
+       0.509507 -0.284494  0.812037
+      -0.270699 -0.736015  0.620441
+       0.562609 -0.660878 -0.496658
+       0.973266  0.229621 -0.000000
+      -0.352611 -0.364910  0.861660
+      -0.607990  0.573687  0.548784
+      -0.703085 -0.711081 -0.000000
+      -0.236579  0.954222 -0.182806
+       0.777642 -0.573290 -0.258065
+      -0.543474  0.774346 -0.324015
+       0.160192  0.974151 -0.159124
+      -0.843196  0.339183  0.417005
+      -0.847560 -0.263222 -0.460768
+      -0.870724 -0.475478  0.125278
+      -0.844264  0.528001 -0.091586
+      -0.578600 -0.485488  0.655354
+      -0.121586  0.874874 -0.468795
+       0.217811  0.917508 -0.332743
+      -0.591632 -0.116733  0.797693
+      -0.834803  0.494675 -0.241523
+       0.225013 -0.003052 -0.974334
+       0.054903 -0.219550  0.974029
+      -0.859340  0.418043  0.294473
+       0.217200 -0.723624  0.655080
+       0.154271  0.919797  0.360759
+      -0.197699 -0.490646  0.848598
+       0.776299 -0.489639  0.396924
+      -0.648518 -0.350993 -0.675405
+      -0.395611  0.516037 -0.759697
+      -0.707663  0.704276 -0.056276
+      -0.586871 -0.809656 -0.000183
+       0.876339  0.162236 -0.453505
+      -0.924406  0.100772 -0.367779
+      -0.565600  0.737754  0.368419
+      -0.469497 -0.771996 -0.428419
+       0.044465  0.881710 -0.469619
+      -0.698019 -0.642628  0.315836
+      -0.845515  0.408246 -0.344066
+       0.209326 -0.724876 -0.656270
+      -0.241646 -0.943602  0.226203
+      -0.559862 -0.742210  0.368297
+      -0.708029 -0.693686  0.132145
+       0.765526  0.493820 -0.412366
+       0.693075  0.527787  0.490951
+      -0.255531 -0.964415  0.067537
+      -0.299936 -0.163732  0.939787
+      -0.232002 -0.361095  0.903195
+      -0.888089  0.025758  0.458907
+       0.829554 -0.019501  0.558031
+       0.210974  0.975097 -0.068026
+       0.894864 -0.048708 -0.443617
+      -0.517624  0.573077 -0.635304
+      -0.982574 -0.004364  0.185766
+      -0.053804 -0.471389 -0.880245
+       0.154271  0.919797 -0.360759
+       0.745903  0.548906  0.377209
+       0.584552  0.574847  0.572558
+       0.947874  0.015473  0.318186
+       0.809961  0.445021  0.381939
+      -0.423536 -0.901059 -0.092990
+       0.562609  0.660878 -0.496658
+       0.612507 -0.725181  0.314463
+       0.013398 -0.999908 -0.001160
+       0.092349  0.973724 -0.208106
+       0.755089 -0.459426  0.467666
+      -0.707205 -0.468734 -0.529252
+      -0.268899  0.962615 -0.031678
+       0.298349 -0.328715  0.896054
+       0.098514 -0.235420 -0.966857
+      -0.437452  0.570574 -0.694998
+      -0.886898  0.164220 -0.431715
+       0.872219  0.124638 -0.472915
+      -0.780908 -0.534684 -0.322855
+       0.989593 -0.143712  0.000885
+       0.880856 -0.359264 -0.308206
+      -0.094180 -0.889248  0.447554
+       0.584552  0.574847  0.572558
+      -0.774590  0.475265  0.417249
+      -0.316660 -0.935270 -0.157933
+       0.829585 -0.017090 -0.558092
+       0.872219  0.124638  0.472915
+      -0.310587  0.815577  0.488144
+      -0.033174  0.376873 -0.925657
+       0.013398 -0.999908 -0.001160
+      -0.992431 -0.122654  0.000092
+      -0.814417  0.108341  0.570025
+       0.963713 -0.173681 -0.202643
+      -0.771569 -0.468276 -0.430525
+      -0.859432 -0.495682 -0.125004
+       0.247353 -0.951598 -0.182287
+       0.029847  0.707419 -0.706137
+       0.863857  0.503464  0.016236
+       0.285806  0.257759 -0.922941
+       0.628498  0.777795 -0.000000
+       0.361461  0.152165 -0.919858
+      -0.718802  0.601733  0.348125
+      -0.521958 -0.567492  0.636769
+      -0.364452 -0.880825  0.302133
+       0.213141  0.976989 -0.000000
+      -0.085238 -0.875973  0.474685
+       0.584552  0.574847 -0.572558
+       0.238746  0.716727 -0.655171
+      -0.767876 -0.510025  0.387524
+       0.876339  0.162236 -0.453505
+       0.230110 -0.938810 -0.256172
+       0.230110 -0.938810  0.256172
+       0.880856 -0.359264  0.308206
+       0.028596  0.707389 -0.706229
+      -0.529130 -0.200629  0.824458
+      -0.136784 -0.097262 -0.985778
+      -0.135075  0.990814  0.001190
+      -0.500748  0.295053  0.813715
+       0.229041  0.965728 -0.122013
+      -0.607990 -0.573687  0.548784
+      -0.841212  0.415387  0.346019
+      -0.490432  0.036103 -0.870724
+      -0.760521  0.413648  0.500473
+      -0.469497 -0.771996  0.428419
+       0.977722  0.209845  0.000183
+       0.028596  0.707389  0.706229
+      -0.098148 -0.421033 -0.901700
+      -0.682211  0.715171  0.151921
+       0.746574 -0.493759 -0.445875
+       0.747887 -0.086703  0.658101
+      -0.771569 -0.468276  0.430525
+      -0.121586  0.874874 -0.468795
+      -0.194769  0.946043 -0.258889
+      -0.814417 -0.478622 -0.327982
+       0.081362  0.988281 -0.128971
+       0.069247 -0.615497 -0.785058
+      -0.697501  0.503281 -0.510056
+      -0.475845  0.340098  0.811090
+      -0.336528  0.030519 -0.941160
+       0.829585 -0.017090  0.558092
+      -0.479019 -0.402478  0.780053
+      -0.599628 -0.009400  0.800195
+       0.601581  0.730583 -0.322947
+      -0.818476 -0.473739  0.324961
+       0.791131 -0.522172 -0.318430
+      -0.120945  0.712394  0.691244
+      -0.136784 -0.097262  0.985778
+       0.765587 -0.435560  0.473434
+       0.028596  0.707389  0.706229
+      -0.333537 -0.180364  0.925291
+      -0.437452  0.570574  0.694998
+      -0.270394 -0.841700 -0.467299
+       0.395459 -0.851527  0.344157
+      -0.867306  0.157506  0.472152
+       0.671957  0.663961  0.327952
+       0.993133  0.116916  0.000305
+      -0.201331  0.791406 -0.577136
+       0.934446  0.199896 -0.294626
+       0.931822  0.107791 -0.346446
+      -0.824976  0.543229  0.155828
+       0.116062  0.181280  0.976531
+      -0.192969 -0.981201  0.000885
+       0.828516 -0.078433 -0.554430
+      -0.789727 -0.004425  0.613392
+       0.027528 -0.996582  0.077639
+      -0.364452 -0.880825 -0.302133
+      -0.685568  0.527909 -0.501236
+      -0.909421  0.304788  0.282907
+      -0.859706  0.509537  0.035554
+      -0.797845  0.412366 -0.439711
+      -0.593646 -0.421613  0.685385
+       0.829554 -0.019501  0.558031
+      -0.354137  0.010651  0.935118
+       0.986938 -0.160955  0.000488
+      -0.779199 -0.206732  0.591632
+      -0.365459  0.140782  0.920103
+       0.028596  0.707389  0.706229
+      -0.796655  0.496933  0.344005
+      -0.212867 -0.658986  0.721366
+       0.765526  0.493820  0.412366
+       0.915555  0.333445  0.224738
+      -0.015412  0.365215 -0.930754
+       0.900754 -0.161809 -0.402997
+      -0.529130 -0.200629 -0.824458
+      -0.543474  0.774346  0.324015
+      -0.875637 -0.482437 -0.022095
+      -0.999603 -0.027131  0.000183
+       0.825739 -0.039186  0.562639
+      -0.133274  0.977264  0.164830
+      -0.354137  0.010651 -0.935118
+       0.540300  0.612751 -0.576678
+      -0.998108  0.061281 -0.000244
+      -0.812220 -0.583300 -0.000000
+      -0.593921 -0.781610 -0.190497
+       0.601581  0.730583  0.322947
+      -0.308390  0.784478 -0.538011
+       0.238746  0.716727 -0.655171
+      -0.543474  0.774346 -0.324015
+       0.829585 -0.017090  0.558092
+      -0.581866  0.635487 -0.507492
+       0.264840  0.432203 -0.861995
+      -0.708029 -0.693686 -0.132145
+       0.664235 -0.724601  0.183538
+      -0.265206 -0.738304 -0.620075
+      -0.767876 -0.510025 -0.387524
+       0.865993 -0.175665  0.468123
+       0.194281  0.772546  0.604450
+       0.856655  0.298502 -0.420698
+       0.000000 -0.826594 -0.562761
+      -0.299936 -0.163732  0.939787
+      -0.232002 -0.361095 -0.903195
+      -0.768914  0.492508  0.407605
+       0.900571 -0.161748  0.403455
+      -0.608020  0.607715 -0.510819
+       0.274667 -0.961516  0.000397
+       0.373089 -0.757775 -0.535295
+       0.249702 -0.962493  0.105899
+      -0.098148 -0.421033 -0.901700
+       0.694174  0.385723 -0.607715
+      -0.255104 -0.414624  0.873470
+      -0.697501 -0.503281 -0.510056
+      -0.690329  0.723472  0.000732
+      -0.185644  0.181219  0.965728
+       0.791131 -0.522172 -0.318430
+       0.829554 -0.019501 -0.558031
+       0.160192  0.974151 -0.159124
+       0.845302  0.492264 -0.207556
+       0.350902 -0.163427  0.922025
+       0.778252  0.542589  0.316019
+      -0.686026 -0.686453 -0.241005
+      -0.269967 -0.962798  0.011109
+      -0.321451  0.935331  0.147649
+      -0.774590  0.475265 -0.417249
+      -0.870724 -0.475478 -0.125278
+      -0.280038  0.175115 -0.943876
+       0.203436 -0.931883 -0.300241
+      -0.057314 -0.557909  0.827876
+       0.000000 -0.603015 -0.797693
+       0.221809 -0.891263  0.395459
+      -0.270302  0.306619  0.912625
+      -0.836909  0.423078 -0.347209
+      -0.292886 -0.300058 -0.907804
+       0.810358 -0.444227  0.382031
+      -0.278451 -0.817103 -0.504746
+       0.944853 -0.027802 -0.326273
+      -0.113315 -0.575823  0.809656
+       0.747429  0.541887  0.384259
+      -0.259407  0.504379  0.823542
+       0.180334 -0.983581 -0.000000
+       0.584552  0.574847  0.572558
+      -0.062197 -0.666707  0.742698
+      -0.328867 -0.689413  0.645375
+       0.117435 -0.938841 -0.323679
+      -0.517624  0.573077 -0.635304
+       0.927152  0.025025  0.373821
+      -0.999908  0.013428 -0.000000
+      -0.372539 -0.917295 -0.140507
+       0.745903  0.548906 -0.377209
+      -0.274392  0.915006  0.295633
+       0.551042 -0.533952  0.641255
+      -0.049013  0.319437 -0.946318
+       0.065310 -0.770989  0.633442
+      -0.984924 -0.100711 -0.140446
+      -0.900845  0.431074 -0.051302
+      -0.176519  0.398175 -0.900143
+      -0.856563 -0.094577  0.507248
+      -0.079470 -0.765130 -0.638905
+      -0.231269  0.691427 -0.684408
+       0.944853 -0.027802  0.326273
+      -0.192969 -0.981201 -0.000885
+       0.133793  0.376171 -0.916807
+       0.845302  0.492264  0.207556
+      -0.424604 -0.796045  0.431288
+      -0.254311 -0.391736 -0.884213
+      -0.542344 -0.480575 -0.689077
+      -0.310617  0.935545  0.168035
+       0.251534  0.146641 -0.956664
+       0.765526  0.493820  0.412366
+       0.652303  0.614460 -0.443739
+      -0.539659 -0.811853 -0.222694
+      -0.048769 -0.980712  0.189215
+       0.562609  0.660878 -0.496658
+       0.055879 -0.990570  0.125034
+      -0.336528  0.030519 -0.941160
+       0.776299 -0.489639 -0.396924
+       0.000000  0.826594 -0.562761
+       0.311960  0.950072  0.002380
+      -0.698386  0.521317 -0.490341
+      -0.542344 -0.480575 -0.689077
+       0.154271  0.919797 -0.360759
+      -0.301981 -0.942351 -0.143956
+       0.545946  0.052278 -0.836177
+      -0.133091 -0.991089 -0.000000
+       0.578600  0.485488  0.655354
+      -0.310617  0.935545 -0.168035
+      -0.220099  0.959319 -0.176641
+       0.872524 -0.488510 -0.000000
+       0.028291 -0.260445 -0.965056
+       0.240974 -0.660634 -0.710959
+      -0.818476 -0.473739 -0.324961
+       0.527146 -0.754357 -0.391186
+       0.520768 -0.182287 -0.833979
+       0.825739 -0.039186 -0.562639
+      -0.388653  0.291971 -0.873867
+       0.856746 -0.200415  0.475143
+      -0.310953 -0.139134  0.940153
+       0.924924  0.380078  0.000031
+      -0.512345  0.450453  0.731132
+      -0.301981 -0.942351  0.143956
+      -0.987579  0.006867  0.156926
+      -0.512375  0.450392 -0.731162
+      -0.945616  0.058779 -0.319865
+       0.866482 -0.168981 -0.469649
+      -0.562609 -0.660878 -0.496658
+       0.310800  0.016511  0.950316
+       0.934446  0.199591  0.294839
+       0.999084  0.042665  0.000732
+       0.856655  0.298502  0.420698
+      -0.304971 -0.098483  0.947233
+       0.776299 -0.489639 -0.396924
+      -0.269967 -0.962798 -0.011109
+      -0.331614 -0.891507  0.308542
+       0.070864  0.707144  0.703482
+      -0.820124 -0.473159 -0.321665
+      -0.434400  0.414991  0.799402
+      -0.615253 -0.785058 -0.071474
+      -0.231239  0.691397  0.684439
+       0.258827  0.806513 -0.531510
+      -0.340953  0.074221  0.937132
+      -0.048769 -0.980712  0.189215
+      -0.955687  0.198248 -0.217505
+       0.382000 -0.159673  0.910245
+      -0.813074  0.506333 -0.287210
+      -0.844264  0.528001  0.091586
+       0.069247 -0.615497  0.785058
+       0.395459 -0.851527 -0.344157
+      -0.178899 -0.668020  0.722282
+       0.305918  0.213141 -0.927854
+      -0.121586  0.874874  0.468795
+       0.209326 -0.724876  0.656270
+      -0.018891 -0.169195  0.985382
+       0.296793 -0.656667  0.693289
+      -0.321451  0.935331 -0.147649
+       0.944853 -0.027802 -0.326273
+       0.185644  0.965667  0.181616
+       0.210974  0.975097  0.068026
+      -0.870510  0.007447  0.492050
+       0.044465  0.881710 -0.469619
+      -0.768914  0.492508 -0.407605
+       0.278176 -0.960509 -0.000000
+       0.986938 -0.160955  0.000488
+      -0.760002  0.523453 -0.385174
+       0.305918  0.213141  0.927854
+      -0.033174  0.376873  0.925657
+      -0.780908 -0.534684 -0.322855
+      -0.246651  0.406232  0.879818
+       0.242683  0.033845  0.969512
+       0.092349  0.973724 -0.208106
+      -0.698019 -0.642628 -0.315836
+      -0.121586  0.874874  0.468795
+      -0.786676  0.479202  0.389172
+       0.755089 -0.459426 -0.467666
+       0.540300  0.612751 -0.576678
+      -0.836116 -0.476394  0.271889
+      -0.593921 -0.781610  0.190497
+      -0.274392  0.915006  0.295633
+      -0.310587  0.815577 -0.488144
+       0.029847  0.707419 -0.706137
+       0.833155 -0.476424 -0.280770
+       0.747490  0.549150  0.373699
+      -0.856319  0.284707  0.430799
+       0.896115  0.194464  0.398907
+      -0.578600 -0.485488  0.655354
+       0.329569  0.036622  0.943388
+      -0.521958 -0.567492 -0.636769
+       0.776299 -0.489639  0.396924
+      -0.349071 -0.468703  0.811457
+      -0.255104 -0.414624  0.873470
+      -0.276193  0.452315 -0.847987
+       0.329569  0.036622 -0.943388
+       0.862056  0.450942  0.231208
+       0.856746 -0.200415  0.475143
+      -0.058657  0.181829  0.981567
+       0.803095  0.473006  0.362255
+       0.829585 -0.017090 -0.558092
+      -0.800378 -0.507096 -0.319681
+       0.908475  0.028657 -0.416913
+       0.588610  0.267098 -0.762993
+      -0.796655  0.496933 -0.344005
+      -0.945616  0.058779  0.319895
+      -0.328867 -0.689413 -0.645375
+       0.562609  0.660878 -0.496658
+       0.179296  0.268197  0.946501
+      -0.299936 -0.163732  0.939787
+      -0.490432  0.036103  0.870724
+       0.584552  0.574847 -0.572558
+      -0.795312 -0.516098 -0.317911
+       0.000000  0.677236  0.735740
+      -0.310953 -0.139134 -0.940153
+       0.918546 -0.351115 -0.181585
+      -0.900845  0.431074  0.051302
+      -0.835597 -0.011780  0.549181
+      -0.811945 -0.526170  0.252632
+       0.179296  0.268288 -0.946471
+      -0.469497 -0.771996  0.428419
+      -0.574786 -0.566759 -0.590228
+      -0.673513  0.628315 -0.389264
+      -0.278451 -0.817103 -0.504746
+      -0.517624  0.573077  0.635304
+      -0.231544 -0.833247  0.502029
+      -0.970702  0.240181  0.000549
+      -0.443159 -0.787561  0.428114
+      -0.530747 -0.847499 -0.000000
+       0.191076 -0.880978 -0.432783
+       0.058107  0.087374 -0.994476
+       0.251778  0.045686  0.966674
+       0.693136  0.527818 -0.490860
+      -0.393811  0.876583  0.276498
+      -0.734092  0.385723 -0.558824
+       0.030122  0.558336 -0.829035
+      -0.847560 -0.263222  0.460768
+       0.703665 -0.705679  0.082736
+      -0.299936 -0.163732 -0.939787
+       0.209326 -0.724876 -0.656270
+      -0.333171  0.188452 -0.923826
+      -0.178899 -0.668020 -0.722282
+       0.139958 -0.544786 -0.826807
+       0.202857 -0.961028  0.187780
+      -0.782067 -0.279885 -0.556780
+       0.789605 -0.157994 -0.592883
+      -0.386822 -0.407941 -0.826991
+      -0.299936 -0.163732 -0.939787
+       0.791131 -0.522172  0.318430
+       0.399976 -0.668844 -0.626576
+       0.023347 -0.502640 -0.864162
+      -0.569323 -0.362377 -0.737907
+      -0.930876 -0.310282  0.192785
+       0.588610  0.267098  0.762993
+       0.278176 -0.960509 -0.000000
+      -0.079470 -0.765130  0.638905
+       0.993133  0.116916  0.000305
+       0.399976 -0.668844 -0.626576
+       0.925596 -0.326273  0.191778
+      -0.768914  0.492508  0.407605
+      -0.811945 -0.526170  0.252632
+      -0.424604 -0.796045  0.431288
+      -0.875637 -0.482437  0.022095
+       0.984283 -0.176427 -0.000000
+       0.671957  0.663961 -0.327952
+      -0.333171  0.188452  0.923826
+       0.350902 -0.163427 -0.922025
+       0.324992  0.337260 -0.883511
+      -0.539659 -0.811884  0.222724
+       0.457015  0.398022 -0.795404
+      -0.544206 -0.827448  0.138279
+       0.935575  0.272958 -0.223914
+       0.765587 -0.435560 -0.473434
+      -0.349040 -0.468703 -0.811457
+       0.313425 -0.017975 -0.949431
+       0.029847  0.707419  0.706137
+       0.120518  0.943510  0.308542
+       0.880917  0.320750  0.347911
+       0.599780  0.471419  0.646504
+       0.687521 -0.676199  0.264687
+       0.123875 -0.951781 -0.280557
+       0.000000  0.826594 -0.562761
+      -0.648518 -0.350993  0.675405
+      -0.015412  0.365215 -0.930754
+      -0.983428 -0.120914  0.135014
+       0.833155 -0.476424 -0.280770
+       0.866482 -0.168981  0.469649
+      -0.328867 -0.689413 -0.645375
+       0.293863  0.378674 -0.877621
+      -0.265206 -0.738304  0.620075
+       0.055788 -0.990448 -0.125889
+       0.963591 -0.173467  0.203406
+       0.694021 -0.473037 -0.542680
+      -0.698386  0.521317  0.490341
+       0.445479  0.678426 -0.584185
+     ) ;; normals
+
+    (texcoords
+      0.968709 0.735000
+      0.142326 0.045559
+      0.335404 0.229261
+      0.323658 0.788148
+      0.513618 0.468040
+      0.099669 0.080620
+      0.375718 0.114421
+      0.145785 0.606254
+      0.644497 0.422233
+      0.028015 0.963061
+      0.464372 0.860605
+      0.191559 0.142272
+      0.411457 0.702886
+      0.242691 0.024951
+      0.216707 0.949940
+      0.871022 0.610035
+      0.210070 0.606297
+      0.456481 0.643130
+      0.272010 0.738994
+      0.385874 0.766902
+      0.311080 0.874866
+      0.084386 0.885074
+      0.033637 0.881283
+      0.202568 0.685925
+      0.708477 0.911200
+      0.075792 0.138166
+      0.644562 0.078129
+      0.800507 0.674147
+      0.322145 0.837771
+      0.214243 0.867042
+      0.981368 0.695199
+      0.913834 0.284460
+      0.276546 0.606301
+      0.229700 0.976830
+      0.772458 0.735767
+      0.373565 0.989409
+      0.916638 0.188009
+      0.488102 0.071988
+      0.706860 0.691407
+      0.995188 0.785439
+      0.279675 0.343161
+      0.583741 0.062422
+      0.793765 0.833658
+      0.694935 0.916860
+      0.358265 0.450715
+      0.208764 0.987589
+      0.866738 0.214670
+      0.423265 0.748441
+      0.410915 0.864756
+      0.766855 0.189878
+      0.453167 0.287422
+      0.186971 0.649206
+      0.471151 0.875395
+      0.242689 0.945742
+      0.778433 0.896562
+      0.632930 0.730236
+      0.906165 0.406900
+      0.471151 0.875395
+      0.518978 0.304890
+      0.370419 0.878173
+      0.803838 0.701795
+      0.452531 0.889487
+      0.370034 0.917647
+      0.663769 0.728278
+      0.716018 0.943038
+      0.309931 0.229011
+      0.682468 0.616902
+      0.671525 0.407940
+      0.254670 0.606293
+      0.645933 0.107531
+      0.549734 0.179998
+      0.411140 0.614796
+      0.279675 0.343161
+      0.746601 0.258552
+      0.471151 0.875395
+      0.510946 0.249151
+      0.255462 0.664557
+      0.691463 0.408145
+      0.471151 0.875395
+      0.255977 0.732014
+      0.819365 0.284460
+      0.692889 0.946148
+      0.079346 0.606230
+      0.616241 0.614505
+      0.410470 0.246134
+      0.593906 0.605237
+      0.438056 0.132297
+      0.755254 0.738117
+      0.081466 0.501639
+      0.271926 0.783768
+      0.505703 0.199366
+      0.429032 0.407966
+      0.400151 0.387096
+      0.279964 0.532673
+      0.804823 0.150350
+      0.832369 0.578628
+      0.476856 0.397659
+      0.456052 0.422249
+      0.548510 0.375218
+      0.845818 0.163380
+      0.793462 0.941428
+      0.859163 0.796560
+      0.534598 0.082628
+      0.717769 0.576672
+      0.423871 0.216458
+      0.513640 0.722935
+      0.344488 0.952985
+      0.513625 0.546659
+      0.017871 0.896341
+      0.136625 0.273984
+      0.452631 0.889487
+      0.145235 0.866906
+      0.138179 0.675112
+      0.878243 0.990780
+      0.139986 0.544194
+      0.368898 0.637837
+      0.768790 0.991946
+      0.417976 0.767897
+      0.038855 0.895906
+      0.134520 0.484864
+      0.016395 0.888781
+      0.201255 0.665413
+      0.257033 0.969880
+      0.383360 0.390853
+      0.807510 0.622316
+      0.991113 0.217145
+      0.272057 0.721956
+      0.893483 0.781417
+      0.553243 0.130363
+      0.156778 0.910252
+      0.053365 0.649158
+      0.139687 0.779311
+      0.548667 0.349986
+      0.186715 0.993549
+      0.700650 0.120972
+      0.561667 0.331932
+      0.198795 0.565234
+      0.471151 0.875395
+      0.919941 0.673214
+      0.548557 0.367666
+      0.745150 0.683268
+      0.180200 0.273984
+      0.197992 0.797356
+      0.781229 0.130798
+      0.232350 0.877908
+      0.471151 0.875395
+      0.513777 0.630246
+      0.913746 0.703922
+      0.678209 0.378124
+      0.575154 0.232985
+      0.081473 0.343156
+      0.759718 0.747259
+      0.052063 0.323411
+      0.610508 0.252091
+      0.382816 0.825131
+      0.926457 0.335355
+      0.095621 0.905193
+      0.736981 0.631057
+      0.580818 0.360997
+      0.789556 0.897903
+      0.904137 0.751894
+      0.332813 0.901074
+      0.271872 0.816947
+      0.892401 0.150243
+      0.665847 0.617501
+      0.081466 0.501639
+      0.986596 0.258536
+      0.812630 0.746055
+      0.793462 0.941429
+      0.194753 0.495499
+      0.450092 0.015889
+      0.537548 0.103300
+      0.380601 0.407212
+      0.168336 0.649219
+      0.242544 0.145767
+      0.310558 0.907782
+      0.202701 0.731639
+      0.587346 0.639120
+      0.716914 0.800259
+      0.174379 0.986698
+      0.242558 0.145763
+      0.549839 0.718558
+      0.160985 0.086285
+      0.425028 0.420014
+      0.621277 0.843329
+      0.234897 0.274007
+      0.471151 0.875395
+      -0.011128 0.443960
+      0.465712 0.686575
+      0.936380 0.955315
+      0.327607 0.724906
+      0.364941 0.221359
+      0.859163 0.796562
+      0.471151 0.875395
+      0.015295 0.915581
+      0.495125 0.992073
+      0.272010 0.738994
+      0.550407 0.400897
+      0.625113 0.584502
+      0.771519 0.939845
+      0.197992 0.797356
+      0.380804 0.864463
+      0.202513 0.396430
+      0.471151 0.875395
+      0.653787 0.693162
+      0.581876 0.368751
+      0.595715 0.582046
+      0.104725 0.273993
+      0.970645 0.782776
+      0.549048 0.290731
+      0.275262 0.145543
+      0.501888 0.257916
+      0.156112 0.848494
+      0.952228 0.919088
+      0.471151 0.875395
+      0.471151 0.875395
+      0.471151 0.875395
+      1.001958 0.649037
+      0.616409 0.702394
+      0.549620 0.198730
+      0.458169 0.824145
+      0.708477 0.911199
+      0.467649 0.916911
+      0.756666 0.078462
+      0.812633 0.746056
+      0.794652 0.622739
+      0.568255 0.581764
+      0.994508 0.747917
+      0.099523 0.375612
+      0.466629 0.889558
+      0.501682 0.281900
+      0.881034 0.841317
+      0.988900 0.728304
+      0.163204 0.488173
+      0.926674 0.470505
+      0.619686 0.917511
+      0.408474 0.371043
+      0.194207 0.853256
+      0.099656 0.080624
+      0.256028 0.699518
+      0.951631 0.957080
+      0.020360 0.414243
+      0.789556 0.897904
+      0.263635 0.231313
+      0.064929 0.885074
+      0.477774 0.392242
+      0.953898 0.798490
+      0.295152 0.869864
+      0.701731 0.839768
+      0.264328 0.907360
+      0.689998 0.839808
+      0.016395 0.888781
+      0.471151 0.875395
+      0.119530 0.545714
+      0.967295 0.923743
+      0.030965 0.896323
+      0.904133 0.751893
+      0.591081 0.763672
+      0.344488 0.952985
+      0.471151 0.875395
+      0.549249 0.893344
+      0.659498 0.264882
+      0.471151 0.875395
+      0.900696 0.731595
+      0.516081 0.126270
+      0.294192 0.889669
+      0.717195 0.390815
+      0.459081 0.581865
+      0.416680 0.640971
+      0.203361 0.227527
+      0.788466 0.990660
+      0.950131 0.288086
+      0.471151 0.875395
+      0.548731 0.306146
+      0.232350 0.877908
+      0.624009 0.426345
+      0.644458 0.765464
+      0.690460 0.738071
+      0.995191 0.785440
+      0.018915 0.938130
+      0.168529 0.606262
+      0.201990 0.779415
+      0.906733 0.329340
+      0.961848 0.453007
+      0.690463 0.738072
+      0.028622 0.854432
+      0.651757 0.434978
+      0.975842 0.177155
+      0.101061 0.649175
+      0.271855 0.837760
+      0.065015 0.913446
+      0.263622 0.231317
+      0.978401 0.846118
+      0.471151 0.875395
+      0.495187 0.991842
+      0.471151 0.875395
+      0.081165 0.396860
+      0.695811 0.051571
+      0.513828 0.648277
+      0.267116 0.078969
+      0.471151 0.875395
+      0.701692 0.782392
+      0.460253 0.246561
+      0.382295 0.837717
+      0.139492 0.733289
+      0.267102 0.078973
+      0.826547 0.329345
+      0.881034 0.841316
+      0.736583 0.183970
+      0.471151 0.875395
+      0.500165 0.607721
+      0.387660 0.348794
+      0.628344 0.988618
+      0.255893 0.685273
+      0.471151 0.875395
+      0.595516 0.240118
+      0.024529 0.915769
+      0.323657 0.788148
+      0.515528 0.215170
+      0.522229 0.277438
+      0.472568 0.444535
+      0.639188 0.390352
+      0.803838 0.701795
+      0.325232 0.756249
+      0.996141 0.766476
+      0.366293 0.954588
+      0.255634 0.766851
+      0.712220 0.648048
+      0.467402 0.083190
+      0.309918 0.229015
+      0.864220 0.899671
+      0.759939 0.046782
+      0.024078 0.867479
+      0.583500 0.215597
+      0.364589 0.584588
+      0.202695 0.699628
+      0.239628 0.821754
+      0.851715 0.462075
+      0.433479 0.605440
+      0.274071 0.029988
+      0.771519 0.939843
+      0.493326 0.076684
+      0.033729 0.839243
+      0.978401 0.846119
+      0.080227 0.237565
+      0.030883 0.906616
+      0.247870 0.515363
+      0.138179 0.675112
+      0.828716 0.757437
+      0.050840 0.837819
+      0.292631 0.883520
+      0.083574 0.288201
+      0.180187 0.273988
+      0.446274 0.480455
+      0.756194 0.710021
+      0.988897 0.728302
+      0.951514 0.130798
+      0.050549 0.930347
+      0.066007 0.516184
+      0.804335 0.384736
+      0.322761 0.376879
+      0.864950 0.702572
+      0.788648 0.436922
+      0.692083 0.371010
+      0.017397 0.133684
+      0.918091 0.619902
+      0.254638 0.606313
+      0.061378 0.779320
+      0.550416 0.451371
+      0.775393 0.252027
+      0.377320 0.670564
+      0.596457 0.042687
+      0.344992 0.049400
+      0.471151 0.875395
+      0.964888 0.104882
+      0.186715 0.993549
+      0.187132 0.606269
+      0.490425 0.341789
+      0.015068 0.881536
+      0.471151 0.875395
+      0.757807 0.765086
+      0.573626 0.249477
+      0.067950 0.839243
+      0.156778 0.910252
+      0.166824 0.948752
+      0.244258 0.906477
+      0.866740 0.186719
+      0.481278 0.203536
+      0.661624 0.557126
+      0.705224 0.396648
+      0.456513 0.860566
+      0.922058 0.768614
+      0.108827 0.134707
+      0.770934 0.754703
+      0.553625 0.069519
+      0.174379 0.986698
+      0.229700 0.976830
+      0.136611 0.273988
+      0.310184 0.962548
+      0.335401 0.274010
+      0.654419 0.014611
+      0.497270 0.911264
+      0.448099 0.538221
+      0.276352 0.649258
+      0.017410 0.133680
+      0.796860 0.090132
+      0.033412 0.915375
+      0.768537 0.795354
+      0.075805 0.138162
+      0.310184 0.962548
+      0.772461 0.735768
+      0.160443 0.279197
+      0.513374 0.955115
+      0.951631 0.957082
+      0.325932 0.742454
+      0.883326 0.949907
+      0.552424 0.042577
+      0.309202 0.577180
+      0.660603 0.382922
+      0.010001 0.895925
+      0.550416 0.429480
+      0.798949 0.793215
+      0.032276 0.163245
+      0.644943 0.288614
+      0.970648 0.688399
+      0.866860 0.329947
+      0.613842 0.077439
+      0.244258 0.906477
+      0.861122 0.949652
+      0.451602 0.916830
+      0.459825 0.395559
+      0.459122 0.795392
+      0.289573 0.956053
+      0.941183 0.398191
+      0.264328 0.907360
+      0.948208 0.433511
+      0.470632 0.987886
+      0.209185 0.861996
+      0.565992 0.606709
+      0.697933 0.019139
+      0.480728 0.155644
+      0.325232 0.756249
+      0.168368 0.649199
+      0.448837 0.987777
+      0.976076 0.078462
+      0.972740 0.300513
+      0.315106 0.648728
+      0.923398 0.783607
+      0.289913 0.906097
+      0.483639 0.346059
+      0.471151 0.875395
+      0.255208 0.779440
+      0.552204 0.008178
+      0.156963 0.945629
+      0.675113 0.218030
+      0.471151 0.875395
+      0.614008 0.559806
+      0.234910 0.274003
+      0.289573 0.956053
+      0.809650 0.735039
+      0.471151 0.875395
+      0.488276 0.220284
+      0.438909 0.263511
+      0.519338 0.319286
+      0.471151 0.875395
+      0.417976 0.767897
+      0.024369 0.888508
+      0.503204 0.239543
+      0.735184 0.384064
+      0.156112 0.848494
+      0.756194 0.710021
+      0.202513 0.396430
+      0.327607 0.724906
+      0.893480 0.781415
+      0.014691 0.954508
+      0.382295 0.837717
+      0.190718 0.901534
+      0.622527 0.313461
+      0.386826 0.356922
+      0.222049 0.848766
+      0.223874 0.505780
+      0.858744 0.988700
+      0.008829 0.903398
+      0.145753 0.606273
+      0.859565 0.618498
+      0.335418 0.229257
+      0.457607 0.837759
+      0.208764 0.987589
+      0.510766 0.911478
+      0.523662 0.232664
+      0.968711 0.735001
+      0.105086 0.706565
+      0.596601 0.258502
+      0.953898 0.798492
+      0.691215 0.770288
+      0.592909 0.007465
+      0.883326 0.949909
+      0.365362 0.384106
+      0.271872 0.816947
+      0.295152 0.869864
+      0.209941 0.649214
+      0.471151 0.875395
+      0.939937 0.990937
+      0.314449 0.056805
+      0.263406 0.947106
+      0.661989 0.133704
+      0.161296 0.549138
+      0.848627 0.619168
+      0.770937 0.754705
+      0.471151 0.875395
+      0.130470 0.222923
+      0.255977 0.732014
+      0.851705 0.547238
+      0.675533 0.419991
+      0.370419 0.878173
+      0.513424 0.992049
+      0.347574 0.085740
+      0.633815 0.317234
+      0.863028 0.672086
+      0.866863 0.372906
+      0.471151 0.875395
+      0.061132 0.764557
+      0.322761 0.376879
+      0.863027 0.672086
+      0.832208 0.609903
+      0.580963 0.480443
+      0.224126 0.577957
+      0.996608 0.183987
+      0.471151 0.875395
+      0.510057 0.856715
+      0.008829 0.903398
+      0.052063 0.323411
+      0.425842 0.918191
+      0.851721 0.509591
+      0.490619 0.798234
+      0.695698 0.188241
+      0.471151 0.875395
+      0.099523 0.375612
+      0.276513 0.606321
+      0.876306 0.900606
+      0.549326 0.245987
+      0.639686 0.084273
+      0.828713 0.757435
+      0.475271 0.312553
+      0.513668 0.581414
+      0.811534 0.672970
+      0.714622 0.185687
+      0.057036 0.906696
+      0.515228 0.368340
+      0.783083 0.288107
+      0.373922 0.693772
+      1.020289 0.658854
+      0.242689 0.945742
+      0.428855 0.971236
+      0.488057 0.251332
+      0.471151 0.875395
+      0.973733 0.767594
+      0.922965 0.754035
+      0.957811 0.252021
+      0.440203 0.639368
+      0.829354 0.736151
+      0.103556 0.227137
+      0.366137 0.970625
+      0.825469 0.748666
+      0.928920 0.384733
+      0.319611 0.673515
+      0.650265 0.670031
+      0.074663 0.274018
+      0.527992 0.347160
+      0.403984 0.373756
+      0.470895 0.955433
+      0.386785 0.753767
+      0.099260 0.284851
+      0.391391 0.379257
+      0.466729 0.889558
+      0.459122 0.795392
+      0.403653 0.186408
+      0.964010 0.218163
+      0.010001 0.895925
+      0.186939 0.649225
+      0.358265 0.450715
+      0.509805 0.729202
+      0.187995 0.023152
+      0.513486 0.991817
+      0.455112 0.048413
+      0.488838 0.172684
+      0.229112 0.876394
+      0.254476 0.649250
+      0.994511 0.747919
+      0.083574 0.288201
+      0.095530 0.891887
+      0.583779 0.451326
+      0.222314 0.315206
+      0.865795 0.839988
+      0.472955 0.276286
+      0.471151 0.875395
+      0.964208 0.719457
+      0.370034 0.917647
+      0.562155 0.686345
+      0.242677 0.024955
+      0.242474 0.078242
+      0.701689 0.782391
+      0.497208 0.911496
+      0.960607 0.849329
+      0.276385 0.649238
+      0.513144 0.389438
+      0.866868 0.408854
+      0.105734 0.490200
+      0.448937 0.987777
+      0.201255 0.665413
+      0.156951 0.138711
+      0.574458 0.262843
+      0.201990 0.779415
+      0.495075 0.955140
+      0.685759 0.756176
+      0.209909 0.649234
+      0.507148 0.327791
+      0.471151 0.875395
+      0.382816 0.825131
+      0.108841 0.134703
+      0.451501 0.916830
+      0.932761 0.675435
+      0.617878 0.204395
+      0.724365 0.393521
+      0.967295 0.923741
+      0.924484 0.704988
+      0.864950 0.702572
+      0.191573 0.142268
+      0.832062 0.545115
+      0.413133 0.559959
+      0.922055 0.768613
+      0.772390 0.764914
+      0.636474 0.797214
+      0.572486 0.082864
+      0.471151 0.875395
+      0.050840 0.822132
+      0.705815 0.365650
+      0.864220 0.899670
+      0.815052 0.160589
+      0.499661 0.631019
+      0.194207 0.853256
+      0.190783 0.334856
+      0.271856 0.837760
+      0.718280 0.615665
+      0.335387 0.274014
+      0.922962 0.754033
+      0.015295 0.915581
+      0.374884 0.344710
+      0.255893 0.685273
+      0.689998 0.839807
+      0.434955 0.728275
+      0.812838 0.752875
+      0.721007 0.342166
+      0.570240 0.853606
+      0.171868 0.408222
+      0.918090 0.619902
+      0.017954 0.906607
+      0.662539 0.584228
+      0.421030 0.878666
+      0.734724 0.198566
+      0.191037 0.952594
+      0.267949 0.403966
+      0.024417 0.896918
+      0.760481 0.300544
+      0.190783 0.334856
+      0.361429 0.617954
+      0.053525 0.606221
+      0.172485 0.375997
+      0.970648 0.782778
+      0.325931 0.742454
+      0.649814 0.047196
+      0.079185 0.649167
+      0.321956 0.822118
+      0.101007 0.403947
+      0.294192 0.889669
+      0.659864 0.197738
+      0.171868 0.408223
+      0.939099 0.805763
+      0.018647 0.955263
+      0.851677 0.438375
+      0.181019 0.557376
+      0.471151 0.875395
+      0.458170 0.824145
+      0.375731 0.114417
+      0.583775 0.400861
+      0.050840 0.865871
+      0.321956 0.822118
+      0.369284 0.233182
+      0.014621 0.939490
+      0.633210 0.227223
+      0.035782 0.823981
+      0.859564 0.618498
+      0.569377 0.347414
+      0.471151 0.875395
+      0.729490 0.235429
+      0.209185 0.861996
+      0.461073 0.626585
+      0.060927 0.734137
+      0.900848 0.767078
+      0.202568 0.685925
+      0.471151 0.875395
+      0.002830 0.357171
+      0.812927 0.766263
+      0.142313 0.045563
+      0.677917 0.644399
+      0.691212 0.770287
+      0.202598 0.765658
+      0.759715 0.747257
+      0.428855 0.971236
+      0.549241 0.728802
+      0.858744 0.988698
+      0.640719 0.395533
+      0.024369 0.888508
+      0.772393 0.764915
+      0.198795 0.565234
+      0.553425 0.101085
+      0.332813 0.901074
+      0.024418 0.905902
+      0.777173 0.833052
+      0.202598 0.765658
+      0.619027 0.156517
+      0.031753 0.843235
+      0.321217 0.692169
+      0.586332 0.683578
+      0.275275 0.145539
+      0.050840 0.852667
+      0.769192 0.218160
+      0.172560 0.225101
+      0.675459 0.748441
+      0.712909 0.348767
+      0.754981 0.433515
+      0.570610 0.892534
+      0.310558 0.907782
+      0.101029 0.649194
+      0.924484 0.704988
+      0.229112 0.876394
+      0.876306 0.900604
+      0.250014 0.590594
+      0.303154 0.421066
+      0.471151 0.875395
+      0.668565 0.689851
+      0.952228 0.919087
+      0.412847 0.396202
+      0.291676 0.902525
+      0.102208 0.551926
+      0.928057 0.735943
+      0.177196 0.285759
+      0.432297 0.623352
+      0.439369 0.196354
+      0.577570 0.290214
+      0.063404 0.939863
+      0.998468 0.198578
+      0.870646 0.578725
+      0.464621 0.473144
+      0.402111 0.584750
+      0.744141 0.020194
+      0.341799 0.142456
+      0.470732 0.987886
+      0.256327 0.884013
+      0.700406 0.387062
+      0.600546 0.200726
+      0.687712 0.396170
+      0.344763 0.617405
+      0.687987 0.797490
+      0.913746 0.703922
+      0.379583 0.342214
+      1.001958 0.649037
+      0.032289 0.163241
+      0.384430 0.792596
+      0.939144 0.625857
+      0.212021 0.838359
+      0.699495 0.997568
+      0.562621 0.473136
+      0.610676 0.221051
+      0.471151 0.875395
+      0.015068 0.881536
+      0.308875 0.616277
+      0.431575 0.582207
+      0.030965 0.896323
+      0.548775 0.333101
+      0.692890 0.946150
+      0.063299 0.955206
+      0.311080 0.874866
+      0.745150 0.683268
+      0.172574 0.225097
+      0.449101 0.955323
+      0.851839 0.702305
+      0.817959 0.700579
+      0.032487 0.888641
+      0.384299 0.114256
+      0.621277 0.843327
+      0.441478 0.683901
+      0.701731 0.839767
+      0.742080 0.217142
+      0.202695 0.699628
+      0.516746 0.451326
+      0.471151 0.875395
+      0.957898 0.986988
+      0.596506 0.282484
+      0.079314 0.606249
+      0.588211 0.712826
+      0.471151 0.875395
+      0.289913 0.906097
+      0.866553 0.089622
+      0.279964 0.532673
+      0.156938 0.138715
+      0.471151 0.875395
+      0.388831 0.737912
+      0.069926 0.843235
+      0.573527 0.071122
+      0.508397 0.043236
+      0.101222 0.606238
+      0.798949 0.793217
+      0.577780 0.319951
+      0.218419 0.904483
+      0.380804 0.864463
+      0.902737 0.372328
+      0.793765 0.833660
+      0.447354 0.858101
+      0.688151 0.247864
+      0.471151 0.875395
+      0.079153 0.649187
+      0.625299 0.953474
+      0.303154 0.421066
+      0.145235 0.866906
+      0.507661 0.763674
+      0.422348 0.378157
+      0.628344 0.988616
+      0.955577 0.713399
+      0.242854 0.836253
+      0.359078 0.690504
+      0.939937 0.990938
+      0.696573 0.373724
+      0.040030 0.903398
+      0.156963 0.945629
+      0.866553 0.145232
+      1.020290 0.658854
+      0.886549 0.800245
+      0.812836 0.752873
+      0.800507 0.674147
+      0.966351 0.189890
+      0.202701 0.731639
+      0.471151 0.875395
+      0.163204 0.488173
+      0.265116 0.274012
+      0.511495 0.007972
+      0.471151 0.875395
+      0.685462 0.577910
+      0.550570 0.384883
+      0.292631 0.883520
+      0.770034 0.746756
+      0.825472 0.748668
+      0.053332 0.649177
+      0.265130 0.274008
+      0.590458 0.126738
+      0.370021 0.057589
+      0.866744 0.162117
+      0.513933 0.689185
+      0.081473 0.343156
+      0.792295 0.510218
+      0.848627 0.619168
+      0.777173 0.833050
+      0.861122 0.949654
+      0.429011 0.955199
+      0.936380 0.955313
+      0.792079 0.398197
+      0.549952 0.144153
+      0.020360 0.414243
+      0.569274 0.103499
+      0.053373 0.892492
+      0.829965 0.767517
+      0.050840 0.842354
+      0.576016 0.277770
+      0.242854 0.836253
+      0.255634 0.766851
+      0.702076 0.361911
+      0.066007 0.516184
+      0.677539 0.553231
+      0.349411 0.553555
+      0.341577 0.578322
+      0.271980 0.752559
+      0.194646 0.077271
+      0.608754 0.679511
+      0.851745 0.610412
+      0.607009 0.342507
+      0.619686 0.917513
+      0.017871 0.896341
+      0.101007 0.403947
+      0.495476 0.091651
+      0.716914 0.800260
+      0.467750 0.916911
+      0.707835 0.672778
+      0.271980 0.752558
+      0.406642 0.020969
+      0.528514 0.853616
+      0.816581 0.188004
+      0.224126 0.577957
+      0.812929 0.766265
+      0.485134 0.144174
+      0.214243 0.867042
+      0.768537 0.795352
+      0.996139 0.766474
+      0.140332 0.706376
+      0.030883 0.906616
+      0.448797 0.434989
+      0.384764 0.183619
+      0.457607 0.837759
+      0.619125 0.072811
+      0.638364 0.247669
+      0.308558 0.888522
+      0.168497 0.606282
+      0.380601 0.407212
+      0.366137 0.970625
+      0.418985 0.679914
+      0.923401 0.783609
+      0.366293 0.954588
+      0.471151 0.875395
+      0.471151 0.875395
+      0.520523 0.289862
+      0.056804 0.891838
+      0.139986 0.544194
+      0.332423 0.958244
+      0.351344 0.373858
+      0.687987 0.797488
+      0.669021 0.670316
+      0.314435 0.056808
+      0.527897 0.630976
+      0.395336 0.396685
+      0.437173 0.388498
+      0.471151 0.875395
+      0.476533 0.426356
+      0.587406 0.389480
+      0.829962 0.767516
+      0.566438 0.626427
+      0.172485 0.375997
+      0.811534 0.672970
+      0.571108 0.642929
+      0.590465 0.328302
+      0.061378 0.779320
+      0.067165 0.109750
+      0.363791 0.354174
+      0.465799 0.730233
+      0.203375 0.227523
+      0.271926 0.783767
+      0.722589 0.992197
+      0.733979 0.223663
+      0.255208 0.779440
+      0.610709 0.173454
+      0.409178 0.053371
+      0.723195 0.367452
+      0.194633 0.077275
+      0.181057 0.814095
+      0.850631 0.672156
+      0.549233 0.763308
+      0.913971 0.214670
+      0.528192 0.892563
+      0.067178 0.109746
+      0.257033 0.969880
+      0.513717 0.608353
+      0.553729 0.053651
+      0.167531 0.898042
+      0.308558 0.888522
+      0.471151 0.875395
+      0.421030 0.878666
+      0.181057 0.814095
+      0.497741 0.856963
+      0.256327 0.884013
+      0.074676 0.274014
+      0.218419 0.904483
+      0.166824 0.948752
+      0.471151 0.875395
+      0.398482 0.361941
+      0.513436 0.954883
+      0.636474 0.797216
+      0.301761 0.274008
+      0.024292 0.881287
+      0.145592 0.649211
+      0.360450 0.022613
+      0.414380 0.989806
+      0.377350 0.367479
+      0.239628 0.821754
+      0.725709 0.344647
+      0.050450 0.963061
+      0.865795 0.839990
+      0.462603 0.076985
+      0.939099 0.805761
+      0.978837 0.393518
+      0.017954 0.906607
+      0.549228 0.855009
+      0.625297 0.277229
+      -0.031354 0.398944
+      0.509996 0.856946
+      0.981369 0.695199
+      0.974112 0.752971
+      0.139882 0.766768
+      0.970647 0.688399
+      0.535899 0.331774
+      0.680961 0.381615
+      0.761020 0.756180
+      0.770037 0.746757
+      0.851840 0.702305
+      0.119530 0.545714
+      0.919941 0.673214
+      0.028114 0.930347
+      0.024418 0.905902
+      0.622755 0.392231
+      0.105734 0.490200
+      0.516382 0.360599
+      0.465659 0.226176
+      0.932761 0.675435
+      0.757363 0.177137
+      0.082305 0.563577
+      0.386785 0.753767
+      0.973736 0.767596
+      0.104711 0.273997
+      0.549219 0.263647
+      0.241976 0.863164
+      0.222314 0.315206
+      0.445693 0.545177
+      0.713727 0.356899
+      0.344821 0.910824
+      0.247870 0.515363
+      0.553549 0.081548
+      0.623682 0.397635
+      0.955577 0.713399
+      0.755251 0.738116
+      0.222049 0.848766
+      0.610839 0.640641
+      0.365384 0.557413
+      0.588931 0.729206
+      0.499600 0.647990
+      0.595164 0.623111
+      0.454272 0.765467
+      0.785424 0.169279
+      0.471151 0.875395
+      0.082305 0.563577
+      0.663380 0.388467
+      0.471151 0.875395
+      0.974109 0.752969
+      0.291676 0.902525
+      0.708682 0.408126
+      0.099260 0.284851
+      0.794652 0.622739
+      0.102208 0.551926
+      0.410915 0.864756
+      0.077601 0.867479
+      0.557037 0.544085
+      0.918178 0.160594
+      0.033637 0.881283
+      0.840341 0.150243
+      0.460868 0.106369
+      0.053493 0.606240
+      0.024529 0.915769
+      0.851632 0.579533
+      0.373565 0.989409
+      0.053312 0.905517
+      0.957898 0.986987
+      0.788466 0.990658
+      0.471151 0.875395
+      0.549123 0.279801
+      0.032487 0.888641
+      0.757804 0.765084
+      0.694935 0.916861
+      0.549434 0.228668
+      0.139492 0.733289
+      0.461354 0.390380
+      0.471151 0.875395
+      0.524982 0.249173
+      0.709163 0.379225
+      0.819238 0.214670
+      0.081165 0.396860
+      0.139687 0.779311
+      0.473675 0.858320
+      0.866738 0.284465
+      0.471151 0.875395
+      0.829351 0.736150
+      0.527286 0.607688
+      0.471151 0.875395
+      0.583783 0.429422
+      0.495137 0.954908
+      0.040030 0.903398
+      0.223874 0.505780
+      0.358517 0.670916
+      0.471151 0.875395
+      0.301748 0.274012
+      0.181019 0.557376
+      0.471151 0.875395
+      0.419595 0.381648
+      0.394739 0.365678
+      0.425842 0.918191
+      0.187100 0.606288
+      0.613740 0.346862
+      0.935882 0.090132
+      0.471151 0.875395
+      0.073057 0.854432
+      0.194753 0.495499
+      0.927920 0.150350
+      0.608122 0.798225
+      0.242488 0.078238
+      0.716018 0.943040
+      0.817958 0.700579
+      0.140332 0.706376
+      0.177196 0.285759
+      0.140268 0.693171
+      0.367490 0.143725
+      0.621182 0.145030
+      0.101189 0.606257
+      0.384429 0.792596
+      0.587659 0.249628
+      0.761017 0.756178
+      0.250014 0.590594
+      0.964208 0.719457
+      0.625299 0.953472
+      0.161296 0.549138
+      0.399559 0.119084
+      0.414380 0.989806
+      0.710336 0.549263
+      0.736793 0.354110
+      0.807510 0.622316
+      0.367476 0.143729
+      0.735016 0.055289
+      0.523607 0.062044
+      0.471151 0.875395
+      0.061132 0.764557
+      0.736981 0.631057
+      0.533707 0.070873
+      0.715970 0.116335
+      0.130457 0.222928
+      0.886549 0.800244
+      0.263406 0.947106
+      0.778433 0.896560
+      0.167531 0.898042
+      0.699495 0.997569
+      0.065897 0.823981
+      0.256028 0.699518
+      0.878243 0.990779
+      0.871106 0.545147
+      0.134520 0.484864
+      0.341786 0.142460
+      0.038855 0.895906
+      0.234804 0.230494
+      0.160443 0.279197
+      0.471151 0.875395
+      0.593448 0.305218
+      0.994518 0.408127
+      0.103570 0.227133
+      0.234791 0.230499
+      0.349463 0.644960
+      0.510827 0.911246
+      0.409099 0.408175
+      0.960607 0.849331
+      0.497802 0.856731
+      0.464271 0.860605
+      -0.011128 0.443960
+      0.471151 0.875395
+      0.722589 0.992195
+      0.516744 0.429422
+      0.581522 0.545104
+      0.033412 0.915375
+      0.952912 0.356811
+      0.060927 0.734137
+      0.611505 0.092378
+      0.241976 0.863164
+      0.456614 0.860566
+      0.024417 0.896918
+      0.473575 0.858320
+      0.776507 0.470502
+      0.528050 0.647940
+      0.461434 0.606839
+      0.809646 0.735037
+      0.780356 0.356832
+      0.388830 0.737912
+      0.212021 0.838359
+      0.471151 0.875395
+      0.767854 0.104882
+      0.344821 0.910824
+      0.105086 0.706565
+      0.549224 0.799546
+      0.577227 0.306088
+      0.548698 0.322625
+      0.523979 0.262527
+      0.471151 0.875395
+      0.254509 0.649230
+      0.830491 0.372327
+      0.471151 0.875395
+      0.627976 0.444532
+      0.471151 0.875395
+      0.449000 0.955323
+      0.191037 0.952594
+      0.145624 0.649191
+      0.471151 0.875395
+      0.204780 0.273995
+      0.140268 0.693171
+      0.439948 0.382955
+      0.900693 0.731594
+      0.470795 0.955433
+      0.274057 0.029992
+      0.471151 0.875395
+      0.447454 0.858101
+      -0.031354 0.398944
+      0.002830 0.357171
+      0.385874 0.766902
+      0.187982 0.023156
+      0.478296 0.718758
+      0.471151 0.875395
+      0.316521 0.549674
+      0.947794 0.169293
+      0.749246 0.373775
+      0.084472 0.913446
+      0.914624 0.436920
+      0.255462 0.664557
+      0.768790 0.991948
+      0.190718 0.901534
+      0.850631 0.672156
+      0.549540 0.211590
+      0.332423 0.958244
+      0.204794 0.273991
+      0.139882 0.766768
+      0.806804 0.335367
+      0.470218 0.544115
+      0.658496 0.637357
+      0.516741 0.400903
+      0.347588 0.085737
+      0.939145 0.625857
+      0.504455 0.304672
+      0.267949 0.403966
+      0.429011 0.955199
+      0.685756 0.756175
+      0.471151 0.875395
+      0.471151 0.875395
+      0.216707 0.949940
+      0.900845 0.767076
+      0.024292 0.881287
+      0.439808 0.713214
+      0.463936 0.316181
+      0.160998 0.086281
+      0.928061 0.735945
+      0.322145 0.837771
+      0.579148 0.538190
+      0.080241 0.237561
+      0.210102 0.606277
+      0.887415 0.163365
+      0.910880 0.510227
+      0.741338 0.453007
+      0.272056 0.721955
+      0.827107 0.406902
+     ) ;; texcoords
+
+    (triangles
+      345 833 118
+      345 118 255
+      987 886 419
+      987 419 482
+      345 1004 1052
+      345 1052 1158
+      1048 1232 712
+      1048 712 1060
+      1060 712 662
+      1060 662 255
+      987 1004 662
+      987 662 886
+      1004 345 255
+      1004 255 662
+      712 251 886
+      712 886 662
+      1232 378 251
+      1232 251 712
+      1004 987 194
+      1004 194 1052
+      1034 1186 501
+      464 145 1093
+      295 300 806
+      295 806 1184
+      1184 806 917
+      1184 917 293
+      293 917 460
+      293 460 595
+      595 460 464
+      595 464 1093
+      186 145 1229
+      186 1229 1204
+      1122 1093 145
+      1122 145 186
+      215 595 1093
+      215 1093 1122
+      1074 293 595
+      1074 595 215
+      137 1184 293
+      137 293 1074
+      450 295 1184
+      450 1184 137
+      74 1228 681
+      74 681 1083
+      1204 1229 1228
+      1204 1228 74
+      536 52 1204
+      536 1204 74
+      846 536 74
+      846 74 1083
+      820 252 450
+      820 450 137
+      262 820 137
+      262 137 1074
+      272 262 1074
+      272 1074 215
+      916 272 215
+      916 215 1122
+      617 916 1122
+      617 1122 186
+      52 617 186
+      52 186 1204
+      295 634 373
+      295 373 300
+      634 962 842
+      634 842 373
+      962 693 801
+      962 801 842
+      693 1034 501
+      693 501 801
+      1037 1154 259
+      1037 259 1186
+      520 1037 1186
+      520 1186 1034
+      455 520 1034
+      455 1034 693
+      1077 455 693
+      1077 693 962
+      1173 1077 962
+      1173 962 634
+      450 1173 634
+      450 634 295
+      555 1083 681
+      555 681 57
+      1154 555 57
+      1154 57 259
+      1154 1058 929
+      1154 929 555
+      846 1083 555
+      846 555 929
+      314 1173 450
+      314 450 252
+      528 1077 1173
+      528 1173 314
+      1197 455 1077
+      1197 1077 528
+      739 520 455
+      739 455 1197
+      1181 1037 520
+      1181 520 739
+      1058 1154 1037
+      1058 1037 1181
+      926 1167 936
+      926 936 933
+      933 936 177
+      933 177 1031
+      146 926 1076
+      146 1076 958
+      857 105 181
+      857 181 598
+      598 181 800
+      598 800 723
+      924 740 38
+      924 38 891
+      924 704 1220
+      924 1220 566
+      1220 1027 882
+      1220 882 566
+      772 1046 1238
+      772 1238 525
+      1046 226 206
+      1046 206 1157
+      847 877 388
+      847 388 657
+      226 438 85
+      226 85 206
+      66 847 657
+      66 657 164
+      438 933 1031
+      438 1031 85
+      704 66 164
+      704 164 1220
+      936 598 723
+      936 723 177
+      740 924 566
+      740 566 204
+      327 704 924
+      327 924 891
+      438 1076 926
+      438 926 933
+      643 66 704
+      643 704 327
+      103 847 66
+      103 66 643
+      544 958 1076
+      1116 877 847
+      1116 847 103
+      374 1092 356
+      374 444 1092
+      1174 405 223
+      1174 143 405
+      56 564 816
+      56 433 564
+      1245 359 865
+      1245 1183 359
+      80 1069 369
+      369 1069 726
+      369 73 663
+      369 663 549
+      558 954 31
+      558 577 954
+      445 166 558
+      445 558 271
+      1241 386 36
+      1241 856 386
+      163 1092 803
+      163 803 835
+      356 1092 1096
+      1206 36 840
+      1206 1047 36
+      519 606 56
+      519 56 816
+      155 564 433
+      155 433 1159
+      155 282 816
+      155 816 564
+      282 425 519
+      282 519 816
+      31 1073 425
+      31 425 282
+      271 31 282
+      271 282 155
+      271 155 1159
+      271 1159 445
+      527 287 840
+      527 840 751
+      125 751 840
+      125 840 577
+      166 125 577
+      166 577 558
+      31 271 558
+      36 954 577
+      36 577 840
+      840 287 1206
+      31 954 46
+      31 46 1073
+      1092 163 1096
+      36 1047 1241
+      46 954 36
+      46 36 386
+      99 895 386
+      99 386 856
+      1049 803 405
+      1049 835 803
+      143 94 405
+      1033 49 895
+      1033 895 638
+      519 1183 1245
+      519 1245 606
+      1218 1170 865
+      1218 865 359
+      1218 359 1183
+      1218 1183 306
+      306 1183 519
+      306 519 425
+      80 306 425
+      80 425 1073
+      549 1218 306
+      549 306 80
+      549 663 1170
+      549 1170 1218
+      308 659 49
+      308 49 1010
+      793 726 49
+      793 49 659
+      726 793 73
+      726 73 369
+      80 369 549
+      726 1069 895
+      726 895 49
+      49 1033 1010
+      46 1069 80
+      46 80 1073
+      405 94 1049
+      895 99 638
+      895 1069 46
+      895 46 386
+      569 1087 826
+      569 826 236
+      92 742 1087
+      92 1087 569
+      927 1149 742
+      927 742 92
+      1156 795 368
+      1156 368 420
+      1221 1156 420
+      1221 420 197
+      605 1221 197
+      605 197 848
+      245 96 1221
+      245 1221 605
+      96 930 1156
+      96 1156 1221
+      930 320 795
+      930 795 1156
+      183 904 97
+      183 97 91
+      91 97 430
+      91 430 928
+      928 430 1065
+      928 1065 1193
+      97 904 320
+      97 320 930
+      430 97 930
+      430 930 96
+      1065 430 96
+      1065 96 245
+      826 1087 928
+      826 928 1193
+      1087 742 91
+      1087 91 928
+      742 1149 183
+      742 183 91
+      573 123 927
+      573 927 92
+      1088 573 92
+      1088 92 569
+      971 1088 569
+      971 569 236
+      311 478 1088
+      311 1088 971
+      478 979 573
+      478 573 1088
+      979 497 123
+      979 123 573
+      647 478 311
+      647 311 765
+      940 979 478
+      940 478 647
+      922 497 979
+      922 979 940
+      832 363 148
+      832 148 997
+      759 832 997
+      759 997 761
+      389 759 761
+      389 761 77
+      368 420 197
+      368 197 848
+      1078 420 368
+      1078 368 591
+      684 197 420
+      684 420 1078
+      931 848 197
+      931 197 684
+      1005 931 684
+      1005 684 1023
+      1023 684 1078
+      1023 1078 275
+      275 1078 591
+      275 591 1185
+      513 67 8
+      513 8 286
+      67 1036 711
+      67 711 8
+      1036 418 321
+      1036 321 711
+      8 275 1185
+      8 1185 286
+      711 1023 275
+      711 275 8
+      321 1005 1023
+      321 1023 711
+      148 418 1036
+      148 1036 997
+      997 1036 67
+      997 67 761
+      761 67 513
+      761 513 77
+      1068 759 389
+      1068 389 266
+      636 832 759
+      636 759 1068
+      875 363 832
+      875 832 636
+      729 875 636
+      729 636 1019
+      1019 636 1068
+      1019 1068 949
+      949 1068 266
+      949 266 468
+      981 652 729
+      981 729 1019
+      1117 981 1019
+      1117 1019 949
+      1207 1117 949
+      1207 949 468
+      1070 867 1200
+      1070 1200 531
+      202 1017 40
+      202 40 661
+      21 244 290
+      21 290 1208
+      1070 607 88
+      1070 88 867
+      1208 156 590
+      1208 590 21
+      40 360 738
+      40 738 661
+      867 1153 990
+      867 990 1200
+      911 580 738
+      911 738 360
+      580 804 1021
+      580 1021 738
+      1085 1113 233
+      1085 233 1095
+      1070 673 119
+      1070 119 607
+      1070 228 673
+      641 934 228
+      641 228 150
+      746 1017 641
+      746 641 411
+      150 1041 411
+      150 411 641
+      531 589 1041
+      531 1041 150
+      244 919 547
+      244 547 290
+      919 869 1055
+      919 1055 547
+      1095 233 654
+      1095 654 202
+      607 119 114
+      607 114 1001
+      1110 1021 804
+      1110 896 1021
+      1113 114 119
+      1113 119 233
+      654 233 119
+      654 119 673
+      867 88 876
+      867 876 1153
+      228 934 654
+      228 654 673
+      934 202 654
+      1081 1021 896
+      1081 896 714
+      1085 1095 1081
+      1085 1081 714
+      1001 1043 88
+      1001 88 607
+      1043 1011 876
+      1043 876 88
+      661 738 1021
+      661 1021 1081
+      661 1081 1095
+      661 1095 202
+      641 202 934
+      641 1017 202
+      150 1070 531
+      150 228 1070
+      767 408 1145
+      767 1145 1239
+      180 1140 942
+      180 942 627
+      627 881 1098
+      627 1098 180
+      627 610 1235
+      627 1235 881
+      942 784 610
+      942 610 627
+      408 619 510
+      408 510 1145
+      510 619 610
+      510 610 784
+      180 724 243
+      180 243 1140
+      756 1104 485
+      756 485 65
+      756 65 243
+      756 243 724
+      408 956 5
+      408 5 619
+      767 404 956
+      767 956 408
+      619 1235 610
+      180 1098 299
+      180 299 724
+      1104 756 1222
+      1104 1222 683
+      299 1098 13
+      299 13 339
+      1235 5 1
+      1235 619 5
+      881 1235 1
+      881 1 582
+      1098 881 582
+      1098 582 13
+      65 974 853
+      65 853 243
+      485 399 974
+      485 974 65
+      243 853 457
+      243 457 1140
+      784 141 109
+      784 109 510
+      510 109 207
+      510 207 1145
+      942 1216 141
+      942 141 784
+      1140 457 1216
+      1140 1216 942
+      1145 207 967
+      1145 967 1239
+      503 299 339
+      724 1222 756
+      503 1222 724
+      503 724 299
+      925 210 516
+      925 305 210
+      210 1138 516
+      925 1196 305
+      561 344 567
+      561 567 1014
+      1146 269 1191
+      1146 1191 185
+      269 727 352
+      269 352 1191
+      1127 561 1014
+      1127 1014 397
+      727 1127 397
+      727 397 352
+      291 1146 185
+      291 185 844
+      2 329 1084
+      2 1084 644
+      329 291 844
+      329 844 1084
+      600 599 1202
+      600 1202 950
+      950 1202 703
+      950 703 182
+      182 238 392
+      182 703 238
+      305 1196 599
+      305 599 600
+      1119 6 516
+      1119 516 1138
+      174 210 305
+      174 305 600
+      392 805 182
+      422 25 939
+      422 939 364
+      25 392 238
+      25 238 939
+      1138 210 291
+      1138 291 329
+      2 1119 1138
+      2 1138 329
+      174 1146 291
+      174 291 210
+      1127 727 805
+      1127 805 392
+      25 561 1127
+      25 1127 392
+      269 11 805
+      269 805 727
+      11 950 182
+      11 182 805
+      11 174 600
+      11 600 950
+      174 11 269
+      174 269 1146
+      422 344 561
+      422 561 25
+      969 375 179
+      969 179 834
+      1131 383 111
+      1131 111 212
+      921 161 1175
+      921 1175 106
+      834 383 1131
+      834 1131 969
+      161 921 398
+      161 398 732
+      969 1131 476
+      969 476 660
+      660 45 375
+      660 375 969
+      45 660 14
+      45 14 396
+      476 899 274
+      476 274 968
+      660 476 968
+      660 968 14
+      732 398 432
+      732 432 448
+      732 743 674
+      732 674 909
+      476 1131 640
+      476 640 695
+      161 732 909
+      161 909 20
+      1131 212 951
+      1131 951 640
+      640 951 200
+      640 200 1172
+      20 909 350
+      20 350 247
+      695 640 1172
+      695 1172 479
+      586 695 479
+      586 479 1162
+      1172 980 873
+      1172 873 479
+      448 432 1129
+      448 1129 434
+      427 552 14
+      427 14 968
+      968 274 966
+      968 966 427
+      552 957 396
+      552 396 14
+      552 427 434
+      552 434 1129
+      585 90 387
+      585 387 440
+      440 387 748
+      440 748 86
+      86 748 576
+      86 576 1114
+      905 789 1114
+      905 1114 576
+      898 1050 888
+      898 888 264
+      264 888 102
+      264 102 171
+      888 341 1125
+      888 1125 102
+      1050 328 341
+      1050 341 888
+      102 1125 394
+      102 394 1022
+      576 104 191
+      576 191 905
+      748 1008 104
+      748 104 576
+      387 461 1008
+      387 1008 748
+      90 318 461
+      90 461 387
+      318 489 467
+      318 467 461
+      461 467 554
+      461 554 1008
+      1008 302 104
+      377 616 568
+      377 568 1007
+      543 1224 616
+      543 616 377
+      1007 568 132
+      1007 132 139
+      594 230 1224
+      594 1224 543
+      554 211 230
+      554 230 594
+      467 75 211
+      467 211 554
+      489 1067 75
+      489 75 467
+      1007 548 449
+      1007 449 377
+      377 449 1234
+      377 1234 543
+      543 1234 50
+      543 50 594
+      594 50 462
+      594 462 302
+      104 84 687
+      104 687 191
+      328 984 37
+      328 37 341
+      341 37 1121
+      341 1121 1125
+      845 810 416
+      845 416 452
+      893 948 584
+      893 584 170
+      170 584 810
+      170 810 845
+      75 1180 319
+      75 319 211
+      211 319 918
+      211 918 230
+      230 918 58
+      230 58 1224
+      568 996 779
+      568 779 132
+      1224 58 463
+      1224 463 616
+      616 463 996
+      616 996 568
+      1214 1063 489
+      1214 489 318
+      219 1214 318
+      219 318 90
+      302 462 84
+      302 84 104
+      302 554 594
+      302 1008 554
+      209 918 319
+      209 319 1059
+      977 372 855
+      948 893 977
+      948 977 855
+      98 548 1007
+      98 1007 139
+      947 720 622
+      947 622 760
+      720 505 675
+      720 675 622
+      505 134 535
+      505 535 675
+      134 1126 546
+      134 546 535
+      1105 854 1161
+      1105 1161 69
+      854 868 633
+      854 633 1161
+      1161 633 809
+      1161 809 426
+      69 1161 426
+      69 426 541
+      633 1022 394
+      633 394 809
+      535 546 945
+      535 945 454
+      675 535 454
+      675 454 689
+      622 675 689
+      622 689 773
+      760 622 773
+      760 773 333
+      333 773 315
+      333 315 149
+      773 689 153
+      773 153 315
+      689 454 908
+      884 158 692
+      884 692 937
+      477 884 937
+      477 937 1143
+      158 139 132
+      158 132 692
+      989 477 1143
+      989 1143 798
+      153 989 798
+      153 798 492
+      315 153 492
+      315 492 1108
+      149 315 1108
+      149 1108 381
+      158 884 1091
+      158 1091 205
+      884 477 517
+      884 517 1091
+      477 989 423
+      477 423 517
+      989 908 261
+      989 261 423
+      454 945 694
+      454 694 819
+      541 426 907
+      541 907 26
+      426 809 41
+      426 41 907
+      495 452 416
+      495 416 371
+      439 400 670
+      439 670 297
+      400 495 371
+      400 371 670
+      1108 492 872
+      1108 872 611
+      492 798 749
+      492 749 872
+      798 1143 1178
+      798 1178 749
+      692 132 779
+      692 779 135
+      1143 937 813
+      1143 813 1178
+      937 692 135
+      937 135 813
+      1214 333 149
+      1214 149 1063
+      219 760 333
+      219 333 1214
+      908 454 819
+      908 819 261
+      908 989 153
+      908 153 689
+      209 1059 872
+      209 872 749
+      755 1120 331
+      297 1120 755
+      297 755 439
+      98 139 158
+      98 158 205
+      1180 1015 1059
+      1180 1059 319
+      1059 1015 611
+      1059 611 872
+      1108 611 381
+      1180 75 1067
+      384 453 395
+      384 395 133
+      960 469 824
+      960 824 129
+      1215 258 1020
+      1215 1020 716
+      453 384 960
+      453 960 129
+      716 175 409
+      716 409 1215
+      384 1188 1212
+      384 1212 960
+      1188 384 133
+      1188 133 487
+      487 33 1230
+      487 1230 1188
+      1212 814 144
+      1212 144 29
+      1188 1230 814
+      1188 814 1212
+      175 802 458
+      175 458 409
+      175 961 265
+      175 265 1039
+      1212 437 237
+      1212 237 960
+      716 782 961
+      716 961 175
+      960 237 964
+      960 964 469
+      237 770 142
+      237 142 964
+      782 499 849
+      782 849 961
+      437 1026 770
+      437 770 237
+      735 1016 1026
+      735 1026 437
+      770 1026 829
+      770 829 336
+      802 249 504
+      802 504 458
+      1230 53 385
+      1230 385 814
+      814 385 758
+      814 758 144
+      53 1230 33
+      53 33 122
+      53 504 249
+      53 249 385
+      296 152 701
+      296 701 241
+      72 592 471
+      72 471 1225
+      1003 9 982
+      1003 982 357
+      296 241 165
+      296 165 1006
+      357 982 781
+      357 781 750
+      72 1225 823
+      72 823 522
+      241 701 1199
+      241 1199 187
+      172 522 823
+      172 823 44
+      44 823 346
+      44 346 93
+      680 169 843
+      680 843 506
+      296 1006 1137
+      296 1137 887
+      296 887 537
+      664 858 537
+      664 537 667
+      664 592 1102
+      664 1102 1141
+      858 664 1141
+      858 1141 572
+      152 858 572
+      152 572 351
+      9 1003 279
+      9 279 678
+      678 279 688
+      678 688 474
+      169 471 676
+      169 676 843
+      1006 253 920
+      1006 920 1137
+      737 93 346
+      737 346 526
+      506 843 1137
+      506 1137 920
+      676 887 1137
+      676 1137 843
+      241 187 358
+      241 358 165
+      537 887 676
+      537 676 667
+      667 676 471
+      480 526 346
+      480 136 526
+      680 136 480
+      680 480 169
+      253 1006 165
+      253 165 744
+      744 165 358
+      744 358 1035
+      1225 480 346
+      1225 346 823
+      1225 471 169
+      1225 169 480
+      664 667 471
+      471 592 664
+      858 152 296
+      858 296 537
+      59 597 1089
+      59 1089 658
+      162 686 3
+      162 3 89
+      79 176 706
+      79 706 326
+      326 706 281
+      326 281 946
+      686 162 642
+      686 642 28
+      59 658 1044
+      59 1044 815
+      583 972 1079
+      583 1079 294
+      176 79 239
+      176 239 794
+      89 3 441
+      89 441 880
+      1089 597 325
+      1089 325 1226
+      1226 325 562
+      1226 562 708
+      880 441 414
+      880 414 196
+      794 239 648
+      794 648 699
+      699 648 1210
+      699 1210 121
+      196 414 472
+      196 472 126
+      708 562 1054
+      708 1054 978
+      436 1195 1187
+      436 1187 443
+      1187 1195 222
+      1187 222 620
+      472 414 571
+      472 571 807
+      699 121 112
+      699 112 1103
+      414 441 1201
+      414 1201 571
+      794 699 1103
+      794 1103 1101
+      441 3 768
+      441 768 1201
+      176 794 1101
+      176 1101 304
+      1079 972 1148
+      1079 1148 401
+      686 28 303
+      686 303 618
+      281 706 994
+      281 994 1071
+      3 686 618
+      3 618 768
+      706 176 304
+      706 304 994
+      401 1148 529
+      401 529 1151
+      620 222 229
+      620 229 61
+      229 1152 390
+      229 390 61
+      1103 1176 1101
+      112 1176 1103
+      571 1201 465
+      571 465 807
+      304 1160 1123
+      768 682 431
+      618 682 768
+      994 304 1123
+      994 1123 938
+      618 486 682
+      1071 994 938
+      303 486 618
+      1176 304 1101
+      465 1201 768
+      818 61 390
+      1160 304 1176
+      768 431 465
+      1165 1152 229
+      587 403 538
+      587 538 366
+      733 1106 799
+      733 799 821
+      173 910 483
+      173 483 976
+      579 1090 910
+      579 910 173
+      615 16 1090
+      615 1090 579
+      976 483 1106
+      976 1106 733
+      615 587 366
+      615 366 16
+      821 799 1051
+      821 1051 852
+      216 193 774
+      216 774 970
+      970 774 700
+      970 700 309
+      216 1086 509
+      216 509 193
+      514 963 532
+      514 532 62
+      498 943 317
+      498 317 672
+      511 874 719
+      511 719 841
+      874 451 612
+      874 612 719
+      289 498 672
+      289 672 1237
+      514 201 48
+      514 48 963
+      515 195 613
+      515 613 412
+      841 335 1134
+      841 1134 511
+      943 892 323
+      943 323 317
+      532 863 915
+      532 915 62
+      863 553 912
+      863 912 915
+      892 18 669
+      892 669 323
+      335 23 313
+      335 313 1134
+      23 609 76
+      23 76 313
+      18 1244 190
+      18 190 669
+      553 1115 35
+      553 35 912
+      757 608 785
+      757 785 570
+      785 429 890
+      785 890 570
+      190 1171 1012
+      190 1012 669
+      23 1192 347
+      23 347 609
+      669 1012 19
+      669 19 323
+      335 902 1192
+      335 1192 23
+      323 19 1107
+      323 1107 317
+      841 1064 902
+      841 902 335
+      613 602 488
+      613 488 412
+      672 154 475
+      672 475 1237
+      612 131 1217
+      612 1217 719
+      317 1107 154
+      317 154 672
+      719 1217 1064
+      719 1064 841
+      602 965 991
+      602 991 488
+      429 110 574
+      429 574 890
+      574 110 1163
+      574 1163 10
+      1192 902 491
+      347 1192 491
+      1012 117 19
+      1012 1171 117
+      1064 521 697
+      1107 575 220
+      154 1107 220
+      1217 521 1064
+      1217 367 521
+      154 220 906
+      131 367 1217
+      475 154 906
+      491 902 1064
+      117 1107 19
+      1198 1163 110
+      697 491 1064
+      1107 117 575
+      1072 574 10
+      1182 68 32
+      1182 32 604
+      288 671 82
+      288 82 811
+      442 1189 7
+      442 7 280
+      51 442 280
+      51 280 376
+      500 51 376
+      500 376 1240
+      1189 288 811
+      1189 811 7
+      500 1240 68
+      500 68 1182
+      671 130 666
+      671 666 82
+      796 379 203
+      796 203 1190
+      379 78 1066
+      379 1066 203
+      796 1190 214
+      796 214 1142
+      941 1032 825
+      941 825 581
+      1032 534 825
+      941 650 47
+      941 47 1032
+      986 435 283
+      986 283 1144
+      1136 1242 533
+      1136 533 512
+      752 1136 512
+      752 512 1053
+      709 581 825
+      709 825 953
+      953 825 534
+      953 534 1177
+      988 894 955
+      988 955 260
+      533 1242 234
+      533 234 337
+      1177 534 894
+      1177 894 988
+      283 234 1242
+      55 1029 257
+      55 257 276
+      276 257 1097
+      55 276 728
+      55 728 63
+      623 1040 1243
+      623 1243 730
+      533 859 628
+      533 628 512
+      512 628 95
+      512 95 1053
+      257 1029 709
+      257 709 953
+      953 1177 1097
+      953 1097 257
+      988 260 731
+      988 731 653
+      533 337 1166
+      533 1166 859
+      1177 988 653
+      1177 653 1097
+      1243 859 1166
+      1243 1166 362
+      1243 362 730
+      283 435 1209
+      283 1209 234
+      337 234 1209
+      337 1209 679
+      362 1166 337
+      362 337 679
+      1053 95 524
+      1053 524 883
+      752 1053 883
+      752 883 15
+      539 213 1150
+      539 1150 231
+      54 718 248
+      54 248 24
+      718 54 242
+      718 242 817
+      539 231 983
+      539 983 330
+      983 817 242
+      983 242 330
+      24 248 250
+      24 250 1062
+      1150 213 254
+      1150 254 343
+      885 1062 250
+      885 250 184
+      254 213 189
+      254 189 413
+      1062 885 822
+      1062 822 780
+      24 1062 780
+      24 780 1099
+      242 54 199
+      242 199 168
+      330 242 168
+      330 168 862
+      539 330 862
+      539 862 496
+      54 24 1099
+      54 1099 199
+      213 539 496
+      213 496 189
+      250 248 889
+      250 889 763
+      184 250 763
+      184 763 973
+      1150 343 493
+      1150 493 677
+      983 231 837
+      983 837 192
+      817 983 192
+      817 192 812
+      718 817 812
+      718 812 407
+      248 718 407
+      248 407 889
+      231 1150 677
+      231 677 837
+      189 496 113
+      189 113 831
+      199 1099 944
+      199 944 1211
+      496 862 481
+      496 481 113
+      862 168 270
+      862 270 481
+      168 199 1211
+      168 1211 270
+      1099 780 1132
+      1099 1132 944
+      780 822 312
+      780 312 1132
+      413 189 831
+      413 831 797
+      355 0 1038
+      355 1038 227
+      1025 277 1227
+      1025 1227 707
+      34 1025 707
+      34 707 850
+      1075 1169 167
+      1075 167 563
+      1194 1075 563
+      1194 563 256
+      745 1194 256
+      745 256 645
+      1169 34 850
+      1169 850 167
+      0 745 645
+      0 645 1038
+      1038 645 630
+      1038 630 556
+      167 850 393
+      167 393 838
+      645 256 1231
+      645 1231 630
+      256 563 542
+      256 542 1231
+      563 167 838
+      563 838 542
+      850 707 1109
+      850 1109 393
+      707 1227 705
+      707 705 1109
+      227 1038 556
+      227 556 901
+      901 556 208
+      901 208 39
+      1109 705 601
+      1109 601 1061
+      393 1109 1061
+      393 1061 631
+      542 838 702
+      542 702 932
+      1231 542 932
+      1231 932 473
+      630 1231 473
+      630 473 447
+      838 393 631
+      838 631 702
+      556 630 447
+      556 447 208
+      217 1223 621
+      217 621 424
+      860 1118 935
+      860 935 952
+      1223 365 1002
+      1223 1002 621
+      365 484 518
+      365 518 1002
+      484 860 952
+      484 952 518
+      1118 225 839
+      1118 839 935
+      225 1124 783
+      225 783 839
+      836 217 424
+      836 424 992
+      992 424 1024
+      992 1024 596
+      839 783 354
+      839 354 60
+      935 839 60
+      935 60 787
+      518 952 1000
+      518 1000 626
+      1002 518 626
+      1002 626 147
+      621 1002 147
+      621 147 734
+      952 935 787
+      952 787 1000
+      424 621 734
+      424 734 1024
+      736 307 603
+      736 603 741
+      1130 221 792
+      1130 792 861
+      861 42 159
+      861 159 1130
+      736 637 593
+      736 593 307
+      593 637 159
+      593 159 42
+      221 43 649
+      221 649 792
+      603 292 624
+      603 624 741
+      235 790 649
+      235 649 43
+      624 240 864
+      624 864 741
+      43 81 1112
+      43 1112 235
+      221 64 81
+      221 81 43
+      159 100 340
+      159 340 1130
+      637 428 100
+      637 100 159
+      736 415 428
+      736 428 637
+      1130 340 64
+      1130 64 221
+      415 736 741
+      415 741 864
+      649 923 178
+      649 178 792
+      790 632 923
+      790 923 649
+      603 985 246
+      603 246 292
+      593 101 1128
+      593 1128 307
+      42 421 101
+      42 101 593
+      861 900 421
+      861 421 42
+      792 178 900
+      792 900 861
+      307 1128 985
+      307 985 603
+      864 502 1135
+      864 1135 415
+      340 116 1155
+      340 1155 64
+      415 1135 710
+      415 710 428
+      428 710 1057
+      428 1057 100
+      100 1057 116
+      100 116 340
+      64 1155 771
+      64 771 81
+      81 771 827
+      81 827 1112
+      240 1056 502
+      240 502 864
+      232 588 993
+      232 993 490
+      87 151 614
+      87 614 284
+      410 999 151
+      410 151 87
+      560 851 224
+      560 224 459
+      263 160 851
+      263 851 560
+      1236 557 160
+      1236 160 263
+      459 224 999
+      459 999 410
+      490 993 557
+      490 557 1236
+      993 1013 391
+      993 391 557
+      224 651 508
+      224 508 999
+      557 391 698
+      557 698 160
+      160 698 348
+      160 348 851
+      851 348 651
+      851 651 224
+      999 508 998
+      999 998 151
+      151 998 494
+      151 494 614
+      588 324 1013
+      588 1013 993
+      324 278 668
+      324 668 1013
+      998 380 301
+      998 301 494
+      508 713 380
+      508 380 998
+      348 870 897
+      348 897 651
+      698 127 870
+      698 870 348
+      391 914 127
+      391 127 698
+      651 897 713
+      651 713 508
+      1013 668 914
+      1013 914 391
+      766 995 1009
+      766 1009 769
+      507 1213 545
+      507 545 124
+      769 1009 138
+      769 138 655
+      655 138 523
+      655 523 691
+      691 523 1213
+      691 1213 507
+      124 545 27
+      124 27 1042
+      1042 27 140
+      1042 140 157
+      551 30 995
+      551 995 766
+      30 1111 828
+      30 828 995
+      27 322 470
+      27 470 140
+      545 1100 322
+      545 322 27
+      523 361 786
+      523 786 1213
+      138 764 361
+      138 361 523
+      1009 625 764
+      1009 764 138
+      1213 786 1100
+      1213 1100 545
+      995 828 625
+      995 625 1009
+      717 656 646
+      717 646 316
+      975 775 120
+      975 120 466
+      466 120 108
+      466 108 1164
+      717 903 778
+      717 778 1164
+      656 717 1164
+      656 1164 108
+      788 466 1164
+      788 1164 778
+      22 975 466
+      22 466 788
+      903 717 316
+      903 316 406
+      656 108 578
+      656 578 530
+      903 1080 1139
+      903 1139 778
+      544 1076 438
+      544 438 226
+      544 226 1046
+      544 1046 107
+      4 107 1046
+      4 1046 772
+      857 598 936
+      857 936 1167
+      723 800 218
+      723 218 882
+      882 1027 177
+      882 177 723
+      882 218 204
+      882 204 566
+      456 206 198
+      1027 1220 164
+      1027 164 83
+      164 657 198
+      164 198 83
+      657 388 456
+      657 456 198
+      206 85 83
+      206 83 198
+      1031 177 1027
+      1031 1027 83
+      1031 83 85
+      747 338 71
+      747 71 268
+      747 268 559
+      777 754 71
+      777 71 338
+      334 754 629
+      334 629 1028
+      665 71 754
+      665 754 334
+      268 71 665
+      268 665 115
+      629 754 777
+      913 370 550
+      913 550 12
+      913 791 559
+      913 559 268
+      791 913 12
+      791 12 1233
+      857 1030 17
+      857 17 188
+      4 753 1219
+      4 1219 107
+      544 107 1219
+      544 1219 267
+      544 267 1168
+      544 1168 310
+      1205 417 879
+      1205 879 878
+      544 310 958
+      417 776 762
+      417 762 879
+      776 446 1147
+      776 1147 762
+      1168 696 639
+      1168 639 310
+      446 565 1082
+      446 1082 1147
+      830 550 370
+      830 370 1082
+      17 559 791
+      17 791 188
+      1147 115 665
+      1147 665 762
+      1168 338 747
+      1168 747 696
+      762 665 334
+      762 334 879
+      267 777 338
+      267 338 1168
+      879 334 1028
+      879 1028 878
+      1219 1018 777
+      1219 777 267
+      753 353 402
+      753 402 1219
+      115 370 913
+      115 913 268
+      1082 370 115
+      1082 115 1147
+      1082 565 722
+      1082 722 830
+      188 791 1233
+      188 1233 1203
+      857 188 1203
+      857 1203 105
+      146 958 310
+      146 310 639
+      696 747 559
+      696 559 17
+      639 696 17
+      639 17 1030
+      857 298 1030
+      1167 298 857
+      146 298 1167
+      146 1167 926
+      146 639 1030
+      146 1030 298
+      171 102 1022
+      171 1022 715
+      868 715 1022
+      868 1022 633
+      463 1179 779
+      463 779 996
+      813 135 779
+      813 779 1179
+      489 1063 540
+      489 540 1067
+      149 381 540
+      149 540 1063
+      1180 1067 540
+      1180 540 1015
+      611 1015 540
+      611 540 381
+      1125 1121 959
+      1125 959 394
+      809 394 959
+      809 959 41
+      854 128 715
+      854 715 868
+      264 171 715
+      264 715 128
+      332 685 725
+      332 725 285
+      1045 1094 725
+      1045 725 685
+      1094 808 871
+      1094 871 725
+      285 725 871
+      285 871 721
+      721 871 349
+      721 349 342
+      808 382 349
+      808 349 871
+      382 1133 635
+      382 635 349
+      342 349 635
+      342 635 690
+      585 440 866
+      585 866 70
+      947 70 866
+      947 866 720
+      219 90 585
+      219 585 70
+      219 70 947
+      219 947 760
+      58 918 209
+      58 209 273
+      1178 273 209
+      1178 209 749
+      463 58 273
+      463 273 1179
+      813 1179 273
+      813 273 1178
+     ) ;; triangles
+
+    (influences
+      (vertex
+        (index 1)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 5)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 11)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 13)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 25)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 41)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 58)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 65)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 70)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 75)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 90)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 98)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 102)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 104)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 109)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 132)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 135)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 139)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 141)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 149)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 153)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 158)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 170)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 171)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 174)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 180)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 182)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 185)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 205)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 207)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 209)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 210)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 211)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 219)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 230)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 238)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 243)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 269)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 273)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 285)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 291)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 297)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 299)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 302)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 305)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 315)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 318)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 319)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 328)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 329)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 331)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 333)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 339)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 341)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 342)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 344)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 349)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 352)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 364)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 372)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 377)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 381)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 382)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 387)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 392)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 394)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 397)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 400)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 408)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 422)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 426)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 439)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 440)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 454)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 457)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 461)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 463)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 467)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 477)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 489)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 492)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 503)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 510)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 516)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 535)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 540)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 541)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 543)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 546)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 548)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 554)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 561)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 568)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 576)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 582)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 584)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 585)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 594)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 599)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 600)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 610)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 611)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 616)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 619)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 622)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 627)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 633)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 635)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 644)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 670)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 675)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 683)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 689)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 690)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 692)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 703)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 715)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 720)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 721)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 724)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 725)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 727)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 748)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 749)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 755)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 756)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 760)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 773)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 779)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 784)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 798)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 805)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 808)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 809)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 813)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 844)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 853)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 855)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 866)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 868)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 871)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 872)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 881)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 884)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 888)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 893)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 905)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 908)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 918)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 925)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 937)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 939)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 942)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 947)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 948)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 950)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 956)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 959)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 967)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 974)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 977)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 989)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 996)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1007)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1008)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1014)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 1015)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1022)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1059)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1063)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1067)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1084)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 1094)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1098)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 1104)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 1108)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1120)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1121)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1125)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1127)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 1133)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1138)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 1140)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 1143)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1145)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 1146)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 1161)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1178)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1179)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1180)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1191)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 1196)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 1202)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.L"))))
+      (vertex
+        (index 1214)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1216)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 1222)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 1224)
+        (influeces
+          (influence (weight 1.000000) (bone "Head"))))
+      (vertex
+        (index 1235)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+      (vertex
+        (index 1239)
+        (influeces
+          (influence (weight 1.000000) (bone "Upper Leg.R"))))
+     ) ;; influencs
+
+   ) ;; mesh
+
+ ) ;; windstille-model
+
+;; EOF ;;

Added: trunk/windstille/data/armature/powersuittexture.png
===================================================================
(Binary files differ)


Property changes on: trunk/windstille/data/armature/powersuittexture.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Modified: trunk/windstille/src/armature/mesh.cpp
===================================================================
--- trunk/windstille/src/armature/mesh.cpp	2007-06-23 00:31:11 UTC (rev 1499)
+++ trunk/windstille/src/armature/mesh.cpp	2007-06-23 02:35:07 UTC (rev 1500)
@@ -28,6 +28,7 @@
 #include <iostream>
 #include "util.hpp"
 #include "display/opengl_state.hpp"
+#include "display/texture_manager.hpp"
 #include "file_reader.hpp"
 #include "mesh.hpp"
 
@@ -38,7 +39,10 @@
   if (reader.get_name() != "mesh")
     throw std::runtime_error("Not a 'mesh' type, its '" + reader.get_name() + "'");
   
+  std::string texture_filename;
+
   reader.get("name",      name);
+  reader.get("texture",   texture_filename);
   reader.get("vertices",  vertices);
   reader.get("normals",   normals);
   reader.get("texcoords", texcoords);
@@ -46,6 +50,8 @@
   
   // FIXME: add 'influences' tag parsing
 
+  texture = texture_manager->get(texture_filename);
+
   // Check that all vectors have the same right modulo
   assert(vertices.size()  % 3 == 0);
   assert(normals.size()   % 3 == 0);
@@ -56,10 +62,10 @@
   assert(vertices.size()/3 == normals.size()/3);
   assert(vertices.size()/3 == texcoords.size()/2);
 
-  std::cout << "Number of normals:   " << normals.size()   << std::endl;
-  std::cout << "Number of texcoords: " << texcoords.size() << std::endl;
-  std::cout << "Number of vertices:  " << vertices.size()  << std::endl;
-  std::cout << "Number of triangles: " << triangles.size() << std::endl;
+  std::cout << "Number of normals:   " << normals.size()/3   << std::endl;
+  std::cout << "Number of texcoords: " << texcoords.size()/2 << std::endl;
+  std::cout << "Number of vertices:  " << vertices.size()/3  << std::endl;
+  std::cout << "Number of triangles: " << triangles.size()/3 << std::endl;
 }
 
 Mesh::~Mesh()
@@ -70,7 +76,7 @@
 void
 Mesh::draw()
 {
-  std::cout << "Mesh: Drawing: " << vertices.size() << std::endl;
+  //std::cout << "Mesh: Drawing: " << vertices.size() << std::endl;
   OpenGLState state;
 
   if (blend_sfactor != GL_ONE || blend_dfactor != GL_ZERO)
@@ -82,28 +88,22 @@
     {
       state.enable(GL_DEPTH_TEST);
     }
-  
+
+  state.bind_texture(texture);
+
   glLineWidth(1.0f);
   glColor4f(1.0f, 1.0f, 1.0f, 0.5f);
-  //state.enable_client_state(GL_VERTEX_ARRAY);
-  //state.enable_client_state(GL_NORMAL_ARRAY);
-  //state.enable_client_state(GL_TEXTURE_COORD_ARRAY);  
+  state.enable_client_state(GL_VERTEX_ARRAY);
+  state.enable_client_state(GL_NORMAL_ARRAY);
+  state.enable_client_state(GL_TEXTURE_COORD_ARRAY);  
   state.activate();
 
   assert_gl("gl init before sprite");
 
-  //  glVertexPointer(3, GL_FLOAT, 0, &*vertices.begin());
-  //glNormalPointer(GL_FLOAT, 0, &*normals.begin());
-  //glTexCoordPointer(2, GL_FLOAT, 0, &*texcoords.begin());
-  //glDrawElements(GL_LINE_STRIP, triangles.size(), GL_INT, &*triangles.begin());
-  glBegin(GL_TRIANGLES);
-  for(int i = 0; i < int(triangles.size()); i += 3)
-    {
-      glVertex3f(vertices[i+0], 
-                 vertices[i+1],
-                 vertices[i+2]);
-    }
-  glEnd();
+  glVertexPointer(3, GL_FLOAT, 0, &*vertices.begin());
+  glNormalPointer(GL_FLOAT, 0, &*normals.begin());
+  glTexCoordPointer(2, GL_FLOAT, 0, &*texcoords.begin());
+  glDrawElements(GL_TRIANGLES, triangles.size(), GL_UNSIGNED_INT, &*triangles.begin());
 }
 
 /* EOF */

Modified: trunk/windstille/src/armature/mesh.hpp
===================================================================
--- trunk/windstille/src/armature/mesh.hpp	2007-06-23 00:31:11 UTC (rev 1499)
+++ trunk/windstille/src/armature/mesh.hpp	2007-06-23 02:35:07 UTC (rev 1500)
@@ -30,6 +30,7 @@
 #include <GL/gl.h>
 #include <string>
 #include <vector>
+#include "display/texture.hpp"
 
 class FileReader;
 
@@ -44,6 +45,8 @@
   std::vector<float> texcoords;
   std::vector<int>   triangles;
 
+  Texture texture;
+
   GLenum blend_sfactor;
   GLenum blend_dfactor;
 

Modified: trunk/windstille/src/armature_test.cpp
===================================================================
--- trunk/windstille/src/armature_test.cpp	2007-06-23 00:31:11 UTC (rev 1499)
+++ trunk/windstille/src/armature_test.cpp	2007-06-23 02:35:07 UTC (rev 1500)
@@ -69,7 +69,7 @@
 void
 ArmatureTest::draw()
 {
-  glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
+  glClearColor(0.2f, 0.0f, 0.2f, 1.0f);
   glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
 
   glPushMatrix();

Modified: trunk/windstille/tools/mesh_export.py
===================================================================
--- trunk/windstille/tools/mesh_export.py	2007-06-23 00:31:11 UTC (rev 1499)
+++ trunk/windstille/tools/mesh_export.py	2007-06-23 02:35:07 UTC (rev 1500)
@@ -216,6 +216,6 @@
 
 export("/tmp/mesh.scm")
 
-# Draw.PupMenu("Export ok")
+Draw.PupMenu("Export ok")
 
 # EOF #



From grumbel at mail.berlios.de  Sat Jun 23 06:07:38 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 23 Jun 2007 06:07:38 +0200
Subject: [Windstille-commit] r1501 - in trunk/windstille: src src/armature
	tools
Message-ID: <200706230407.l5N47cSS022968@sheep.berlios.de>

Author: grumbel
Date: 2007-06-23 06:07:37 +0200 (Sat, 23 Jun 2007)
New Revision: 1501

Modified:
   trunk/windstille/src/armature/mesh.cpp
   trunk/windstille/src/armature_test.cpp
   trunk/windstille/tools/mesh_export.py
Log:
- rewrote how influences get exported

Modified: trunk/windstille/src/armature/mesh.cpp
===================================================================
--- trunk/windstille/src/armature/mesh.cpp	2007-06-23 02:35:07 UTC (rev 1500)
+++ trunk/windstille/src/armature/mesh.cpp	2007-06-23 04:07:37 UTC (rev 1501)
@@ -48,8 +48,43 @@
   reader.get("texcoords", texcoords);
   reader.get("triangles", triangles);
   
-  // FIXME: add 'influences' tag parsing
+#if 0 
+  // FIXME: Broken by design
+  FileReader influences_reader;
+  if (reader.get("influences", influences_reader))
+    {
+      std::vector<FileReader> sections = influences_reader.get_sections();
+      for(std::vector<FileReader>::iterator i = sections.begin(); i != sections.end(); ++i)
+        {
+          if ((*i).get_name() == "vertex")
+            {
+              FileReader influences_sub_reader;
 
+              (*i).get("index", index);
+              if ((*i).get("influences", influences_sub_reader))
+                {
+                  std::vector<FileReader> sub_sections = influences_sub_reader.get_sections();
+                  for(std::vector<FileReader>::iterator j = sub_sections.begin(); j != sub_sections.end(); ++j)
+                    {
+                      if ((*j).get_name() == "influences")
+                        {
+                          float weight;
+                          std::string bone_name;
+                      
+                          (*j).get("weight", weight);
+                          (*j).get("bone",   bone_name);                         
+                        }
+                    }
+                }
+            }
+          else
+            {
+              std::cout << "Unknown tag: " << (*i).get_name() << std::endl;
+            }
+        }
+    }
+#endif
+
   texture = texture_manager->get(texture_filename);
 
   // Check that all vectors have the same right modulo

Modified: trunk/windstille/src/armature_test.cpp
===================================================================
--- trunk/windstille/src/armature_test.cpp	2007-06-23 02:35:07 UTC (rev 1500)
+++ trunk/windstille/src/armature_test.cpp	2007-06-23 04:07:37 UTC (rev 1501)
@@ -69,7 +69,7 @@
 void
 ArmatureTest::draw()
 {
-  glClearColor(0.2f, 0.0f, 0.2f, 1.0f);
+  glClearColor(0.3f, 0.0f, 0.3f, 1.0f);
   glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
 
   glPushMatrix();

Modified: trunk/windstille/tools/mesh_export.py
===================================================================
--- trunk/windstille/tools/mesh_export.py	2007-06-23 02:35:07 UTC (rev 1500)
+++ trunk/windstille/tools/mesh_export.py	2007-06-23 04:07:37 UTC (rev 1501)
@@ -16,6 +16,9 @@
 
         # { orig_index : VerticeData, ... }
         self.vertmap = {}
+
+        # { (bonename, weight) : VertexGroup, ...}
+        self.groups = {}
 
     def add(self, face):
         self.faces.append(face)
@@ -24,11 +27,17 @@
             self.vertmap[vert.orig_idx] = vert
 
     def add_influences(self, orig_idx, influences):
+        """influences -> [(bonename, weight), ...]"""
         if not self.vertmap.has_key(orig_idx):
             pass # this is normal due to MeshData not being a complete
                  # Blender mesh when multiple textures are in play       
         else:
             self.vertmap[orig_idx].influences = influences
+            for (bone,weight) in influences:
+                key = (bone, weight)
+                if not self.groups.has_key(key):
+                    self.groups[key] = VertexGroup(bone, weight)
+                self.groups[key].add(orig_idx)
 
     def finalize(self):
         """Reorders vertex indexes and merge vertexes which have the
@@ -72,6 +81,15 @@
                 self.normal[0], self.normal[1], self.normal[2],
                 self.uv[0], self.uv[1])
     
+
+class VertexGroup:
+    def __init__(self, bone, weight):
+        self.bone     = bone
+        self.weight   = weight
+        self.vertices = [] # [23,2,1,2,...]
+
+    def add(self, v):
+        self.vertices.append(v)
 
 class WindstilleModel:
     """WindstilleMesh is used to collect data vertex and face data
@@ -161,16 +179,28 @@
                                                 face.verts[2].index))
             out.write("     ) ;; triangles\n\n")
 
-            out.write("    (influences\n")
-            for vert in mesh.vertices:
-                if vert.influences != []:
-                    out.write("      (vertex\n")
-                    out.write("        (index %d)\n" % vert.index)
-                    out.write("        (influeces")
-                    for (bone, weight) in vert.influences:
-                        out.write("\n          (influence (weight %f) (bone \"%s\"))" % (weight, bone))
-                    out.write("))\n")
-            out.write("     ) ;; influencs\n\n")
+            out.write("    (groups\n")
+            for group in mesh.groups.values():
+                out.write("      (group\n")
+                out.write("        (bone    \"%s\")\n" % group.bone)
+                out.write("        (weight   %f)\n" % group.weight)
+                out.write("        (vertices")
+                for v in group.vertices:
+                    out.write(" %d" % v)
+                out.write(")\n")
+                out.write("       )\n")
+            out.write("     ) ;; groups\n\n")
+             
+#             out.write("    (influences\n")
+#             for vert in mesh.vertices:
+#                 if vert.influences != []:
+#                     out.write("      (vertex\n")
+#                     out.write("        (index %d)\n" % vert.index)
+#                     out.write("        (influeces")
+#                     for (bone, weight) in vert.influences:
+#                         out.write("\n          (influence (weight %f) (bone \"%s\"))" % (weight, bone))
+#                     out.write("))\n")
+#             out.write("     ) ;; influencs\n\n")
             
             out.write("   ) ;; mesh\n\n")
         out.write(" ) ;; windstille-model\n")



From grumbel at mail.berlios.de  Sat Jun 23 15:55:40 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 23 Jun 2007 15:55:40 +0200
Subject: [Windstille-commit] r1502 - in trunk/windstille: data/armature
	src/armature
Message-ID: <200706231355.l5NDteah022316@sheep.berlios.de>

Author: grumbel
Date: 2007-06-23 15:55:40 +0200 (Sat, 23 Jun 2007)
New Revision: 1502

Modified:
   trunk/windstille/data/armature/mesh.mesh
   trunk/windstille/src/armature/mesh.cpp
   trunk/windstille/src/armature/mesh.hpp
Log:
- new influences parsing code

Modified: trunk/windstille/data/armature/mesh.mesh
===================================================================
--- trunk/windstille/data/armature/mesh.mesh	2007-06-23 04:07:37 UTC (rev 1501)
+++ trunk/windstille/data/armature/mesh.mesh	2007-06-23 13:55:40 UTC (rev 1502)
@@ -3,7 +3,7 @@
   (name "")
   (mesh
     (name "")
-    (texture "armature/powersuittexture.png")
+    (texture "powersuittexture.png")
 
     (vertices
         0.991082   0.183809   0.297031 ;; 0
@@ -5369,804 +5369,23 @@
       813 273 1178
      ) ;; triangles
 
-    (influences
-      (vertex
-        (index 1)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 5)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 11)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 13)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 25)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 41)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 58)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 65)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 70)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 75)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 90)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 98)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 102)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 104)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 109)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 132)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 135)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 139)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 141)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 149)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 153)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 158)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 170)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 171)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 174)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 180)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 182)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 185)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 205)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 207)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 209)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 210)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 211)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 219)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 230)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 238)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 243)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 269)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 273)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 285)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 291)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 297)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 299)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 302)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 305)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 315)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 318)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 319)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 328)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 329)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 331)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 333)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 339)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 341)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 342)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 344)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 349)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 352)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 364)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 372)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 377)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 381)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 382)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 387)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 392)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 394)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 397)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 400)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 408)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 422)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 426)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 439)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 440)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 454)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 457)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 461)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 463)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 467)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 477)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 489)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 492)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 503)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 510)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 516)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 535)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 540)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 541)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 543)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 546)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 548)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 554)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 561)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 568)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 576)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 582)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 584)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 585)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 594)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 599)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 600)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 610)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 611)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 616)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 619)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 622)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 627)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 633)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 635)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 644)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 670)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 675)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 683)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 689)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 690)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 692)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 703)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 715)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 720)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 721)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 724)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 725)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 727)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 748)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 749)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 755)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 756)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 760)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 773)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 779)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 784)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 798)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 805)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 808)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 809)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 813)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 844)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 853)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 855)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 866)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 868)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 871)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 872)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 881)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 884)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 888)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 893)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 905)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 908)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 918)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 925)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 937)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 939)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 942)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 947)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 948)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 950)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 956)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 959)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 967)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 974)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 977)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 989)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 996)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1007)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1008)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1014)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 1015)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1022)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1059)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1063)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1067)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1084)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 1094)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1098)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 1104)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 1108)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1120)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1121)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1125)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1127)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 1133)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1138)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 1140)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 1143)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1145)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 1146)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 1161)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1178)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1179)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1180)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1191)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 1196)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 1202)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.L"))))
-      (vertex
-        (index 1214)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1216)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 1222)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 1224)
-        (influeces
-          (influence (weight 1.000000) (bone "Head"))))
-      (vertex
-        (index 1235)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-      (vertex
-        (index 1239)
-        (influeces
-          (influence (weight 1.000000) (bone "Upper Leg.R"))))
-     ) ;; influencs
+    (groups
+      (group
+        (bone    "Upper Leg.L")
+        (weight   1.000000)
+        (vertices 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344)
+       )
+      (group
+        (bone    "Upper Leg.R")
+        (weight   1.000000)
+        (vertices 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307)
+       )
+      (group
+        (bone    "Head")
+        (weight   1.000000)
+        (vertices 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 932)
+       )
+     ) ;; groups
 
    ) ;; mesh
 

Modified: trunk/windstille/src/armature/mesh.cpp
===================================================================
--- trunk/windstille/src/armature/mesh.cpp	2007-06-23 04:07:37 UTC (rev 1501)
+++ trunk/windstille/src/armature/mesh.cpp	2007-06-23 13:55:40 UTC (rev 1502)
@@ -47,7 +47,65 @@
   reader.get("normals",   normals);
   reader.get("texcoords", texcoords);
   reader.get("triangles", triangles);
-  
+
+  FileReader groups_reader;
+  if (reader.get("groups", groups_reader))
+    {
+      std::vector<FileReader> sections = groups_reader.get_sections();
+      for(std::vector<FileReader>::iterator i = sections.begin(); i != sections.end(); ++i)
+        {
+          if ((*i).get_name() == "group")
+            {
+              VertexGroup group;
+              if ((*i).get("bone",     group.bone_name) &&
+                  (*i).get("weight",   group.weight) && 
+                  (*i).get("vertices", group.vertices))
+                groups.push_back(group);
+              else
+                std::cout << "Mesh::VertexGroup: Element missing" << std::endl;
+            }
+          else
+            {
+              std::cout << "Unknown tag: " << (*i).get_name() << std::endl;
+            }
+        }
+    }
+
+  // Check that all vectors have the same right modulo
+  assert(vertices.size()  % 3 == 0);
+  assert(normals.size()   % 3 == 0);
+  assert(texcoords.size() % 2 == 0);
+
+  // Convert the data to something we can use together with Armatures
+  // and Bones
+  for(std::vector<float>::size_type i = 0; i < vertices.size()/3; ++i)
+    {
+      Vertex vertex;
+
+      vertex.pos.x = vertices[3*i+0];
+      vertex.pos.y = vertices[3*i+1];
+      vertex.pos.z = vertices[3*i+2];
+
+      vertex.normal.x = normals[3*i+0];
+      vertex.normal.y = normals[3*i+1];
+      vertex.normal.z = normals[3*i+2];
+
+      vertex.texcoord.x = texcoords[2*i+0];
+      vertex.texcoord.y = texcoords[2*i+1];
+
+      vertices_.push_back(vertex);
+    }
+
+  for(Groups::iterator i = groups.begin(); i != groups.end(); ++i)
+    {
+      VertexGroup& group = *i;
+      for(std::vector<int>::iterator j = group.vertices.begin(); j != group.vertices.end(); ++j)
+        {
+          vertices_[*j].bone_names.push_back(group.bone_name);
+          vertices_[*j].weight.push_back(group.weight);
+        }
+    }
+
 #if 0 
   // FIXME: Broken by design
   FileReader influences_reader;
@@ -87,11 +145,6 @@
 
   texture = texture_manager->get(texture_filename);
 
-  // Check that all vectors have the same right modulo
-  assert(vertices.size()  % 3 == 0);
-  assert(normals.size()   % 3 == 0);
-  assert(texcoords.size() % 2 == 0);
-
   // Check that all vectors contain enough values for the given number
   // of vertices
   assert(vertices.size()/3 == normals.size()/3);

Modified: trunk/windstille/src/armature/mesh.hpp
===================================================================
--- trunk/windstille/src/armature/mesh.hpp	2007-06-23 04:07:37 UTC (rev 1501)
+++ trunk/windstille/src/armature/mesh.hpp	2007-06-23 13:55:40 UTC (rev 1502)
@@ -30,10 +30,32 @@
 #include <GL/gl.h>
 #include <string>
 #include <vector>
+#include "math/vector.hpp"
+#include "math/vector3.hpp"
 #include "display/texture.hpp"
 
 class FileReader;
+class Bone;
 
+struct VertexGroup
+{
+  std::string bone_name;
+  float       weight;
+  std::vector<int> vertices;
+};
+
+struct Vertex
+{
+  Vector3 pos;
+  Vector3 normal;
+  Vector  texcoord;
+
+  // Influences from bone;
+  std::vector<float> weight;
+  std::vector<std::string> bone_names;
+  std::vector<Bone*> bones;
+};
+
 /** */
 class Mesh
 {
@@ -45,6 +67,12 @@
   std::vector<float> texcoords;
   std::vector<int>   triangles;
 
+  typedef std::vector<VertexGroup> Groups;
+  Groups groups;
+  
+  typedef std::vector<Vertex> Vertices;
+  Vertices vertices_;
+
   Texture texture;
 
   GLenum blend_sfactor;



From grumbel at mail.berlios.de  Sat Jun 23 16:17:10 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 23 Jun 2007 16:17:10 +0200
Subject: [Windstille-commit] r1503 - in trunk/windstille/src: . armature
Message-ID: <200706231417.l5NEHA8Y023628@sheep.berlios.de>

Author: grumbel
Date: 2007-06-23 16:17:10 +0200 (Sat, 23 Jun 2007)
New Revision: 1503

Modified:
   trunk/windstille/src/armature/mesh.cpp
   trunk/windstille/src/armature/mesh.hpp
   trunk/windstille/src/armature/model.cpp
   trunk/windstille/src/armature/model.hpp
   trunk/windstille/src/armature_test.cpp
Log:
- added directory handling for texture loading in mesh

Modified: trunk/windstille/src/armature/mesh.cpp
===================================================================
--- trunk/windstille/src/armature/mesh.cpp	2007-06-23 13:55:40 UTC (rev 1502)
+++ trunk/windstille/src/armature/mesh.cpp	2007-06-23 14:17:10 UTC (rev 1503)
@@ -32,7 +32,7 @@
 #include "file_reader.hpp"
 #include "mesh.hpp"
 
-Mesh::Mesh(FileReader& reader)
+Mesh::Mesh(FileReader& reader, const std::string& path)
   : blend_sfactor(GL_ONE),
     blend_dfactor(GL_ZERO)
 {
@@ -143,6 +143,7 @@
     }
 #endif
 
+  texture_filename = path + basename(texture_filename);
   texture = texture_manager->get(texture_filename);
 
   // Check that all vectors contain enough values for the given number

Modified: trunk/windstille/src/armature/mesh.hpp
===================================================================
--- trunk/windstille/src/armature/mesh.hpp	2007-06-23 13:55:40 UTC (rev 1502)
+++ trunk/windstille/src/armature/mesh.hpp	2007-06-23 14:17:10 UTC (rev 1503)
@@ -79,7 +79,7 @@
   GLenum blend_dfactor;
 
 public:
-  Mesh(FileReader& reader);
+  Mesh(FileReader& reader, const std::string& path);
   ~Mesh();
 
   void draw();

Modified: trunk/windstille/src/armature/model.cpp
===================================================================
--- trunk/windstille/src/armature/model.cpp	2007-06-23 13:55:40 UTC (rev 1502)
+++ trunk/windstille/src/armature/model.cpp	2007-06-23 14:17:10 UTC (rev 1503)
@@ -29,7 +29,7 @@
 #include "mesh.hpp"
 #include "model.hpp"
 
-Model::Model(FileReader& reader)
+Model::Model(FileReader& reader, const std::string& path)
 {
   if (reader.get_name() != "windstille-model")
     throw std::runtime_error("Not a 'windstille-model' file, its '" + reader.get_name() + "'");
@@ -41,7 +41,7 @@
     {
       if (i->get_name() == "mesh")
         {
-          Mesh* mesh = new Mesh(*i);
+          Mesh* mesh = new Mesh(*i, path);
           meshes.push_back(mesh);
         }
       else

Modified: trunk/windstille/src/armature/model.hpp
===================================================================
--- trunk/windstille/src/armature/model.hpp	2007-06-23 13:55:40 UTC (rev 1502)
+++ trunk/windstille/src/armature/model.hpp	2007-06-23 14:17:10 UTC (rev 1503)
@@ -41,7 +41,7 @@
   Meshes meshes;
 
 public:
-  Model(FileReader& reader);
+  Model(FileReader& reader, const std::string& path);
   ~Model();
 
   void draw();

Modified: trunk/windstille/src/armature_test.cpp
===================================================================
--- trunk/windstille/src/armature_test.cpp	2007-06-23 13:55:40 UTC (rev 1502)
+++ trunk/windstille/src/armature_test.cpp	2007-06-23 14:17:10 UTC (rev 1503)
@@ -38,7 +38,7 @@
 ArmatureTest::ArmatureTest()
 {
   FileReader model_reader = FileReader::parse("armature/mesh.mesh");
-  model = new Model(model_reader);
+  model = new Model(model_reader, "armature/");
 
   FileReader armature_reader = FileReader::parse("armature/armature.arm");
   armature = new Armature(armature_reader);
@@ -69,7 +69,7 @@
 void
 ArmatureTest::draw()
 {
-  glClearColor(0.3f, 0.0f, 0.3f, 1.0f);
+  glClearColor(0.5f, 0.0f, 0.5f, 1.0f);
   glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
 
   glPushMatrix();



From grumbel at mail.berlios.de  Sat Jun 23 16:28:14 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 23 Jun 2007 16:28:14 +0200
Subject: [Windstille-commit] r1504 - trunk/windstille/src/armature
Message-ID: <200706231428.l5NESE6F024202@sheep.berlios.de>

Author: grumbel
Date: 2007-06-23 16:28:14 +0200 (Sat, 23 Jun 2007)
New Revision: 1504

Modified:
   trunk/windstille/src/armature/mesh.cpp
   trunk/windstille/src/armature/mesh.hpp
Log:
- added code to normalize bone weighting

Modified: trunk/windstille/src/armature/mesh.cpp
===================================================================
--- trunk/windstille/src/armature/mesh.cpp	2007-06-23 14:17:10 UTC (rev 1503)
+++ trunk/windstille/src/armature/mesh.cpp	2007-06-23 14:28:14 UTC (rev 1504)
@@ -60,7 +60,9 @@
               if ((*i).get("bone",     group.bone_name) &&
                   (*i).get("weight",   group.weight) && 
                   (*i).get("vertices", group.vertices))
-                groups.push_back(group);
+
+                if (group.weight != 0.0f) // ignore useless bones
+                  groups.push_back(group);
               else
                 std::cout << "Mesh::VertexGroup: Element missing" << std::endl;
             }
@@ -95,16 +97,28 @@
 
       vertices_.push_back(vertex);
     }
-
+  
+  // Add bone and weight to the individual vertices
   for(Groups::iterator i = groups.begin(); i != groups.end(); ++i)
     {
       VertexGroup& group = *i;
       for(std::vector<int>::iterator j = group.vertices.begin(); j != group.vertices.end(); ++j)
         {
           vertices_[*j].bone_names.push_back(group.bone_name);
-          vertices_[*j].weight.push_back(group.weight);
+          vertices_[*j].weights.push_back(group.weight);
         }
     }
+  
+  // Normalize Weight to 1.0f
+  for(Vertices::iterator i = vertices_.begin(); i != vertices_.end(); ++i)
+    {
+      float total_weight = 0.0f;
+      for(std::vector<float>::iterator w = i->weights.begin(); w != i->weights.end(); ++w)
+        total_weight += *w;
+     
+      for(std::vector<float>::iterator w = i->weights.begin(); w != i->weights.end(); ++w)
+        *w /= total_weight;
+    }
 
 #if 0 
   // FIXME: Broken by design

Modified: trunk/windstille/src/armature/mesh.hpp
===================================================================
--- trunk/windstille/src/armature/mesh.hpp	2007-06-23 14:17:10 UTC (rev 1503)
+++ trunk/windstille/src/armature/mesh.hpp	2007-06-23 14:28:14 UTC (rev 1504)
@@ -51,7 +51,7 @@
   Vector  texcoord;
 
   // Influences from bone;
-  std::vector<float> weight;
+  std::vector<float> weights;
   std::vector<std::string> bone_names;
   std::vector<Bone*> bones;
 };



From grumbel at mail.berlios.de  Sat Jun 23 18:10:23 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 23 Jun 2007 18:10:23 +0200
Subject: [Windstille-commit] r1506 - trunk/windstille/data/armature
Message-ID: <200706231610.l5NGAN1b031638@sheep.berlios.de>

Author: grumbel
Date: 2007-06-23 18:10:21 +0200 (Sat, 23 Jun 2007)
New Revision: 1506

Modified:
   trunk/windstille/data/armature/armature.arm
   trunk/windstille/data/armature/mesh.mesh
Log:
- fixed a bug that causes x cord to be ignored in key generation

Modified: trunk/windstille/data/armature/armature.arm
===================================================================
--- trunk/windstille/data/armature/armature.arm	2007-06-23 16:00:21 UTC (rev 1505)
+++ trunk/windstille/data/armature/armature.arm	2007-06-23 16:10:21 UTC (rev 1506)
@@ -7,13 +7,13 @@
       (children )
       (parent    "Bone.002")
       (head      0.000000 0.000000 0.000000)
-      (length    1.41421353817)
+      (length    1.41421341896)
       (matrix    0.707107 -0.000000 -0.707107  0.000000
                 -0.707107 -0.000000 -0.707107  0.000000
                 -0.000000  1.000000 -0.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
       (quat      0.653281 -0.653282 0.270598 0.270598)
-      (euler     -90.000015 45.000008 -0.000005)
+      (euler     -90.000023 45.000000 -0.000012)
      )
 
     (bone
@@ -26,8 +26,8 @@
                 -0.707107  0.000000  0.707107  0.000000
                 -0.707107 -0.000000 -0.707107  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.270598 0.653282 -0.653282 -0.270598)
-      (euler     135.000015 -0.000005 -90.000000)
+      (quat      0.270598 0.653281 -0.653282 -0.270598)
+      (euler     135.000015 -0.000008 -90.000000)
      )
 
     (bone
@@ -55,7 +55,7 @@
                  0.707107 -0.000000  0.707107  0.000000
                  0.000000  0.000000  0.000000  1.000000)
       (quat      0.653282 0.270598 0.270598 0.653281)
-      (euler     45.000008 -0.000002 89.999992)
+      (euler     45.000008 -0.000000 89.999992)
      )
 
     (bone
@@ -97,7 +97,7 @@
                 -0.707107 -0.000000  0.707107  0.000000
                  0.000000  0.000000  0.000000  1.000000)
       (quat      0.653282 0.270598 -0.270598 -0.653281)
-      (euler     45.000008 0.000002 -89.999992)
+      (euler     45.000008 0.000000 -89.999992)
      )
 
     (bone
@@ -105,13 +105,13 @@
       (children )
       (parent    "Bone.011")
       (head      0.000000 0.000000 0.000000)
-      (length    1.41421365738)
+      (length    1.41421353817)
       (matrix    0.000000  1.000000  0.000000  0.000000
                  0.707107  0.000000 -0.707107  0.000000
                 -0.707107  0.000000 -0.707107  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.270598 -0.653281 -0.653282 0.270598)
-      (euler     -135.000000 -0.000008 90.000000)
+      (quat      0.270598 -0.653282 -0.653281 0.270598)
+      (euler     -135.000000 -0.000013 89.999992)
      )
 
     (bone
@@ -119,13 +119,13 @@
       (children )
       (parent    "Bone.011")
       (head      0.000000 0.000000 0.000000)
-      (length    1.41421341896)
+      (length    1.41421353817)
       (matrix    0.000000  1.000000 -0.000000  0.000000
-                 0.707107 -0.000000  0.707107  0.000000
+                 0.707107  0.000000  0.707107  0.000000
                  0.707107 -0.000000 -0.707107  0.000000
                  0.000000  0.000000  0.000000  1.000000)
       (quat      0.270598 0.653282 0.653282 0.270598)
-      (euler     135.000000 0.000003 90.000000)
+      (euler     135.000015 0.000006 90.000000)
      )
 
     (bone
@@ -175,7 +175,7 @@
       (children  "Bone.026")
       (parent    "Bone.023")
       (head      0.000000 0.000000 0.000000)
-      (length    2.23606801033)
+      (length    2.23606824875)
       (matrix   -0.894427 -0.447214 -0.000000  0.000000
                  0.447214 -0.894427  0.000000  0.000000
                 -0.000000  0.000000  1.000000  0.000000
@@ -195,7 +195,7 @@
                 -0.000000 -1.000000 -0.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
       (quat      0.653281 0.653282 0.270598 -0.270598)
-      (euler     90.000000 45.000008 -0.000009)
+      (euler     90.000008 45.000015 -0.000006)
      )
 
     (bone
@@ -217,13 +217,13 @@
       (children )
       (parent    "Bone.002")
       (head      0.000000 0.000000 0.000000)
-      (length    1.41421353817)
+      (length    1.41421341896)
       (matrix    0.707107  0.000000  0.707107  0.000000
                  0.707107 -0.000000 -0.707107  0.000000
                  0.000000  1.000000 -0.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
       (quat      0.653281 -0.653282 -0.270598 -0.270598)
-      (euler     -90.000015 -45.000008 0.000005)
+      (euler     -90.000023 -45.000000 0.000012)
      )
 
     (bone
@@ -231,7 +231,7 @@
       (children )
       (parent    "Bone.002")
       (head      0.000000 0.000000 0.000000)
-      (length    1.0)
+      (length    1.00000011921)
       (matrix    1.000000  0.000000  0.000000  0.000000
                  0.000000  1.000000  0.000000  0.000000
                  0.000000  0.000000  1.000000  0.000000
@@ -245,13 +245,13 @@
       (children )
       (parent    "Bone.002")
       (head      0.000000 0.000000 0.000000)
-      (length    2.0)
+      (length    0.980814993382)
       (matrix   -1.000000  0.000000 -0.000000  0.000000
                  0.000000  0.000000  1.000000  0.000000
                  0.000000  1.000000 -0.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
       (quat      0.000000 0.000000 0.707107 0.707107)
-      (euler     90.000008 0.000000 180.000000)
+      (euler     -89.999985 180.000000 -0.000009)
      )
 
     (bone
@@ -259,7 +259,7 @@
       (children )
       (parent    "Bone.025")
       (head      0.000000 0.000000 0.000000)
-      (length    2.0)
+      (length    1.99999988079)
       (matrix   -0.894427  0.447214 -0.000000  0.000000
                 -0.447214 -0.894427  0.000000  0.000000
                 -0.000000  0.000000  1.000000  0.000000
@@ -273,7 +273,7 @@
       (children  "Bone.003" "Bone.004" "Bone.005")
       (parent    "Bone")
       (head      0.000000 0.000000 0.000000)
-      (length    2.0)
+      (length    1.99999988079)
       (matrix    1.000000  0.000000  0.000000  0.000000
                  0.000000  0.000000 -1.000000  0.000000
                  0.000000  1.000000  0.000000  0.000000
@@ -293,7 +293,7 @@
                  0.000000 -1.000000 -0.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
       (quat      0.707107 0.707107 0.000000 0.000000)
-      (euler     90.000008 -0.000000 0.000000)
+      (euler     90.000015 -0.000000 0.000000)
      )
 
     (bone
@@ -307,7 +307,7 @@
                  0.000000 -1.000000 -0.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
       (quat      0.653281 0.653282 -0.270598 0.270598)
-      (euler     90.000000 -45.000008 0.000009)
+      (euler     90.000008 -45.000015 0.000006)
      )
 
     (bone
@@ -329,13 +329,13 @@
       (children )
       (parent    "Bone.001")
       (head      0.000000 0.000000 0.000000)
-      (length    2.0)
-      (matrix   -1.000000  0.000000 -0.000000  0.000000
+      (length    0.980814993382)
+      (matrix   -1.000000  0.000000  0.000000  0.000000
                  0.000000  0.000000 -1.000000  0.000000
                 -0.000000 -1.000000 -0.000000  0.000000
                  0.000000  0.000000  0.000000  1.000000)
       (quat      0.000000 0.000000 0.707107 -0.707107)
-      (euler     -90.000000 0.000000 180.000000)
+      (euler     -90.000008 -0.000000 180.000000)
      )
 
     (bone
@@ -343,13 +343,13 @@
       (children )
       (parent    "Bone.010")
       (head      0.000000 0.000000 0.000000)
-      (length    1.41421365738)
+      (length    1.41421353817)
       (matrix    0.000000 -1.000000 -0.000000  0.000000
                 -0.707107  0.000000 -0.707107  0.000000
                  0.707107  0.000000 -0.707107  0.000000
                  0.000000  0.000000  0.000000  1.000000)
-      (quat      0.270598 -0.653281 0.653282 -0.270598)
-      (euler     -135.000000 0.000008 -90.000000)
+      (quat      0.270598 -0.653282 0.653281 -0.270598)
+      (euler     -135.000000 0.000013 -89.999992)
      )
 
     (bone

Modified: trunk/windstille/data/armature/mesh.mesh
===================================================================
--- trunk/windstille/data/armature/mesh.mesh	2007-06-23 16:00:21 UTC (rev 1505)
+++ trunk/windstille/data/armature/mesh.mesh	2007-06-23 16:10:21 UTC (rev 1506)
@@ -6,1324 +6,1418 @@
     (texture "404.png")
 
     (vertices
-        0.150268  -1.057474  -1.846240 ;; 0
-        1.780537  -0.150937   0.156700 ;; 1
-        1.050267   1.050937   1.841506 ;; 2
-       -0.000670   0.150937  -1.846240 ;; 3
-        0.150267   1.851356  -0.150936 ;; 4
-       -3.091192   0.090094   0.090095 ;; 5
-       -0.151606  -1.057474  -1.846240 ;; 6
-        0.150267   0.150937  -2.132085 ;; 7
-        0.150268  -1.057474   1.841506 ;; 8
-        0.150267   0.150937  -0.155671 ;; 9
-        0.150267   0.150937  -2.132085 ;; 10
-       -0.750527   1.851356  -0.150937 ;; 11
-       -0.151606  -0.150937  -2.132085 ;; 12
-        2.090937   0.150936  -0.150937 ;; 13
-       -0.750528   1.851356   0.150937 ;; 14
-       -1.781207   0.150936  -0.150937 ;; 15
-        1.050267   1.050937   2.127351 ;; 16
-       -0.151607   0.150936   1.841506 ;; 17
-        0.150267   1.851356   0.150937 ;; 18
-       -0.480033   2.103175   0.150937 ;; 19
-       -0.151607   0.150936   1.841506 ;; 20
-        0.150267   2.103175   0.150937 ;; 21
-        0.346967   2.879049  -0.150937 ;; 22
-       -0.151607   2.103175   0.150937 ;; 23
-        0.067099   0.084402   3.091057 ;; 24
-        2.090937  -1.050937  -1.050937 ;; 25
-        0.150267  -0.150937   0.150937 ;; 26
-       -0.068439  -0.051136   3.091057 ;; 27
-       -3.091192   0.090094  -0.090095 ;; 28
-       -0.151606  -1.057474  -2.132085 ;; 29
-       -1.781207   1.050936  -0.900000 ;; 30
-       -0.151607   1.851356  -0.150936 ;; 31
-       -3.091192  -0.090096  -0.000000 ;; 32
-       -0.900670   1.050937   1.841506 ;; 33
-       -1.077211   3.110451   0.150936 ;; 34
-       -0.151606  -0.150937   2.127351 ;; 35
-        0.346967   2.879049   0.150936 ;; 36
-        0.150267   0.150937   1.841506 ;; 37
-       -1.781206  -1.050937  -1.050937 ;; 38
-       -1.077211   3.110451  -0.150937 ;; 39
-       -0.151607   1.851356  -0.150936 ;; 40
-        0.150267  -0.150936  -1.846240 ;; 41
-       -2.091606  -0.150937   0.156700 ;; 42
-       -1.781207   0.150936  -0.000000 ;; 43
-        2.090937  -0.150937  -0.156701 ;; 44
-        2.090937  -0.150937   0.156700 ;; 45
-        0.150267  -0.150936  -2.132085 ;; 46
-        1.021424   1.851356  -0.150936 ;; 47
-        0.067099   0.084402   3.091057 ;; 48
-        2.090937   0.150936  -0.000000 ;; 49
-        0.150268  -1.057474  -1.846240 ;; 50
-       -1.781207   0.150936  -0.000000 ;; 51
-       -0.480033   2.103175   0.150937 ;; 52
-        1.021424   1.851356   0.150937 ;; 53
-        0.150267  -0.150937  -0.155671 ;; 54
-       -3.091192   0.090094  -0.000000 ;; 55
-        2.090937  -0.150937  -0.156701 ;; 56
-       -1.070406   2.103175   0.150936 ;; 57
-       -1.070405   2.103175  -0.150937 ;; 58
-        2.090937   0.150936  -0.150937 ;; 59
-       -1.781207  -0.150937  -0.156701 ;; 60
-        0.937340   2.879049  -0.150937 ;; 61
-        1.021424   1.851356  -0.150936 ;; 62
-       -0.151607   2.103175  -0.150936 ;; 63
-        2.090937   1.050936   1.050937 ;; 64
-       -0.068439   0.084402   3.091057 ;; 65
-       -1.781207   1.050936  -1.050937 ;; 66
-       -2.091606  -1.050937  -0.861211 ;; 67
-       -0.000670   0.150937  -2.132085 ;; 68
-        0.150268  -1.057474   1.841506 ;; 69
-       -1.051607   1.050936   2.127351 ;; 70
-       -0.151606  -1.057474   2.127351 ;; 71
-        0.150267   0.150937  -1.846240 ;; 72
-        0.150267   0.150937  -2.132085 ;; 73
-        1.050267   1.050937  -1.846240 ;; 74
-        1.780536  -1.050938   1.031500 ;; 75
-        0.346967   2.879049   0.150936 ;; 76
-       -1.781206  -0.150937  -0.000000 ;; 77
-       -1.051607   1.050936   1.841506 ;; 78
-       -2.091607  -0.150937  -0.156701 ;; 79
-       -1.781207   0.150936   0.150936 ;; 80
-       -1.781207   1.050936   0.900000 ;; 81
-       -0.151607   0.150937  -2.132085 ;; 82
-       -0.151606  -1.057474   1.841506 ;; 83
-       -0.000670   0.150936   2.127351 ;; 84
-       -1.781207   1.050936  -0.900000 ;; 85
-        0.937340   2.879049  -0.150937 ;; 86
-       -1.051607   1.050937  -2.132085 ;; 87
-        2.090937   0.150936  -0.000000 ;; 88
-       -1.077211   3.110451  -0.150937 ;; 89
-       -0.151606  -0.150937  -0.155671 ;; 90
-       -2.091606  -0.150937   0.156700 ;; 91
-       -0.480033   2.103175  -0.150937 ;; 92
-        2.090937  -0.150937  -0.000000 ;; 93
-        0.150267   2.103175   0.150937 ;; 94
-       -2.091607   0.150936  -0.150937 ;; 95
-       -2.091607   1.050936   1.050937 ;; 96
-       -3.091192  -0.090096  -0.000000 ;; 97
-       -1.781206  -0.150937   0.156700 ;; 98
-       -0.900670   1.050937   2.127351 ;; 99
-        1.780536  -1.050937  -0.861211 ;; 100
-        0.150267  -0.150937   0.150937 ;; 101
-       -1.070406   1.851356   0.150936 ;; 102
-       -2.091606  -0.150937  -0.000000 ;; 103
-       -0.480033   2.103175  -0.150937 ;; 104
-        1.780537   1.050936  -1.050937 ;; 105
-       -0.750528   1.851356   0.150937 ;; 106
-       -2.091606  -1.050937  -1.050937 ;; 107
-        2.090937  -0.150937  -0.000000 ;; 108
-       -1.781207   0.150936  -0.150937 ;; 109
-       -0.151606  -1.057474  -1.846240 ;; 110
-       -0.151606  -0.150937   2.127351 ;; 111
-       -3.091192   0.090094  -0.090095 ;; 112
-        1.021424   2.103175  -0.150936 ;; 113
-        1.780537   1.050936   0.900000 ;; 114
-        0.150268  -1.057474   2.127351 ;; 115
-        0.150267   0.150937   2.127351 ;; 116
-       -0.900670   1.050937  -1.846240 ;; 117
-        0.617461   3.110451   0.150936 ;; 118
-       -1.781206  -1.050937  -1.050937 ;; 119
-       -1.781207   0.150936   0.150936 ;; 120
-        1.050267   1.050937   1.841506 ;; 121
-       -2.091607   1.050936   0.900000 ;; 122
-       -0.151607   2.103175   0.150937 ;; 123
-        0.150267   1.851356  -0.150936 ;; 124
-       -0.151607   0.150937  -0.155671 ;; 125
-        0.150267  -0.150936  -1.846240 ;; 126
-       -1.781206  -1.050937  -0.861211 ;; 127
-        1.780537  -0.150937  -0.156701 ;; 128
-       -1.781207   1.050936   1.050937 ;; 129
-        0.899330   1.050937   1.841506 ;; 130
-        2.090937   0.150936  -0.150937 ;; 131
-       -2.091607   0.150936  -0.000000 ;; 132
-       -2.091606  -0.150937   0.156700 ;; 133
-       -1.781206  -1.050937   0.874799 ;; 134
-        1.780537   1.050936   1.050937 ;; 135
-        0.150267   1.851356  -0.150936 ;; 136
-       -1.781207   1.050936   0.900000 ;; 137
-       -0.000670   0.150937  -1.846240 ;; 138
-        1.050267   1.050937  -2.132085 ;; 139
-       -1.070405   1.851356  -0.150937 ;; 140
-        2.090937  -0.150937   0.156700 ;; 141
-        0.150267  -0.150936  -1.846240 ;; 142
-       -2.091607   0.150936   0.150936 ;; 143
-        0.937339   3.110451   0.150937 ;; 144
-       -2.091607   1.050936  -1.050937 ;; 145
-       -3.091192  -0.090096  -0.093536 ;; 146
-       -0.151606  -0.150937  -2.132085 ;; 147
-       -2.091607   0.150936  -0.150937 ;; 148
-        2.090937   0.150936  -0.150937 ;; 149
-       -0.000670   0.150936   2.127351 ;; 150
-        0.937340   2.879049  -0.150937 ;; 151
-       -1.077211   2.879049  -0.150937 ;; 152
-       -0.151607   0.150937  -1.846240 ;; 153
-       -1.070406   2.103175   0.150936 ;; 154
-        0.346967   2.879049  -0.150937 ;; 155
-       -2.091606  -1.050938   0.874799 ;; 156
-        0.899330   1.050937  -1.846240 ;; 157
-        0.346967   2.879049   0.150936 ;; 158
-       -0.151607   0.150937   0.150937 ;; 159
-        0.937339   3.110451   0.150937 ;; 160
-       -0.151606  -0.150937  -1.846240 ;; 161
-        0.150267  -0.150937   1.841506 ;; 162
-        1.780536  -1.050937   0.874799 ;; 163
-        1.021424   1.851356   0.150937 ;; 164
-        1.021424   2.103175   0.150937 ;; 165
-       -1.051607   1.050936   1.841506 ;; 166
-       -3.091192   0.090094  -0.000000 ;; 167
-       -0.151607   0.150937  -2.132085 ;; 168
-        2.090937  -0.150937  -0.000000 ;; 169
-       -1.781206  -1.050937  -1.050937 ;; 170
-        0.150267   0.150937   1.841506 ;; 171
-       -0.151607   1.851356  -0.150936 ;; 172
-        0.150268  -1.057474   2.127351 ;; 173
-        0.150267   0.150937  -1.846240 ;; 174
-       -1.051607   1.050937  -2.132085 ;; 175
-       -2.091607   1.050936   1.050937 ;; 176
-        0.899330   1.050937   1.841506 ;; 177
-        2.090937  -0.150937  -0.000000 ;; 178
-       -0.151606  -0.150937   1.841506 ;; 179
-        2.090937   0.150936   0.150936 ;; 180
-       -3.091192   0.090094   0.090095 ;; 181
-        0.150267  -0.150936  -2.132085 ;; 182
-       -2.091607   0.150936  -0.000000 ;; 183
-       -0.151606  -0.150937   1.841506 ;; 184
-        0.899330   1.050937   2.127351 ;; 185
-       -2.091607   0.150936  -0.000000 ;; 186
-        0.150267  -0.150937   2.127351 ;; 187
-        0.937340   3.110451  -0.150937 ;; 188
-       -2.091607   1.050936  -0.900000 ;; 189
-        0.617461   3.110451   0.150936 ;; 190
-       -0.151607   1.851356  -0.150936 ;; 191
-        2.090937   1.050936   0.900000 ;; 192
-       -0.900670   1.050937  -1.846240 ;; 193
-       -1.077211   2.879049   0.150936 ;; 194
-        0.150267   1.851356  -0.150936 ;; 195
-       -0.151607   0.150937   0.150937 ;; 196
-       -0.068439   0.084402   3.091057 ;; 197
-        1.021424   2.103175   0.150937 ;; 198
-       -1.781206  -1.050937   0.874799 ;; 199
-       -0.151607   2.103175  -0.150936 ;; 200
-       -1.781206  -1.050938   1.031500 ;; 201
-       -0.151607   0.150937   0.150937 ;; 202
-       -0.151606  -0.150937   0.150937 ;; 203
-        2.090937   1.050936  -0.900000 ;; 204
-        0.150267  -0.150937   2.127351 ;; 205
-        2.090936  -1.050938   0.874799 ;; 206
-        0.937340   2.879049  -0.150937 ;; 207
-        0.150267   0.150937  -2.132085 ;; 208
-        1.050267   1.050937  -2.132085 ;; 209
-        0.150268  -1.057474  -2.132085 ;; 210
-       -0.151607   1.851356   0.150937 ;; 211
-        1.050267   1.050937  -1.846240 ;; 212
-        0.150267  -0.150937   1.841506 ;; 213
-       -1.781206  -0.150937   0.156700 ;; 214
-        0.937339   2.879049   0.150937 ;; 215
-        1.780537   0.150936   0.150936 ;; 216
-       -3.091192  -0.090096  -0.093536 ;; 217
-       -2.091607   0.150936  -0.150937 ;; 218
-       -1.051607   1.050936   2.127351 ;; 219
-       -0.151606  -0.150937  -0.155671 ;; 220
-       -2.091607   1.050936  -1.050937 ;; 221
-        1.780536  -1.050937  -1.050937 ;; 222
-       -1.781207   0.150936   0.150936 ;; 223
-       -3.091192   0.090094  -0.000000 ;; 224
-       -2.091606  -0.150937   0.156700 ;; 225
-       -0.151607   0.150936   1.841506 ;; 226
-       -0.151607   0.150937  -2.132085 ;; 227
-       -0.151607   2.103175   0.150937 ;; 228
-        1.021424   2.103175  -0.150936 ;; 229
-       -0.151607   0.150937  -0.155671 ;; 230
-       -0.750527   1.851356  -0.150937 ;; 231
-        2.090937  -0.150937  -0.000000 ;; 232
-       -0.151607   0.150937  -0.155671 ;; 233
-       -0.900670   1.050937  -2.132085 ;; 234
-       -1.070406   1.851356   0.150936 ;; 235
-       -0.480033   2.103175  -0.150937 ;; 236
-       -0.750528   1.851356   0.150937 ;; 237
-       -0.151606  -0.150937  -0.155671 ;; 238
-        0.150267   1.851356  -0.150936 ;; 239
-       -2.091607   1.050936   0.900000 ;; 240
-       -1.077211   3.110451   0.150936 ;; 241
-       -0.000670   0.150937  -2.132085 ;; 242
-       -0.151607   0.150937   0.150937 ;; 243
-        0.937339   2.879049   0.150937 ;; 244
-        1.780537  -0.150937  -0.000000 ;; 245
-        1.780537   1.050936  -0.900000 ;; 246
-       -3.091192   0.090094  -0.090095 ;; 247
-        1.021424   1.851356  -0.150936 ;; 248
-       -3.091192  -0.090096   0.093535 ;; 249
-       -1.077211   2.879049   0.150936 ;; 250
-        0.617462   3.110451  -0.150937 ;; 251
-        1.780537   0.150936  -0.150937 ;; 252
-       -0.151606  -0.150937   2.127351 ;; 253
-        0.150267   0.150937  -2.132085 ;; 254
-       -1.781206  -1.050937   0.874799 ;; 255
-       -0.151606  -0.150937   0.150937 ;; 256
-        0.150267  -0.150936  -1.846240 ;; 257
-       -2.091606  -1.050938   0.874799 ;; 258
-       -2.091606  -0.150937   0.156700 ;; 259
-        0.067099  -0.051136   3.091057 ;; 260
-        0.150267   0.150937  -0.155671 ;; 261
-        0.899330   1.050937   1.841506 ;; 262
-        0.150267   0.150937   2.127351 ;; 263
-        2.090937   0.150936  -0.000000 ;; 264
-       -0.151606  -0.150937   1.841506 ;; 265
-       -0.151606  -0.150937  -2.132085 ;; 266
-        0.150268  -1.057474  -1.846240 ;; 267
-       -2.091606  -1.050937  -1.050937 ;; 268
-       -0.151606  -0.150937  -1.846240 ;; 269
-       -2.091607   1.050936  -0.900000 ;; 270
-       -1.070406   2.103175   0.150936 ;; 271
-       -1.781207   1.050936   1.050937 ;; 272
-       -2.091607   0.150936  -0.150937 ;; 273
-       -0.151607   0.150937  -0.155671 ;; 274
-        0.617461   3.110451   0.150936 ;; 275
-       -0.151607   2.103175  -0.150936 ;; 276
-        2.090937   1.050936   1.050937 ;; 277
-       -1.051607   1.050937  -1.846240 ;; 278
-        0.346967   2.879049   0.150936 ;; 279
-        2.090936  -1.050937  -0.861211 ;; 280
-       -1.781207   1.050936   0.900000 ;; 281
-       -1.070406   2.103175   0.150936 ;; 282
-       -1.077211   2.879049   0.150936 ;; 283
-       -0.068439   0.084402   3.091057 ;; 284
-        0.150267   0.150937   2.127351 ;; 285
-       -0.900670   1.050937   1.841506 ;; 286
-       -0.900670   1.050937   1.841506 ;; 287
-        1.780537   0.150936  -0.150937 ;; 288
-        0.150267   0.150937   2.127351 ;; 289
-       -0.151606  -1.057474   2.127351 ;; 290
-        0.150268  -1.057474  -2.132085 ;; 291
-       -0.151606  -0.150937  -1.846240 ;; 292
-        0.150267  -0.150937   1.841506 ;; 293
-        1.780537  -0.150937  -0.000000 ;; 294
-       -1.077211   3.110451   0.150936 ;; 295
-       -3.091192   0.090094  -0.000000 ;; 296
-       -0.151607   0.150937  -2.132085 ;; 297
-       -0.000670   0.150936   2.127351 ;; 298
-       -1.070405   2.103175  -0.150937 ;; 299
-        0.150267   0.150937   0.150937 ;; 300
-        0.067099   0.084402   3.091057 ;; 301
-       -1.781207   1.050936   0.900000 ;; 302
-        0.937340   2.879049  -0.150937 ;; 303
-       -0.151607   0.150936   2.127351 ;; 304
-       -2.091607   0.150936  -0.150937 ;; 305
-       -0.151606  -0.150937  -2.132085 ;; 306
-        2.090936  -1.050937  -0.861211 ;; 307
-       -2.091606  -1.050938   1.031500 ;; 308
-       -2.091607  -0.150937  -0.156701 ;; 309
-       -3.091192  -0.090096  -0.000000 ;; 310
-       -1.781207   1.050936  -1.050937 ;; 311
-        1.780536  -1.050937  -0.861211 ;; 312
-       -1.070406   1.851356   0.150936 ;; 313
-       -0.151606  -0.150937   1.841506 ;; 314
-       -1.051607   1.050937  -1.846240 ;; 315
-       -0.480033   2.103175  -0.150937 ;; 316
-       -0.151607   0.150937  -1.846240 ;; 317
-       -1.781207   0.150936  -0.150937 ;; 318
-       -1.781206  -0.150937  -0.000000 ;; 319
-        0.937340   3.110451  -0.150937 ;; 320
-       -0.151607   2.103175  -0.150936 ;; 321
-       -0.900670   1.050937  -1.846240 ;; 322
-        0.899330   1.050937  -1.846240 ;; 323
-        0.150268  -1.057474   1.841506 ;; 324
-        1.050267   1.050937   1.841506 ;; 325
-       -1.781206  -1.050938   1.031500 ;; 326
-        0.150267   0.150937  -1.846240 ;; 327
-       -1.781206  -1.050937  -0.861211 ;; 328
-       -0.151606  -0.150937   0.150937 ;; 329
-       -2.091606  -1.050938   0.874799 ;; 330
-        1.780536  -1.050938   1.031500 ;; 331
-        0.150267   0.150937  -0.155671 ;; 332
-       -0.900670   1.050937  -1.846240 ;; 333
-       -1.070405   1.851356  -0.150937 ;; 334
-       -0.151607   1.851356   0.150937 ;; 335
-       -1.051607   1.050937  -1.846240 ;; 336
-       -0.151606  -1.057474   1.841506 ;; 337
-        1.780537   0.150936  -0.000000 ;; 338
-       -1.781206  -1.050938   1.031500 ;; 339
-        2.090937   0.150936   0.150936 ;; 340
-       -2.091607   0.150936  -0.150937 ;; 341
-       -0.480033   2.103175  -0.150937 ;; 342
-        0.150268  -1.057474  -1.846240 ;; 343
-        2.090936  -1.050938   1.031500 ;; 344
-       -2.091606  -1.050937  -0.861211 ;; 345
-       -0.151607   0.150936   1.841506 ;; 346
-       -1.070405   1.851356  -0.150937 ;; 347
-        0.150267   1.851356   0.150937 ;; 348
-       -2.091607   0.150936   0.150936 ;; 349
-        2.090937   1.050936  -1.050937 ;; 350
-       -1.077211   2.879049  -0.150937 ;; 351
-       -2.091606  -0.150937  -0.000000 ;; 352
-       -3.091192   0.090094  -0.090095 ;; 353
-        1.050267   1.050937  -1.846240 ;; 354
-       -0.151607   0.150937  -2.132085 ;; 355
-       -2.091606  -0.150937  -0.000000 ;; 356
-        0.346967   2.879049  -0.150937 ;; 357
-       -0.151607   0.150937  -0.155671 ;; 358
-        0.150267   0.150937   1.841506 ;; 359
+        1.021424   1.851356   0.150937 ;; 0
+        1.780537  -0.150937  -0.000000 ;; 1
+        0.150267  -0.150937   0.150937 ;; 2
+        2.090936  -1.050938   1.031500 ;; 3
+       -0.000670   0.150937  -1.846240 ;; 4
+       -0.000670   0.150936   1.841506 ;; 5
+       -1.781207   1.050936   0.900000 ;; 6
+        1.780537   0.150936  -0.150937 ;; 7
+        0.150267  -0.150937   1.841506 ;; 8
+       -0.151607   1.851356  -0.150936 ;; 9
+        0.150267  -0.150936  -2.132085 ;; 10
+       -3.091192  -0.090096  -0.093536 ;; 11
+       -0.068439  -0.051136   3.091057 ;; 12
+        1.021424   1.851356  -0.150936 ;; 13
+        1.780536  -1.050937  -1.050937 ;; 14
+       -0.151607   0.150937  -2.132085 ;; 15
+       -0.900670   1.050937  -1.846240 ;; 16
+       -0.151606  -0.150937   2.127351 ;; 17
+       -0.068439   0.084402   3.091057 ;; 18
+        1.050267   1.050937  -1.846240 ;; 19
+       -0.750527   1.851356  -0.150937 ;; 20
+       -0.151606  -1.057474  -1.846240 ;; 21
+        1.780536  -1.050938   1.031500 ;; 22
+       -1.781207   0.150936   0.150936 ;; 23
+       -0.480033   2.103175  -0.150937 ;; 24
+       -2.091607   1.050936   0.900000 ;; 25
+        0.150267  -0.150937  -0.155671 ;; 26
+        0.937339   2.879049   0.150937 ;; 27
+       -0.151606  -1.057474   2.127351 ;; 28
+        1.780537   1.050936   0.900000 ;; 29
+       -1.051607   1.050937  -2.132085 ;; 30
+        0.150267   1.851356  -0.150936 ;; 31
+        0.150267  -0.150937   1.841506 ;; 32
+        2.090937  -0.150937  -0.156701 ;; 33
+        0.150267   2.103175   0.150937 ;; 34
+       -2.091606  -1.050937  -0.861211 ;; 35
+        0.150267   0.150937  -0.155671 ;; 36
+       -0.151607   1.851356  -0.150936 ;; 37
+       -3.091192   0.090094  -0.000000 ;; 38
+        1.050267   1.050937   1.841506 ;; 39
+       -0.151606  -0.150937   0.150937 ;; 40
+        1.780536  -1.050937  -0.861211 ;; 41
+        1.780537  -0.150937   0.156700 ;; 42
+       -0.151606  -0.150937   0.150937 ;; 43
+        0.937339   3.110451   0.150937 ;; 44
+       -1.781207   1.050936   1.050937 ;; 45
+        0.150267   0.150937  -1.846240 ;; 46
+       -1.781207   1.050936   0.900000 ;; 47
+       -1.781206  -1.050937  -0.861211 ;; 48
+       -1.781207   0.150936  -0.150937 ;; 49
+       -0.151606  -1.057474  -2.132085 ;; 50
+       -0.900670   1.050937   1.841506 ;; 51
+        2.090937   0.150936  -0.150937 ;; 52
+        1.021424   2.103175   0.150937 ;; 53
+        0.150268  -1.057474  -1.846240 ;; 54
+       -0.151607   0.150937   0.150937 ;; 55
+        2.090937   0.150936  -0.150937 ;; 56
+        1.021424   2.103175  -0.150936 ;; 57
+       -2.091606  -1.050937  -1.050937 ;; 58
+       -1.077211   3.110451   0.150936 ;; 59
+       -3.091192   0.090094  -0.090095 ;; 60
+       -0.000670   0.150936   1.841506 ;; 61
+       -0.900670   1.050937  -2.132085 ;; 62
+        1.780536  -1.050938   1.031500 ;; 63
+       -0.151606  -0.150937   1.841506 ;; 64
+       -2.091606  -0.150937   0.156700 ;; 65
+       -1.781206  -0.150937   0.156700 ;; 66
+        0.150267  -0.150936  -2.132085 ;; 67
+       -2.091607   1.050936  -0.900000 ;; 68
+       -0.151607   2.103175   0.150937 ;; 69
+       -1.781206  -1.050937   0.874799 ;; 70
+       -0.068439  -0.051136   3.091057 ;; 71
+       -1.781207   1.050936  -0.900000 ;; 72
+       -1.781207  -0.150937  -0.156701 ;; 73
+        1.050267   1.050937   2.127351 ;; 74
+        0.150267   1.851356  -0.150936 ;; 75
+        2.090937  -1.050937  -1.050937 ;; 76
+        0.150268  -1.057474   2.127351 ;; 77
+       -0.900670   1.050937   1.841506 ;; 78
+       -0.151606  -1.057474   1.841506 ;; 79
+        0.150267  -0.150936  -2.132085 ;; 80
+       -1.051607   1.050937  -2.132085 ;; 81
+        0.067099   0.084402   3.091057 ;; 82
+        1.021424   2.103175  -0.150936 ;; 83
+       -1.077211   2.879049  -0.150937 ;; 84
+       -0.151607   1.851356  -0.150936 ;; 85
+       -2.091606  -0.150937  -0.000000 ;; 86
+        0.150267   0.150937   1.841506 ;; 87
+        0.150267  -0.150936  -1.846240 ;; 88
+       -2.091606  -1.050937  -1.050937 ;; 89
+       -0.151607   0.150937  -1.846240 ;; 90
+        2.090937  -0.150937   0.156700 ;; 91
+        0.150267   0.150937   0.150937 ;; 92
+        0.150268  -1.057474   1.841506 ;; 93
+        0.346967   2.879049  -0.150937 ;; 94
+        1.780537   1.050936  -1.050937 ;; 95
+        0.150267   1.851356   0.150937 ;; 96
+        0.150267  -0.150937  -0.155671 ;; 97
+        0.150267  -0.150936  -1.846240 ;; 98
+        1.780537   1.050936   0.900000 ;; 99
+       -3.091192  -0.090096  -0.000000 ;; 100
+       -1.781207   1.050936   1.050937 ;; 101
+        0.150267  -0.150937   0.150937 ;; 102
+        1.780537   0.150936   0.150936 ;; 103
+       -1.070405   1.851356  -0.150937 ;; 104
+       -0.151606  -0.150937   0.150937 ;; 105
+        0.937339   3.110451   0.150937 ;; 106
+       -1.781207   0.150936  -0.000000 ;; 107
+       -1.781206  -1.050937  -0.861211 ;; 108
+        1.050267   1.050937   2.127351 ;; 109
+        0.150267   2.103175  -0.150936 ;; 110
+       -0.151607   1.851356   0.150937 ;; 111
+       -2.091607   1.050936  -1.050937 ;; 112
+        0.150268  -1.057474  -1.846240 ;; 113
+       -1.781206  -0.150937  -0.000000 ;; 114
+       -0.151607   2.103175   0.150937 ;; 115
+       -2.091606  -1.050938   0.874799 ;; 116
+        0.150267  -0.150937   2.127351 ;; 117
+        1.780537   1.050936   1.050937 ;; 118
+       -0.151607   0.150937  -0.155671 ;; 119
+       -0.000670   0.150936   1.841506 ;; 120
+       -3.091192   0.090094  -0.090095 ;; 121
+        0.150267   0.150937  -1.846240 ;; 122
+       -1.070405   2.103175  -0.150937 ;; 123
+        0.150268  -1.057474   1.841506 ;; 124
+        0.346967   2.879049   0.150936 ;; 125
+        0.150267   0.150937  -0.155671 ;; 126
+       -0.151606  -0.150937  -2.132085 ;; 127
+        0.899330   1.050937   1.841506 ;; 128
+       -0.151607   1.851356  -0.150936 ;; 129
+       -2.091606  -1.050938   1.031500 ;; 130
+       -1.781206  -1.050937   0.874799 ;; 131
+       -1.781207   1.050936  -1.050937 ;; 132
+       -0.151606  -1.057474   2.127351 ;; 133
+        1.780536  -1.050937   0.874799 ;; 134
+       -2.091606  -1.050937  -0.861211 ;; 135
+       -1.781207  -0.150937  -0.156701 ;; 136
+        1.050267   1.050937   2.127351 ;; 137
+        0.150268  -1.057474   2.127351 ;; 138
+       -1.781206  -1.050937  -0.861211 ;; 139
+        0.150267   1.851356   0.150937 ;; 140
+       -1.070406   2.103175   0.150936 ;; 141
+        0.150267  -0.150936  -2.132085 ;; 142
+       -0.750527   1.851356  -0.150937 ;; 143
+        0.067099   0.084402   3.091057 ;; 144
+       -0.151607   1.851356   0.150937 ;; 145
+       -0.151607   0.150937   0.150937 ;; 146
+        0.150267   0.150937   2.127351 ;; 147
+       -1.781206  -0.150937   0.156700 ;; 148
+        1.021424   1.851356   0.150937 ;; 149
+       -0.151606  -0.150937  -2.132085 ;; 150
+        2.090937   1.050936   1.050937 ;; 151
+       -0.068439   0.084402   3.091057 ;; 152
+        0.937339   2.879049   0.150937 ;; 153
+       -0.480033   2.103175  -0.150937 ;; 154
+        0.150267   1.851356   0.150937 ;; 155
+        2.090936  -1.050937  -0.861211 ;; 156
+       -1.781206  -1.050937  -1.050937 ;; 157
+       -2.091607   1.050936  -1.050937 ;; 158
+       -0.151606  -0.150937   2.127351 ;; 159
+       -1.781207   1.050936  -0.900000 ;; 160
+        0.346967   2.879049   0.150936 ;; 161
+       -0.151607   0.150936   1.841506 ;; 162
+        1.021424   1.851356  -0.150936 ;; 163
+        0.150268  -1.057474  -2.132085 ;; 164
+        0.899330   1.050937   1.841506 ;; 165
+       -2.091606  -1.050937  -0.861211 ;; 166
+        0.937339   2.879049   0.150937 ;; 167
+       -1.077211   3.110451  -0.150937 ;; 168
+        0.899330   1.050937  -2.132085 ;; 169
+        1.780537   1.050936  -0.900000 ;; 170
+       -3.091192  -0.090096   0.093535 ;; 171
+       -0.000670   0.150937  -2.132085 ;; 172
+       -1.051607   1.050937  -1.846240 ;; 173
+        0.067099  -0.051136   3.091057 ;; 174
+       -2.091606  -1.050938   0.874799 ;; 175
+        0.937340   3.110451  -0.150937 ;; 176
+       -0.151606  -0.150937   0.150937 ;; 177
+        1.021424   1.851356   0.150937 ;; 178
+        1.780537   1.050936   1.050937 ;; 179
+       -0.750527   1.851356  -0.150937 ;; 180
+       -0.000670   0.150937  -1.846240 ;; 181
+        2.090937  -0.150937  -0.000000 ;; 182
+        1.050267   1.050937   1.841506 ;; 183
+       -1.781207   0.150936  -0.000000 ;; 184
+       -1.051607   1.050936   2.127351 ;; 185
+       -0.151607   0.150937  -0.155671 ;; 186
+        2.090937   1.050936  -1.050937 ;; 187
+        0.346967   2.879049   0.150936 ;; 188
+        0.899330   1.050937   1.841506 ;; 189
+        1.780537   0.150936   0.150936 ;; 190
+        2.090937   1.050936   0.900000 ;; 191
+       -2.091607   0.150936   0.150936 ;; 192
+       -2.091607   1.050936  -0.900000 ;; 193
+       -2.091607   1.050936   1.050937 ;; 194
+        1.050267   1.050937  -1.846240 ;; 195
+        1.021424   1.851356  -0.150936 ;; 196
+        1.780536  -1.050937   0.874799 ;; 197
+        2.090937   0.150936  -0.000000 ;; 198
+        0.150267   1.851356   0.150937 ;; 199
+       -0.750528   1.851356   0.150937 ;; 200
+        0.150267   0.150937  -1.846240 ;; 201
+       -0.151606  -1.057474   1.841506 ;; 202
+        2.090936  -1.050938   0.874799 ;; 203
+        1.780536  -1.050938   1.031500 ;; 204
+        1.021424   1.851356   0.150937 ;; 205
+       -1.781206  -1.050937   0.874799 ;; 206
+       -0.480033   2.103175  -0.150937 ;; 207
+        2.090937   1.050936   1.050937 ;; 208
+        2.090937   0.150936  -0.000000 ;; 209
+        0.150267  -0.150936  -1.846240 ;; 210
+        0.937339   2.879049   0.150937 ;; 211
+       -0.900670   1.050937  -1.846240 ;; 212
+       -1.781207   1.050936  -1.050937 ;; 213
+        0.150267   0.150937  -0.155671 ;; 214
+        0.617462   3.110451  -0.150937 ;; 215
+        0.150268  -1.057474   1.841506 ;; 216
+       -0.900670   1.050937   2.127351 ;; 217
+        1.780537   0.150936   0.150936 ;; 218
+       -3.091192  -0.090096   0.093535 ;; 219
+        0.150267   0.150937   2.127351 ;; 220
+       -0.151607   0.150936   2.127351 ;; 221
+       -1.781206  -1.050937  -1.050937 ;; 222
+        2.090937   1.050936  -0.900000 ;; 223
+       -0.151607   0.150937  -0.155671 ;; 224
+       -0.151607   0.150936   2.127351 ;; 225
+       -0.151606  -0.150937  -1.846240 ;; 226
+       -0.151606  -0.150937  -1.846240 ;; 227
+       -2.091606  -1.050938   1.031500 ;; 228
+        2.090937   0.150936  -0.150937 ;; 229
+       -0.151606  -0.150937   1.841506 ;; 230
+        0.937339   2.879049   0.150937 ;; 231
+       -2.091607   1.050936  -1.050937 ;; 232
+        2.090937   1.050936  -1.050937 ;; 233
+       -0.151607   1.851356  -0.150936 ;; 234
+        0.067099  -0.051136   3.091057 ;; 235
+       -0.068439   0.084402   3.091057 ;; 236
+        0.937340   3.110451  -0.150937 ;; 237
+       -3.091192   0.090094  -0.090095 ;; 238
+        0.150267   0.150937  -2.132085 ;; 239
+        2.090937  -1.050937  -1.050937 ;; 240
+        1.050267   1.050937   1.841506 ;; 241
+        1.050267   1.050937   1.841506 ;; 242
+        0.150267   0.150937  -0.155671 ;; 243
+       -0.151606  -0.150937  -2.132085 ;; 244
+       -0.000670   0.150936   2.127351 ;; 245
+       -1.781206  -0.150937   0.156700 ;; 246
+        1.780537   0.150936  -0.150937 ;; 247
+        0.150267   0.150937  -2.132085 ;; 248
+        0.937340   2.879049  -0.150937 ;; 249
+       -0.750528   1.851356   0.150937 ;; 250
+       -0.750528   1.851356   0.150937 ;; 251
+       -0.151607   0.150937  -2.132085 ;; 252
+       -1.070406   2.103175   0.150936 ;; 253
+        1.780537  -0.150937  -0.156701 ;; 254
+        0.150267   0.150937   0.150937 ;; 255
+       -2.091607  -0.150937  -0.156701 ;; 256
+       -1.781207   1.050936   0.900000 ;; 257
+       -1.781206  -1.050938   1.031500 ;; 258
+        2.090937  -0.150937  -0.000000 ;; 259
+        2.090937   0.150936   0.150936 ;; 260
+        2.090937  -0.150937  -0.000000 ;; 261
+       -1.781207   0.150936   0.150936 ;; 262
+        2.090937   1.050936  -0.900000 ;; 263
+        0.150267  -0.150937  -0.155671 ;; 264
+       -3.091192   0.090094  -0.000000 ;; 265
+       -0.900670   1.050937  -1.846240 ;; 266
+       -3.091192   0.090094   0.090095 ;; 267
+       -3.091192  -0.090096  -0.093536 ;; 268
+        2.090937  -0.150937   0.156700 ;; 269
+        0.150267   0.150937   2.127351 ;; 270
+       -0.900670   1.050937   2.127351 ;; 271
+       -0.151606  -0.150937  -0.155671 ;; 272
+       -3.091192  -0.090096   0.093535 ;; 273
+        2.090937  -0.150937  -0.156701 ;; 274
+       -1.781206  -1.050937  -1.050937 ;; 275
+       -0.151606  -0.150937   2.127351 ;; 276
+       -0.151607   0.150936   2.127351 ;; 277
+        0.150267   0.150937   1.841506 ;; 278
+        0.617461   3.110451   0.150936 ;; 279
+        0.346967   2.879049   0.150936 ;; 280
+        0.150267  -0.150937  -0.155671 ;; 281
+       -0.151607   0.150937  -2.132085 ;; 282
+        0.150267  -0.150936  -1.846240 ;; 283
+       -2.091607   1.050936   1.050937 ;; 284
+        0.899330   1.050937   1.841506 ;; 285
+       -2.091606  -1.050937  -1.050937 ;; 286
+        0.150268  -1.057474  -1.846240 ;; 287
+        0.937339   3.110451   0.150937 ;; 288
+       -1.781207   0.150936  -0.000000 ;; 289
+        0.937340   2.879049  -0.150937 ;; 290
+       -1.781207   0.150936  -0.150937 ;; 291
+       -0.151606  -0.150937   1.841506 ;; 292
+       -1.781207   0.150936  -0.000000 ;; 293
+        2.090937   0.150936   0.150936 ;; 294
+        1.780537   0.150936  -0.000000 ;; 295
+       -1.781207   1.050936  -0.900000 ;; 296
+       -0.480033   2.103175   0.150937 ;; 297
+       -0.750528   1.851356   0.150937 ;; 298
+       -1.781207  -0.150937  -0.156701 ;; 299
+       -1.051607   1.050937  -1.846240 ;; 300
+       -2.091607   1.050936  -0.900000 ;; 301
+        2.090937   1.050936  -1.050937 ;; 302
+       -0.151607   0.150937  -2.132085 ;; 303
+        2.090937   0.150936   0.150936 ;; 304
+        1.780537   1.050936  -1.050937 ;; 305
+        0.150267   0.150937  -2.132085 ;; 306
+        0.899330   1.050937  -1.846240 ;; 307
+       -0.900670   1.050937  -2.132085 ;; 308
+        0.899330   1.050937   2.127351 ;; 309
+       -0.151606  -0.150937  -0.155671 ;; 310
+       -3.091192   0.090094  -0.090095 ;; 311
+        0.899330   1.050937  -2.132085 ;; 312
+        0.150268  -1.057474   2.127351 ;; 313
+       -0.151606  -0.150937   0.150937 ;; 314
+        1.050267   1.050937  -1.846240 ;; 315
+       -0.151606  -0.150937  -2.132085 ;; 316
+        0.150267  -0.150937   2.127351 ;; 317
+       -2.091606  -1.050938   1.031500 ;; 318
+       -1.781207   0.150936  -0.150937 ;; 319
+        0.150267   0.150937  -2.132085 ;; 320
+       -1.077211   3.110451  -0.150937 ;; 321
+       -0.480033   2.103175  -0.150937 ;; 322
+       -1.070406   2.103175   0.150936 ;; 323
+        1.050267   1.050937  -2.132085 ;; 324
+        0.150267  -0.150936  -2.132085 ;; 325
+       -1.051607   1.050936   1.841506 ;; 326
+       -0.151607   0.150937   0.150937 ;; 327
+        0.067099   0.084402   3.091057 ;; 328
+        2.090937  -0.150937  -0.156701 ;; 329
+        0.150267   0.150937   2.127351 ;; 330
+       -2.091606  -0.150937   0.156700 ;; 331
+       -1.781206  -1.050937   0.874799 ;; 332
+       -1.051607   1.050937  -1.846240 ;; 333
+       -3.091192  -0.090096  -0.093536 ;; 334
+       -2.091606  -0.150937  -0.000000 ;; 335
+       -0.068439  -0.051136   3.091057 ;; 336
+        2.090937   1.050936  -0.900000 ;; 337
+       -3.091192   0.090094  -0.000000 ;; 338
+       -1.070405   2.103175  -0.150937 ;; 339
+        2.090937  -0.150937  -0.000000 ;; 340
+        0.617462   3.110451  -0.150937 ;; 341
+       -1.077211   3.110451   0.150936 ;; 342
+        0.150267   0.150937  -2.132085 ;; 343
+        0.617462   3.110451  -0.150937 ;; 344
+       -1.051607   1.050937  -2.132085 ;; 345
+        0.150268  -1.057474   1.841506 ;; 346
+        1.780537   1.050936  -0.900000 ;; 347
+       -2.091607   0.150936  -0.150937 ;; 348
+       -0.151606  -0.150937   2.127351 ;; 349
+       -3.091192  -0.090096  -0.000000 ;; 350
+        2.090937  -1.050937  -1.050937 ;; 351
+        0.346967   2.879049   0.150936 ;; 352
+       -0.750527   1.851356  -0.150937 ;; 353
+        1.780536  -1.050937  -0.861211 ;; 354
+       -0.151606  -0.150937  -1.846240 ;; 355
+       -0.151606  -0.150937   1.841506 ;; 356
+       -1.070405   2.103175  -0.150937 ;; 357
+        0.150267   2.103175   0.150937 ;; 358
+        0.150267   0.150937   0.150937 ;; 359
        -1.781207   0.150936  -0.150937 ;; 360
-       -0.000670   0.150936   1.841506 ;; 361
-       -0.151607   0.150936   2.127351 ;; 362
-       -2.091606  -1.050938   1.031500 ;; 363
-        0.150267  -0.150937  -0.155671 ;; 364
-        0.150267   1.851356  -0.150936 ;; 365
-        1.780537   1.050936   0.900000 ;; 366
-       -1.051607   1.050936   1.841506 ;; 367
-       -0.900670   1.050937  -2.132085 ;; 368
-        0.150267  -0.150937   1.841506 ;; 369
-       -0.151607   2.103175   0.150937 ;; 370
-       -0.750528   1.851356   0.150937 ;; 371
-        2.090937  -0.150937  -0.156701 ;; 372
-       -0.151606  -0.150937   2.127351 ;; 373
-       -1.781206  -0.150937  -0.000000 ;; 374
-       -0.480033   2.103175   0.150937 ;; 375
-       -1.051607   1.050936   2.127351 ;; 376
-       -1.781206  -1.050938   1.031500 ;; 377
-       -0.480033   2.103175   0.150937 ;; 378
-       -0.000670   0.150937  -1.846240 ;; 379
-        0.150267   0.150937   0.150937 ;; 380
-       -3.091192  -0.090096   0.093535 ;; 381
-        0.150267   0.150937  -0.155671 ;; 382
-       -0.750527   1.851356  -0.150937 ;; 383
-       -2.091606  -0.150937  -0.000000 ;; 384
-       -1.781207   1.050936  -1.050937 ;; 385
-        0.150267   1.851356   0.150937 ;; 386
-        2.090937  -0.150937   0.156700 ;; 387
-       -0.151606  -0.150937   1.841506 ;; 388
-       -0.151606  -0.150937  -2.132085 ;; 389
-        0.067099  -0.051136   3.091057 ;; 390
-        1.780536  -1.050937  -1.050937 ;; 391
-        0.150267  -0.150936  -2.132085 ;; 392
-       -1.781207   1.050936  -0.900000 ;; 393
-        1.021424   1.851356   0.150937 ;; 394
-       -0.151607   1.851356  -0.150936 ;; 395
-        2.090937  -1.050937  -1.050937 ;; 396
-        0.150267  -0.150937   2.127351 ;; 397
-        0.937340   3.110451  -0.150937 ;; 398
-        1.780537   0.150936  -0.150937 ;; 399
-       -0.068439  -0.051136   3.091057 ;; 400
-        2.090937   1.050936   0.900000 ;; 401
-        0.150267   0.150937   1.841506 ;; 402
-       -0.068439   0.084402   3.091057 ;; 403
-        1.050267   1.050937  -1.846240 ;; 404
-       -0.151606  -0.150937   0.150937 ;; 405
-       -0.151607   2.103175  -0.150936 ;; 406
-       -1.781207   1.050936  -1.050937 ;; 407
-        1.780536  -1.050937  -0.861211 ;; 408
-        0.150267   0.150937   1.841506 ;; 409
-       -3.091192   0.090094   0.090095 ;; 410
-       -0.151607   1.851356   0.150937 ;; 411
-        0.346967   2.879049  -0.150937 ;; 412
-        0.150267  -0.150937   1.841506 ;; 413
-       -1.781206  -0.150937   0.156700 ;; 414
+        2.090937  -0.150937   0.156700 ;; 361
+        0.150267   2.103175  -0.150936 ;; 362
+       -1.781207   1.050936  -0.900000 ;; 363
+       -0.000670   0.150937  -2.132085 ;; 364
+        0.937340   3.110451  -0.150937 ;; 365
+       -2.091607   1.050936   0.900000 ;; 366
+       -1.070406   2.103175   0.150936 ;; 367
+        0.899330   1.050937  -1.846240 ;; 368
+        0.899330   1.050937   2.127351 ;; 369
+        1.780537  -0.150937  -0.156701 ;; 370
+       -0.000670   0.150936   2.127351 ;; 371
+       -2.091607   1.050936   1.050937 ;; 372
+       -0.151607   2.103175  -0.150936 ;; 373
+       -2.091607  -0.150937  -0.156701 ;; 374
+       -2.091607   0.150936   0.150936 ;; 375
+        1.780537   0.150936  -0.000000 ;; 376
+       -2.091607   0.150936  -0.000000 ;; 377
+       -1.070406   1.851356   0.150936 ;; 378
+        0.150268  -1.057474  -2.132085 ;; 379
+       -2.091607   0.150936  -0.150937 ;; 380
+        0.150267  -0.150937   2.127351 ;; 381
+        1.780537   1.050936   1.050937 ;; 382
+       -0.480033   2.103175   0.150937 ;; 383
+        0.150267   0.150937  -1.846240 ;; 384
+        1.780536  -1.050937  -0.861211 ;; 385
+        0.346967   2.879049  -0.150937 ;; 386
+        1.780537  -0.150937   0.156700 ;; 387
+       -0.900670   1.050937   2.127351 ;; 388
+       -0.151607   0.150937  -1.846240 ;; 389
+        0.150267  -0.150936  -1.846240 ;; 390
+        0.150267   1.851356   0.150937 ;; 391
+        1.050267   1.050937  -2.132085 ;; 392
+       -0.900670   1.050937   1.841506 ;; 393
+        2.090937  -0.150937  -0.156701 ;; 394
+       -1.781206  -1.050938   1.031500 ;; 395
+       -0.068439   0.084402   3.091057 ;; 396
+        1.021424   1.851356   0.150937 ;; 397
+        0.899330   1.050937  -1.846240 ;; 398
+       -1.051607   1.050937  -1.846240 ;; 399
+        2.090936  -1.050938   1.031500 ;; 400
+        0.150267  -0.150937   1.841506 ;; 401
+       -1.781206  -0.150937  -0.000000 ;; 402
+        2.090937   1.050936   0.900000 ;; 403
+        0.617462   3.110451  -0.150937 ;; 404
+       -1.077211   2.879049   0.150936 ;; 405
+        0.150267   0.150937   2.127351 ;; 406
+        0.937340   2.879049  -0.150937 ;; 407
+       -0.068439   0.084402   3.091057 ;; 408
+        2.090937   0.150936  -0.150937 ;; 409
+       -1.781206  -1.050937  -1.050937 ;; 410
+       -1.781206  -0.150937  -0.000000 ;; 411
+        0.150267   1.851356  -0.150936 ;; 412
+        1.780537  -0.150937   0.156700 ;; 413
+        0.150267   0.150937   1.841506 ;; 414
        -0.068439  -0.051136   3.091057 ;; 415
-        0.937339   2.879049   0.150937 ;; 416
-        2.090937   1.050936  -0.900000 ;; 417
-        0.150267   0.150937   0.150937 ;; 418
-       -1.781207   1.050936  -1.050937 ;; 419
-        0.150267  -0.150937  -0.155671 ;; 420
-        1.780537  -0.150937  -0.156701 ;; 421
-        0.899330   1.050937   2.127351 ;; 422
-        0.150267  -0.150936  -2.132085 ;; 423
-       -1.781206  -1.050937  -0.861211 ;; 424
-        2.090937   0.150936   0.150936 ;; 425
-       -3.091192   0.090094  -0.090095 ;; 426
-        1.021424   1.851356   0.150937 ;; 427
-        1.050267   1.050937   2.127351 ;; 428
-        1.050267   1.050937  -1.846240 ;; 429
-       -0.750527   1.851356  -0.150937 ;; 430
-        1.050267   1.050937   1.841506 ;; 431
-       -1.781207  -0.150937  -0.156701 ;; 432
-        1.050267   1.050937  -2.132085 ;; 433
-       -0.068439   0.084402   3.091057 ;; 434
-       -0.900670   1.050937  -2.132085 ;; 435
-       -0.151606  -0.150937   2.127351 ;; 436
-        1.050267   1.050937   1.841506 ;; 437
-       -1.781207   1.050936   1.050937 ;; 438
-       -2.091606  -1.050937  -0.861211 ;; 439
-        0.937339   2.879049   0.150937 ;; 440
-       -0.000670   0.150937  -1.846240 ;; 441
-        0.150267   2.103175  -0.150936 ;; 442
-        0.617461   3.110451   0.150936 ;; 443
-       -1.781207   0.150936   0.150936 ;; 444
-        0.150267   0.150937  -2.132085 ;; 445
-       -1.051607   1.050937  -2.132085 ;; 446
-        0.150267  -0.150937   2.127351 ;; 447
-        2.090937   1.050936  -1.050937 ;; 448
-       -1.077211   3.110451  -0.150937 ;; 449
-        0.067099  -0.051136   3.091057 ;; 450
-       -1.781207  -0.150937  -0.156701 ;; 451
-       -0.750527   1.851356  -0.150937 ;; 452
-       -0.900670   1.050937  -1.846240 ;; 453
-       -0.151606  -0.150937  -1.846240 ;; 454
-        0.150267   0.150937   2.127351 ;; 455
-        2.090937  -0.150937   0.156700 ;; 456
-        0.150267  -0.150936  -1.846240 ;; 457
-       -2.091607   0.150936   0.150936 ;; 458
-       -2.091607   1.050936  -1.050937 ;; 459
-       -0.151606  -0.150937  -0.155671 ;; 460
-       -2.091606  -0.150937   0.156700 ;; 461
-        0.346967   2.879049  -0.150937 ;; 462
-       -3.091192  -0.090096  -0.093536 ;; 463
-       -3.091192   0.090094  -0.000000 ;; 464
-       -1.781207  -0.150937  -0.156701 ;; 465
-       -1.051607   1.050937  -1.846240 ;; 466
-        1.780537  -0.150937   0.156700 ;; 467
-       -0.900670   1.050937   2.127351 ;; 468
-        0.150267  -0.150937   0.150937 ;; 469
-       -0.151607   0.150937  -1.846240 ;; 470
-        0.346967   2.879049  -0.150937 ;; 471
-        0.937339   2.879049   0.150937 ;; 472
-       -0.750528   1.851356   0.150937 ;; 473
-        0.617462   3.110451  -0.150937 ;; 474
-       -0.900670   1.050937   1.841506 ;; 475
-       -1.781207   0.150936  -0.150937 ;; 476
-       -0.151606  -1.057474  -1.846240 ;; 477
-       -1.051607   1.050936   1.841506 ;; 478
-        1.050267   1.050937   2.127351 ;; 479
-       -2.091607  -0.150937  -0.156701 ;; 480
-        0.346967   2.879049   0.150936 ;; 481
-        2.090936  -1.050938   0.874799 ;; 482
-        1.780537   1.050936   0.900000 ;; 483
-        0.150267  -0.150936  -1.846240 ;; 484
-        0.150267  -0.150937   1.841506 ;; 485
-       -0.750528   1.851356   0.150937 ;; 486
-       -0.068439  -0.051136   3.091057 ;; 487
-        0.899330   1.050937  -2.132085 ;; 488
-        0.899330   1.050937   1.841506 ;; 489
-       -0.480033   2.103175   0.150937 ;; 490
-       -2.091607   1.050936   1.050937 ;; 491
-        1.780537   1.050936   1.050937 ;; 492
-        0.150267  -0.150937   0.150937 ;; 493
-        1.780537   0.150936  -0.000000 ;; 494
-        0.150267  -0.150936  -2.132085 ;; 495
-        2.090937  -0.150937  -0.156701 ;; 496
-       -1.781207   1.050936   1.050937 ;; 497
-        0.150267   0.150937   0.150937 ;; 498
-        0.067099   0.084402   3.091057 ;; 499
-       -2.091606  -1.050937  -1.050937 ;; 500
-        0.937339   3.110451   0.150937 ;; 501
-       -3.091192  -0.090096  -0.093536 ;; 502
-        0.150267  -0.150937  -0.155671 ;; 503
-       -0.151606  -0.150937  -2.132085 ;; 504
-        0.150267  -0.150936  -2.132085 ;; 505
-        2.090937   0.150936  -0.150937 ;; 506
-       -0.151606  -0.150937  -1.846240 ;; 507
-       -1.781206  -1.050937   0.874799 ;; 508
-       -1.781206  -0.150937  -0.000000 ;; 509
-       -1.781207   1.050936  -0.900000 ;; 510
-       -1.077211   2.879049  -0.150937 ;; 511
-        1.021424   1.851356   0.150937 ;; 512
-        0.150267   0.150937   0.150937 ;; 513
-       -0.151607   0.150937  -1.846240 ;; 514
-       -0.151606  -0.150937   0.150937 ;; 515
-       -2.091607   0.150936  -0.000000 ;; 516
-        0.150268  -1.057474  -2.132085 ;; 517
-        0.617462   3.110451  -0.150937 ;; 518
-       -1.781207   0.150936  -0.000000 ;; 519
-       -0.151607   1.851356  -0.150936 ;; 520
-        0.346967   2.879049   0.150936 ;; 521
-       -0.151606  -1.057474  -2.132085 ;; 522
-       -1.781206  -1.050937  -0.861211 ;; 523
-       -0.000670   0.150937  -2.132085 ;; 524
-        0.150268  -1.057474   1.841506 ;; 525
-       -3.091192  -0.090096  -0.000000 ;; 526
-        1.780537   1.050936  -1.050937 ;; 527
-        2.090937  -0.150937   0.156700 ;; 528
-        0.150267   0.150937  -1.846240 ;; 529
-       -0.151606  -0.150937   0.150937 ;; 530
-        1.780536  -1.050937   0.874799 ;; 531
-        1.780537   1.050936  -0.900000 ;; 532
-        0.937340   2.879049  -0.150937 ;; 533
-       -0.151607   1.851356   0.150937 ;; 534
-       -1.781207   1.050936   0.900000 ;; 535
-       -1.781206  -0.150937   0.156700 ;; 536
-       -0.151606  -1.057474   1.841506 ;; 537
-        0.937339   2.879049   0.150937 ;; 538
-       -1.781206  -1.050937  -1.050937 ;; 539
-        0.150268  -1.057474   2.127351 ;; 540
-        2.090937   0.150936   0.150936 ;; 541
-       -3.091192  -0.090096   0.093535 ;; 542
-        0.150267   0.150937  -1.846240 ;; 543
-        0.617462   3.110451  -0.150937 ;; 544
-       -0.151607   0.150936   2.127351 ;; 545
-       -0.480033   2.103175  -0.150937 ;; 546
-       -0.151606  -0.150937  -1.846240 ;; 547
-       -1.781206  -1.050937  -0.861211 ;; 548
-       -2.091607   1.050936   0.900000 ;; 549
-       -2.091607   0.150936   0.150936 ;; 550
-       -1.070405   2.103175  -0.150937 ;; 551
-        0.617462   3.110451  -0.150937 ;; 552
-       -0.480033   2.103175   0.150937 ;; 553
-       -1.781206  -0.150937   0.156700 ;; 554
-       -0.000670   0.150936   1.841506 ;; 555
-        0.150267  -0.150937   0.150937 ;; 556
-       -1.781207   0.150936  -0.000000 ;; 557
-        0.150267   0.150937  -0.155671 ;; 558
-       -0.151606  -0.150937   1.841506 ;; 559
-       -0.750527   1.851356  -0.150937 ;; 560
-        1.780537   1.050936  -1.050937 ;; 561
-        0.899330   1.050937   2.127351 ;; 562
-       -1.070405   2.103175  -0.150937 ;; 563
-        2.090937  -0.150937  -0.000000 ;; 564
-       -1.070406   2.103175   0.150936 ;; 565
-       -2.091607   1.050936  -0.900000 ;; 566
-       -0.000670   0.150936   1.841506 ;; 567
-       -2.091607  -0.150937  -0.156701 ;; 568
-       -0.151607   0.150936   2.127351 ;; 569
-        1.021424   1.851356  -0.150936 ;; 570
+       -0.750527   1.851356  -0.150937 ;; 416
+        1.780536  -1.050937  -0.861211 ;; 417
+        1.780537   1.050936  -1.050937 ;; 418
+       -0.151606  -0.150937  -1.846240 ;; 419
+        2.090937  -0.150937  -0.000000 ;; 420
+       -0.480033   2.103175  -0.150937 ;; 421
+        0.899330   1.050937  -2.132085 ;; 422
+       -0.151606  -0.150937   1.841506 ;; 423
+        1.780536  -1.050937  -1.050937 ;; 424
+        0.937339   2.879049   0.150937 ;; 425
+        0.937340   2.879049  -0.150937 ;; 426
+        1.780536  -1.050937   0.874799 ;; 427
+        0.150267   0.150937   0.150937 ;; 428
+       -0.151607   1.851356  -0.150936 ;; 429
+       -1.781206  -1.050938   1.031500 ;; 430
+       -0.480033   2.103175  -0.150937 ;; 431
+        0.150267   1.851356  -0.150936 ;; 432
+        0.899330   1.050937   2.127351 ;; 433
+        0.150267  -0.150937   0.150937 ;; 434
+       -0.000670   0.150937  -1.846240 ;; 435
+       -3.091192   0.090094  -0.090095 ;; 436
+       -0.900670   1.050937  -2.132085 ;; 437
+       -1.781207   0.150936   0.150936 ;; 438
+        1.780537   0.150936  -0.150937 ;; 439
+       -0.480033   2.103175   0.150937 ;; 440
+        0.150267   0.150937  -1.846240 ;; 441
+        2.090937   1.050936   0.900000 ;; 442
+        0.150267  -0.150937   1.841506 ;; 443
+        1.050267   1.050937   1.841506 ;; 444
+       -2.091607   1.050936   0.900000 ;; 445
+        1.780537   0.150936  -0.000000 ;; 446
+        1.050267   1.050937  -1.846240 ;; 447
+       -0.151607   2.103175   0.150937 ;; 448
+        0.150267   2.103175  -0.150936 ;; 449
+       -0.151606  -0.150937   2.127351 ;; 450
+       -2.091607   0.150936  -0.150937 ;; 451
+        0.150267  -0.150936  -1.846240 ;; 452
+       -0.151607   2.103175   0.150937 ;; 453
+       -0.900670   1.050937  -1.846240 ;; 454
+       -0.151606  -1.057474   1.841506 ;; 455
+       -1.781207   1.050936   0.900000 ;; 456
+        0.067099  -0.051136   3.091057 ;; 457
+       -1.077211   2.879049  -0.150937 ;; 458
+        1.780536  -1.050938   1.031500 ;; 459
+       -0.151606  -1.057474  -1.846240 ;; 460
+        2.090937   0.150936   0.150936 ;; 461
+       -1.077211   3.110451  -0.150937 ;; 462
+       -1.051607   1.050936   1.841506 ;; 463
+        2.090937   0.150936  -0.150937 ;; 464
+       -2.091607   0.150936  -0.000000 ;; 465
+       -1.781206  -1.050938   1.031500 ;; 466
+       -2.091606  -0.150937   0.156700 ;; 467
+       -1.070406   2.103175   0.150936 ;; 468
+        1.050267   1.050937  -2.132085 ;; 469
+        1.021424   1.851356  -0.150936 ;; 470
+        2.090936  -1.050938   1.031500 ;; 471
+        1.780536  -1.050938   1.031500 ;; 472
+        0.150267  -0.150937   1.841506 ;; 473
+       -2.091606  -0.150937  -0.000000 ;; 474
+       -1.051607   1.050936   1.841506 ;; 475
+       -0.151607   2.103175  -0.150936 ;; 476
+       -0.151606  -0.150937  -1.846240 ;; 477
+       -1.077211   2.879049   0.150936 ;; 478
+       -0.151607   0.150936   2.127351 ;; 479
+        1.780537  -0.150937  -0.000000 ;; 480
+       -2.091607   0.150936  -0.150937 ;; 481
+       -3.091192  -0.090096  -0.000000 ;; 482
+        0.150267   0.150937   1.841506 ;; 483
+       -0.000670   0.150937  -2.132085 ;; 484
+       -1.051607   1.050936   2.127351 ;; 485
+        1.780537   1.050936   0.900000 ;; 486
+        0.150267   2.103175   0.150937 ;; 487
+       -0.151607   1.851356   0.150937 ;; 488
+        1.780537   1.050936  -0.900000 ;; 489
+        0.346967   2.879049  -0.150937 ;; 490
+        0.937340   2.879049  -0.150937 ;; 491
+       -1.781207   1.050936  -1.050937 ;; 492
+       -0.750528   1.851356   0.150937 ;; 493
+       -0.151607   0.150937  -1.846240 ;; 494
+        1.780536  -1.050937   0.874799 ;; 495
+        1.780537   0.150936  -0.150937 ;; 496
+       -0.151607   0.150937   0.150937 ;; 497
+        0.150267  -0.150937   2.127351 ;; 498
+       -3.091192   0.090094   0.090095 ;; 499
+       -0.151607   0.150937  -2.132085 ;; 500
+       -0.151607   0.150937  -0.155671 ;; 501
+        0.150267  -0.150937   0.150937 ;; 502
+       -0.151607   0.150936   1.841506 ;; 503
+       -0.151607   1.851356   0.150937 ;; 504
+       -1.077211   3.110451   0.150936 ;; 505
+        1.780537   1.050936   0.900000 ;; 506
+        0.150267   0.150937  -0.155671 ;; 507
+       -3.091192  -0.090096  -0.093536 ;; 508
+       -0.151607   2.103175  -0.150936 ;; 509
+       -2.091606  -0.150937   0.156700 ;; 510
+       -0.480033   2.103175   0.150937 ;; 511
+        0.150267  -0.150936  -2.132085 ;; 512
+        1.050267   1.050937  -1.846240 ;; 513
+        0.150268  -1.057474  -2.132085 ;; 514
+        2.090936  -1.050937  -0.861211 ;; 515
+       -1.781207   1.050936   0.900000 ;; 516
+       -2.091607   0.150936   0.150936 ;; 517
+        1.780537   1.050936  -1.050937 ;; 518
+        1.780537   1.050936   1.050937 ;; 519
+       -0.900670   1.050937  -1.846240 ;; 520
+        2.090936  -1.050938   0.874799 ;; 521
+        0.346967   2.879049  -0.150937 ;; 522
+        2.090937   1.050936   1.050937 ;; 523
+        0.150267   1.851356   0.150937 ;; 524
+       -1.077211   2.879049  -0.150937 ;; 525
+        2.090937  -0.150937  -0.000000 ;; 526
+        1.780537  -0.150937  -0.156701 ;; 527
+       -0.151606  -0.150937  -2.132085 ;; 528
+        0.150267   0.150937   1.841506 ;; 529
+       -1.781207   1.050936   1.050937 ;; 530
+        0.617461   3.110451   0.150936 ;; 531
+        0.899330   1.050937  -1.846240 ;; 532
+       -0.480033   2.103175   0.150937 ;; 533
+        0.150267   0.150937  -2.132085 ;; 534
+        1.780537   0.150936  -0.150937 ;; 535
+       -3.091192   0.090094  -0.000000 ;; 536
+       -2.091606  -0.150937  -0.000000 ;; 537
+       -1.051607   1.050936   1.841506 ;; 538
+        1.780537   1.050936  -1.050937 ;; 539
+        0.150267   0.150937   0.150937 ;; 540
+        0.150268  -1.057474  -1.846240 ;; 541
+        0.346967   2.879049  -0.150937 ;; 542
+        0.617462   3.110451  -0.150937 ;; 543
+       -2.091607   0.150936  -0.150937 ;; 544
+       -0.151607   0.150936   1.841506 ;; 545
+       -2.091607   0.150936  -0.150937 ;; 546
+        0.150267   1.851356  -0.150936 ;; 547
+        1.780537   1.050936   0.900000 ;; 548
+        0.617461   3.110451   0.150936 ;; 549
+       -1.070406   1.851356   0.150936 ;; 550
+        0.150267   2.103175  -0.150936 ;; 551
+        2.090937   0.150936  -0.000000 ;; 552
+        1.780536  -1.050937  -0.861211 ;; 553
+       -1.070405   1.851356  -0.150937 ;; 554
+       -0.151607   0.150937  -0.155671 ;; 555
+       -0.151606  -0.150937  -0.155671 ;; 556
+       -0.151607   0.150937  -1.846240 ;; 557
+       -1.051607   1.050936   2.127351 ;; 558
+        1.780536  -1.050937  -1.050937 ;; 559
+        0.150267   2.103175   0.150937 ;; 560
+       -1.781206  -1.050937  -0.861211 ;; 561
+       -0.151606  -0.150937   0.150937 ;; 562
+       -0.151606  -1.057474  -2.132085 ;; 563
+       -1.781207   0.150936  -0.150937 ;; 564
+        2.090937  -0.150937   0.156700 ;; 565
+       -2.091607  -0.150937  -0.156701 ;; 566
+       -0.480033   2.103175   0.150937 ;; 567
+        1.780537  -0.150937  -0.000000 ;; 568
+       -1.781207  -0.150937  -0.156701 ;; 569
+       -0.151606  -0.150937   1.841506 ;; 570
+        0.150267  -0.150937   0.150937 ;; 571
+       -0.151607   0.150936   1.841506 ;; 572
+       -1.781206  -0.150937   0.156700 ;; 573
+       -1.781206  -0.150937   0.156700 ;; 574
+        1.780537  -0.150937  -0.156701 ;; 575
+       -0.151607   2.103175  -0.150936 ;; 576
+        0.150267  -0.150937   1.841506 ;; 577
+        0.067099   0.084402   3.091057 ;; 578
+       -0.000670   0.150936   2.127351 ;; 579
+       -1.781207   1.050936  -1.050937 ;; 580
+       -0.000670   0.150937  -1.846240 ;; 581
+        1.780537   1.050936  -0.900000 ;; 582
+       -2.091607  -0.150937  -0.156701 ;; 583
+       -1.781206  -1.050937  -0.861211 ;; 584
+        1.780536  -1.050937  -1.050937 ;; 585
+        0.346967   2.879049   0.150936 ;; 586
+        2.090936  -1.050938   0.874799 ;; 587
+        0.346967   2.879049  -0.150937 ;; 588
+        0.150267   2.103175   0.150937 ;; 589
+       -0.750527   1.851356  -0.150937 ;; 590
+       -0.151606  -1.057474  -1.846240 ;; 591
+        2.090936  -1.050937  -0.861211 ;; 592
+       -0.900670   1.050937   1.841506 ;; 593
+       -0.151606  -0.150937  -2.132085 ;; 594
+        2.090937  -0.150937   0.156700 ;; 595
+       -2.091606  -0.150937   0.156700 ;; 596
+        0.617461   3.110451   0.150936 ;; 597
+       -2.091607   0.150936  -0.000000 ;; 598
+       -2.091607   0.150936   0.150936 ;; 599
+       -0.151607   2.103175  -0.150936 ;; 600
+       -1.077211   2.879049   0.150936 ;; 601
+       -0.151606  -0.150937  -1.846240 ;; 602
+        0.937340   2.879049  -0.150937 ;; 603
+       -3.091192   0.090094   0.090095 ;; 604
+        0.150267   1.851356  -0.150936 ;; 605
+       -1.070405   2.103175  -0.150937 ;; 606
+       -1.070406   1.851356   0.150936 ;; 607
+       -1.781207   0.150936   0.150936 ;; 608
+       -1.781206  -0.150937  -0.000000 ;; 609
+       -1.070405   1.851356  -0.150937 ;; 610
+       -2.091607   0.150936  -0.000000 ;; 611
+       -0.151606  -0.150937  -0.155671 ;; 612
+       -1.781207   1.050936   1.050937 ;; 613
+       -2.091606  -0.150937   0.156700 ;; 614
+       -3.091192  -0.090096  -0.000000 ;; 615
+       -0.750528   1.851356   0.150937 ;; 616
+       -0.900670   1.050937   1.841506 ;; 617
+       -1.781207   1.050936  -1.050937 ;; 618
+       -3.091192   0.090094  -0.000000 ;; 619
+        1.021424   2.103175   0.150937 ;; 620
+       -2.091606  -1.050938   0.874799 ;; 621
+       -1.781206  -1.050938   1.031500 ;; 622
      ) ;; vertices
 
     (normals
       -0.577349 -0.577349  0.577349
-      -0.344401 -0.094302  0.934049
-       0.561510  0.232582 -0.794092
+      -0.909940 -0.909940  0.001099
+      -0.942625 -0.942625  0.236213
+      -0.239082 -0.239082  0.565813
        0.910855  0.910855  0.412671
-       0.301584 -0.300729 -0.904752
-      -0.618854  0.560717  0.550066
-      -0.577349 -0.577349  0.577349
-       0.626942 -0.259682 -0.734489
-      -0.577349 -0.577349 -0.577349
-       0.407605  0.817255 -0.407361
-      -0.259682 -0.259682 -0.734489
-      -0.707083 -0.707083 -0.707083
-       0.000000  0.000000 -0.832026
-       0.735862 -0.253121 -0.628010
-      -0.707083 -0.707083  0.707083
-       0.344035  0.110752 -0.932371
-       0.561510  0.232582  0.794092
-      -0.933226  0.100955 -0.344737
-       0.301492 -0.301492  0.904508
-       0.157903  0.040376  0.986602
-       0.100955  0.100955 -0.344737
-       0.000000  0.707083  0.707083
-      -0.040376 -0.040376 -0.986602
-       0.707083  0.707083  0.707083
-       0.546648  0.547380  0.633656
-       0.792962 -0.234046 -0.562487
-       0.235786 -0.942625  0.236213
-      -0.540635 -0.539781  0.645222
-      -0.618854  0.560717 -0.550066
-      -0.577349 -0.577349 -0.577349
-       0.812494  0.812494  0.336528
+       0.910855  0.910855 -0.412671
+       0.812494  0.812494 -0.336528
+       0.110752  0.110752 -0.932371
+      -0.301492 -0.301492 -0.301492
       -0.300729 -0.300729 -0.904752
-      -0.685263 -0.685263  0.000000
-       0.336528  0.812494 -0.475936
-      -0.577349  0.577349  0.577349
-      -0.294839 -0.294839  0.352428
-      -0.157903 -0.040376  0.986602
-       0.100955  0.100955 -0.344737
-      -0.234046 -0.234046 -0.562487
-       0.577349  0.577349 -0.577349
-      -0.301584 -0.300729 -0.904752
-      -0.301492 -0.301492  0.301492
-      -0.089145 -0.089145  0.920408
-       0.412671  0.910855  0.000000
-       0.265297  0.265297 -0.626392
-       0.262154  0.262154  0.628559
        0.000000  0.000000 -0.707083
+      -0.546068 -0.546068 -0.556536
+      -0.540635 -0.539781  0.645222
        0.577349 -0.577349 -0.577349
-       0.547380  0.547380  0.633656
-       0.333323  0.333323  0.000000
-       0.577349 -0.577349  0.577349
-       0.412671  0.910855  0.000000
-       0.040376  0.040376  0.986602
-       0.577349 -0.577349  0.577349
-      -0.942473 -0.942473 -0.236152
-      -0.728263  0.685263  0.000000
-       0.732963  0.265297 -0.626392
-       0.332469  0.332469  0.758049
-       0.332469  0.332469 -0.758080
-      -0.253121 -0.253121 -0.628010
-      -0.091891 -0.091891 -0.934263
-      -0.332469 -0.332469 -0.758049
-      -0.577349 -0.577349 -0.577349
-       0.707083  0.707083 -0.707083
-       0.794092  0.232582  0.561510
-      -0.316324  0.633534  0.706076
-       0.232582  0.232582 -0.561510
-      -0.807886 -0.807886  0.345103
-       0.333323  0.333323 -0.942808
-      -0.577349 -0.577349 -0.577349
-      -0.561510  0.232582  0.794092
+      -0.792962 -0.234046 -0.562487
+      -0.626942 -0.259682 -0.734489
+       0.336528  0.812494  0.475936
+      -0.888150 -0.294839  0.352428
+       0.633534  0.633534  0.706076
+       0.561510  0.232582  0.794092
+      -0.707083 -0.707083 -0.707083
       -0.577349 -0.577349  0.577349
-       0.933226  0.100955  0.344737
-      -0.259682 -0.259682 -0.734489
-       0.561510  0.232582  0.794092
-      -0.789087 -0.239082  0.565813
-      -0.040376 -0.040376  0.986602
-      -0.909940 -0.909940  0.001099
-       0.232582  0.232582 -0.794092
-      -0.086734 -0.086734 -0.920225
-       0.110691  0.110691  0.932066
+      -0.239082 -0.239082  0.565813
+       0.344920  0.110691  0.932066
+       0.040376  0.040376 -0.986602
        0.812494  0.812494 -0.336528
-      -0.259682 -0.259682 -0.734489
-      -0.577349 -0.577349 -0.577349
-       0.847224  0.847224  0.531205
-       0.475936  0.812494  0.336528
-       0.561022 -0.332469 -0.758049
-       0.232582  0.232582 -0.794092
-       0.942808  0.333323  0.000000
-      -0.577349  0.577349 -0.577349
-      -0.942473 -0.942473 -0.236152
-      -0.380596 -0.089145  0.920408
-       0.040376  0.040376 -0.986602
-      -0.327891 -0.327891  0.001282
-       0.707083  0.707083  0.707083
-      -0.380932  0.111698 -0.917814
-       0.232582  0.232582  0.561510
-      -0.728263 -0.685263  0.000000
-      -0.094302 -0.094302  0.934049
-       0.336528  0.812494  0.475936
-      -0.477645 -0.807886  0.345103
-      -0.942625 -0.942625  0.236213
+       0.236427 -0.942473 -0.236152
+      -0.332469 -0.332469  0.758080
       -0.577349 -0.577349  0.577349
-      -0.531083 -0.847285  0.001343
-       0.157903  0.040376 -0.986602
-      -0.794092  0.232582 -0.561510
-       0.000000 -0.707083  0.707083
-      -0.234046 -0.234046 -0.562487
-       0.944700 -0.327891  0.001282
-       0.344035  0.110752 -0.932371
-      -0.577349 -0.577349  0.577349
-      -0.294839 -0.294839  0.352428
-       0.560717  0.560717 -0.550066
-       0.577349  0.577349 -0.577349
       -0.475936  0.812494 -0.336528
-      -0.577349 -0.577349  0.577349
-       0.915128  0.098331  0.390912
-       0.812494  0.812494  0.475936
+       0.232582  0.232582 -0.794092
+       0.301584 -0.300729 -0.904752
+       0.904508 -0.301492 -0.301492
+       0.732963  0.265297 -0.626392
        0.000000  0.707083  0.707083
-      -0.234046 -0.234046 -0.562487
-       0.344920  0.110691  0.932066
+      -0.807886 -0.807886  0.345103
+       0.817255  0.817255 -0.407361
+      -0.301584 -0.300729 -0.904752
+       0.685263  0.685263  0.000000
        0.561510  0.232582 -0.794092
-       0.812494  0.812494 -0.336528
-       0.000000  0.707083  0.707083
-       0.301584 -0.300729 -0.904752
-      -0.407605  0.817255 -0.407361
-      -0.301492 -0.301492  0.301492
-      -0.807886 -0.807886  0.345103
-      -0.344462 -0.091891 -0.934263
+      -0.942625 -0.942625  0.236213
+      -0.477645 -0.807886  0.345103
+      -0.094302 -0.094302  0.934049
+      -0.942625 -0.942625  0.236213
+       0.577349  0.577349  0.577349
        0.794092  0.232582  0.561510
-      -0.336528  0.812494 -0.475936
-      -0.253121 -0.253121 -0.628010
-       0.849117  0.849117  0.000000
-      -0.089145 -0.089145  0.920408
-      -0.809534 -0.809534 -0.342082
-      -0.794092  0.232582  0.561510
-       0.301584 -0.300729 -0.904752
+       0.933226  0.100955  0.344737
        0.475936  0.812494 -0.336528
-       0.000000  0.910855  0.412671
-       0.232582  0.232582 -0.794092
+      -0.807886 -0.807886  0.345103
+       0.110752  0.110752 -0.932371
       -0.577349 -0.577349 -0.577349
-       0.732200  0.262154  0.628559
-       0.904508 -0.301492  0.301492
-      -0.380932  0.111698  0.917814
-       0.577349  0.577349  0.577349
-      -0.794092  0.232582 -0.561510
-      -0.546068 -0.546068 -0.556536
-       0.000000  0.000000 -0.832026
-       0.111698  0.111698 -0.917814
+       0.336528  0.812494 -0.475936
        0.735862 -0.253121 -0.628010
-       0.000000  0.847224  0.531205
-      -0.332469 -0.332469 -0.758049
-      -0.577349 -0.577349 -0.577349
-      -0.933226  0.100955  0.344737
-      -0.561022  0.332469  0.758049
-      -0.157903 -0.040376 -0.986602
-      -0.477035 -0.809534 -0.342082
-      -0.336528  0.812494  0.475936
-      -0.040376 -0.040376  0.986602
-       0.817255  0.817255  0.407636
        0.577349  0.577349  0.577349
-      -0.301492 -0.301492  0.301492
-       0.904508 -0.301492 -0.301492
-      -0.477035 -0.809534 -0.342082
        0.577349 -0.577349  0.577349
+       0.817255  0.817255  0.407636
+      -0.253121 -0.253121 -0.628010
+       0.577349  0.577349 -0.577349
+      -0.234046 -0.234046 -0.562487
        0.577349  0.577349  0.577349
-       0.232582  0.232582 -0.794092
-       0.685263  0.685263  0.000000
-      -0.259682 -0.259682 -0.734489
-       0.944700 -0.327891  0.001282
-       0.792962 -0.234046 -0.562487
-       0.933226  0.100955 -0.344737
-      -0.301584 -0.300729 -0.904752
+      -0.618854  0.560717 -0.550066
+       0.910855  0.910855 -0.412671
+       0.336528  0.812494 -0.475936
+      -0.789087 -0.239082  0.565813
+      -0.904508 -0.301492 -0.301492
+      -0.089145 -0.089145  0.920408
+      -0.094302 -0.094302  0.934049
+       0.000000  0.000000 -0.707083
+       0.812494  0.812494  0.336528
+       0.000000  0.707083  0.707083
+       0.477035 -0.809534 -0.342082
+      -0.540635 -0.539781  0.645222
+       0.812494  0.812494  0.336528
+      -0.091891 -0.091891 -0.934263
+       0.561510  0.232582  0.794092
+       0.301584 -0.300729 -0.904752
+      -0.234046 -0.234046 -0.562487
        0.577349 -0.577349  0.577349
-       0.100955  0.100955  0.344737
-       0.232582  0.232582 -0.794092
-      -0.794092  0.232582  0.561510
-       0.812494  0.812494 -0.475936
-      -0.327891 -0.327891  0.001282
-      -0.301492 -0.301492 -0.301492
-       0.735862 -0.253121  0.628010
-       0.560717  0.560717  0.550066
+       0.336528  0.812494 -0.475936
+      -0.577349 -0.577349 -0.577349
        0.707083  0.000000 -0.707083
-       0.849117  0.849117  0.000000
-      -0.904508 -0.301492 -0.301492
-      -0.336528  0.812494  0.475936
-      -0.528184  0.849117  0.000000
-      -0.294839 -0.294839  0.352428
+      -0.561510  0.232582 -0.794092
+       0.546648  0.547380  0.633656
        0.577349  0.577349 -0.577349
-       0.812494  0.812494  0.336528
-       0.707083  0.707083  0.707083
+      -0.577349 -0.577349 -0.577349
       -0.300729 -0.300729 -0.904752
-       0.475936  0.812494 -0.336528
-       0.812494  0.812494  0.475936
-      -0.577349 -0.577349  0.577349
-      -0.300729 -0.300729 -0.904752
-       0.817255  0.817255  0.407636
-       0.633534  0.633534  0.706076
+      -0.531083 -0.847285  0.001343
+       0.933226  0.100955 -0.344737
+      -0.301492 -0.301492  0.301492
+      -0.792962 -0.234046 -0.562487
+      -0.933226  0.100955  0.344737
+       0.732200  0.262154  0.628559
+       0.407300  0.817255  0.407636
+      -0.577349 -0.577349 -0.577349
+      -0.157903 -0.040376 -0.986602
+      -0.794092  0.232582 -0.561510
+      -0.301492 -0.301492  0.904508
+      -0.942473 -0.942473 -0.236152
+       0.904508 -0.301492  0.301492
+      -0.475936  0.812494 -0.336528
+      -0.728263 -0.685263  0.000000
+       0.232582  0.232582  0.561510
+       0.235786 -0.942625  0.236213
+      -0.344920  0.110691  0.932066
+      -0.577349 -0.577349 -0.577349
+      -0.942625 -0.942625  0.236213
        0.577349  0.577349  0.577349
-       0.477035 -0.809534 -0.342082
+       0.910855  0.910855  0.000000
+      -0.807886 -0.807886  0.345103
+       0.232582  0.232582  0.794092
        0.000000  0.707083 -0.707083
-       0.789087 -0.239082  0.565813
-       0.817255  0.817255  0.407636
-      -0.235786 -0.942625  0.236213
-       0.475936  0.812494  0.336528
-       0.888150 -0.294839  0.352428
-       0.477035 -0.809534 -0.342082
-       0.561022 -0.332469 -0.758049
-      -0.259682 -0.259682 -0.734489
-       0.232582  0.232582 -0.794092
-      -0.577349 -0.577349 -0.577349
       -0.301492 -0.301492  0.904508
-       0.561510  0.232582  0.794092
-      -0.301492 -0.301492 -0.301492
-       0.344401 -0.094302  0.934049
-       0.561022 -0.332469  0.758080
-      -0.344920  0.110691  0.932066
-      -0.546068 -0.546068 -0.556536
-       0.111698  0.111698 -0.917814
-      -0.561510  0.232582  0.794092
-      -0.236427 -0.942473 -0.236152
-       0.232582  0.232582 -0.561510
-      -0.792962 -0.234046 -0.562487
-       0.110691  0.110691  0.932066
-      -0.728263  0.685263  0.000000
-      -0.380596 -0.089145  0.920408
-       0.100955  0.100955 -0.344737
-      -0.626942 -0.259682 -0.734489
+      -0.794092  0.232582 -0.561510
+       0.577349 -0.577349  0.577349
+       0.414686 -0.909940  0.001099
        0.707083  0.707083  0.707083
-       0.577349  0.577349 -0.577349
+      -0.809534 -0.809534 -0.342082
+       0.888150 -0.294839  0.352428
+      -0.794092  0.232582  0.561510
        0.817255  0.817255 -0.407361
-       0.000000 -0.707083 -0.707083
-      -0.327891 -0.327891  0.001282
-       0.817255  0.817255 -0.407361
-       0.336528  0.812494 -0.475936
+       0.000000  0.910855 -0.412671
+      -0.618854  0.560717 -0.550066
+       0.100955  0.100955  0.344737
+       0.332469  0.332469 -0.758080
+       0.577349 -0.577349 -0.577349
+      -0.157903 -0.040376  0.986602
+       0.407605  0.817255 -0.407361
+       0.000000  0.000000 -0.832026
+      -0.336528  0.812494 -0.475936
+      -0.300729 -0.300729 -0.904752
+      -0.239082 -0.239082  0.565813
+       0.477035 -0.809534 -0.342082
+       0.794092  0.232582 -0.561510
       -0.577349 -0.577349  0.577349
-       0.157903  0.040376 -0.986602
-       0.000000 -0.707083  0.707083
-      -0.236427 -0.942473 -0.236152
-      -0.300729 -0.300729 -0.904752
-      -0.475936  0.812494 -0.336528
-      -0.577349  0.577349  0.577349
-       0.000000  0.333323 -0.942808
+      -0.477035 -0.809534 -0.342082
+      -0.807886 -0.807886  0.345103
+      -0.091891 -0.091891 -0.934263
+       0.561510  0.232582  0.794092
+       0.577349 -0.577349  0.577349
+       0.477645 -0.807886  0.345103
+       0.301492 -0.301492  0.904508
+       0.332469  0.332469  0.758049
+       0.707083  0.000000 -0.707083
+      -0.707083 -0.707083 -0.707083
+       0.547380  0.547380  0.633656
+      -0.301492 -0.301492  0.904508
       -0.407300  0.817255  0.407636
+       0.915128  0.098331  0.390912
+       0.344401 -0.094302  0.934049
+       0.577349 -0.577349  0.577349
+      -0.554674  0.000000 -0.832026
+       0.794092  0.232582  0.561510
+       0.633534  0.633534  0.706076
       -0.332469 -0.332469  0.758080
-      -0.909940 -0.909940  0.001099
-      -0.475936  0.812494  0.336528
-       0.560717  0.560717 -0.550066
+       0.040376  0.040376 -0.986602
+      -0.301492 -0.301492  0.904508
+      -0.807886 -0.807886  0.345103
+       0.792962 -0.234046 -0.562487
+       0.232582  0.232582 -0.561510
+      -0.294839 -0.294839  0.352428
+       0.475936  0.812494  0.336528
+      -0.040376 -0.040376  0.986602
+      -0.933226  0.100955 -0.344737
+      -0.577349 -0.577349 -0.577349
        0.577349 -0.577349 -0.577349
+       0.812494  0.812494 -0.475936
+      -0.477645 -0.807886  0.345103
+       0.561022 -0.332469  0.758080
+       0.577349  0.577349 -0.577349
+       0.812494  0.812494 -0.475936
+       0.812494  0.812494  0.336528
       -0.546068 -0.546068  0.556536
+       0.000000  0.333323 -0.942808
+       0.232582  0.232582  0.794092
+       0.382794 -0.382153  0.841060
+      -0.477035 -0.809534 -0.342082
+       0.577349  0.577349 -0.577349
+      -0.235786 -0.942625  0.236213
       -0.577349 -0.577349  0.577349
-       0.707083  0.707083 -0.707083
-      -0.344035  0.110752 -0.932371
-      -0.888150 -0.294839  0.352428
-       0.626942 -0.259682 -0.734489
-      -0.809534 -0.809534 -0.342082
-      -0.235786 -0.942625  0.236213
-      -0.301492 -0.301492  0.301492
-      -0.809534 -0.809534 -0.342082
-      -0.089145 -0.089145  0.920408
-       0.382794 -0.382153  0.841060
+      -0.794092  0.232582  0.561510
+       0.000000 -0.707083 -0.707083
+       0.000000  0.910855  0.412671
+       0.944700 -0.327891  0.001282
+       0.561510  0.232582 -0.794092
+       0.412671  0.910855  0.000000
+       0.232582  0.232582  0.794092
        0.817255  0.817255 -0.407361
-       0.812494  0.812494 -0.475936
-       0.098331  0.098331  0.390912
+       0.232582  0.232582 -0.561510
+      -0.157903 -0.040376  0.986602
+      -0.336528  0.812494 -0.475936
+       0.110691  0.110691  0.932066
+       0.475936  0.812494 -0.336528
+      -0.380932  0.111698  0.917814
+       0.812494  0.812494  0.336528
+       0.232582  0.232582  0.561510
+       0.561510  0.232582  0.794092
+       0.577349 -0.577349 -0.577349
+      -0.477035 -0.809534 -0.342082
        0.333323  0.333323  0.000000
-      -0.301492 -0.301492 -0.301492
-      -0.554674  0.000000 -0.832026
+       0.301492 -0.301492  0.904508
+       0.000000 -0.707083  0.707083
+       0.933226  0.100955  0.344737
+      -0.577349 -0.577349 -0.577349
+      -0.809534 -0.809534 -0.342082
+      -0.239082 -0.239082  0.565813
        0.577349 -0.577349  0.577349
-      -0.234046 -0.234046 -0.562487
+      -0.809534 -0.809534 -0.342082
+       0.040376  0.040376 -0.986602
+       0.794092  0.232582  0.561510
+       0.942808  0.333323  0.000000
       -0.301492 -0.301492  0.301492
-      -0.475936  0.812494  0.336528
-       0.332469  0.332469  0.758049
-       0.232582  0.232582  0.561510
-      -0.380932  0.111698 -0.917814
-      -0.407605  0.817255 -0.407361
-       0.707083  0.707083  0.707083
+      -0.332469 -0.332469  0.758080
+       0.812494  0.812494  0.475936
+       0.232582  0.232582 -0.561510
+       0.817255  0.817255 -0.407361
        0.707083  0.707083 -0.707083
-       0.794092  0.232582  0.561510
-      -0.561510  0.232582  0.794092
-      -0.157903 -0.040376  0.986602
-       0.477645 -0.807886  0.345103
-       0.475936  0.812494 -0.336528
-      -0.561022  0.332469  0.758049
-      -0.577349 -0.577349  0.577349
-       0.633534  0.633534  0.706076
-       0.915128  0.098331  0.390912
-       0.812494  0.812494 -0.475936
-       0.336528  0.812494 -0.475936
-       0.110752  0.110752 -0.932371
+      -0.577349 -0.577349 -0.577349
+       0.336528  0.812494  0.475936
+       0.110691  0.110691  0.932066
+      -0.626118 -0.546068  0.556536
        0.098331  0.098331  0.390912
-      -0.577349 -0.577349  0.577349
-      -0.577349 -0.577349 -0.577349
+      -0.915128  0.098331  0.390912
+       0.792962 -0.234046 -0.562487
+       0.812494  0.812494  0.336528
+      -0.407605  0.817255 -0.407361
+       0.098331  0.098331  0.390912
       -0.904508 -0.301492  0.301492
+      -0.301492 -0.301492  0.301492
+      -0.239082 -0.239082  0.565813
+      -0.253121 -0.253121 -0.628010
       -0.301492 -0.301492 -0.301492
-      -0.414686 -0.909940  0.001099
-       0.577349  0.577349  0.577349
-       0.685263  0.685263  0.000000
+       0.561022 -0.332469  0.758080
+       0.232582  0.232582 -0.561510
+       0.794092  0.232582 -0.561510
+      -0.301584 -0.300729 -0.904752
+       0.382794 -0.382153  0.841060
+      -0.316324  0.633534  0.706076
+       0.577349  0.577349 -0.577349
+       0.560717  0.560717 -0.550066
+       0.626942 -0.259682 -0.734489
+       0.792962 -0.234046 -0.562487
+       0.561510  0.232582 -0.794092
+       0.232582  0.232582 -0.794092
+       0.817255  0.817255 -0.407361
+       0.000000  0.000000 -0.832026
+       0.847224  0.847224  0.531205
+      -0.094302 -0.094302  0.934049
+      -0.344035  0.110752 -0.932371
       -0.259682 -0.259682 -0.734489
-       0.847224  0.847224  0.531205
-      -0.561022  0.332469 -0.758080
+       0.561022 -0.332469 -0.758049
+      -0.707083 -0.707083  0.707083
+      -0.707083 -0.707083  0.707083
+      -0.626942 -0.259682 -0.734489
+       0.332469  0.332469  0.758049
+      -0.344462 -0.091891 -0.934263
        0.817255  0.817255  0.407636
-       0.546648  0.547380  0.633656
+      -0.381603 -0.086734 -0.920225
        0.812494  0.812494 -0.336528
-      -0.332469 -0.332469 -0.758049
-      -0.915128  0.098331  0.390912
-      -0.380932  0.111698 -0.917814
-      -0.554674  0.000000 -0.832026
-       0.477645 -0.807886  0.345103
       -0.239082 -0.239082  0.565813
-      -0.381603 -0.086734 -0.920225
-      -0.728263 -0.685263  0.000000
-       0.794092  0.232582 -0.561510
-      -0.477645 -0.807886  0.345103
+      -0.327891 -0.327891  0.001282
+       0.735862 -0.253121  0.628010
+       0.944700 -0.327891  0.001282
+       0.344920  0.110691  0.932066
+       0.475936  0.812494  0.336528
+       0.236427 -0.942473 -0.236152
+      -0.728263  0.685263  0.000000
+       0.812494  0.812494  0.475936
+      -0.618854  0.560717  0.550066
+      -0.626118 -0.546068 -0.556536
+       0.732200  0.262154  0.628559
+       0.098331  0.098331  0.390912
+       0.336528  0.812494  0.475936
+      -0.236427 -0.942473 -0.236152
+      -0.626118 -0.546068  0.556536
+       0.732963  0.265297 -0.626392
+      -0.234046 -0.234046 -0.562487
+      -0.294839 -0.294839  0.352428
+       0.098331  0.098331  0.390912
+       0.100955  0.100955 -0.344737
+       0.000000  0.707083  0.707083
+      -0.040376 -0.040376  0.986602
+      -0.942473 -0.942473 -0.236152
+      -0.259682 -0.259682 -0.734489
+       0.904508 -0.301492  0.301492
+       0.232582  0.232582  0.561510
+       0.812494  0.812494 -0.475936
+      -0.234046 -0.234046 -0.562487
       -0.577349 -0.577349  0.577349
+       0.577349  0.577349  0.577349
+       0.910855  0.910855  0.000000
+      -0.332469 -0.332469 -0.758049
+       0.344035  0.110752 -0.932371
       -0.904508 -0.301492 -0.301492
+       0.412671  0.910855  0.000000
+      -0.253121 -0.253121  0.628010
+      -0.412671  0.910855  0.000000
+       0.812494  0.812494  0.336528
+       0.157903  0.040376  0.986602
+       0.000000 -0.707083  0.707083
+       0.344462 -0.091891 -0.934263
        0.232582  0.232582  0.794092
+      -0.475936  0.812494  0.336528
+       0.794092  0.232582 -0.561510
+      -0.259682 -0.259682 -0.734489
+      -0.253121 -0.253121  0.628010
+       0.232582  0.232582 -0.561510
+       0.626942 -0.259682 -0.734489
+      -0.336528  0.812494  0.475936
+       0.812494  0.812494 -0.475936
+      -0.336528  0.812494  0.475936
+      -0.236427 -0.942473 -0.236152
+      -0.618854  0.560717 -0.550066
+       0.812494  0.812494 -0.475936
+      -0.577349 -0.577349  0.577349
+      -0.235786 -0.942625  0.236213
+       0.232582  0.232582  0.794092
+       0.000000  0.000000 -0.832026
+      -0.294839 -0.294839  0.352428
+      -0.789087 -0.239082  0.565813
+       0.110752  0.110752 -0.932371
+      -0.259682 -0.259682 -0.734489
+      -0.577349  0.577349 -0.577349
        0.157903  0.040376 -0.986602
-       0.100955  0.100955  0.344737
+       0.332469  0.332469  0.758049
+       0.232582  0.232582 -0.794092
+       0.707083  0.000000 -0.707083
+       0.232582  0.232582 -0.794092
+       0.817255  0.817255  0.407636
+       0.547380  0.547380  0.633656
+       0.265297  0.265297 -0.626392
+       0.915128  0.098331  0.390912
+      -0.089145 -0.089145  0.920408
+      -0.809534 -0.809534 -0.342082
+      -0.561510  0.232582  0.794092
+      -0.626118 -0.546068 -0.556536
+      -0.531083 -0.847285  0.001343
+      -0.539781 -0.539781  0.645222
+       0.475936  0.812494  0.336528
+      -0.728263  0.685263  0.000000
+      -0.561022  0.332469 -0.758080
+      -0.327891 -0.327891  0.001282
+       0.707083  0.707083 -0.707083
+      -0.577349  0.577349  0.577349
+       0.626942 -0.259682 -0.734489
+       0.000000  0.707083 -0.707083
+       0.232582  0.232582 -0.794092
+       0.577349 -0.577349 -0.577349
+      -0.475936  0.812494  0.336528
+       0.111698  0.111698 -0.917814
+      -0.294839 -0.294839  0.352428
+      -0.685263 -0.685263  0.000000
+       0.792962 -0.234046 -0.562487
+      -0.040376 -0.040376  0.986602
+       0.000000 -0.707083 -0.707083
+      -0.807886 -0.807886  0.345103
+      -0.301492 -0.301492  0.301492
+      -0.301492 -0.301492 -0.301492
+      -0.561022  0.332469 -0.758080
+       0.707083  0.707083  0.707083
+       0.817255  0.817255  0.407636
        0.344035  0.110752 -0.932371
-      -0.909940 -0.909940  0.001099
+       0.262154  0.262154  0.628559
+       0.000000  0.707083 -0.707083
+       0.475936  0.812494  0.336528
+       0.333323  0.333323 -0.942808
        0.577349  0.577349 -0.577349
+       0.812494  0.812494 -0.336528
+      -0.561022  0.332469  0.758049
+      -0.336528  0.812494  0.475936
+      -0.336528  0.812494  0.475936
+      -0.091891 -0.091891 -0.934263
+       0.000000  0.847224  0.531205
+      -0.794092  0.232582  0.561510
        0.707083  0.707083 -0.707083
-       0.812494  0.812494  0.475936
-      -0.336528  0.812494  0.475936
-       0.577349 -0.577349 -0.577349
-       0.232582  0.232582 -0.794092
-       0.789087 -0.239082  0.565813
-       0.933226  0.100955  0.344737
-      -0.807886 -0.807886  0.345103
-      -0.942625 -0.942625  0.236213
-      -0.809534 -0.809534 -0.342082
-      -0.789087 -0.239082  0.565813
-       0.407605  0.817255 -0.407361
-       0.336528  0.812494  0.475936
-      -0.577349 -0.577349 -0.577349
-      -0.301492 -0.301492  0.904508
-       0.232582  0.232582  0.794092
-      -0.577349 -0.577349 -0.577349
+      -0.381603 -0.086734 -0.920225
+       0.111698  0.111698  0.917814
        0.910855  0.910855  0.000000
-      -0.239082 -0.239082  0.565813
-      -0.253121 -0.253121  0.628010
-       0.111698  0.111698 -0.917814
-       0.040376  0.040376 -0.986602
+      -0.528184  0.849117  0.000000
       -0.577349 -0.577349  0.577349
-       0.789087 -0.239082  0.565813
+      -0.577349 -0.577349 -0.577349
+      -0.380932  0.111698 -0.917814
+      -0.294839 -0.294839  0.352428
+       0.232582  0.232582  0.561510
+       0.040376  0.040376  0.986602
+       0.100955  0.100955  0.344737
       -0.477645 -0.807886  0.345103
-      -0.933226  0.100955 -0.344737
-      -0.577349 -0.577349 -0.577349
+      -0.040376 -0.040376 -0.986602
+      -0.344401 -0.094302  0.934049
+       0.812494  0.812494  0.475936
+       0.100955  0.100955  0.344737
+       0.904508 -0.301492  0.301492
        0.301492 -0.301492  0.904508
-       0.111698  0.111698  0.917814
-       0.794092  0.232582 -0.561510
-      -0.577349 -0.577349 -0.577349
-      -0.847285 -0.847285  0.001343
-      -0.618854  0.560717 -0.550066
-       0.232582  0.232582  0.794092
-      -0.626942 -0.259682 -0.734489
-      -0.531083 -0.847285  0.001343
-      -0.157903 -0.040376 -0.986602
-       0.817255  0.817255 -0.407361
-       0.100955  0.100955 -0.344737
-       0.110752  0.110752 -0.932371
-       0.910855  0.910855 -0.412671
-       0.098331  0.098331  0.390912
-      -0.789087 -0.239082  0.565813
-       0.236427 -0.942473 -0.236152
-      -0.300729 -0.300729 -0.904752
-      -0.475936  0.812494 -0.336528
-      -0.561510  0.232582 -0.794092
+       0.232582  0.232582 -0.794092
        0.812494  0.812494 -0.475936
-       0.904508 -0.301492 -0.301492
-       0.000000  0.707083  0.707083
-      -0.707083 -0.707083  0.707083
        0.265297  0.265297 -0.626392
-      -0.888150 -0.294839  0.352428
-       0.414686 -0.909940  0.001099
-       0.157903  0.040376  0.986602
-       0.232582  0.232582  0.794092
       -0.239082 -0.239082  0.565813
-       0.040376  0.040376  0.986602
-       0.000000  0.910855  0.412671
-       0.817255  0.817255  0.407636
-      -0.626118 -0.546068  0.556536
-       0.817255  0.817255 -0.407361
-      -0.707083 -0.707083 -0.707083
-      -0.847285 -0.847285  0.001343
-       0.232582  0.232582 -0.561510
-       0.301492 -0.301492  0.904508
-       0.262154  0.262154  0.628559
-      -0.301492 -0.301492 -0.301492
-      -0.554674  0.000000 -0.832026
-      -0.382153 -0.382153  0.841060
-      -0.792962 -0.234046 -0.562487
-       0.707083  0.000000 -0.707083
-       0.475936  0.812494  0.336528
+      -0.316324  0.633534  0.706076
+       0.577349 -0.577349  0.577349
+       0.812494  0.812494  0.475936
+      -0.561510  0.232582  0.794092
+       0.789087 -0.239082  0.565813
+       0.904508 -0.301492 -0.301492
+      -0.909940 -0.909940  0.001099
+       0.475936  0.812494 -0.336528
+       0.707083  0.707083 -0.707083
       -0.577349 -0.577349  0.577349
+       0.098331  0.098331  0.390912
+       0.561022 -0.332469 -0.758049
+       0.633534  0.633534  0.706076
+      -0.253121 -0.253121 -0.628010
+      -0.234046 -0.234046 -0.562487
+       0.414686 -0.909940  0.001099
       -0.300729 -0.300729 -0.904752
-       0.792962 -0.234046 -0.562487
-      -0.294839 -0.294839  0.352428
-       0.577349  0.577349 -0.577349
-      -0.344035  0.110752 -0.932371
-      -0.540635 -0.539781  0.645222
-       0.475936  0.812494 -0.336528
-       0.933226  0.100955 -0.344737
-       0.633534  0.633534  0.706076
-       0.232582  0.232582  0.794092
-      -0.942625 -0.942625  0.236213
-       0.000000  0.707083 -0.707083
-       0.232582  0.232582 -0.561510
+      -0.094302 -0.094302  0.934049
+       0.100955  0.100955 -0.344737
+      -0.539781 -0.539781  0.645222
+       0.000000 -0.707083 -0.707083
       -0.477645 -0.807886  0.345103
-       0.100955  0.100955 -0.344737
-      -0.618854  0.560717  0.550066
-      -0.301492 -0.301492  0.904508
-      -0.040376 -0.040376 -0.986602
+      -0.794092  0.232582 -0.561510
+      -0.301492 -0.301492  0.301492
+       0.944700 -0.327891  0.001282
+       0.157903  0.040376 -0.986602
+      -0.336528  0.812494 -0.475936
       -0.301492 -0.301492 -0.301492
-       0.344401 -0.094302  0.934049
-      -0.539781 -0.539781  0.645222
+      -0.234046 -0.234046 -0.562487
        0.561022 -0.332469  0.758080
-       0.475936  0.812494  0.336528
-       0.407300  0.817255  0.407636
-       0.794092  0.232582 -0.561510
-       0.236427 -0.942473 -0.236152
-      -0.344462 -0.091891 -0.934263
+      -0.332469 -0.332469 -0.758049
+      -0.809534 -0.809534 -0.342082
+       0.817255  0.817255  0.407636
+      -0.301584 -0.300729 -0.904752
+       0.789087 -0.239082  0.565813
+       0.157903  0.040376 -0.986602
+       0.301584 -0.300729 -0.904752
        0.812494  0.812494  0.475936
-       0.000000  0.000000 -0.707083
-       0.477645 -0.807886  0.345103
-       0.735862 -0.253121  0.628010
-      -0.618854  0.560717 -0.550066
-       0.577349 -0.577349  0.577349
-       0.232582  0.232582  0.794092
-       0.232582  0.232582  0.794092
-       0.000000 -0.707083 -0.707083
-       0.561510  0.232582 -0.794092
-      -0.091891 -0.091891 -0.934263
-       0.561510  0.232582 -0.794092
-      -0.316324  0.633534  0.706076
+      -0.942625 -0.942625  0.236213
+       0.910855  0.910855  0.412671
+       0.560717  0.560717 -0.550066
        0.812494  0.812494 -0.475936
-      -0.294839 -0.294839  0.352428
+       0.110691  0.110691  0.932066
+       0.110752  0.110752 -0.932371
+       0.040376  0.040376  0.986602
+       0.933226  0.100955  0.344737
+       0.812494  0.812494 -0.336528
+      -0.301492 -0.301492 -0.301492
        0.232582  0.232582 -0.794092
-       0.794092  0.232582  0.561510
-      -0.807886 -0.807886  0.345103
-      -0.332469 -0.332469  0.758080
-       0.910855  0.910855  0.412671
-       0.000000  0.707083 -0.707083
+      -0.475936  0.812494 -0.336528
+       0.910855  0.910855  0.000000
+       0.232582  0.232582  0.794092
        0.000000  0.707083  0.707083
-       0.344920  0.110691  0.932066
-       0.626942 -0.259682 -0.734489
-      -0.561510  0.232582 -0.794092
-       0.888150 -0.294839  0.352428
-       0.794092  0.232582 -0.561510
-      -0.577349  0.577349 -0.577349
-       0.382794 -0.382153  0.841060
-       0.344462 -0.091891 -0.934263
-      -0.707083 -0.707083 -0.707083
-       0.336528  0.812494  0.475936
+       0.707083  0.707083 -0.707083
+      -0.888150 -0.294839  0.352428
+      -0.380932  0.111698 -0.917814
       -0.301492 -0.301492  0.301492
-       0.098331  0.098331  0.390912
-       0.262154  0.262154  0.628559
-       0.904508 -0.301492  0.301492
-      -0.380932  0.111698  0.917814
-       0.232582  0.232582 -0.561510
-      -0.942473 -0.942473 -0.236152
-      -0.380596 -0.089145  0.920408
-      -0.040376 -0.040376 -0.986602
-      -0.626118 -0.546068 -0.556536
-      -0.728263  0.685263  0.000000
-       0.344462 -0.091891 -0.934263
-      -0.561510  0.232582  0.794092
-      -0.094302 -0.094302  0.934049
+       0.707083  0.707083  0.707083
        0.336528  0.812494  0.475936
-      -0.942625 -0.942625  0.236213
-      -0.933226  0.100955  0.344737
-      -0.157903 -0.040376 -0.986602
-      -0.332469 -0.332469  0.758080
-       0.000000 -0.707083  0.707083
-       0.707083  0.707083 -0.707083
-       0.336528  0.812494 -0.475936
-       0.110752  0.110752 -0.932371
+      -0.577349 -0.577349 -0.577349
+       0.475936  0.812494 -0.336528
+      -0.382153 -0.382153  0.841060
+      -0.577349 -0.577349 -0.577349
+      -0.789087 -0.239082  0.565813
       -0.577349 -0.577349  0.577349
+       0.735862 -0.253121  0.628010
+      -0.577349  0.577349 -0.577349
+       0.232582  0.232582 -0.794092
+       0.735862 -0.253121 -0.628010
+      -0.528184  0.849117  0.000000
+      -0.239082 -0.239082  0.565813
+      -0.089145 -0.089145  0.920408
+      -0.561022  0.332469  0.758049
+       0.561510  0.232582 -0.794092
+      -0.577349 -0.577349 -0.577349
+       0.789087 -0.239082  0.565813
+      -0.789087 -0.239082  0.565813
+       0.904508 -0.301492 -0.301492
+      -0.847285 -0.847285  0.001343
       -0.561510  0.232582 -0.794092
-       0.561510  0.232582  0.794092
-      -0.086734 -0.086734 -0.920225
-      -0.157903 -0.040376  0.986602
-       0.477035 -0.809534 -0.342082
-      -0.475936  0.812494 -0.336528
-       0.904508 -0.301492  0.301492
-       0.904508 -0.301492 -0.301492
+       0.000000  0.707083 -0.707083
+      -0.904508 -0.301492  0.301492
+      -0.577349 -0.577349  0.577349
+      -0.915128  0.098331  0.390912
+      -0.414686 -0.909940  0.001099
+       0.111698  0.111698 -0.917814
+      -0.685263 -0.685263  0.000000
+       0.100955  0.100955 -0.344737
+       0.000000  0.333323 -0.942808
+      -0.561510  0.232582  0.794092
+       0.812494  0.812494 -0.336528
+       0.707083  0.707083  0.707083
+      -0.301492 -0.301492  0.904508
+       0.812494  0.812494  0.336528
+      -0.157903 -0.040376 -0.986602
+      -0.332469 -0.332469 -0.758049
+       0.232582  0.232582 -0.561510
       -0.707083 -0.707083  0.707083
-      -0.539781 -0.539781  0.645222
-      -0.336528  0.812494 -0.475936
-      -0.336528  0.812494 -0.475936
+      -0.933226  0.100955  0.344737
+      -0.809534 -0.809534 -0.342082
+      -0.344035  0.110752 -0.932371
+       0.817255  0.817255  0.407636
+       0.888150 -0.294839  0.352428
+      -0.618854  0.560717  0.550066
+      -0.259682 -0.259682 -0.734489
+      -0.407605  0.817255 -0.407361
+       0.235786 -0.942625  0.236213
+       0.100955  0.100955 -0.344737
+      -0.301492 -0.301492  0.904508
+      -0.577349  0.577349  0.577349
+       0.812494  0.812494 -0.336528
+       0.407605  0.817255 -0.407361
+      -0.546068 -0.546068 -0.556536
+       0.707083  0.707083 -0.707083
+      -0.380596 -0.089145  0.920408
        0.157903  0.040376  0.986602
-       0.232582  0.232582  0.561510
-      -0.794092  0.232582  0.561510
-       0.235786 -0.942625  0.236213
-      -0.412671  0.910855  0.000000
        0.000000  0.000000 -0.707083
-       0.732963  0.265297 -0.626392
+       0.232582  0.232582  0.794092
+      -0.577349 -0.577349 -0.577349
+       0.477645 -0.807886  0.345103
+       0.812494  0.812494 -0.336528
+       0.111698  0.111698  0.917814
+       0.232582  0.232582 -0.561510
        0.232582  0.232582  0.561510
-       0.817255  0.817255  0.407636
-       0.547380  0.547380  0.633656
-      -0.792962 -0.234046 -0.562487
-       0.577349  0.577349  0.577349
-      -0.626118 -0.546068 -0.556536
-      -0.942473 -0.942473 -0.236152
-       0.000000  0.000000 -0.832026
-       0.707083  0.000000 -0.707083
-      -0.253121 -0.253121 -0.628010
-      -0.904508 -0.301492  0.301492
+       0.812494  0.812494  0.475936
        0.477035 -0.809534 -0.342082
-       0.414686 -0.909940  0.001099
-       0.812494  0.812494  0.336528
+      -0.040376 -0.040376 -0.986602
+       0.232582  0.232582  0.561510
+      -0.301492 -0.301492  0.904508
       -0.577349 -0.577349 -0.577349
+      -0.327891 -0.327891  0.001282
+      -0.344462 -0.091891 -0.934263
+      -0.554674  0.000000 -0.832026
+       0.933226  0.100955 -0.344737
+       0.232582  0.232582  0.561510
+       0.707083  0.707083  0.707083
+       0.812494  0.812494  0.475936
+       0.040376  0.040376  0.986602
+      -0.259682 -0.259682 -0.734489
+       0.110752  0.110752 -0.932371
+      -0.728263  0.685263  0.000000
+      -0.847285 -0.847285  0.001343
+      -0.561510  0.232582 -0.794092
+      -0.794092  0.232582 -0.561510
+       0.407300  0.817255  0.407636
       -0.577349 -0.577349  0.577349
-       0.407300  0.817255  0.407636
+      -0.157903 -0.040376 -0.986602
+       0.000000  0.707083 -0.707083
+      -0.380932  0.111698 -0.917814
+      -0.933226  0.100955 -0.344737
+       0.111698  0.111698 -0.917814
+      -0.300729 -0.300729 -0.904752
+      -0.475936  0.812494 -0.336528
+       0.000000  0.707083  0.707083
+      -0.577349 -0.577349  0.577349
+       0.707083  0.707083 -0.707083
+       0.333323  0.333323  0.000000
+      -0.807886 -0.807886  0.345103
+      -0.577349 -0.577349 -0.577349
+       0.817255  0.817255 -0.407361
+      -0.942473 -0.942473 -0.236152
        0.100955  0.100955  0.344737
+      -0.561510  0.232582  0.794092
+      -0.234046 -0.234046 -0.562487
+       0.707083  0.707083  0.707083
+      -0.807886 -0.807886  0.345103
       -0.235786 -0.942625  0.236213
-      -0.528184  0.849117  0.000000
-       0.577349 -0.577349 -0.577349
-       0.707083  0.707083 -0.707083
-       0.910855  0.910855  0.000000
-      -0.301584 -0.300729 -0.904752
-      -0.040376 -0.040376  0.986602
       -0.577349 -0.577349 -0.577349
-      -0.807886 -0.807886  0.345103
-       0.000000  0.333323 -0.942808
-       0.577349 -0.577349 -0.577349
-      -0.685263 -0.685263  0.000000
-      -0.794092  0.232582 -0.561510
-       0.732200  0.262154  0.628559
-       0.933226  0.100955  0.344737
+       0.344035  0.110752 -0.932371
+       0.262154  0.262154  0.628559
+      -0.086734 -0.086734 -0.920225
+       0.157903  0.040376  0.986602
+      -0.909940 -0.909940  0.001099
+       0.344462 -0.091891 -0.934263
+      -0.904508 -0.301492 -0.301492
       -0.942625 -0.942625  0.236213
-      -0.477035 -0.809534 -0.342082
+       0.100955  0.100955 -0.344737
+       0.344401 -0.094302  0.934049
+       0.344401 -0.094302  0.934049
+      -0.091891 -0.091891 -0.934263
+       0.707083  0.707083 -0.707083
+      -0.301492 -0.301492 -0.301492
+       0.546648  0.547380  0.633656
+       0.847224  0.847224  0.531205
+       0.794092  0.232582 -0.561510
+       0.000000  0.910855  0.412671
       -0.475936  0.812494  0.336528
-       0.561022 -0.332469 -0.758049
-      -0.301492 -0.301492  0.904508
-       0.812494  0.812494 -0.336528
-       0.344401 -0.094302  0.934049
-      -0.577349 -0.577349 -0.577349
-       0.561022 -0.332469  0.758080
-       0.792962 -0.234046 -0.562487
-       0.577349 -0.577349  0.577349
-      -0.253121 -0.253121  0.628010
-      -0.626118 -0.546068  0.556536
-       0.100955  0.100955  0.344737
+      -0.086734 -0.086734 -0.920225
+       0.477645 -0.807886  0.345103
+      -0.792962 -0.234046 -0.562487
+      -0.157903 -0.040376  0.986602
+       0.477035 -0.809534 -0.342082
+      -0.040376 -0.040376 -0.986602
+       0.000000  0.707083  0.707083
+      -0.707083 -0.707083 -0.707083
+      -0.577349 -0.577349  0.577349
+       0.477645 -0.807886  0.345103
+       0.812494  0.812494 -0.475936
+      -0.554674  0.000000 -0.832026
+       0.262154  0.262154  0.628559
+      -0.380596 -0.089145  0.920408
+       0.707083  0.707083  0.707083
+       0.849117  0.849117  0.000000
+      -0.380932  0.111698  0.917814
        0.000000  0.707083 -0.707083
-      -0.915128  0.098331  0.390912
-       0.040376  0.040376 -0.986602
+      -0.577349 -0.577349  0.577349
       -0.904508 -0.301492  0.301492
-       0.477645 -0.807886  0.345103
-       0.812494  0.812494 -0.336528
-       0.111698  0.111698  0.917814
+       0.561022 -0.332469 -0.758049
+       0.560717  0.560717  0.550066
+      -0.300729 -0.300729 -0.904752
        0.332469  0.332469 -0.758080
-       0.000000  0.707083 -0.707083
-       0.040376  0.040376  0.986602
-      -0.094302 -0.094302  0.934049
-       0.000000  0.910855 -0.412671
-      -0.942625 -0.942625  0.236213
-       0.910855  0.910855  0.000000
-       0.817255  0.817255 -0.407361
-      -0.904508 -0.301492 -0.301492
-       0.000000 -0.707083 -0.707083
-      -0.794092  0.232582 -0.561510
-      -0.336528  0.812494  0.475936
-      -0.561022  0.332469 -0.758080
-       0.944700 -0.327891  0.001282
-       0.332469  0.332469  0.758049
-       0.812494  0.812494  0.336528
-       0.910855  0.910855 -0.412671
-      -0.381603 -0.086734 -0.920225
-       0.098331  0.098331  0.390912
+      -0.577349 -0.577349  0.577349
+       0.110691  0.110691  0.932066
+      -0.909940 -0.909940  0.001099
       -0.577349 -0.577349 -0.577349
+       0.849117  0.849117  0.000000
+      -0.942473 -0.942473 -0.236152
+       0.794092  0.232582  0.561510
+      -0.380596 -0.089145  0.920408
+      -0.728263 -0.685263  0.000000
+       0.000000 -0.707083  0.707083
+       0.336528  0.812494 -0.475936
+       0.232582  0.232582 -0.561510
+       0.685263  0.685263  0.000000
+       0.577349  0.577349  0.577349
+      -0.809534 -0.809534 -0.342082
+       0.789087 -0.239082  0.565813
      ) ;; normals
 
     (texcoords
       1.000000 1.000000
+      0.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
       0.000000 0.000000
-      1.000000 1.000000
-      1.000000 0.000000
-      1.000000 1.000000
-      0.000000 0.000000
       0.000000 1.000000
-      1.000000 0.000000
       0.000000 1.000000
       0.000000 0.000000
+      0.000000 0.000000
       1.000000 1.000000
-      1.000000 1.000000
       0.000000 1.000000
-      0.000000 0.000000
+      0.000000 1.000000
       1.000000 0.000000
+      1.000000 1.000000
+      1.000000 1.000000
       1.000000 0.000000
-      1.000000 0.000000
-      1.000000 0.000000
-      0.000000 1.000000
+      0.000000 0.000000
       1.000000 1.000000
       0.000000 0.000000
+      1.000000 1.000000
       0.000000 1.000000
+      0.000000 0.000000
       1.000000 1.000000
-      1.000000 1.000000
       1.000000 0.000000
       1.000000 1.000000
-      0.000000 0.000000
       1.000000 1.000000
+      1.000000 0.000000
       1.000000 1.000000
-      0.000000 1.000000
-      1.000000 1.000000
-      0.000000 0.000000
       1.000000 0.000000
+      1.000000 0.000000
       0.000000 1.000000
       0.000000 0.000000
       0.000000 0.000000
-      0.000000 1.000000
+      1.000000 0.000000
       1.000000 1.000000
       1.000000 1.000000
-      0.000000 1.000000
-      0.000000 1.000000
       0.000000 0.000000
-      0.000000 1.000000
+      1.000000 0.000000
+      1.000000 1.000000
       0.000000 0.000000
-      0.000000 0.000000
       1.000000 1.000000
       0.000000 0.000000
+      0.000000 0.000000
       0.000000 1.000000
       1.000000 0.000000
+      1.000000 1.000000
       1.000000 0.000000
-      1.000000 1.000000
-      1.000000 1.000000
       0.000000 0.000000
+      0.000000 1.000000
       0.000000 0.000000
-      0.000000 0.000000
       0.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
+      1.000000 1.000000
+      1.000000 0.000000
       0.000000 0.000000
       0.000000 0.000000
+      1.000000 1.000000
       0.000000 1.000000
       1.000000 1.000000
-      0.000000 1.000000
       1.000000 0.000000
+      0.000000 0.000000
       1.000000 1.000000
+      1.000000 0.000000
       1.000000 1.000000
+      0.000000 0.000000
       1.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
-      1.000000 1.000000
+      0.000000 0.000000
       1.000000 0.000000
-      0.000000 0.000000
       1.000000 1.000000
-      1.000000 1.000000
-      0.000000 0.000000
       0.000000 1.000000
-      0.000000 0.000000
       0.000000 1.000000
-      0.000000 0.000000
-      0.000000 0.000000
-      0.000000 0.000000
-      0.000000 1.000000
-      0.000000 0.000000
-      0.000000 1.000000
       1.000000 0.000000
+      1.000000 0.000000
       1.000000 1.000000
-      0.000000 1.000000
-      0.000000 0.000000
       1.000000 0.000000
       0.000000 0.000000
-      1.000000 1.000000
       0.000000 0.000000
-      0.000000 1.000000
-      1.000000 1.000000
       1.000000 0.000000
       1.000000 1.000000
       1.000000 0.000000
-      0.000000 0.000000
-      1.000000 1.000000
       1.000000 0.000000
       0.000000 0.000000
+      0.000000 0.000000
       1.000000 0.000000
       0.000000 0.000000
       1.000000 1.000000
-      0.000000 0.000000
       1.000000 1.000000
+      1.000000 0.000000
       1.000000 1.000000
+      1.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
-      1.000000 0.000000
       0.000000 0.000000
+      0.000000 1.000000
       1.000000 1.000000
       1.000000 1.000000
+      0.000000 0.000000
       1.000000 0.000000
-      0.000000 0.000000
-      1.000000 1.000000
-      1.000000 1.000000
       0.000000 1.000000
       1.000000 0.000000
-      1.000000 1.000000
-      1.000000 0.000000
       0.000000 0.000000
-      0.000000 1.000000
       0.000000 0.000000
       0.000000 0.000000
+      1.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
-      0.000000 1.000000
       1.000000 0.000000
-      1.000000 0.000000
       1.000000 1.000000
-      0.000000 1.000000
-      0.000000 0.000000
       1.000000 1.000000
-      0.000000 1.000000
       1.000000 1.000000
       1.000000 0.000000
-      1.000000 1.000000
       0.000000 0.000000
       0.000000 1.000000
+      0.000000 0.000000
       1.000000 0.000000
+      0.000000 1.000000
       0.000000 0.000000
+      1.000000 1.000000
+      0.000000 0.000000
+      0.000000 0.000000
       1.000000 0.000000
       1.000000 0.000000
+      0.000000 0.000000
+      1.000000 1.000000
       1.000000 0.000000
+      0.000000 1.000000
       1.000000 1.000000
-      0.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
+      1.000000 1.000000
+      1.000000 0.000000
       0.000000 1.000000
       0.000000 0.000000
-      0.000000 0.000000
       1.000000 1.000000
       1.000000 1.000000
+      0.000000 0.000000
       1.000000 0.000000
       1.000000 1.000000
+      1.000000 1.000000
+      0.000000 0.000000
+      1.000000 1.000000
       1.000000 0.000000
+      0.000000 0.000000
       1.000000 1.000000
+      0.000000 0.000000
       1.000000 0.000000
       0.000000 0.000000
+      1.000000 0.000000
       0.000000 1.000000
-      0.000000 0.000000
       0.000000 1.000000
-      1.000000 0.000000
+      0.000000 1.000000
       1.000000 1.000000
-      1.000000 0.000000
       1.000000 1.000000
       1.000000 1.000000
       1.000000 1.000000
       1.000000 1.000000
-      1.000000 0.000000
       1.000000 1.000000
       1.000000 1.000000
       0.000000 0.000000
@@ -1331,699 +1425,761 @@
       1.000000 1.000000
       1.000000 1.000000
       1.000000 1.000000
+      1.000000 0.000000
+      1.000000 1.000000
       0.000000 1.000000
+      0.000000 1.000000
       1.000000 1.000000
-      0.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
       1.000000 0.000000
-      0.000000 1.000000
       1.000000 1.000000
-      1.000000 1.000000
       1.000000 0.000000
-      0.000000 1.000000
       1.000000 0.000000
-      0.000000 1.000000
       0.000000 0.000000
+      1.000000 1.000000
       0.000000 0.000000
+      0.000000 0.000000
+      1.000000 1.000000
       1.000000 0.000000
+      0.000000 0.000000
       1.000000 1.000000
+      0.000000 0.000000
+      1.000000 1.000000
+      1.000000 1.000000
+      1.000000 1.000000
+      0.000000 0.000000
+      1.000000 1.000000
+      1.000000 0.000000
       0.000000 1.000000
-      0.000000 1.000000
       1.000000 1.000000
-      0.000000 1.000000
+      0.000000 0.000000
       1.000000 0.000000
       1.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
       0.000000 0.000000
-      1.000000 0.000000
       1.000000 1.000000
+      1.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
-      1.000000 0.000000
+      1.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
+      0.000000 0.000000
       0.000000 1.000000
-      1.000000 0.000000
       0.000000 0.000000
       0.000000 1.000000
-      1.000000 0.000000
-      1.000000 0.000000
-      0.000000 0.000000
+      0.000000 1.000000
       1.000000 1.000000
       1.000000 1.000000
+      0.000000 1.000000
       1.000000 0.000000
-      0.000000 0.000000
       0.000000 1.000000
+      1.000000 0.000000
       1.000000 1.000000
-      0.000000 1.000000
       1.000000 0.000000
-      0.000000 0.000000
-      0.000000 0.000000
       1.000000 0.000000
+      1.000000 1.000000
       0.000000 0.000000
-      1.000000 1.000000
       0.000000 1.000000
-      1.000000 0.000000
       0.000000 0.000000
       1.000000 1.000000
-      1.000000 1.000000
       0.000000 1.000000
-      0.000000 0.000000
-      0.000000 0.000000
-      1.000000 0.000000
       1.000000 1.000000
       1.000000 1.000000
       1.000000 1.000000
-      1.000000 0.000000
-      0.000000 0.000000
-      1.000000 1.000000
       0.000000 1.000000
       1.000000 0.000000
-      0.000000 0.000000
-      1.000000 0.000000
       1.000000 1.000000
-      1.000000 0.000000
       1.000000 1.000000
       1.000000 1.000000
       1.000000 1.000000
+      1.000000 1.000000
       1.000000 0.000000
       1.000000 1.000000
       1.000000 1.000000
+      1.000000 1.000000
+      0.000000 1.000000
+      0.000000 1.000000
       0.000000 0.000000
+      0.000000 0.000000
+      0.000000 0.000000
       0.000000 1.000000
-      0.000000 0.000000
       1.000000 0.000000
       1.000000 1.000000
-      1.000000 1.000000
-      0.000000 1.000000
       0.000000 0.000000
-      1.000000 1.000000
-      1.000000 1.000000
-      1.000000 1.000000
-      0.000000 1.000000
       0.000000 0.000000
-      1.000000 1.000000
-      0.000000 0.000000
       0.000000 1.000000
-      0.000000 0.000000
       1.000000 0.000000
-      0.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
-      1.000000 0.000000
-      1.000000 0.000000
       1.000000 1.000000
       0.000000 0.000000
       0.000000 0.000000
+      1.000000 0.000000
+      0.000000 0.000000
       1.000000 1.000000
-      1.000000 1.000000
       0.000000 0.000000
+      1.000000 0.000000
       0.000000 0.000000
       1.000000 0.000000
+      1.000000 0.000000
+      0.000000 0.000000
       0.000000 1.000000
       1.000000 1.000000
+      0.000000 0.000000
       1.000000 1.000000
-      1.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
+      0.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
+      1.000000 0.000000
+      0.000000 1.000000
       0.000000 0.000000
+      0.000000 1.000000
       0.000000 0.000000
-      0.000000 0.000000
-      0.000000 0.000000
       0.000000 1.000000
-      1.000000 0.000000
       0.000000 1.000000
+      1.000000 1.000000
+      0.000000 1.000000
       0.000000 0.000000
       0.000000 0.000000
       1.000000 1.000000
       1.000000 0.000000
+      0.000000 0.000000
       1.000000 0.000000
+      0.000000 0.000000
+      0.000000 0.000000
       1.000000 1.000000
       1.000000 0.000000
       1.000000 1.000000
-      1.000000 1.000000
-      1.000000 1.000000
-      1.000000 1.000000
-      0.000000 0.000000
-      0.000000 1.000000
       1.000000 0.000000
       0.000000 1.000000
       1.000000 1.000000
       1.000000 1.000000
+      1.000000 1.000000
       0.000000 1.000000
       1.000000 1.000000
-      0.000000 0.000000
       1.000000 1.000000
       1.000000 0.000000
       1.000000 1.000000
-      0.000000 0.000000
       1.000000 0.000000
-      0.000000 0.000000
-      0.000000 1.000000
-      1.000000 1.000000
       1.000000 0.000000
       0.000000 0.000000
       1.000000 1.000000
       1.000000 1.000000
-      0.000000 1.000000
       1.000000 1.000000
-      1.000000 0.000000
-      0.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
       0.000000 1.000000
+      1.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
-      0.000000 1.000000
-      0.000000 1.000000
       1.000000 0.000000
       1.000000 1.000000
       0.000000 0.000000
+      0.000000 1.000000
       0.000000 0.000000
+      1.000000 1.000000
+      0.000000 1.000000
       0.000000 0.000000
       0.000000 1.000000
-      1.000000 1.000000
       0.000000 0.000000
-      0.000000 1.000000
       1.000000 1.000000
       0.000000 1.000000
-      0.000000 0.000000
       1.000000 0.000000
       1.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
+      1.000000 0.000000
       1.000000 1.000000
+      0.000000 0.000000
       0.000000 1.000000
       0.000000 1.000000
       1.000000 1.000000
-      1.000000 0.000000
       0.000000 0.000000
-      1.000000 0.000000
       1.000000 1.000000
-      0.000000 1.000000
       1.000000 1.000000
-      1.000000 0.000000
       1.000000 1.000000
+      1.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
+      1.000000 1.000000
+      1.000000 0.000000
       0.000000 0.000000
       1.000000 0.000000
       1.000000 1.000000
-      1.000000 1.000000
       0.000000 1.000000
-      0.000000 0.000000
+      0.000000 1.000000
       1.000000 0.000000
       1.000000 1.000000
+      0.000000 0.000000
       1.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
+      1.000000 0.000000
+      0.000000 0.000000
       0.000000 1.000000
+      0.000000 1.000000
       0.000000 0.000000
-      0.000000 0.000000
       1.000000 1.000000
-      0.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
       0.000000 0.000000
       1.000000 1.000000
+      1.000000 1.000000
       1.000000 0.000000
+      0.000000 0.000000
+      0.000000 1.000000
+      1.000000 0.000000
+      0.000000 1.000000
       1.000000 1.000000
+      1.000000 0.000000
+      0.000000 0.000000
       1.000000 1.000000
+      0.000000 1.000000
       1.000000 1.000000
       1.000000 1.000000
-      1.000000 0.000000
+      1.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
       0.000000 0.000000
       1.000000 0.000000
+      0.000000 0.000000
       1.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
+      0.000000 1.000000
+      1.000000 0.000000
       0.000000 0.000000
-      0.000000 0.000000
       1.000000 1.000000
       1.000000 1.000000
-      0.000000 1.000000
+      1.000000 0.000000
+      1.000000 0.000000
+      1.000000 1.000000
+      1.000000 0.000000
       0.000000 0.000000
-      0.000000 1.000000
+      1.000000 0.000000
+      0.000000 0.000000
       1.000000 1.000000
       1.000000 1.000000
       0.000000 1.000000
+      0.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
       0.000000 1.000000
+      0.000000 1.000000
+      0.000000 1.000000
       1.000000 1.000000
       1.000000 0.000000
-      1.000000 1.000000
+      1.000000 0.000000
       0.000000 0.000000
       0.000000 0.000000
       0.000000 0.000000
       1.000000 1.000000
+      0.000000 0.000000
+      1.000000 1.000000
+      0.000000 0.000000
       0.000000 1.000000
       1.000000 1.000000
-      1.000000 0.000000
-      1.000000 0.000000
+      0.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
+      1.000000 0.000000
       1.000000 1.000000
       1.000000 1.000000
-      1.000000 0.000000
+      1.000000 1.000000
+      1.000000 1.000000
+      0.000000 0.000000
       0.000000 1.000000
+      0.000000 0.000000
       1.000000 1.000000
-      1.000000 0.000000
       1.000000 1.000000
       0.000000 0.000000
+      1.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
+      0.000000 0.000000
       0.000000 1.000000
+      1.000000 0.000000
+      0.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
-      1.000000 0.000000
       0.000000 0.000000
-      0.000000 0.000000
+      0.000000 1.000000
       1.000000 1.000000
-      1.000000 1.000000
       1.000000 0.000000
-      1.000000 0.000000
       1.000000 1.000000
       1.000000 1.000000
       1.000000 0.000000
-      1.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
-      0.000000 0.000000
+      1.000000 0.000000
       1.000000 1.000000
+      0.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
       0.000000 0.000000
+      0.000000 1.000000
       1.000000 1.000000
+      1.000000 1.000000
       0.000000 1.000000
-      1.000000 0.000000
       1.000000 1.000000
-      1.000000 0.000000
       1.000000 1.000000
-      0.000000 0.000000
       1.000000 1.000000
       0.000000 1.000000
       1.000000 0.000000
-      0.000000 1.000000
+      1.000000 1.000000
+      1.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
       0.000000 0.000000
       0.000000 1.000000
+      0.000000 1.000000
+      0.000000 0.000000
       1.000000 0.000000
+      1.000000 0.000000
+      1.000000 1.000000
+      0.000000 1.000000
+      0.000000 1.000000
+      1.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
+      0.000000 1.000000
       0.000000 0.000000
       0.000000 1.000000
-      1.000000 0.000000
       1.000000 1.000000
-      0.000000 1.000000
       1.000000 1.000000
       1.000000 0.000000
       1.000000 1.000000
-      1.000000 1.000000
       0.000000 0.000000
+      1.000000 0.000000
       0.000000 0.000000
+      0.000000 1.000000
+      0.000000 0.000000
+      1.000000 0.000000
+      0.000000 0.000000
+      1.000000 0.000000
       1.000000 1.000000
+      0.000000 1.000000
       1.000000 1.000000
-      1.000000 0.000000
+      1.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
       0.000000 1.000000
       1.000000 0.000000
       0.000000 0.000000
+      0.000000 1.000000
       0.000000 0.000000
+      0.000000 1.000000
       1.000000 1.000000
       1.000000 0.000000
+      0.000000 1.000000
       1.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
       1.000000 1.000000
+      0.000000 0.000000
+      1.000000 0.000000
       1.000000 1.000000
       1.000000 1.000000
+      0.000000 1.000000
+      0.000000 1.000000
+      0.000000 0.000000
       1.000000 1.000000
       0.000000 1.000000
       0.000000 0.000000
+      0.000000 0.000000
       1.000000 1.000000
-      1.000000 0.000000
-      1.000000 0.000000
+      1.000000 1.000000
       0.000000 0.000000
-      0.000000 1.000000
+      1.000000 1.000000
       1.000000 0.000000
       0.000000 0.000000
       0.000000 0.000000
+      1.000000 0.000000
       0.000000 0.000000
+      0.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
+      1.000000 0.000000
       0.000000 0.000000
-      1.000000 1.000000
       0.000000 1.000000
       0.000000 0.000000
       1.000000 0.000000
       1.000000 1.000000
       0.000000 1.000000
+      0.000000 1.000000
       1.000000 1.000000
+      0.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
-      0.000000 1.000000
-      1.000000 0.000000
-      1.000000 1.000000
-      1.000000 1.000000
       0.000000 0.000000
-      1.000000 0.000000
       1.000000 1.000000
       0.000000 0.000000
       0.000000 0.000000
-      1.000000 1.000000
+      0.000000 1.000000
       0.000000 0.000000
-      1.000000 1.000000
       0.000000 0.000000
+      0.000000 0.000000
       1.000000 0.000000
+      0.000000 1.000000
+      0.000000 0.000000
+      1.000000 1.000000
       1.000000 0.000000
+      0.000000 1.000000
       0.000000 0.000000
+      0.000000 1.000000
+      1.000000 1.000000
+      0.000000 1.000000
+      1.000000 1.000000
       1.000000 0.000000
+      1.000000 0.000000
       0.000000 0.000000
       1.000000 1.000000
       1.000000 0.000000
+      0.000000 0.000000
       1.000000 1.000000
+      0.000000 0.000000
+      0.000000 0.000000
       1.000000 1.000000
+      0.000000 1.000000
+      1.000000 1.000000
       0.000000 0.000000
       1.000000 1.000000
+      0.000000 1.000000
+      1.000000 0.000000
       0.000000 0.000000
       0.000000 1.000000
       0.000000 0.000000
+      0.000000 0.000000
       0.000000 1.000000
+      1.000000 0.000000
+      0.000000 0.000000
       1.000000 1.000000
       0.000000 0.000000
+      0.000000 1.000000
       1.000000 1.000000
+      0.000000 1.000000
+      0.000000 0.000000
       1.000000 1.000000
-      0.000000 1.000000
+      0.000000 0.000000
+      0.000000 0.000000
       1.000000 0.000000
       0.000000 0.000000
       1.000000 1.000000
       1.000000 0.000000
       1.000000 0.000000
-      1.000000 1.000000
-      1.000000 1.000000
-      1.000000 1.000000
       0.000000 0.000000
       0.000000 0.000000
+      1.000000 0.000000
+      1.000000 1.000000
       0.000000 0.000000
-      0.000000 1.000000
      ) ;; texcoords
 
     (triangles
-      54 469 405
-      420 256 238
-      98 223 380
-      1 418 26
-      54 558 360
-      420 252 128
-      60 288 506
-      421 13 496
-      80 467 456
-      216 528 425
-      519 558 380
-      80 338 380
-      519 288 261
-      77 469 503
-      60 245 503
-      77 467 556
-      59 49 178
-      149 564 496
-      264 340 456
-      88 528 169
-      232 245 523
-      108 312 307
-      372 93 67
-      56 280 396
-      77 432 119
-      294 222 100
-      60 44 107
-      421 25 391
-      328 38 107
-      408 25 307
-      77 93 330
-      294 206 531
-      232 387 308
-      108 201 482
-      98 245 255
-      1 163 331
-      45 467 308
-      141 363 344
-      339 134 330
-      75 206 344
-      264 338 535
-      88 483 192
-      541 49 549
-      180 401 64
-      519 223 497
-      494 135 366
-      80 340 96
-      216 277 492
-      81 272 96
-      114 277 192
-      519 49 566
-      494 204 246
-      264 131 459
-      88 350 417
-      476 338 30
-      399 532 527
-      59 288 66
-      149 561 448
-      385 510 566
-      105 204 448
-      385 221 566
-      419 270 85
-      341 221 66
-      273 311 109
-      476 407 30
-      15 393 51
-      132 189 459
-      516 145 95
-      519 510 566
-      43 270 186
-      81 122 96
-      281 176 129
-      80 272 96
-      444 176 143
-      519 302 497
-      43 438 120
-      550 491 549
-      458 240 186
-      132 122 535
-      516 137 51
-      339 377 330
-      326 156 508
-      259 377 308
-      225 201 214
-      98 377 255
-      536 199 374
-      384 258 308
-      103 363 461
-      77 134 330
-      509 156 356
-      328 439 107
-      548 500 539
-      60 38 107
-      465 500 309
-      77 127 119
-      509 170 451
-      79 268 67
-      568 345 356
-      384 439 523
-      103 424 374
-      77 329 554
-      60 460 319
-      77 460 405
-      519 230 360
-      80 159 557
-      519 159 233
-      80 349 133
-      444 91 214
-      60 480 218
-      465 305 109
-      90 432 360
-      220 318 274
-      202 223 554
-      243 414 203
-      382 230 395
-      332 40 136
-      202 300 411
-      243 386 211
-      358 159 411
-      125 411 520
-      498 558 239
-      513 4 18
-      534 335 94
-      534 21 370
-      365 31 321
-      124 406 442
-      276 23 94
-      200 21 442
-      228 335 394
-      123 53 198
-      276 23 165
-      200 165 113
-      365 63 229
-      124 229 248
-      534 195 62
-      348 47 164
-      512 570 229
-      427 229 198
-      276 31 452
-      200 430 316
-      228 63 546
-      123 104 19
-      534 23 52
-      534 375 473
-      191 335 371
-      172 106 231
-      11 14 313
-      560 313 140
-      486 553 565
-      237 154 102
-      92 383 334
-      236 334 563
-      347 235 565
-      347 154 563
-      58 57 521
-      299 481 155
-      92 551 462
-      236 357 207
-      271 553 244
-      282 416 279
-      378 342 151
-      490 86 215
-      440 61 398
-      538 398 144
-      158 472 501
-      36 501 118
-      303 412 251
-      533 544 188
-      160 320 251
-      160 544 118
-      190 518 39
-      443 449 34
-      474 412 152
-      552 152 89
-      158 275 295
-      36 241 250
-      22 76 283
-      471 283 511
-      351 194 295
-      351 241 89
-      202 329 265
-      243 184 17
-      530 469 293
-      515 369 559
-      101 300 359
-      493 171 162
-      413 409 289
-      485 116 447
-      226 179 111
-      346 253 545
-      567 300 196
-      226 361 196
-      567 409 380
-      298 361 262
-      150 475 468
-      569 84 422
-      304 99 219
-      567 20 166
-      555 367 287
-      226 362 376
-      346 70 478
-      286 78 376
-      33 70 468
-      567 84 422
-      555 185 489
-      298 263 428
-      150 479 562
-      37 361 262
-      402 130 431
-      455 409 325
-      285 2 16
-      437 177 422
-      121 185 16
-      436 179 537
-      373 537 71
-      397 35 290
-      205 290 540
-      413 187 115
-      485 173 324
-      388 213 69
-      314 525 337
-      83 8 115
-      83 173 71
-      455 84 284
-      285 65 301
-      298 362 284
-      569 35 487
-      304 27 434
-      436 187 390
-      373 450 400
-      397 263 499
-      205 24 260
-      403 415 390
-      48 197 390
-      110 522 291
-      110 517 50
-      269 477 0
-      292 267 142
-      257 343 291
-      457 517 182
-      46 210 29
-      505 29 306
-      147 522 6
-      389 6 507
-      404 139 435
-      212 488 157
-      208 139 429
-      7 74 327
-      543 354 193
-      72 323 379
-      68 368 209
-      524 433 254
-      3 117 435
-      138 488 242
-      322 368 175
-      453 446 278
-      514 315 175
-      470 446 227
-      3 117 336
-      138 466 153
-      297 87 435
-      355 234 242
-      68 368 193
-      524 333 379
-      3 558 174
-      514 230 441
-      3 230 261
-      514 82 12
-      470 266 507
-      257 423 73
-      457 445 327
-      54 41 174
-      420 529 9
-      90 161 126
-      220 484 364
-      358 317 454
-      125 547 238
-      68 504 168
-      68 10 495
-      524 392 306
-      341 480 217
-      273 502 426
-      259 349 181
-      225 410 542
-      384 42 249
-      103 381 97
-      79 352 32
-      568 310 463
-      550 183 167
-      458 464 5
-      132 148 112
-      516 353 224
-      247 146 32
-      28 310 224
-      296 526 249
-      55 381 5
+      281 571 40
+      264 314 310
+      42 218 255
+      387 92 102
+      281 243 439
+      264 496 254
+      370 535 229
+      527 464 33
+      190 413 361
+      103 91 461
+      446 243 255
+      190 376 255
+      446 535 214
+      568 571 97
+      370 1 97
+      568 413 434
+      56 552 526
+      52 182 33
+      198 304 361
+      209 91 261
+      259 1 354
+      420 385 515
+      394 340 156
+      274 592 351
+      568 575 424
+      480 14 417
+      370 329 76
+      527 240 585
+      553 559 76
+      41 240 515
+      568 340 203
+      480 587 134
+      259 595 3
+      420 471 521
+      42 1 427
+      387 197 63
+      565 413 22
+      269 472 400
+      204 495 203
+      459 587 400
+      198 376 486
+      209 548 403
+      294 552 442
+      260 191 151
+      446 218 382
+      295 179 29
+      190 304 523
+      103 208 118
+      506 519 523
+      99 208 403
+      446 552 223
+      295 263 582
+      198 409 187
+      209 302 337
+      7 376 489
+      247 347 418
+      56 535 305
+      52 539 233
+      518 170 223
+      95 263 233
+      618 232 68
+      132 301 363
+      546 232 492
+      544 580 291
+      49 213 296
+      564 160 293
+      611 193 158
+      465 112 380
+      289 72 68
+      184 301 377
+      516 366 194
+      47 372 613
+      438 101 194
+      262 372 192
+      289 6 530
+      184 45 23
+      375 284 25
+      599 445 377
+      611 366 257
+      465 456 293
+      466 228 621
+      622 175 70
+      65 228 258
+      614 430 574
+      246 395 206
+      148 131 114
+      537 116 130
+      335 318 596
+      609 332 621
+      411 175 86
+      108 135 286
+      139 89 222
+      136 410 286
+      569 89 374
+      609 48 275
+      411 157 299
+      583 58 35
+      256 166 86
+      537 135 561
+      335 584 114
+      609 43 66
+      136 556 402
+      609 556 40
+      289 119 319
+      438 327 107
+      289 327 555
+      438 517 331
+      262 510 574
+      136 566 348
+      569 451 291
+      612 73 319
+      272 360 501
+      55 608 66
+      146 573 177
+      36 119 9
+      126 234 75
+      55 428 155
+      146 199 145
+      186 327 111
+      224 111 37
+      359 243 412
+      540 432 140
+      504 96 358
+      504 34 448
+      605 129 373
+      31 476 110
+      576 453 358
+      600 34 110
+      560 96 0
+      589 205 620
+      551 487 53
+      362 53 83
+      605 449 57
+      31 57 196
+      524 547 163
+      391 13 149
+      178 470 57
+      397 57 620
+      576 129 590
+      600 416 431
+      115 509 24
+      69 322 297
+      504 453 440
+      504 511 616
+      85 488 250
+      429 298 353
+      143 493 607
+      180 607 554
+      251 383 141
+      200 468 550
+      207 20 610
+      421 610 357
+      104 378 141
+      104 468 357
+      123 253 161
+      339 188 542
+      207 606 386
+      421 490 249
+      323 383 27
+      367 231 125
+      533 154 290
+      567 407 167
+      211 426 237
+      425 237 44
+      352 153 106
+      586 106 279
+      491 522 215
+      603 344 176
+      288 365 215
+      288 344 279
+      597 341 168
+      549 462 505
+      404 522 525
+      543 525 321
+      352 531 59
+      586 342 405
+      588 280 478
+      94 478 458
+      84 601 59
+      84 342 321
+      55 43 230
+      146 64 545
+      105 571 443
+      562 473 570
+      2 428 278
+      502 529 401
+      8 414 220
+      32 147 498
+      572 356 159
+      162 17 221
+      61 428 497
+      572 5 497
+      61 414 255
+      245 5 393
+      371 51 217
+      277 579 388
+      479 271 485
+      61 503 326
+      120 538 617
+      572 225 185
+      162 558 475
+      593 463 185
+      78 558 217
+      61 579 433
+      120 369 128
+      245 270 109
+      371 137 309
+      483 5 165
+      87 189 183
+      406 414 242
+      330 241 74
+      444 285 433
+      39 369 74
+      349 356 202
+      450 202 28
+      381 276 133
+      117 133 77
+      8 317 313
+      32 138 124
+      423 577 93
+      292 346 455
+      79 216 313
+      79 138 28
+      406 579 408
+      330 236 82
+      245 225 408
+      277 276 336
+      479 71 396
+      349 317 457
+      450 235 12
+      381 270 144
+      117 578 174
+      18 415 457
+      328 152 457
+      21 50 379
+      21 164 54
+      419 591 541
+      226 113 390
+      452 287 379
+      283 164 80
+      67 514 563
+      325 563 528
+      316 50 460
+      150 460 602
+      513 324 312
+      195 422 307
+      320 324 315
+      343 19 46
+      122 447 398
+      441 368 581
+      364 169 392
+      172 469 239
+      4 532 312
+      181 422 484
+      266 437 345
+      16 81 333
+      389 300 345
+      494 81 15
+      4 212 173
+      181 399 90
+      500 30 308
+      252 62 484
+      364 437 520
+      172 454 581
+      4 243 384
+      389 119 435
+      4 119 214
+      389 282 127
+      494 594 602
+      452 10 534
+      283 306 46
+      281 210 384
+      264 201 507
+      612 355 88
+      272 98 26
+      186 557 227
+      224 477 310
+      364 244 303
+      364 248 512
+      172 142 528
+      546 566 508
+      544 334 60
+      65 517 604
+      614 499 219
+      537 467 171
+      335 273 100
+      583 474 350
+      256 615 268
+      375 598 38
+      599 338 267
+      611 481 238
+      465 121 265
+      436 11 350
+      311 615 265
+      619 482 171
+      536 273 267
      ) ;; triangles
 
     (groups



From grumbel at mail.berlios.de  Sat Jun 23 21:09:06 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 23 Jun 2007 21:09:06 +0200
Subject: [Windstille-commit] r1507 - in trunk/windstille/src: . armature
Message-ID: <200706231909.l5NJ96NC025063@sheep.berlios.de>

Author: grumbel
Date: 2007-06-23 21:09:06 +0200 (Sat, 23 Jun 2007)
New Revision: 1507

Modified:
   trunk/windstille/src/armature/armature.hpp
   trunk/windstille/src/armature/mesh.cpp
   trunk/windstille/src/armature/mesh.hpp
   trunk/windstille/src/armature/model.cpp
   trunk/windstille/src/armature/model.hpp
   trunk/windstille/src/armature_test.cpp
Log:
- some buggy bone animation and a few bug fixes

Modified: trunk/windstille/src/armature/armature.hpp
===================================================================
--- trunk/windstille/src/armature/armature.hpp	2007-06-23 16:10:21 UTC (rev 1506)
+++ trunk/windstille/src/armature/armature.hpp	2007-06-23 19:09:06 UTC (rev 1507)
@@ -53,6 +53,9 @@
 
   void  parse(FileReader& reader);
   Bone* get_bone(const std::string& name);
+
+  Matrix* get_render_matrix(const std::string& name);
+
   void  draw();
   void  draw_bone(Bone* bone, Vector3 p, Matrix matrix);
 private:

Modified: trunk/windstille/src/armature/mesh.cpp
===================================================================
--- trunk/windstille/src/armature/mesh.cpp	2007-06-23 16:10:21 UTC (rev 1506)
+++ trunk/windstille/src/armature/mesh.cpp	2007-06-23 19:09:06 UTC (rev 1507)
@@ -30,6 +30,7 @@
 #include "display/opengl_state.hpp"
 #include "display/texture_manager.hpp"
 #include "file_reader.hpp"
+#include "armature.hpp"
 #include "mesh.hpp"
 
 Mesh::Mesh(FileReader& reader, const std::string& path)
@@ -60,11 +61,14 @@
               if ((*i).get("bone",     group.bone_name) &&
                   (*i).get("weight",   group.weight) && 
                   (*i).get("vertices", group.vertices))
-
-                if (group.weight != 0.0f) // ignore useless bones
-                  groups.push_back(group);
+                {
+                  if (group.weight != 0.0f) // ignore useless bones
+                    groups.push_back(group);
+                }
               else
+                {
                 std::cout << "Mesh::VertexGroup: Element missing" << std::endl;
+                }
             }
           else
             {
@@ -112,6 +116,9 @@
   // Normalize Weight to 1.0f
   for(Vertices::iterator i = vertices_.begin(); i != vertices_.end(); ++i)
     {
+      if (i->weights.empty())
+        std::cout << "Vertex doesn't have weight: " << i - vertices_.begin() << std::endl;
+
       float total_weight = 0.0f;
       for(std::vector<float>::iterator w = i->weights.begin(); w != i->weights.end(); ++w)
         total_weight += *w;
@@ -203,10 +210,66 @@
 
   assert_gl("gl init before sprite");
 
+  for(Vertices::size_type i = 0; i < vertices_.size(); ++i)
+    { // evil messing around with vertices, need more order
+      vertices[3*i + 0] = vertices_[i].render_pos.x;
+      vertices[3*i + 1] = vertices_[i].render_pos.y;
+      vertices[3*i + 2] = vertices_[i].render_pos.z;
+    }
+
   glVertexPointer(3, GL_FLOAT, 0, &*vertices.begin());
+
   glNormalPointer(GL_FLOAT, 0, &*normals.begin());
   glTexCoordPointer(2, GL_FLOAT, 0, &*texcoords.begin());
   glDrawElements(GL_TRIANGLES, triangles.size(), GL_UNSIGNED_INT, &*triangles.begin());
 }
 
+void
+Mesh::apply(Armature* armature)
+{
+  for(Vertices::iterator i = vertices_.begin(); i != vertices_.end(); ++i)
+    {
+      if (i->bone_names.empty())
+        {
+          // This shouldn't be reached for full mehes
+          i->render_pos = i->pos;
+        }
+      else
+        {
+          if (i->bones.empty())
+            {
+              for(unsigned int j = 0; j < i->bone_names.size(); ++j)
+                i->bones.push_back(armature->get_bone(i->bone_names[j]));
+            }
+
+          i->render_pos = Vector3(0.0f, 0.0f, 0.0f);
+          for(unsigned int j = 0; j < i->bone_names.size(); ++j)
+            {
+              Bone* bone   = i->bones[j];
+              float weight = i->weights[j];
+
+              //std::cout << "apply: " << i->bone_names[j] << " " << bone << " " << weight << std::endl;
+
+              if (bone)
+                { // FIXME: Need to calculate the offset from the bone and rotate that, not the pos
+                  i->render_pos += (bone->render_matrix.multiply(i->pos)) * weight;
+                }
+              else
+                {
+                  std::cout << "Couldn't find bone: " << i->bone_names[j] << std::endl;
+                }
+            }
+        }
+    }
+}
+
+void
+Mesh::reset()
+{
+  for(Vertices::iterator i = vertices_.begin(); i != vertices_.end(); ++i)
+    {
+      i->render_pos = i->pos;
+    }
+}
+
 /* EOF */

Modified: trunk/windstille/src/armature/mesh.hpp
===================================================================
--- trunk/windstille/src/armature/mesh.hpp	2007-06-23 16:10:21 UTC (rev 1506)
+++ trunk/windstille/src/armature/mesh.hpp	2007-06-23 19:09:06 UTC (rev 1507)
@@ -36,6 +36,7 @@
 
 class FileReader;
 class Bone;
+class Armature;
 
 struct VertexGroup
 {
@@ -50,6 +51,8 @@
   Vector3 normal;
   Vector  texcoord;
 
+  Vector3 render_pos;
+
   // Influences from bone;
   std::vector<float> weights;
   std::vector<std::string> bone_names;
@@ -83,6 +86,8 @@
   ~Mesh();
 
   void draw();
+  void apply(Armature* armature);
+  void reset();
 private:
   Mesh (const Mesh&);
   Mesh& operator= (const Mesh&);

Modified: trunk/windstille/src/armature/model.cpp
===================================================================
--- trunk/windstille/src/armature/model.cpp	2007-06-23 16:10:21 UTC (rev 1506)
+++ trunk/windstille/src/armature/model.cpp	2007-06-23 19:09:06 UTC (rev 1507)
@@ -49,6 +49,8 @@
           std::cout << "Ignoring unhandled tag: " << i->get_name() << std::endl;
         }
     }
+
+  reset();
 }
 
 Model::~Model()
@@ -66,4 +68,22 @@
     }
 }
 
+void
+Model::reset()
+{
+  for(Meshes::iterator i = meshes.begin(); i != meshes.end(); ++i)
+    {
+      (*i)->reset();
+    }  
+}
+
+void
+Model::apply(Armature* armature)
+{
+  for(Meshes::iterator i = meshes.begin(); i != meshes.end(); ++i)
+    {
+      (*i)->apply(armature);
+    }    
+}
+
 /* EOF */

Modified: trunk/windstille/src/armature/model.hpp
===================================================================
--- trunk/windstille/src/armature/model.hpp	2007-06-23 16:10:21 UTC (rev 1506)
+++ trunk/windstille/src/armature/model.hpp	2007-06-23 19:09:06 UTC (rev 1507)
@@ -31,6 +31,7 @@
 
 class FileReader;
 class Mesh;
+class Armature;
 
 /** */
 class Model
@@ -45,6 +46,8 @@
   ~Model();
 
   void draw();
+  void apply(Armature* armature);
+  void reset();
 private:
   Model (const Model&);
   Model& operator= (const Model&);

Modified: trunk/windstille/src/armature_test.cpp
===================================================================
--- trunk/windstille/src/armature_test.cpp	2007-06-23 16:10:21 UTC (rev 1506)
+++ trunk/windstille/src/armature_test.cpp	2007-06-23 19:09:06 UTC (rev 1507)
@@ -57,7 +57,7 @@
 
   pose_idx = 0;
 
-  //armature->apply(*poses[pose_idx]);
+  armature->apply(*poses[pose_idx]);
 
   xrot = 0;
   yrot = 0;
@@ -94,8 +94,9 @@
 {
   time += delta;
 
-  pose_idx = int(time * 20.0f) % poses.size();
-  //armature->apply(*poses[pose_idx]);
+  pose_idx = int(time * 5.0f) % poses.size();
+  armature->apply(*poses[pose_idx]);
+  model->apply(armature);
 
   if (controller.button_was_pressed(ESCAPE_BUTTON) ||
       controller.button_was_pressed(PAUSE_BUTTON))



From grumbel at mail.berlios.de  Sun Jun 24 12:34:06 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sun, 24 Jun 2007 12:34:06 +0200
Subject: [Windstille-commit] r1508 - in trunk/windstille/src: . math
Message-ID: <200706241034.l5OAY6Rt013866@sheep.berlios.de>

Author: grumbel
Date: 2007-06-24 12:34:04 +0200 (Sun, 24 Jun 2007)
New Revision: 1508

Modified:
   trunk/windstille/src/math/quaternion.hpp
   trunk/windstille/src/sprite3dview.cpp
   trunk/windstille/src/sprite3dview.hpp
Log:
- improved rotation in sprite3dview

Modified: trunk/windstille/src/math/quaternion.hpp
===================================================================
--- trunk/windstille/src/math/quaternion.hpp	2007-06-23 19:09:06 UTC (rev 1507)
+++ trunk/windstille/src/math/quaternion.hpp	2007-06-24 10:34:04 UTC (rev 1508)
@@ -20,6 +20,8 @@
 #ifndef __QUATERNION_HPP__
 #define __QUATERNION_HPP__
 
+#include <math.h>
+#include "vector3.hpp"
 #include "matrix.hpp"
 
 class Quaternion
@@ -38,6 +40,24 @@
     : w(w), x(x), y(y), z(z)
   {}
 
+  /** Construct a Quaternion representing a rotation 
+   *  @param axis   the axis of rotation, must be a unit vector (length = 1.0f)
+   *  @param theta  the angle of rotation in radians
+   */
+  Quaternion(const Vector3& axis, float theta)
+  {
+    w = cos(theta/2);
+
+    float s = sin(theta/2);
+    x = axis.x * s;
+    y = axis.y * s;
+    z = axis.z * s;
+  }
+
+  static Quaternion identity() {
+    return Quaternion(1.0f, 0.0f, 0.0f, 0.0f);
+  }
+
   float magnitude() const;
   void normalize();
 

Modified: trunk/windstille/src/sprite3dview.cpp
===================================================================
--- trunk/windstille/src/sprite3dview.cpp	2007-06-23 19:09:06 UTC (rev 1507)
+++ trunk/windstille/src/sprite3dview.cpp	2007-06-24 10:34:04 UTC (rev 1508)
@@ -40,9 +40,9 @@
   actions = sprite.get_actions();
 
   sprite.set_action(actions[current_action]);
+  
+  rotation = Quaternion::identity();
 
-  rotx  = 0.0f;
-  roty  = 0.0f;
   scale = 2.0f;
 }
 
@@ -61,16 +61,18 @@
 Sprite3DView::draw()
 {
   sc.reset_modelview();
-  //sc.translate(-config->screen_width/2, -config->screen_height/2 + 150);
+  //sc.translate(-config->screen_width/2, -config->screen_height/2);
   //sc.scale(2.0f, 2.0f);
   
   sc.color().fill_screen(Color(0.5, 0.0, 0.5));
 
   sc.push_modelview();
-  sc.translate(Display::get_width()/2, Display::get_height()/2 + 200);
+  sc.translate(Display::get_width()/2, Display::get_height()/2);
   sc.scale(scale, scale);
-  sc.rotate(roty, 0.0f, 1.0f, 0.0f);
-  sc.rotate(rotx, 1.0f, 0.0f, 0.0f);
+
+  // Rotate
+  sc.mult_modelview(rotation.to_matrix());  
+  sc.translate(0, 64.0f); // FIXME: use object height/2 instead of 64
   sprite.draw(sc.color(), Vector(0,0), 0); 
   sc.pop_modelview();
 
@@ -141,9 +143,15 @@
       sprite.set_action(actions[current_action]);
     }
 
-  rotx += controller.get_axis_state(Y2_AXIS) * 50.0f * delta;
-  roty += controller.get_axis_state(X2_AXIS) * 50.0f * delta;
+  rotation = Quaternion(Vector3(0.0f, 1.0f, 0.0f), controller.get_axis_state(X2_AXIS) * delta * 2.0f) * rotation;
+  rotation = Quaternion(Vector3(1.0f, 0.0f, 0.0f), controller.get_axis_state(Y2_AXIS) * delta * 2.0f) * rotation;
+  rotation = Quaternion(Vector3(0.0f, 0.0f, 1.0f), controller.get_axis_state(X_AXIS) * delta * 2.0f) * rotation;
 
+  if (controller.get_button_state(VIEW_CENTER_BUTTON))
+    {
+      rotation = Quaternion::identity();
+    }
+
   if (controller.button_was_pressed(ESCAPE_BUTTON) ||
       controller.button_was_pressed(CANCEL_BUTTON))
     screen_manager.pop_screen();

Modified: trunk/windstille/src/sprite3dview.hpp
===================================================================
--- trunk/windstille/src/sprite3dview.hpp	2007-06-23 19:09:06 UTC (rev 1507)
+++ trunk/windstille/src/sprite3dview.hpp	2007-06-24 10:34:04 UTC (rev 1508)
@@ -42,8 +42,7 @@
   std::vector<std::string> actions;
   int current_action;
 
-  float rotx;
-  float roty;
+  Quaternion rotation;
   float scale;
 
 public:



From grumbel at mail.berlios.de  Sun Jun 24 14:30:58 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sun, 24 Jun 2007 14:30:58 +0200
Subject: [Windstille-commit] r1509 - trunk/windstille/tools
Message-ID: <200706241230.l5OCUwct027740@sheep.berlios.de>

Author: grumbel
Date: 2007-06-24 14:30:58 +0200 (Sun, 24 Jun 2007)
New Revision: 1509

Modified:
   trunk/windstille/tools/windstille_export.py
Log:
- little bug fixing

Modified: trunk/windstille/tools/windstille_export.py
===================================================================
--- trunk/windstille/tools/windstille_export.py	2007-06-24 10:34:04 UTC (rev 1508)
+++ trunk/windstille/tools/windstille_export.py	2007-06-24 12:30:58 UTC (rev 1509)
@@ -343,7 +343,7 @@
       """Convert Blender data structures into something that is used by
       this export script"""
 
-      scene  = Blender.Scene.getCurrent()
+      scene  = Blender.Scene.GetCurrent()
       layers = scene.Layers
 
       # compose list of meshs to export
@@ -361,6 +361,8 @@
       armatures = [obj for obj in Blender.Object.Get() if obj.getType() == "Armature"]
       if len(armatures) > 1:
           raise Exception, "Need to have at most 1 armature in the scene"
+      elif len(armatures) == 0:
+          self.armature_object = None
       else:
           self.armature_object = armatures[0]
 



From grumbel at mail.berlios.de  Mon Jun 25 05:07:40 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Mon, 25 Jun 2007 05:07:40 +0200
Subject: [Windstille-commit] r1510 - in trunk/media/images: . objects tiles
Message-ID: <200706250307.l5P37eDU013555@sheep.berlios.de>

Author: grumbel
Date: 2007-06-25 05:07:32 +0200 (Mon, 25 Jun 2007)
New Revision: 1510

Added:
   trunk/media/images/humanreference.png
   trunk/media/images/objects/lamp.xcf
   trunk/media/images/tiles/bar2.xcf
Log:
- some new gfx

Added: trunk/media/images/humanreference.png
===================================================================
(Binary files differ)


Property changes on: trunk/media/images/humanreference.png
___________________________________________________________________
Name: svn:mime-type
   + image/png

Added: trunk/media/images/objects/lamp.xcf
===================================================================
(Binary files differ)


Property changes on: trunk/media/images/objects/lamp.xcf
___________________________________________________________________
Name: svn:mime-type
   + application/x-xcf

Added: trunk/media/images/tiles/bar2.xcf
===================================================================
(Binary files differ)


Property changes on: trunk/media/images/tiles/bar2.xcf
___________________________________________________________________
Name: svn:mime-type
   + application/x-xcf



From grumbel at mail.berlios.de  Sat Jun 30 11:53:19 2007
From: grumbel at mail.berlios.de (grumbel at BerliOS)
Date: Sat, 30 Jun 2007 11:53:19 +0200
Subject: [Windstille-commit] r1511 - in trunk/windstille/src: . armature
	input math scripting
Message-ID: <200706300953.l5U9rJx0018843@sheep.berlios.de>

Author: grumbel
Date: 2007-06-30 11:53:18 +0200 (Sat, 30 Jun 2007)
New Revision: 1511

Modified:
   trunk/windstille/src/armature/armature.cpp
   trunk/windstille/src/armature/bone.hpp
   trunk/windstille/src/conversation.cpp
   trunk/windstille/src/conversation.hpp
   trunk/windstille/src/input/input_manager_sdl.cpp
   trunk/windstille/src/math/matrix.cpp
   trunk/windstille/src/math/matrix.hpp
   trunk/windstille/src/scripting/interface.cpp
   trunk/windstille/src/scripting/interface.hpp
   trunk/windstille/src/scripting/wrapper.cpp
Log:
- added topic/text to conversations
- some more matrix math

Modified: trunk/windstille/src/armature/armature.cpp
===================================================================
--- trunk/windstille/src/armature/armature.cpp	2007-06-25 03:07:32 UTC (rev 1510)
+++ trunk/windstille/src/armature/armature.cpp	2007-06-30 09:53:18 UTC (rev 1511)
@@ -63,7 +63,6 @@
                     i->get("parent",   bone->parent_name) &&
                     i->get("length",   bone->length) &&
                     i->get("quat",     bone->quat) &&
-                    i->get("matrix",   bone->matrix) &&
                     i->get("head",     bone->offset)))
                 {
                   std::cout << "Error: some Bone attribute missing" << std::endl;
@@ -71,10 +70,7 @@
                 }
               else
                 {
-                  // FIXME: experimental
-                  bone->matrix = bone->quat.to_matrix();
                   bone->render_matrix = bone->quat.to_matrix();
-
                   bones.push_back(bone);
                 }
             }
@@ -145,6 +141,7 @@
 {
   Matrix  m_  = m.multiply(bone->render_matrix);
   Vector3 p_  = p + m.multiply(bone->offset);
+
   // FIXME: In theory we should be using length in the Z component, but only
   // Y seems to work?! -> Blenders matrix are weird
   Vector3 p__ = p_ + m_.multiply(Vector3(0.0f, bone->length, 0.0f));
@@ -161,6 +158,9 @@
   glColor3f(1.0f, 0.0f, 0.0f);
   glVertex3f(  p__.x,  p__.y, p__.z);
 
+  bone->render_head = p_;
+  bone->render_tail = p__;
+
   for(std::vector<Bone*>::iterator i = bone->children.begin(); i != bone->children.end(); ++i)  
     draw_bone(*i, p__, m_);
 }
@@ -183,7 +183,7 @@
             }
           else
             {
-              bone->render_matrix = bone->matrix.multiply(pbone->quat.to_matrix());
+              bone->render_matrix = bone->quat.to_matrix().multiply(pbone->quat.to_matrix());
             }
         }
     }

Modified: trunk/windstille/src/armature/bone.hpp
===================================================================
--- trunk/windstille/src/armature/bone.hpp	2007-06-25 03:07:32 UTC (rev 1510)
+++ trunk/windstille/src/armature/bone.hpp	2007-06-30 09:53:18 UTC (rev 1511)
@@ -48,10 +48,11 @@
   float      length;
 
   Quaternion quat;
-  Matrix     matrix;
   Vector3    offset;
 
   Matrix     render_matrix;
+  Vector3    render_head;
+  Vector3    render_tail;
   
   Bone();
   ~Bone();

Modified: trunk/windstille/src/conversation.cpp
===================================================================
--- trunk/windstille/src/conversation.cpp	2007-06-25 03:07:32 UTC (rev 1510)
+++ trunk/windstille/src/conversation.cpp	2007-06-30 09:53:18 UTC (rev 1511)
@@ -49,19 +49,30 @@
 {
   if (!active)
     {
-      choices.push_back(text);
+      choices.push_back(Choice(text, ""));
       if (selection >= int(choices.size()))
         selection = 0;
     }
 }
 
 void
+Conversation::add(const std::string& topic, const std::string& text)
+{
+  if (!active)
+    {
+      choices.push_back(Choice(topic, text));
+      if (selection >= int(choices.size()))
+        selection = 0;
+    }
+}
+
+void
 Conversation::draw()
 {
   if (!active)
     return;
   
-  Display::fill_circle(pos, 42.0f, Color(1.0f, 1.0f, 1.0f, 0.25f), 24);
+  Display::fill_circle(pos, 42.0f, Color(0.5f, 0.5f, 0.5f, 0.75f), 24);
 
   float segment = 360.0f / choices.size();
 
@@ -74,7 +85,7 @@
       float end   = -segment/2 - 90.0f + segment*(i+1);
       
       // FIXME: Doesn't handle multi line text
-      Sizef size(Fonts::vera20->get_width(choices[i]) + 60,
+      Sizef size(Fonts::vera20->get_width(choices[i].topic) + 60,
                  Fonts::vera20->get_height() + 40);
       float distance = 160.0f;
 
@@ -85,12 +96,19 @@
         {
           Display::fill_arc(pos, 42.0f, start, end, Color(1.0f, 1.0f, 1.0f, 0.5f), 24);
           Display::fill_rounded_rect(rect, 5.0f, Color(0.5f, 0.5f, 0.5f, 0.75f));
-          Fonts::vera20->draw_center(textpos.x + distance * offset.x, textpos.y + distance * offset.y, choices[i], Color(1.0f, 1.0f, 1.0f));
+          Fonts::vera20->draw_center(textpos.x + distance * offset.x,
+                                     textpos.y + distance * offset.y, 
+                                     choices[i].topic, Color(1.0f, 1.0f, 1.0f));
+
+          Fonts::vera20->draw_center(400, 600 - 64,
+                                     choices[i].text, Color(1.0f, 1.0f, 1.0f));
         }
       else
         {
           Display::fill_rounded_rect(rect, 5.0f, Color(0.25f, 0.25f, 0.25f, 0.75f));
-          Fonts::vera20->draw_center(textpos.x + distance * offset.x, textpos.y + distance * offset.y, choices[i], Color(0.5f, 0.5f, 0.5f));
+          Fonts::vera20->draw_center(textpos.x + distance * offset.x,
+                                     textpos.y + distance * offset.y,
+                                     choices[i].topic, Color(0.5f, 0.5f, 0.5f));
         }
 
       Display::draw_rounded_rect(rect, 5.0f, Color(1.0f, 1.0f, 1.0f));
@@ -147,7 +165,9 @@
   if (controller.button_was_pressed(OK_BUTTON) && selection != -1)
     {
       active = false;
-      GameSession::current()->get_pda().add_dialog("Jane", choices[selection]);
+      GameSession::current()->get_pda().add_dialog("Jane",
+                                                   choices[selection].topic + " - " +
+                                                   choices[selection].text);
       choices.clear();
       GameSession::current()->set_control_state(GameSession::GAME);
       script_manager->fire_wakeup_event(ScriptManager::CONVERSATION_CLOSED);

Modified: trunk/windstille/src/conversation.hpp
===================================================================
--- trunk/windstille/src/conversation.hpp	2007-06-25 03:07:32 UTC (rev 1510)
+++ trunk/windstille/src/conversation.hpp	2007-06-30 09:53:18 UTC (rev 1511)
@@ -40,7 +40,17 @@
   bool   active;
   int    selection;
 
-  typedef std::vector<std::string> Choices;
+  struct Choice {
+    Choice(const std::string topic_,
+           const std::string text_)
+      : topic(topic_), 
+        text(text_) 
+    {}
+    std::string topic;
+    std::string text;
+  };
+
+  typedef std::vector<Choice> Choices;
   Choices choices;
   
   static Conversation* current_;
@@ -53,6 +63,7 @@
   void update(float delta, const Controller& controller);
 
   void add(const std::string& text);
+  void add(const std::string& topic, const std::string& text);
   int  get_selection() const;
   void show();
 };

Modified: trunk/windstille/src/input/input_manager_sdl.cpp
===================================================================
--- trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-25 03:07:32 UTC (rev 1510)
+++ trunk/windstille/src/input/input_manager_sdl.cpp	2007-06-30 09:53:18 UTC (rev 1511)
@@ -33,7 +33,7 @@
 
 InputManagerSDL* InputManagerSDL::current_ = 0;
 
-const int dead_zone =  4096;
+const int dead_zone =  8192;
 
 class InputManagerSDLImpl
 {

Modified: trunk/windstille/src/math/matrix.cpp
===================================================================
--- trunk/windstille/src/math/matrix.cpp	2007-06-25 03:07:32 UTC (rev 1510)
+++ trunk/windstille/src/math/matrix.cpp	2007-06-30 09:53:18 UTC (rev 1511)
@@ -27,8 +27,10 @@
 **    (if your name is missing here, please add it)
 */
 
+#include <assert.h>
 #include <string.h>
 #include <iostream>
+#include <iomanip>
 #include <math.h>
 #include "vector3.hpp"
 #include "matrix.hpp"
@@ -46,8 +48,8 @@
 {
   Matrix matrix;
 
-  matrix.matrix[0] = 1.0;
-  matrix.matrix[5] = 1.0;
+  matrix.matrix[0]  = 1.0;
+  matrix.matrix[5]  = 1.0;
   matrix.matrix[10] = 1.0;
   matrix.matrix[15] = 1.0;
 	
@@ -56,13 +58,41 @@
 
 Matrix::Matrix(const Matrix &copy)
 {
-  for (int i=0; i<16; i++)
+  for (int i = 0; i < 16; ++i)
     matrix[i] = copy.matrix[i];
 }
 
-Matrix::Matrix(const float *init_matrix)
+Matrix::Matrix(float m00, float m01, float m02, float m03,
+               float m10, float m11, float m12, float m13, 
+               float m20, float m21, float m22, float m23, 
+               float m30, float m31, float m32, float m33)
 {
-  for (int i=0; i<16; i++)
+  Matrix& m = *this;
+
+  m(0,0) = m00;
+  m(1,0) = m10;
+  m(2,0) = m20;
+  m(3,0) = m30;
+
+  m(0,1) = m01;
+  m(1,1) = m11;
+  m(2,1) = m21;
+  m(3,1) = m31;
+
+  m(0,2) = m02;
+  m(1,2) = m12;
+  m(2,2) = m22;
+  m(3,2) = m32;
+
+  m(0,3) = m03;
+  m(1,3) = m13;
+  m(2,3) = m23;
+  m(3,3) = m33;
+}
+
+Matrix::Matrix(const float* init_matrix)
+{
+  for (int i = 0; i < 16; ++i)
     matrix[i] = init_matrix[i];
 }
 
@@ -192,14 +222,110 @@
 
   return multiply(matrix);
 }
+// http://www.cvl.iis.u-tokyo.ac.jp/~miyazaki/tech/teche23.html
+// http://gpwiki.org/index.php/MathGem:Fast_Matrix_Inversion
 
+Matrix
+Matrix::inverse() const
+{
+  float det = determinat();
+  if (det != 0)
+    {
+      const Matrix& m = *this;
+      Matrix b;
+      // FIXME: wrong start index, should be 0, is 1
+      b(0,0) = m(2,2)*m(3,3)*m(4,4) + m(2,3)*m(3,4)*m(4,2) + m(2,4)*m(3,2)*m(4,3) - m(2,2)*m(3,4)*m(4,3) - m(2,3)*m(3,2)*m(4,4) - m(2,4)*m(3,3)*m(4,2);
+      b(0,1) = m(1,2)*m(3,4)*m(4,3) + m(1,3)*m(3,2)*m(4,4) + m(1,4)*m(3,3)*m(4,2) - m(1,2)*m(3,3)*m(4,4) - m(1,3)*m(3,4)*m(4,2) - m(1,4)*m(3,2)*m(4,3);
+      b(0,2) = m(1,2)*m(2,3)*m(4,4) + m(1,3)*m(2,4)*m(4,2) + m(1,4)*m(2,2)*m(4,3) - m(1,2)*m(2,4)*m(4,3) - m(1,3)*m(2,2)*m(4,4) - m(1,4)*m(2,3)*m(4,2);
+      b(0,3) = m(1,2)*m(2,4)*m(3,3) + m(1,3)*m(2,2)*m(3,4) + m(1,4)*m(2,3)*m(3,2) - m(1,2)*m(2,3)*m(3,4) - m(1,3)*m(2,4)*m(3,2) - m(1,4)*m(2,2)*m(3,3);
+                                                                                                                                                              
+      b(1,0) = m(2,1)*m(3,4)*m(4,3) + m(2,3)*m(3,1)*m(4,4) + m(2,4)*m(3,3)*m(4,1) - m(2,1)*m(3,3)*m(4,4) - m(2,3)*m(3,4)*m(4,1) - m(2,4)*m(3,1)*m(4,3);
+      b(1,1) = m(1,1)*m(3,3)*m(4,4) + m(1,3)*m(3,4)*m(4,1) + m(1,4)*m(3,1)*m(4,3) - m(1,1)*m(3,4)*m(4,3) - m(1,3)*m(3,1)*m(4,4) - m(1,4)*m(3,3)*m(4,1);
+      b(1,2) = m(1,1)*m(2,4)*m(4,3) + m(1,3)*m(2,1)*m(4,4) + m(1,4)*m(2,3)*m(4,1) - m(1,1)*m(2,3)*m(4,4) - m(1,3)*m(2,4)*m(4,1) - m(1,4)*m(2,1)*m(4,3);
+      b(1,3) = m(1,1)*m(2,3)*m(3,4) + m(1,3)*m(2,4)*m(3,1) + m(1,4)*m(2,1)*m(3,3) - m(1,1)*m(2,4)*m(3,3) - m(1,3)*m(2,1)*m(3,4) - m(1,4)*m(2,3)*m(3,1);
+                                                                                                                                                              
+      b(2,0) = m(2,1)*m(3,2)*m(4,4) + m(2,2)*m(3,4)*m(4,1) + m(2,4)*m(3,1)*m(4,2) - m(2,1)*m(3,4)*m(4,2) - m(2,2)*m(3,1)*m(4,1) - m(2,4)*m(3,2)*m(4,1);
+      b(2,1) = m(1,1)*m(3,4)*m(4,2) + m(1,2)*m(3,1)*m(4,4) + m(1,4)*m(3,2)*m(4,1) - m(1,1)*m(3,2)*m(4,4) - m(1,2)*m(3,4)*m(4,1) - m(1,4)*m(3,1)*m(4,2);
+      b(2,2) = m(1,1)*m(2,2)*m(4,4) + m(1,2)*m(2,4)*m(4,1) + m(1,4)*m(2,1)*m(4,2) - m(1,1)*m(2,4)*m(4,2) - m(1,2)*m(2,1)*m(4,4) - m(1,4)*m(2,2)*m(4,1);
+      b(2,3) = m(1,1)*m(2,4)*m(3,2) + m(1,2)*m(2,1)*m(3,4) + m(1,4)*m(2,2)*m(3,1) - m(1,1)*m(2,2)*m(3,4) - m(1,2)*m(2,4)*m(3,1) - m(1,4)*m(2,1)*m(3,2);
+                                                                                                                                                              
+      b(3,0) = m(2,1)*m(3,3)*m(4,2) + m(2,2)*m(3,1)*m(4,3) + m(2,3)*m(3,2)*m(4,1) - m(2,1)*m(3,2)*m(4,3) - m(2,2)*m(3,3)*m(4,1) - m(2,3)*m(3,1)*m(4,2);
+      b(3,1) = m(1,1)*m(3,2)*m(4,3) + m(1,2)*m(3,3)*m(4,1) + m(1,3)*m(3,1)*m(4,2) - m(1,1)*m(3,3)*m(4,2) - m(1,2)*m(3,1)*m(4,3) - m(1,3)*m(3,2)*m(4,1);
+      b(3,2) = m(1,1)*m(2,3)*m(4,2) + m(1,2)*m(2,1)*m(4,3) + m(1,3)*m(2,2)*m(4,1) - m(1,1)*m(2,2)*m(4,3) - m(1,2)*m(2,3)*m(4,1) - m(1,3)*m(2,1)*m(4,2);
+      b(3,3) = m(1,1)*m(2,2)*m(3,3) + m(1,2)*m(2,3)*m(3,1) + m(1,3)*m(2,1)*m(3,2) - m(1,1)*m(2,3)*m(3,2) - m(1,2)*m(2,1)*m(3,3) - m(1,3)*m(2,2)*m(3,1);
+
+      return b;
+    }
+  else
+    {
+      assert(!"Matrix can't be inverted");
+    }
+}
+
+float
+Matrix::determinat() const
+{
+  const Matrix& m = *this;
+  return  // fixme: all wrong, need to -1 everything!
+    m(1,1)*m(2,2)*m(3,3)*m(4,4) + m(1,1)*m(2,3)*m(3,4)*m(4,2) + m(1,1)*m(2,4)*m(3,2)*m(4,3) +
+    m(1,2)*m(2,1)*m(3,4)*m(4,3) + m(1,2)*m(2,3)*m(3,1)*m(4,4) + m(1,2)*m(2,4)*m(3,3)*m(4,1) +
+    m(1,3)*m(2,1)*m(3,2)*m(4,4) + m(1,3)*m(2,2)*m(3,4)*m(4,1) + m(1,3)*m(2,4)*m(3,1)*m(4,2) +
+    m(1,4)*m(2,1)*m(3,3)*m(4,2) + m(1,4)*m(2,2)*m(3,1)*m(4,3) + m(1,4)*m(2,3)*m(3,2)*m(4,1) -
+    m(1,1)*m(2,2)*m(3,4)*m(4,3) - m(1,1)*m(2,3)*m(3,2)*m(4,4) - m(1,1)*m(2,4)*m(3,3)*m(4,2) -
+    m(1,2)*m(2,1)*m(3,3)*m(4,4) - m(1,2)*m(2,3)*m(3,4)*m(4,1) - m(1,2)*m(2,4)*m(3,1)*m(4,3) -
+    m(1,3)*m(2,1)*m(3,4)*m(4,2) - m(1,3)*m(2,2)*m(3,1)*m(4,4) - m(1,3)*m(2,4)*m(3,2)*m(4,1) -
+    m(1,4)*m(2,1)*m(3,2)*m(4,3) - m(1,4)*m(2,2)*m(3,3)*m(4,1) - m(1,4)*m(2,3)*m(3,1)*m(4,2);
+}
+
+Matrix
+Matrix::fast_inverse() const
+{
+  //const Matrix& m = *this;
+  Matrix ret;
+
+  assert(!"implement me");
+
+  return ret;
+}
+
+Matrix
+Matrix::transpose() const
+{
+  const Matrix& m = *this;
+  Matrix ret;
+
+  ret(0,0) = m(0,0);
+  ret(1,0) = m(0,1);
+  ret(2,0) = m(0,2);
+  ret(3,0) = m(0,3);
+
+  ret(0,1) = m(1,0);
+  ret(1,1) = m(1,1);
+  ret(2,1) = m(1,2);
+  ret(3,1) = m(1,3);
+
+  ret(0,2) = m(2,0);
+  ret(1,2) = m(2,1);
+  ret(2,2) = m(2,2);
+  ret(3,2) = m(2,3);
+
+  ret(0,3) = m(3,0);
+  ret(1,3) = m(3,1);
+  ret(2,3) = m(3,2);
+  ret(3,3) = m(3,3);
+
+  return ret;
+}
+
 std::ostream& operator<<(std::ostream& s, const Matrix& m)
 {
-  s << "[" << m[ 0] << ", " << m[ 4] << ", " << m[ 8] << ", " << m[12] << "\n";
-  s << " " << m[ 1] << ", " << m[ 5] << ", " << m[ 9] << ", " << m[13] << "\n";
-  s << " " << m[ 2] << ", " << m[ 6] << ", " << m[10] << ", " << m[14] << "\n";
-  s << " " << m[ 3] << ", " << m[ 7] << ", " << m[11] << ", " << m[15] << "]\n";
-
+  std::ios_base::fmtflags oldflags = s.flags();
+  s << std::fixed << std::setprecision(3)
+    << "[" << m[ 0] << ", " << m[ 4] << ", " << m[ 8] << ", " << m[12] << "\n"
+    << " " << m[ 1] << ", " << m[ 5] << ", " << m[ 9] << ", " << m[13] << "\n"
+    << " " << m[ 2] << ", " << m[ 6] << ", " << m[10] << ", " << m[14] << "\n"
+    << " " << m[ 3] << ", " << m[ 7] << ", " << m[11] << ", " << m[15] << "]\n";
+  s.flags(oldflags);
   return s;
 }
 

Modified: trunk/windstille/src/math/matrix.hpp
===================================================================
--- trunk/windstille/src/math/matrix.hpp	2007-06-25 03:07:32 UTC (rev 1510)
+++ trunk/windstille/src/math/matrix.hpp	2007-06-30 09:53:18 UTC (rev 1511)
@@ -46,6 +46,11 @@
 
   Matrix(const float *matrix);
 
+  Matrix(float m00, float m01, float m02, float m03,
+         float m10, float m11, float m12, float m13, 
+         float m20, float m21, float m22, float m23, 
+         float m30, float m31, float m32, float m33);
+
   /** Returns identity matrix */
   static Matrix identity();
 
@@ -91,7 +96,21 @@
   //: Multiply two matrices.
   Matrix multiply(const Matrix &matrix) const;
 
+  //: Calculate the inverse of this matrix
+  Matrix inverse() const;
+
+  /** Calculate the inverse of this matrix in a fast way, only works
+   *  for matrices that represent rotation and translation */
+  Matrix fast_inverse() const;
+
+  //: Callculate the determinat of this matrix
+  float determinat() const;
+
+  //: Multiply a vector with this matrix
   Vector3 multiply(const Vector3& vector) const;
+  
+  //: Transpose this matrix and return the result
+  Matrix transpose() const;
 
   //: Multiply the matrix with the given scale/translate/rotate matrix
   Matrix scale(float x, float y, float z);

Modified: trunk/windstille/src/scripting/interface.cpp
===================================================================
--- trunk/windstille/src/scripting/interface.cpp	2007-06-25 03:07:32 UTC (rev 1510)
+++ trunk/windstille/src/scripting/interface.cpp	2007-06-30 09:53:18 UTC (rev 1511)
@@ -223,6 +223,11 @@
   Conversation::current()->add(text);
 }
 
+void conversation_add2(const std::string& topic, const std::string& text)
+{
+  Conversation::current()->add(topic, text);
+}
+
 void conversation_show()
 {
   Conversation::current()->show();

Modified: trunk/windstille/src/scripting/interface.hpp
===================================================================
--- trunk/windstille/src/scripting/interface.hpp	2007-06-25 03:07:32 UTC (rev 1510)
+++ trunk/windstille/src/scripting/interface.hpp	2007-06-30 09:53:18 UTC (rev 1511)
@@ -69,6 +69,7 @@
 void wait_for_camera(HSQUIRRELVM vm) __suspend;
 
 void conversation_add(const std::string& text);
+void conversation_add2(const std::string& topic, const std::string& text);
 void conversation_show();
 int  conversation_get_selection();
 void wait_for_conversation(HSQUIRRELVM v) __suspend;

Modified: trunk/windstille/src/scripting/wrapper.cpp
===================================================================
--- trunk/windstille/src/scripting/wrapper.cpp	2007-06-25 03:07:32 UTC (rev 1510)
+++ trunk/windstille/src/scripting/wrapper.cpp	2007-06-30 09:53:18 UTC (rev 1511)
@@ -892,6 +892,34 @@
   
 }
 
+static SQInteger conversation_add2_wrapper(HSQUIRRELVM vm)
+{
+  const SQChar* arg0;
+  if(SQ_FAILED(sq_getstring(vm, 2, &arg0))) {
+    sq_throwerror(vm, _SC("Argument 1 not a string"));
+    return SQ_ERROR;
+  }
+  const SQChar* arg1;
+  if(SQ_FAILED(sq_getstring(vm, 3, &arg1))) {
+    sq_throwerror(vm, _SC("Argument 2 not a string"));
+    return SQ_ERROR;
+  }
+  
+  try {
+    Scripting::conversation_add2(arg0, arg1);
+  
+    return 0;
+  
+  } catch(std::exception& e) {
+    sq_throwerror(vm, e.what());
+    return SQ_ERROR;
+  } catch(...) {
+    sq_throwerror(vm, _SC("Unexpected exception while executing function 'conversation_add2'"));
+    return SQ_ERROR;
+  }
+  
+}
+
 static SQInteger conversation_show_wrapper(HSQUIRRELVM vm)
 {
   (void) vm;
@@ -1768,6 +1796,12 @@
     throw SquirrelError(v, "Couldn't register function 'conversation_add'");
   }
 
+  sq_pushstring(v, "conversation_add2", -1);
+  sq_newclosure(v, &conversation_add2_wrapper, 0);
+  if(SQ_FAILED(sq_createslot(v, -3))) {
+    throw SquirrelError(v, "Couldn't register function 'conversation_add2'");
+  }
+
   sq_pushstring(v, "conversation_show", -1);
   sq_newclosure(v, &conversation_show_wrapper, 0);
   if(SQ_FAILED(sq_createslot(v, -3))) {



