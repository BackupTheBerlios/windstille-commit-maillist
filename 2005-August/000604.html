<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Windstille-commit] r951 - in trunk: data/levels data/scripts src src/collision src/lisp src/scripting
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/windstille-commit/2005-August/index.html" >
   <LINK REL="made" HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r951%20-%20in%20trunk%3A%20data/levels%20data/scripts%20src%20src/collision%20src/lisp%20src/scripting&In-Reply-To=%3C200508102226.j7AMQgmv006877%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000603.html">
   <LINK REL="Next"  HREF="000605.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Windstille-commit] r951 - in trunk: data/levels data/scripts src src/collision src/lisp src/scripting</H1>
    <B>Matthias Braun at BerliOS</B> 
    <A HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r951%20-%20in%20trunk%3A%20data/levels%20data/scripts%20src%20src/collision%20src/lisp%20src/scripting&In-Reply-To=%3C200508102226.j7AMQgmv006877%40sheep.berlios.de%3E"
       TITLE="[Windstille-commit] r951 - in trunk: data/levels data/scripts src src/collision src/lisp src/scripting">matzebraun at berlios.de
       </A><BR>
    <I>Thu Aug 11 00:26:42 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000603.html">[Windstille-commit] r950 - in trunk/src: . badguy
</A></li>
        <LI>Next message: <A HREF="000605.html">[Windstille-commit] r952 - trunk/data/images
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#604">[ date ]</a>
              <a href="thread.html#604">[ thread ]</a>
              <a href="subject.html#604">[ subject ]</a>
              <a href="author.html#604">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: matzebraun
Date: 2005-08-11 00:26:40 +0200 (Thu, 11 Aug 2005)
New Revision: 951

Added:
   trunk/src/physics.cpp
   trunk/src/physics.hpp
   trunk/src/scripting/squirrel_error.cpp
   trunk/src/scripting/squirrel_error.hpp
Modified:
   trunk/data/levels/intro.nut
   trunk/data/levels/intro.wst
   trunk/data/levels/newformat2.nut
   trunk/data/scripts/windstille.nut
   trunk/src/Jamfile
   trunk/src/box.cpp
   trunk/src/box.hpp
   trunk/src/collision/collision_data.hpp
   trunk/src/collision/collision_engine.cpp
   trunk/src/collision/collision_engine.hpp
   trunk/src/collision/collision_object.cpp
   trunk/src/collision/collision_object.hpp
   trunk/src/elevator.cpp
   trunk/src/entity.hpp
   trunk/src/lisp/parser.cpp
   trunk/src/player.cpp
   trunk/src/player.hpp
   trunk/src/script_manager.cpp
   trunk/src/script_manager.hpp
   trunk/src/scripting/wrapper.cpp
   trunk/src/scripting/wrapper.hpp
   trunk/src/scripting/wrapper_util.cpp
   trunk/src/scripting/wrapper_util.hpp
   trunk/src/sector.cpp
Log:
- SOme cleanups to scripting code
- Moved GameObjects into objects table (now you have to use
        objects.Player instead of just Player)
- added link back to GameObject to CollisionObject
- No need for GameObject&amp; other parameter in collision function when the same
  information is in CollisionData
- Added not yet working physics class (but I'll be off for holidays in the next
  3 weeks...)



Modified: trunk/data/levels/intro.nut
===================================================================
--- trunk/data/levels/intro.nut	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/data/levels/intro.nut	2005-08-10 22:26:40 UTC (rev 951)
@@ -1,7 +1,8 @@
 set_camera_active(false);
-player.set_active(false);
+objects.player.set_active(false);
 set_view(0, 0);
-spawn_object(&quot;scriptable-object&quot;, {name=&quot;planet&quot;, pos=[0,0], sprite=&quot;images/planet.sprite&quot;, z_pos=1001});
+spawn_object(&quot;scriptable-object&quot;, { name=&quot;planet&quot;, pos=[0,0],
+    sprite=&quot;images/planet.sprite&quot;, z_pos=1001 });
 wait(3);
 add_caption(BOTTOM, &quot;The Big Boom. Humanity found out it could travel to the stars, and it did, en masse.&quot;);
 wait(10);
@@ -10,8 +11,8 @@
 add_caption(BOTTOM, &quot;Still, many individuals took their chances, even without military hardware and terraformers. Most worlds were so barren or so dangerous that whole colonies died out. In the Free Colonies that survive, life isn't easy.&quot;);
 wait(15);
 end_caption();
-player.set_active(true);
+objects.player.set_active(true);
 set_camera_active(true);
-planet.remove();
+objects.planet.remove();
 
 /* EOF */

Modified: trunk/data/levels/intro.wst
===================================================================
--- trunk/data/levels/intro.wst	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/data/levels/intro.wst	2005-08-10 22:26:40 UTC (rev 951)
@@ -2,7 +2,7 @@
 (windstille-sector
   (version 2)
   (name   &quot;&quot;)
-  (music  &quot;silence_wip.ogg&quot;)
+  (music  &quot;music/silence_wip.ogg&quot;)
   (ambient-color .666 .666 .666)
   (init-script &quot;levels/intro.nut&quot;)
   (spawnpoint

Modified: trunk/data/levels/newformat2.nut
===================================================================
--- trunk/data/levels/newformat2.nut	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/data/levels/newformat2.nut	2005-08-10 22:26:40 UTC (rev 951)
@@ -1,27 +1,27 @@
 set_controller_help_active(true);
-player_flames2.set_active(false);
-player_flames.set_active(false);      
+objects.player_flames2.set_active(false);
+objects.player_flames.set_active(false);      
 
 /* Some fun with fire */
 function startfire()
 {
   // Need to parent here because at top level &quot;player&quot; isn't yet created
-  player_flames2.set_parent(&quot;player&quot;);
-  player_flames.set_parent(&quot;player&quot;);      
+  objects.player_flames2.set_parent(&quot;player&quot;);
+  objects.player_flames.set_parent(&quot;player&quot;);      
 
-  player_flames2.set_active(true);
-  player_flames.set_active(true);
+  objects.player_flames2.set_active(true);
+  objects.player_flames.set_active(true);
 }
 
 function stopfire()
 {
   // FIXME: Don't just deactivate the GameObject, but let the particle
   // system run out (set_cycles(1.0)) also add a bunch of white smoke
-  player_flames2.set_active(false);
-  player_flames.set_active(false);
+  objects.player_flames2.set_active(false);
+  objects.player_flames.set_active(false);
 }
 
-Block0Sign.start_flash(0.7);
-Block0Sign.move_to(100, 370, 100, 2);
+objects.Block0Sign.start_flash(0.7);
+objects.Block0Sign.move_to(100, 370, 100, 2);
 
 /* EOF */

Modified: trunk/data/scripts/windstille.nut
===================================================================
--- trunk/data/scripts/windstille.nut	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/data/scripts/windstille.nut	2005-08-10 22:26:40 UTC (rev 951)
@@ -6,13 +6,13 @@
 {
   if (vargc == 1) 
     {
-      if (::has_nightvision) {
-        nightvision.set_active(vargv[0]); 
+      if (has_nightvision) {
+        objects.nightvision.set_active(vargv[0]); 
       } 
       else if (vargv[0]) 
         {
-          ::spawn_object(&quot;nightvision&quot;, {});
-          ::has_nightvision = true;
+          spawn_object(&quot;nightvision&quot;, {});
+          has_nightvision = true;
         }
     } else {
       return true;
@@ -36,23 +36,23 @@
   return conversation_get_selection();
 }
 
-class Dialog {
-  constructor(arg_align, arg_character, arg_portrait)
-  {
+class Dialog {
+  constructor(arg_align, arg_character, arg_portrait)
+  {
     align = arg_align;
     character = arg_character;
-    portrait = arg_portrait;
-  }
-
-  function set(text)
-  {
+    portrait = arg_portrait;
+  }
+
+  function set(text)
+  {
     dialog_show(align, character, portrait, text);
-    wait_for_dialog();
-  }
-
+    wait_for_dialog();
+  }
+
   align = null;
   character = null;
-  portrait = null;
+  portrait = null;
 }
 
 function add_dialog(align, character, portrait, text)

Modified: trunk/src/Jamfile
===================================================================
--- trunk/src/Jamfile	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/Jamfile	2005-08-10 22:26:40 UTC (rev 951)
@@ -68,6 +68,8 @@
         math.hpp
         nightvision.cpp
         nightvision.hpp
+        physics.cpp
+        physics.hpp
         pda.cpp
         pda.hpp
         player.cpp

Modified: trunk/src/box.cpp
===================================================================
--- trunk/src/box.cpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/box.cpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -51,7 +51,7 @@
     throw std::runtime_error(&quot;No sprite name specified in Box&quot;);
   sprite = Sprite(spritename);
   
-  colobj = new CollisionObject(Rectf(0, 0, width, height));
+  colobj = new CollisionObject(this, Rectf(0, 0, width, height));
   colobj-&gt;set_velocity(vel);
   colobj-&gt;set_pos(Vector(pos.x, pos.y));
 
@@ -66,10 +66,8 @@
 }
 
 void 
-Box::collision(const CollisionData&amp; data, CollisionObject&amp; other)
+Box::collision(const CollisionData&amp; data)
 {
-  (void) data;
-  (void) other;
   //std::cout &lt;&lt; this &lt;&lt; &quot;: Collision Event&quot; &lt;&lt; std::endl;
   if ((data.direction.x &gt; 0 &amp;&amp; colobj-&gt;get_velocity().x &lt; 0) ||
       (data.direction.x &lt; 0 &amp;&amp; colobj-&gt;get_velocity().x &gt; 0))

Modified: trunk/src/box.hpp
===================================================================
--- trunk/src/box.hpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/box.hpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -39,7 +39,7 @@
   Box(const lisp::Lisp* lisp);
   virtual ~Box();
 
-  void collision(const CollisionData&amp; data, CollisionObject&amp; other); 
+  void collision(const CollisionData&amp; data); 
 
   void update(float delta);
 

Modified: trunk/src/collision/collision_data.hpp
===================================================================
--- trunk/src/collision/collision_data.hpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/collision/collision_data.hpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -44,7 +44,8 @@
   // time of collision
   float col_time;
 
-  CollisionObject *a,*b;
+  CollisionObject* object1;
+  CollisionObject* object2;
 
   CollisionData()
   {
@@ -58,6 +59,8 @@
   {
     CollisionData r(*this);
     r.direction*=-1;
+    r.object1 = object2;
+    r.object2 = object1;
 
     return r;
   } 

Modified: trunk/src/collision/collision_engine.cpp
===================================================================
--- trunk/src/collision/collision_engine.cpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/collision/collision_engine.cpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -49,14 +49,10 @@
 }
 
 void
-CollisionEngine::collision(CollisionObject&amp; a, CollisionObject&amp; b, const CollisionData &amp;result, float delta)
+CollisionEngine::collision(const CollisionData &amp;result)
 {
-  (void)delta;
-
-  CollisionData inv=result.invert();
-
-  a.sig_collision()(result, b);
-  b.sig_collision()(inv, a);
+  result.object1-&gt;sig_collision() (result);
+  result.object2-&gt;sig_collision() (result.invert());
 }
 
 void
@@ -290,8 +286,8 @@
 		    {
 		      if (min_time &gt; r.col_time &amp;&amp; r.col_time&gt;=0)
 			{
-			  r.a=*i;
-			  r.b=*j;
+			  r.object1 = *i;
+			  r.object2 = *j;
 			  col_data = r;
 			  min_time = r.col_time;
 			  if (min_time &gt; 0.0005)
@@ -313,7 +309,7 @@
       // report collision
       if (min_time &lt; frame)
 	{
-	  collision (*col_data.a, *col_data.b, col_data, min_time);
+	  collision (col_data);
 	}
 
       frame-=min_time;

Modified: trunk/src/collision/collision_engine.hpp
===================================================================
--- trunk/src/collision/collision_engine.hpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/collision/collision_engine.hpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -40,7 +40,7 @@
   void draw(DrawingContext&amp; dc);
   void update(float delta);
   void update(CollisionObject&amp; obj, float delta);
-  void collision(CollisionObject&amp; a, CollisionObject&amp; b, const CollisionData &amp;result, float delta);
+  void collision(const CollisionData &amp;result);
 
   CollisionObject* add(CollisionObject *obj);
   void remove(CollisionObject *obj);

Modified: trunk/src/collision/collision_object.cpp
===================================================================
--- trunk/src/collision/collision_object.cpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/collision/collision_object.cpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -30,7 +30,7 @@
  * CollisionObject
  ***********************************************************************/
 
-CollisionObject::CollisionObject(const Rectf&amp; rect_)
+CollisionObject::CollisionObject(GameObject* game_object, const Rectf&amp; rect_)
   : primitive(rect_)
 {
   object_type        = RECTANGLE;
@@ -38,7 +38,7 @@
   is_unstuck_movable = true;
   velocity           = Vector(0,0);
   pos                = Vector(0,0);
-  game_object        = 0;
+  game_object        = game_object;
 }
 
 CollisionObject::CollisionObject(TileMap* tilemap_)

Modified: trunk/src/collision/collision_object.hpp
===================================================================
--- trunk/src/collision/collision_object.hpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/collision/collision_object.hpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -54,7 +54,7 @@
 
   GameObject* game_object;
 
-  Signal_v2&lt;const CollisionData &amp;, CollisionObject &amp;&gt; collision;
+  Signal_v1&lt;const CollisionData &amp;&gt; collision;
 
   Rectf primitive;
   TileMap* tilemap;
@@ -63,7 +63,7 @@
   bool is_unstuck_movable;
 
 public:
-  CollisionObject(const Rectf&amp; rect_);
+  CollisionObject(GameObject* object, const Rectf&amp; rect_);
   CollisionObject(TileMap* tilemap_);
 
   virtual ~CollisionObject();
@@ -108,7 +108,7 @@
   void set_unstuck(bool s) { is_unstuckable = s; }
   void set_unstuck_movable(bool s) { is_unstuck_movable = s; }
 
-  Signal_v2&lt;const CollisionData &amp;, CollisionObject &amp;&gt;&amp; sig_collision() { return collision; }
+  Signal_v1&lt;const CollisionData &amp;&gt;&amp; sig_collision() { return collision; }
 
   friend class CollisionEngine;
 };

Modified: trunk/src/elevator.cpp
===================================================================
--- trunk/src/elevator.cpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/elevator.cpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -45,7 +45,7 @@
 
   sprite = Sprite(spritename);
   size  = Size(128, 64);
-  colobject = new CollisionObject(Rectf(Vector(0,0), size));
+  colobject = new CollisionObject(this, Rectf(Vector(0,0), size));
   Sector::current()-&gt;get_collision_engine()-&gt;add(colobject);
   colobject-&gt;set_pos(pos);
 }

Modified: trunk/src/entity.hpp
===================================================================
--- trunk/src/entity.hpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/entity.hpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -39,6 +39,7 @@
   Signal_v0 done; 
 
 protected:
+  friend class Physics;
   bool on_ground() const;
   bool in_wall() const;
   

Modified: trunk/src/lisp/parser.cpp
===================================================================
--- trunk/src/lisp/parser.cpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/lisp/parser.cpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -101,6 +101,9 @@
   parser-&gt;lexer = new Lexer(stream);
 
   parser-&gt;token = parser-&gt;lexer-&gt;getNextToken();
+  if(parser-&gt;token != Lexer::TOKEN_OPEN_PAREN)
+    throw ParseError(parser.get(), &quot;file doesn't start with '('&quot;);
+
   std::auto_ptr&lt;Lisp&gt; result (parser-&gt;parse());
   if(parser-&gt;token != Lexer::TOKEN_EOF) {
     if(parser-&gt;token == Lexer::TOKEN_CLOSE_PAREN)

Added: trunk/src/physics.cpp
===================================================================
--- trunk/src/physics.cpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/physics.cpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -0,0 +1,95 @@
+#include &lt;config.h&gt;
+
+#include &quot;physics.hpp&quot;
+
+Physics::Physics(Entity* entity)
+  : entity(entity)
+{
+  mass = 1.0;
+  bounciness = 0.0;
+  air_friction = 0.0;
+  contact_friction = 0.0;
+}
+
+Physics::~Physics()
+{
+}
+
+void
+Physics::register_collobj(CollisionObject&amp; object)
+{
+  slots.push_back(object.sig_collision().connect(this, &amp;Physics::collision));
+}
+
+void
+Physics::collision(const CollisionData&amp; data)
+{
+  GameObject* other_object = data.object2-&gt;get_game_object();
+  if(other_object == 0)
+    return;
+
+  data.object1-&gt;set_velocity(Vector(0, 0));
+  data.object2-&gt;set_velocity(Vector(0, 0));
+
+  const Physics* physics = dynamic_cast&lt;const Physics*&gt; (other_object);
+  if(physics)
+  {
+    elastic_collision(data, *physics);
+    return;
+  }
+
+  // assume fix object...
+  bounce_collision(data);
+}
+
+void
+Physics::elastic_collision(const CollisionData&amp; data, const Physics&amp; other)
+{
+  printf(&quot;elastic collision.\n&quot;);
+  // we could calculate this cheaper if we'd do it once for both objects and not
+  // each object on it's own...
+
+  Vector other_collision_vel 
+    = data.direction * (other.velocity() * data.direction);
+  Vector collision_vel
+    = data.direction * (velocity() * data.direction);
+  
+  Vector new_v = collision_vel * (mass - other.mass);
+  new_v += other_collision_vel * (2 * other.mass);
+  new_v /= mass + other.mass;
+
+  // velocity += new_v - collision_vel
+  force += (new_v - collision_vel) * mass / data.delta;
+
+  // TODO apply friction here?
+}
+
+void
+Physics::bounce_collision(const CollisionData&amp; data)
+{
+  printf(&quot;bounce collision.\n&quot;);
+  Vector collision_vel
+    = data.direction * (velocity() * data.direction);
+
+  // velocity -= collision_vel * (1.0 + bounciness)
+  force -= collision_vel * (1.0f + bounciness) * mass / data.delta;
+
+  // TODO apply friction
+}
+
+void
+Physics::update(float elapsed_time)
+{
+  // take a look at verlet integration, might work better than euler here
+ 
+  // add gravity force (TODO make it configurable per Sector)
+  force += Vector(0, 9.81 * mass);
+
+  force -= velocity() * air_friction;
+  
+  Vector acceleration = force / mass;
+  velocity() += acceleration * elapsed_time;
+
+  force = Vector(0, 0);
+}
+

Added: trunk/src/physics.hpp
===================================================================
--- trunk/src/physics.hpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/physics.hpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -0,0 +1,38 @@
+#ifndef __PHYSICS_HPP__
+#define __PHYSICS_HPP__
+
+#include &quot;collision/collision_data.hpp&quot;
+#include &quot;entity.hpp&quot;
+
+class Physics
+{
+public:
+  Physics(Entity* entity);
+  ~Physics();
+
+  void update(float elapsed_time);
+  void register_collobj(CollisionObject&amp; object);
+
+  Vector&amp; pos() const
+  { return entity-&gt;pos; }
+  Vector&amp; velocity() const
+  { return entity-&gt;velocity; }
+
+private:
+  void collision(const CollisionData&amp; data);
+  
+  void elastic_collision(const CollisionData&amp; data, const Physics&amp; other);
+  void bounce_collision(const CollisionData&amp; data);
+
+  Entity* entity;
+  float mass;
+  float bounciness;
+  Vector force;
+  float air_friction;
+  float contact_friction;
+
+  std::vector&lt;Slot&gt; slots;
+};
+
+#endif
+

Modified: trunk/src/player.cpp
===================================================================
--- trunk/src/player.cpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/player.cpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -57,7 +57,7 @@
   sprite.set_action(&quot;Stand&quot;);
 
   // collision detection init
-  c_object = new CollisionObject(Rectf(-15, -120, 15, 0));
+  c_object = new CollisionObject(this, Rectf(-15, -120, 15, 0));
 
   c_object-&gt;set_pos(pos);
   c_object-&gt;set_velocity(velocity);
@@ -576,12 +576,11 @@
 }
 
 void
-Player::collision(const CollisionData&amp; data, CollisionObject&amp; other)
+Player::collision(const CollisionData&amp; data)
 {
   // copy velocity, as &quot;velocity&quot; is the wanted velocity, whereas
   // cur_vel is the velocity in the current delta-frame
   Vector cur_vel = c_object-&gt;get_velocity(); 
-  (void) other;
   if (data.direction.y != 0)
     {
       cur_vel.y = 0;

Modified: trunk/src/player.hpp
===================================================================
--- trunk/src/player.hpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/player.hpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -98,7 +98,7 @@
   int get_max_energy() const;
   void hit(int points);
   
-  void collision(const CollisionData&amp; data, CollisionObject&amp; other);
+  void collision(const CollisionData&amp; data);
 
   Entity* find_useable_entity();
 

Modified: trunk/src/script_manager.cpp
===================================================================
--- trunk/src/script_manager.cpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/script_manager.cpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -15,8 +15,11 @@
 #include &quot;timer.hpp&quot;
 #include &quot;scripting/wrapper.hpp&quot;
 #include &quot;scripting/wrapper_util.hpp&quot;
+#include &quot;scripting/squirrel_error.hpp&quot;
 #include &quot;physfs/physfs_stream.hpp&quot;
 
+using namespace Scripting;
+
 ScriptManager* script_manager = 0;
 
 static void printfunc(HSQUIRRELVM, const char* str, ...)
@@ -55,7 +58,7 @@
   sq_setprintfunc(v, printfunc);
   
   // register windstille API
-  SquirrelWrapper::register_windstille_wrapper(v);
+  register_windstille_wrapper(v);
 }
 
 ScriptManager::~ScriptManager()
@@ -166,19 +169,6 @@
 }
 
 void
-ScriptManager::remove_object(const std::string&amp; name)
-{
-  sq_pushroottable(v);
-  sq_pushstring(v, name.c_str(), -1);
-  if(sq_deleteslot(v, -2, SQFalse) &lt; 0) {
-    std::ostringstream msg;
-    msg &lt;&lt; &quot;Couldn't remove squirrel object '&quot; &lt;&lt; name &lt;&lt; &quot;'&quot;;
-    throw SquirrelError(v, msg.str());
-  }
-  sq_pop(v, 1);
-}
-
-void
 ScriptManager::fire_wakeup_event(WakeupEvent event)
 {
   for(SquirrelVMs::iterator i = squirrel_vms.begin(); i != squirrel_vms.end(); ++i) {

Modified: trunk/src/script_manager.hpp
===================================================================
--- trunk/src/script_manager.hpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/script_manager.hpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -10,6 +10,12 @@
 #include &quot;scripting/wrapper.hpp&quot;
 #include &quot;scripting/wrapper_util.hpp&quot;
 
+/**
+ * This class is responsible for managing all running squirrel threads
+ * (called coroutines by others)
+ * It contains functions for loading and starting script, keeps a list of
+ * suspended scripts and receives wakeup events for them
+ */
 class ScriptManager
 {
 public:
@@ -22,30 +28,8 @@
   void run_script(const std::string&amp; string, const std::string&amp; sourcename);
   void run_script(std::istream&amp; in, const std::string&amp; sourcename);
 
-  template&lt;typename T&gt;
-  void expose_object(T* object, const std::string&amp; name, bool free)
+  HSQUIRRELVM get_vm() const
   {
-    // part1 of registration of the instance in the root table
-    sq_pushroottable(v);
-    sq_pushstring(v, name.c_str(), -1);
-
-    sq_pushroottable(v);
-    SquirrelWrapper::create_squirrel_instance(v, object, free);
-    sq_remove(v, -2);
-    
-    // register instance in root table
-    if(sq_createslot(v, -3) &lt; 0) {
-      std::ostringstream msg;
-      msg &lt;&lt; &quot;Couldn't register object '&quot; &lt;&lt; name &lt;&lt; &quot;' in squirrel root table&quot;;
-      throw SquirrelError(v, msg.str());
-    }
-
-    sq_pop(v, 1);
-  }
-  void remove_object(const std::string&amp; name);
-
-  HSQUIRRELVM get_vm()
-  {
     return v;
   }
 

Added: trunk/src/scripting/squirrel_error.cpp
===================================================================
--- trunk/src/scripting/squirrel_error.cpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/scripting/squirrel_error.cpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -0,0 +1,37 @@
+#include &lt;config.h&gt;
+
+#include &quot;squirrel_error.hpp&quot;
+#include &lt;sstream&gt;
+
+namespace Scripting
+{
+
+SquirrelError::SquirrelError(HSQUIRRELVM v, const std::string&amp; message) throw()
+{
+  std::ostringstream msg;
+  msg &lt;&lt; &quot;Squirrel error: &quot; &lt;&lt; message &lt;&lt; &quot; (&quot;;
+  const char* lasterr;
+  sq_getlasterror(v);
+  if(sq_gettype(v, -1) != OT_STRING)
+  {
+    lasterr = &quot;no error info&quot;;
+  }
+  else
+  {
+    sq_getstring(v, -1, &amp;lasterr);
+  }
+  sq_pop(v, 1);
+  msg &lt;&lt; lasterr &lt;&lt; &quot;)&quot;;
+  this-&gt;message = msg.str();
+}
+
+SquirrelError::~SquirrelError() throw()
+{}
+
+const char*
+SquirrelError::what() const throw()
+{
+  return message.c_str();
+}
+
+}

Added: trunk/src/scripting/squirrel_error.hpp
===================================================================
--- trunk/src/scripting/squirrel_error.hpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/scripting/squirrel_error.hpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -0,0 +1,28 @@
+#ifndef __SQUIRREL_ERROR_HPP__
+#define __SQUIRREL_ERROR_HPP__
+
+#include &lt;squirrel.h&gt;
+#include &lt;stdexcept&gt;
+
+namespace Scripting
+{
+
+/** Exception class for squirrel errors, it takes a squirrelvm and uses
+ * sq_geterror() to retrieve additional information about the last error that
+ * occured and creates a readable message from that.
+ */
+class SquirrelError : public std::exception
+{
+public:
+  SquirrelError(HSQUIRRELVM v, const std::string&amp; message) throw();
+  virtual ~SquirrelError() throw();
+
+  const char* what() const throw();
+private:
+  std::string message;
+};
+
+}
+
+#endif
+

Modified: trunk/src/scripting/wrapper.cpp
===================================================================
--- trunk/src/scripting/wrapper.cpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/scripting/wrapper.cpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -8,12 +8,15 @@
 #include &lt;new&gt;
 #include &lt;assert.h&gt;
 #include &lt;string&gt;
+#include &lt;sstream&gt;
 #include &lt;squirrel.h&gt;
-#include &quot;wrapper_util.hpp&quot;
+#include &quot;squirrel_error.hpp&quot;
 #include &quot;wrapper.interface.hpp&quot;
 
-namespace SquirrelWrapper
+namespace Scripting
 {
+namespace Wrapper
+{
 
 static int GameObject_release_hook(SQUserPointer ptr, int )
 {
@@ -22,27 +25,6 @@
   return 0;
 }
 
-void create_squirrel_instance(HSQUIRRELVM v, Scripting::GameObject* object, bool setup_releasehook)
-{
-  sq_pushstring(v, &quot;GameObject&quot;, -1);
-  if(sq_get(v, -2) &lt; 0) {
-    std::ostringstream msg;
-    msg &lt;&lt; &quot;Couldn't resolved squirrel type 'GameObject'&quot;;
-    throw SquirrelError(v, msg.str());
-  }
-
-  if(sq_createinstance(v, -1) &lt; 0 || sq_setinstanceup(v, -1, object) &lt; 0) {
-    std::ostringstream msg;
-    msg &lt;&lt; &quot;Couldn't setup squirrel instance for object of type 'GameObject'&quot;;
-    throw SquirrelError(v, msg.str());
-  }
-  sq_remove(v, -2);
-
-  if(setup_releasehook) {
-    sq_setreleasehook(v, -1, GameObject_release_hook);
-  }
-}
-
 static int GameObject_get_name_wrapper(HSQUIRRELVM v)
 {
   Scripting::GameObject* _this;
@@ -95,27 +77,6 @@
   return 0;
 }
 
-void create_squirrel_instance(HSQUIRRELVM v, Scripting::TestObject* object, bool setup_releasehook)
-{
-  sq_pushstring(v, &quot;TestObject&quot;, -1);
-  if(sq_get(v, -2) &lt; 0) {
-    std::ostringstream msg;
-    msg &lt;&lt; &quot;Couldn't resolved squirrel type 'TestObject'&quot;;
-    throw SquirrelError(v, msg.str());
-  }
-
-  if(sq_createinstance(v, -1) &lt; 0 || sq_setinstanceup(v, -1, object) &lt; 0) {
-    std::ostringstream msg;
-    msg &lt;&lt; &quot;Couldn't setup squirrel instance for object of type 'TestObject'&quot;;
-    throw SquirrelError(v, msg.str());
-  }
-  sq_remove(v, -2);
-
-  if(setup_releasehook) {
-    sq_setreleasehook(v, -1, TestObject_release_hook);
-  }
-}
-
 static int TestObject_set_sprite_wrapper(HSQUIRRELVM v)
 {
   Scripting::TestObject* _this;
@@ -187,27 +148,6 @@
   return 0;
 }
 
-void create_squirrel_instance(HSQUIRRELVM v, Scripting::Player* object, bool setup_releasehook)
-{
-  sq_pushstring(v, &quot;Player&quot;, -1);
-  if(sq_get(v, -2) &lt; 0) {
-    std::ostringstream msg;
-    msg &lt;&lt; &quot;Couldn't resolved squirrel type 'Player'&quot;;
-    throw SquirrelError(v, msg.str());
-  }
-
-  if(sq_createinstance(v, -1) &lt; 0 || sq_setinstanceup(v, -1, object) &lt; 0) {
-    std::ostringstream msg;
-    msg &lt;&lt; &quot;Couldn't setup squirrel instance for object of type 'Player'&quot;;
-    throw SquirrelError(v, msg.str());
-  }
-  sq_remove(v, -2);
-
-  if(setup_releasehook) {
-    sq_setreleasehook(v, -1, Player_release_hook);
-  }
-}
-
 static int Player_start_listening_wrapper(HSQUIRRELVM v)
 {
   Scripting::Player* _this;
@@ -235,27 +175,6 @@
   return 0;
 }
 
-void create_squirrel_instance(HSQUIRRELVM v, Scripting::ScriptableObject* object, bool setup_releasehook)
-{
-  sq_pushstring(v, &quot;ScriptableObject&quot;, -1);
-  if(sq_get(v, -2) &lt; 0) {
-    std::ostringstream msg;
-    msg &lt;&lt; &quot;Couldn't resolved squirrel type 'ScriptableObject'&quot;;
-    throw SquirrelError(v, msg.str());
-  }
-
-  if(sq_createinstance(v, -1) &lt; 0 || sq_setinstanceup(v, -1, object) &lt; 0) {
-    std::ostringstream msg;
-    msg &lt;&lt; &quot;Couldn't setup squirrel instance for object of type 'ScriptableObject'&quot;;
-    throw SquirrelError(v, msg.str());
-  }
-  sq_remove(v, -2);
-
-  if(setup_releasehook) {
-    sq_setreleasehook(v, -1, ScriptableObject_release_hook);
-  }
-}
-
 static int ScriptableObject_move_to_wrapper(HSQUIRRELVM v)
 {
   Scripting::ScriptableObject* _this;
@@ -577,12 +496,120 @@
   return Scripting::spawn_object(v);
 }
 
+} // end of namespace Wrapper
+
+void create_squirrel_instance(HSQUIRRELVM v, Scripting::GameObject* object, bool setup_releasehook)
+{
+  using namespace Wrapper;
+
+  sq_pushroottable(v);
+  sq_pushstring(v, &quot;GameObject&quot;, -1);
+  if(SQ_FAILED(sq_get(v, -2))) {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;Couldn't resolved squirrel type 'GameObject'&quot;;
+    throw SquirrelError(v, msg.str());
+  }
+
+  if(SQ_FAILED(sq_createinstance(v, -1)) || SQ_FAILED(sq_setinstanceup(v, -1, object))) {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;Couldn't setup squirrel instance for object of type 'GameObject'&quot;;
+    throw SquirrelError(v, msg.str());
+  }
+  sq_remove(v, -2); // remove object name
+
+  if(setup_releasehook) {
+    sq_setreleasehook(v, -1, GameObject_release_hook);
+  }
+
+  sq_remove(v, -2); // remove root table
+}
+
+void create_squirrel_instance(HSQUIRRELVM v, Scripting::TestObject* object, bool setup_releasehook)
+{
+  using namespace Wrapper;
+
+  sq_pushroottable(v);
+  sq_pushstring(v, &quot;TestObject&quot;, -1);
+  if(SQ_FAILED(sq_get(v, -2))) {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;Couldn't resolved squirrel type 'TestObject'&quot;;
+    throw SquirrelError(v, msg.str());
+  }
+
+  if(SQ_FAILED(sq_createinstance(v, -1)) || SQ_FAILED(sq_setinstanceup(v, -1, object))) {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;Couldn't setup squirrel instance for object of type 'TestObject'&quot;;
+    throw SquirrelError(v, msg.str());
+  }
+  sq_remove(v, -2); // remove object name
+
+  if(setup_releasehook) {
+    sq_setreleasehook(v, -1, TestObject_release_hook);
+  }
+
+  sq_remove(v, -2); // remove root table
+}
+
+void create_squirrel_instance(HSQUIRRELVM v, Scripting::Player* object, bool setup_releasehook)
+{
+  using namespace Wrapper;
+
+  sq_pushroottable(v);
+  sq_pushstring(v, &quot;Player&quot;, -1);
+  if(SQ_FAILED(sq_get(v, -2))) {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;Couldn't resolved squirrel type 'Player'&quot;;
+    throw SquirrelError(v, msg.str());
+  }
+
+  if(SQ_FAILED(sq_createinstance(v, -1)) || SQ_FAILED(sq_setinstanceup(v, -1, object))) {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;Couldn't setup squirrel instance for object of type 'Player'&quot;;
+    throw SquirrelError(v, msg.str());
+  }
+  sq_remove(v, -2); // remove object name
+
+  if(setup_releasehook) {
+    sq_setreleasehook(v, -1, Player_release_hook);
+  }
+
+  sq_remove(v, -2); // remove root table
+}
+
+void create_squirrel_instance(HSQUIRRELVM v, Scripting::ScriptableObject* object, bool setup_releasehook)
+{
+  using namespace Wrapper;
+
+  sq_pushroottable(v);
+  sq_pushstring(v, &quot;ScriptableObject&quot;, -1);
+  if(SQ_FAILED(sq_get(v, -2))) {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;Couldn't resolved squirrel type 'ScriptableObject'&quot;;
+    throw SquirrelError(v, msg.str());
+  }
+
+  if(SQ_FAILED(sq_createinstance(v, -1)) || SQ_FAILED(sq_setinstanceup(v, -1, object))) {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;Couldn't setup squirrel instance for object of type 'ScriptableObject'&quot;;
+    throw SquirrelError(v, msg.str());
+  }
+  sq_remove(v, -2); // remove object name
+
+  if(setup_releasehook) {
+    sq_setreleasehook(v, -1, ScriptableObject_release_hook);
+  }
+
+  sq_remove(v, -2); // remove root table
+}
+
 void register_windstille_wrapper(HSQUIRRELVM v)
 {
+  using namespace Wrapper;
+
   sq_pushroottable(v);
   sq_pushstring(v, &quot;VCENTER&quot;, -1);
   sq_pushinteger(v, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register constant'VCENTER'&quot;;
     throw SquirrelError(v, msg.str());
@@ -590,7 +617,7 @@
 
   sq_pushstring(v, &quot;LEFT&quot;, -1);
   sq_pushinteger(v, 1);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register constant'LEFT'&quot;;
     throw SquirrelError(v, msg.str());
@@ -598,7 +625,7 @@
 
   sq_pushstring(v, &quot;RIGHT&quot;, -1);
   sq_pushinteger(v, 2);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register constant'RIGHT'&quot;;
     throw SquirrelError(v, msg.str());
@@ -606,7 +633,7 @@
 
   sq_pushstring(v, &quot;HCENTER&quot;, -1);
   sq_pushinteger(v, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register constant'HCENTER'&quot;;
     throw SquirrelError(v, msg.str());
@@ -614,7 +641,7 @@
 
   sq_pushstring(v, &quot;TOP&quot;, -1);
   sq_pushinteger(v, 16);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register constant'TOP'&quot;;
     throw SquirrelError(v, msg.str());
@@ -622,7 +649,7 @@
 
   sq_pushstring(v, &quot;BOTTOM&quot;, -1);
   sq_pushinteger(v, 32);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register constant'BOTTOM'&quot;;
     throw SquirrelError(v, msg.str());
@@ -630,7 +657,7 @@
 
   sq_pushstring(v, &quot;set_sector&quot;, -1);
   sq_newclosure(v, &amp;set_sector_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'set_sector'&quot;;
     throw SquirrelError(v, msg.str());
@@ -638,7 +665,7 @@
 
   sq_pushstring(v, &quot;play_music&quot;, -1);
   sq_newclosure(v, &amp;play_music_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'play_music'&quot;;
     throw SquirrelError(v, msg.str());
@@ -646,7 +673,7 @@
 
   sq_pushstring(v, &quot;stop_music&quot;, -1);
   sq_newclosure(v, &amp;stop_music_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'stop_music'&quot;;
     throw SquirrelError(v, msg.str());
@@ -654,7 +681,7 @@
 
   sq_pushstring(v, &quot;play_sound&quot;, -1);
   sq_newclosure(v, &amp;play_sound_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'play_sound'&quot;;
     throw SquirrelError(v, msg.str());
@@ -662,7 +689,7 @@
 
   sq_pushstring(v, &quot;add_caption&quot;, -1);
   sq_newclosure(v, &amp;add_caption_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'add_caption'&quot;;
     throw SquirrelError(v, msg.str());
@@ -670,7 +697,7 @@
 
   sq_pushstring(v, &quot;end_caption&quot;, -1);
   sq_newclosure(v, &amp;end_caption_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'end_caption'&quot;;
     throw SquirrelError(v, msg.str());
@@ -678,7 +705,7 @@
 
   sq_pushstring(v, &quot;set_view&quot;, -1);
   sq_newclosure(v, &amp;set_view_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'set_view'&quot;;
     throw SquirrelError(v, msg.str());
@@ -686,7 +713,7 @@
 
   sq_pushstring(v, &quot;set_camera_active&quot;, -1);
   sq_newclosure(v, &amp;set_camera_active_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'set_camera_active'&quot;;
     throw SquirrelError(v, msg.str());
@@ -694,7 +721,7 @@
 
   sq_pushstring(v, &quot;set_controller_help_active&quot;, -1);
   sq_newclosure(v, &amp;set_controller_help_active_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'set_controller_help_active'&quot;;
     throw SquirrelError(v, msg.str());
@@ -702,7 +729,7 @@
 
   sq_pushstring(v, &quot;dialog_show&quot;, -1);
   sq_newclosure(v, &amp;dialog_show_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'dialog_show'&quot;;
     throw SquirrelError(v, msg.str());
@@ -710,7 +737,7 @@
 
   sq_pushstring(v, &quot;wait_for_dialog&quot;, -1);
   sq_newclosure(v, &amp;wait_for_dialog_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'wait_for_dialog'&quot;;
     throw SquirrelError(v, msg.str());
@@ -718,7 +745,7 @@
 
   sq_pushstring(v, &quot;conversation_add&quot;, -1);
   sq_newclosure(v, &amp;conversation_add_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'conversation_add'&quot;;
     throw SquirrelError(v, msg.str());
@@ -726,7 +753,7 @@
 
   sq_pushstring(v, &quot;conversation_show&quot;, -1);
   sq_newclosure(v, &amp;conversation_show_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'conversation_show'&quot;;
     throw SquirrelError(v, msg.str());
@@ -734,7 +761,7 @@
 
   sq_pushstring(v, &quot;conversation_get_selection&quot;, -1);
   sq_newclosure(v, &amp;conversation_get_selection_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'conversation_get_selection'&quot;;
     throw SquirrelError(v, msg.str());
@@ -742,7 +769,7 @@
 
   sq_pushstring(v, &quot;wait_for_conversation&quot;, -1);
   sq_newclosure(v, &amp;wait_for_conversation_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'wait_for_conversation'&quot;;
     throw SquirrelError(v, msg.str());
@@ -750,7 +777,7 @@
 
   sq_pushstring(v, &quot;run_before&quot;, -1);
   sq_newclosure(v, &amp;run_before_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'run_before'&quot;;
     throw SquirrelError(v, msg.str());
@@ -758,7 +785,7 @@
 
   sq_pushstring(v, &quot;save_state&quot;, -1);
   sq_newclosure(v, &amp;save_state_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'save_state'&quot;;
     throw SquirrelError(v, msg.str());
@@ -766,7 +793,7 @@
 
   sq_pushstring(v, &quot;load_state&quot;, -1);
   sq_newclosure(v, &amp;load_state_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'load_state'&quot;;
     throw SquirrelError(v, msg.str());
@@ -774,7 +801,7 @@
 
   sq_pushstring(v, &quot;list_objects&quot;, -1);
   sq_newclosure(v, &amp;list_objects_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'list_objects'&quot;;
     throw SquirrelError(v, msg.str());
@@ -782,7 +809,7 @@
 
   sq_pushstring(v, &quot;set_debug&quot;, -1);
   sq_newclosure(v, &amp;set_debug_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'set_debug'&quot;;
     throw SquirrelError(v, msg.str());
@@ -790,7 +817,7 @@
 
   sq_pushstring(v, &quot;get_debug&quot;, -1);
   sq_newclosure(v, &amp;get_debug_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'get_debug'&quot;;
     throw SquirrelError(v, msg.str());
@@ -798,7 +825,7 @@
 
   sq_pushstring(v, &quot;get_game_speed&quot;, -1);
   sq_newclosure(v, &amp;get_game_speed_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'get_game_speed'&quot;;
     throw SquirrelError(v, msg.str());
@@ -806,7 +833,7 @@
 
   sq_pushstring(v, &quot;set_game_speed&quot;, -1);
   sq_newclosure(v, &amp;set_game_speed_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'set_game_speed'&quot;;
     throw SquirrelError(v, msg.str());
@@ -814,7 +841,7 @@
 
   sq_pushstring(v, &quot;get_text_speed&quot;, -1);
   sq_newclosure(v, &amp;get_text_speed_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'get_text_speed'&quot;;
     throw SquirrelError(v, msg.str());
@@ -822,7 +849,7 @@
 
   sq_pushstring(v, &quot;set_text_speed&quot;, -1);
   sq_newclosure(v, &amp;set_text_speed_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'set_text_speed'&quot;;
     throw SquirrelError(v, msg.str());
@@ -830,7 +857,7 @@
 
   sq_pushstring(v, &quot;wait&quot;, -1);
   sq_newclosure(v, &amp;wait_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'wait'&quot;;
     throw SquirrelError(v, msg.str());
@@ -838,7 +865,7 @@
 
   sq_pushstring(v, &quot;display&quot;, -1);
   sq_newclosure(v, &amp;display_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'display'&quot;;
     throw SquirrelError(v, msg.str());
@@ -846,7 +873,7 @@
 
   sq_pushstring(v, &quot;println&quot;, -1);
   sq_newclosure(v, &amp;println_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'println'&quot;;
     throw SquirrelError(v, msg.str());
@@ -854,7 +881,7 @@
 
   sq_pushstring(v, &quot;set_console_font&quot;, -1);
   sq_newclosure(v, &amp;set_console_font_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'set_console_font'&quot;;
     throw SquirrelError(v, msg.str());
@@ -862,7 +889,7 @@
 
   sq_pushstring(v, &quot;spawn_object&quot;, -1);
   sq_newclosure(v, &amp;spawn_object_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'spawn_object'&quot;;
     throw SquirrelError(v, msg.str());
@@ -877,7 +904,7 @@
   }
   sq_pushstring(v, &quot;get_name&quot;, -1);
   sq_newclosure(v, &amp;GameObject_get_name_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'get_name'&quot;;
     throw SquirrelError(v, msg.str());
@@ -885,7 +912,7 @@
 
   sq_pushstring(v, &quot;remove&quot;, -1);
   sq_newclosure(v, &amp;GameObject_remove_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'remove'&quot;;
     throw SquirrelError(v, msg.str());
@@ -893,7 +920,7 @@
 
   sq_pushstring(v, &quot;set_active&quot;, -1);
   sq_newclosure(v, &amp;GameObject_set_active_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'set_active'&quot;;
     throw SquirrelError(v, msg.str());
@@ -901,13 +928,13 @@
 
   sq_pushstring(v, &quot;set_parent&quot;, -1);
   sq_newclosure(v, &amp;GameObject_set_parent_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'set_parent'&quot;;
     throw SquirrelError(v, msg.str());
   }
 
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register class'GameObject'&quot;;
     throw SquirrelError(v, msg.str());
@@ -924,7 +951,7 @@
   }
   sq_pushstring(v, &quot;set_sprite&quot;, -1);
   sq_newclosure(v, &amp;TestObject_set_sprite_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'set_sprite'&quot;;
     throw SquirrelError(v, msg.str());
@@ -932,7 +959,7 @@
 
   sq_pushstring(v, &quot;set_action&quot;, -1);
   sq_newclosure(v, &amp;TestObject_set_action_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'set_action'&quot;;
     throw SquirrelError(v, msg.str());
@@ -940,7 +967,7 @@
 
   sq_pushstring(v, &quot;set_pos&quot;, -1);
   sq_newclosure(v, &amp;TestObject_set_pos_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'set_pos'&quot;;
     throw SquirrelError(v, msg.str());
@@ -948,7 +975,7 @@
 
   sq_pushstring(v, &quot;set_vflip&quot;, -1);
   sq_newclosure(v, &amp;TestObject_set_vflip_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'set_vflip'&quot;;
     throw SquirrelError(v, msg.str());
@@ -956,13 +983,13 @@
 
   sq_pushstring(v, &quot;attach&quot;, -1);
   sq_newclosure(v, &amp;TestObject_attach_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'attach'&quot;;
     throw SquirrelError(v, msg.str());
   }
 
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register class'TestObject'&quot;;
     throw SquirrelError(v, msg.str());
@@ -979,7 +1006,7 @@
   }
   sq_pushstring(v, &quot;start_listening&quot;, -1);
   sq_newclosure(v, &amp;Player_start_listening_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'start_listening'&quot;;
     throw SquirrelError(v, msg.str());
@@ -987,13 +1014,13 @@
 
   sq_pushstring(v, &quot;stop_listening&quot;, -1);
   sq_newclosure(v, &amp;Player_stop_listening_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'stop_listening'&quot;;
     throw SquirrelError(v, msg.str());
   }
 
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register class'Player'&quot;;
     throw SquirrelError(v, msg.str());
@@ -1010,7 +1037,7 @@
   }
   sq_pushstring(v, &quot;move_to&quot;, -1);
   sq_newclosure(v, &amp;ScriptableObject_move_to_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'move_to'&quot;;
     throw SquirrelError(v, msg.str());
@@ -1018,13 +1045,13 @@
 
   sq_pushstring(v, &quot;start_flash&quot;, -1);
   sq_newclosure(v, &amp;ScriptableObject_start_flash_wrapper, 0);
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register function'start_flash'&quot;;
     throw SquirrelError(v, msg.str());
   }
 
-  if(sq_createslot(v, -3) &lt; 0) {
+  if(SQ_FAILED(sq_createslot(v, -3))) {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't register class'ScriptableObject'&quot;;
     throw SquirrelError(v, msg.str());
@@ -1033,5 +1060,5 @@
   sq_pop(v, 1);
 }
 
-}
+} // end of namespace Scripting
 

Modified: trunk/src/scripting/wrapper.hpp
===================================================================
--- trunk/src/scripting/wrapper.hpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/scripting/wrapper.hpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -9,7 +9,7 @@
 #include &lt;squirrel.h&gt;
 #include &quot;wrapper.interface.hpp&quot;
 
-namespace SquirrelWrapper
+namespace Scripting
 {
 
 void register_windstille_wrapper(HSQUIRRELVM v);

Modified: trunk/src/scripting/wrapper_util.cpp
===================================================================
--- trunk/src/scripting/wrapper_util.cpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/scripting/wrapper_util.cpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -180,31 +180,4 @@
     printf(&quot;--------------------------------------------------------------\n&quot;);
 }
 
-//----------------------------------------------------------------------------
-
-SquirrelError::SquirrelError(HSQUIRRELVM v, const std::string&amp; message) throw()
-{
-  std::ostringstream msg;
-  msg &lt;&lt; &quot;Squirrel error: &quot; &lt;&lt; message &lt;&lt; &quot; (&quot;;
-  const char* lasterr;
-  sq_getlasterror(v);
-  if(sq_gettype(v, -1) != OT_STRING) {
-    lasterr = &quot;no error info&quot;;
-  } else {
-    sq_getstring(v, -1, &amp;lasterr);
-  }
-  sq_pop(v, 1);
-  msg &lt;&lt; lasterr &lt;&lt; &quot;)&quot;;
-  this-&gt;message = msg.str();
-}
-
-SquirrelError::~SquirrelError() throw()
-{}
-
-const char*
-SquirrelError::what() const throw()
-{
-  return message.c_str();
-}
-
 /* EOF */

Modified: trunk/src/scripting/wrapper_util.hpp
===================================================================
--- trunk/src/scripting/wrapper_util.hpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/scripting/wrapper_util.hpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -2,21 +2,9 @@
 #define __WRAPPERUTIL_HPP__
 
 #include &lt;squirrel.h&gt;
-#include &lt;exception&gt;
 #include &lt;sstream&gt;
 #include &lt;string&gt;
 
-class SquirrelError : public std::exception
-{
-public:
-  SquirrelError(HSQUIRRELVM v, const std::string&amp; message) throw();
-  virtual ~SquirrelError() throw();
-
-  const char* what() const throw();
-private:
-  std::string message;
-};
-
 std::string squirrel2string(HSQUIRRELVM v, int i);
 void print_squirrel_stack(HSQUIRRELVM v);
 

Modified: trunk/src/sector.cpp
===================================================================
--- trunk/src/sector.cpp	2005-08-09 18:17:19 UTC (rev 950)
+++ trunk/src/sector.cpp	2005-08-10 22:26:40 UTC (rev 951)
@@ -16,6 +16,7 @@
 //  You should have received a copy of the GNU General Public License
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+#include &lt;config.h&gt;
 
 #include &lt;iostream&gt;
 #include &lt;sstream&gt;
@@ -46,12 +47,22 @@
 #include &quot;badguy/spider_mine.hpp&quot;
 #include &quot;box.hpp&quot;
 #include &quot;scriptable_object.hpp&quot;
+#include &quot;scripting/squirrel_error.hpp&quot;
 
+// The table (works like a namespace here) where the game objects will appear
+#define OBJECTS_TABLE &quot;objects&quot;
+
 Sector* Sector::current_ = 0;
 
 Sector::Sector(const std::string&amp; filename)
   : player(0)
 {
+  // make sure squirrel has an &quot;objects&quot; table
+  script_manager-&gt;run_script(
+      &quot;if(! (\&quot;&quot; OBJECTS_TABLE &quot;\&quot; in this)) {&quot;
+      &quot;  &quot; OBJECTS_TABLE &quot; &lt;- {};&quot;
+      &quot;}&quot;, &quot;&quot;);
+  
   if (debug) std::cout &lt;&lt; &quot;Creating new Sector&quot; &lt;&lt; std::endl;
   collision_engine = new CollisionEngine();
 
@@ -274,40 +285,88 @@
 void
 Sector::remove_object_from_squirrel(GameObject* object)
 {
-  script_manager-&gt;remove_object(object-&gt;get_name());
+  using namespace Scripting;
+
+  // get objects table
+  HSQUIRRELVM v = script_manager-&gt;get_vm();
+  sq_pushroottable(v);
+  sq_pushstring(v, OBJECTS_TABLE, -1);
+  if(SQ_FAILED(sq_get(v, -2)))
+  {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;Couldn't get objects table '&quot; &lt;&lt; OBJECTS_TABLE &lt;&lt; &quot;'&quot;;
+    throw SquirrelError(v, msg.str());
+  }
+
+  // remove object from table
+  sq_pushstring(v, object-&gt;get_name().c_str(), object-&gt;get_name().size());
+  if(SQ_FAILED(sq_deleteslot(v, -2, SQFalse) &lt; 0)) {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;Couldn't remove squirrel object for '&quot; &lt;&lt; object-&gt;get_name()
+        &lt;&lt; &quot;'&quot;;
+    throw SquirrelError(v, msg.str());
+  }
+  
+  // pop objects and root table
+  sq_pop(v, 2);
 }
 
-void
-Sector::expose_object_to_squirrel(GameObject* object)
+// tries to find out the &quot;real&quot; class of an gameobject by some dynamic casting
+// and creates a matching squirrel instance for that object
+static inline void create_squirrel_instance(HSQUIRRELVM v, GameObject* object)
 {
-  // FIXME: Grumbel: I don't consider this brute-force exposing a good
-  // idea, should be up to the scripter if we ones to keep a refrence
-  // to an object or not
   ScriptableObject* script_obj = dynamic_cast&lt;ScriptableObject*&gt; (object);
   if(script_obj) {
-    script_manager-&gt;expose_object(new Scripting::ScriptableObject(script_obj),
-                                  object-&gt;get_name(), true);
+    create_squirrel_instance(v, new Scripting::ScriptableObject(script_obj),
+                             true);
     return;
   }
-
+  
   TestObject* tobj = dynamic_cast&lt;TestObject*&gt; (object);
   if(tobj) {
-    script_manager-&gt;expose_object(new Scripting::TestObject(tobj),
-                                  object-&gt;get_name(), true);
+    create_squirrel_instance(v, new Scripting::TestObject(tobj), true);
     return;
-  }
+  }                                                                             
 
   Player* player = dynamic_cast&lt;Player*&gt; (object);
   if(player) {
-    script_manager-&gt;expose_object(new Scripting::Player(player),
-                                  object-&gt;get_name(), true);
+    create_squirrel_instance(v, new Scripting::Player(player), true);
     return;
   }
 
-  script_manager-&gt;expose_object(new Scripting::GameObject(object),
-                                object-&gt;get_name(), true);
+  create_squirrel_instance(v, new Scripting::GameObject(object), true);
 }
 
+void
+Sector::expose_object_to_squirrel(GameObject* object)
+{
+  using namespace Scripting;
+
+  // get objects table
+  HSQUIRRELVM v = script_manager-&gt;get_vm();
+  sq_pushroottable(v);
+  sq_pushstring(v, OBJECTS_TABLE, -1);
+  if(SQ_FAILED(sq_get(v, -2)))
+  {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;Couldn't get objects table '&quot; &lt;&lt; OBJECTS_TABLE &lt;&lt; &quot;'&quot;;
+    throw SquirrelError(v, msg.str());
+  }
+  
+  // create squirrel instance and register in table
+  sq_pushstring(v, object-&gt;get_name().c_str(), object-&gt;get_name().size());
+  create_squirrel_instance(v, object);
+  if(SQ_FAILED(sq_createslot(v, -3)))
+  {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;Couldn't register object in objects tab&#246;e&quot;;
+    throw SquirrelError(v, msg.str());
+  }
+
+  // pop roottable and objects table
+  sq_pop(v, 2);
+}
+
 GameObject*
 Sector::get_object(const std::string&amp; name) const
 {


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000603.html">[Windstille-commit] r950 - in trunk/src: . badguy
</A></li>
	<LI>Next message: <A HREF="000605.html">[Windstille-commit] r952 - trunk/data/images
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#604">[ date ]</a>
              <a href="thread.html#604">[ thread ]</a>
              <a href="subject.html#604">[ subject ]</a>
              <a href="author.html#604">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/windstille-commit">More information about the Windstille-commit
mailing list</a><br>
</body></html>
