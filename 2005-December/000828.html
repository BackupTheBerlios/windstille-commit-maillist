<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Windstille-commit] r1175 - in facebuilder: . data/ear data/glasses data/hair data/head examples
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/windstille-commit/2005-December/index.html" >
   <LINK REL="made" HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r1175%20-%20in%20facebuilder%3A%20.%20data/ear%20data/glasses%20data/hair%20data/head%20examples&In-Reply-To=%3C200512310338.jBV3cDsc029870%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000827.html">
   <LINK REL="Next"  HREF="000829.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Windstille-commit] r1175 - in facebuilder: . data/ear data/glasses data/hair data/head examples</H1>
    <B>grumbel at BerliOS</B> 
    <A HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r1175%20-%20in%20facebuilder%3A%20.%20data/ear%20data/glasses%20data/hair%20data/head%20examples&In-Reply-To=%3C200512310338.jBV3cDsc029870%40sheep.berlios.de%3E"
       TITLE="[Windstille-commit] r1175 - in facebuilder: . data/ear data/glasses data/hair data/head examples">grumbel at berlios.de
       </A><BR>
    <I>Sat Dec 31 04:38:13 CET 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000827.html">[Windstille-commit] r1174 - in facebuilder/data: eye eyebrow head mouth nose
</A></li>
        <LI>Next message: <A HREF="000829.html">[Windstille-commit] r1176 - facebuilder
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#828">[ date ]</a>
              <a href="thread.html#828">[ thread ]</a>
              <a href="subject.html#828">[ subject ]</a>
              <a href="author.html#828">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: grumbel
Date: 2005-12-31 04:37:55 +0100 (Sat, 31 Dec 2005)
New Revision: 1175

Added:
   facebuilder/data/hair/0032.png
   facebuilder/data/head/0013.png
   facebuilder/data/head/0014.png
   facebuilder/examples/male10.xml
   facebuilder/examples/male11.xml
Removed:
   facebuilder/data/glasses/0000.png
Modified:
   facebuilder/NEWS
   facebuilder/TODO
   facebuilder/data/ear/0000.png
   facebuilder/examples/pirate3.xml
   facebuilder/face.rb
   facebuilder/facebuilder.glade
   facebuilder/facebuilder.rb
Log:
- some bug fixes and some more faceparts

Modified: facebuilder/NEWS
===================================================================
--- facebuilder/NEWS	2005-12-30 00:11:51 UTC (rev 1174)
+++ facebuilder/NEWS	2005-12-31 03:37:55 UTC (rev 1175)
@@ -9,6 +9,7 @@
 * new buttons to center horizontal and vertical
 * fixed loading
 * quit properly when window close button is pressed
+* face part thumbnails are now cached
 
 
 FaceBuilder 0.1.0

Modified: facebuilder/TODO
===================================================================
--- facebuilder/TODO	2005-12-30 00:11:51 UTC (rev 1174)
+++ facebuilder/TODO	2005-12-31 03:37:55 UTC (rev 1175)
@@ -2,18 +2,12 @@
 | FaceBuilder ToDo
 +--------------
 
-* follow a few more GUI conventions
 * add much more face parts
 * adjust all face parts to follow a standard convention (pupils in
   center of the image, hair relative to the center of the face, etc) so that
   they are easier swapable without size and position adjustments
 * support for different sets, male/female, comic, realistic, etc
-* create a context-menu to center-x, center-y and similar stuff
 * add simple cloths
 * seperate hair into front and back
-* export to PNG
-* export to SVG
-* add GUI handles for scale and rotate
 
-
 # EOF #

Modified: facebuilder/data/ear/0000.png
===================================================================
(Binary files differ)

Deleted: facebuilder/data/glasses/0000.png
===================================================================
(Binary files differ)

Added: facebuilder/data/hair/0032.png
===================================================================
(Binary files differ)


Property changes on: facebuilder/data/hair/0032.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: facebuilder/data/head/0013.png
===================================================================
(Binary files differ)


Property changes on: facebuilder/data/head/0013.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: facebuilder/data/head/0014.png
===================================================================
(Binary files differ)


Property changes on: facebuilder/data/head/0014.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: facebuilder/examples/male10.xml
===================================================================
--- facebuilder/examples/male10.xml	2005-12-30 00:11:51 UTC (rev 1174)
+++ facebuilder/examples/male10.xml	2005-12-31 03:37:55 UTC (rev 1175)
@@ -0,0 +1,44 @@
+&lt;face&gt;
+  &lt;eye&gt;
+    &lt;filename&gt;data/eye/0016.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;40.0&lt;/x&gt;&lt;y&gt;-21.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;0.728445813714234&lt;/scale&gt;
+    &lt;rotation&gt;0&lt;/rotation&gt;
+  &lt;/eye&gt;
+  &lt;eyebrow&gt;
+    &lt;filename&gt;data/eyebrow/0005.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;39.0&lt;/x&gt;&lt;y&gt;-42.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;1.0&lt;/scale&gt;
+    &lt;rotation&gt;0&lt;/rotation&gt;
+  &lt;/eyebrow&gt;
+  &lt;nose&gt;
+    &lt;filename&gt;data/nose/0007.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;0.0&lt;/x&gt;&lt;y&gt;10.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;1.0&lt;/scale&gt;
+    &lt;rotation&gt;0.0&lt;/rotation&gt;
+  &lt;/nose&gt;
+  &lt;head&gt;
+    &lt;filename&gt;data/head/0013.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;0&lt;/x&gt;&lt;y&gt;-12.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;1.0&lt;/scale&gt;
+    &lt;rotation&gt;0&lt;/rotation&gt;
+  &lt;/head&gt;
+  &lt;ear&gt;
+    &lt;filename&gt;data/ear/0001.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;88.0&lt;/x&gt;&lt;y&gt;7.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;1.0&lt;/scale&gt;
+    &lt;rotation&gt;0.0&lt;/rotation&gt;
+  &lt;/ear&gt;
+  &lt;mouth&gt;
+    &lt;filename&gt;data/mouth/0009.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;1.0&lt;/x&gt;&lt;y&gt;71.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;0.942322334547044&lt;/scale&gt;
+    &lt;rotation&gt;0&lt;/rotation&gt;
+  &lt;/mouth&gt;
+  &lt;hair&gt;
+    &lt;filename&gt;data/hair/0030.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;7.0&lt;/x&gt;&lt;y&gt;-4.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;0.870560178613914&lt;/scale&gt;
+    &lt;rotation&gt;0.0&lt;/rotation&gt;
+  &lt;/hair&gt;
+&lt;/face&gt;

Added: facebuilder/examples/male11.xml
===================================================================
--- facebuilder/examples/male11.xml	2005-12-30 00:11:51 UTC (rev 1174)
+++ facebuilder/examples/male11.xml	2005-12-31 03:37:55 UTC (rev 1175)
@@ -0,0 +1,62 @@
+&lt;face&gt;
+  &lt;forehead&gt;
+    &lt;filename&gt;data/forehead/0000.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;0&lt;/x&gt;&lt;y&gt;-60.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;1.0&lt;/scale&gt;
+    &lt;rotation&gt;0.0&lt;/rotation&gt;
+  &lt;/forehead&gt;
+  &lt;mouth&gt;
+    &lt;filename&gt;data/mouth/0009.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;0.0&lt;/x&gt;&lt;y&gt;73.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;0.804263039093289&lt;/scale&gt;
+    &lt;rotation&gt;0.0&lt;/rotation&gt;
+  &lt;/mouth&gt;
+  &lt;hair&gt;
+    &lt;filename&gt;data/hair/0028.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;1.0&lt;/x&gt;&lt;y&gt;3.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;0.743014729988519&lt;/scale&gt;
+    &lt;rotation&gt;0.0&lt;/rotation&gt;
+  &lt;/hair&gt;
+  &lt;mouthfold&gt;
+    &lt;filename&gt;data/mouthfold/0000.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;30&lt;/x&gt;&lt;y&gt;67.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;1.0&lt;/scale&gt;
+    &lt;rotation&gt;0.0&lt;/rotation&gt;
+  &lt;/mouthfold&gt;
+  &lt;eye&gt;
+    &lt;filename&gt;data/eye/0005.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;33.0&lt;/x&gt;&lt;y&gt;-7.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;1.0&lt;/scale&gt;
+    &lt;rotation&gt;0.0&lt;/rotation&gt;
+  &lt;/eye&gt;
+  &lt;eyebrow&gt;
+    &lt;filename&gt;data/eyebrow/0005.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;37.0&lt;/x&gt;&lt;y&gt;-28.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;1.0404&lt;/scale&gt;
+    &lt;rotation&gt;0.0&lt;/rotation&gt;
+  &lt;/eyebrow&gt;
+  &lt;nose&gt;
+    &lt;filename&gt;data/nose/0010.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;0.0&lt;/x&gt;&lt;y&gt;20.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;1.061208&lt;/scale&gt;
+    &lt;rotation&gt;0&lt;/rotation&gt;
+  &lt;/nose&gt;
+  &lt;glasses&gt;
+    &lt;filename&gt;data/glasses/0010.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;1.0&lt;/x&gt;&lt;y&gt;-2.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;1.0&lt;/scale&gt;
+    &lt;rotation&gt;0.0&lt;/rotation&gt;
+  &lt;/glasses&gt;
+  &lt;head&gt;
+    &lt;filename&gt;data/head/0013.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;0&lt;/x&gt;&lt;y&gt;0.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;0.942322334547044&lt;/scale&gt;
+    &lt;rotation&gt;0.0&lt;/rotation&gt;
+  &lt;/head&gt;
+  &lt;ear&gt;
+    &lt;filename&gt;data/ear/0001.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;84.0&lt;/x&gt;&lt;y&gt;15.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;1.0&lt;/scale&gt;
+    &lt;rotation&gt;0&lt;/rotation&gt;
+  &lt;/ear&gt;
+&lt;/face&gt;

Modified: facebuilder/examples/pirate3.xml
===================================================================
--- facebuilder/examples/pirate3.xml	2005-12-30 00:11:51 UTC (rev 1174)
+++ facebuilder/examples/pirate3.xml	2005-12-31 03:37:55 UTC (rev 1175)
@@ -1,62 +1,62 @@
 &lt;face&gt;
+  &lt;mouth&gt;
+    &lt;filename&gt;data/mouth/0008.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;-1.0&lt;/x&gt;&lt;y&gt;58.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;0.853490371190111&lt;/scale&gt;
+    &lt;rotation&gt;0.0&lt;/rotation&gt;
+  &lt;/mouth&gt;
+  &lt;hair&gt;
+    &lt;filename&gt;data/hair/0029.png&lt;/filename&gt;
+    &lt;offset&gt;&lt;x&gt;-1.0&lt;/x&gt;&lt;y&gt;-3.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;scale&gt;0.757875024588289&lt;/scale&gt;
+    &lt;rotation&gt;0.0&lt;/rotation&gt;
+  &lt;/hair&gt;
   &lt;hat&gt;
     &lt;filename&gt;data/hat/0003.png&lt;/filename&gt;
-    &lt;offset&gt;&lt;x&gt;2.0&lt;/x&gt;&lt;y&gt;-25.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;offset&gt;&lt;x&gt;2.0&lt;/x&gt;&lt;y&gt;-72.0&lt;/y&gt;&lt;/offset&gt;
     &lt;scale&gt;1.061208&lt;/scale&gt;
     &lt;rotation&gt;0.0&lt;/rotation&gt;
   &lt;/hat&gt;
   &lt;eye&gt;
     &lt;filename&gt;data/eye/0005.png&lt;/filename&gt;
-    &lt;offset&gt;&lt;x&gt;34.0&lt;/x&gt;&lt;y&gt;27.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;offset&gt;&lt;x&gt;34.0&lt;/x&gt;&lt;y&gt;-20.0&lt;/y&gt;&lt;/offset&gt;
     &lt;scale&gt;0.961168781237985&lt;/scale&gt;
     &lt;rotation&gt;0.0&lt;/rotation&gt;
   &lt;/eye&gt;
   &lt;beard&gt;
     &lt;filename&gt;data/beard/0001.png&lt;/filename&gt;
-    &lt;offset&gt;&lt;x&gt;-1.0&lt;/x&gt;&lt;y&gt;54.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;offset&gt;&lt;x&gt;-1.0&lt;/x&gt;&lt;y&gt;7.0&lt;/y&gt;&lt;/offset&gt;
     &lt;scale&gt;0.728445813714234&lt;/scale&gt;
     &lt;rotation&gt;0.0&lt;/rotation&gt;
   &lt;/beard&gt;
   &lt;eyebrow&gt;
     &lt;filename&gt;data/eyebrow/0005.png&lt;/filename&gt;
-    &lt;offset&gt;&lt;x&gt;35.0&lt;/x&gt;&lt;y&gt;10.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;offset&gt;&lt;x&gt;35.0&lt;/x&gt;&lt;y&gt;-37.0&lt;/y&gt;&lt;/offset&gt;
     &lt;scale&gt;0.757875024588288&lt;/scale&gt;
     &lt;rotation&gt;-6.0&lt;/rotation&gt;
   &lt;/eyebrow&gt;
   &lt;nose&gt;
     &lt;filename&gt;data/nose/0007.png&lt;/filename&gt;
-    &lt;offset&gt;&lt;x&gt;0.0&lt;/x&gt;&lt;y&gt;46.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;offset&gt;&lt;x&gt;0.0&lt;/x&gt;&lt;y&gt;-1.0&lt;/y&gt;&lt;/offset&gt;
     &lt;scale&gt;0.923845426026514&lt;/scale&gt;
     &lt;rotation&gt;0.0&lt;/rotation&gt;
   &lt;/nose&gt;
   &lt;glasses&gt;
     &lt;filename&gt;data/glasses/0004.png&lt;/filename&gt;
-    &lt;offset&gt;&lt;x&gt;-3.0&lt;/x&gt;&lt;y&gt;27.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;offset&gt;&lt;x&gt;-3.0&lt;/x&gt;&lt;y&gt;-20.0&lt;/y&gt;&lt;/offset&gt;
     &lt;scale&gt;1.0&lt;/scale&gt;
     &lt;rotation&gt;0.0&lt;/rotation&gt;
   &lt;/glasses&gt;
   &lt;head&gt;
     &lt;filename&gt;data/head/0009.png&lt;/filename&gt;
-    &lt;offset&gt;&lt;x&gt;0.0&lt;/x&gt;&lt;y&gt;47.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;offset&gt;&lt;x&gt;0.0&lt;/x&gt;&lt;y&gt;0.0&lt;/y&gt;&lt;/offset&gt;
     &lt;scale&gt;0.905730809829916&lt;/scale&gt;
     &lt;rotation&gt;0.0&lt;/rotation&gt;
   &lt;/head&gt;
   &lt;ear&gt;
     &lt;filename&gt;data/ear/0001.png&lt;/filename&gt;
-    &lt;offset&gt;&lt;x&gt;85.0&lt;/x&gt;&lt;y&gt;51.0&lt;/y&gt;&lt;/offset&gt;
+    &lt;offset&gt;&lt;x&gt;85.0&lt;/x&gt;&lt;y&gt;4.0&lt;/y&gt;&lt;/offset&gt;
     &lt;scale&gt;0.905730809829916&lt;/scale&gt;
     &lt;rotation&gt;0.0&lt;/rotation&gt;
   &lt;/ear&gt;
-  &lt;mouth&gt;
-    &lt;filename&gt;data/mouth/0008.png&lt;/filename&gt;
-    &lt;offset&gt;&lt;x&gt;-1.0&lt;/x&gt;&lt;y&gt;105.0&lt;/y&gt;&lt;/offset&gt;
-    &lt;scale&gt;0.853490371190111&lt;/scale&gt;
-    &lt;rotation&gt;0.0&lt;/rotation&gt;
-  &lt;/mouth&gt;
-  &lt;hair&gt;
-    &lt;filename&gt;data/hair/0029.png&lt;/filename&gt;
-    &lt;offset&gt;&lt;x&gt;-1.0&lt;/x&gt;&lt;y&gt;44.0&lt;/y&gt;&lt;/offset&gt;
-    &lt;scale&gt;0.757875024588289&lt;/scale&gt;
-    &lt;rotation&gt;0.0&lt;/rotation&gt;
-  &lt;/hair&gt;
 &lt;/face&gt;

Modified: facebuilder/face.rb
===================================================================
--- facebuilder/face.rb	2005-12-30 00:11:51 UTC (rev 1174)
+++ facebuilder/face.rb	2005-12-31 03:37:55 UTC (rev 1175)
@@ -1,6 +1,7 @@
 require &quot;rexml/document&quot;
 require &quot;base64.rb&quot;
 require 'gnomecanvas2'
+require 'face_part.rb'
 
 class FaceCommand
   def initialize(undo_, redo_)
@@ -17,262 +18,6 @@
   end
 end
 
-class FacePart
-  attr_reader :type, :offset, :filename, :canvas_items, :scale, :rotation
-  
-  def item_event(item, event)
-    case event.event_type
-    when Gdk::Event::BUTTON_PRESS
-      case event.button
-      when 1
-        # Record the click position in item-space
-        @x, @y = item.parent.w2i(event.x, event.y)
-
-        # Record the item position before the drag
-        @old_offset = @offset.clone()
-
-        fleur = Gdk::Cursor.new(Gdk::Cursor::FLEUR)
-        item.grab(Gdk::Event::POINTER_MOTION_MASK | Gdk::Event::BUTTON_RELEASE_MASK,
-                  fleur,
-                  event.time)
-        
-        @dragging = true
-
-        $facebuilder.set_current_part(@type)
-      end
-
-    when Gdk::Event::MOTION_NOTIFY
-      item_x, item_y = item.parent.w2i(event.x, event.y)
-      if @dragging &amp;&amp; (event.state &amp; Gdk::Window::BUTTON1_MASK == Gdk::Window::BUTTON1_MASK)
-        # Calculate the new position
-
-        if event.state &amp; Gdk::Window::SHIFT_MASK == Gdk::Window::SHIFT_MASK
-          @offset.x = @old_offset.x
-        else
-          @offset.x = @old_offset.x + item_x - @x
-        end
-        @offset.y = @old_offset.y + item_y - @y       
-
-        update_items()
-      end
-
-    when Gdk::Event::BUTTON_RELEASE
-      item.ungrab(event.time)
-      @dragging = false;
-
-      if @old_offset != @offset then
-        old_offset = @old_offset.clone()
-        offset     = @offset.clone()
-        
-        @parent.add_to_undo_stack(FaceCommand.new(proc{ @parent.get_part(@type).offset = old_offset },
-                                                  proc{ @parent.get_part(@type).offset = offset     }))
-        $facebuilder.update_undo() if $facebuilder
-      end
-    end
-  end
-
-  def initialize(parent, root, type, offset)
-    @parent = parent
-    @type     = type
-    
-    @offset   = offset
-    @filename = nil
-    @scale    = 1.0
-    @rotation = 0
-
-    @canvas_items = []
-
-    im = Gdk::Pixbuf.new(&quot;data/empty.png&quot;)
-    @canvas_items &lt;&lt; Gnome::CanvasPixbuf.new(root,
-                                             :pixbuf =&gt; im,
-                                             :x =&gt; 0, # offset.x,
-                                             :y =&gt; 0, # offset.y,
-                                             :width =&gt;  im.width,
-                                             :height =&gt; im.height,
-                                             :anchor =&gt; Gtk::ANCHOR_CENTER)
-
-    case @type
-    when :eye, :ear, :eyebrow, :mouthfold
-      @canvas_items &lt;&lt; Gnome::CanvasPixbuf.new(root,
-                                               :pixbuf =&gt; im,
-                                               :x =&gt; 0, # offset.x,
-                                               :y =&gt; 0, # offset.y,
-                                               :width =&gt;  im.width,
-                                               :height =&gt; im.height,
-                                               :anchor =&gt; Gtk::ANCHOR_CENTER)
-    end
-    
-    @canvas_items.each {|i|
-      i.signal_connect(&quot;event&quot;) { |item, event|
-        item_event(item, event)
-      }
-    }
-
-    self.filename=(nil)
-    update_items()
-  end
-
-  def reload()
-    self.filename=(@filename)
-  end
-  
-  def next_item()
-    pathname = &quot;data/&quot; + type.to_s + &quot;/&quot;
-    files = Dir.new(pathname).to_a[2..-1].grep(/\.png$/)
-    
-    file = File::basename(@filename)
-    index = 0
-
-    files.each_with_index { |obj, i|
-      if obj == file then
-        index = i
-        break
-      end
-    }
-    index += 1
-    
-    if index &gt;= files.length then
-      index = 0
-    end
-
-    self.filename=(pathname + files[index])
-  end
-
-  def previous_item()
-    pathname = &quot;data/&quot; + type.to_s + &quot;/&quot;
-    files = Dir.new(pathname).to_a[2..-1].grep(/\.png$/)
-    
-    file = File::basename(@filename)
-    index = 0
-
-    files.each_with_index { |obj, i|
-      if obj == file then
-        index = i
-        break
-      end
-    }
-    index -= 1
-    
-    if index &lt; 0 then
-      index = files.length - 1
-    end
-
-    self.filename=(pathname + files[index])
-  end
-
-  def update_items()
-    if @canvas_items.length == 1 then
-      @canvas_items[0].affine_absolute(Art::Affine.translate(@offset.x, @offset.y) *
-                                       Art::Affine.rotate(@rotation) *
-                                       Art::Affine.scale(@scale, @scale))
-    elsif @canvas_items.length == 2 then
-      @canvas_items[0].affine_absolute(Art::Affine.translate(@offset.x, @offset.y) *
-                                       Art::Affine.rotate(@rotation) *
-                                       Art::Affine.scale(@scale, @scale))
-      @canvas_items[1].affine_absolute(Art::Affine.scale(-1.0, 1.0) * 
-                                       Art::Affine.translate(@offset.x, @offset.y) *
-                                       Art::Affine.rotate(@rotation) *
-                                       Art::Affine.scale(@scale, @scale))
-    else
-      raise &quot;Unhandled @canvas_items.length: #{@canvas_items.length}&quot;
-    end
-  end
-
-  def rotation=(rotation)
-    @rotation = rotation
-    update_items()
-  end
-
-  def scale=(scale)
-    @scale = scale
-    update_items()
-  end
-
-  def filename=(filename)
-    if @parent.use_undo() and filename != @filename then
-      old_filename = @filename.clone() if @filename
-      new_filename = filename.clone()  if filename
-      @parent.add_to_undo_stack(FaceCommand.new(proc{ @parent.without_undo {
-                                                    @parent.get_part(@type).filename=(old_filename) }},
-                                                proc{ @parent.without_undo {
-                                                    @parent.get_part(@type).filename=(new_filename) }}))
-      $facebuilder.update_undo() if $facebuilder
-    end
-    
-    if filename and ! filename.empty? then
-      @canvas_items.each{ |item| item.show() }
-      
-      @filename = filename    
-      pixbuf = Gdk::Pixbuf.new(@filename)
-      @canvas_items.each {|item|
-        item.pixbuf = pixbuf
-      }
-    else
-      @filename = nil
-      @canvas_items.each{ |item| item.hide() }
-    end
-  end
-
-  def offset=(offset)
-    @offset = offset
-    update_items()
-  end
-
-  def offset()
-    return @offset
-  end
-
-  def save_svg(out)
-    if @filename then
-      pixbuf = Gdk::Pixbuf.new(@filename)
-
-      out.write(&quot;\n\n&lt;!-- #{@type.to_s} --&gt;\n&quot;)
-      out.write(&quot;&lt;g transform=\&quot;&quot;)
-      out.write(&quot;translate(#{pixbuf.width/2},#{pixbuf.height/2}) &quot;)
-      out.write(&quot;translate(#{-pixbuf.width/2 + 256},#{-pixbuf.height/2 + 256}) &quot;)
-      out.write(&quot;translate(#{offset.x},#{offset.y}) &quot;)
-      out.write(&quot;rotate(#{@rotation}) &quot;)
-      out.write(&quot;scale(#{@scale}) &quot;)
-      out.write(&quot;translate(#{-pixbuf.width/2},#{-pixbuf.height/2}) &quot;)
-
-      out.write(&quot;\&quot;&gt;&quot;)
-      out.write(&quot;&lt;image height=\&quot;#{pixbuf.height}\&quot; width=\&quot;#{pixbuf.width}\&quot; &quot;)
-      out.write(&quot;xlink:href=\&quot;data:image/png;base64,#{Base64.encode64(File.new(@filename).read())}\&quot; &quot;)
-      out.write(&quot;x=\&quot;0\&quot; y=\&quot;0\&quot; /&gt;&quot;)
-      out.write(&quot;&lt;/g&gt;\n&quot;)
-
-      case @type
-      when :eye, :ear, :eyebrow, :mouthfold
-        out.write(&quot;&lt;g transform=\&quot;&quot;)
-        out.write(&quot;translate(#{pixbuf.width/2},#{pixbuf.height/2}) &quot;)
-        out.write(&quot;scale(-1.0, 1.0) &quot;)
-        out.write(&quot;translate(#{pixbuf.width/2 - 256},#{-pixbuf.height/2 + 256}) &quot;)
-        out.write(&quot;translate(#{offset.x},#{offset.y}) &quot;)
-        out.write(&quot;rotate(#{@rotation}) &quot;)
-        out.write(&quot;scale(#{@scale}) &quot;)
-        out.write(&quot;translate(#{-pixbuf.width/2},#{-pixbuf.height/2}) &quot;)
-
-        out.write(&quot;\&quot;&gt;&quot;)
-        out.write(&quot;&lt;image height=\&quot;#{pixbuf.height}\&quot; width=\&quot;#{pixbuf.width}\&quot; &quot;)
-        out.write(&quot;xlink:href=\&quot;data:image/png;base64,#{Base64.encode64(File.new(@filename).read())}\&quot; &quot;)
-        out.write(&quot;x=\&quot;0\&quot; y=\&quot;0\&quot; /&gt;&quot;)
-        out.write(&quot;&lt;/g&gt;\n&quot;)
-      end
-    end
-  end
-
-  def save(out)
-    if @filename then
-      out &lt;&lt; &quot;  &lt;#{type}&gt;\n&quot;
-      out &lt;&lt; &quot;    &lt;filename&gt;#{@filename}&lt;/filename&gt;\n&quot;
-      out &lt;&lt; &quot;    &lt;offset&gt;&lt;x&gt;#{@offset.x}&lt;/x&gt;&lt;y&gt;#{@offset.y}&lt;/y&gt;&lt;/offset&gt;\n&quot;
-      out &lt;&lt; &quot;    &lt;scale&gt;#{@scale}&lt;/scale&gt;\n&quot;
-      out &lt;&lt; &quot;    &lt;rotation&gt;#{@rotation}&lt;/rotation&gt;\n&quot;
-      out &lt;&lt; &quot;  &lt;/#{type}&gt;\n&quot;
-    end
-  end
-end
-
 class Face
   attr_accessor :redo_stack, :parts
   attr_reader   :use_undo, :undo_stack
@@ -299,6 +44,13 @@
     }
   end
 
+  def center()
+    offset = @parts[:head].offset
+    @parts.each{|key, val| 
+      val.offset = Point.new(val.offset.x - offset.x, val.offset.y - offset.y)
+    }
+  end
+
   def without_undo()
     disable_undo()
     yield()
@@ -325,8 +77,9 @@
     # FIXME: Only primitive export, only copies from framebuffer and doesn't work with overlap
     puts $facebuilder.canvas.window
     window = $facebuilder.canvas.window
+    
     pixbuf = Gdk::Pixbuf.from_drawable(window.colormap, window, 0, 0, 512, 512)
-    pixbuf.save(filename,&quot;png&quot;)
+    pixbuf.save(filename, &quot;png&quot;)
   end
 
   def save_as_svg(filename)

Modified: facebuilder/facebuilder.glade
===================================================================
--- facebuilder/facebuilder.glade	2005-12-30 00:11:51 UTC (rev 1174)
+++ facebuilder/facebuilder.glade	2005-12-31 03:37:55 UTC (rev 1175)
@@ -23,7 +23,7 @@
   &lt;property name=&quot;gravity&quot;&gt;GDK_GRAVITY_NORTH_WEST&lt;/property&gt;
   &lt;property name=&quot;focus_on_map&quot;&gt;True&lt;/property&gt;
   &lt;property name=&quot;enable_layout_config&quot;&gt;True&lt;/property&gt;
-  &lt;signal name=&quot;delete_event&quot; handler=&quot;on_quit&quot; /&gt;
+  &lt;signal name=&quot;delete_event&quot; handler=&quot;on_quit&quot;/&gt;
 
   &lt;child internal-child=&quot;dock&quot;&gt;
     &lt;widget class=&quot;BonoboDock&quot; id=&quot;bonobodock1&quot;&gt;
@@ -174,6 +174,21 @@
 			  &lt;signal name=&quot;activate&quot; handler=&quot;on_preferences1_activate&quot; last_modification_time=&quot;Sun, 25 Dec 2005 14:41:31 GMT&quot;/&gt;
 			&lt;/widget&gt;
 		      &lt;/child&gt;
+
+		      &lt;child&gt;
+			&lt;widget class=&quot;GtkSeparatorMenuItem&quot; id=&quot;separator5&quot;&gt;
+			  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+			&lt;/widget&gt;
+		      &lt;/child&gt;
+
+		      &lt;child&gt;
+			&lt;widget class=&quot;GtkMenuItem&quot; id=&quot;center_face2&quot;&gt;
+			  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+			  &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;Center Face&lt;/property&gt;
+			  &lt;property name=&quot;use_underline&quot;&gt;True&lt;/property&gt;
+			  &lt;signal name=&quot;activate&quot; handler=&quot;on_center_face1_activate&quot; last_modification_time=&quot;Sat, 31 Dec 2005 00:57:36 GMT&quot;/&gt;
+			&lt;/widget&gt;
+		      &lt;/child&gt;
 		    &lt;/widget&gt;
 		  &lt;/child&gt;
 		&lt;/widget&gt;

Modified: facebuilder/facebuilder.rb
===================================================================
--- facebuilder/facebuilder.rb	2005-12-30 00:11:51 UTC (rev 1174)
+++ facebuilder/facebuilder.rb	2005-12-31 03:37:55 UTC (rev 1175)
@@ -37,8 +37,8 @@
     uiinfos[5][9]  = @glade['copy1']
     uiinfos[6][9]  = @glade['paste1']
     uiinfos[7][9]  = @glade['properties1']
-    uiinfos[8][9] = @glade['preferences1']
-    uiinfos[9][9] = @glade['about1']
+    uiinfos[8][9]  = @glade['preferences1']
+    uiinfos[9][9]  = @glade['about1']
     @app.install_menu_hints(uiinfos)
   end
 
@@ -102,7 +102,27 @@
     }      
   end
 
+  def create_directory(name)
+    if ! File.directory?(name) then
+      puts &quot;Creating #{@dot_directory}...&quot;
+      Dir.mkdir(name)
+    end
+  end
+
+  def create_dot_directory()
+    @dot_directory = ENV[&quot;HOME&quot;] + &quot;/.facebuilder&quot;
+    create_directory(@dot_directory)
+    create_directory(@dot_directory + &quot;/data&quot;)
+    create_directory(@dot_directory + &quot;/thumbnails&quot;)
+    [&quot;beard&quot;, &quot;eyebrow&quot;, &quot;glasses&quot;, &quot;hat&quot;, &quot;mouthfold&quot;,
+     &quot;ear&quot;, &quot;eye&quot;, &quot;forehead&quot;, &quot;hair&quot;, &quot;head&quot;, &quot;mouth&quot;, &quot;nose&quot;].each { |sub|
+      create_directory(@dot_directory + &quot;/data/&quot; + sub)
+    }
+  end
+
   def initialize(path_or_data, root = nil, domain = nil, localedir = nil, flag = GladeXML::FILE)
+    create_dot_directory()
+
     @glade = GladeXML.new(path_or_data, root, domain, localedir, flag) {|handler| method(handler) }
 
     create_uiinfo_menus(domain)
@@ -228,6 +248,10 @@
     update_undo()
   end
   
+  def on_center_face1_activate(widget)
+    @face.center()
+  end
+
   def on_open1_activate(widget)
     dialog =  Gtk::FileChooserDialog.new(&quot;Gtk::FileChooser sample&quot;, nil,
                                          Gtk::FileChooser::ACTION_OPEN,
@@ -288,7 +312,6 @@
     clipboard.request_contents(Gdk::Atom.intern(&quot;CLIPBOARD&quot;, false)) { |clipboard, selection_data| 
       puts selection_data.type, selection_data.text
     }
-
   end
 
   def on_save_as1_activate(widget)
@@ -378,7 +401,7 @@
                               :size_pixels =&gt; FALSE})
     left.show()
     left.signal_connect(&quot;clicked&quot;) {
-      @face.get_part(facepart).previous_item()
+      @face.get_part(facepart).next_item(-1)
       set_current_part(facepart)
     }
 
@@ -453,12 +476,31 @@
     }
   end
 
+  def store_thumbnail(pixmap, orig_filename)
+    filename = orig_filename.gsub(&quot;/&quot;, &quot;_&quot;).gsub(&quot;.&quot;, &quot;+&quot;)
+    filename = @dot_directory + &quot;/thumbnails/&quot; + &quot;thumb0_&quot; + filename + &quot;.png&quot;
+    pixmap.save(filename, &quot;png&quot;)
+    File.utime(0, File.mtime(orig_filename), filename)
+  end
+
+  def load_thumbnail(orig_filename)
+    filename = orig_filename.gsub(&quot;/&quot;, &quot;_&quot;).gsub(&quot;.&quot;, &quot;+&quot;)
+    filename = @dot_directory + &quot;/thumbnails/&quot; + &quot;thumb0_&quot; + filename + &quot;.png&quot;
+    if File.exists? filename and File.mtime(orig_filename) == File.mtime(filename) then
+        return Gdk::Pixbuf.new(filename)
+    else
+      return nil
+    end
+  end
+
   def set_current_part(type)
     @parts.each_with_index() { |p, i|
       if type == p then
         @glade['PartSelector'].active = i
 
         if @current_part != i then
+          @current_part = i
+
           @list.clear()
 
           # Add empty item
@@ -467,38 +509,52 @@
           iter[1] = Gdk::Pixbuf.new('data/empty.png')
 
           # Add other items
+          i = 0
           Dir.new(&quot;data/#{type}/&quot;).grep(/\.png$/).each{|v|
             filename = &quot;data/#{type}/#{v}&quot;
             iter = @list.append()
-            pixbuf = Gdk::Pixbuf.new(filename)
-
-            # scale, while keeping aspect
-            if pixbuf.width &gt; 64 or pixbuf.height &gt; 64 then # need scaling, since larger then 64x64
-              aspect = pixbuf.width.to_f / pixbuf.height
-              if pixbuf.width &gt; pixbuf.height then
-                pixbuf = pixbuf.scale(64, 64 / aspect)
-              else
-                pixbuf = pixbuf.scale(64 * aspect, 64)
+            
+            pixbuf = load_thumbnail(filename)
+            if ! pixbuf then
+              pixbuf = Gdk::Pixbuf.new(filename)
+              
+              # scale, while keeping aspect
+              if pixbuf.width &gt; 64 or pixbuf.height &gt; 64 then # need scaling, since larger then 64x64
+                aspect = pixbuf.width.to_f / pixbuf.height
+                if pixbuf.width &gt; pixbuf.height then
+                  pixbuf = pixbuf.scale(64, 64 / aspect)
+                else
+                  pixbuf = pixbuf.scale(64 * aspect, 64)
+                end
               end
-            end
 
-            whitepixbuf = Gdk::Pixbuf.new(Gdk::Pixbuf::COLORSPACE_RGB, true, 8, 64, 64)
-            whitepixbuf.fill!(0xf5f5f5ff)
+              whitepixbuf = Gdk::Pixbuf.new(Gdk::Pixbuf::COLORSPACE_RGB, true, 8, 64, 64)
+              whitepixbuf.fill!(0xf5f5f5ff)
 
-            whitepixbuf.composite!(pixbuf, 
-                                   (whitepixbuf.width - pixbuf.width)/2, (whitepixbuf.height - pixbuf.height)/2,
-                                   pixbuf.width, pixbuf.height,
-                                   (whitepixbuf.width - pixbuf.width)/2, (whitepixbuf.height - pixbuf.height)/2,
-                                   1.0, 1.0,
-                                   Gdk::Pixbuf::INTERP_BILINEAR,
-                                   255)            
+              whitepixbuf.composite!(pixbuf, 
+                                     (whitepixbuf.width - pixbuf.width)/2, (whitepixbuf.height - pixbuf.height)/2,
+                                     pixbuf.width, pixbuf.height,
+                                     (whitepixbuf.width - pixbuf.width)/2, (whitepixbuf.height - pixbuf.height)/2,
+                                     1.0, 1.0,
+                                     Gdk::Pixbuf::INTERP_BILINEAR,
+                                     255)            
+              pixbuf = whitepixbuf
+              store_thumbnail(pixbuf, filename)              
+            end
 
             # Add keep of aspect ratio
-            iter[1] = whitepixbuf
+            iter[1] = pixbuf
             iter[0] = filename
+
+            if filename == @face.get_part(@parts[@current_part]).filename then
+              # FIXME: Doesn't handle keyboard focus correctly
+              @glade['FaceParts'].select_path(Gtk::TreePath.new((i+1).to_s))
+              # puts @glade['FaceParts'].methods().grep(/cursor/)
+              # @glade['FaceParts'].move_cursor(Gtk::MOVEMENT_LOGICAL_POSITIONS, i+1)
+            end
+
+            i += 1
           }
-
-          @current_part = i
         end       
       end
     }   


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000827.html">[Windstille-commit] r1174 - in facebuilder/data: eye eyebrow head mouth nose
</A></li>
	<LI>Next message: <A HREF="000829.html">[Windstille-commit] r1176 - facebuilder
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#828">[ date ]</a>
              <a href="thread.html#828">[ thread ]</a>
              <a href="subject.html#828">[ subject ]</a>
              <a href="author.html#828">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/windstille-commit">More information about the Windstille-commit
mailing list</a><br>
</body></html>
