<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Windstille-commit] r503 - in trunk: . data data/levels src src/display src/input src/scripting
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/windstille-commit/2005-July/index.html" >
   <LINK REL="made" HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r503%20-%20in%20trunk%3A%20.%20data%20data/levels%20src%20src/display%20src/input%20src/scripting&In-Reply-To=%3C200507012234.j61MYpZ0005801%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000159.html">
   <LINK REL="Next"  HREF="000160.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Windstille-commit] r503 - in trunk: . data data/levels src src/display src/input src/scripting</H1>
    <B>Matthias Braun at BerliOS</B> 
    <A HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r503%20-%20in%20trunk%3A%20.%20data%20data/levels%20src%20src/display%20src/input%20src/scripting&In-Reply-To=%3C200507012234.j61MYpZ0005801%40sheep.berlios.de%3E"
       TITLE="[Windstille-commit] r503 - in trunk: . data data/levels src src/display src/input src/scripting">matzebraun at sheep.berlios.de
       </A><BR>
    <I>Sat Jul  2 00:34:51 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000159.html">[Windstille-commit] r502 - trunk/src/scripting
</A></li>
        <LI>Next message: <A HREF="000160.html">[Windstille-commit] r504 - in trunk: data data/images data/levels data/sounds data/sounds/speech src src/scripting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#668">[ date ]</a>
              <a href="thread.html#668">[ thread ]</a>
              <a href="subject.html#668">[ subject ]</a>
              <a href="author.html#668">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: matzebraun
Date: 2005-07-02 00:34:46 +0200 (Sat, 02 Jul 2005)
New Revision: 503

Added:
   trunk/src/animation_obj.cpp
   trunk/src/animation_obj.hpp
   trunk/src/blitter.cpp
   trunk/src/blitter.hpp
   trunk/src/bomb.cpp
   trunk/src/bomb.hpp
   trunk/src/brush.cpp
   trunk/src/brush.hpp
   trunk/src/camera.cpp
   trunk/src/camera.hpp
   trunk/src/collision_manager.cpp
   trunk/src/collision_manager.hpp
   trunk/src/console.cpp
   trunk/src/console.hpp
   trunk/src/controller_def.cpp
   trunk/src/controller_def.hpp
   trunk/src/default_shoot.cpp
   trunk/src/default_shoot.hpp
   trunk/src/delta_manager.hpp
   trunk/src/dialog_manager.cpp
   trunk/src/dialog_manager.hpp
   trunk/src/display.cpp
   trunk/src/display.hpp
   trunk/src/display/drawing_context.cpp
   trunk/src/display/drawing_context.hpp
   trunk/src/display/drawing_request.hpp
   trunk/src/display/scene_context.cpp
   trunk/src/display/scene_context.hpp
   trunk/src/door.cpp
   trunk/src/door.hpp
   trunk/src/energiebar.cpp
   trunk/src/energiebar.hpp
   trunk/src/entity.cpp
   trunk/src/entity.hpp
   trunk/src/field.hpp
   trunk/src/fonts.cpp
   trunk/src/fonts.hpp
   trunk/src/game_object.cpp
   trunk/src/game_object.hpp
   trunk/src/game_session.cpp
   trunk/src/game_session.hpp
   trunk/src/globals.cpp
   trunk/src/globals.hpp
   trunk/src/graphic_context_state.cpp
   trunk/src/graphic_context_state.hpp
   trunk/src/igel.cpp
   trunk/src/igel.hpp
   trunk/src/input/axis_button.cpp
   trunk/src/input/axis_button.hpp
   trunk/src/input/axis_factory.cpp
   trunk/src/input/axis_factory.hpp
   trunk/src/input/button_axis.cpp
   trunk/src/input/button_axis.hpp
   trunk/src/input/button_factory.cpp
   trunk/src/input/button_factory.hpp
   trunk/src/input/controller.cpp
   trunk/src/input/controller.hpp
   trunk/src/input/input_axis.hpp
   trunk/src/input/input_axis_input_device.cpp
   trunk/src/input/input_axis_input_device.hpp
   trunk/src/input/input_button.hpp
   trunk/src/input/input_button_input_device.cpp
   trunk/src/input/input_button_input_device.hpp
   trunk/src/input/input_event.hpp
   trunk/src/input/input_keyboard.hpp
   trunk/src/input/input_keyboard_input_device.cpp
   trunk/src/input/input_keyboard_input_device.hpp
   trunk/src/input/input_manager.cpp
   trunk/src/input/input_manager.hpp
   trunk/src/input/input_manager_custom.cpp
   trunk/src/input/input_manager_custom.hpp
   trunk/src/input/input_manager_impl.cpp
   trunk/src/input/input_manager_impl.hpp
   trunk/src/input/input_manager_player.cpp
   trunk/src/input/input_manager_player.hpp
   trunk/src/input/input_recorder.cpp
   trunk/src/input/input_recorder.hpp
   trunk/src/input/multi_button.cpp
   trunk/src/input/multi_button.hpp
   trunk/src/laser_shoot.cpp
   trunk/src/laser_shoot.hpp
   trunk/src/math.hpp
   trunk/src/particle_system.cpp
   trunk/src/particle_system.hpp
   trunk/src/player.cpp
   trunk/src/player.hpp
   trunk/src/random.cpp
   trunk/src/random.hpp
   trunk/src/screen.cpp
   trunk/src/screen.hpp
   trunk/src/sector.cpp
   trunk/src/sector.hpp
   trunk/src/sprite3d.cpp
   trunk/src/sprite3d.hpp
   trunk/src/tile.cpp
   trunk/src/tile.hpp
   trunk/src/tile_factory.cpp
   trunk/src/tile_factory.hpp
   trunk/src/tile_map.cpp
   trunk/src/tile_map.hpp
   trunk/src/tile_packer.cpp
   trunk/src/tile_packer.hpp
   trunk/src/trigger.cpp
   trunk/src/trigger.hpp
   trunk/src/view.cpp
   trunk/src/view.hpp
   trunk/src/water_map.cpp
   trunk/src/water_map.hpp
   trunk/src/water_splash.cpp
   trunk/src/water_splash.hpp
   trunk/src/windstille_bonus.cpp
   trunk/src/windstille_bonus.hpp
   trunk/src/windstille_error.cpp
   trunk/src/windstille_error.hpp
   trunk/src/windstille_main.cpp
   trunk/src/windstille_main.hpp
   trunk/src/windstille_menu.cpp
   trunk/src/windstille_menu.hpp
Removed:
   trunk/src/animation_obj.cxx
   trunk/src/animation_obj.hxx
   trunk/src/blitter.cxx
   trunk/src/blitter.hxx
   trunk/src/bomb.cxx
   trunk/src/bomb.hxx
   trunk/src/brush.cxx
   trunk/src/brush.hxx
   trunk/src/camera.cxx
   trunk/src/camera.hxx
   trunk/src/collision_manager.cxx
   trunk/src/collision_manager.hxx
   trunk/src/console.cxx
   trunk/src/console.hxx
   trunk/src/controller_def.cxx
   trunk/src/controller_def.hxx
   trunk/src/default_shoot.cxx
   trunk/src/default_shoot.hxx
   trunk/src/delta_manager.hxx
   trunk/src/dialog_manager.cxx
   trunk/src/dialog_manager.hxx
   trunk/src/display.cxx
   trunk/src/display.hxx
   trunk/src/display/drawing_context.cxx
   trunk/src/display/drawing_context.hxx
   trunk/src/display/drawing_request.hxx
   trunk/src/display/scene_context.cxx
   trunk/src/display/scene_context.hxx
   trunk/src/door.cxx
   trunk/src/door.hxx
   trunk/src/energiebar.cxx
   trunk/src/energiebar.hxx
   trunk/src/entity.cxx
   trunk/src/entity.hxx
   trunk/src/field.hxx
   trunk/src/fonts.cxx
   trunk/src/fonts.hxx
   trunk/src/game_object.cxx
   trunk/src/game_object.hxx
   trunk/src/game_session.cxx
   trunk/src/game_session.hxx
   trunk/src/globals.cxx
   trunk/src/globals.hxx
   trunk/src/graphic_context_state.cxx
   trunk/src/graphic_context_state.hxx
   trunk/src/igel.cxx
   trunk/src/igel.hxx
   trunk/src/input/axis_button.cxx
   trunk/src/input/axis_button.hxx
   trunk/src/input/axis_factory.cxx
   trunk/src/input/axis_factory.hxx
   trunk/src/input/button_axis.cxx
   trunk/src/input/button_axis.hxx
   trunk/src/input/button_factory.cxx
   trunk/src/input/button_factory.hxx
   trunk/src/input/controller.cxx
   trunk/src/input/controller.hxx
   trunk/src/input/input_axis.hxx
   trunk/src/input/input_axis_input_device.cxx
   trunk/src/input/input_axis_input_device.hxx
   trunk/src/input/input_button.hxx
   trunk/src/input/input_button_input_device.cxx
   trunk/src/input/input_button_input_device.hxx
   trunk/src/input/input_event.hxx
   trunk/src/input/input_keyboard.hxx
   trunk/src/input/input_keyboard_input_device.cxx
   trunk/src/input/input_keyboard_input_device.hxx
   trunk/src/input/input_manager.cxx
   trunk/src/input/input_manager.hxx
   trunk/src/input/input_manager_custom.cxx
   trunk/src/input/input_manager_custom.hxx
   trunk/src/input/input_manager_impl.cxx
   trunk/src/input/input_manager_impl.hxx
   trunk/src/input/input_manager_player.cxx
   trunk/src/input/input_manager_player.hxx
   trunk/src/input/input_recorder.cxx
   trunk/src/input/input_recorder.hxx
   trunk/src/input/multi_button.cxx
   trunk/src/input/multi_button.hxx
   trunk/src/laser_shoot.cxx
   trunk/src/laser_shoot.hxx
   trunk/src/math.hxx
   trunk/src/particle_system.cxx
   trunk/src/particle_system.hxx
   trunk/src/player.cxx
   trunk/src/player.hxx
   trunk/src/random.cxx
   trunk/src/random.hxx
   trunk/src/screen.cxx
   trunk/src/screen.hxx
   trunk/src/sector.cxx
   trunk/src/sector.hxx
   trunk/src/sprite3d.cxx
   trunk/src/sprite3d.hxx
   trunk/src/tile.cxx
   trunk/src/tile.hxx
   trunk/src/tile_factory.cxx
   trunk/src/tile_factory.hxx
   trunk/src/tile_map.cxx
   trunk/src/tile_map.hxx
   trunk/src/tile_packer.cxx
   trunk/src/tile_packer.hxx
   trunk/src/trigger.cxx
   trunk/src/trigger.hxx
   trunk/src/view.cxx
   trunk/src/view.hxx
   trunk/src/water_map.cxx
   trunk/src/water_map.hxx
   trunk/src/water_splash.cxx
   trunk/src/water_splash.hxx
   trunk/src/windstille_bonus.cxx
   trunk/src/windstille_bonus.hxx
   trunk/src/windstille_error.cxx
   trunk/src/windstille_error.hxx
   trunk/src/windstille_main.cxx
   trunk/src/windstille_main.hxx
   trunk/src/windstille_menu.cxx
   trunk/src/windstille_menu.hxx
Modified:
   trunk/configure.ac
   trunk/data/levels/newformat2.wst
   trunk/data/windstille.xml
   trunk/src/Jamfile
   trunk/src/display/Jamfile
   trunk/src/input/Jamfile
   trunk/src/script_manager.cpp
   trunk/src/scripting/interface.cpp
   trunk/src/scripting/interface.hpp
   trunk/src/scripting/wrapper.cpp
   trunk/src/scripting/wrapper.hpp
Log:
renamed all .cxx/.hxx files to .cpp/.hpp, added alignment parameter to dialogs

Modified: trunk/configure.ac
===================================================================
--- trunk/configure.ac	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/configure.ac	2005-07-01 22:34:46 UTC (rev 503)
@@ -36,6 +36,8 @@
 AC_ARG_ENABLE([profile], [AC_HELP_STRING([--enable-profile],
     [build with profiling information (default NO)])],
     [test &quot;$enableval&quot; = &quot;yes&quot; &amp;&amp; VARIANT=profile])
+AC_MSG_CHECKING([for build variant])
+AC_MSG_RESULT([$VARIANT])
 AC_SUBST([VARIANT])
 
 #----------------------------------------------------------------------------

Modified: trunk/data/levels/newformat2.wst
===================================================================
--- trunk/data/levels/newformat2.wst	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/data/levels/newformat2.wst	2005-07-01 22:34:46 UTC (rev 503)
@@ -5,12 +5,13 @@
   (music  &quot;music/techdemo.ogg&quot;)
   (ambient-color 170 170 170)
   (init-script &quot;
-show_dialog(\&quot;human/portrait\&quot;,
+set_dialog(TOP + RIGHT, \&quot;human/portrait\&quot;,
 \&quot;Welcome to the VR training programm. Here you \&quot; +
 \&quot;will learn the basic manovering abilities of your \&quot; +
 \&quot;powersuit, jumping, running, climbing and shooting.\&quot; +
 \&quot;We will start with climbing. See the block infront \&quot; +
 \&quot;of you? Press [Right] and [Jump] to hang on the ledge.\&quot;);
+show_dialog(0);
 &quot;)
   (objects
     (trigger
@@ -26,7 +27,6 @@
 print(\&quot;2\&quot;);
 wait(2);
 print(\&quot;3\&quot;);
-play_music(\&quot;music/jingle.ogg\&quot;);
 &quot;)
     )
   (tilemap (name &quot;background&quot;) (width 100) (height 30)

Modified: trunk/data/windstille.xml
===================================================================
--- trunk/data/windstille.xml	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/data/windstille.xml	2005-07-01 22:34:46 UTC (rev 503)
@@ -175,7 +175,7 @@
     &lt;/sprite&gt;
 
     &lt;sprite name=&quot;portrait&quot;&gt;
-      &lt;translation origin=&quot;top_left&quot; x=&quot;-50&quot; y=&quot;50&quot; /&gt;
+      &lt;translation origin=&quot;top_left&quot; x=&quot;0&quot; y=&quot;0&quot; /&gt;
       &lt;image file=&quot;images/human_portrait.png&quot; /&gt; 
     &lt;/sprite&gt;
   &lt;/section&gt;

Modified: trunk/src/Jamfile
===================================================================
--- trunk/src/Jamfile	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/Jamfile	2005-07-01 22:34:46 UTC (rev 503)
@@ -10,93 +10,93 @@
 SubInclude TOP src scripting ;
 
 sources = 
-        animation_obj.cxx
-        animation_obj.hxx
-        bomb.cxx
-        bomb.hxx
-        brush.cxx
-        brush.hxx
-        blitter.cxx
-        blitter.hxx
-        camera.cxx
-        camera.hxx
-        collision_manager.cxx
-        collision_manager.hxx
-        console.cxx
-        console.hxx
-        controller_def.cxx
-        controller_def.hxx
-        default_shoot.cxx
-        default_shoot.hxx
-        delta_manager.hxx
-        dialog_manager.cxx
-        dialog_manager.hxx
-        display.cxx
-        display.hxx
-        door.cxx
-        door.hxx
-        energiebar.cxx
-        energiebar.hxx
-        entity.cxx
-        entity.hxx
-        field.hxx
-        fonts.cxx
-        fonts.hxx
+        animation_obj.cpp
+        animation_obj.hpp
+        bomb.cpp
+        bomb.hpp
+        brush.cpp
+        brush.hpp
+        blitter.cpp
+        blitter.hpp
+        camera.cpp
+        camera.hpp
+        collision_manager.cpp
+        collision_manager.hpp
+        console.cpp
+        console.hpp
+        controller_def.cpp
+        controller_def.hpp
+        default_shoot.cpp
+        default_shoot.hpp
+        delta_manager.hpp
+        dialog_manager.cpp
+        dialog_manager.hpp
+        display.cpp
+        display.hpp
+        door.cpp
+        door.hpp
+        energiebar.cpp
+        energiebar.hpp
+        entity.cpp
+        entity.hpp
+        field.hpp
+        fonts.cpp
+        fonts.hpp
         gameconfig.hpp
         gameconfig.cpp
-        game_object.cxx
-        game_object.hxx
-        game_session.cxx
-        game_session.hxx
-        globals.cxx
-        globals.hxx
-        graphic_context_state.cxx
-        graphic_context_state.hxx
-        igel.cxx
-        igel.hxx
-        laser_shoot.cxx
-        laser_shoot.hxx
-        math.hxx
-        particle_system.cxx
-        particle_system.hxx
-        player.cxx
-        player.hxx
-        random.cxx
-        random.hxx
-        screen.cxx
-        screen.hxx
+        game_object.cpp
+        game_object.hpp
+        game_session.cpp
+        game_session.hpp
+        globals.cpp
+        globals.hpp
+        graphic_context_state.cpp
+        graphic_context_state.hpp
+        igel.cpp
+        igel.hpp
+        laser_shoot.cpp
+        laser_shoot.hpp
+        math.hpp
+        particle_system.cpp
+        particle_system.hpp
+        player.cpp
+        player.hpp
+        random.cpp
+        random.hpp
+        screen.cpp
+        screen.hpp
         script_manager.hpp
         script_manager.cpp
-        sector.cxx
-        sector.hxx
-        sprite3d.cxx
-        sprite3d.hxx
-        tile.cxx
-        tile_factory.cxx
-        tile_factory.hxx
-        tile_packer.cxx
-        tile_packer.hxx
-        tile.hxx
-        tile_map.cxx
-        tile_map.hxx
+        sector.cpp
+        sector.hpp
+        sprite3d.cpp
+        sprite3d.hpp
+        tile.cpp
+        tile_factory.cpp
+        tile_factory.hpp
+        tile_packer.cpp
+        tile_packer.hpp
+        tile.hpp
+        tile_map.cpp
+        tile_map.hpp
         timer.hpp
         timer.cpp
-        trigger.cxx
-        trigger.hxx
-        view.cxx
-        view.hxx
-        water_map.cxx
-        water_map.hxx
-        water_splash.cxx
-        water_splash.hxx
-        windstille_bonus.cxx
-        windstille_bonus.hxx
-        windstille_error.cxx
-        windstille_error.hxx
-        windstille_main.cxx
-        windstille_main.hxx
-        windstille_menu.cxx
-        windstille_menu.hxx
+        trigger.cpp
+        trigger.hpp
+        view.cpp
+        view.hpp
+        water_map.cpp
+        water_map.hpp
+        water_splash.cpp
+        water_splash.hpp
+        windstille_bonus.cpp
+        windstille_bonus.hpp
+        windstille_error.cpp
+        windstille_error.hpp
+        windstille_main.cpp
+        windstille_main.hpp
+        windstille_menu.cpp
+        windstille_menu.hpp
 ;
 
 TRANSLATABLE_SOURCES += [ SearchSource $(sources) ] ;

Copied: trunk/src/animation_obj.cpp (from rev 502, trunk/src/animation_obj.cxx)
===================================================================
--- trunk/src/animation_obj.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/animation_obj.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,46 @@
+//  $Id: animation_obj.cxx,v 1.3 2003/08/12 08:24:41 grumbel Exp $
+//
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ClanLib/display.h&gt;
+#include &quot;globals.hpp&quot;
+#include &quot;animation_obj.hpp&quot;
+
+extern CL_ResourceManager* resources;
+
+AnimationObj::AnimationObj (const std::string&amp; str, const CL_Vector&amp; arg_pos)
+  : sprite(CL_Sprite (str, resources)), 
+    pos(arg_pos)
+{
+}
+
+void
+AnimationObj::draw (SceneContext&amp; )
+{
+  sprite.draw (int (pos.x), int (pos.y));
+}
+
+void
+AnimationObj::update (float delta)
+{
+  if (sprite.is_finished ())
+    remove ();
+  sprite.update (delta);
+}
+
+/* EOF */

Deleted: trunk/src/animation_obj.cxx
===================================================================
--- trunk/src/animation_obj.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/animation_obj.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,46 +0,0 @@
-//  $Id: animation_obj.cxx,v 1.3 2003/08/12 08:24:41 grumbel Exp $
-//
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ClanLib/display.h&gt;
-#include &quot;globals.hxx&quot;
-#include &quot;animation_obj.hxx&quot;
-
-extern CL_ResourceManager* resources;
-
-AnimationObj::AnimationObj (const std::string&amp; str, const CL_Vector&amp; arg_pos)
-  : sprite(CL_Sprite (str, resources)), 
-    pos(arg_pos)
-{
-}
-
-void
-AnimationObj::draw (SceneContext&amp; )
-{
-  sprite.draw (int (pos.x), int (pos.y));
-}
-
-void
-AnimationObj::update (float delta)
-{
-  if (sprite.is_finished ())
-    remove ();
-  sprite.update (delta);
-}
-
-/* EOF */

Copied: trunk/src/animation_obj.hpp (from rev 502, trunk/src/animation_obj.hxx)
===================================================================
--- trunk/src/animation_obj.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/animation_obj.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,47 @@
+//  $Id: animation_obj.hpp,v 1.3 2003/09/12 16:31:20 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef ANIMATIONOBJ_HXX
+#define ANIMATIONOBJ_HXX
+
+#include &lt;ClanLib/Display/sprite.h&gt;
+#include &lt;ClanLib/Core/Math/cl_vector.h&gt;
+#include &quot;game_object.hpp&quot;
+
+/** Display a sequenze of frames and then remove itself. Usefull for
+    explosions an other gfx only things which don't influence the game
+    physics by itself.
+ */
+class AnimationObj : public GameObject
+{
+private:
+  CL_Sprite sprite;
+  CL_Vector pos;
+  
+public:
+  AnimationObj (const std::string&amp;, const CL_Vector&amp; position);
+  virtual ~AnimationObj() {}
+  
+  void draw (SceneContext&amp; gc);
+  void update (float);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/animation_obj.hxx
===================================================================
--- trunk/src/animation_obj.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/animation_obj.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,47 +0,0 @@
-//  $Id: animation_obj.hxx,v 1.3 2003/09/12 16:31:20 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef ANIMATIONOBJ_HXX
-#define ANIMATIONOBJ_HXX
-
-#include &lt;ClanLib/Display/sprite.h&gt;
-#include &lt;ClanLib/Core/Math/cl_vector.h&gt;
-#include &quot;game_object.hxx&quot;
-
-/** Display a sequenze of frames and then remove itself. Usefull for
-    explosions an other gfx only things which don't influence the game
-    physics by itself.
- */
-class AnimationObj : public GameObject
-{
-private:
-  CL_Sprite sprite;
-  CL_Vector pos;
-  
-public:
-  AnimationObj (const std::string&amp;, const CL_Vector&amp; position);
-  virtual ~AnimationObj() {}
-  
-  void draw (SceneContext&amp; gc);
-  void update (float);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/blitter.cpp (from rev 502, trunk/src/blitter.cxx)
===================================================================
--- trunk/src/blitter.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/blitter.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,208 @@
+//  $Id$
+//
+//  Flexlay - A Generic 2D Game Editor
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;assert.h&gt;
+#include &lt;iostream&gt;
+#include &lt;algorithm&gt;
+#include &lt;ClanLib/Display/pixel_format.h&gt;
+#include &lt;ClanLib/Display/palette.h&gt;
+#include &quot;blitter.hpp&quot;
+
+void 
+blit_opaque(CL_PixelBuffer target, CL_PixelBuffer brush, int x_pos, int y_pos)
+{
+  target.lock();
+  brush.lock();
+
+  int start_x = std::max(0, -x_pos);
+  int start_y = std::max(0, -y_pos);
+  
+  int end_x = std::min(brush.get_width(),  target.get_width()  - x_pos);
+  int end_y = std::min(brush.get_height(), target.get_height() - y_pos);
+
+  unsigned char* target_buf = static_cast&lt;unsigned char*&gt;(target.get_data());
+  unsigned char* brush_buf  = static_cast&lt;unsigned char*&gt;(brush.get_data());
+
+  int target_pitch = target.get_pitch();
+  int brush_pitch  = brush.get_pitch();
+
+  if (brush.get_format().get_type() == pixelformat_rgba)
+    {
+      if (brush.get_format().get_depth() == 32)
+        {
+          for (int y = start_y; y &lt; end_y; ++y)
+            for (int x = start_x; x &lt; end_x; ++x)
+              {
+                int target_pos = (y + y_pos) * target_pitch + 4*(x + x_pos);
+                int brush_pos  = y * brush_pitch + x*4;
+
+                target_buf[target_pos + 0] = brush_buf[brush_pos + 0];
+                target_buf[target_pos + 1] = brush_buf[brush_pos + 1];
+                target_buf[target_pos + 2] = brush_buf[brush_pos + 2];
+                target_buf[target_pos + 3] = brush_buf[brush_pos + 3];
+              } 
+        }
+      else if (brush.get_format().get_depth() == 24)
+        {
+          for (int y = start_y; y &lt; end_y; ++y)
+            for (int x = start_x; x &lt; end_x; ++x)
+              {
+                int target_pos = (y + y_pos) * target_pitch + 3*(x + x_pos);
+                int brush_pos  = y * brush_pitch + 3*x;
+
+                target_buf[target_pos + 0] = 255;
+                target_buf[target_pos + 1] = brush_buf[brush_pos + 0];
+                target_buf[target_pos + 2] = brush_buf[brush_pos + 1];
+                target_buf[target_pos + 3] = brush_buf[brush_pos + 2];
+              }
+        }
+      else
+        {
+          std::cout &lt;&lt; &quot;Unsupported bpp: &quot; &lt;&lt; brush.get_format().get_depth() &lt;&lt; std::endl;
+        }
+    }
+  else if (brush.get_format().get_type() == pixelformat_index)
+    {
+      CL_Palette palette = brush.get_palette();
+      for (int y = start_y; y &lt; end_y; ++y)
+        for (int x = start_x; x &lt; end_x; ++x)
+          {
+            int target_pos = (y + y_pos) * target_pitch + 4*(x + x_pos);
+            int brush_pos  = y * brush_pitch + x;
+            
+            target_buf[target_pos + 0] = 255;
+            target_buf[target_pos + 1] = palette.colors[brush_buf[brush_pos]].get_blue();
+            target_buf[target_pos + 2] = palette.colors[brush_buf[brush_pos]].get_green();
+            target_buf[target_pos + 3] = palette.colors[brush_buf[brush_pos]].get_red();
+          }
+    }
+  else
+    {
+      assert(!&quot;Unknown pixelformat type&quot;);
+    }
+    
+
+
+  brush.unlock();
+  target.unlock();
+}
+
+void 
+blit(CL_PixelBuffer target, CL_PixelBuffer brush, int x_pos, int y_pos)
+{
+  target.lock();
+  brush.lock();
+
+  int start_x = std::max(0, -x_pos);
+  int start_y = std::max(0, -y_pos);
+  
+  int end_x = std::min(brush.get_width(),  target.get_width()  - x_pos);
+  int end_y = std::min(brush.get_height(), target.get_height() - y_pos);
+
+  unsigned char* target_buf = static_cast&lt;unsigned char*&gt;(target.get_data());
+  unsigned char* brush_buf  = static_cast&lt;unsigned char*&gt;(brush.get_data());
+
+  // FIXME: This doesn't take pitch into account
+  int target_width = target.get_width();
+  int brush_width  = brush.get_width();
+
+  if (brush.get_format().get_type() == pixelformat_rgba)
+    {
+      if (brush.get_format().get_depth() == 32)
+        {
+          for (int y = start_y; y &lt; end_y; ++y)
+            for (int x = start_x; x &lt; end_x; ++x)
+              {
+                int target_pos = (y + y_pos) * target_width + x + x_pos;
+                int brush_pos  = y * brush_width + x;
+
+                unsigned char a  = brush_buf[4*brush_pos + 0];
+                unsigned char r  = brush_buf[4*brush_pos + 1];
+                unsigned char g  = brush_buf[4*brush_pos + 2];
+                unsigned char b  = brush_buf[4*brush_pos + 3];
+
+                unsigned char ta = target_buf[4*target_pos + 0];
+                unsigned char tr = target_buf[4*target_pos + 1];
+                unsigned char tg = target_buf[4*target_pos + 2];
+                unsigned char tb = target_buf[4*target_pos + 3];
+
+                float alpha  = a/255.0f;
+        
+                target_buf[4*target_pos + 0] = std::min(255, ta + a);
+                target_buf[4*target_pos + 1] = std::min(255, int((1-alpha)*tr + alpha*r));
+                target_buf[4*target_pos + 2] = std::min(255, int((1-alpha)*tg + alpha*g));
+                target_buf[4*target_pos + 3] = std::min(255, int((1-alpha)*tb + alpha*b));
+              }
+        }
+      else if (brush.get_format().get_depth() == 24)
+        {
+          for (int y = start_y; y &lt; end_y; ++y)
+            for (int x = start_x; x &lt; end_x; ++x)
+              {
+                int target_pos = (y + y_pos) * target_width + x + x_pos;
+                int brush_pos  = y * brush_width + x;
+
+                target_buf[4*target_pos + 0] = 255;
+                target_buf[4*target_pos + 1] = brush_buf[3*brush_pos + 0];
+                target_buf[4*target_pos + 2] = brush_buf[3*brush_pos + 1];
+                target_buf[4*target_pos + 3] = brush_buf[3*brush_pos + 2];
+              }
+        }
+      else
+        {
+          std::cout &lt;&lt; &quot;Unsupported bpp: &quot; &lt;&lt; brush.get_format().get_depth() &lt;&lt; std::endl;
+        }
+    }
+  else if (brush.get_format().get_type() == pixelformat_index)
+    {
+      CL_Palette palette = brush.get_palette();
+      for (int y = start_y; y &lt; end_y; ++y)
+        for (int x = start_x; x &lt; end_x; ++x)
+          {
+            int target_pos = (y + y_pos) * target_width + x + x_pos;
+            int brush_pos  = y * brush_width + x;
+            
+            target_buf[4*target_pos + 0] = 255;
+            target_buf[4*target_pos + 1] = palette.colors[brush_buf[brush_pos]].get_blue();
+            target_buf[4*target_pos + 2] = palette.colors[brush_buf[brush_pos]].get_green();
+            target_buf[4*target_pos + 3] = palette.colors[brush_buf[brush_pos]].get_red();
+          }
+    }
+  else
+    {
+      assert(!&quot;Unknown pixelformat type&quot;);
+    }
+    
+
+
+  brush.unlock();
+  target.unlock();
+}
+
+void clear(CL_PixelBuffer canvas)
+{
+  unsigned char* buffer;
+
+  canvas.lock();
+  buffer = static_cast&lt;unsigned char*&gt;(canvas.get_data());
+  memset(buffer, 0, sizeof(unsigned char) * canvas.get_pitch() * canvas.get_height());
+  canvas.unlock();
+}
+
+/* EOF */

Deleted: trunk/src/blitter.cxx
===================================================================
--- trunk/src/blitter.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/blitter.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,208 +0,0 @@
-//  $Id$
-//
-//  Flexlay - A Generic 2D Game Editor
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;assert.h&gt;
-#include &lt;iostream&gt;
-#include &lt;algorithm&gt;
-#include &lt;ClanLib/Display/pixel_format.h&gt;
-#include &lt;ClanLib/Display/palette.h&gt;
-#include &quot;blitter.hxx&quot;
-
-void 
-blit_opaque(CL_PixelBuffer target, CL_PixelBuffer brush, int x_pos, int y_pos)
-{
-  target.lock();
-  brush.lock();
-
-  int start_x = std::max(0, -x_pos);
-  int start_y = std::max(0, -y_pos);
-  
-  int end_x = std::min(brush.get_width(),  target.get_width()  - x_pos);
-  int end_y = std::min(brush.get_height(), target.get_height() - y_pos);
-
-  unsigned char* target_buf = static_cast&lt;unsigned char*&gt;(target.get_data());
-  unsigned char* brush_buf  = static_cast&lt;unsigned char*&gt;(brush.get_data());
-
-  int target_pitch = target.get_pitch();
-  int brush_pitch  = brush.get_pitch();
-
-  if (brush.get_format().get_type() == pixelformat_rgba)
-    {
-      if (brush.get_format().get_depth() == 32)
-        {
-          for (int y = start_y; y &lt; end_y; ++y)
-            for (int x = start_x; x &lt; end_x; ++x)
-              {
-                int target_pos = (y + y_pos) * target_pitch + 4*(x + x_pos);
-                int brush_pos  = y * brush_pitch + x*4;
-
-                target_buf[target_pos + 0] = brush_buf[brush_pos + 0];
-                target_buf[target_pos + 1] = brush_buf[brush_pos + 1];
-                target_buf[target_pos + 2] = brush_buf[brush_pos + 2];
-                target_buf[target_pos + 3] = brush_buf[brush_pos + 3];
-              } 
-        }
-      else if (brush.get_format().get_depth() == 24)
-        {
-          for (int y = start_y; y &lt; end_y; ++y)
-            for (int x = start_x; x &lt; end_x; ++x)
-              {
-                int target_pos = (y + y_pos) * target_pitch + 3*(x + x_pos);
-                int brush_pos  = y * brush_pitch + 3*x;
-
-                target_buf[target_pos + 0] = 255;
-                target_buf[target_pos + 1] = brush_buf[brush_pos + 0];
-                target_buf[target_pos + 2] = brush_buf[brush_pos + 1];
-                target_buf[target_pos + 3] = brush_buf[brush_pos + 2];
-              }
-        }
-      else
-        {
-          std::cout &lt;&lt; &quot;Unsupported bpp: &quot; &lt;&lt; brush.get_format().get_depth() &lt;&lt; std::endl;
-        }
-    }
-  else if (brush.get_format().get_type() == pixelformat_index)
-    {
-      CL_Palette palette = brush.get_palette();
-      for (int y = start_y; y &lt; end_y; ++y)
-        for (int x = start_x; x &lt; end_x; ++x)
-          {
-            int target_pos = (y + y_pos) * target_pitch + 4*(x + x_pos);
-            int brush_pos  = y * brush_pitch + x;
-            
-            target_buf[target_pos + 0] = 255;
-            target_buf[target_pos + 1] = palette.colors[brush_buf[brush_pos]].get_blue();
-            target_buf[target_pos + 2] = palette.colors[brush_buf[brush_pos]].get_green();
-            target_buf[target_pos + 3] = palette.colors[brush_buf[brush_pos]].get_red();
-          }
-    }
-  else
-    {
-      assert(!&quot;Unknown pixelformat type&quot;);
-    }
-    
-
-
-  brush.unlock();
-  target.unlock();
-}
-
-void 
-blit(CL_PixelBuffer target, CL_PixelBuffer brush, int x_pos, int y_pos)
-{
-  target.lock();
-  brush.lock();
-
-  int start_x = std::max(0, -x_pos);
-  int start_y = std::max(0, -y_pos);
-  
-  int end_x = std::min(brush.get_width(),  target.get_width()  - x_pos);
-  int end_y = std::min(brush.get_height(), target.get_height() - y_pos);
-
-  unsigned char* target_buf = static_cast&lt;unsigned char*&gt;(target.get_data());
-  unsigned char* brush_buf  = static_cast&lt;unsigned char*&gt;(brush.get_data());
-
-  // FIXME: This doesn't take pitch into account
-  int target_width = target.get_width();
-  int brush_width  = brush.get_width();
-
-  if (brush.get_format().get_type() == pixelformat_rgba)
-    {
-      if (brush.get_format().get_depth() == 32)
-        {
-          for (int y = start_y; y &lt; end_y; ++y)
-            for (int x = start_x; x &lt; end_x; ++x)
-              {
-                int target_pos = (y + y_pos) * target_width + x + x_pos;
-                int brush_pos  = y * brush_width + x;
-
-                unsigned char a  = brush_buf[4*brush_pos + 0];
-                unsigned char r  = brush_buf[4*brush_pos + 1];
-                unsigned char g  = brush_buf[4*brush_pos + 2];
-                unsigned char b  = brush_buf[4*brush_pos + 3];
-
-                unsigned char ta = target_buf[4*target_pos + 0];
-                unsigned char tr = target_buf[4*target_pos + 1];
-                unsigned char tg = target_buf[4*target_pos + 2];
-                unsigned char tb = target_buf[4*target_pos + 3];
-
-                float alpha  = a/255.0f;
-        
-                target_buf[4*target_pos + 0] = std::min(255, ta + a);
-                target_buf[4*target_pos + 1] = std::min(255, int((1-alpha)*tr + alpha*r));
-                target_buf[4*target_pos + 2] = std::min(255, int((1-alpha)*tg + alpha*g));
-                target_buf[4*target_pos + 3] = std::min(255, int((1-alpha)*tb + alpha*b));
-              }
-        }
-      else if (brush.get_format().get_depth() == 24)
-        {
-          for (int y = start_y; y &lt; end_y; ++y)
-            for (int x = start_x; x &lt; end_x; ++x)
-              {
-                int target_pos = (y + y_pos) * target_width + x + x_pos;
-                int brush_pos  = y * brush_width + x;
-
-                target_buf[4*target_pos + 0] = 255;
-                target_buf[4*target_pos + 1] = brush_buf[3*brush_pos + 0];
-                target_buf[4*target_pos + 2] = brush_buf[3*brush_pos + 1];
-                target_buf[4*target_pos + 3] = brush_buf[3*brush_pos + 2];
-              }
-        }
-      else
-        {
-          std::cout &lt;&lt; &quot;Unsupported bpp: &quot; &lt;&lt; brush.get_format().get_depth() &lt;&lt; std::endl;
-        }
-    }
-  else if (brush.get_format().get_type() == pixelformat_index)
-    {
-      CL_Palette palette = brush.get_palette();
-      for (int y = start_y; y &lt; end_y; ++y)
-        for (int x = start_x; x &lt; end_x; ++x)
-          {
-            int target_pos = (y + y_pos) * target_width + x + x_pos;
-            int brush_pos  = y * brush_width + x;
-            
-            target_buf[4*target_pos + 0] = 255;
-            target_buf[4*target_pos + 1] = palette.colors[brush_buf[brush_pos]].get_blue();
-            target_buf[4*target_pos + 2] = palette.colors[brush_buf[brush_pos]].get_green();
-            target_buf[4*target_pos + 3] = palette.colors[brush_buf[brush_pos]].get_red();
-          }
-    }
-  else
-    {
-      assert(!&quot;Unknown pixelformat type&quot;);
-    }
-    
-
-
-  brush.unlock();
-  target.unlock();
-}
-
-void clear(CL_PixelBuffer canvas)
-{
-  unsigned char* buffer;
-
-  canvas.lock();
-  buffer = static_cast&lt;unsigned char*&gt;(canvas.get_data());
-  memset(buffer, 0, sizeof(unsigned char) * canvas.get_pitch() * canvas.get_height());
-  canvas.unlock();
-}
-
-/* EOF */

Copied: trunk/src/blitter.hpp (from rev 502, trunk/src/blitter.hxx)

Deleted: trunk/src/blitter.hxx
===================================================================
--- trunk/src/blitter.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/blitter.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,31 +0,0 @@
-//  $Id$
-// 
-//  Flexlay - A Generic 2D Game Editor
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_BLITTER_HXX
-#define HEADER_BLITTER_HXX
-
-#include &lt;ClanLib/Display/pixel_buffer.h&gt;
-
-void blit_opaque(CL_PixelBuffer target, CL_PixelBuffer brush, int x_pos, int y_pos);
-void blit(CL_PixelBuffer target, CL_PixelBuffer brush, int x_pos, int y_pos);
-void clear(CL_PixelBuffer target);
-
-#endif
-
-/* EOF */

Copied: trunk/src/bomb.cpp (from rev 502, trunk/src/bomb.cxx)
===================================================================
--- trunk/src/bomb.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/bomb.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,115 @@
+//  $Id: bomb.cxx,v 1.4 2003/09/28 16:58:03 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;globals.hpp&quot;
+#include &quot;igel.hpp&quot;
+#include &quot;sector.hpp&quot;
+#include &quot;bomb.hpp&quot;
+
+Bomb::Bomb(int x, int y)
+  : sprite(&quot;bomb&quot;, resources),
+    explo(&quot;explo&quot;, resources),
+    light(&quot;bomblight&quot;, resources),
+    highlight(&quot;bombhighlight&quot;, resources),
+    explolight(&quot;explolight&quot;, resources),
+    pos(x, int(y/TILE_SIZE+1)*TILE_SIZE),
+    count(2.0f),
+    state(COUNTDOWN),
+    exploded(false)
+{
+  light.set_blend_func(blend_src_alpha, blend_one);
+  highlight.set_blend_func(blend_src_alpha, blend_one);
+  explolight.set_blend_func(blend_src_alpha, blend_one);
+}
+
+Bomb::~Bomb()
+{
+}
+
+void
+Bomb::update(float delta)
+{
+  if (explo.is_finished())
+    remove();
+
+  if (state == EXPLODE)
+    explo.update(delta);
+  else
+    sprite.update(delta);
+
+  count -= delta;
+
+  if (count &lt; 0 &amp;&amp; state != EXPLODE)
+    {
+      state = EXPLODE;
+      count = 0;
+      if (!exploded)
+        {
+          exploded = true;
+          explode();
+        }
+
+    }
+}
+
+void
+Bomb::draw(SceneContext&amp; sc)
+{
+  if (state == EXPLODE)
+    {
+      explo.draw(pos.x, pos.y);
+      sc.light().draw(explolight, pos.x, pos.y, 0);
+      explolight.set_alpha(0.5);
+      explolight.set_scale(.5, .5);
+      sc.highlight().draw(explolight, pos.x, pos.y, 0);
+      explolight.set_alpha(1.0);
+      explolight.set_scale(1.0, 1.0);
+    }
+  else
+    {
+      sc.color().draw(sprite, pos.x, pos.y);
+      if (sprite.get_current_frame() == 0) {
+        sc.light().draw(light, pos.x, pos.y, 0);
+        sc.highlight().draw(highlight, pos.x, pos.y, 0);
+      }
+    }
+}
+
+void 
+Bomb::explode()
+{
+  if (0)
+    { // FIXME: Should be handled by the collision system
+      std::vector&lt;GameObject*&gt;* objs = Sector::current()-&gt;get_objects();
+      for(std::vector&lt;GameObject*&gt;::iterator i = objs-&gt;begin(); i != objs-&gt;end(); ++i)
+        {
+          Igel* igel = dynamic_cast&lt;Igel*&gt;(*i);
+          if (igel)
+            {
+              if (igel-&gt;get_pos().x &gt; pos.x - 30 &amp;&amp;
+                  igel-&gt;get_pos().x &lt; pos.x + 30 &amp;&amp;
+                  igel-&gt;get_pos().y &gt; pos.y - 20 &amp;&amp;
+                  igel-&gt;get_pos().y &lt; pos.y + 20)
+                igel-&gt;die();
+            }
+        }
+    }
+}
+
+/* EOF */

Deleted: trunk/src/bomb.cxx
===================================================================
--- trunk/src/bomb.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/bomb.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,115 +0,0 @@
-//  $Id: bomb.cxx,v 1.4 2003/09/28 16:58:03 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;globals.hxx&quot;
-#include &quot;igel.hxx&quot;
-#include &quot;sector.hxx&quot;
-#include &quot;bomb.hxx&quot;
-
-Bomb::Bomb(int x, int y)
-  : sprite(&quot;bomb&quot;, resources),
-    explo(&quot;explo&quot;, resources),
-    light(&quot;bomblight&quot;, resources),
-    highlight(&quot;bombhighlight&quot;, resources),
-    explolight(&quot;explolight&quot;, resources),
-    pos(x, int(y/TILE_SIZE+1)*TILE_SIZE),
-    count(2.0f),
-    state(COUNTDOWN),
-    exploded(false)
-{
-  light.set_blend_func(blend_src_alpha, blend_one);
-  highlight.set_blend_func(blend_src_alpha, blend_one);
-  explolight.set_blend_func(blend_src_alpha, blend_one);
-}
-
-Bomb::~Bomb()
-{
-}
-
-void
-Bomb::update(float delta)
-{
-  if (explo.is_finished())
-    remove();
-
-  if (state == EXPLODE)
-    explo.update(delta);
-  else
-    sprite.update(delta);
-
-  count -= delta;
-
-  if (count &lt; 0 &amp;&amp; state != EXPLODE)
-    {
-      state = EXPLODE;
-      count = 0;
-      if (!exploded)
-        {
-          exploded = true;
-          explode();
-        }
-
-    }
-}
-
-void
-Bomb::draw(SceneContext&amp; sc)
-{
-  if (state == EXPLODE)
-    {
-      explo.draw(pos.x, pos.y);
-      sc.light().draw(explolight, pos.x, pos.y, 0);
-      explolight.set_alpha(0.5);
-      explolight.set_scale(.5, .5);
-      sc.highlight().draw(explolight, pos.x, pos.y, 0);
-      explolight.set_alpha(1.0);
-      explolight.set_scale(1.0, 1.0);
-    }
-  else
-    {
-      sc.color().draw(sprite, pos.x, pos.y);
-      if (sprite.get_current_frame() == 0) {
-        sc.light().draw(light, pos.x, pos.y, 0);
-        sc.highlight().draw(highlight, pos.x, pos.y, 0);
-      }
-    }
-}
-
-void 
-Bomb::explode()
-{
-  if (0)
-    { // FIXME: Should be handled by the collision system
-      std::vector&lt;GameObject*&gt;* objs = Sector::current()-&gt;get_objects();
-      for(std::vector&lt;GameObject*&gt;::iterator i = objs-&gt;begin(); i != objs-&gt;end(); ++i)
-        {
-          Igel* igel = dynamic_cast&lt;Igel*&gt;(*i);
-          if (igel)
-            {
-              if (igel-&gt;get_pos().x &gt; pos.x - 30 &amp;&amp;
-                  igel-&gt;get_pos().x &lt; pos.x + 30 &amp;&amp;
-                  igel-&gt;get_pos().y &gt; pos.y - 20 &amp;&amp;
-                  igel-&gt;get_pos().y &lt; pos.y + 20)
-                igel-&gt;die();
-            }
-        }
-    }
-}
-
-/* EOF */

Copied: trunk/src/bomb.hpp (from rev 502, trunk/src/bomb.hxx)
===================================================================
--- trunk/src/bomb.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/bomb.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,55 @@
+//  $Id: bomb.hpp,v 1.2 2003/09/28 10:55:34 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_BOMB_HXX
+#define HEADER_BOMB_HXX
+
+#include &lt;ClanLib/Display/sprite.h&gt;
+#include &lt;ClanLib/Core/Math/point.h&gt;
+#include &quot;game_object.hpp&quot;
+
+/** */
+class Bomb : public GameObject
+{
+private:
+  CL_Sprite sprite;
+  CL_Sprite explo;
+  CL_Sprite light;
+  CL_Sprite highlight;
+  CL_Sprite explolight;
+  CL_Point pos;
+  float count;
+  enum { COUNTDOWN, EXPLODE } state;
+  bool exploded;
+
+public:
+  Bomb(int x, int y);
+  virtual ~Bomb();
+
+  void update(float delta);
+  void draw(SceneContext&amp; gc);
+private:
+  void explode();
+  Bomb (const Bomb&amp;);
+  Bomb&amp; operator= (const Bomb&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/bomb.hxx
===================================================================
--- trunk/src/bomb.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/bomb.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,55 +0,0 @@
-//  $Id: bomb.hxx,v 1.2 2003/09/28 10:55:34 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_BOMB_HXX
-#define HEADER_BOMB_HXX
-
-#include &lt;ClanLib/Display/sprite.h&gt;
-#include &lt;ClanLib/Core/Math/point.h&gt;
-#include &quot;game_object.hxx&quot;
-
-/** */
-class Bomb : public GameObject
-{
-private:
-  CL_Sprite sprite;
-  CL_Sprite explo;
-  CL_Sprite light;
-  CL_Sprite highlight;
-  CL_Sprite explolight;
-  CL_Point pos;
-  float count;
-  enum { COUNTDOWN, EXPLODE } state;
-  bool exploded;
-
-public:
-  Bomb(int x, int y);
-  virtual ~Bomb();
-
-  void update(float delta);
-  void draw(SceneContext&amp; gc);
-private:
-  void explode();
-  Bomb (const Bomb&amp;);
-  Bomb&amp; operator= (const Bomb&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/brush.cpp (from rev 502, trunk/src/brush.cxx)
===================================================================
--- trunk/src/brush.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/brush.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,54 @@
+//  $Id: brush.cxx,v 1.1 2003/11/05 22:51:27 grumbel Exp $
+//
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2003 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;globals.hpp&quot;
+#include &quot;brush.hpp&quot;
+
+Brush::Brush(const std::string&amp; res, CL_Point pos, bool blink)
+  : sprite(res, resources),
+    pos(pos),
+    blink(blink),
+    passed_time(0)
+{
+  if (blink)
+    sprite.set_blend_func(blend_src_alpha, blend_one);
+}
+
+Brush::~Brush()
+{
+}
+
+void
+Brush::draw(SceneContext&amp; )
+{
+  sprite.draw(pos.x, pos.y);
+}
+
+void
+Brush::update(float delta)
+{
+  passed_time += delta;
+
+  if (blink)
+    {
+      sprite.set_alpha(cos(passed_time*3.141f)*.2f + .8f);
+    }
+}
+
+/* EOF */

Deleted: trunk/src/brush.cxx
===================================================================
--- trunk/src/brush.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/brush.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,54 +0,0 @@
-//  $Id: brush.cxx,v 1.1 2003/11/05 22:51:27 grumbel Exp $
-//
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2003 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;globals.hxx&quot;
-#include &quot;brush.hxx&quot;
-
-Brush::Brush(const std::string&amp; res, CL_Point pos, bool blink)
-  : sprite(res, resources),
-    pos(pos),
-    blink(blink),
-    passed_time(0)
-{
-  if (blink)
-    sprite.set_blend_func(blend_src_alpha, blend_one);
-}
-
-Brush::~Brush()
-{
-}
-
-void
-Brush::draw(SceneContext&amp; )
-{
-  sprite.draw(pos.x, pos.y);
-}
-
-void
-Brush::update(float delta)
-{
-  passed_time += delta;
-
-  if (blink)
-    {
-      sprite.set_alpha(cos(passed_time*3.141f)*.2f + .8f);
-    }
-}
-
-/* EOF */

Copied: trunk/src/brush.hpp (from rev 502, trunk/src/brush.hxx)
===================================================================
--- trunk/src/brush.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/brush.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,49 @@
+//  $Id: brush.hpp,v 1.1 2003/11/05 22:51:27 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2003 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_BRUSH_HXX
+#define HEADER_BRUSH_HXX
+
+#include &lt;ClanLib/Display/sprite.h&gt;
+#include &quot;game_object.hpp&quot;
+
+/** */
+class Brush : public GameObject
+{
+private:
+  CL_Sprite sprite;
+  CL_Point pos;
+  bool blink;
+  float passed_time;
+
+public:
+  Brush(const std::string&amp; res, CL_Point pos, bool blink);
+  virtual ~Brush();
+
+  void draw(SceneContext&amp; gc);
+  void update(float delta);
+
+private:
+  Brush (const Brush&amp;);
+  Brush&amp; operator= (const Brush&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/brush.hxx
===================================================================
--- trunk/src/brush.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/brush.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,49 +0,0 @@
-//  $Id: brush.hxx,v 1.1 2003/11/05 22:51:27 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2003 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_BRUSH_HXX
-#define HEADER_BRUSH_HXX
-
-#include &lt;ClanLib/Display/sprite.h&gt;
-#include &quot;game_object.hxx&quot;
-
-/** */
-class Brush : public GameObject
-{
-private:
-  CL_Sprite sprite;
-  CL_Point pos;
-  bool blink;
-  float passed_time;
-
-public:
-  Brush(const std::string&amp; res, CL_Point pos, bool blink);
-  virtual ~Brush();
-
-  void draw(SceneContext&amp; gc);
-  void update(float delta);
-
-private:
-  Brush (const Brush&amp;);
-  Brush&amp; operator= (const Brush&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/camera.cpp (from rev 502, trunk/src/camera.cxx)
===================================================================
--- trunk/src/camera.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/camera.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,71 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;player.hpp&quot;
+#include &quot;sector.hpp&quot;
+#include &quot;camera.hpp&quot;
+
+Camera* Camera::current_ = 0;
+
+Camera::Camera()
+  : pos(0, 0)
+{
+  current_ = this;
+}
+
+void
+Camera::update(float )
+{
+  int hscroll_threshold = 100;
+  int vscroll_threshold = 150;
+
+  CL_Vector tpos = Player::current()-&gt;get_pos();
+
+  float dist = tpos.x - pos.x;
+  if (dist &gt; hscroll_threshold)
+    pos.x = tpos.x - hscroll_threshold;
+  else if (dist &lt; - hscroll_threshold)
+    pos.x = tpos.x + hscroll_threshold;
+
+  dist = tpos.y - pos.y;
+  if (dist &gt; vscroll_threshold)
+    pos.y = tpos.y - vscroll_threshold;
+  else if (dist &lt; -vscroll_threshold)
+    pos.y = tpos.y + vscroll_threshold;
+
+  int start_x = CL_Display::get_width()/2;
+  int end_x   = Sector::current()-&gt;get_width() - CL_Display::get_width()/2;
+
+  int start_y = CL_Display::get_height()/2;
+  int end_y   = Sector::current()-&gt;get_height() - CL_Display::get_height()/2;
+
+  if (pos.x &lt; start_x)
+    pos.x = start_x;
+
+  if (pos.y &lt; start_y)
+    pos.y = start_y;
+
+  if (pos.x &gt; end_x)
+    pos.x = end_x;
+
+  if (pos.y &gt; end_y)
+    pos.y = end_y;
+}
+
+/* EOF */

Deleted: trunk/src/camera.cxx
===================================================================
--- trunk/src/camera.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/camera.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,71 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;player.hxx&quot;
-#include &quot;sector.hxx&quot;
-#include &quot;camera.hxx&quot;
-
-Camera* Camera::current_ = 0;
-
-Camera::Camera()
-  : pos(0, 0)
-{
-  current_ = this;
-}
-
-void
-Camera::update(float )
-{
-  int hscroll_threshold = 100;
-  int vscroll_threshold = 150;
-
-  CL_Vector tpos = Player::current()-&gt;get_pos();
-
-  float dist = tpos.x - pos.x;
-  if (dist &gt; hscroll_threshold)
-    pos.x = tpos.x - hscroll_threshold;
-  else if (dist &lt; - hscroll_threshold)
-    pos.x = tpos.x + hscroll_threshold;
-
-  dist = tpos.y - pos.y;
-  if (dist &gt; vscroll_threshold)
-    pos.y = tpos.y - vscroll_threshold;
-  else if (dist &lt; -vscroll_threshold)
-    pos.y = tpos.y + vscroll_threshold;
-
-  int start_x = CL_Display::get_width()/2;
-  int end_x   = Sector::current()-&gt;get_width() - CL_Display::get_width()/2;
-
-  int start_y = CL_Display::get_height()/2;
-  int end_y   = Sector::current()-&gt;get_height() - CL_Display::get_height()/2;
-
-  if (pos.x &lt; start_x)
-    pos.x = start_x;
-
-  if (pos.y &lt; start_y)
-    pos.y = start_y;
-
-  if (pos.x &gt; end_x)
-    pos.x = end_x;
-
-  if (pos.y &gt; end_y)
-    pos.y = end_y;
-}
-
-/* EOF */

Copied: trunk/src/camera.hpp (from rev 502, trunk/src/camera.hxx)

Deleted: trunk/src/camera.hxx
===================================================================
--- trunk/src/camera.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/camera.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,47 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_CAMERA_HXX
-#define HEADER_CAMERA_HXX
-
-/** This class manages the virtual camera movement, it follows the
-    player, allows the player to watch around, might zoom out if
-    interesting stuff happens out of the screen and such
- */
-class Camera
-{
-private:
-  CL_Vector pos;
-
-  static Camera* current_;
-public:
-  static Camera* current() { return current_; }
-
-  Camera();
-
-  void update(float delta);
-  CL_Pointf get_pos() const { return CL_Pointf(pos.x, pos.y); }
-private:
-  Camera (const Camera&amp;);
-  Camera&amp; operator= (const Camera&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/collision_manager.cpp (from rev 502, trunk/src/collision_manager.cxx)
===================================================================
--- trunk/src/collision_manager.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/collision_manager.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,216 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;assert.h&gt;
+#include &quot;collision_manager.hpp&quot;
+
+CollisionManager::CollisionManager()
+{
+}
+
+void
+CollisionManager::update(float delta)
+{
+}
+
+void
+CollisionManager::add(const CL_Rect&amp; rect)
+{
+  rects.push_back(rect);
+}
+
+bool
+CollisionManager::range_overlaps(float a1, float a2, float b1, float b2)
+{
+  assert(a1 &lt; a2);
+  assert(b1 &lt; b2);
+
+  return !(a2 &lt; b1 || b2 &lt; a1);
+}
+
+CollisionManager::SweepResult
+CollisionManager::sweep_helper(float a1, float a2,
+                               float b1, float b2, float v)
+{
+  assert(a1 &lt; a2);
+  assert(b1 &lt; b2);
+  
+  SweepResult result;
+
+  if( v &lt; 0 ) 
+    { // collision from u0, to u1
+      result.u0 = (a2 - b1) / v;
+      result.u1 = (a1 - b2) / v; 
+
+      result.num = CO_SOMETIME;
+    } 
+  else if( v &gt; 0 ) 
+    { // collision from u0, to u1
+      result.u0 = (a1 - b2) / v;
+      result.u1 = (a2 - b1) / v; 
+
+      result.num = CO_SOMETIME;
+    }
+  else // v == 0
+    {
+      if (a2 &lt;= b1 || a1 &gt;= b2)
+        result.num = CO_NEVER;
+      else
+        result.num = CO_ALWAYS;
+    }
+
+  return result;
+}
+
+CollisionManager::CollisionResult
+CollisionManager::sweep(CL_Sizef a_s, CL_Vector a_pos1, CL_Vector a_pos2,
+                        CL_Sizef b_s, CL_Vector b_pos1, CL_Vector b_pos2)
+{
+  // For more info on the algorithm see:
+  // <A HREF="http://www.gamasutra.com/features/19991018/Gomez_3.htm">http://www.gamasutra.com/features/19991018/Gomez_3.htm</A>
+
+  CL_Rectf a(CL_Pointf(a_pos1.x, a_pos1.y), a_s);
+  CL_Rectf b(CL_Pointf(b_pos1.x, b_pos1.y), b_s);
+
+  CL_Vector v = (b_pos2 - b_pos1) - (a_pos2 - a_pos1);
+
+  // the problem is solved in A's frame of reference, v is the
+  // relative velocity of B in relation to A
+
+  SweepResult x_axis = sweep_helper(a.left, a.right,  b.left, b.right,  v.x);
+  SweepResult y_axis = sweep_helper(a.top,  a.bottom, b.top,  b.bottom, v.y);
+
+  CollisionResult result(CO_NONE, 0, 0);
+
+  if (x_axis.num == CO_NEVER || y_axis.num == CO_NEVER)
+    { // One axis doesn't collide, so both can never collide at
+      // the same time
+      return CollisionResult(CO_NONE, 0, 0);
+    }
+  else if (x_axis.num == CO_ALWAYS &amp;&amp; y_axis.num == CO_ALWAYS)
+    {
+      return CollisionResult(CO_UNKNOWN, 0, 0);
+    }
+  else if (x_axis.num == CO_SOMETIME &amp;&amp; y_axis.num == CO_SOMETIME)
+    { // Both axis collide sometime, so figure out when
+      result.u0 = std::max(x_axis.u0, y_axis.u0);
+      result.u1 = std::min(x_axis.u1, y_axis.u1);
+
+      if (result.u0 == x_axis.u0)
+        {
+          if (v.x &gt; 0)
+            result.side = CO_LEFT;
+          else if (v.x &lt; 0)
+            result.side = CO_RIGHT;
+          else
+            result.side = CO_UNKNOWN;
+        }
+      else if (result.u0 == y_axis.u0)
+        {
+          if (v.y &gt; 0)
+            result.side = CO_TOP;
+          else if (v.y &lt; 0)
+            result.side = CO_BOTTOM;
+          else
+            result.side = CO_UNKNOWN;
+        }
+      else
+        {
+          assert(!&quot;Should never be reached&quot;);
+        }
+
+      if (result.u1 == x_axis.u1)
+        {
+          if (v.x &lt; 0)
+            result.side_out = CO_LEFT;
+          else if (v.x &gt; 0)
+            result.side_out = CO_RIGHT;
+          else
+            result.side_out = CO_UNKNOWN;
+        }
+      else if (result.u1 == y_axis.u1)
+        {
+          if (v.y &lt; 0)
+            result.side_out = CO_TOP;
+          else if (v.y &gt; 0)
+            result.side_out = CO_BOTTOM;
+          else
+            result.side_out = CO_UNKNOWN;
+        }
+      else
+        {
+          assert(!&quot;Should never be reached&quot;);
+        }
+    }
+  else if (x_axis.num == CO_ALWAYS &amp;&amp; y_axis.num == CO_SOMETIME)
+    {
+      result.u0 = y_axis.u0;
+      result.u1 = y_axis.u1;
+      
+      if (v.y &gt; 0)
+        result.side = CO_TOP;
+      else if (v.y &lt; 0)
+        result.side = CO_BOTTOM;
+      else
+        assert(0);
+    }
+  else if (x_axis.num == CO_SOMETIME &amp;&amp; y_axis.num == CO_ALWAYS)
+    {
+      result.u0 = x_axis.u0;
+      result.u1 = x_axis.u1;
+
+      if (v.x &gt; 0)
+        result.side = CO_LEFT;
+      else if (v.x &lt; 0)
+        result.side = CO_RIGHT;
+      else
+        assert(0);
+    }
+  else
+    {
+      assert(!&quot;Should never be reached&quot;);
+    }
+
+  if (result.u0 &lt; result.u1)
+    { // Range is valid
+      if (result.u0 &lt; 0 &amp;&amp; result.u1 &gt;= 1.0f)
+        { // We are inside a collision
+          return CollisionResult(CO_UNKNOWN, 0, 0);
+        }
+      else if (result.u0 &gt;= 0 &amp;&amp; result.u0 &lt; 1.0f)
+        { // Collision happens in the range of the movement
+        }
+      else
+        {
+          result.side     = CO_NONE;
+          return CollisionResult(CO_NONE, 0, 0);
+        }
+      // FIXME: Add side_out code
+    }
+  else
+    {
+      result.side     = CO_NONE;
+      result.side_out = CO_NONE;
+    }
+
+  return result;
+}
+
+/* EOF */
+

Deleted: trunk/src/collision_manager.cxx
===================================================================
--- trunk/src/collision_manager.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/collision_manager.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,216 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;assert.h&gt;
-#include &quot;collision_manager.hxx&quot;
-
-CollisionManager::CollisionManager()
-{
-}
-
-void
-CollisionManager::update(float delta)
-{
-}
-
-void
-CollisionManager::add(const CL_Rect&amp; rect)
-{
-  rects.push_back(rect);
-}
-
-bool
-CollisionManager::range_overlaps(float a1, float a2, float b1, float b2)
-{
-  assert(a1 &lt; a2);
-  assert(b1 &lt; b2);
-
-  return !(a2 &lt; b1 || b2 &lt; a1);
-}
-
-CollisionManager::SweepResult
-CollisionManager::sweep_helper(float a1, float a2,
-                               float b1, float b2, float v)
-{
-  assert(a1 &lt; a2);
-  assert(b1 &lt; b2);
-  
-  SweepResult result;
-
-  if( v &lt; 0 ) 
-    { // collision from u0, to u1
-      result.u0 = (a2 - b1) / v;
-      result.u1 = (a1 - b2) / v; 
-
-      result.num = CO_SOMETIME;
-    } 
-  else if( v &gt; 0 ) 
-    { // collision from u0, to u1
-      result.u0 = (a1 - b2) / v;
-      result.u1 = (a2 - b1) / v; 
-
-      result.num = CO_SOMETIME;
-    }
-  else // v == 0
-    {
-      if (a2 &lt;= b1 || a1 &gt;= b2)
-        result.num = CO_NEVER;
-      else
-        result.num = CO_ALWAYS;
-    }
-
-  return result;
-}
-
-CollisionManager::CollisionResult
-CollisionManager::sweep(CL_Sizef a_s, CL_Vector a_pos1, CL_Vector a_pos2,
-                        CL_Sizef b_s, CL_Vector b_pos1, CL_Vector b_pos2)
-{
-  // For more info on the algorithm see:
-  // <A HREF="http://www.gamasutra.com/features/19991018/Gomez_3.htm">http://www.gamasutra.com/features/19991018/Gomez_3.htm</A>
-
-  CL_Rectf a(CL_Pointf(a_pos1.x, a_pos1.y), a_s);
-  CL_Rectf b(CL_Pointf(b_pos1.x, b_pos1.y), b_s);
-
-  CL_Vector v = (b_pos2 - b_pos1) - (a_pos2 - a_pos1);
-
-  // the problem is solved in A's frame of reference, v is the
-  // relative velocity of B in relation to A
-
-  SweepResult x_axis = sweep_helper(a.left, a.right,  b.left, b.right,  v.x);
-  SweepResult y_axis = sweep_helper(a.top,  a.bottom, b.top,  b.bottom, v.y);
-
-  CollisionResult result(CO_NONE, 0, 0);
-
-  if (x_axis.num == CO_NEVER || y_axis.num == CO_NEVER)
-    { // One axis doesn't collide, so both can never collide at
-      // the same time
-      return CollisionResult(CO_NONE, 0, 0);
-    }
-  else if (x_axis.num == CO_ALWAYS &amp;&amp; y_axis.num == CO_ALWAYS)
-    {
-      return CollisionResult(CO_UNKNOWN, 0, 0);
-    }
-  else if (x_axis.num == CO_SOMETIME &amp;&amp; y_axis.num == CO_SOMETIME)
-    { // Both axis collide sometime, so figure out when
-      result.u0 = std::max(x_axis.u0, y_axis.u0);
-      result.u1 = std::min(x_axis.u1, y_axis.u1);
-
-      if (result.u0 == x_axis.u0)
-        {
-          if (v.x &gt; 0)
-            result.side = CO_LEFT;
-          else if (v.x &lt; 0)
-            result.side = CO_RIGHT;
-          else
-            result.side = CO_UNKNOWN;
-        }
-      else if (result.u0 == y_axis.u0)
-        {
-          if (v.y &gt; 0)
-            result.side = CO_TOP;
-          else if (v.y &lt; 0)
-            result.side = CO_BOTTOM;
-          else
-            result.side = CO_UNKNOWN;
-        }
-      else
-        {
-          assert(!&quot;Should never be reached&quot;);
-        }
-
-      if (result.u1 == x_axis.u1)
-        {
-          if (v.x &lt; 0)
-            result.side_out = CO_LEFT;
-          else if (v.x &gt; 0)
-            result.side_out = CO_RIGHT;
-          else
-            result.side_out = CO_UNKNOWN;
-        }
-      else if (result.u1 == y_axis.u1)
-        {
-          if (v.y &lt; 0)
-            result.side_out = CO_TOP;
-          else if (v.y &gt; 0)
-            result.side_out = CO_BOTTOM;
-          else
-            result.side_out = CO_UNKNOWN;
-        }
-      else
-        {
-          assert(!&quot;Should never be reached&quot;);
-        }
-    }
-  else if (x_axis.num == CO_ALWAYS &amp;&amp; y_axis.num == CO_SOMETIME)
-    {
-      result.u0 = y_axis.u0;
-      result.u1 = y_axis.u1;
-      
-      if (v.y &gt; 0)
-        result.side = CO_TOP;
-      else if (v.y &lt; 0)
-        result.side = CO_BOTTOM;
-      else
-        assert(0);
-    }
-  else if (x_axis.num == CO_SOMETIME &amp;&amp; y_axis.num == CO_ALWAYS)
-    {
-      result.u0 = x_axis.u0;
-      result.u1 = x_axis.u1;
-
-      if (v.x &gt; 0)
-        result.side = CO_LEFT;
-      else if (v.x &lt; 0)
-        result.side = CO_RIGHT;
-      else
-        assert(0);
-    }
-  else
-    {
-      assert(!&quot;Should never be reached&quot;);
-    }
-
-  if (result.u0 &lt; result.u1)
-    { // Range is valid
-      if (result.u0 &lt; 0 &amp;&amp; result.u1 &gt;= 1.0f)
-        { // We are inside a collision
-          return CollisionResult(CO_UNKNOWN, 0, 0);
-        }
-      else if (result.u0 &gt;= 0 &amp;&amp; result.u0 &lt; 1.0f)
-        { // Collision happens in the range of the movement
-        }
-      else
-        {
-          result.side     = CO_NONE;
-          return CollisionResult(CO_NONE, 0, 0);
-        }
-      // FIXME: Add side_out code
-    }
-  else
-    {
-      result.side     = CO_NONE;
-      result.side_out = CO_NONE;
-    }
-
-  return result;
-}
-
-/* EOF */
-

Copied: trunk/src/collision_manager.hpp (from rev 502, trunk/src/collision_manager.hxx)

Deleted: trunk/src/collision_manager.hxx
===================================================================
--- trunk/src/collision_manager.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/collision_manager.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,100 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_COLLISION_MANAGER_HXX
-#define HEADER_COLLISION_MANAGER_HXX
-
-#include &lt;vector&gt;
-#include &lt;ClanLib/Core/Math/rect.h&gt;
-#include &lt;ClanLib/Core/Math/cl_vector.h&gt;
-#include &lt;ClanLib/Core/Math/size.h&gt;
-
-/** */
-class CollisionManager
-{
-private:
-  std::vector&lt;CL_Rect&gt; rects;
-public:
-  enum Side { CO_NONE, // Objects did not collide
-              CO_UNKNOWN, // Objects collide, but its not know where
-              CO_TOP, CO_BOTTOM, CO_LEFT, CO_RIGHT }; 
-
-  enum Num { CO_ALWAYS, CO_NEVER, CO_SOMETIME };
-  struct SweepResult {
-    Num   num;
-    float u0;
-    float u1;
-  };
-
-  struct CollisionResult {
-    /** Side at which the collision starts */
-    Side  side;
-
-    /** Side at which the collision ends */
-    Side  side_out;
-
-    /** first times of overlap along each axis */
-    float u0;
-    
-    /** last times of overlap along each axis, if 1.0f collision
-        occurs still at the end of the movement */
-    float u1;
-    
-    CollisionResult()
-      : side(CO_NONE), side_out(CO_UNKNOWN), u0(0.0f), u1(1.0f)
-    {
-    }
-
-    CollisionResult(Side side_, float u0_, float u1_)
-      : side(side_), u0(u0_), u1(u1_)
-    {}
-  };
-
-  CollisionManager();
-  
-  void update(float delta);
-
-  void add(const CL_Rect&amp; rect);
-  CollisionResult sweep(CL_Sizef a, CL_Vector a_pos1, CL_Vector a_pos2,
-                        CL_Sizef b, CL_Vector b_pos1, CL_Vector b_pos2);
-
-  bool range_overlaps(float a1, float a2, float b1, float b2);
-
-  /** Sweep test for a single axis, returns true if [a1,a2[ and
-      [b1,b2[ collide at some point in time, the time is saved in u0
-      and u1, if false is returned u0 and u1 are undefined.
-
-      @param a1 start of the first range
-      @param a2 end of the first range
-      @param b1 start of the second range
-      @param b2 end of the second range
-      @param v  the amount of space that b moves relative to a
-      @param u0 time at which both ranged a and b start to collide
-      @param u1 time at which both ranged a and b get disjunked and no longer collide
-  */
-  inline SweepResult sweep_helper(float a1, float a2,
-                                  float b1, float b2, float v);
-private:
-  CollisionManager (const CollisionManager&amp;);
-  CollisionManager&amp; operator= (const CollisionManager&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/console.cpp (from rev 502, trunk/src/console.cxx)
===================================================================
--- trunk/src/console.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/console.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,199 @@
+//  $Id: console.cxx,v 1.3 2003/06/08 15:49:00 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;assert.h&gt;
+#include &lt;ClanLib/Display/keys.h&gt;
+#include &lt;ClanLib/Display/keyboard.h&gt;
+#include &lt;ClanLib/core.h&gt;
+#include &quot;fonts.hpp&quot;
+#include &quot;game_session.hpp&quot;
+#include &quot;input/input_manager.hpp&quot;
+#include &quot;console.hpp&quot;
+
+Console* Console::current_ = 0;
+
+Console::Console(int arg_x, int arg_y)
+{
+  current_ = this;
+  x_pos = arg_x;
+  y_pos = arg_y;
+  active = false;
+  history_position = 1;
+}
+
+Console* 
+Console::current()
+{
+  assert(current_);
+  return current_;
+}
+
+void
+Console::add(const std::string&amp; str)
+{
+  ConsoleEntry entry;
+  entry.display_time = 0;
+  entry.message = str;
+  buffer.push_back(entry);
+}
+
+void
+Console::draw()
+{
+  CL_Font font = Fonts::copyright;
+  int y = y_pos;
+
+  if (active)
+    y -= font.get_height() + 2;
+
+  font.set_alignment(origin_bottom_left);
+  // FIXME: only display stuff that would end up on the screen
+  for(Buffer::reverse_iterator i = buffer.rbegin(); i != buffer.rend(); ++i)
+    {
+      if (i-&gt;display_time &lt; 5.0f || is_active())
+        {
+          font.set_color(CL_Color(225, 225, 255));
+          if (i-&gt;display_time &gt; 4.0f &amp;&amp; !is_active())
+            font.set_alpha(1.0f - (i-&gt;display_time - 4.0f));
+          else
+            font.set_alpha(1.0f);
+
+          font.draw(x_pos, y, i-&gt;message);
+        }
+      y -= font.get_height() + 2;
+    }
+
+  font.set_color(CL_Color(255, 255, 255));
+  if (active)
+    {
+      font.set_alignment(origin_bottom_left);
+      font.set_alpha(1.0f);
+      font.draw(x_pos, y_pos, &quot;&gt;&quot; + command_line);
+    }
+}
+
+void
+Console::update(float delta)
+{
+  for(Buffer::iterator i = buffer.begin(); i != buffer.end(); ++i)
+    {
+      i-&gt;display_time += delta;
+    }  
+
+  if (active)
+    {
+      InputEventLst events = InputManager::get_controller().get_events();
+  
+      for (InputEventLst::iterator i = events.begin(); i != events.end(); ++i)
+        {
+          if ((*i).type == KEYBOARD_EVENT)
+            {
+              if ((*i).keyboard.key_type == KeyboardEvent::LETTER)
+                {
+                  //std::cout &lt;&lt; &quot;Key: '&quot; &lt;&lt; (char)((*i).keyboard.code) &lt;&lt; &quot;' &quot; &lt;&lt; (*i).keyboard.code &lt;&lt; std::endl;
+                  command_line += (char)(*i).keyboard.code;
+                }
+              else if ((*i).keyboard.key_type == KeyboardEvent::SPECIAL)
+                {
+                  switch (i-&gt;keyboard.code)
+                    {
+                    case CL_KEY_BACKSPACE:
+                      if (!command_line.empty())
+                        command_line = command_line.substr(0, command_line.size() - 1);
+                      break;
+
+                    case CL_KEY_DOWN:
+                      if (!history.empty())
+                        {
+                          history_position += 1;
+                          if (history_position &gt; int(history.size())-1)
+                            history_position = int(history.size())-1;
+                          command_line = history[history_position];
+                        }
+                      break;
+
+                    case CL_KEY_UP:
+                      if (!history.empty())
+                        {
+                          history_position -= 1;
+                          if (history_position &lt; 0)
+                            history_position = 0;
+
+                          command_line = history[history_position];
+                        }
+                      break;
+
+                    case CL_KEY_ENTER:
+                      if (history.empty() || history.back() != command_line)
+                        {
+                          history.push_back(command_line);
+                          history_position = history.size();
+                        }
+                      add(&quot;&gt;&quot; + command_line);
+                      if (command_line == &quot;quit&quot; || command_line == &quot;exit&quot;)
+                        {
+                          deactive();
+                        }
+                      else if (command_line == &quot;help&quot;)
+                        {
+                          add(&quot;This is a script console, can enter stuff in here that will then be evaluated.&quot;);
+                          add(&quot;Type 'quit' to exit the console.&quot;);
+                        }
+                      else if (command_line == &quot;reset&quot;)
+                        {
+                          GameSession::current()-&gt;set_sector(&quot;levels/newformat2.wst&quot;);
+                        }
+                      else
+                        {
+                          GameSession::current()-&gt;execute(command_line);
+                        }
+                      command_line = &quot;&quot;;
+                      break;
+
+                    case CL_KEY_F1:
+                      deactive();
+                      break;
+                    }
+                }
+            }
+        }
+    }
+}
+
+void
+Console::activate()
+{
+  // Get rid of all input events so that we don't double press
+  InputManager::clear();
+  active = true;
+}
+
+void
+Console::deactive()
+{
+  active = false;
+}
+
+bool
+Console::is_active() const
+{
+  return active;
+}
+
+/* EOF */

Deleted: trunk/src/console.cxx
===================================================================
--- trunk/src/console.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/console.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,199 +0,0 @@
-//  $Id: console.cxx,v 1.3 2003/06/08 15:49:00 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;assert.h&gt;
-#include &lt;ClanLib/Display/keys.h&gt;
-#include &lt;ClanLib/Display/keyboard.h&gt;
-#include &lt;ClanLib/core.h&gt;
-#include &quot;fonts.hxx&quot;
-#include &quot;game_session.hxx&quot;
-#include &quot;input/input_manager.hxx&quot;
-#include &quot;console.hxx&quot;
-
-Console* Console::current_ = 0;
-
-Console::Console(int arg_x, int arg_y)
-{
-  current_ = this;
-  x_pos = arg_x;
-  y_pos = arg_y;
-  active = false;
-  history_position = 1;
-}
-
-Console* 
-Console::current()
-{
-  assert(current_);
-  return current_;
-}
-
-void
-Console::add(const std::string&amp; str)
-{
-  ConsoleEntry entry;
-  entry.display_time = 0;
-  entry.message = str;
-  buffer.push_back(entry);
-}
-
-void
-Console::draw()
-{
-  CL_Font font = Fonts::copyright;
-  int y = y_pos;
-
-  if (active)
-    y -= font.get_height() + 2;
-
-  font.set_alignment(origin_bottom_left);
-  // FIXME: only display stuff that would end up on the screen
-  for(Buffer::reverse_iterator i = buffer.rbegin(); i != buffer.rend(); ++i)
-    {
-      if (i-&gt;display_time &lt; 5.0f || is_active())
-        {
-          font.set_color(CL_Color(225, 225, 255));
-          if (i-&gt;display_time &gt; 4.0f &amp;&amp; !is_active())
-            font.set_alpha(1.0f - (i-&gt;display_time - 4.0f));
-          else
-            font.set_alpha(1.0f);
-
-          font.draw(x_pos, y, i-&gt;message);
-        }
-      y -= font.get_height() + 2;
-    }
-
-  font.set_color(CL_Color(255, 255, 255));
-  if (active)
-    {
-      font.set_alignment(origin_bottom_left);
-      font.set_alpha(1.0f);
-      font.draw(x_pos, y_pos, &quot;&gt;&quot; + command_line);
-    }
-}
-
-void
-Console::update(float delta)
-{
-  for(Buffer::iterator i = buffer.begin(); i != buffer.end(); ++i)
-    {
-      i-&gt;display_time += delta;
-    }  
-
-  if (active)
-    {
-      InputEventLst events = InputManager::get_controller().get_events();
-  
-      for (InputEventLst::iterator i = events.begin(); i != events.end(); ++i)
-        {
-          if ((*i).type == KEYBOARD_EVENT)
-            {
-              if ((*i).keyboard.key_type == KeyboardEvent::LETTER)
-                {
-                  //std::cout &lt;&lt; &quot;Key: '&quot; &lt;&lt; (char)((*i).keyboard.code) &lt;&lt; &quot;' &quot; &lt;&lt; (*i).keyboard.code &lt;&lt; std::endl;
-                  command_line += (char)(*i).keyboard.code;
-                }
-              else if ((*i).keyboard.key_type == KeyboardEvent::SPECIAL)
-                {
-                  switch (i-&gt;keyboard.code)
-                    {
-                    case CL_KEY_BACKSPACE:
-                      if (!command_line.empty())
-                        command_line = command_line.substr(0, command_line.size() - 1);
-                      break;
-
-                    case CL_KEY_DOWN:
-                      if (!history.empty())
-                        {
-                          history_position += 1;
-                          if (history_position &gt; int(history.size())-1)
-                            history_position = int(history.size())-1;
-                          command_line = history[history_position];
-                        }
-                      break;
-
-                    case CL_KEY_UP:
-                      if (!history.empty())
-                        {
-                          history_position -= 1;
-                          if (history_position &lt; 0)
-                            history_position = 0;
-
-                          command_line = history[history_position];
-                        }
-                      break;
-
-                    case CL_KEY_ENTER:
-                      if (history.empty() || history.back() != command_line)
-                        {
-                          history.push_back(command_line);
-                          history_position = history.size();
-                        }
-                      add(&quot;&gt;&quot; + command_line);
-                      if (command_line == &quot;quit&quot; || command_line == &quot;exit&quot;)
-                        {
-                          deactive();
-                        }
-                      else if (command_line == &quot;help&quot;)
-                        {
-                          add(&quot;This is a script console, can enter stuff in here that will then be evaluated.&quot;);
-                          add(&quot;Type 'quit' to exit the console.&quot;);
-                        }
-                      else if (command_line == &quot;reset&quot;)
-                        {
-                          GameSession::current()-&gt;set_sector(&quot;levels/newformat2.wst&quot;);
-                        }
-                      else
-                        {
-                          GameSession::current()-&gt;execute(command_line);
-                        }
-                      command_line = &quot;&quot;;
-                      break;
-
-                    case CL_KEY_F1:
-                      deactive();
-                      break;
-                    }
-                }
-            }
-        }
-    }
-}
-
-void
-Console::activate()
-{
-  // Get rid of all input events so that we don't double press
-  InputManager::clear();
-  active = true;
-}
-
-void
-Console::deactive()
-{
-  active = false;
-}
-
-bool
-Console::is_active() const
-{
-  return active;
-}
-
-/* EOF */

Copied: trunk/src/console.hpp (from rev 502, trunk/src/console.hxx)
===================================================================
--- trunk/src/console.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/console.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,77 @@
+//  $Id: console.hpp,v 1.2 2003/06/08 15:49:00 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef CONSOLE_HXX
+#define CONSOLE_HXX
+
+#include &lt;vector&gt;
+#include &lt;sstream&gt;
+
+struct ConsoleEntry {
+  std::string message;
+  float display_time;
+};
+
+/** */
+class Console
+{
+private:
+  int x_pos;
+  int y_pos;
+  typedef std::vector&lt;ConsoleEntry&gt; Buffer;
+  Buffer buffer;
+  static Console* current_;
+  std::string command_line;
+  bool active;
+  std::vector&lt;std::string&gt; history;
+  int history_position;
+public:
+  static Console* current();
+
+  Console(int x, int y);
+  
+  void add(const std::string&amp;);
+  template&lt;class A, class B&gt;
+  void add(const A&amp; a, const B&amp; b) {
+    std::ostringstream s;
+    s &lt;&lt; a &lt;&lt; b;
+    add(s.str());
+  }
+
+  template&lt;class A, class B, class C&gt;
+  void add(const A&amp; a, const B&amp; b, const C&amp; c) {
+    std::ostringstream s;
+    s &lt;&lt; a &lt;&lt; b &lt;&lt; c;
+    add(s.str());
+  }
+
+  void draw();
+  void update(float delta);
+
+  void activate();
+  void deactive();
+  bool is_active() const;
+private:
+  Console (const Console&amp;);
+  Console&amp; operator= (const Console&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/console.hxx
===================================================================
--- trunk/src/console.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/console.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,77 +0,0 @@
-//  $Id: console.hxx,v 1.2 2003/06/08 15:49:00 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef CONSOLE_HXX
-#define CONSOLE_HXX
-
-#include &lt;vector&gt;
-#include &lt;sstream&gt;
-
-struct ConsoleEntry {
-  std::string message;
-  float display_time;
-};
-
-/** */
-class Console
-{
-private:
-  int x_pos;
-  int y_pos;
-  typedef std::vector&lt;ConsoleEntry&gt; Buffer;
-  Buffer buffer;
-  static Console* current_;
-  std::string command_line;
-  bool active;
-  std::vector&lt;std::string&gt; history;
-  int history_position;
-public:
-  static Console* current();
-
-  Console(int x, int y);
-  
-  void add(const std::string&amp;);
-  template&lt;class A, class B&gt;
-  void add(const A&amp; a, const B&amp; b) {
-    std::ostringstream s;
-    s &lt;&lt; a &lt;&lt; b;
-    add(s.str());
-  }
-
-  template&lt;class A, class B, class C&gt;
-  void add(const A&amp; a, const B&amp; b, const C&amp; c) {
-    std::ostringstream s;
-    s &lt;&lt; a &lt;&lt; b &lt;&lt; c;
-    add(s.str());
-  }
-
-  void draw();
-  void update(float delta);
-
-  void activate();
-  void deactive();
-  bool is_active() const;
-private:
-  Console (const Console&amp;);
-  Console&amp; operator= (const Console&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/controller_def.cpp (from rev 502, trunk/src/controller_def.cxx)
===================================================================
--- trunk/src/controller_def.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/controller_def.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,97 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;controller_def.hpp&quot;
+
+int
+ControllerDef::get_button_count()
+{
+  return 7;
+}
+
+int
+ControllerDef::get_axis_count()
+{
+  return 0;
+}
+
+int
+ControllerDef::get_keyboard_count()
+{
+  return 1;
+}
+
+std::string
+ControllerDef::button_id2name(int id)
+{
+  switch (id)
+    {
+    case UP_BUTTON:
+      return &quot;up&quot;;
+    case DOWN_BUTTON:
+      return &quot;down&quot;;
+    case LEFT_BUTTON:
+      return &quot;left&quot;;
+    case RIGHT_BUTTON:
+      return &quot;right&quot;;
+    case FIRE_BUTTON:
+      return &quot;fire&quot;;
+    case JUMP_BUTTON:
+      return &quot;jump&quot;;
+    case RUN_BUTTON:
+      return &quot;run&quot;;
+    default:
+      return &quot;unknown&quot;;
+    }
+}
+
+int
+ControllerDef::button_name2id(const std::string&amp; name)
+{
+  if (name == &quot;up&quot;) 
+    return UP_BUTTON;
+  else if (name == &quot;down&quot;)
+    return DOWN_BUTTON;
+  else if (name == &quot;left&quot;)
+    return LEFT_BUTTON;
+  else if (name == &quot;right&quot;)
+    return (RIGHT_BUTTON);
+  else if (name == &quot;fire&quot;)
+    return FIRE_BUTTON;
+  else if (name == &quot;jump&quot;)
+    return JUMP_BUTTON;
+  else if (name == &quot;run&quot;)
+    return RUN_BUTTON;
+  else
+    return -1;
+}
+
+std::string
+ControllerDef::axis_id2name(int )
+{
+  return &quot;unknown&quot;;
+}
+
+int 
+ControllerDef::axis_name2id(const std::string&amp; )
+{
+  return -1;
+}
+
+/* EOF */

Deleted: trunk/src/controller_def.cxx
===================================================================
--- trunk/src/controller_def.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/controller_def.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,97 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;controller_def.hxx&quot;
-
-int
-ControllerDef::get_button_count()
-{
-  return 7;
-}
-
-int
-ControllerDef::get_axis_count()
-{
-  return 0;
-}
-
-int
-ControllerDef::get_keyboard_count()
-{
-  return 1;
-}
-
-std::string
-ControllerDef::button_id2name(int id)
-{
-  switch (id)
-    {
-    case UP_BUTTON:
-      return &quot;up&quot;;
-    case DOWN_BUTTON:
-      return &quot;down&quot;;
-    case LEFT_BUTTON:
-      return &quot;left&quot;;
-    case RIGHT_BUTTON:
-      return &quot;right&quot;;
-    case FIRE_BUTTON:
-      return &quot;fire&quot;;
-    case JUMP_BUTTON:
-      return &quot;jump&quot;;
-    case RUN_BUTTON:
-      return &quot;run&quot;;
-    default:
-      return &quot;unknown&quot;;
-    }
-}
-
-int
-ControllerDef::button_name2id(const std::string&amp; name)
-{
-  if (name == &quot;up&quot;) 
-    return UP_BUTTON;
-  else if (name == &quot;down&quot;)
-    return DOWN_BUTTON;
-  else if (name == &quot;left&quot;)
-    return LEFT_BUTTON;
-  else if (name == &quot;right&quot;)
-    return (RIGHT_BUTTON);
-  else if (name == &quot;fire&quot;)
-    return FIRE_BUTTON;
-  else if (name == &quot;jump&quot;)
-    return JUMP_BUTTON;
-  else if (name == &quot;run&quot;)
-    return RUN_BUTTON;
-  else
-    return -1;
-}
-
-std::string
-ControllerDef::axis_id2name(int )
-{
-  return &quot;unknown&quot;;
-}
-
-int 
-ControllerDef::axis_name2id(const std::string&amp; )
-{
-  return -1;
-}
-
-/* EOF */

Copied: trunk/src/controller_def.hpp (from rev 502, trunk/src/controller_def.hxx)

Deleted: trunk/src/controller_def.hxx
===================================================================
--- trunk/src/controller_def.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/controller_def.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,46 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_CONTROLLER_DEF_HXX
-#define HEADER_CONTROLLER_DEF_HXX
-
-#include &lt;string&gt;
-
-//enum AxisName       { ORIENTATION_AXIS, ACCELERATE_AXIS, STRAFE_AXIS };
-enum ButtonName     { UP_BUTTON, DOWN_BUTTON, LEFT_BUTTON, RIGHT_BUTTON, FIRE_BUTTON, JUMP_BUTTON, RUN_BUTTON };
-
-/** */
-class ControllerDef
-{
-private:
-public:
-  static int         get_button_count();
-  static int         get_axis_count();
-  static int         get_keyboard_count();
-
-  static std::string button_id2name(int id);
-  static int         button_name2id(const std::string&amp; name);
-
-  static std::string axis_id2name(int id);
-  static int         axis_name2id(const std::string&amp; name);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/default_shoot.cpp (from rev 502, trunk/src/default_shoot.cxx)
===================================================================
--- trunk/src/default_shoot.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/default_shoot.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,69 @@
+//  $Id: default_shoot.cxx,v 1.3 2003/09/12 16:31:20 grumbel Exp $
+//
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;globals.hpp&quot;
+#include &quot;sector.hpp&quot;
+#include &quot;animation_obj.hpp&quot;
+#include &quot;tile_map.hpp&quot;
+#include &quot;default_shoot.hpp&quot;
+
+DefaultShoot::DefaultShoot (const CL_Vector&amp; arg_pos,
+			    DefaultShoot::DirectionState dir)
+  : pos (arg_pos),
+    sprite (&quot;shoot/default&quot;, resources),
+    direction (dir)
+{ 
+}
+
+void
+DefaultShoot::draw (SceneContext&amp; )
+{
+  if (direction)
+    sprite.set_scale (1.0, 1.0);
+  else
+    sprite.set_scale (-1.0, 1.0);
+
+  sprite.draw ((int)pos.x, (int) pos.y);
+}
+
+void
+DefaultShoot::update (float delta)
+{
+  switch (direction)
+    {
+    case WEST:
+      pos.x -= 800 * delta;
+      break;
+    case EAST:
+      pos.x += 800 * delta;
+      break;
+    }
+
+  if (get_world ()-&gt;get_tilemap()-&gt;is_ground (pos.x, pos.y))
+    explode ();
+}
+
+void
+DefaultShoot::explode ()
+{
+  remove ();
+  get_world ()-&gt;add(new AnimationObj (&quot;shoot/explosion&quot;, pos));
+}
+
+/* EOF */

Deleted: trunk/src/default_shoot.cxx
===================================================================
--- trunk/src/default_shoot.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/default_shoot.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,69 +0,0 @@
-//  $Id: default_shoot.cxx,v 1.3 2003/09/12 16:31:20 grumbel Exp $
-//
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;globals.hxx&quot;
-#include &quot;sector.hxx&quot;
-#include &quot;animation_obj.hxx&quot;
-#include &quot;tile_map.hxx&quot;
-#include &quot;default_shoot.hxx&quot;
-
-DefaultShoot::DefaultShoot (const CL_Vector&amp; arg_pos,
-			    DefaultShoot::DirectionState dir)
-  : pos (arg_pos),
-    sprite (&quot;shoot/default&quot;, resources),
-    direction (dir)
-{ 
-}
-
-void
-DefaultShoot::draw (SceneContext&amp; )
-{
-  if (direction)
-    sprite.set_scale (1.0, 1.0);
-  else
-    sprite.set_scale (-1.0, 1.0);
-
-  sprite.draw ((int)pos.x, (int) pos.y);
-}
-
-void
-DefaultShoot::update (float delta)
-{
-  switch (direction)
-    {
-    case WEST:
-      pos.x -= 800 * delta;
-      break;
-    case EAST:
-      pos.x += 800 * delta;
-      break;
-    }
-
-  if (get_world ()-&gt;get_tilemap()-&gt;is_ground (pos.x, pos.y))
-    explode ();
-}
-
-void
-DefaultShoot::explode ()
-{
-  remove ();
-  get_world ()-&gt;add(new AnimationObj (&quot;shoot/explosion&quot;, pos));
-}
-
-/* EOF */

Copied: trunk/src/default_shoot.hpp (from rev 502, trunk/src/default_shoot.hxx)
===================================================================
--- trunk/src/default_shoot.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/default_shoot.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,52 @@
+//  $Id: default_shoot.hpp,v 1.2 2003/08/12 08:24:41 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef DEFAULTSHOOT_HXX
+#define DEFAULTSHOOT_HXX
+
+#include &lt;ClanLib/core.h&gt;
+#include &lt;ClanLib/display.h&gt;
+
+#include &quot;game_object.hpp&quot;
+
+class DefaultShoot : public GameObject
+{
+private:
+  CL_Vector pos;
+  CL_Vector velocity;
+  CL_Sprite sprite;
+
+public:
+  typedef enum { WEST, EAST } DirectionState;
+  typedef enum { SHOOT_DEFAULT, SHOOT_STAGE1, SHOOT_STAGE2 } ShootType; 
+private:
+  DirectionState direction;
+public:
+  DefaultShoot (const CL_Vector&amp; arg_pos,
+		DefaultShoot::DirectionState);
+  virtual ~DefaultShoot () {}
+  void draw (SceneContext&amp; gc);
+  void update (float delta);
+private: 
+  void explode ();
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/default_shoot.hxx
===================================================================
--- trunk/src/default_shoot.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/default_shoot.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,52 +0,0 @@
-//  $Id: default_shoot.hxx,v 1.2 2003/08/12 08:24:41 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef DEFAULTSHOOT_HXX
-#define DEFAULTSHOOT_HXX
-
-#include &lt;ClanLib/core.h&gt;
-#include &lt;ClanLib/display.h&gt;
-
-#include &quot;game_object.hxx&quot;
-
-class DefaultShoot : public GameObject
-{
-private:
-  CL_Vector pos;
-  CL_Vector velocity;
-  CL_Sprite sprite;
-
-public:
-  typedef enum { WEST, EAST } DirectionState;
-  typedef enum { SHOOT_DEFAULT, SHOOT_STAGE1, SHOOT_STAGE2 } ShootType; 
-private:
-  DirectionState direction;
-public:
-  DefaultShoot (const CL_Vector&amp; arg_pos,
-		DefaultShoot::DirectionState);
-  virtual ~DefaultShoot () {}
-  void draw (SceneContext&amp; gc);
-  void update (float delta);
-private: 
-  void explode ();
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/delta_manager.hpp (from rev 502, trunk/src/delta_manager.hxx)
===================================================================
--- trunk/src/delta_manager.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/delta_manager.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,54 @@
+//  $Id: delta_manager.hpp,v 1.2 2003/08/12 08:24:41 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef DELTAMANAGER_HH
+#define DELTAMANAGER_HH
+
+#include &lt;ClanLib/core.h&gt;
+
+class DeltaManager
+{
+private:
+  unsigned int last_time;
+public:
+  DeltaManager ()
+    : last_time (CL_System::get_time ())
+  {}
+
+  float getset ()
+  {
+    float ret = get ();
+    set ();
+    return ret;
+  }
+  
+  void set () 
+  {
+    last_time = CL_System::get_time ();
+  }
+  
+  float get () 
+  {
+    return (CL_System::get_time () - last_time) / 1000.0f;
+  }
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/delta_manager.hxx
===================================================================
--- trunk/src/delta_manager.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/delta_manager.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,54 +0,0 @@
-//  $Id: delta_manager.hxx,v 1.2 2003/08/12 08:24:41 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef DELTAMANAGER_HH
-#define DELTAMANAGER_HH
-
-#include &lt;ClanLib/core.h&gt;
-
-class DeltaManager
-{
-private:
-  unsigned int last_time;
-public:
-  DeltaManager ()
-    : last_time (CL_System::get_time ())
-  {}
-
-  float getset ()
-  {
-    float ret = get ();
-    set ();
-    return ret;
-  }
-  
-  void set () 
-  {
-    last_time = CL_System::get_time ();
-  }
-  
-  float get () 
-  {
-    return (CL_System::get_time () - last_time) / 1000.0f;
-  }
-};
-
-#endif
-
-/* EOF */

Added: trunk/src/dialog_manager.cpp
===================================================================
--- trunk/src/dialog_manager.cpp	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/dialog_manager.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,201 @@
+//  $Id: dialog_manager.cxx,v 1.3 2003/09/30 16:42:26 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ClanLib/Display/display.h&gt;
+#include &lt;iostream&gt;
+#include &quot;fonts.hpp&quot;
+#include &quot;game_session.hpp&quot;
+#include &quot;input/controller.hpp&quot;
+#include &quot;input/input_manager.hpp&quot;
+#include &quot;dialog_manager.hpp&quot;
+#include &quot;script_manager.hpp&quot;
+#include &quot;gameconfig.hpp&quot;
+
+DialogManager* DialogManager::current_ = 0;
+
+Dialog::Dialog(int alignment, const std::string&amp; portrait,
+               const std::string&amp; text)
+  : portrait(portrait, resources), text(text), alignment(alignment)
+{
+}
+
+DialogManager::DialogManager()
+{
+  current_ = this;
+  current_dialog = -1;
+  current_choice = 0;
+}
+
+void
+DialogManager::add_dialog(int alignment, const std::string&amp; portrait,
+                          const std::string&amp; text)
+{
+  dialogs.push_back(Dialog(alignment, portrait, text));
+  current_dialog = dialogs.size()-1;
+}
+
+void
+DialogManager::add_answer(const std::string&amp; text, const std::string&amp; script)
+{
+  Dialog&amp; dialog = dialogs[current_dialog];
+  dialog.answers.push_back(std::make_pair(text, script));
+}
+
+void
+DialogManager::draw()
+{
+  if (current_dialog != -1)
+    {
+      static const int dialog_width = 600;
+      static const int outer_border_x = 20;
+      static const int outer_border_y = 20;
+      static const int portrait_border_x = 10;
+      static const int portrait_border_y = 10;
+      static const int text_border_x = 10;
+      static const int text_border_y = 10;
+      static const int portrait_width = 180;
+      static const int portrait_height = 192;
+
+      Dialog&amp; dialog = dialogs[current_dialog];
+
+      CL_Point pos;
+      if(dialog.alignment &amp; Dialog::LEFT) {
+        pos.x = outer_border_x;
+      } else if(dialog.alignment &amp; Dialog::RIGHT) {
+        pos.x = config-&gt;screen_width - dialog_width - outer_border_x;
+      } else {
+        pos.x = (config-&gt;screen_width - dialog_width) / 2;
+      }
+
+      int text_width
+        = dialog_width - portrait_height - portrait_border_x*2 - text_border_x;
+      CL_Rect text_rect = Fonts::dialog.bounding_rect(
+        CL_Rect(CL_Point(pos.x + portrait_width + portrait_border_x*2, 0),
+                CL_Size(text_width, 600)), dialog.text);
+
+      int dialog_height = std::max(portrait_height + portrait_border_y*2,
+                                   text_rect.get_height() + text_border_y*2);
+
+      if(dialog.answers.size() &gt; 0) 
+          dialog_height += 80;
+
+      if(dialog.alignment &amp; Dialog::TOP) {
+        pos.y = outer_border_y;
+      } else if(dialog.alignment &amp; Dialog::BOTTOM) {
+        pos.y = config-&gt;screen_height - dialog_height - outer_border_y;
+      } else {
+        pos.y = (config-&gt;screen_height - dialog_height) / 2;
+      }
+
+      text_rect.bottom = text_rect.top + text_rect.get_height();
+      text_rect.top = pos.y + text_border_y;
+
+      CL_Size dialog_size(dialog_width, dialog_height);
+      
+      CL_Display::fill_rect(CL_Rect(pos, dialog_size), 
+                            CL_Gradient(CL_Color(0,0,0,228),
+                                        CL_Color(0,0,0,228),
+                                        CL_Color(0,0,0,128),
+                                        CL_Color(0,0,0,128)));
+      CL_Display::draw_rect(CL_Rect(pos, dialog_size),
+                            CL_Color(255,255,255, 80));
+      
+      CL_Display::flush();
+      
+      dialog.portrait.draw(pos.x + portrait_border_x,
+                           pos.y + portrait_border_y);
+      Fonts::dialog.set_alignment(origin_top_left);
+      Fonts::dialog_h.set_alignment(origin_top_left);
+
+      Fonts::dialog.draw(text_rect, dialog.text);
+
+      Fonts::dialog.set_alignment(origin_top_center);
+      Fonts::dialog_h.set_alignment(origin_top_center);
+
+      if (dialog.answers.size() &gt; 0)
+        {
+          int w = (dialog_width/dialog.answers.size());
+          for(Dialogs::size_type i = 0; i &lt; dialog.answers.size(); ++i)
+            {
+              if (int(i) == current_choice)
+                Fonts::dialog_h.draw(pos.x + i*w + w/2,
+                                     pos.y + text_rect.get_height() 
+                                        + text_border_y*2 + 20,
+                                     &quot;[&quot; + dialog.answers[i].first + &quot;]&quot;);
+              else
+                Fonts::dialog.draw(pos.x + i*w + w/2,
+                                   pos.y + text_rect.get_height() 
+                                        + text_border_y*2 + 20,
+                                   dialog.answers[i].first);
+            }
+        }
+    }
+}
+
+void
+DialogManager::update(float )
+{
+  if (current_dialog != -1)
+    {
+      InputEventLst events = InputManager::get_controller().get_events();
+
+      for (InputEventLst::iterator i = events.begin(); i != events.end(); ++i)
+        {
+          if ((*i).type == BUTTON_EVENT)
+            {
+          if ((*i).button.name == FIRE_BUTTON &amp;&amp; (*i).button.down == true)
+            {
+              GameSession::current()-&gt;set_game_state();
+              if (dialogs[current_dialog].answers.size() &gt; 0) {
+                script_manager-&gt;run_script(
+                  dialogs[current_dialog].answers[current_choice].second);
+              }
+            }
+          else if ((*i).button.name == LEFT_BUTTON &amp;&amp; (*i).button.down == true)
+            {
+              current_choice -= 1;
+            }
+          else if ((*i).button.name == RIGHT_BUTTON &amp;&amp; (*i).button.down == true)
+            {
+              current_choice += 1;
+            }
+            }
+        }
+
+      if (current_choice &lt; 0)
+        current_choice = 0;
+      else if (current_choice &gt;= int(dialogs[current_dialog].answers.size()))
+        current_choice = int(dialogs[current_dialog].answers.size()) - 1;
+    }
+  else
+    {
+      std::cout &lt;&lt; &quot;DialogManager: No dialog available&quot; &lt;&lt; std::endl;
+      GameSession::current()-&gt;set_game_state();
+    }
+}
+
+void
+DialogManager::clear()
+{
+  current_dialog = 0;
+  current_choice = 0;
+  dialogs.clear();
+}
+
+/* EOF */

Deleted: trunk/src/dialog_manager.cxx
===================================================================
--- trunk/src/dialog_manager.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/dialog_manager.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,157 +0,0 @@
-//  $Id: dialog_manager.cxx,v 1.3 2003/09/30 16:42:26 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ClanLib/Display/display.h&gt;
-#include &lt;iostream&gt;
-#include &quot;fonts.hxx&quot;
-#include &quot;game_session.hxx&quot;
-#include &quot;input/controller.hxx&quot;
-#include &quot;input/input_manager.hxx&quot;
-#include &quot;dialog_manager.hxx&quot;
-
-DialogManager* DialogManager::current_ = 0;
-
-Dialog::Dialog(const std::string&amp; portrait, const std::string&amp; text)
-  : portrait(portrait, resources), text(text)
-{
-}
-
-DialogManager::DialogManager()
-{
-  current_ = this;
-  current_dialog = -1;
-  current_choice = 0;
-}
-
-void
-DialogManager::add_dialog(const std::string&amp; portrait, const std::string&amp; text)
-{
-  dialogs.push_back(Dialog(portrait, text));
-  current_dialog = dialogs.size()-1;
-}
-
-void
-DialogManager::add_answer(const std::string&amp; text, const RubyFunctor&amp; func)
-{
-  Dialog&amp; dialog = dialogs[current_dialog];
-  dialog.answers.push_back(std::pair&lt;std::string, RubyFunctor&gt;(text, func));
-}
-
-void
-DialogManager::draw()
-{
-  if (current_dialog != -1)
-    {
-      Dialog&amp; dialog = dialogs[current_dialog];
-      
-      CL_Rect text_rect = Fonts::dialog.bounding_rect(CL_Rect(CL_Point(260, 0), CL_Size(420, 600)),
-                                                      dialog.text);
-
-      CL_Display::fill_rect(CL_Rect(CL_Point(100, 100), CL_Size(600, text_rect.get_height() + 80)), 
-                            CL_Gradient(CL_Color(0,0,0,228),
-                                        CL_Color(0,0,0,228),
-                                        CL_Color(0,0,0,128),
-                                        CL_Color(0,0,0,128)));
-      CL_Display::draw_rect(CL_Rect(CL_Point(100, 100), CL_Size(600, text_rect.get_height() + 80)), 
-                            CL_Color(255,255,255, 80));
-      CL_Display::flush();
-      
-      if (0) // portrait background
-        {
-          CL_Display::fill_rect(CL_Rect(CL_Point(120, 120), CL_Size(120, 120)),
-                                CL_Gradient(CL_Color(100,100,100,68), CL_Color(100,100,100,68),
-                                            CL_Color(255,255,255, 255), CL_Color(255,255,255, 255)));
-        }
-      
-      dialog.portrait.draw(120, 120);
-
-      Fonts::dialog.set_alignment(origin_top_left);
-      Fonts::dialog_h.set_alignment(origin_top_left);
-
-      Fonts::dialog.draw(CL_Rect(CL_Point(260, 120), CL_Size(420, 0)),
-                         dialog.text);
-
-      Fonts::dialog.set_alignment(origin_top_center);
-      Fonts::dialog_h.set_alignment(origin_top_center);
-
-      if (dialog.answers.size() &gt; 0)
-        {
-          int w = (500/dialog.answers.size());
-          for(Dialogs::size_type i = 0; i &lt; dialog.answers.size(); ++i)
-            {
-              if (int(i) == current_choice)
-                Fonts::dialog_h.draw(150 + i*w + w/2, 120 + text_rect.get_height() + 20,
-                                     &quot;[&quot; + dialog.answers[i].first + &quot;]&quot;);
-              else
-                Fonts::dialog.draw(150 + i*w + w/2, 120 + text_rect.get_height() + 20,
-                                   dialog.answers[i].first);
-            }
-        }
-    }
-}
-
-void
-DialogManager::update(float )
-{
-  if (current_dialog != -1)
-    {
-      InputEventLst events = InputManager::get_controller().get_events();
-
-      for (InputEventLst::iterator i = events.begin(); i != events.end(); ++i)
-        {
-          if ((*i).type == BUTTON_EVENT)
-            {
-          if ((*i).button.name == FIRE_BUTTON &amp;&amp; (*i).button.down == true)
-            {
-              GameSession::current()-&gt;set_game_state();
-              if (dialogs[current_dialog].answers.size() &gt; 0)
-                dialogs[current_dialog].answers[current_choice].second();
-            }
-          else if ((*i).button.name == LEFT_BUTTON &amp;&amp; (*i).button.down == true)
-            {
-              current_choice -= 1;
-            }
-          else if ((*i).button.name == RIGHT_BUTTON &amp;&amp; (*i).button.down == true)
-            {
-              current_choice += 1;
-            }
-            }
-        }
-
-      if (current_choice &lt; 0)
-        current_choice = 0;
-      else if (current_choice &gt;= int(dialogs[current_dialog].answers.size()))
-        current_choice = int(dialogs[current_dialog].answers.size()) - 1;
-    }
-  else
-    {
-      std::cout &lt;&lt; &quot;DialogManager: No dialog available&quot; &lt;&lt; std::endl;
-      GameSession::current()-&gt;set_game_state();
-    }
-}
-
-void
-DialogManager::clear()
-{
-  current_dialog = 0;
-  current_choice = 0;
-  dialogs.clear();
-}
-
-/* EOF */

Added: trunk/src/dialog_manager.hpp
===================================================================
--- trunk/src/dialog_manager.hpp	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/dialog_manager.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,77 @@
+//  $Id: dialog_manager.hpp,v 1.2 2003/09/29 19:29:17 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_DIALOG_MANAGER_HXX
+#define HEADER_DIALOG_MANAGER_HXX
+
+#include &lt;vector&gt;
+#include &lt;string&gt;
+#include &lt;ClanLib/Display/sprite.h&gt;
+#include &quot;globals.hpp&quot;
+
+class Dialog {
+public:
+  CL_Sprite portrait;
+  std::string text;
+  /// pair&lt;answer, script&gt;
+  std::vector&lt;std::pair&lt;std::string, std::string&gt; &gt; answers;
+
+  enum Alignment {
+    VCENTER = 0x00,
+    LEFT    = 0x01,
+    RIGHT   = 0x02,
+    HCENTER = 0x00,
+    TOP     = 0x10,
+    BOTTOM  = 0x20
+  };
+  int alignment;
+
+  Dialog(int alignment, const std::string&amp; portrait, const std::string&amp; text);
+};
+
+/** */
+class DialogManager
+{
+private:
+  typedef std::vector&lt;Dialog&gt; Dialogs;
+  Dialogs dialogs;
+  int current_dialog;
+  int current_choice;
+
+  static DialogManager* current_;
+public:
+  static DialogManager* current() { return current_; }
+
+  DialogManager();
+
+  void draw();
+  void update(float delta);
+
+  void add_dialog(int alignment, const std::string&amp; portrait,
+                  const std::string&amp; text);
+  void add_answer(const std::string&amp; text, const std::string&amp; script);
+  void clear();
+private:
+  DialogManager (const DialogManager&amp;);
+  DialogManager&amp; operator= (const DialogManager&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/dialog_manager.hxx
===================================================================
--- trunk/src/dialog_manager.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/dialog_manager.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,71 +0,0 @@
-//  $Id: dialog_manager.hxx,v 1.2 2003/09/29 19:29:17 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_DIALOG_MANAGER_HXX
-#define HEADER_DIALOG_MANAGER_HXX
-
-#include &lt;vector&gt;
-#include &lt;string&gt;
-#include &lt;ClanLib/Display/sprite.h&gt;
-#include &quot;globals.hxx&quot;
-
-struct RubyFunctor
-{
-  // dummy class to make this thing compile
-  void operator()() {}
-};
-
-class Dialog {
-public:
-  CL_Sprite portrait;
-  std::string text;
-  std::vector&lt;std::pair&lt;std::string, RubyFunctor&gt; &gt; answers;
-
-  Dialog(const std::string&amp; portrait, const std::string&amp; text);
-};
-
-/** */
-class DialogManager
-{
-private:
-  typedef std::vector&lt;Dialog&gt; Dialogs;
-  Dialogs dialogs;
-  int current_dialog;
-  int current_choice;
-
-  static DialogManager* current_;
-public:
-  static DialogManager* current() { return current_; }
-
-  DialogManager();
-
-  void draw();
-  void update(float delta);
-
-  void add_dialog(const std::string&amp; portrait, const std::string&amp; text);
-  void add_answer(const std::string&amp; text, const RubyFunctor&amp; func);
-  void clear();
-private:
-  DialogManager (const DialogManager&amp;);
-  DialogManager&amp; operator= (const DialogManager&amp;);
-};
-
-#endif
-
-/* EOF */

Modified: trunk/src/display/Jamfile
===================================================================
--- trunk/src/display/Jamfile	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/display/Jamfile	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,9 +1,9 @@
 SubDir TOP src display ;
 
-sources = drawing_context.hxx
-          drawing_context.cxx
-          scene_context.hxx
-          scene_context.cxx
+sources = drawing_context.hpp
+          drawing_context.cpp
+          scene_context.hpp
+          scene_context.cpp
 ;
 
 TRANSLATABLE_SOURCES = [ SearchSource $(sources) ] ;

Copied: trunk/src/display/drawing_context.cpp (from rev 502, trunk/src/display/drawing_context.cxx)
===================================================================
--- trunk/src/display/drawing_context.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/display/drawing_context.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,311 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;assert.h&gt;
+#include &lt;ClanLib/Display/sprite.h&gt;
+#include &lt;ClanLib/Display/display.h&gt;
+#include &lt;ClanLib/Display/display_window.h&gt;
+#include &lt;ClanLib/Display/graphic_context.h&gt;
+#include &lt;iostream&gt;
+#include &lt;iosfwd&gt;
+#include &quot;drawing_context.hpp&quot;
+
+std::ostream&amp; operator&lt;&lt;(std::ostream&amp; s, const CL_Matrix4x4&amp; m)
+{
+  s &lt;&lt; &quot;[&quot; &lt;&lt; m[ 0] &lt;&lt; &quot;, &quot; &lt;&lt; m[ 4] &lt;&lt; &quot;, &quot; &lt;&lt; m[ 8] &lt;&lt; &quot;, &quot; &lt;&lt; m[12] &lt;&lt; &quot;\n&quot;;
+  s &lt;&lt; &quot; &quot; &lt;&lt; m[ 1] &lt;&lt; &quot;, &quot; &lt;&lt; m[ 5] &lt;&lt; &quot;, &quot; &lt;&lt; m[ 9] &lt;&lt; &quot;, &quot; &lt;&lt; m[13] &lt;&lt; &quot;\n&quot;;
+  s &lt;&lt; &quot; &quot; &lt;&lt; m[ 2] &lt;&lt; &quot;, &quot; &lt;&lt; m[ 6] &lt;&lt; &quot;, &quot; &lt;&lt; m[10] &lt;&lt; &quot;, &quot; &lt;&lt; m[14] &lt;&lt; &quot;\n&quot;;
+  s &lt;&lt; &quot; &quot; &lt;&lt; m[ 3] &lt;&lt; &quot;, &quot; &lt;&lt; m[ 7] &lt;&lt; &quot;, &quot; &lt;&lt; m[11] &lt;&lt; &quot;, &quot; &lt;&lt; m[15] &lt;&lt; &quot;]\n&quot;;
+
+  return s;
+}
+
+struct DrawingRequestsSorter
+{
+  bool operator()(DrawingRequest* a, DrawingRequest* b) {
+    return a-&gt;get_z_pos() &lt; b-&gt;get_z_pos();
+  }
+};
+
+class FillScreenDrawingRequest : public DrawingRequest
+{
+private:
+  CL_Color color;
+public:
+  FillScreenDrawingRequest(const CL_Color&amp; color_) 
+    : DrawingRequest(CL_Vector(0, 0, -1000.0f)), color(color_)
+  {
+  }
+  virtual ~FillScreenDrawingRequest() {}
+
+  void draw(CL_GraphicContext* gc) {
+    gc-&gt;clear(color);
+  }
+};
+
+class SpriteDrawingRequest : public DrawingRequest
+{
+private:
+  CL_Sprite sprite;
+
+public:
+  SpriteDrawingRequest(const CL_Sprite&amp; sprite_, const CL_Vector&amp; pos_, const CL_Matrix4x4&amp; modelview_)
+    : DrawingRequest(pos_, modelview_),
+      sprite(sprite_)
+  {}
+  virtual ~SpriteDrawingRequest() {}
+
+  void draw(CL_GraphicContext* gc) {
+    //sprite.draw(static_cast&lt;int&gt;(pos.x + modelview[12]),
+    //          static_cast&lt;int&gt;(pos.y + modelview[13]), gc);
+
+    gc-&gt;push_modelview();
+    gc-&gt;add_modelview(modelview);
+    sprite.draw(static_cast&lt;int&gt;(pos.x),
+                static_cast&lt;int&gt;(pos.y), gc);
+    gc-&gt;pop_modelview();
+  }
+};
+
+class SurfaceDrawingRequest : public DrawingRequest
+{
+private:
+  CL_Surface sprite;
+
+public:
+  SurfaceDrawingRequest(const CL_Surface&amp; sprite_, const CL_Vector&amp; pos_, const CL_Matrix4x4&amp; modelview_)
+    : DrawingRequest(pos_, modelview_),
+      sprite(sprite_)
+  {}
+  virtual ~SurfaceDrawingRequest() {}
+
+  void draw(CL_GraphicContext* gc) {
+    // FIXME: frequent push/pops might be slow
+    gc-&gt;push_modelview();
+    gc-&gt;add_modelview(modelview);
+    sprite.draw(static_cast&lt;int&gt;(pos.x),
+                static_cast&lt;int&gt;(pos.y), gc);
+    gc-&gt;pop_modelview();
+  }
+};
+
+class TextDrawingRequest : public DrawingRequest
+{
+private:
+  std::string text;
+public:
+  TextDrawingRequest(const std::string&amp; text_, const CL_Vector&amp; pos_)
+    : DrawingRequest(pos_),
+      text(text_)
+  {}
+  virtual ~TextDrawingRequest() {}
+
+  void draw(CL_GraphicContext* gc) {
+    (void) gc;
+    // FIXME: not implemented
+  }
+};
+
+DrawingContext::DrawingContext()
+{
+  modelview_stack.push_back(CL_Matrix4x4(true));
+}
+
+DrawingContext::~DrawingContext()
+{
+  clear();
+}
+
+void
+DrawingContext::render(CL_GraphicContext* gc)
+{
+  if (gc == 0)
+    {
+      gc = CL_Display::get_current_window()-&gt;get_gc();
+    }
+
+  std::stable_sort(drawingrequests.begin(), drawingrequests.end(), DrawingRequestsSorter());
+  
+  for(DrawingRequests::iterator i = drawingrequests.begin(); i != drawingrequests.end(); ++i)
+    {
+      (*i)-&gt;draw(gc);
+    }
+}
+
+void
+DrawingContext::clear()
+{
+  for(DrawingRequests::iterator i = drawingrequests.begin(); i != drawingrequests.end(); ++i)
+    {
+      delete *i;
+    }
+  drawingrequests.clear();
+}
+
+void
+DrawingContext::draw(DrawingRequest* request)
+{
+  drawingrequests.push_back(request);
+}
+
+void
+DrawingContext::draw(const CL_Surface&amp;   sprite,  float x, float y, float z)
+{ // FIXME: This should get flattend down to a simple texture draw
+  // command for easier sorting after texture-id/alpha
+  draw(new SurfaceDrawingRequest(sprite, CL_Vector(x, y, z), modelview_stack.back()));
+}
+
+void
+DrawingContext::draw(const CL_Sprite&amp;   sprite,  float x, float y, float z)
+{ // FIXME: This should get flattend down to a simple texture draw
+  // command for easier sorting after texture-id/alpha
+  draw(new SpriteDrawingRequest(sprite, CL_Vector(x, y, z), modelview_stack.back()));
+}
+
+void
+DrawingContext::draw(const std::string&amp; text,    float x, float y, float z)
+{ 
+  draw(new TextDrawingRequest(text, CL_Vector(x, y, z)));
+}
+
+void
+DrawingContext::draw_line (float , float , float , float , 
+                           const CL_Color&amp; )
+{
+}
+
+void
+DrawingContext::draw_fillrect (float , float , float , float , 
+		      const CL_Color&amp; )
+{
+}
+
+void
+DrawingContext::draw_rect (float , float , float , float , 
+		  const CL_Color&amp; )
+{
+}
+
+void
+DrawingContext::draw_pixel (float , float , const CL_Color&amp; )
+{
+}
+
+void
+DrawingContext::draw_circle (float , float , float , const CL_Color&amp; )
+{
+}
+
+/** Draws an arc, starting from angle_start to angle_end in
+      counterclockwise direction. Angles are taken in radian */
+void
+DrawingContext::draw_arc (float , float , float , float , float ,
+                          const CL_Color&amp; )
+{
+}
+
+void
+DrawingContext::fill_screen(const CL_Color&amp; color)
+{
+  draw(new FillScreenDrawingRequest(color));
+}
+
+void
+DrawingContext::rotate(float angle, float x, float y, float z)
+{
+  double len2 = x*x+y*y+z*z;
+  if (len2 != 1.0)
+    {
+      double len = sqrt(len2);
+      x /= len;
+      y /= len;
+      z /= len;
+    }
+
+  double c = cos(angle*3.14159265/180);
+  double s = sin(angle*3.14159265/180);
+
+  CL_Matrix4x4 matrix(true);
+  matrix[0] = x*x*(1-c)+c;
+  matrix[1] = y*x*(1-c)+z*s;
+  matrix[2] = x*z*(1-c)-y*s;
+
+  matrix[4] = x*y*(1-c)-z*s;
+  matrix[5] = y*y*(1-c)+c;
+  matrix[6] = y*z*(1-c)+x*s;
+
+  matrix[8] = x*z*(1-c)+y*s;
+  matrix[9] = y*z*(1-c)-x*s;
+  matrix[10] = z*z*(1-c)+c;
+
+  modelview_stack.back() = modelview_stack.back().multiply(matrix);
+}
+
+void
+DrawingContext::scale(float x, float y, float z)
+{
+  CL_Matrix4x4 matrix(true);
+  matrix[0] = x;
+  matrix[5] = y;
+  matrix[10] = z;
+
+  modelview_stack.back() = modelview_stack.back().multiply(matrix);
+}
+
+void
+DrawingContext::translate(float x, float y, float z)
+{
+  CL_Matrix4x4 matrix(true);
+  matrix[12] = x;
+  matrix[13] = y;
+  matrix[14] = z;
+
+  modelview_stack.back() = modelview_stack.back().multiply(matrix);
+}
+
+void
+DrawingContext::push_modelview()
+{
+  modelview_stack.push_back(modelview_stack.back());
+}
+
+void
+DrawingContext::pop_modelview()
+{
+  modelview_stack.pop_back();
+  assert(!modelview_stack.empty());
+}
+
+void
+DrawingContext::reset_modelview()
+{
+  modelview_stack.clear();
+  modelview_stack.push_back(CL_Matrix4x4(true));
+}
+
+CL_Rect
+DrawingContext::get_clip_rect()
+{
+  // FIXME: Need to check the modelview matrix
+  return CL_Rect(CL_Point(int(modelview_stack.back()[12]),
+                          int(modelview_stack.back()[13])),
+                 CL_Size(800, 600));
+}
+
+/* EOF */

Deleted: trunk/src/display/drawing_context.cxx
===================================================================
--- trunk/src/display/drawing_context.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/display/drawing_context.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,311 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;assert.h&gt;
-#include &lt;ClanLib/Display/sprite.h&gt;
-#include &lt;ClanLib/Display/display.h&gt;
-#include &lt;ClanLib/Display/display_window.h&gt;
-#include &lt;ClanLib/Display/graphic_context.h&gt;
-#include &lt;iostream&gt;
-#include &lt;iosfwd&gt;
-#include &quot;drawing_context.hxx&quot;
-
-std::ostream&amp; operator&lt;&lt;(std::ostream&amp; s, const CL_Matrix4x4&amp; m)
-{
-  s &lt;&lt; &quot;[&quot; &lt;&lt; m[ 0] &lt;&lt; &quot;, &quot; &lt;&lt; m[ 4] &lt;&lt; &quot;, &quot; &lt;&lt; m[ 8] &lt;&lt; &quot;, &quot; &lt;&lt; m[12] &lt;&lt; &quot;\n&quot;;
-  s &lt;&lt; &quot; &quot; &lt;&lt; m[ 1] &lt;&lt; &quot;, &quot; &lt;&lt; m[ 5] &lt;&lt; &quot;, &quot; &lt;&lt; m[ 9] &lt;&lt; &quot;, &quot; &lt;&lt; m[13] &lt;&lt; &quot;\n&quot;;
-  s &lt;&lt; &quot; &quot; &lt;&lt; m[ 2] &lt;&lt; &quot;, &quot; &lt;&lt; m[ 6] &lt;&lt; &quot;, &quot; &lt;&lt; m[10] &lt;&lt; &quot;, &quot; &lt;&lt; m[14] &lt;&lt; &quot;\n&quot;;
-  s &lt;&lt; &quot; &quot; &lt;&lt; m[ 3] &lt;&lt; &quot;, &quot; &lt;&lt; m[ 7] &lt;&lt; &quot;, &quot; &lt;&lt; m[11] &lt;&lt; &quot;, &quot; &lt;&lt; m[15] &lt;&lt; &quot;]\n&quot;;
-
-  return s;
-}
-
-struct DrawingRequestsSorter
-{
-  bool operator()(DrawingRequest* a, DrawingRequest* b) {
-    return a-&gt;get_z_pos() &lt; b-&gt;get_z_pos();
-  }
-};
-
-class FillScreenDrawingRequest : public DrawingRequest
-{
-private:
-  CL_Color color;
-public:
-  FillScreenDrawingRequest(const CL_Color&amp; color_) 
-    : DrawingRequest(CL_Vector(0, 0, -1000.0f)), color(color_)
-  {
-  }
-  virtual ~FillScreenDrawingRequest() {}
-
-  void draw(CL_GraphicContext* gc) {
-    gc-&gt;clear(color);
-  }
-};
-
-class SpriteDrawingRequest : public DrawingRequest
-{
-private:
-  CL_Sprite sprite;
-
-public:
-  SpriteDrawingRequest(const CL_Sprite&amp; sprite_, const CL_Vector&amp; pos_, const CL_Matrix4x4&amp; modelview_)
-    : DrawingRequest(pos_, modelview_),
-      sprite(sprite_)
-  {}
-  virtual ~SpriteDrawingRequest() {}
-
-  void draw(CL_GraphicContext* gc) {
-    //sprite.draw(static_cast&lt;int&gt;(pos.x + modelview[12]),
-    //          static_cast&lt;int&gt;(pos.y + modelview[13]), gc);
-
-    gc-&gt;push_modelview();
-    gc-&gt;add_modelview(modelview);
-    sprite.draw(static_cast&lt;int&gt;(pos.x),
-                static_cast&lt;int&gt;(pos.y), gc);
-    gc-&gt;pop_modelview();
-  }
-};
-
-class SurfaceDrawingRequest : public DrawingRequest
-{
-private:
-  CL_Surface sprite;
-
-public:
-  SurfaceDrawingRequest(const CL_Surface&amp; sprite_, const CL_Vector&amp; pos_, const CL_Matrix4x4&amp; modelview_)
-    : DrawingRequest(pos_, modelview_),
-      sprite(sprite_)
-  {}
-  virtual ~SurfaceDrawingRequest() {}
-
-  void draw(CL_GraphicContext* gc) {
-    // FIXME: frequent push/pops might be slow
-    gc-&gt;push_modelview();
-    gc-&gt;add_modelview(modelview);
-    sprite.draw(static_cast&lt;int&gt;(pos.x),
-                static_cast&lt;int&gt;(pos.y), gc);
-    gc-&gt;pop_modelview();
-  }
-};
-
-class TextDrawingRequest : public DrawingRequest
-{
-private:
-  std::string text;
-public:
-  TextDrawingRequest(const std::string&amp; text_, const CL_Vector&amp; pos_)
-    : DrawingRequest(pos_),
-      text(text_)
-  {}
-  virtual ~TextDrawingRequest() {}
-
-  void draw(CL_GraphicContext* gc) {
-    (void) gc;
-    // FIXME: not implemented
-  }
-};
-
-DrawingContext::DrawingContext()
-{
-  modelview_stack.push_back(CL_Matrix4x4(true));
-}
-
-DrawingContext::~DrawingContext()
-{
-  clear();
-}
-
-void
-DrawingContext::render(CL_GraphicContext* gc)
-{
-  if (gc == 0)
-    {
-      gc = CL_Display::get_current_window()-&gt;get_gc();
-    }
-
-  std::stable_sort(drawingrequests.begin(), drawingrequests.end(), DrawingRequestsSorter());
-  
-  for(DrawingRequests::iterator i = drawingrequests.begin(); i != drawingrequests.end(); ++i)
-    {
-      (*i)-&gt;draw(gc);
-    }
-}
-
-void
-DrawingContext::clear()
-{
-  for(DrawingRequests::iterator i = drawingrequests.begin(); i != drawingrequests.end(); ++i)
-    {
-      delete *i;
-    }
-  drawingrequests.clear();
-}
-
-void
-DrawingContext::draw(DrawingRequest* request)
-{
-  drawingrequests.push_back(request);
-}
-
-void
-DrawingContext::draw(const CL_Surface&amp;   sprite,  float x, float y, float z)
-{ // FIXME: This should get flattend down to a simple texture draw
-  // command for easier sorting after texture-id/alpha
-  draw(new SurfaceDrawingRequest(sprite, CL_Vector(x, y, z), modelview_stack.back()));
-}
-
-void
-DrawingContext::draw(const CL_Sprite&amp;   sprite,  float x, float y, float z)
-{ // FIXME: This should get flattend down to a simple texture draw
-  // command for easier sorting after texture-id/alpha
-  draw(new SpriteDrawingRequest(sprite, CL_Vector(x, y, z), modelview_stack.back()));
-}
-
-void
-DrawingContext::draw(const std::string&amp; text,    float x, float y, float z)
-{ 
-  draw(new TextDrawingRequest(text, CL_Vector(x, y, z)));
-}
-
-void
-DrawingContext::draw_line (float , float , float , float , 
-                           const CL_Color&amp; )
-{
-}
-
-void
-DrawingContext::draw_fillrect (float , float , float , float , 
-		      const CL_Color&amp; )
-{
-}
-
-void
-DrawingContext::draw_rect (float , float , float , float , 
-		  const CL_Color&amp; )
-{
-}
-
-void
-DrawingContext::draw_pixel (float , float , const CL_Color&amp; )
-{
-}
-
-void
-DrawingContext::draw_circle (float , float , float , const CL_Color&amp; )
-{
-}
-
-/** Draws an arc, starting from angle_start to angle_end in
-      counterclockwise direction. Angles are taken in radian */
-void
-DrawingContext::draw_arc (float , float , float , float , float ,
-                          const CL_Color&amp; )
-{
-}
-
-void
-DrawingContext::fill_screen(const CL_Color&amp; color)
-{
-  draw(new FillScreenDrawingRequest(color));
-}
-
-void
-DrawingContext::rotate(float angle, float x, float y, float z)
-{
-  double len2 = x*x+y*y+z*z;
-  if (len2 != 1.0)
-    {
-      double len = sqrt(len2);
-      x /= len;
-      y /= len;
-      z /= len;
-    }
-
-  double c = cos(angle*3.14159265/180);
-  double s = sin(angle*3.14159265/180);
-
-  CL_Matrix4x4 matrix(true);
-  matrix[0] = x*x*(1-c)+c;
-  matrix[1] = y*x*(1-c)+z*s;
-  matrix[2] = x*z*(1-c)-y*s;
-
-  matrix[4] = x*y*(1-c)-z*s;
-  matrix[5] = y*y*(1-c)+c;
-  matrix[6] = y*z*(1-c)+x*s;
-
-  matrix[8] = x*z*(1-c)+y*s;
-  matrix[9] = y*z*(1-c)-x*s;
-  matrix[10] = z*z*(1-c)+c;
-
-  modelview_stack.back() = modelview_stack.back().multiply(matrix);
-}
-
-void
-DrawingContext::scale(float x, float y, float z)
-{
-  CL_Matrix4x4 matrix(true);
-  matrix[0] = x;
-  matrix[5] = y;
-  matrix[10] = z;
-
-  modelview_stack.back() = modelview_stack.back().multiply(matrix);
-}
-
-void
-DrawingContext::translate(float x, float y, float z)
-{
-  CL_Matrix4x4 matrix(true);
-  matrix[12] = x;
-  matrix[13] = y;
-  matrix[14] = z;
-
-  modelview_stack.back() = modelview_stack.back().multiply(matrix);
-}
-
-void
-DrawingContext::push_modelview()
-{
-  modelview_stack.push_back(modelview_stack.back());
-}
-
-void
-DrawingContext::pop_modelview()
-{
-  modelview_stack.pop_back();
-  assert(!modelview_stack.empty());
-}
-
-void
-DrawingContext::reset_modelview()
-{
-  modelview_stack.clear();
-  modelview_stack.push_back(CL_Matrix4x4(true));
-}
-
-CL_Rect
-DrawingContext::get_clip_rect()
-{
-  // FIXME: Need to check the modelview matrix
-  return CL_Rect(CL_Point(int(modelview_stack.back()[12]),
-                          int(modelview_stack.back()[13])),
-                 CL_Size(800, 600));
-}
-
-/* EOF */

Copied: trunk/src/display/drawing_context.hpp (from rev 502, trunk/src/display/drawing_context.hxx)
===================================================================
--- trunk/src/display/drawing_context.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/display/drawing_context.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,107 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_DRAWING_CONTEXT_HXX
+#define HEADER_DRAWING_CONTEXT_HXX
+
+#include &lt;ClanLib/Core/Math/rect.h&gt;
+#include &lt;ClanLib/Core/Math/matrix4x4.h&gt;
+#include &lt;ClanLib/Display/color.h&gt;
+#include &lt;vector&gt;
+#include &quot;drawing_request.hpp&quot;
+
+class CL_Surface;
+class CL_Sprite;
+
+/** The DrawingContext collects all DrawingRequests and allows you to
+    flush them all down to the graphics card in one run, this has the
+    advantage that it is possible to z-sort, texture-id sort or
+    otherwise optimize the drawing. In addition to that it also allows
+    you do render the drawing commands to multiple buffers which might
+    be usefull for post-processing effects and such. */
+class DrawingContext
+{
+private:
+  typedef std::vector&lt;DrawingRequest*&gt; DrawingRequests;
+  DrawingRequests drawingrequests;
+
+  std::vector&lt;CL_Matrix4x4&gt; modelview_stack;
+
+public:
+  DrawingContext();
+  ~DrawingContext();
+
+  /** Draws everything in the drawing context to the screen */
+  void render(CL_GraphicContext* gc = 0);
+
+  /** Empties the drawing context */
+  void clear();
+
+  /** Fills the screen with a given color, this is different from
+      clear() in that it doesn't remove other DrawingRequest from the
+      queue */
+  void fill_screen(const CL_Color&amp; color);
+
+  /*{ */
+  void draw(DrawingRequest* request);
+  void draw(const CL_Sprite&amp;   sprite,  float x, float y, float z = 0);
+  void draw(const CL_Surface&amp;   sprite,  float x, float y, float z = 0);
+  void draw(const std::string&amp; text,    float x, float y, float z = 0);
+
+  void draw_line (float x1, float y1, float x2, float y2, 
+		  const CL_Color&amp; color);
+  void draw_fillrect (float x1, float y1, float x2, float y2, 
+		      const CL_Color&amp; color);
+  void draw_rect (float x1, float y1, float x2, float y2, 
+		  const CL_Color&amp; color);
+  void draw_pixel (float x_pos, float y_pos, 
+		   const CL_Color&amp; color);
+  void draw_circle (float x_pos, float y_pos, float radius,
+                    const CL_Color&amp; color);
+
+  /** Draws an arc, starting from angle_start to angle_end in
+      counterclockwise direction. Angles are taken in radian */
+  void draw_arc (float x_pos, float y_pos, float radius, float angle_start, float angle_end,
+                 const CL_Color&amp; color);
+  /*} */
+  
+  /** Translate the drawing context */
+  void translate(float x, float y, float z = 0.0f);
+
+  /** Set the rotation of the drawing context */
+  void rotate(float angle, float x = 0.0f, float y = 0.0f, float z = 1.0f);
+
+  /** Set the scaling of the drawing context */
+  void scale(float x, float y, float z = 1.0f);
+
+  void push_modelview();
+  void pop_modelview();
+  void reset_modelview();
+  CL_Matrix4x4 get_modelview() const { return modelview_stack.back(); }
+
+  /** Return the area of the screen that will be visible*/
+  CL_Rect get_clip_rect();
+private:
+  DrawingContext (const DrawingContext&amp;);
+  DrawingContext&amp; operator= (const DrawingContext&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/display/drawing_context.hxx
===================================================================
--- trunk/src/display/drawing_context.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/display/drawing_context.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,107 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_DRAWING_CONTEXT_HXX
-#define HEADER_DRAWING_CONTEXT_HXX
-
-#include &lt;ClanLib/Core/Math/rect.h&gt;
-#include &lt;ClanLib/Core/Math/matrix4x4.h&gt;
-#include &lt;ClanLib/Display/color.h&gt;
-#include &lt;vector&gt;
-#include &quot;drawing_request.hxx&quot;
-
-class CL_Surface;
-class CL_Sprite;
-
-/** The DrawingContext collects all DrawingRequests and allows you to
-    flush them all down to the graphics card in one run, this has the
-    advantage that it is possible to z-sort, texture-id sort or
-    otherwise optimize the drawing. In addition to that it also allows
-    you do render the drawing commands to multiple buffers which might
-    be usefull for post-processing effects and such. */
-class DrawingContext
-{
-private:
-  typedef std::vector&lt;DrawingRequest*&gt; DrawingRequests;
-  DrawingRequests drawingrequests;
-
-  std::vector&lt;CL_Matrix4x4&gt; modelview_stack;
-
-public:
-  DrawingContext();
-  ~DrawingContext();
-
-  /** Draws everything in the drawing context to the screen */
-  void render(CL_GraphicContext* gc = 0);
-
-  /** Empties the drawing context */
-  void clear();
-
-  /** Fills the screen with a given color, this is different from
-      clear() in that it doesn't remove other DrawingRequest from the
-      queue */
-  void fill_screen(const CL_Color&amp; color);
-
-  /*{ */
-  void draw(DrawingRequest* request);
-  void draw(const CL_Sprite&amp;   sprite,  float x, float y, float z = 0);
-  void draw(const CL_Surface&amp;   sprite,  float x, float y, float z = 0);
-  void draw(const std::string&amp; text,    float x, float y, float z = 0);
-
-  void draw_line (float x1, float y1, float x2, float y2, 
-		  const CL_Color&amp; color);
-  void draw_fillrect (float x1, float y1, float x2, float y2, 
-		      const CL_Color&amp; color);
-  void draw_rect (float x1, float y1, float x2, float y2, 
-		  const CL_Color&amp; color);
-  void draw_pixel (float x_pos, float y_pos, 
-		   const CL_Color&amp; color);
-  void draw_circle (float x_pos, float y_pos, float radius,
-                    const CL_Color&amp; color);
-
-  /** Draws an arc, starting from angle_start to angle_end in
-      counterclockwise direction. Angles are taken in radian */
-  void draw_arc (float x_pos, float y_pos, float radius, float angle_start, float angle_end,
-                 const CL_Color&amp; color);
-  /*} */
-  
-  /** Translate the drawing context */
-  void translate(float x, float y, float z = 0.0f);
-
-  /** Set the rotation of the drawing context */
-  void rotate(float angle, float x = 0.0f, float y = 0.0f, float z = 1.0f);
-
-  /** Set the scaling of the drawing context */
-  void scale(float x, float y, float z = 1.0f);
-
-  void push_modelview();
-  void pop_modelview();
-  void reset_modelview();
-  CL_Matrix4x4 get_modelview() const { return modelview_stack.back(); }
-
-  /** Return the area of the screen that will be visible*/
-  CL_Rect get_clip_rect();
-private:
-  DrawingContext (const DrawingContext&amp;);
-  DrawingContext&amp; operator= (const DrawingContext&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/display/drawing_request.hpp (from rev 502, trunk/src/display/drawing_request.hxx)

Deleted: trunk/src/display/drawing_request.hxx
===================================================================
--- trunk/src/display/drawing_request.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/display/drawing_request.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,58 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_DRAWING_REQUEST_HXX
-#define HEADER_DRAWING_REQUEST_HXX
-
-#include &lt;ClanLib/Core/Math/cl_vector.h&gt;
-
-class CL_GraphicContext;
-
-/** 
- */
-class DrawingRequest
-{
-protected:
-  CL_Vector pos;
-  CL_Matrix4x4 modelview;
-public:
-  DrawingRequest(const CL_Vector&amp; pos_, const CL_Matrix4x4&amp; modelview_ = CL_Matrix4x4(true))
-    : pos(pos_), modelview(modelview_) {}
-  virtual ~DrawingRequest() {}
-  
-  virtual void draw(CL_GraphicContext* gc) = 0;
-  
-  /** Returns true if the request contains an alpha channel and needs
-      to be drawn in order */
-  virtual bool has_alpha() { return true; }
-
-  /** Returns the position at which the request should be drawn */
-  float get_z_pos() const
-  { return pos.z; }
-
-  CL_Matrix4x4 get_modelview() const
-  { return modelview; }
-private:
-  DrawingRequest (const DrawingRequest&amp;);
-  DrawingRequest&amp; operator= (const DrawingRequest&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/display/scene_context.cpp (from rev 502, trunk/src/display/scene_context.cxx)
===================================================================
--- trunk/src/display/scene_context.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/display/scene_context.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,181 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ClanLib/display.h&gt;
+#include &lt;ClanLib/gl.h&gt;
+#include &quot;scene_context.hpp&quot;
+
+// The lightmap has a resolution of screen.w/LIGHTMAP, screen.h/LIGHTMAP
+#define LIGHTMAP_DIV 4
+
+class SceneContextImpl
+{
+public:
+  DrawingContext color;
+  DrawingContext light;
+  DrawingContext highlight; 
+  unsigned int render_mask;
+
+  CL_OpenGLSurface lightmap;
+
+  SceneContextImpl() 
+    : render_mask(SceneContext::COLORMAP | SceneContext::LIGHTMAP | SceneContext::HIGHLIGHTMAP ),
+      lightmap(CL_PixelBuffer(800/LIGHTMAP_DIV, 
+                              600/LIGHTMAP_DIV,
+                              800/LIGHTMAP_DIV*4, CL_PixelFormat::rgba8888))
+  {
+  }
+};
+
+SceneContext::SceneContext()
+{
+  impl = new SceneContextImpl();
+}
+
+SceneContext::~SceneContext()
+{
+  delete impl;
+}
+
+DrawingContext&amp;
+SceneContext::color()
+{
+  return impl-&gt;color; 
+}
+
+DrawingContext&amp;
+SceneContext::light()
+{ 
+  return impl-&gt;light; 
+}
+
+DrawingContext&amp;
+SceneContext::highlight()
+{ 
+  return impl-&gt;highlight; 
+}
+
+
+/** Translate the drawing context */
+void
+SceneContext::translate(float x, float y)
+{
+  impl-&gt;color.translate(x, y);
+  impl-&gt;light.translate(x, y);
+  impl-&gt;highlight.translate(x, y);
+}
+
+/** Set the rotation of the drawing context */
+void
+SceneContext::rotate(float angel)
+{
+  impl-&gt;color.rotate(angel);
+  impl-&gt;light.rotate(angel);
+  impl-&gt;highlight.rotate(angel);
+}
+
+/** Set the scaling of the drawing context */
+void
+SceneContext::scale(float x, float y)
+{
+  impl-&gt;color.scale(x, y);
+  impl-&gt;light.scale(x, y);
+  impl-&gt;highlight.scale(x, y);
+}
+
+void
+SceneContext::push_modelview()
+{
+  impl-&gt;color.push_modelview();
+  impl-&gt;light.push_modelview();
+  impl-&gt;highlight.push_modelview();
+}
+
+void
+SceneContext::pop_modelview()
+{
+  impl-&gt;color.pop_modelview();
+  impl-&gt;light.pop_modelview();
+  impl-&gt;highlight.pop_modelview();
+}
+
+void
+SceneContext::reset_modelview()
+{
+  impl-&gt;color.reset_modelview();
+  impl-&gt;light.reset_modelview();
+  impl-&gt;highlight.reset_modelview();
+}
+
+void
+SceneContext::render()
+{
+  if (impl-&gt;render_mask &amp; LIGHTMAP)
+    {
+      CL_Display::clear();
+      
+      CL_Display::push_modelview();
+      CL_Display::add_scale(1.0f/LIGHTMAP_DIV, 1.0f/LIGHTMAP_DIV, 1.0f);
+      impl-&gt;light.render();
+      CL_Display::pop_modelview();
+      
+      // Weird y-pos is needed since OpenGL is upside down when it comes to y-coordinate
+      impl-&gt;lightmap.bind();
+      glCopyTexSubImage2D(GL_TEXTURE_2D, 0,
+                          0, 0, 
+                          0, 600 - impl-&gt;lightmap.get_height(),
+                          impl-&gt;lightmap.get_width(), impl-&gt;lightmap.get_height());
+    }
+
+  if (impl-&gt;render_mask &amp; COLORMAP)
+    {
+      impl-&gt;color.render();
+    }
+
+  if (impl-&gt;render_mask &amp; LIGHTMAP)
+    {
+      impl-&gt;lightmap.set_blend_func(blend_dest_color, blend_zero);
+      impl-&gt;lightmap.set_scale(LIGHTMAP_DIV, -LIGHTMAP_DIV);
+      impl-&gt;lightmap.draw(0, 600);
+    }
+
+  if (impl-&gt;render_mask &amp; HIGHLIGHTMAP)
+    {
+      impl-&gt;highlight.render();
+    }
+
+  // Clear all DrawingContexts
+  impl-&gt;color.clear();
+  impl-&gt;light.clear();
+  impl-&gt;highlight.clear();
+}
+
+void
+SceneContext::set_render_mask(unsigned int mask)
+{
+  impl-&gt;render_mask = mask;
+}
+
+unsigned int
+SceneContext::get_render_mask()
+{
+  return impl-&gt;render_mask;
+}
+
+/* EOF */

Deleted: trunk/src/display/scene_context.cxx
===================================================================
--- trunk/src/display/scene_context.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/display/scene_context.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,181 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ClanLib/display.h&gt;
-#include &lt;ClanLib/gl.h&gt;
-#include &quot;scene_context.hxx&quot;
-
-// The lightmap has a resolution of screen.w/LIGHTMAP, screen.h/LIGHTMAP
-#define LIGHTMAP_DIV 4
-
-class SceneContextImpl
-{
-public:
-  DrawingContext color;
-  DrawingContext light;
-  DrawingContext highlight; 
-  unsigned int render_mask;
-
-  CL_OpenGLSurface lightmap;
-
-  SceneContextImpl() 
-    : render_mask(SceneContext::COLORMAP | SceneContext::LIGHTMAP | SceneContext::HIGHLIGHTMAP ),
-      lightmap(CL_PixelBuffer(800/LIGHTMAP_DIV, 
-                              600/LIGHTMAP_DIV,
-                              800/LIGHTMAP_DIV*4, CL_PixelFormat::rgba8888))
-  {
-  }
-};
-
-SceneContext::SceneContext()
-{
-  impl = new SceneContextImpl();
-}
-
-SceneContext::~SceneContext()
-{
-  delete impl;
-}
-
-DrawingContext&amp;
-SceneContext::color()
-{
-  return impl-&gt;color; 
-}
-
-DrawingContext&amp;
-SceneContext::light()
-{ 
-  return impl-&gt;light; 
-}
-
-DrawingContext&amp;
-SceneContext::highlight()
-{ 
-  return impl-&gt;highlight; 
-}
-
-
-/** Translate the drawing context */
-void
-SceneContext::translate(float x, float y)
-{
-  impl-&gt;color.translate(x, y);
-  impl-&gt;light.translate(x, y);
-  impl-&gt;highlight.translate(x, y);
-}
-
-/** Set the rotation of the drawing context */
-void
-SceneContext::rotate(float angel)
-{
-  impl-&gt;color.rotate(angel);
-  impl-&gt;light.rotate(angel);
-  impl-&gt;highlight.rotate(angel);
-}
-
-/** Set the scaling of the drawing context */
-void
-SceneContext::scale(float x, float y)
-{
-  impl-&gt;color.scale(x, y);
-  impl-&gt;light.scale(x, y);
-  impl-&gt;highlight.scale(x, y);
-}
-
-void
-SceneContext::push_modelview()
-{
-  impl-&gt;color.push_modelview();
-  impl-&gt;light.push_modelview();
-  impl-&gt;highlight.push_modelview();
-}
-
-void
-SceneContext::pop_modelview()
-{
-  impl-&gt;color.pop_modelview();
-  impl-&gt;light.pop_modelview();
-  impl-&gt;highlight.pop_modelview();
-}
-
-void
-SceneContext::reset_modelview()
-{
-  impl-&gt;color.reset_modelview();
-  impl-&gt;light.reset_modelview();
-  impl-&gt;highlight.reset_modelview();
-}
-
-void
-SceneContext::render()
-{
-  if (impl-&gt;render_mask &amp; LIGHTMAP)
-    {
-      CL_Display::clear();
-      
-      CL_Display::push_modelview();
-      CL_Display::add_scale(1.0f/LIGHTMAP_DIV, 1.0f/LIGHTMAP_DIV, 1.0f);
-      impl-&gt;light.render();
-      CL_Display::pop_modelview();
-      
-      // Weird y-pos is needed since OpenGL is upside down when it comes to y-coordinate
-      impl-&gt;lightmap.bind();
-      glCopyTexSubImage2D(GL_TEXTURE_2D, 0,
-                          0, 0, 
-                          0, 600 - impl-&gt;lightmap.get_height(),
-                          impl-&gt;lightmap.get_width(), impl-&gt;lightmap.get_height());
-    }
-
-  if (impl-&gt;render_mask &amp; COLORMAP)
-    {
-      impl-&gt;color.render();
-    }
-
-  if (impl-&gt;render_mask &amp; LIGHTMAP)
-    {
-      impl-&gt;lightmap.set_blend_func(blend_dest_color, blend_zero);
-      impl-&gt;lightmap.set_scale(LIGHTMAP_DIV, -LIGHTMAP_DIV);
-      impl-&gt;lightmap.draw(0, 600);
-    }
-
-  if (impl-&gt;render_mask &amp; HIGHLIGHTMAP)
-    {
-      impl-&gt;highlight.render();
-    }
-
-  // Clear all DrawingContexts
-  impl-&gt;color.clear();
-  impl-&gt;light.clear();
-  impl-&gt;highlight.clear();
-}
-
-void
-SceneContext::set_render_mask(unsigned int mask)
-{
-  impl-&gt;render_mask = mask;
-}
-
-unsigned int
-SceneContext::get_render_mask()
-{
-  return impl-&gt;render_mask;
-}
-
-/* EOF */

Copied: trunk/src/display/scene_context.hpp (from rev 502, trunk/src/display/scene_context.hxx)
===================================================================
--- trunk/src/display/scene_context.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/display/scene_context.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,90 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_SCENE_CONTEXT_HXX
+#define HEADER_SCENE_CONTEXT_HXX
+
+#include &quot;drawing_context.hpp&quot;
+
+class SceneContextImpl;
+
+/** The SceneContext maintains all the different drawing layers to
+    which a game object can draw. Each drawing layer serves a
+    different purporse and all are combined in the end to form the
+    final image. */
+class SceneContext
+{
+public:
+  SceneContext();
+  ~SceneContext();
+  
+  /** The main drawing context, also known as color buffer, to this
+      you draw all normal graphics, sprites and enemies, as you would
+      do with a normal framebuffer */
+  DrawingContext&amp; color();
+
+  /** This is the lightmap, to this you draw all lights, meaning that
+      a color of white will result in a area that is completly
+      visible, while a value of black will mean that the area will be
+      not lighted at all and be completly black. This lightmap is
+      multiplied with the color buffer to get the light effect */
+  DrawingContext&amp; light();
+
+  /** The highlight map is usefull for all objects that are extremly
+      bright so that they generate a lenseflare or a glow. The
+      highlight map doesn't light the scenario itself, but gets
+      additionally rendered above the color and light buffer, thus its
+      allows to add glow without risking to losing it in an area of
+      darkness */
+  DrawingContext&amp; highlight();
+
+  /** Translate the drawing context */
+  void translate(float x, float y);
+
+  /** Set the rotation of the drawing context */
+  void rotate(float angel);
+
+  /** Set the scaling of the drawing context */
+  void scale(float x, float y);
+
+  void push_modelview();
+  void pop_modelview();
+  void reset_modelview();
+
+  /** Takes all the buffers and combines them to form the final image
+      that will be shown on the screen */
+  void render();
+
+  enum { COLORMAP     = 1&lt;&lt;0,
+         LIGHTMAP     = 1&lt;&lt;1,
+         HIGHLIGHTMAP = 1&lt;&lt;2
+  };
+
+  void set_render_mask(unsigned int mask);
+  unsigned int get_render_mask();
+private:
+  SceneContextImpl* impl;
+
+  SceneContext (const SceneContext&amp;);
+  SceneContext&amp; operator= (const SceneContext&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/display/scene_context.hxx
===================================================================
--- trunk/src/display/scene_context.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/display/scene_context.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,90 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_SCENE_CONTEXT_HXX
-#define HEADER_SCENE_CONTEXT_HXX
-
-#include &quot;drawing_context.hxx&quot;
-
-class SceneContextImpl;
-
-/** The SceneContext maintains all the different drawing layers to
-    which a game object can draw. Each drawing layer serves a
-    different purporse and all are combined in the end to form the
-    final image. */
-class SceneContext
-{
-public:
-  SceneContext();
-  ~SceneContext();
-  
-  /** The main drawing context, also known as color buffer, to this
-      you draw all normal graphics, sprites and enemies, as you would
-      do with a normal framebuffer */
-  DrawingContext&amp; color();
-
-  /** This is the lightmap, to this you draw all lights, meaning that
-      a color of white will result in a area that is completly
-      visible, while a value of black will mean that the area will be
-      not lighted at all and be completly black. This lightmap is
-      multiplied with the color buffer to get the light effect */
-  DrawingContext&amp; light();
-
-  /** The highlight map is usefull for all objects that are extremly
-      bright so that they generate a lenseflare or a glow. The
-      highlight map doesn't light the scenario itself, but gets
-      additionally rendered above the color and light buffer, thus its
-      allows to add glow without risking to losing it in an area of
-      darkness */
-  DrawingContext&amp; highlight();
-
-  /** Translate the drawing context */
-  void translate(float x, float y);
-
-  /** Set the rotation of the drawing context */
-  void rotate(float angel);
-
-  /** Set the scaling of the drawing context */
-  void scale(float x, float y);
-
-  void push_modelview();
-  void pop_modelview();
-  void reset_modelview();
-
-  /** Takes all the buffers and combines them to form the final image
-      that will be shown on the screen */
-  void render();
-
-  enum { COLORMAP     = 1&lt;&lt;0,
-         LIGHTMAP     = 1&lt;&lt;1,
-         HIGHLIGHTMAP = 1&lt;&lt;2
-  };
-
-  void set_render_mask(unsigned int mask);
-  unsigned int get_render_mask();
-private:
-  SceneContextImpl* impl;
-
-  SceneContext (const SceneContext&amp;);
-  SceneContext&amp; operator= (const SceneContext&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/display.cpp (from rev 502, trunk/src/display.cxx)
===================================================================
--- trunk/src/display.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/display.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,46 @@
+//  $Id: display.cxx,v 1.2 2003/10/10 21:06:22 grumbel Exp $
+//
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ClanLib/gl.h&gt;
+#include &lt;ClanLib/Display/display.h&gt;
+#include &quot;display.hpp&quot;
+
+namespace Windstille {
+
+void
+Display::begin_gl()
+{
+  int viewport[4];
+  glGetIntegerv(GL_VIEWPORT, viewport);
+
+  //CL_Display::begin_3d();
+  glMatrixMode(GL_MODELVIEW);
+  glLoadIdentity();
+  gluOrtho2D (0, viewport[2], viewport[3], 0);
+}
+
+void
+Display::end_gl()
+{
+  //CL_Display::end_3d();
+}
+
+} // namespace Windstille
+
+/* EOF */

Deleted: trunk/src/display.cxx
===================================================================
--- trunk/src/display.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/display.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,46 +0,0 @@
-//  $Id: display.cxx,v 1.2 2003/10/10 21:06:22 grumbel Exp $
-//
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ClanLib/gl.h&gt;
-#include &lt;ClanLib/Display/display.h&gt;
-#include &quot;display.hxx&quot;
-
-namespace Windstille {
-
-void
-Display::begin_gl()
-{
-  int viewport[4];
-  glGetIntegerv(GL_VIEWPORT, viewport);
-
-  //CL_Display::begin_3d();
-  glMatrixMode(GL_MODELVIEW);
-  glLoadIdentity();
-  gluOrtho2D (0, viewport[2], viewport[3], 0);
-}
-
-void
-Display::end_gl()
-{
-  //CL_Display::end_3d();
-}
-
-} // namespace Windstille
-
-/* EOF */

Copied: trunk/src/display.hpp (from rev 502, trunk/src/display.hxx)
===================================================================
--- trunk/src/display.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/display.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,41 @@
+//  $Id: display.hpp,v 1.2 2003/10/10 21:06:22 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_DISPLAY_HXX
+#define HEADER_DISPLAY_HXX
+
+namespace Windstille {
+
+/** */
+class Display
+{
+private:
+public:
+  /** Enter 2d OpenGL mode and allow to draw polygons and such */
+  static void begin_gl();
+
+  /** Leave 2d OpenGL mode and give controll back to ClanLib */
+  static void end_gl();
+};
+
+} // namespace Windstille
+
+#endif
+
+/* EOF */

Deleted: trunk/src/display.hxx
===================================================================
--- trunk/src/display.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/display.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,41 +0,0 @@
-//  $Id: display.hxx,v 1.2 2003/10/10 21:06:22 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_DISPLAY_HXX
-#define HEADER_DISPLAY_HXX
-
-namespace Windstille {
-
-/** */
-class Display
-{
-private:
-public:
-  /** Enter 2d OpenGL mode and allow to draw polygons and such */
-  static void begin_gl();
-
-  /** Leave 2d OpenGL mode and give controll back to ClanLib */
-  static void end_gl();
-};
-
-} // namespace Windstille
-
-#endif
-
-/* EOF */

Copied: trunk/src/door.cpp (from rev 502, trunk/src/door.cxx)
===================================================================
--- trunk/src/door.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/door.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,43 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;globals.hpp&quot;
+#include &quot;door.hpp&quot;
+
+Door::Door(int x, int y)
+  : highlight(&quot;vrdoor/highlight&quot;, resources),
+    color(&quot;vrdoor/color&quot;, resources),
+    pos(32*x, 32*y)
+{
+}
+
+void
+Door::draw (SceneContext&amp; sc)
+{
+  sc.color().draw(color, pos.x, pos.y);
+  sc.color().draw(highlight, pos.x, pos.y);
+  sc.light().draw(highlight, pos.x, pos.y);
+}
+
+void
+Door::update (float)
+{
+}
+
+/* EOF */

Deleted: trunk/src/door.cxx
===================================================================
--- trunk/src/door.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/door.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,43 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;globals.hxx&quot;
-#include &quot;door.hxx&quot;
-
-Door::Door(int x, int y)
-  : highlight(&quot;vrdoor/highlight&quot;, resources),
-    color(&quot;vrdoor/color&quot;, resources),
-    pos(32*x, 32*y)
-{
-}
-
-void
-Door::draw (SceneContext&amp; sc)
-{
-  sc.color().draw(color, pos.x, pos.y);
-  sc.color().draw(highlight, pos.x, pos.y);
-  sc.light().draw(highlight, pos.x, pos.y);
-}
-
-void
-Door::update (float)
-{
-}
-
-/* EOF */

Copied: trunk/src/door.hpp (from rev 502, trunk/src/door.hxx)
===================================================================
--- trunk/src/door.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/door.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,46 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_DOOR_HXX
+#define HEADER_DOOR_HXX
+
+#include &lt;ClanLib/Display/sprite.h&gt;
+#include &quot;game_object.hpp&quot;
+
+/** */
+class Door : public GameObject
+{
+private:
+  CL_Sprite highlight;
+  CL_Sprite color;
+  CL_Vector pos;
+public:
+  Door(int x, int y);
+  virtual ~Door() {}
+
+  void draw (SceneContext&amp; sc);
+  void update (float);
+private:
+  Door (const Door&amp;);
+  Door&amp; operator= (const Door&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/door.hxx
===================================================================
--- trunk/src/door.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/door.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,46 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_DOOR_HXX
-#define HEADER_DOOR_HXX
-
-#include &lt;ClanLib/Display/sprite.h&gt;
-#include &quot;game_object.hxx&quot;
-
-/** */
-class Door : public GameObject
-{
-private:
-  CL_Sprite highlight;
-  CL_Sprite color;
-  CL_Vector pos;
-public:
-  Door(int x, int y);
-  virtual ~Door() {}
-
-  void draw (SceneContext&amp; sc);
-  void update (float);
-private:
-  Door (const Door&amp;);
-  Door&amp; operator= (const Door&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/energiebar.cpp (from rev 502, trunk/src/energiebar.cxx)
===================================================================
--- trunk/src/energiebar.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/energiebar.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,66 @@
+//  $Id: energiebar.cxx,v 1.3 2003/11/05 12:41:37 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ClanLib/Display/color.h&gt;
+#include &lt;ClanLib/Display/display.h&gt;
+#include &lt;ClanLib/Display/display_window.h&gt;
+#include &lt;ClanLib/Display/graphic_context.h&gt;
+#include &quot;globals.hpp&quot;
+#include &quot;player.hpp&quot;
+#include &quot;energiebar.hpp&quot;
+
+Energiebar::Energiebar()
+  : bar(&quot;energiebar&quot;, resources)
+{
+}
+
+Energiebar::~Energiebar()
+{
+}
+  
+void
+Energiebar::draw()
+{
+  int energie     = Player::current()-&gt;get_energie();
+  int max_energie = Player::current()-&gt;get_max_energie();
+
+  for(int i = 0; i &lt; energie; ++i)
+    {
+      float red   = 1.0f;
+      float green = (i/float(max_energie));
+      CL_Sprite sprite = bar;
+      sprite.set_color(red, green, 0, 1.0f);
+      sprite.draw(15 + (i * 10), 15);
+      CL_Display::get_current_window()-&gt;get_gc()-&gt;flush();
+    }
+
+  for(int i = energie; i &lt; max_energie; ++i)
+    {
+      bar.set_color(.5f, .5f, .5f, .5f);
+      bar.draw(15 + (i * 10), 15);
+    }
+}
+
+void
+Energiebar::update(float delta)
+{
+  bar.update(delta);
+}
+
+/* EOF */

Deleted: trunk/src/energiebar.cxx
===================================================================
--- trunk/src/energiebar.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/energiebar.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,66 +0,0 @@
-//  $Id: energiebar.cxx,v 1.3 2003/11/05 12:41:37 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ClanLib/Display/color.h&gt;
-#include &lt;ClanLib/Display/display.h&gt;
-#include &lt;ClanLib/Display/display_window.h&gt;
-#include &lt;ClanLib/Display/graphic_context.h&gt;
-#include &quot;globals.hxx&quot;
-#include &quot;player.hxx&quot;
-#include &quot;energiebar.hxx&quot;
-
-Energiebar::Energiebar()
-  : bar(&quot;energiebar&quot;, resources)
-{
-}
-
-Energiebar::~Energiebar()
-{
-}
-  
-void
-Energiebar::draw()
-{
-  int energie     = Player::current()-&gt;get_energie();
-  int max_energie = Player::current()-&gt;get_max_energie();
-
-  for(int i = 0; i &lt; energie; ++i)
-    {
-      float red   = 1.0f;
-      float green = (i/float(max_energie));
-      CL_Sprite sprite = bar;
-      sprite.set_color(red, green, 0, 1.0f);
-      sprite.draw(15 + (i * 10), 15);
-      CL_Display::get_current_window()-&gt;get_gc()-&gt;flush();
-    }
-
-  for(int i = energie; i &lt; max_energie; ++i)
-    {
-      bar.set_color(.5f, .5f, .5f, .5f);
-      bar.draw(15 + (i * 10), 15);
-    }
-}
-
-void
-Energiebar::update(float delta)
-{
-  bar.update(delta);
-}
-
-/* EOF */

Copied: trunk/src/energiebar.hpp (from rev 502, trunk/src/energiebar.hxx)
===================================================================
--- trunk/src/energiebar.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/energiebar.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,43 @@
+//  $Id: energiebar.hpp,v 1.1 2003/09/12 22:14:03 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_ENERGIEBAR_HXX
+#define HEADER_ENERGIEBAR_HXX
+
+#include &lt;ClanLib/Display/sprite.h&gt;
+
+/** */
+class Energiebar
+{
+private:
+  CL_Sprite bar;
+public:
+  Energiebar();
+  ~Energiebar();
+  
+  void draw();
+  void update(float delta);
+private:
+  Energiebar (const Energiebar&amp;);
+  Energiebar&amp; operator= (const Energiebar&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/energiebar.hxx
===================================================================
--- trunk/src/energiebar.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/energiebar.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,43 +0,0 @@
-//  $Id: energiebar.hxx,v 1.1 2003/09/12 22:14:03 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_ENERGIEBAR_HXX
-#define HEADER_ENERGIEBAR_HXX
-
-#include &lt;ClanLib/Display/sprite.h&gt;
-
-/** */
-class Energiebar
-{
-private:
-  CL_Sprite bar;
-public:
-  Energiebar();
-  ~Energiebar();
-  
-  void draw();
-  void update(float delta);
-private:
-  Energiebar (const Energiebar&amp;);
-  Energiebar&amp; operator= (const Energiebar&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/entity.cpp (from rev 502, trunk/src/entity.cxx)
===================================================================
--- trunk/src/entity.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/entity.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,113 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ClanLib/Display/display.h&gt;
+#include &lt;assert.h&gt;
+#include &quot;globals.hpp&quot;
+#include &quot;entity.hpp&quot;
+
+Entity::Entity(const CL_Vector&amp; pos_)
+  : pos(pos_),
+    parent(0),
+    sprite(&quot;igel&quot;, resources)
+{
+  mover_active = false;
+}
+
+Entity::~Entity()
+{
+}
+
+CL_Vector
+Entity::get_pos() const
+{
+  if (parent)
+    return parent-&gt;get_pos() + pos;
+  else
+    return pos;
+}
+
+void
+Entity::bind(Entity* parent_, bool recalc_pos)
+{
+  assert(parent_);
+
+  parent = parent_;
+  if (recalc_pos)
+    pos -= parent-&gt;get_pos();
+}
+
+void
+Entity::unbind(bool recalc_pos)
+{
+  parent = 0;
+  if (recalc_pos)
+    pos += parent-&gt;get_pos();
+}
+
+void
+Entity::draw(SceneContext&amp; )
+{
+  sprite.draw(int(get_pos().x), int(get_pos().y));
+  if (parent)
+    CL_Display::draw_line(int(get_pos().x), int(get_pos().y),
+                          int(parent-&gt;get_pos().x), int(parent-&gt;get_pos().y),
+                          CL_Color(255, 255, 255, 255));
+}
+
+void
+Entity::update(float delta)
+{
+  sprite.update(delta);
+  
+  if (mover_active) 
+    {
+      float dir_x = (target_pos.x - pos.x) &gt; 0? 100.0f : -100.0f;
+    
+      //std::cout &lt;&lt; this &lt;&lt; &quot; &quot; &lt;&lt; target_pos.x &lt;&lt; &quot; &quot; &lt;&lt; pos.x &lt;&lt; std::endl;
+
+      pos.x += dir_x * delta;
+
+      float dir_x2 = (target_pos.x - pos.x) &gt; 0 ? 100.0f : -100.0f;
+    
+      if (dir_x != dir_x2)
+        {
+          //std::cout &lt;&lt; &quot;Done!!!&quot; &lt;&lt; std::endl;
+          mover_active = false;
+          done();
+        }
+    }
+}
+
+void
+Entity::set_pos(float x, float y)
+{
+  pos.x = x;
+  pos.y = y;
+}
+
+void
+Entity::move_to(float x, float y)
+{
+  mover_active = true;
+  target_pos.x = pos.x + x;
+  target_pos.y = pos.y + y;
+}
+
+/* EOF */

Deleted: trunk/src/entity.cxx
===================================================================
--- trunk/src/entity.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/entity.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,113 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ClanLib/Display/display.h&gt;
-#include &lt;assert.h&gt;
-#include &quot;globals.hxx&quot;
-#include &quot;entity.hxx&quot;
-
-Entity::Entity(const CL_Vector&amp; pos_)
-  : pos(pos_),
-    parent(0),
-    sprite(&quot;igel&quot;, resources)
-{
-  mover_active = false;
-}
-
-Entity::~Entity()
-{
-}
-
-CL_Vector
-Entity::get_pos() const
-{
-  if (parent)
-    return parent-&gt;get_pos() + pos;
-  else
-    return pos;
-}
-
-void
-Entity::bind(Entity* parent_, bool recalc_pos)
-{
-  assert(parent_);
-
-  parent = parent_;
-  if (recalc_pos)
-    pos -= parent-&gt;get_pos();
-}
-
-void
-Entity::unbind(bool recalc_pos)
-{
-  parent = 0;
-  if (recalc_pos)
-    pos += parent-&gt;get_pos();
-}
-
-void
-Entity::draw(SceneContext&amp; )
-{
-  sprite.draw(int(get_pos().x), int(get_pos().y));
-  if (parent)
-    CL_Display::draw_line(int(get_pos().x), int(get_pos().y),
-                          int(parent-&gt;get_pos().x), int(parent-&gt;get_pos().y),
-                          CL_Color(255, 255, 255, 255));
-}
-
-void
-Entity::update(float delta)
-{
-  sprite.update(delta);
-  
-  if (mover_active) 
-    {
-      float dir_x = (target_pos.x - pos.x) &gt; 0? 100.0f : -100.0f;
-    
-      //std::cout &lt;&lt; this &lt;&lt; &quot; &quot; &lt;&lt; target_pos.x &lt;&lt; &quot; &quot; &lt;&lt; pos.x &lt;&lt; std::endl;
-
-      pos.x += dir_x * delta;
-
-      float dir_x2 = (target_pos.x - pos.x) &gt; 0 ? 100.0f : -100.0f;
-    
-      if (dir_x != dir_x2)
-        {
-          //std::cout &lt;&lt; &quot;Done!!!&quot; &lt;&lt; std::endl;
-          mover_active = false;
-          done();
-        }
-    }
-}
-
-void
-Entity::set_pos(float x, float y)
-{
-  pos.x = x;
-  pos.y = y;
-}
-
-void
-Entity::move_to(float x, float y)
-{
-  mover_active = true;
-  target_pos.x = pos.x + x;
-  target_pos.y = pos.y + y;
-}
-
-/* EOF */

Copied: trunk/src/entity.hpp (from rev 502, trunk/src/entity.hxx)
===================================================================
--- trunk/src/entity.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/entity.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,74 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_ENTITY_HXX
+#define HEADER_ENTITY_HXX
+
+#include &lt;ClanLib/Core/Math/cl_vector.h&gt;
+#include &lt;ClanLib/Display/sprite.h&gt;
+#include &quot;game_object.hpp&quot;
+
+/** A GameObject which has a position and some other properties which
+    are shared among all/most things in the world */
+class Entity : public GameObject
+{
+private:
+  CL_Vector pos;
+  bool mover_active;
+  CL_Vector target_pos;
+  
+  /** Reference to the parent object, must not be deleted */
+  Entity* parent;
+
+  CL_Sprite sprite;
+
+  CL_Signal_v0 done;
+
+public:
+  Entity(const CL_Vector&amp; pos_);
+  virtual ~Entity();
+  
+  /** Bind the entity to a parent, causing all movement to be affected
+      by the parent entity
+  
+      @param recalc_pos recalculates the current entities position
+      into the local space of parent_
+  */
+  void bind(Entity* parent_, bool recalc_pos = true);
+
+  /** Unbinds an entity */
+  void unbind(bool recalc_pos = true);
+  
+  CL_Vector get_pos() const;
+
+  void set_pos(float x, float y);
+  void move_to(float x, float y);
+
+  void draw(SceneContext&amp; gc);
+  void update(float delta);
+
+  CL_Signal_v0&amp; sig_done() { return done; }
+private:
+  Entity (const Entity&amp;);
+  Entity&amp; operator= (const Entity&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/entity.hxx
===================================================================
--- trunk/src/entity.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/entity.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,74 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_ENTITY_HXX
-#define HEADER_ENTITY_HXX
-
-#include &lt;ClanLib/Core/Math/cl_vector.h&gt;
-#include &lt;ClanLib/Display/sprite.h&gt;
-#include &quot;game_object.hxx&quot;
-
-/** A GameObject which has a position and some other properties which
-    are shared among all/most things in the world */
-class Entity : public GameObject
-{
-private:
-  CL_Vector pos;
-  bool mover_active;
-  CL_Vector target_pos;
-  
-  /** Reference to the parent object, must not be deleted */
-  Entity* parent;
-
-  CL_Sprite sprite;
-
-  CL_Signal_v0 done;
-
-public:
-  Entity(const CL_Vector&amp; pos_);
-  virtual ~Entity();
-  
-  /** Bind the entity to a parent, causing all movement to be affected
-      by the parent entity
-  
-      @param recalc_pos recalculates the current entities position
-      into the local space of parent_
-  */
-  void bind(Entity* parent_, bool recalc_pos = true);
-
-  /** Unbinds an entity */
-  void unbind(bool recalc_pos = true);
-  
-  CL_Vector get_pos() const;
-
-  void set_pos(float x, float y);
-  void move_to(float x, float y);
-
-  void draw(SceneContext&amp; gc);
-  void update(float delta);
-
-  CL_Signal_v0&amp; sig_done() { return done; }
-private:
-  Entity (const Entity&amp;);
-  Entity&amp; operator= (const Entity&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/field.hpp (from rev 502, trunk/src/field.hxx)
===================================================================
--- trunk/src/field.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/field.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,121 @@
+//  $Id: field.hpp,v 1.4 2003/09/12 09:25:48 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef FIELD_HXX
+#define FIELD_HXX
+
+#include &lt;vector&gt;
+#include &lt;assert.h&gt;
+
+template&lt;class T&gt;
+class Field
+{
+private:
+  int width;
+  int height;
+  std::vector&lt;T&gt; vec;
+
+public:
+  typedef typename std::vector&lt;T&gt;::iterator iterator;
+
+  Field()
+    : width(0), height(0)
+  {
+  }
+
+  Field (int w, int h) 
+    : width (w), height (h), vec (width * height)
+  {
+  }
+
+  /** Creates a new field out of a subsection from an already excisting one 
+   *  @param pos_x The position of the old field in the new resized one
+   *  @param pos_y The position of the old field in the new resized one */
+  Field(const Field&lt;T&gt;&amp; arg_field, int w, int h, int pos_x, int pos_y)
+    : width (w), height (h), vec (width * height)
+  {
+    int start_x = std::max(0, -pos_x);
+    int start_y = std::max(0, -pos_y);
+
+    int end_x = std::min(arg_field.get_width(),  get_width()  - pos_x);
+    int end_y = std::min(arg_field.get_height(), get_height() - pos_y);
+
+    for(int y = start_y; y &lt; end_y; ++y)
+      for(int x = start_x; x &lt; end_x; ++x)
+        at(pos_x + x, pos_y + y) = arg_field.at(x, y);
+  }
+
+  const T&amp; operator[] (int i) const {
+    return vec[i];
+  }
+
+  T&amp; operator[] (int i) {
+    return vec[i];
+  }
+
+  T&amp; operator() (int x, int y) 
+  {
+    assert (x &gt;= 0 || x &lt; (int) width || y &gt;= 0 || y &lt; (int) height);
+    return vec [width*y + x];
+  }
+
+  const T&amp; operator() (int x, int y) const
+  {
+    assert (x &gt;= 0 || x &lt; (int) width || y &gt;= 0 || y &lt; (int) height);
+    return vec [width*y + x];
+  }
+  
+  inline const T&amp; at (int x, int y) const {
+    return (*this) (x, y);
+  }
+
+  inline T&amp; at (int x, int y) {
+    return (*this) (x, y);
+  }
+
+  /** Resize a field to a new size
+   *  @param pos_x The position of the old field in the new resized one
+   *  @param pos_y The position of the old field in the new resized one
+   **/
+  void resize(int w, int h, int pos_x = 0, int pos_y = 0) 
+  {
+    *this = Field&lt;T&gt;(*this, w, h, pos_x, pos_y);
+  }
+
+  void clear()
+  {
+    width  = 0;
+    height = 0;
+    vec.clear();
+  }
+
+  /** Provides raw access to the underlying vector */
+  std::vector&lt;T&gt;&amp; get_vector() { return vec; }
+
+  iterator begin () { return vec.begin (); }
+  iterator end () { return vec.end (); }
+
+  int size() const { return vec.size(); }
+  int get_width () const { return width; }
+  int get_height () const { return height; }
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/field.hxx
===================================================================
--- trunk/src/field.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/field.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,121 +0,0 @@
-//  $Id: field.hxx,v 1.4 2003/09/12 09:25:48 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef FIELD_HXX
-#define FIELD_HXX
-
-#include &lt;vector&gt;
-#include &lt;assert.h&gt;
-
-template&lt;class T&gt;
-class Field
-{
-private:
-  int width;
-  int height;
-  std::vector&lt;T&gt; vec;
-
-public:
-  typedef typename std::vector&lt;T&gt;::iterator iterator;
-
-  Field()
-    : width(0), height(0)
-  {
-  }
-
-  Field (int w, int h) 
-    : width (w), height (h), vec (width * height)
-  {
-  }
-
-  /** Creates a new field out of a subsection from an already excisting one 
-   *  @param pos_x The position of the old field in the new resized one
-   *  @param pos_y The position of the old field in the new resized one */
-  Field(const Field&lt;T&gt;&amp; arg_field, int w, int h, int pos_x, int pos_y)
-    : width (w), height (h), vec (width * height)
-  {
-    int start_x = std::max(0, -pos_x);
-    int start_y = std::max(0, -pos_y);
-
-    int end_x = std::min(arg_field.get_width(),  get_width()  - pos_x);
-    int end_y = std::min(arg_field.get_height(), get_height() - pos_y);
-
-    for(int y = start_y; y &lt; end_y; ++y)
-      for(int x = start_x; x &lt; end_x; ++x)
-        at(pos_x + x, pos_y + y) = arg_field.at(x, y);
-  }
-
-  const T&amp; operator[] (int i) const {
-    return vec[i];
-  }
-
-  T&amp; operator[] (int i) {
-    return vec[i];
-  }
-
-  T&amp; operator() (int x, int y) 
-  {
-    assert (x &gt;= 0 || x &lt; (int) width || y &gt;= 0 || y &lt; (int) height);
-    return vec [width*y + x];
-  }
-
-  const T&amp; operator() (int x, int y) const
-  {
-    assert (x &gt;= 0 || x &lt; (int) width || y &gt;= 0 || y &lt; (int) height);
-    return vec [width*y + x];
-  }
-  
-  inline const T&amp; at (int x, int y) const {
-    return (*this) (x, y);
-  }
-
-  inline T&amp; at (int x, int y) {
-    return (*this) (x, y);
-  }
-
-  /** Resize a field to a new size
-   *  @param pos_x The position of the old field in the new resized one
-   *  @param pos_y The position of the old field in the new resized one
-   **/
-  void resize(int w, int h, int pos_x = 0, int pos_y = 0) 
-  {
-    *this = Field&lt;T&gt;(*this, w, h, pos_x, pos_y);
-  }
-
-  void clear()
-  {
-    width  = 0;
-    height = 0;
-    vec.clear();
-  }
-
-  /** Provides raw access to the underlying vector */
-  std::vector&lt;T&gt;&amp; get_vector() { return vec; }
-
-  iterator begin () { return vec.begin (); }
-  iterator end () { return vec.end (); }
-
-  int size() const { return vec.size(); }
-  int get_width () const { return width; }
-  int get_height () const { return height; }
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/fonts.cpp (from rev 502, trunk/src/fonts.cxx)
===================================================================
--- trunk/src/fonts.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/fonts.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,55 @@
+//  $Id: fonts.cxx,v 1.2 2003/09/29 19:29:17 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;globals.hpp&quot;
+#include &quot;fonts.hpp&quot;
+
+CL_Font Fonts::dialog;
+CL_Font Fonts::dialog_h;
+
+CL_Font Fonts::menu;
+CL_Font Fonts::menu_h;
+
+CL_Font Fonts::copyright;
+
+void
+Fonts::init()
+{
+  dialog   = CL_Font(&quot;font&quot;, resources);
+  dialog_h = CL_Font(&quot;font_h&quot;, resources);
+
+  menu   = CL_Font(&quot;menu&quot;, resources);
+  menu_h = CL_Font(&quot;menu_h&quot;, resources);
+
+  copyright = CL_Font(&quot;copyright&quot;, resources);
+}
+
+void
+Fonts::deinit()
+{
+  dialog   = CL_Font();
+  dialog_h = CL_Font();
+
+  menu   = CL_Font();
+  menu_h = CL_Font();
+
+  copyright = CL_Font();
+}
+
+/* EOF */

Deleted: trunk/src/fonts.cxx
===================================================================
--- trunk/src/fonts.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/fonts.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,55 +0,0 @@
-//  $Id: fonts.cxx,v 1.2 2003/09/29 19:29:17 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;globals.hxx&quot;
-#include &quot;fonts.hxx&quot;
-
-CL_Font Fonts::dialog;
-CL_Font Fonts::dialog_h;
-
-CL_Font Fonts::menu;
-CL_Font Fonts::menu_h;
-
-CL_Font Fonts::copyright;
-
-void
-Fonts::init()
-{
-  dialog   = CL_Font(&quot;font&quot;, resources);
-  dialog_h = CL_Font(&quot;font_h&quot;, resources);
-
-  menu   = CL_Font(&quot;menu&quot;, resources);
-  menu_h = CL_Font(&quot;menu_h&quot;, resources);
-
-  copyright = CL_Font(&quot;copyright&quot;, resources);
-}
-
-void
-Fonts::deinit()
-{
-  dialog   = CL_Font();
-  dialog_h = CL_Font();
-
-  menu   = CL_Font();
-  menu_h = CL_Font();
-
-  copyright = CL_Font();
-}
-
-/* EOF */

Copied: trunk/src/fonts.hpp (from rev 502, trunk/src/fonts.hxx)
===================================================================
--- trunk/src/fonts.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/fonts.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,42 @@
+//  $Id: fonts.hpp,v 1.2 2003/09/29 19:29:17 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_FONTS_HXX
+#define HEADER_FONTS_HXX
+
+#include &lt;ClanLib/Display/font.h&gt;
+
+namespace Fonts {
+
+extern CL_Font dialog;
+extern CL_Font dialog_h;
+
+extern CL_Font menu;
+extern CL_Font menu_h;
+
+extern CL_Font copyright;
+
+void init();
+void deinit();
+
+} // namespace Fonts
+
+#endif
+
+/* EOF */

Deleted: trunk/src/fonts.hxx
===================================================================
--- trunk/src/fonts.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/fonts.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,42 +0,0 @@
-//  $Id: fonts.hxx,v 1.2 2003/09/29 19:29:17 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_FONTS_HXX
-#define HEADER_FONTS_HXX
-
-#include &lt;ClanLib/Display/font.h&gt;
-
-namespace Fonts {
-
-extern CL_Font dialog;
-extern CL_Font dialog_h;
-
-extern CL_Font menu;
-extern CL_Font menu_h;
-
-extern CL_Font copyright;
-
-void init();
-void deinit();
-
-} // namespace Fonts
-
-#endif
-
-/* EOF */

Copied: trunk/src/game_object.cpp (from rev 502, trunk/src/game_object.cxx)
===================================================================
--- trunk/src/game_object.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/game_object.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,24 @@
+//  $Id: gameobj.cxx,v 1.2 2003/08/12 08:24:41 grumbel Exp $
+//
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;game_object.hpp&quot;
+
+Sector* GameObject::world;
+
+/* EOF */

Deleted: trunk/src/game_object.cxx
===================================================================
--- trunk/src/game_object.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/game_object.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,24 +0,0 @@
-//  $Id: gameobj.cxx,v 1.2 2003/08/12 08:24:41 grumbel Exp $
-//
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;game_object.hxx&quot;
-
-Sector* GameObject::world;
-
-/* EOF */

Copied: trunk/src/game_object.hpp (from rev 502, trunk/src/game_object.hxx)
===================================================================
--- trunk/src/game_object.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/game_object.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,49 @@
+//  $Id: game_object.hpp,v 1.2 2003/08/12 08:24:41 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef GAME_OBJECT_HXX
+#define GAME_OBJECT_HXX
+
+#include &quot;display/scene_context.hpp&quot;
+
+class Sector;
+
+class GameObject
+{
+private:
+  static Sector* world;
+  bool remove_;
+protected:
+  void remove () { remove_= true; } 
+public:
+  bool is_removable () { return remove_; } 
+  static void set_world (Sector* w) { world = w; }
+  
+  Sector* get_world () { return world; }
+
+  GameObject() : remove_ (false) {}
+  virtual ~GameObject() {}
+
+  virtual void draw (SceneContext&amp; sc) =0;
+  virtual void update (float) =0;
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/game_object.hxx
===================================================================
--- trunk/src/game_object.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/game_object.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,49 +0,0 @@
-//  $Id: game_object.hxx,v 1.2 2003/08/12 08:24:41 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef GAME_OBJECT_HXX
-#define GAME_OBJECT_HXX
-
-#include &quot;display/scene_context.hxx&quot;
-
-class Sector;
-
-class GameObject
-{
-private:
-  static Sector* world;
-  bool remove_;
-protected:
-  void remove () { remove_= true; } 
-public:
-  bool is_removable () { return remove_; } 
-  static void set_world (Sector* w) { world = w; }
-  
-  Sector* get_world () { return world; }
-
-  GameObject() : remove_ (false) {}
-  virtual ~GameObject() {}
-
-  virtual void draw (SceneContext&amp; sc) =0;
-  virtual void update (float) =0;
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/game_session.cpp (from rev 502, trunk/src/game_session.cxx)
===================================================================
--- trunk/src/game_session.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/game_session.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,407 @@
+//  $Id: windstille_game.cxx,v 1.33 2003/11/13 12:59:42 grumbel Exp $
+//
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;math.h&gt;
+#include &lt;ClanLib/gl.h&gt;
+#include &lt;sstream&gt;
+#include &lt;stdarg.h&gt;
+
+#include &lt;squirrel.h&gt; 
+#include &lt;sqstdio.h&gt; 
+#include &lt;sqstdaux.h&gt; 
+
+#include &quot;fonts.hpp&quot;
+#include &quot;sector.hpp&quot;
+#include &quot;console.hpp&quot;
+#include &quot;game_object.hpp&quot;
+#include &quot;player.hpp&quot;
+#include &quot;animation_obj.hpp&quot;
+#include &quot;tile_map.hpp&quot;
+#include &quot;display.hpp&quot;
+#include &quot;view.hpp&quot;
+#include &quot;door.hpp&quot;
+#include &quot;timer.hpp&quot;
+#include &quot;energiebar.hpp&quot;
+#include &quot;sprite3d.hpp&quot;
+#include &quot;dialog_manager.hpp&quot;
+#include &quot;windstille_main.hpp&quot;
+#include &quot;display/scene_context.hpp&quot;
+#include &quot;scripting/wrapper_util.hpp&quot;
+#include &quot;scripting/wrapper.hpp&quot;
+#include &quot;input/input_manager.hpp&quot;
+#include &quot;particle_system.hpp&quot;
+#include &quot;script_manager.hpp&quot;
+#include &quot;sound/sound_manager.hpp&quot;
+
+#include &quot;game_session.hpp&quot;
+
+using namespace Windstille;
+
+GameSession* GameSession::current_ = 0; 
+
+GameSession::GameSession(const std::string&amp; arg_filename)
+  : console(16, CL_Display::get_height()-16),
+    control_dialog(&quot;controldialog&quot;, resources),
+    world (0)
+{
+  current_ = this;
+  set_sector(arg_filename);
+}
+
+GameSession::~GameSession()
+{
+  delete world;
+}
+
+void
+GameSession::draw_game()
+{
+  if (0)
+    {
+      // Generic blue background
+      // FIXME: let the level decide which kind of background he wants 
+      CL_Display::fill_rect(CL_Rect(0, 0, 800, 300),
+                            CL_Gradient(CL_Color(  0,   0,  50),
+                                        CL_Color(  0,   0,  50),
+                                        CL_Color( 50,  50, 128),
+                                        CL_Color( 50,  50, 128)));
+      CL_Display::fill_rect(CL_Rect(0, 300, 800, 600),
+                            CL_Gradient(CL_Color( 50,  50, 128),
+                                        CL_Color( 50,  50, 128),
+                                        CL_Color(  0,   0,   0),
+                                        CL_Color(  0,   0,   0)));
+    }
+
+  view-&gt;draw(sc);
+
+  // Render the scene to the screen
+  sc.render();
+
+  // Draw HUD
+  energiebar-&gt;draw();
+
+  switch (control_state)
+    {
+    case DIALOG:
+      dialog_manager-&gt;draw();      
+      break;
+    default:
+      break;
+    }
+  
+  control_dialog.set_alignment(origin_bottom_right);
+  control_dialog.draw(800-16, 600-16);
+
+  // Draw Logo
+  if (0)
+    {     
+      //logo.set_blend_func(blend_src_alpha, blend_one);
+      logo.set_alpha(cos(blink)*0.5f + 0.5f);
+      logo.draw(800 - 302, 600 - 95);
+      logo_black.draw(800 - 302, 600 - 95);
+    }
+}
+
+void
+GameSession::draw()
+{
+  //std::cout &lt;&lt; gluErrorString(glGetError()) &lt;&lt; std::endl;
+
+  draw_game();
+  console.draw();
+
+  switch (state)
+    {
+    case FADEOUT:
+      CL_Display::fill_rect(CL_Rect(0, 0, 
+                                    CL_Display::get_width(), CL_Display::get_height()),
+                            CL_Color(0,0,0, std::min(int(fadeout_value*255), 255)));
+      break;
+    case FADEIN:
+      CL_Display::fill_rect(CL_Rect(0, 0, 
+                                    CL_Display::get_width(), CL_Display::get_height()),
+                            CL_Color(0,0,0, 255-std::min(int(fadeout_value*255), 255)));
+      break;
+
+    default:
+      break;
+    }
+
+  if (player-&gt;get_movement_state() == Player::DEAD)
+    {
+      CL_Font font = Fonts::dialog;
+      font.set_alignment(origin_bottom_center);
+      font.draw(CL_Display::get_width()/2, 200,
+                &quot;..:: Press Fire to restart ::..&quot;);
+    }
+
+  if (!main_app.screenshot_dir.empty())
+    {
+      std::stringstream filename;
+      filename &lt;&lt; main_app.screenshot_dir;
+      filename.width(8);
+      filename.fill('0');
+      filename &lt;&lt; frames;
+      filename &lt;&lt; &quot;.png&quot;;
+      CL_ProviderFactory::save(CL_Display::get_front_buffer(), filename.str());
+    }
+}
+
+void
+GameSession::update(float delta)
+{
+  console.update(delta);
+
+  InputManager::update(delta);
+  delta *= game_speed;
+
+  game_time += delta;
+  script_manager-&gt;update();
+
+  view-&gt;update(delta);
+
+  switch (state)
+    {
+    case FADEIN:
+      if (fadeout_value &gt; 1.0f)
+        state = RUNNING;
+      fadeout_value += delta;
+      break;
+    case FADEOUT:
+      if (fadeout_value &gt; 1.0f)
+        Screen::quit();
+
+      fadeout_value += delta;
+      break;
+
+    case RUNNING:
+      switch (control_state) 
+        {
+        case DIALOG:
+          dialog_manager-&gt;update(delta);
+          break;
+        case GAME:
+          world-&gt;update (delta);
+          energiebar-&gt;update(delta);
+          break;
+        }
+      break;
+    }
+  
+  if (CL_Keyboard::get_keycode(CL_KEY_ESCAPE))
+    quit();
+  
+  InputManager::clear();
+
+  blink += delta * 3.141f;
+}
+
+void
+GameSession::set_sector (const std::string&amp; arg_filename)
+{
+  if (world)
+    delete world;
+
+  filename = arg_filename;
+  world = new Sector(filename);
+
+  state = FADEIN;
+  fadeout_value = 0;
+
+  control_state = GAME;
+}
+
+void
+GameSession::on_startup ()
+{ 
+  slots.push_back(CL_Keyboard::sig_key_down().connect(this, &amp;GameSession::on_key_down));
+  slots.push_back(CL_Mouse::sig_key_down().connect(this, &amp;GameSession::on_mouse_down));
+
+  blink = 0.0f;
+
+  GameObject::set_world (world);
+
+  player = new Player();
+  view   = new View();
+  
+  energiebar = new Energiebar();
+  dialog_manager = new DialogManager();
+
+  world-&gt;add(player);
+
+  logo       = CL_Sprite(&quot;logo&quot;, resources);
+  logo_black = CL_Sprite(&quot;logo_black&quot;, resources);
+
+  if (1)
+    {
+      world-&gt;add(new Door(24, 6));
+      world-&gt;add(new Door(32, 14));
+      world-&gt;add(new Door(8, 22));
+
+      CL_Surface surface1(&quot;particles/smoke&quot;, resources);
+      CL_Surface surface2(&quot;particles/smoke2&quot;, resources);
+
+      ParticleSystem* psystem2 = new ParticleSystem();
+      psystem2-&gt;set_drawer(new SparkDrawer());
+      psystem2-&gt;set_pos(0,0);
+      psystem2-&gt;set_speed(300, 550);
+      psystem2-&gt;set_cone(-25-90, 25-90);
+      psystem2-&gt;set_gravity(0, 5);
+      psystem2-&gt;set_line_distribution(-50, 0, 50, 0);
+
+      ParticleSystem* psystem3 = new ParticleSystem();
+      psystem3-&gt;set_lifetime(8);
+      psystem3-&gt;set_count(30);
+      surface2.set_blend_func(blend_src_alpha, blend_one_minus_src_alpha);
+      surface2.set_alignment(origin_center);
+      psystem3-&gt;set_drawer(new SurfaceDrawer(surface2));
+      psystem3-&gt;set_pos(0,0);
+      psystem3-&gt;set_speed(70, 100);
+      psystem3-&gt;set_cone(-25-90, 25-90);
+      psystem3-&gt;set_gravity(0, -1);
+      psystem3-&gt;set_size(1.0f, 3.0f);
+      psystem3-&gt;set_line_distribution(-50, 0, 50, 0);
+ 
+      ParticleSystem* psystem = new ParticleSystem();
+      psystem-&gt;set_count(100);
+      surface1.set_blend_func(blend_src_alpha, blend_one);
+      surface1.set_alignment(origin_center);
+      psystem-&gt;set_drawer(new SurfaceDrawer(surface1));
+      psystem-&gt;set_pos(0,0);
+      psystem-&gt;set_speed(200, 300);
+      psystem-&gt;set_cone(-5-90, 5-90);
+      psystem-&gt;set_gravity(0, 0);
+      psystem-&gt;set_line_distribution(-50, 0, 50, 0);
+
+      psystem-&gt;set_spawn_point (768, 832);
+      psystem2-&gt;set_spawn_point(768, 832);
+      psystem3-&gt;set_spawn_point(768, 832);
+      
+      world-&gt;add(psystem3);
+      world-&gt;add(psystem2);
+      world-&gt;add(psystem);
+    }
+  
+  world-&gt;add(new Sprite3D(&quot;3dsprites/3dsprites&quot;));
+
+  world-&gt;activate();
+}
+
+void
+GameSession::on_shutdown ()
+{
+  delete energiebar;
+  delete view;
+  delete dialog_manager;
+}
+
+void
+GameSession::quit()
+{
+  if (state != FADEOUT)
+    {
+      fadeout_value = 0;
+      sound_manager-&gt;stop_music();
+      state = FADEOUT;
+    }
+}
+
+void
+GameSession::on_mouse_down(const CL_InputEvent&amp; event)
+{
+  switch(event.id)
+    {
+    case CL_MOUSE_LEFT:
+      console.add(&quot;Click at: &quot;, CL_Point(view-&gt;screen2world(event.mouse_pos)));
+      break;
+    default:
+      break;
+    }
+}
+
+void
+GameSession::on_key_down(const CL_InputEvent&amp; event)
+{
+  if (!console.is_active())
+    {
+      switch(event.id)
+        {
+        case CL_KEY_F1:
+          console.activate();
+          break;
+
+        case CL_KEY_1:
+          sc.set_render_mask(sc.get_render_mask() ^ SceneContext::COLORMAP);
+          console.add(&quot;Toggled COLORMAP: &quot;, (sc.get_render_mask() &amp; SceneContext::COLORMAP) &gt; 0);
+          break;
+
+        case CL_KEY_2:
+          sc.set_render_mask(sc.get_render_mask() ^ SceneContext::LIGHTMAP);
+          console.add(&quot;Toggled LIGHTMAP: &quot;, (sc.get_render_mask() &amp; SceneContext::LIGHTMAP) &gt; 0);
+          break;
+
+        case CL_KEY_3:
+          sc.set_render_mask(sc.get_render_mask() ^ SceneContext::HIGHLIGHTMAP);
+          console.add(&quot;Toggled HIGHLIGHTMAP: &quot;, (sc.get_render_mask() &amp; SceneContext::HIGHLIGHTMAP) &gt; 0);
+          break;      
+
+        default:
+          // ignore key
+          //console.add(&quot;Key pressed:: &quot;, event.id);
+          break;
+        }
+    }
+}
+
+void
+GameSession::execute(const std::string&amp; str_)
+{
+  std::string str = str_; //&quot;return (&quot; + str_ + &quot;)&quot;;
+
+  int i = str.length();
+  const char* buffer = str.c_str();
+
+  HSQUIRRELVM vm = script_manager-&gt;get_vm();
+  int oldtop=sq_gettop(vm); 
+  try {
+    int retval = 0;
+
+    if(i&gt;0){
+      if(SQ_SUCCEEDED(sq_compilebuffer(vm,buffer,i,_SC(&quot;interactive console&quot;),SQTrue))){
+        sq_pushroottable(vm);
+        if(SQ_SUCCEEDED(sq_call(vm,1, retval))) {
+          scprintf(_SC(&quot;\n&quot;));
+          sq_pushroottable(vm);
+          sq_pushstring(vm,_SC(&quot;print&quot;),-1);
+          sq_get(vm,-2);
+          sq_pushroottable(vm);
+          sq_push(vm,-4);
+          sq_call(vm,2,SQFalse);
+          scprintf(_SC(&quot;\n&quot;));
+        }
+      }
+    }
+  } catch(std::exception&amp; e) {
+    std::cerr &lt;&lt; &quot;Couldn't execute command '&quot; &lt;&lt; str_ &lt;&lt; &quot;': &quot;
+      &lt;&lt; e.what() &lt;&lt; &quot;\n&quot;;
+  }
+  sq_settop(vm,oldtop);
+}
+
+/* EOF */

Deleted: trunk/src/game_session.cxx
===================================================================
--- trunk/src/game_session.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/game_session.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,407 +0,0 @@
-//  $Id: windstille_game.cxx,v 1.33 2003/11/13 12:59:42 grumbel Exp $
-//
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;math.h&gt;
-#include &lt;ClanLib/gl.h&gt;
-#include &lt;sstream&gt;
-#include &lt;stdarg.h&gt;
-
-#include &lt;squirrel.h&gt; 
-#include &lt;sqstdio.h&gt; 
-#include &lt;sqstdaux.h&gt; 
-
-#include &quot;fonts.hxx&quot;
-#include &quot;sector.hxx&quot;
-#include &quot;console.hxx&quot;
-#include &quot;game_object.hxx&quot;
-#include &quot;player.hxx&quot;
-#include &quot;animation_obj.hxx&quot;
-#include &quot;tile_map.hxx&quot;
-#include &quot;display.hxx&quot;
-#include &quot;view.hxx&quot;
-#include &quot;door.hxx&quot;
-#include &quot;timer.hpp&quot;
-#include &quot;energiebar.hxx&quot;
-#include &quot;sprite3d.hxx&quot;
-#include &quot;dialog_manager.hxx&quot;
-#include &quot;windstille_main.hxx&quot;
-#include &quot;display/scene_context.hxx&quot;
-#include &quot;scripting/wrapper_util.hpp&quot;
-#include &quot;scripting/wrapper.hpp&quot;
-#include &quot;input/input_manager.hxx&quot;
-#include &quot;particle_system.hxx&quot;
-#include &quot;script_manager.hpp&quot;
-#include &quot;sound/sound_manager.hpp&quot;
-
-#include &quot;game_session.hxx&quot;
-
-using namespace Windstille;
-
-GameSession* GameSession::current_ = 0; 
-
-GameSession::GameSession(const std::string&amp; arg_filename)
-  : console(16, CL_Display::get_height()-16),
-    control_dialog(&quot;controldialog&quot;, resources),
-    world (0)
-{
-  current_ = this;
-  set_sector(arg_filename);
-}
-
-GameSession::~GameSession()
-{
-  delete world;
-}
-
-void
-GameSession::draw_game()
-{
-  if (0)
-    {
-      // Generic blue background
-      // FIXME: let the level decide which kind of background he wants 
-      CL_Display::fill_rect(CL_Rect(0, 0, 800, 300),
-                            CL_Gradient(CL_Color(  0,   0,  50),
-                                        CL_Color(  0,   0,  50),
-                                        CL_Color( 50,  50, 128),
-                                        CL_Color( 50,  50, 128)));
-      CL_Display::fill_rect(CL_Rect(0, 300, 800, 600),
-                            CL_Gradient(CL_Color( 50,  50, 128),
-                                        CL_Color( 50,  50, 128),
-                                        CL_Color(  0,   0,   0),
-                                        CL_Color(  0,   0,   0)));
-    }
-
-  view-&gt;draw(sc);
-
-  // Render the scene to the screen
-  sc.render();
-
-  // Draw HUD
-  energiebar-&gt;draw();
-
-  switch (control_state)
-    {
-    case DIALOG:
-      dialog_manager-&gt;draw();      
-      break;
-    default:
-      break;
-    }
-  
-  control_dialog.set_alignment(origin_bottom_right);
-  control_dialog.draw(800-16, 600-16);
-
-  // Draw Logo
-  if (0)
-    {     
-      //logo.set_blend_func(blend_src_alpha, blend_one);
-      logo.set_alpha(cos(blink)*0.5f + 0.5f);
-      logo.draw(800 - 302, 600 - 95);
-      logo_black.draw(800 - 302, 600 - 95);
-    }
-}
-
-void
-GameSession::draw()
-{
-  //std::cout &lt;&lt; gluErrorString(glGetError()) &lt;&lt; std::endl;
-
-  draw_game();
-  console.draw();
-
-  switch (state)
-    {
-    case FADEOUT:
-      CL_Display::fill_rect(CL_Rect(0, 0, 
-                                    CL_Display::get_width(), CL_Display::get_height()),
-                            CL_Color(0,0,0, std::min(int(fadeout_value*255), 255)));
-      break;
-    case FADEIN:
-      CL_Display::fill_rect(CL_Rect(0, 0, 
-                                    CL_Display::get_width(), CL_Display::get_height()),
-                            CL_Color(0,0,0, 255-std::min(int(fadeout_value*255), 255)));
-      break;
-
-    default:
-      break;
-    }
-
-  if (player-&gt;get_movement_state() == Player::DEAD)
-    {
-      CL_Font font = Fonts::dialog;
-      font.set_alignment(origin_bottom_center);
-      font.draw(CL_Display::get_width()/2, 200,
-                &quot;..:: Press Fire to restart ::..&quot;);
-    }
-
-  if (!main_app.screenshot_dir.empty())
-    {
-      std::stringstream filename;
-      filename &lt;&lt; main_app.screenshot_dir;
-      filename.width(8);
-      filename.fill('0');
-      filename &lt;&lt; frames;
-      filename &lt;&lt; &quot;.png&quot;;
-      CL_ProviderFactory::save(CL_Display::get_front_buffer(), filename.str());
-    }
-}
-
-void
-GameSession::update(float delta)
-{
-  console.update(delta);
-
-  InputManager::update(delta);
-  delta *= game_speed;
-
-  game_time += delta;
-  script_manager-&gt;update();
-
-  view-&gt;update(delta);
-
-  switch (state)
-    {
-    case FADEIN:
-      if (fadeout_value &gt; 1.0f)
-        state = RUNNING;
-      fadeout_value += delta;
-      break;
-    case FADEOUT:
-      if (fadeout_value &gt; 1.0f)
-        Screen::quit();
-
-      fadeout_value += delta;
-      break;
-
-    case RUNNING:
-      switch (control_state) 
-        {
-        case DIALOG:
-          dialog_manager-&gt;update(delta);
-          break;
-        case GAME:
-          world-&gt;update (delta);
-          energiebar-&gt;update(delta);
-          break;
-        }
-      break;
-    }
-  
-  if (CL_Keyboard::get_keycode(CL_KEY_ESCAPE))
-    quit();
-  
-  InputManager::clear();
-
-  blink += delta * 3.141f;
-}
-
-void
-GameSession::set_sector (const std::string&amp; arg_filename)
-{
-  if (world)
-    delete world;
-
-  filename = arg_filename;
-  world = new Sector(filename);
-
-  state = FADEIN;
-  fadeout_value = 0;
-
-  control_state = GAME;
-}
-
-void
-GameSession::on_startup ()
-{ 
-  slots.push_back(CL_Keyboard::sig_key_down().connect(this, &amp;GameSession::on_key_down));
-  slots.push_back(CL_Mouse::sig_key_down().connect(this, &amp;GameSession::on_mouse_down));
-
-  blink = 0.0f;
-
-  GameObject::set_world (world);
-
-  player = new Player();
-  view   = new View();
-  
-  energiebar = new Energiebar();
-  dialog_manager = new DialogManager();
-
-  world-&gt;add(player);
-
-  logo       = CL_Sprite(&quot;logo&quot;, resources);
-  logo_black = CL_Sprite(&quot;logo_black&quot;, resources);
-
-  if (1)
-    {
-      world-&gt;add(new Door(24, 6));
-      world-&gt;add(new Door(32, 14));
-      world-&gt;add(new Door(8, 22));
-
-      CL_Surface surface1(&quot;particles/smoke&quot;, resources);
-      CL_Surface surface2(&quot;particles/smoke2&quot;, resources);
-
-      ParticleSystem* psystem2 = new ParticleSystem();
-      psystem2-&gt;set_drawer(new SparkDrawer());
-      psystem2-&gt;set_pos(0,0);
-      psystem2-&gt;set_speed(300, 550);
-      psystem2-&gt;set_cone(-25-90, 25-90);
-      psystem2-&gt;set_gravity(0, 5);
-      psystem2-&gt;set_line_distribution(-50, 0, 50, 0);
-
-      ParticleSystem* psystem3 = new ParticleSystem();
-      psystem3-&gt;set_lifetime(8);
-      psystem3-&gt;set_count(30);
-      surface2.set_blend_func(blend_src_alpha, blend_one_minus_src_alpha);
-      surface2.set_alignment(origin_center);
-      psystem3-&gt;set_drawer(new SurfaceDrawer(surface2));
-      psystem3-&gt;set_pos(0,0);
-      psystem3-&gt;set_speed(70, 100);
-      psystem3-&gt;set_cone(-25-90, 25-90);
-      psystem3-&gt;set_gravity(0, -1);
-      psystem3-&gt;set_size(1.0f, 3.0f);
-      psystem3-&gt;set_line_distribution(-50, 0, 50, 0);
- 
-      ParticleSystem* psystem = new ParticleSystem();
-      psystem-&gt;set_count(100);
-      surface1.set_blend_func(blend_src_alpha, blend_one);
-      surface1.set_alignment(origin_center);
-      psystem-&gt;set_drawer(new SurfaceDrawer(surface1));
-      psystem-&gt;set_pos(0,0);
-      psystem-&gt;set_speed(200, 300);
-      psystem-&gt;set_cone(-5-90, 5-90);
-      psystem-&gt;set_gravity(0, 0);
-      psystem-&gt;set_line_distribution(-50, 0, 50, 0);
-
-      psystem-&gt;set_spawn_point (768, 832);
-      psystem2-&gt;set_spawn_point(768, 832);
-      psystem3-&gt;set_spawn_point(768, 832);
-      
-      world-&gt;add(psystem3);
-      world-&gt;add(psystem2);
-      world-&gt;add(psystem);
-    }
-  
-  world-&gt;add(new Sprite3D(&quot;3dsprites/3dsprites&quot;));
-
-  world-&gt;activate();
-}
-
-void
-GameSession::on_shutdown ()
-{
-  delete energiebar;
-  delete view;
-  delete dialog_manager;
-}
-
-void
-GameSession::quit()
-{
-  if (state != FADEOUT)
-    {
-      fadeout_value = 0;
-      sound_manager-&gt;stop_music();
-      state = FADEOUT;
-    }
-}
-
-void
-GameSession::on_mouse_down(const CL_InputEvent&amp; event)
-{
-  switch(event.id)
-    {
-    case CL_MOUSE_LEFT:
-      console.add(&quot;Click at: &quot;, CL_Point(view-&gt;screen2world(event.mouse_pos)));
-      break;
-    default:
-      break;
-    }
-}
-
-void
-GameSession::on_key_down(const CL_InputEvent&amp; event)
-{
-  if (!console.is_active())
-    {
-      switch(event.id)
-        {
-        case CL_KEY_F1:
-          console.activate();
-          break;
-
-        case CL_KEY_1:
-          sc.set_render_mask(sc.get_render_mask() ^ SceneContext::COLORMAP);
-          console.add(&quot;Toggled COLORMAP: &quot;, (sc.get_render_mask() &amp; SceneContext::COLORMAP) &gt; 0);
-          break;
-
-        case CL_KEY_2:
-          sc.set_render_mask(sc.get_render_mask() ^ SceneContext::LIGHTMAP);
-          console.add(&quot;Toggled LIGHTMAP: &quot;, (sc.get_render_mask() &amp; SceneContext::LIGHTMAP) &gt; 0);
-          break;
-
-        case CL_KEY_3:
-          sc.set_render_mask(sc.get_render_mask() ^ SceneContext::HIGHLIGHTMAP);
-          console.add(&quot;Toggled HIGHLIGHTMAP: &quot;, (sc.get_render_mask() &amp; SceneContext::HIGHLIGHTMAP) &gt; 0);
-          break;      
-
-        default:
-          // ignore key
-          //console.add(&quot;Key pressed:: &quot;, event.id);
-          break;
-        }
-    }
-}
-
-void
-GameSession::execute(const std::string&amp; str_)
-{
-  std::string str = str_; //&quot;return (&quot; + str_ + &quot;)&quot;;
-
-  int i = str.length();
-  const char* buffer = str.c_str();
-
-  HSQUIRRELVM vm = script_manager-&gt;get_vm();
-  int oldtop=sq_gettop(vm); 
-  try {
-    int retval = 0;
-
-    if(i&gt;0){
-      if(SQ_SUCCEEDED(sq_compilebuffer(vm,buffer,i,_SC(&quot;interactive console&quot;),SQTrue))){
-        sq_pushroottable(vm);
-        if(SQ_SUCCEEDED(sq_call(vm,1, retval))) {
-          scprintf(_SC(&quot;\n&quot;));
-          sq_pushroottable(vm);
-          sq_pushstring(vm,_SC(&quot;print&quot;),-1);
-          sq_get(vm,-2);
-          sq_pushroottable(vm);
-          sq_push(vm,-4);
-          sq_call(vm,2,SQFalse);
-          scprintf(_SC(&quot;\n&quot;));
-        }
-      }
-    }
-  } catch(std::exception&amp; e) {
-    std::cerr &lt;&lt; &quot;Couldn't execute command '&quot; &lt;&lt; str_ &lt;&lt; &quot;': &quot;
-      &lt;&lt; e.what() &lt;&lt; &quot;\n&quot;;
-  }
-  sq_settop(vm,oldtop);
-}
-
-/* EOF */

Copied: trunk/src/game_session.hpp (from rev 502, trunk/src/game_session.hxx)
===================================================================
--- trunk/src/game_session.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/game_session.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,95 @@
+//  $Id: windstille_game.hpp,v 1.9 2003/11/04 22:48:51 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef GAME_SESSION_HXX
+#define GAME_SESSION_HXX
+
+#include &lt;string&gt;
+#include &lt;ClanLib/Display/sprite.h&gt;
+#include &lt;ClanLib/Display/font.h&gt;
+#include &lt;ClanLib/Signals/slot_container.h&gt;
+#include &quot;display/scene_context.hpp&quot;
+#include &quot;console.hpp&quot;
+#include &quot;squirrel/include/squirrel.h&quot;
+#include &quot;screen.hpp&quot;
+
+class CL_InputEvent;
+
+class Energiebar;
+class View;
+class Sector;
+class Player;
+class DialogManager;
+
+class GameSession : public Windstille::Screen
+{
+private:
+  SceneContext sc;
+  Console console;
+  Player* player;
+
+  float blink;
+  float fadeout_value;
+
+  CL_Sprite control_dialog;
+
+  std::string filename;
+  Sector* world;
+  View* view;
+  Energiebar* energiebar;
+  DialogManager* dialog_manager;
+
+  enum { FADEIN, RUNNING, FADEOUT } state;
+  enum { DIALOG, GAME } control_state;
+
+  CL_Font font;
+  CL_Sprite logo;
+  CL_Sprite logo_black;
+
+  std::vector&lt;CL_Slot&gt; slots;
+  void on_key_down  (const CL_InputEvent&amp; event);
+  void on_mouse_down  (const CL_InputEvent&amp; event);
+
+  static GameSession* current_; 
+public:
+  static GameSession* current() { return current_; } 
+
+  GameSession (const std::string&amp; arg_filename);
+  ~GameSession ();
+
+  void set_dialog_state() { control_state = DIALOG; }
+  void set_game_state()   { control_state = GAME; }
+  void set_sector (const std::string&amp; arg_filename);
+
+  void on_startup();
+  void on_shutdown();
+
+  void draw();
+  void draw_game();
+  void update(float delta);
+
+  /** execute the given string in the scripting environment */
+  void execute(const std::string&amp; str);
+
+  void quit();
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/game_session.hxx
===================================================================
--- trunk/src/game_session.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/game_session.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,95 +0,0 @@
-//  $Id: windstille_game.hxx,v 1.9 2003/11/04 22:48:51 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef GAME_SESSION_HXX
-#define GAME_SESSION_HXX
-
-#include &lt;string&gt;
-#include &lt;ClanLib/Display/sprite.h&gt;
-#include &lt;ClanLib/Display/font.h&gt;
-#include &lt;ClanLib/Signals/slot_container.h&gt;
-#include &quot;display/scene_context.hxx&quot;
-#include &quot;console.hxx&quot;
-#include &quot;squirrel/include/squirrel.h&quot;
-#include &quot;screen.hxx&quot;
-
-class CL_InputEvent;
-
-class Energiebar;
-class View;
-class Sector;
-class Player;
-class DialogManager;
-
-class GameSession : public Windstille::Screen
-{
-private:
-  SceneContext sc;
-  Console console;
-  Player* player;
-
-  float blink;
-  float fadeout_value;
-
-  CL_Sprite control_dialog;
-
-  std::string filename;
-  Sector* world;
-  View* view;
-  Energiebar* energiebar;
-  DialogManager* dialog_manager;
-
-  enum { FADEIN, RUNNING, FADEOUT } state;
-  enum { DIALOG, GAME } control_state;
-
-  CL_Font font;
-  CL_Sprite logo;
-  CL_Sprite logo_black;
-
-  std::vector&lt;CL_Slot&gt; slots;
-  void on_key_down  (const CL_InputEvent&amp; event);
-  void on_mouse_down  (const CL_InputEvent&amp; event);
-
-  static GameSession* current_; 
-public:
-  static GameSession* current() { return current_; } 
-
-  GameSession (const std::string&amp; arg_filename);
-  ~GameSession ();
-
-  void set_dialog_state() { control_state = DIALOG; }
-  void set_game_state()   { control_state = GAME; }
-  void set_sector (const std::string&amp; arg_filename);
-
-  void on_startup();
-  void on_shutdown();
-
-  void draw();
-  void draw_game();
-  void update(float delta);
-
-  /** execute the given string in the scripting environment */
-  void execute(const std::string&amp; str);
-
-  void quit();
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/globals.cpp (from rev 502, trunk/src/globals.cxx)
===================================================================
--- trunk/src/globals.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/globals.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,35 @@
+//  $Id: globals.cxx,v 1.6 2003/11/07 22:41:18 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;globals.hpp&quot;
+
+std::string datadir;
+std::string bindir;
+std::string homedir;
+
+int TILE_SIZE    = 32;
+int SUBTILE_SIZE = 32;
+int SUBTILE_NUM  = (TILE_SIZE/SUBTILE_SIZE);
+
+bool bonus_active = true;
+float game_speed = 1.0f;
+int debug = 1;
+bool sound_disabled = false;
+
+/* EOF */

Deleted: trunk/src/globals.cxx
===================================================================
--- trunk/src/globals.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/globals.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,35 +0,0 @@
-//  $Id: globals.cxx,v 1.6 2003/11/07 22:41:18 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;globals.hxx&quot;
-
-std::string datadir;
-std::string bindir;
-std::string homedir;
-
-int TILE_SIZE    = 32;
-int SUBTILE_SIZE = 32;
-int SUBTILE_NUM  = (TILE_SIZE/SUBTILE_SIZE);
-
-bool bonus_active = true;
-float game_speed = 1.0f;
-int debug = 1;
-bool sound_disabled = false;
-
-/* EOF */

Copied: trunk/src/globals.hpp (from rev 502, trunk/src/globals.hxx)
===================================================================
--- trunk/src/globals.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/globals.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,49 @@
+//  $Id: globals.hpp,v 1.11 2003/11/07 13:00:39 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef GLOBALS_HXX
+#define GLOBALS_HXX
+
+#include &lt;string&gt;
+#include &lt;ClanLib/Core/Resources/resource_manager.h&gt;
+
+typedef enum { WEST, EAST} Direction;
+
+extern int TILE_SIZE;
+
+/** datadir =&gt; /usr/local/share/games/windstille/ */
+extern std::string datadir;
+
+/** bindir =&gt; /usr/local/games/ */
+extern std::string bindir;
+
+/** homedir =&gt; /home/juser/.windstille/ */
+extern std::string homedir;
+
+extern CL_ResourceManager* resources;
+
+extern bool bonus_active;
+extern float game_speed;
+extern bool sound_disabled;
+
+extern int debug;
+
+#endif
+
+/* EOF */

Deleted: trunk/src/globals.hxx
===================================================================
--- trunk/src/globals.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/globals.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,49 +0,0 @@
-//  $Id: globals.hxx,v 1.11 2003/11/07 13:00:39 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef GLOBALS_HXX
-#define GLOBALS_HXX
-
-#include &lt;string&gt;
-#include &lt;ClanLib/Core/Resources/resource_manager.h&gt;
-
-typedef enum { WEST, EAST} Direction;
-
-extern int TILE_SIZE;
-
-/** datadir =&gt; /usr/local/share/games/windstille/ */
-extern std::string datadir;
-
-/** bindir =&gt; /usr/local/games/ */
-extern std::string bindir;
-
-/** homedir =&gt; /home/juser/.windstille/ */
-extern std::string homedir;
-
-extern CL_ResourceManager* resources;
-
-extern bool bonus_active;
-extern float game_speed;
-extern bool sound_disabled;
-
-extern int debug;
-
-#endif
-
-/* EOF */

Copied: trunk/src/graphic_context_state.cpp (from rev 502, trunk/src/graphic_context_state.cxx)
===================================================================
--- trunk/src/graphic_context_state.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/graphic_context_state.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,222 @@
+//  $Id$
+//
+//  Flexlay - A Generic 2D Game Editor
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ClanLib/Display/display.h&gt;
+#include &lt;ClanLib/Display/display_window.h&gt;
+#include &lt;ClanLib/Display/graphic_context.h&gt;
+#include &lt;ClanLib/GUI/component.h&gt;
+#include &lt;math.h&gt;
+#include &quot;display/scene_context.hpp&quot;
+#include &quot;graphic_context_state.hpp&quot;
+
+class GraphicContextStateImpl
+{
+public:
+  int width;
+  int height;
+  
+  CL_Pointf offset;
+  float zoom;
+  float rotation;
+};
+
+GraphicContextState::GraphicContextState()
+  : impl(new GraphicContextStateImpl())
+{
+  impl-&gt;width  = 1;
+  impl-&gt;height = 1; 
+  impl-&gt;offset = CL_Pointf(0,0);
+  impl-&gt;zoom   = 1.0f;
+  impl-&gt;rotation = 0;
+}
+
+GraphicContextState::GraphicContextState(int w, int h)
+  : impl(new GraphicContextStateImpl())
+{  
+  impl-&gt;width  = w;
+  impl-&gt;height = h;
+  impl-&gt;offset = CL_Pointf(0,0); 
+  impl-&gt;zoom   = 1.0f;
+  impl-&gt;rotation = 0;
+}
+
+void
+GraphicContextState::set_size(int w, int h)
+{
+  impl-&gt;width  = w;
+  impl-&gt;height = h;
+}
+
+void
+GraphicContextState::push(SceneContext&amp; sc)
+{
+  sc.push_modelview();
+
+  sc.translate(impl-&gt;width/2, impl-&gt;height/2);
+  sc.rotate(impl-&gt;rotation);
+  sc.translate(-impl-&gt;width/2, -impl-&gt;height/2);
+
+  sc.scale(get_zoom(), get_zoom());
+  sc.translate(impl-&gt;offset.x, impl-&gt;offset.y);
+}
+
+void
+GraphicContextState::pop(SceneContext&amp; sc)
+{
+  sc.pop_modelview();
+}
+
+void
+GraphicContextState::push(CL_GraphicContext* gc)
+{
+  if (gc == 0)
+    gc = CL_Display::get_current_window()-&gt;get_gc();
+  
+  gc-&gt;push_modelview();
+
+  gc-&gt;add_translate(impl-&gt;width/2, impl-&gt;height/2);
+  gc-&gt;add_rotate(impl-&gt;rotation, 0, 0, 1.0);
+  gc-&gt;add_translate(-impl-&gt;width/2, -impl-&gt;height/2);
+
+  gc-&gt;add_scale(get_zoom(), get_zoom());
+  gc-&gt;add_translate(impl-&gt;offset.x, impl-&gt;offset.y);
+}
+
+void
+GraphicContextState::pop(CL_GraphicContext* gc)
+{
+  if (gc == 0)
+    gc = CL_Display::get_current_window()-&gt;get_gc();
+  
+  gc-&gt;pop_modelview();
+}
+
+CL_Rectf
+GraphicContextState::get_clip_rect()
+{
+  return CL_Rectf(CL_Pointf(-impl-&gt;offset.x,
+                            -impl-&gt;offset.y),
+                  CL_Sizef(get_width()  / impl-&gt;zoom,
+                           get_height() / impl-&gt;zoom));
+}
+
+void
+GraphicContextState::set_pos(const CL_Pointf&amp; pos)
+{
+  impl-&gt;offset.x = -pos.x + (get_width()/2  / impl-&gt;zoom);
+  impl-&gt;offset.y = -pos.y + (get_height()/2 / impl-&gt;zoom);
+}
+
+CL_Pointf
+GraphicContextState::get_pos() const
+{
+  return CL_Pointf(-impl-&gt;offset.x + (get_width()/2  / impl-&gt;zoom),
+                   -impl-&gt;offset.y + (get_height()/2  / impl-&gt;zoom));
+}
+
+void
+GraphicContextState::set_zoom(CL_Pointf pos, float z)
+{
+  float old_zoom = impl-&gt;zoom;
+  set_zoom(z);
+  impl-&gt;offset.x = pos.x/impl-&gt;zoom - pos.x/old_zoom + impl-&gt;offset.x;
+  impl-&gt;offset.y = pos.y/impl-&gt;zoom - pos.y/old_zoom + impl-&gt;offset.y;
+}
+
+void
+GraphicContextState::set_zoom(float z)
+{
+  impl-&gt;zoom = z;
+}
+
+float
+GraphicContextState::get_zoom()
+{
+  return impl-&gt;zoom;
+}
+
+void
+GraphicContextState::zoom_to (const CL_Rectf&amp; rect)
+{
+  float center_x = (rect.left + rect.right) / 2.0f;
+  float center_y = (rect.top + rect.bottom) / 2.0f;
+
+  float width  = rect.right - rect.left;
+  float height = rect.bottom - rect.top;
+  float screen_relation = float(get_height())/float(get_width ());
+  float rect_relation   = height/width; 
+  
+  //std::cout &lt;&lt; &quot;Screen: &quot; &lt;&lt; screen_relation &lt;&lt; &quot; Zoom: &quot; &lt;&lt; rect_relation &lt;&lt; std::endl;
+  if (rect_relation &lt; screen_relation) // take width, ignore height
+    {
+      impl-&gt;zoom = get_width()/width; 
+    }
+  else // take height, ignore width
+    {
+      impl-&gt;zoom = get_height()/height;
+    }
+
+  impl-&gt;offset.x = (get_width()  / (2*impl-&gt;zoom)) - center_x;
+  impl-&gt;offset.y = (get_height() / (2*impl-&gt;zoom)) - center_y;
+}
+
+CL_Pointf
+GraphicContextState::screen2world(const CL_Point&amp; pos_)
+{
+  CL_Pointf pos = pos_;
+  float sa = sin(-impl-&gt;rotation/180.0f*M_PI);
+  float ca = cos(-impl-&gt;rotation/180.0f*M_PI);
+
+  float dx = pos.x - impl-&gt;width/2;
+  float dy = pos.y - impl-&gt;height/2;
+
+  pos.x = impl-&gt;width/2  + (ca * dx - sa * dy);
+  pos.y = impl-&gt;height/2 + (sa * dx + ca * dy);
+
+  CL_Pointf p((float(pos.x) / impl-&gt;zoom) - impl-&gt;offset.x, 
+              (float(pos.y) / impl-&gt;zoom) - impl-&gt;offset.y);
+
+  return p;
+}
+
+void
+GraphicContextState::set_rotation(float angle)
+{
+  impl-&gt;rotation = angle;
+}
+
+float
+GraphicContextState::get_rotation()
+{
+  return impl-&gt;rotation;
+}
+
+int
+GraphicContextState::get_width()  const 
+{
+  return impl-&gt;width; 
+}
+
+int
+GraphicContextState::get_height() const 
+{ 
+  return impl-&gt;height; 
+}
+
+/* EOF */

Deleted: trunk/src/graphic_context_state.cxx
===================================================================
--- trunk/src/graphic_context_state.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/graphic_context_state.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,222 +0,0 @@
-//  $Id$
-//
-//  Flexlay - A Generic 2D Game Editor
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ClanLib/Display/display.h&gt;
-#include &lt;ClanLib/Display/display_window.h&gt;
-#include &lt;ClanLib/Display/graphic_context.h&gt;
-#include &lt;ClanLib/GUI/component.h&gt;
-#include &lt;math.h&gt;
-#include &quot;display/scene_context.hxx&quot;
-#include &quot;graphic_context_state.hxx&quot;
-
-class GraphicContextStateImpl
-{
-public:
-  int width;
-  int height;
-  
-  CL_Pointf offset;
-  float zoom;
-  float rotation;
-};
-
-GraphicContextState::GraphicContextState()
-  : impl(new GraphicContextStateImpl())
-{
-  impl-&gt;width  = 1;
-  impl-&gt;height = 1; 
-  impl-&gt;offset = CL_Pointf(0,0);
-  impl-&gt;zoom   = 1.0f;
-  impl-&gt;rotation = 0;
-}
-
-GraphicContextState::GraphicContextState(int w, int h)
-  : impl(new GraphicContextStateImpl())
-{  
-  impl-&gt;width  = w;
-  impl-&gt;height = h;
-  impl-&gt;offset = CL_Pointf(0,0); 
-  impl-&gt;zoom   = 1.0f;
-  impl-&gt;rotation = 0;
-}
-
-void
-GraphicContextState::set_size(int w, int h)
-{
-  impl-&gt;width  = w;
-  impl-&gt;height = h;
-}
-
-void
-GraphicContextState::push(SceneContext&amp; sc)
-{
-  sc.push_modelview();
-
-  sc.translate(impl-&gt;width/2, impl-&gt;height/2);
-  sc.rotate(impl-&gt;rotation);
-  sc.translate(-impl-&gt;width/2, -impl-&gt;height/2);
-
-  sc.scale(get_zoom(), get_zoom());
-  sc.translate(impl-&gt;offset.x, impl-&gt;offset.y);
-}
-
-void
-GraphicContextState::pop(SceneContext&amp; sc)
-{
-  sc.pop_modelview();
-}
-
-void
-GraphicContextState::push(CL_GraphicContext* gc)
-{
-  if (gc == 0)
-    gc = CL_Display::get_current_window()-&gt;get_gc();
-  
-  gc-&gt;push_modelview();
-
-  gc-&gt;add_translate(impl-&gt;width/2, impl-&gt;height/2);
-  gc-&gt;add_rotate(impl-&gt;rotation, 0, 0, 1.0);
-  gc-&gt;add_translate(-impl-&gt;width/2, -impl-&gt;height/2);
-
-  gc-&gt;add_scale(get_zoom(), get_zoom());
-  gc-&gt;add_translate(impl-&gt;offset.x, impl-&gt;offset.y);
-}
-
-void
-GraphicContextState::pop(CL_GraphicContext* gc)
-{
-  if (gc == 0)
-    gc = CL_Display::get_current_window()-&gt;get_gc();
-  
-  gc-&gt;pop_modelview();
-}
-
-CL_Rectf
-GraphicContextState::get_clip_rect()
-{
-  return CL_Rectf(CL_Pointf(-impl-&gt;offset.x,
-                            -impl-&gt;offset.y),
-                  CL_Sizef(get_width()  / impl-&gt;zoom,
-                           get_height() / impl-&gt;zoom));
-}
-
-void
-GraphicContextState::set_pos(const CL_Pointf&amp; pos)
-{
-  impl-&gt;offset.x = -pos.x + (get_width()/2  / impl-&gt;zoom);
-  impl-&gt;offset.y = -pos.y + (get_height()/2 / impl-&gt;zoom);
-}
-
-CL_Pointf
-GraphicContextState::get_pos() const
-{
-  return CL_Pointf(-impl-&gt;offset.x + (get_width()/2  / impl-&gt;zoom),
-                   -impl-&gt;offset.y + (get_height()/2  / impl-&gt;zoom));
-}
-
-void
-GraphicContextState::set_zoom(CL_Pointf pos, float z)
-{
-  float old_zoom = impl-&gt;zoom;
-  set_zoom(z);
-  impl-&gt;offset.x = pos.x/impl-&gt;zoom - pos.x/old_zoom + impl-&gt;offset.x;
-  impl-&gt;offset.y = pos.y/impl-&gt;zoom - pos.y/old_zoom + impl-&gt;offset.y;
-}
-
-void
-GraphicContextState::set_zoom(float z)
-{
-  impl-&gt;zoom = z;
-}
-
-float
-GraphicContextState::get_zoom()
-{
-  return impl-&gt;zoom;
-}
-
-void
-GraphicContextState::zoom_to (const CL_Rectf&amp; rect)
-{
-  float center_x = (rect.left + rect.right) / 2.0f;
-  float center_y = (rect.top + rect.bottom) / 2.0f;
-
-  float width  = rect.right - rect.left;
-  float height = rect.bottom - rect.top;
-  float screen_relation = float(get_height())/float(get_width ());
-  float rect_relation   = height/width; 
-  
-  //std::cout &lt;&lt; &quot;Screen: &quot; &lt;&lt; screen_relation &lt;&lt; &quot; Zoom: &quot; &lt;&lt; rect_relation &lt;&lt; std::endl;
-  if (rect_relation &lt; screen_relation) // take width, ignore height
-    {
-      impl-&gt;zoom = get_width()/width; 
-    }
-  else // take height, ignore width
-    {
-      impl-&gt;zoom = get_height()/height;
-    }
-
-  impl-&gt;offset.x = (get_width()  / (2*impl-&gt;zoom)) - center_x;
-  impl-&gt;offset.y = (get_height() / (2*impl-&gt;zoom)) - center_y;
-}
-
-CL_Pointf
-GraphicContextState::screen2world(const CL_Point&amp; pos_)
-{
-  CL_Pointf pos = pos_;
-  float sa = sin(-impl-&gt;rotation/180.0f*M_PI);
-  float ca = cos(-impl-&gt;rotation/180.0f*M_PI);
-
-  float dx = pos.x - impl-&gt;width/2;
-  float dy = pos.y - impl-&gt;height/2;
-
-  pos.x = impl-&gt;width/2  + (ca * dx - sa * dy);
-  pos.y = impl-&gt;height/2 + (sa * dx + ca * dy);
-
-  CL_Pointf p((float(pos.x) / impl-&gt;zoom) - impl-&gt;offset.x, 
-              (float(pos.y) / impl-&gt;zoom) - impl-&gt;offset.y);
-
-  return p;
-}
-
-void
-GraphicContextState::set_rotation(float angle)
-{
-  impl-&gt;rotation = angle;
-}
-
-float
-GraphicContextState::get_rotation()
-{
-  return impl-&gt;rotation;
-}
-
-int
-GraphicContextState::get_width()  const 
-{
-  return impl-&gt;width; 
-}
-
-int
-GraphicContextState::get_height() const 
-{ 
-  return impl-&gt;height; 
-}
-
-/* EOF */

Copied: trunk/src/graphic_context_state.hpp (from rev 502, trunk/src/graphic_context_state.hxx)

Deleted: trunk/src/graphic_context_state.hxx
===================================================================
--- trunk/src/graphic_context_state.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/graphic_context_state.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,83 +0,0 @@
-//  $Id$
-// 
-//  Flexlay - A Generic 2D Game Editor
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_GRAPHIC_CONTEXT_STATE_HXX
-#define HEADER_GRAPHIC_CONTEXT_STATE_HXX
-
-#include &lt;ClanLib/Core/Math/point.h&gt;
-#include &lt;ClanLib/Core/Math/rect.h&gt;
-#include &lt;ClanLib/Core/System/sharedptr.h&gt;
-
-class SceneContext;
-class CL_GraphicContext;
-
-class GraphicContextStateImpl;
-
-/** Helper class for capturing the state of a GraphicContext, with
-    additional convenience functions to make handling GraphicContexts
-    easier */
-class GraphicContextState
-{
-public:
-  GraphicContextState();
-  GraphicContextState(int w, int h);
-
-  void set_size(int w, int h);
-
-  void push(CL_GraphicContext* gc = 0);
-  void pop (CL_GraphicContext* gc = 0);
-
-  void push(SceneContext&amp; sc);
-  void pop(SceneContext&amp; sc);
-
-  /** Return a rectangle in world coordinates that represents the area
-      visible on the screen */
-  CL_Rectf get_clip_rect();
-
-  int get_width()  const;
-  int get_height() const;
-
-  /** Set the current rotation angel */
-  void  set_rotation(float angle);
-
-  /** Return the current rotation angel */
-  float get_rotation();
-
-  /** Move the center of the visible area to pos */
-  void      set_pos(const CL_Pointf&amp; pos);
-  CL_Pointf get_pos() const;
-
-  /** Set zoom to z, while ensuring that the screen position \a pos
-      (normaly the position of the mouse pointer) stays in the same
-      position even after zoomed in/out */
-  void  set_zoom(CL_Pointf pos, float z);
-  void  set_zoom(float z);
-  float get_zoom(); 
-
-  void zoom_to (const CL_Rectf&amp; rect);
-
-  CL_Pointf screen2world(const CL_Point&amp; pos);
-
-private:
-  CL_SharedPtr&lt;GraphicContextStateImpl&gt; impl;
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/igel.cpp (from rev 502, trunk/src/igel.cxx)
===================================================================
--- trunk/src/igel.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/igel.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,145 @@
+//  $Id: igel.cxx,v 1.4 2003/11/05 12:41:37 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;globals.hpp&quot;
+#include &quot;player.hpp&quot;
+#include &quot;sector.hpp&quot;
+#include &quot;tile_map.hpp&quot;
+#include &quot;igel.hpp&quot;
+
+Igel::Igel(int x, int y)
+  : sprite(&quot;igel&quot;, resources),
+    die_sprite(&quot;igel_die&quot;, resources),
+    light(&quot;igel_light&quot;, resources),
+    highlight(&quot;igel_highlight&quot;, resources),
+    pos(x, y)
+{
+  direction_left = false;
+  state = WALKING;
+  light.set_blend_func(blend_src_alpha, blend_one);
+  highlight.set_blend_func(blend_src_alpha, blend_one);
+}
+
+Igel::~Igel()
+{
+}
+
+void
+Igel::draw(SceneContext&amp; gc)
+{
+  CL_Sprite* s;
+
+  if (state == DIEING)
+    s = &amp;die_sprite;
+  else
+    s = &sprite;
+
+  if (direction_left)
+    s-&gt;set_scale(1.0f, 1.0f);
+  else
+    s-&gt;set_scale(-1.0f, 1.0f);
+
+  s-&gt;draw(int(pos.x), int(pos.y));
+  gc.light().draw(light, pos.x, pos.y, 0);
+  gc.highlight().draw(highlight, pos.x, pos.y, 0);
+}
+
+void
+Igel::update(float delta)
+{
+  if (state == DIEING)
+    {
+      if (die_sprite.is_finished())
+        remove();
+      die_sprite.update(delta);
+    }
+  else
+    {
+      sprite.update(delta);
+      
+      CL_Pointf old_pos = pos;
+      
+      if (on_ground())
+        {
+          pos.y = int(pos.y)/TILE_SIZE * TILE_SIZE;
+          
+          if (direction_left)
+            pos.x -= 32 * delta;
+          else
+            pos.x += 32 * delta;      
+          
+          if (!on_ground() || in_wall())
+            {
+              direction_left = !direction_left;
+              pos = old_pos;
+            }
+        }
+      else
+        { // Fall
+          pos.y += 450 * delta;
+        }
+
+      // Check if the player got hit
+      // FIXME: Insert pixel perfect collision detection here
+      CL_Vector player_pos = Player::current()-&gt;get_pos();
+      if (pos.x - 20 &lt; player_pos.x
+          &amp;&amp; pos.x + 20 &gt; player_pos.x
+          &amp;&amp; pos.y - 20 &lt; player_pos.y
+          &amp;&amp; pos.y + 5  &gt; player_pos.y)
+        Player::current()-&gt;hit(5);
+    }
+}
+
+bool
+Igel::in_wall()
+{
+  return Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE)*TILE_SIZE,
+                                                        (int(pos.y)/TILE_SIZE - 1)*TILE_SIZE)
+    || Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE - 1)*TILE_SIZE,
+                                                        (int(pos.y)/TILE_SIZE - 1)*TILE_SIZE)
+    || Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE - 2)*TILE_SIZE,
+                                                        (int(pos.y)/TILE_SIZE - 1)*TILE_SIZE)
+    || Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE + 1)*TILE_SIZE,
+                                                        (int(pos.y)/TILE_SIZE - 1)*TILE_SIZE)
+    || Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE + 2)*TILE_SIZE,
+                                                      (int(pos.y)/TILE_SIZE - 1)*TILE_SIZE);
+}
+
+bool
+Igel::on_ground()
+{
+  return Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE)*TILE_SIZE,
+                                                        (int(pos.y)/TILE_SIZE)*TILE_SIZE)
+    &amp;&amp; Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE+1)*TILE_SIZE,
+                                                      (int(pos.y)/TILE_SIZE)*TILE_SIZE)
+    &amp;&amp; Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE+2)*TILE_SIZE,
+                                                      (int(pos.y)/TILE_SIZE)*TILE_SIZE)
+    &amp;&amp; Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE - 1)*TILE_SIZE,
+                                                      (int(pos.y)/TILE_SIZE)*TILE_SIZE)
+    &amp;&amp; Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE - 2)*TILE_SIZE,
+                                                      (int(pos.y)/TILE_SIZE)*TILE_SIZE);
+}
+
+void
+Igel::die()
+{
+  state = DIEING;
+}
+
+/* EOF */

Deleted: trunk/src/igel.cxx
===================================================================
--- trunk/src/igel.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/igel.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,145 +0,0 @@
-//  $Id: igel.cxx,v 1.4 2003/11/05 12:41:37 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;globals.hxx&quot;
-#include &quot;player.hxx&quot;
-#include &quot;sector.hxx&quot;
-#include &quot;tile_map.hxx&quot;
-#include &quot;igel.hxx&quot;
-
-Igel::Igel(int x, int y)
-  : sprite(&quot;igel&quot;, resources),
-    die_sprite(&quot;igel_die&quot;, resources),
-    light(&quot;igel_light&quot;, resources),
-    highlight(&quot;igel_highlight&quot;, resources),
-    pos(x, y)
-{
-  direction_left = false;
-  state = WALKING;
-  light.set_blend_func(blend_src_alpha, blend_one);
-  highlight.set_blend_func(blend_src_alpha, blend_one);
-}
-
-Igel::~Igel()
-{
-}
-
-void
-Igel::draw(SceneContext&amp; gc)
-{
-  CL_Sprite* s;
-
-  if (state == DIEING)
-    s = &amp;die_sprite;
-  else
-    s = &sprite;
-
-  if (direction_left)
-    s-&gt;set_scale(1.0f, 1.0f);
-  else
-    s-&gt;set_scale(-1.0f, 1.0f);
-
-  s-&gt;draw(int(pos.x), int(pos.y));
-  gc.light().draw(light, pos.x, pos.y, 0);
-  gc.highlight().draw(highlight, pos.x, pos.y, 0);
-}
-
-void
-Igel::update(float delta)
-{
-  if (state == DIEING)
-    {
-      if (die_sprite.is_finished())
-        remove();
-      die_sprite.update(delta);
-    }
-  else
-    {
-      sprite.update(delta);
-      
-      CL_Pointf old_pos = pos;
-      
-      if (on_ground())
-        {
-          pos.y = int(pos.y)/TILE_SIZE * TILE_SIZE;
-          
-          if (direction_left)
-            pos.x -= 32 * delta;
-          else
-            pos.x += 32 * delta;      
-          
-          if (!on_ground() || in_wall())
-            {
-              direction_left = !direction_left;
-              pos = old_pos;
-            }
-        }
-      else
-        { // Fall
-          pos.y += 450 * delta;
-        }
-
-      // Check if the player got hit
-      // FIXME: Insert pixel perfect collision detection here
-      CL_Vector player_pos = Player::current()-&gt;get_pos();
-      if (pos.x - 20 &lt; player_pos.x
-          &amp;&amp; pos.x + 20 &gt; player_pos.x
-          &amp;&amp; pos.y - 20 &lt; player_pos.y
-          &amp;&amp; pos.y + 5  &gt; player_pos.y)
-        Player::current()-&gt;hit(5);
-    }
-}
-
-bool
-Igel::in_wall()
-{
-  return Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE)*TILE_SIZE,
-                                                        (int(pos.y)/TILE_SIZE - 1)*TILE_SIZE)
-    || Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE - 1)*TILE_SIZE,
-                                                        (int(pos.y)/TILE_SIZE - 1)*TILE_SIZE)
-    || Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE - 2)*TILE_SIZE,
-                                                        (int(pos.y)/TILE_SIZE - 1)*TILE_SIZE)
-    || Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE + 1)*TILE_SIZE,
-                                                        (int(pos.y)/TILE_SIZE - 1)*TILE_SIZE)
-    || Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE + 2)*TILE_SIZE,
-                                                      (int(pos.y)/TILE_SIZE - 1)*TILE_SIZE);
-}
-
-bool
-Igel::on_ground()
-{
-  return Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE)*TILE_SIZE,
-                                                        (int(pos.y)/TILE_SIZE)*TILE_SIZE)
-    &amp;&amp; Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE+1)*TILE_SIZE,
-                                                      (int(pos.y)/TILE_SIZE)*TILE_SIZE)
-    &amp;&amp; Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE+2)*TILE_SIZE,
-                                                      (int(pos.y)/TILE_SIZE)*TILE_SIZE)
-    &amp;&amp; Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE - 1)*TILE_SIZE,
-                                                      (int(pos.y)/TILE_SIZE)*TILE_SIZE)
-    &amp;&amp; Sector::current()-&gt;get_tilemap()-&gt;is_ground((int(pos.x)/TILE_SIZE - 2)*TILE_SIZE,
-                                                      (int(pos.y)/TILE_SIZE)*TILE_SIZE);
-}
-
-void
-Igel::die()
-{
-  state = DIEING;
-}
-
-/* EOF */

Copied: trunk/src/igel.hpp (from rev 502, trunk/src/igel.hxx)
===================================================================
--- trunk/src/igel.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/igel.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,56 @@
+//  $Id: igel.hpp,v 1.4 2003/11/05 11:08:31 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_IGEL_HXX
+#define HEADER_IGEL_HXX
+
+#include &lt;ClanLib/Display/sprite.h&gt;
+#include &quot;game_object.hpp&quot;
+
+/** */
+class Igel : public GameObject
+{
+private:
+  CL_Sprite sprite;
+  CL_Sprite die_sprite;
+  CL_Sprite light;
+  CL_Sprite highlight;
+
+  CL_Pointf pos;
+  bool direction_left;
+  enum { WALKING, FALLING, DIEING } state;
+public:
+  Igel(int x, int y);
+  virtual ~Igel();
+
+  void draw(SceneContext&amp; gc);
+  void update(float delta);
+  void die();
+  CL_Pointf get_pos() { return pos; }
+private:
+  bool on_ground();
+  bool in_wall();
+
+  Igel (const Igel&amp;);
+  Igel&amp; operator= (const Igel&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/igel.hxx
===================================================================
--- trunk/src/igel.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/igel.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,56 +0,0 @@
-//  $Id: igel.hxx,v 1.4 2003/11/05 11:08:31 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_IGEL_HXX
-#define HEADER_IGEL_HXX
-
-#include &lt;ClanLib/Display/sprite.h&gt;
-#include &quot;game_object.hxx&quot;
-
-/** */
-class Igel : public GameObject
-{
-private:
-  CL_Sprite sprite;
-  CL_Sprite die_sprite;
-  CL_Sprite light;
-  CL_Sprite highlight;
-
-  CL_Pointf pos;
-  bool direction_left;
-  enum { WALKING, FALLING, DIEING } state;
-public:
-  Igel(int x, int y);
-  virtual ~Igel();
-
-  void draw(SceneContext&amp; gc);
-  void update(float delta);
-  void die();
-  CL_Pointf get_pos() { return pos; }
-private:
-  bool on_ground();
-  bool in_wall();
-
-  Igel (const Igel&amp;);
-  Igel&amp; operator= (const Igel&amp;);
-};
-
-#endif
-
-/* EOF */

Modified: trunk/src/input/Jamfile
===================================================================
--- trunk/src/input/Jamfile	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/Jamfile	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,38 +1,38 @@
 SubDir TOP src input ;
 
 sources =
-    axis_button.cxx                
-    axis_button.hxx
-    axis_factory.cxx
-    axis_factory.hxx
-    button_axis.cxx
-    button_axis.hxx
-    button_factory.cxx
-    button_factory.hxx
-    controller.cxx
-    controller.hxx
-    input_axis.hxx
-    input_axis_input_device.cxx
-    input_axis_input_device.hxx
-    input_button.hxx
-    input_keyboard.hxx
-    input_button_input_device.cxx
-    input_button_input_device.hxx
-    input_keyboard_input_device.hxx
-    input_keyboard_input_device.cxx
-    input_event.hxx
-    input_manager_custom.cxx
-    input_manager_custom.hxx
-    input_manager.cxx
-    input_manager.hxx
-    input_manager_impl.cxx
-    input_manager_impl.hxx
-    input_manager_player.cxx
-    input_manager_player.hxx
-    input_recorder.cxx
-    input_recorder.hxx
-    multi_button.cxx
-    multi_button.hxx
+    axis_button.cpp                
+    axis_button.hpp
+    axis_factory.cpp
+    axis_factory.hpp
+    button_axis.cpp
+    button_axis.hpp
+    button_factory.cpp
+    button_factory.hpp
+    controller.cpp
+    controller.hpp
+    input_axis.hpp
+    input_axis_input_device.cpp
+    input_axis_input_device.hpp
+    input_button.hpp
+    input_keyboard.hpp
+    input_button_input_device.cpp
+    input_button_input_device.hpp
+    input_keyboard_input_device.hpp
+    input_keyboard_input_device.cpp
+    input_event.hpp
+    input_manager_custom.cpp
+    input_manager_custom.hpp
+    input_manager.cpp
+    input_manager.hpp
+    input_manager_impl.cpp
+    input_manager_impl.hpp
+    input_manager_player.cpp
+    input_manager_player.hpp
+    input_recorder.cpp
+    input_recorder.hpp
+    multi_button.cpp
+    multi_button.hpp
 ;
 
 TRANSLATABLE_SOURCES += [ SearchSource $(sources) ] ;

Copied: trunk/src/input/axis_button.cpp (from rev 502, trunk/src/input/axis_button.cxx)
===================================================================
--- trunk/src/input/axis_button.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/axis_button.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,72 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;iostream&gt;
+#include &quot;input_axis.hpp&quot;
+#include &quot;axis_button.hpp&quot;
+
+AxisButton::AxisButton(InputAxis* axis, bool top)
+  : axis(axis),
+    down(false),
+    top(top)
+{
+  on_axis_move_slot = axis-&gt;on_move().connect(this, &amp;AxisButton::on_axis_move);
+}
+
+AxisButton::~AxisButton()
+{
+}
+
+void
+AxisButton::update(float )
+{
+}
+
+void
+AxisButton::on_axis_move(float pos)
+{
+  if (top)
+    {
+      if (down &amp;&amp; pos &lt; 0.5f)
+        {
+          down = false;
+          button_up();
+        }
+      else if (!down &amp;&amp; pos &gt; 0.5f)
+        {
+          down = true;
+          button_down();
+        }
+    }
+  else
+    {
+      if (down &amp;&amp; pos &gt; -0.5f)
+        {
+          down = false;
+          button_up();
+        }
+      else if (!down &amp;&amp; pos &lt; -0.5f)
+        {
+          down = true;
+          button_down();
+        }
+    }
+}
+
+/* EOF */

Deleted: trunk/src/input/axis_button.cxx
===================================================================
--- trunk/src/input/axis_button.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/axis_button.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,72 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;iostream&gt;
-#include &quot;input_axis.hxx&quot;
-#include &quot;axis_button.hxx&quot;
-
-AxisButton::AxisButton(InputAxis* axis, bool top)
-  : axis(axis),
-    down(false),
-    top(top)
-{
-  on_axis_move_slot = axis-&gt;on_move().connect(this, &amp;AxisButton::on_axis_move);
-}
-
-AxisButton::~AxisButton()
-{
-}
-
-void
-AxisButton::update(float )
-{
-}
-
-void
-AxisButton::on_axis_move(float pos)
-{
-  if (top)
-    {
-      if (down &amp;&amp; pos &lt; 0.5f)
-        {
-          down = false;
-          button_up();
-        }
-      else if (!down &amp;&amp; pos &gt; 0.5f)
-        {
-          down = true;
-          button_down();
-        }
-    }
-  else
-    {
-      if (down &amp;&amp; pos &gt; -0.5f)
-        {
-          down = false;
-          button_up();
-        }
-      else if (!down &amp;&amp; pos &lt; -0.5f)
-        {
-          down = true;
-          button_down();
-        }
-    }
-}
-
-/* EOF */

Copied: trunk/src/input/axis_button.hpp (from rev 502, trunk/src/input/axis_button.hxx)
===================================================================
--- trunk/src/input/axis_button.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/axis_button.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,53 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_AXIS_BUTTON_HXX
+#define HEADER_AXIS_BUTTON_HXX
+
+#include &quot;input_button.hpp&quot;
+
+class InputAxis;
+
+/** */
+class AxisButton : public InputButton
+{
+private:
+  CL_Slot on_axis_move_slot;
+  InputAxis* axis;
+  bool down;
+
+  /** true if the range 0..1 should be used to trigger, false if -1..0
+      should be used */
+  bool top;
+public:
+  AxisButton(InputAxis* axis, bool top);
+  ~AxisButton();
+
+  void update(float delta);
+  
+private:
+  void on_axis_move(float pos);
+
+  AxisButton (const AxisButton&amp;);
+  AxisButton&amp; operator= (const AxisButton&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/input/axis_button.hxx
===================================================================
--- trunk/src/input/axis_button.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/axis_button.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,53 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_AXIS_BUTTON_HXX
-#define HEADER_AXIS_BUTTON_HXX
-
-#include &quot;input_button.hxx&quot;
-
-class InputAxis;
-
-/** */
-class AxisButton : public InputButton
-{
-private:
-  CL_Slot on_axis_move_slot;
-  InputAxis* axis;
-  bool down;
-
-  /** true if the range 0..1 should be used to trigger, false if -1..0
-      should be used */
-  bool top;
-public:
-  AxisButton(InputAxis* axis, bool top);
-  ~AxisButton();
-
-  void update(float delta);
-  
-private:
-  void on_axis_move(float pos);
-
-  AxisButton (const AxisButton&amp;);
-  AxisButton&amp; operator= (const AxisButton&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/axis_factory.cpp (from rev 502, trunk/src/input/axis_factory.cxx)
===================================================================
--- trunk/src/input/axis_factory.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/axis_factory.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,68 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ClanLib/Display/joystick.h&gt;
+#include &quot;input_axis_input_device.hpp&quot;
+#include &quot;windstille_error.hpp&quot;
+#include &quot;button_factory.hpp&quot;
+#include &quot;button_axis.hpp&quot;
+#include &quot;axis_factory.hpp&quot;
+#include &quot;lisp_util.hpp&quot;
+#include &quot;lisp/lisp.hpp&quot;
+#include &quot;lisp/list_iterator.hpp&quot;
+
+InputAxis* 
+AxisFactory::create(const lisp::Lisp* lisp)
+{
+  lisp::ListIterator iter(lisp);
+  while(iter.next()) {
+    if(iter.item() == &quot;joystick-axis&quot;) {
+      return create_joystick_axis(iter.lisp());
+    } else if(iter.item() == &quot;button-axis&quot;) {
+      return create_button_axis(iter.lisp());
+    } else {
+      std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot; &lt;&lt; iter.item() &lt;&lt; &quot;' in axis.\n&quot;;
+    }
+  }
+
+  return 0;
+}
+
+InputAxis*
+AxisFactory::create_joystick_axis(const lisp::Lisp* lisp)
+{
+  int device_num = lisp_get_list_nth(lisp, 0)-&gt;get_int();
+  int axis_num   = lisp_get_list_nth(lisp, 1)-&gt;get_int();
+
+  if (device_num &gt;= 0 &amp;&amp; device_num &lt; CL_Joystick::get_device_count())
+    return new InputAxisInputDevice(CL_Joystick::get_device(device_num), axis_num);
+  else
+    throw WindstilleError(&quot;Error: AxisFactory::create_joystick_axis: &quot;);
+}
+
+InputAxis*
+AxisFactory::create_button_axis(const lisp::Lisp* lisp)
+{
+  InputButton* left  = ButtonFactory::create(lisp_get_list_nth(lisp, 0));
+  InputButton* right = ButtonFactory::create(lisp_get_list_nth(lisp, 1));
+
+  return new ButtonAxis(left, right);
+}
+
+/* EOF */

Deleted: trunk/src/input/axis_factory.cxx
===================================================================
--- trunk/src/input/axis_factory.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/axis_factory.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,68 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ClanLib/Display/joystick.h&gt;
-#include &quot;input_axis_input_device.hxx&quot;
-#include &quot;windstille_error.hxx&quot;
-#include &quot;button_factory.hxx&quot;
-#include &quot;button_axis.hxx&quot;
-#include &quot;axis_factory.hxx&quot;
-#include &quot;lisp_util.hpp&quot;
-#include &quot;lisp/lisp.hpp&quot;
-#include &quot;lisp/list_iterator.hpp&quot;
-
-InputAxis* 
-AxisFactory::create(const lisp::Lisp* lisp)
-{
-  lisp::ListIterator iter(lisp);
-  while(iter.next()) {
-    if(iter.item() == &quot;joystick-axis&quot;) {
-      return create_joystick_axis(iter.lisp());
-    } else if(iter.item() == &quot;button-axis&quot;) {
-      return create_button_axis(iter.lisp());
-    } else {
-      std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot; &lt;&lt; iter.item() &lt;&lt; &quot;' in axis.\n&quot;;
-    }
-  }
-
-  return 0;
-}
-
-InputAxis*
-AxisFactory::create_joystick_axis(const lisp::Lisp* lisp)
-{
-  int device_num = lisp_get_list_nth(lisp, 0)-&gt;get_int();
-  int axis_num   = lisp_get_list_nth(lisp, 1)-&gt;get_int();
-
-  if (device_num &gt;= 0 &amp;&amp; device_num &lt; CL_Joystick::get_device_count())
-    return new InputAxisInputDevice(CL_Joystick::get_device(device_num), axis_num);
-  else
-    throw WindstilleError(&quot;Error: AxisFactory::create_joystick_axis: &quot;);
-}
-
-InputAxis*
-AxisFactory::create_button_axis(const lisp::Lisp* lisp)
-{
-  InputButton* left  = ButtonFactory::create(lisp_get_list_nth(lisp, 0));
-  InputButton* right = ButtonFactory::create(lisp_get_list_nth(lisp, 1));
-
-  return new ButtonAxis(left, right);
-}
-
-/* EOF */

Copied: trunk/src/input/axis_factory.hpp (from rev 502, trunk/src/input/axis_factory.hxx)
===================================================================
--- trunk/src/input/axis_factory.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/axis_factory.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,38 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_AXIS_FACTORY_HXX
+#define HEADER_AXIS_FACTORY_HXX
+
+#include &quot;lisp/lisp.hpp&quot;
+#include &quot;input_axis.hpp&quot;
+
+/** */
+class AxisFactory
+{
+public:
+  static InputAxis* create(const lisp::Lisp* lisp);
+private:
+  static InputAxis* create_joystick_axis(const lisp::Lisp* lisp);
+  static InputAxis* create_button_axis(const lisp::Lisp* lisp);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/input/axis_factory.hxx
===================================================================
--- trunk/src/input/axis_factory.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/axis_factory.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,38 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_AXIS_FACTORY_HXX
-#define HEADER_AXIS_FACTORY_HXX
-
-#include &quot;lisp/lisp.hpp&quot;
-#include &quot;input_axis.hxx&quot;
-
-/** */
-class AxisFactory
-{
-public:
-  static InputAxis* create(const lisp::Lisp* lisp);
-private:
-  static InputAxis* create_joystick_axis(const lisp::Lisp* lisp);
-  static InputAxis* create_button_axis(const lisp::Lisp* lisp);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/button_axis.cpp (from rev 502, trunk/src/input/button_axis.cxx)
===================================================================
--- trunk/src/input/button_axis.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/button_axis.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,87 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;iostream&gt;
+#include &quot;input_button.hpp&quot;
+#include &quot;button_axis.hpp&quot;
+
+ButtonAxis::ButtonAxis(InputButton* left, InputButton* right)
+  : left(left), right(right)
+{
+  slots.push_back(left-&gt;on_key_down().connect(this, &amp;ButtonAxis::on_left_down));
+  slots.push_back(left-&gt;on_key_up().connect  (this, &amp;ButtonAxis::on_left_up));
+
+  slots.push_back(right-&gt;on_key_down().connect(this, &amp;ButtonAxis::on_right_down));
+  slots.push_back(right-&gt;on_key_up().connect  (this, &amp;ButtonAxis::on_right_up));
+
+  left_state  = false;
+  right_state = false;
+  
+  pos = 0.0f;
+}
+
+void
+ButtonAxis::update(float delta)
+{
+  left-&gt;update(delta);
+  right-&gt;update(delta);
+
+  float new_pos = 0.0f;
+  if (left_state)
+    {
+      new_pos -= 1.0f;
+    }
+  
+  if (right_state)
+    {
+      new_pos += 1.0f;
+    }
+
+  if (new_pos != pos)
+    {
+      pos = new_pos;
+      move(pos);
+    }
+}
+
+void
+ButtonAxis::on_left_up()
+{
+  left_state = false;
+}
+
+void
+ButtonAxis::on_left_down()
+{
+  left_state = true;
+}
+
+void
+ButtonAxis::on_right_up()
+{
+  right_state = false;
+}
+
+void
+ButtonAxis::on_right_down()
+{
+  right_state = true;
+}
+
+/* EOF */

Deleted: trunk/src/input/button_axis.cxx
===================================================================
--- trunk/src/input/button_axis.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/button_axis.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,87 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;iostream&gt;
-#include &quot;input_button.hxx&quot;
-#include &quot;button_axis.hxx&quot;
-
-ButtonAxis::ButtonAxis(InputButton* left, InputButton* right)
-  : left(left), right(right)
-{
-  slots.push_back(left-&gt;on_key_down().connect(this, &amp;ButtonAxis::on_left_down));
-  slots.push_back(left-&gt;on_key_up().connect  (this, &amp;ButtonAxis::on_left_up));
-
-  slots.push_back(right-&gt;on_key_down().connect(this, &amp;ButtonAxis::on_right_down));
-  slots.push_back(right-&gt;on_key_up().connect  (this, &amp;ButtonAxis::on_right_up));
-
-  left_state  = false;
-  right_state = false;
-  
-  pos = 0.0f;
-}
-
-void
-ButtonAxis::update(float delta)
-{
-  left-&gt;update(delta);
-  right-&gt;update(delta);
-
-  float new_pos = 0.0f;
-  if (left_state)
-    {
-      new_pos -= 1.0f;
-    }
-  
-  if (right_state)
-    {
-      new_pos += 1.0f;
-    }
-
-  if (new_pos != pos)
-    {
-      pos = new_pos;
-      move(pos);
-    }
-}
-
-void
-ButtonAxis::on_left_up()
-{
-  left_state = false;
-}
-
-void
-ButtonAxis::on_left_down()
-{
-  left_state = true;
-}
-
-void
-ButtonAxis::on_right_up()
-{
-  right_state = false;
-}
-
-void
-ButtonAxis::on_right_down()
-{
-  right_state = true;
-}
-
-/* EOF */

Copied: trunk/src/input/button_axis.hpp (from rev 502, trunk/src/input/button_axis.hxx)
===================================================================
--- trunk/src/input/button_axis.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/button_axis.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,50 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_BUTTON_AXIS_HXX
+#define HEADER_BUTTON_AXIS_HXX
+
+#include &quot;input_axis.hpp&quot;
+
+class InputButton;
+
+class ButtonAxis : public InputAxis
+{
+private:
+  InputButton* left;
+  InputButton* right;
+
+  bool left_state;
+  bool right_state;
+  
+  float pos;
+private:
+  void on_left_up();
+  void on_left_down();
+
+  void on_right_up();
+  void on_right_down();
+public:
+  ButtonAxis(InputButton* left, InputButton* right);
+  void update(float delta);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/input/button_axis.hxx
===================================================================
--- trunk/src/input/button_axis.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/button_axis.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,50 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_BUTTON_AXIS_HXX
-#define HEADER_BUTTON_AXIS_HXX
-
-#include &quot;input_axis.hxx&quot;
-
-class InputButton;
-
-class ButtonAxis : public InputAxis
-{
-private:
-  InputButton* left;
-  InputButton* right;
-
-  bool left_state;
-  bool right_state;
-  
-  float pos;
-private:
-  void on_left_up();
-  void on_left_down();
-
-  void on_right_up();
-  void on_right_down();
-public:
-  ButtonAxis(InputButton* left, InputButton* right);
-  void update(float delta);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/button_factory.cpp (from rev 502, trunk/src/input/button_factory.cxx)
===================================================================
--- trunk/src/input/button_factory.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/button_factory.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,98 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ClanLib/Display/joystick.h&gt;
+#include &lt;ClanLib/Display/keyboard.h&gt;
+#include &quot;windstille_error.hpp&quot;
+#include &quot;input_button.hpp&quot;
+#include &quot;input_axis.hpp&quot;
+#include &quot;input_button_input_device.hpp&quot;
+#include &quot;lisp/list_iterator.hpp&quot;
+#include &quot;lisp_util.hpp&quot;
+#include &quot;axis_factory.hpp&quot;
+#include &quot;axis_button.hpp&quot;
+#include &quot;multi_button.hpp&quot;
+#include &quot;button_factory.hpp&quot;
+
+InputButton* 
+ButtonFactory::create(const lisp::Lisp* lisp)
+{
+  lisp::ListIterator iter(lisp);
+  while(iter.next()) {
+    if(iter.item() == &quot;joystick-button&quot;) {
+      return create_joystick_button(iter.lisp());
+    } else if(iter.item() == &quot;keyboard-button&quot;) {
+      return create_keyboard_button(iter.lisp());
+    } else if(iter.item() == &quot;axis-button&quot;) {
+      return create_axis_button(iter.lisp());
+    } else if(iter.item() == &quot;multi-button&quot;) {
+      return create_multi_button(iter.lisp());
+    } else {
+      std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot; &lt;&lt; iter.item() 
+        &lt;&lt; &quot;' in controller file\n&quot;;
+    }
+  }
+      
+  return 0;
+}
+
+InputButton*
+ButtonFactory::create_axis_button(const lisp::Lisp* lisp)
+{
+  InputAxis* axis = AxisFactory::create(lisp_get_list_nth(lisp, 0));
+  bool top = lisp_get_list_nth(lisp, 1)-&gt;get_bool();
+  
+  return new AxisButton(axis, top);
+}
+
+InputButton*
+ButtonFactory::create_joystick_button(const lisp::Lisp* lisp)
+{
+  int device_num = lisp_get_list_nth(lisp, 0)-&gt;get_int();
+  int button_num = lisp_get_list_nth(lisp, 1)-&gt;get_int();
+  
+  if (device_num &gt;= 0 &amp;&amp; device_num &lt; CL_Joystick::get_device_count())
+    return new InputButtonInputDevice(CL_Joystick::get_device(device_num), button_num);
+  else
+    throw WindstilleError(&quot;Error: ButtonFactory::create_joystick_button: device out of range&quot;);
+}
+
+InputButton*
+ButtonFactory::create_keyboard_button(const lisp::Lisp* lisp)
+{
+  std::string key_str = lisp-&gt;get_car()-&gt;get_string();
+  int key_num         = CL_Keyboard::get_device().string_to_keyid(key_str);
+
+  // FIXME: No error checking
+  return new InputButtonInputDevice(CL_Keyboard::get_device(), key_num);
+}
+
+InputButton*
+ButtonFactory::create_multi_button(const lisp::Lisp* lisp)
+{
+  MultiButton* button = new MultiButton();
+ 
+  for( ; lisp != 0; lisp = lisp-&gt;get_cdr()) {
+    button-&gt;add(create(lisp-&gt;get_car()));
+  }
+  
+  return button;
+}
+
+/* EOF */

Deleted: trunk/src/input/button_factory.cxx
===================================================================
--- trunk/src/input/button_factory.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/button_factory.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,98 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ClanLib/Display/joystick.h&gt;
-#include &lt;ClanLib/Display/keyboard.h&gt;
-#include &quot;windstille_error.hxx&quot;
-#include &quot;input_button.hxx&quot;
-#include &quot;input_axis.hxx&quot;
-#include &quot;input_button_input_device.hxx&quot;
-#include &quot;lisp/list_iterator.hpp&quot;
-#include &quot;lisp_util.hpp&quot;
-#include &quot;axis_factory.hxx&quot;
-#include &quot;axis_button.hxx&quot;
-#include &quot;multi_button.hxx&quot;
-#include &quot;button_factory.hxx&quot;
-
-InputButton* 
-ButtonFactory::create(const lisp::Lisp* lisp)
-{
-  lisp::ListIterator iter(lisp);
-  while(iter.next()) {
-    if(iter.item() == &quot;joystick-button&quot;) {
-      return create_joystick_button(iter.lisp());
-    } else if(iter.item() == &quot;keyboard-button&quot;) {
-      return create_keyboard_button(iter.lisp());
-    } else if(iter.item() == &quot;axis-button&quot;) {
-      return create_axis_button(iter.lisp());
-    } else if(iter.item() == &quot;multi-button&quot;) {
-      return create_multi_button(iter.lisp());
-    } else {
-      std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot; &lt;&lt; iter.item() 
-        &lt;&lt; &quot;' in controller file\n&quot;;
-    }
-  }
-      
-  return 0;
-}
-
-InputButton*
-ButtonFactory::create_axis_button(const lisp::Lisp* lisp)
-{
-  InputAxis* axis = AxisFactory::create(lisp_get_list_nth(lisp, 0));
-  bool top = lisp_get_list_nth(lisp, 1)-&gt;get_bool();
-  
-  return new AxisButton(axis, top);
-}
-
-InputButton*
-ButtonFactory::create_joystick_button(const lisp::Lisp* lisp)
-{
-  int device_num = lisp_get_list_nth(lisp, 0)-&gt;get_int();
-  int button_num = lisp_get_list_nth(lisp, 1)-&gt;get_int();
-  
-  if (device_num &gt;= 0 &amp;&amp; device_num &lt; CL_Joystick::get_device_count())
-    return new InputButtonInputDevice(CL_Joystick::get_device(device_num), button_num);
-  else
-    throw WindstilleError(&quot;Error: ButtonFactory::create_joystick_button: device out of range&quot;);
-}
-
-InputButton*
-ButtonFactory::create_keyboard_button(const lisp::Lisp* lisp)
-{
-  std::string key_str = lisp-&gt;get_car()-&gt;get_string();
-  int key_num         = CL_Keyboard::get_device().string_to_keyid(key_str);
-
-  // FIXME: No error checking
-  return new InputButtonInputDevice(CL_Keyboard::get_device(), key_num);
-}
-
-InputButton*
-ButtonFactory::create_multi_button(const lisp::Lisp* lisp)
-{
-  MultiButton* button = new MultiButton();
- 
-  for( ; lisp != 0; lisp = lisp-&gt;get_cdr()) {
-    button-&gt;add(create(lisp-&gt;get_car()));
-  }
-  
-  return button;
-}
-
-/* EOF */

Copied: trunk/src/input/button_factory.hpp (from rev 502, trunk/src/input/button_factory.hxx)

Deleted: trunk/src/input/button_factory.hxx
===================================================================
--- trunk/src/input/button_factory.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/button_factory.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,46 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_BUTTON_FACTORY_HXX
-#define HEADER_BUTTON_FACTORY_HXX
-
-#include &quot;lisp/lisp.hpp&quot;
-
-class InputButton;
-
-/** */
-class ButtonFactory
-{
-private:
-public:
-  static InputButton* create(const lisp::Lisp* lisp);
-
-private:
-  static InputButton* create_joystick_button(const lisp::Lisp* lisp);
-  static InputButton* create_keyboard_button(const lisp::Lisp* lisp);
-  static InputButton* create_axis_button(const lisp::Lisp* lisp);
-  static InputButton* create_multi_button(const lisp::Lisp* lisp);
-
-  ButtonFactory (const ButtonFactory&amp;);
-  ButtonFactory&amp; operator= (const ButtonFactory&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/controller.cpp (from rev 502, trunk/src/input/controller.cxx)
===================================================================
--- trunk/src/input/controller.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/controller.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,90 @@
+//  $Id: controller.cxx,v 1.4 2003/10/31 23:24:41 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;assert.h&gt;
+#include &quot;controller.hpp&quot;
+
+Controller::Controller()
+{
+  buttons.resize(ControllerDef::get_button_count());
+  axes.resize(ControllerDef::get_axis_count());
+}
+
+float
+Controller::get_axis_state(int name) const
+{
+  assert(name &lt; int(axes.size()));
+  return axes[name];
+}
+        
+
+bool
+Controller::get_button_state(int name) const
+{
+  assert(name &lt; int(buttons.size()));
+  return buttons[name];
+}
+
+void
+Controller::set_axis_state(int name, float pos)
+{
+  assert(name &lt; static_cast&lt;int&gt; (axes.size()));
+  axes[name] = pos;
+}
+
+void
+Controller::set_button_state(int name, bool down)
+{
+  assert(name &lt; static_cast&lt;int&gt;(buttons.size()));
+  buttons[name] = down;
+}
+
+void
+Controller::add_axis_event(int name, float pos)
+{
+  InputEvent event;
+  event.type = AXIS_EVENT;
+  event.axis.name = name;
+  event.axis.pos  = pos;
+  events.push_back(event);
+}
+
+void
+Controller::add_button_event(int name, bool down)
+{
+  InputEvent event;
+  event.type = BUTTON_EVENT;
+  event.button.name = name;
+  event.button.down = down;
+  events.push_back(event);
+}
+
+InputEventLst
+Controller::get_events() const
+{
+  return events;
+}
+
+void
+Controller::set_events(const InputEventLst&amp; lst)
+{
+  events = lst;
+}
+
+/* EOF */

Deleted: trunk/src/input/controller.cxx
===================================================================
--- trunk/src/input/controller.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/controller.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,90 +0,0 @@
-//  $Id: controller.cxx,v 1.4 2003/10/31 23:24:41 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;assert.h&gt;
-#include &quot;controller.hxx&quot;
-
-Controller::Controller()
-{
-  buttons.resize(ControllerDef::get_button_count());
-  axes.resize(ControllerDef::get_axis_count());
-}
-
-float
-Controller::get_axis_state(int name) const
-{
-  assert(name &lt; int(axes.size()));
-  return axes[name];
-}
-        
-
-bool
-Controller::get_button_state(int name) const
-{
-  assert(name &lt; int(buttons.size()));
-  return buttons[name];
-}
-
-void
-Controller::set_axis_state(int name, float pos)
-{
-  assert(name &lt; static_cast&lt;int&gt; (axes.size()));
-  axes[name] = pos;
-}
-
-void
-Controller::set_button_state(int name, bool down)
-{
-  assert(name &lt; static_cast&lt;int&gt;(buttons.size()));
-  buttons[name] = down;
-}
-
-void
-Controller::add_axis_event(int name, float pos)
-{
-  InputEvent event;
-  event.type = AXIS_EVENT;
-  event.axis.name = name;
-  event.axis.pos  = pos;
-  events.push_back(event);
-}
-
-void
-Controller::add_button_event(int name, bool down)
-{
-  InputEvent event;
-  event.type = BUTTON_EVENT;
-  event.button.name = name;
-  event.button.down = down;
-  events.push_back(event);
-}
-
-InputEventLst
-Controller::get_events() const
-{
-  return events;
-}
-
-void
-Controller::set_events(const InputEventLst&amp; lst)
-{
-  events = lst;
-}
-
-/* EOF */

Copied: trunk/src/input/controller.hpp (from rev 502, trunk/src/input/controller.hxx)
===================================================================
--- trunk/src/input/controller.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/controller.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,59 @@
+//  $Id: controller.hpp,v 1.4 2003/10/31 23:24:41 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_CONTROLLER_HXX
+#define HEADER_CONTROLLER_HXX
+
+#include &lt;vector&gt;
+#include &quot;../controller_def.hpp&quot;
+#include &quot;input_event.hpp&quot;
+
+/** The Controller class presents the current state of the controller
+    and the input events that occurred on the controller since the
+    last update */
+class Controller
+{
+private:
+  /** State of all buttons, indexed by ButtonName */
+  std::vector&lt;bool&gt; buttons;
+  
+  /** State of all axis, indexed by AxisName */
+  std::vector&lt;float&gt; axes;
+
+  InputEventLst events;
+
+public:
+  Controller();
+
+  float get_axis_state  (int name) const;
+  bool  get_button_state(int name) const;
+
+  void  set_axis_state  (int name, float pos);
+  void  set_button_state(int name, bool down);
+
+  void add_axis_event  (int name, float pos);
+  void add_button_event(int name, bool down);
+
+  InputEventLst get_events() const;
+  void set_events(const InputEventLst&amp; lst);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/input/controller.hxx
===================================================================
--- trunk/src/input/controller.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/controller.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,59 +0,0 @@
-//  $Id: controller.hxx,v 1.4 2003/10/31 23:24:41 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_CONTROLLER_HXX
-#define HEADER_CONTROLLER_HXX
-
-#include &lt;vector&gt;
-#include &quot;../controller_def.hxx&quot;
-#include &quot;input_event.hxx&quot;
-
-/** The Controller class presents the current state of the controller
-    and the input events that occurred on the controller since the
-    last update */
-class Controller
-{
-private:
-  /** State of all buttons, indexed by ButtonName */
-  std::vector&lt;bool&gt; buttons;
-  
-  /** State of all axis, indexed by AxisName */
-  std::vector&lt;float&gt; axes;
-
-  InputEventLst events;
-
-public:
-  Controller();
-
-  float get_axis_state  (int name) const;
-  bool  get_button_state(int name) const;
-
-  void  set_axis_state  (int name, float pos);
-  void  set_button_state(int name, bool down);
-
-  void add_axis_event  (int name, float pos);
-  void add_button_event(int name, bool down);
-
-  InputEventLst get_events() const;
-  void set_events(const InputEventLst&amp; lst);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/input_axis.hpp (from rev 502, trunk/src/input/input_axis.hxx)

Deleted: trunk/src/input/input_axis.hxx
===================================================================
--- trunk/src/input/input_axis.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_axis.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,42 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_INPUT_AXIS_HXX
-#define HEADER_INPUT_AXIS_HXX
-
-#include &lt;vector&gt;
-#include &lt;ClanLib/Signals/slot.h&gt;
-#include &lt;ClanLib/Signals/signal_v1.h&gt;
-
-class InputAxis
-{
-protected:
-  std::vector&lt;CL_Slot&gt; slots;
-  CL_Signal_v1&lt;float&gt; move;  
-public:
-  InputAxis() {}
-  virtual ~InputAxis() {}
-
-  virtual void update(float ) {}
-  CL_Signal_v1&lt;float&gt;&amp; on_move() { return move; }
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/input_axis_input_device.cpp (from rev 502, trunk/src/input/input_axis_input_device.cxx)
===================================================================
--- trunk/src/input/input_axis_input_device.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_axis_input_device.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,38 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ClanLib/Display/input_event.h&gt;
+#include &quot;input_axis_input_device.hpp&quot;
+
+InputAxisInputDevice::InputAxisInputDevice(CL_InputDevice&amp; dev, int num)
+  : dev(dev), axis_num(num)
+{
+  slots.push_back(dev.sig_axis_move().connect(this, &amp;InputAxisInputDevice::on_axis_move));
+}
+
+void
+InputAxisInputDevice::on_axis_move(const CL_InputEvent&amp; event)
+{
+  if (event.id == axis_num)
+    {
+      move(event.axis_pos);
+    }
+}
+
+/* EOF */

Deleted: trunk/src/input/input_axis_input_device.cxx
===================================================================
--- trunk/src/input/input_axis_input_device.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_axis_input_device.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,38 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ClanLib/Display/input_event.h&gt;
-#include &quot;input_axis_input_device.hxx&quot;
-
-InputAxisInputDevice::InputAxisInputDevice(CL_InputDevice&amp; dev, int num)
-  : dev(dev), axis_num(num)
-{
-  slots.push_back(dev.sig_axis_move().connect(this, &amp;InputAxisInputDevice::on_axis_move));
-}
-
-void
-InputAxisInputDevice::on_axis_move(const CL_InputEvent&amp; event)
-{
-  if (event.id == axis_num)
-    {
-      move(event.axis_pos);
-    }
-}
-
-/* EOF */

Copied: trunk/src/input/input_axis_input_device.hpp (from rev 502, trunk/src/input/input_axis_input_device.hxx)
===================================================================
--- trunk/src/input/input_axis_input_device.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_axis_input_device.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,41 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_AXIS_INPUT_DEVICE_HXX
+#define HEADER_INPUT_AXIS_INPUT_DEVICE_HXX
+
+#include &lt;ClanLib/Display/input_device.h&gt;
+#include &quot;input_axis.hpp&quot;
+
+class InputAxisInputDevice : public InputAxis
+{
+private:
+  CL_InputDevice dev;
+  int axis_num;
+
+  void on_axis_move(const CL_InputEvent&amp; event); 
+
+public:
+  InputAxisInputDevice(CL_InputDevice&amp; dev, int num);
+  void update(float ) {}
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/input/input_axis_input_device.hxx
===================================================================
--- trunk/src/input/input_axis_input_device.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_axis_input_device.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,41 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_INPUT_AXIS_INPUT_DEVICE_HXX
-#define HEADER_INPUT_AXIS_INPUT_DEVICE_HXX
-
-#include &lt;ClanLib/Display/input_device.h&gt;
-#include &quot;input_axis.hxx&quot;
-
-class InputAxisInputDevice : public InputAxis
-{
-private:
-  CL_InputDevice dev;
-  int axis_num;
-
-  void on_axis_move(const CL_InputEvent&amp; event); 
-
-public:
-  InputAxisInputDevice(CL_InputDevice&amp; dev, int num);
-  void update(float ) {}
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/input_button.hpp (from rev 502, trunk/src/input/input_button.hxx)

Deleted: trunk/src/input/input_button.hxx
===================================================================
--- trunk/src/input/input_button.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_button.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,46 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_INPUT_BOTTON_HXX
-#define HEADER_INPUT_BOTTON_HXX
-
-#include &lt;vector&gt;
-#include &lt;ClanLib/Signals/slot.h&gt;
-#include &lt;ClanLib/Signals/signal_v0.h&gt;
-
-class InputButton
-{
-protected:
-  std::vector&lt;CL_Slot&gt; slots;
-  CL_Signal_v0 button_down;
-  CL_Signal_v0 button_up;
-
-public:
-  InputButton() {}
-  virtual ~InputButton() {}
-  
-  virtual void update(float ) {}
-
-  CL_Signal_v0&amp; on_key_down() { return button_down; }
-  CL_Signal_v0&amp; on_key_up()   { return button_up; }
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/input_button_input_device.cpp (from rev 502, trunk/src/input/input_button_input_device.cxx)
===================================================================
--- trunk/src/input/input_button_input_device.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_button_input_device.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,49 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;iostream&gt;
+#include &lt;ClanLib/Display/input_event.h&gt;
+#include &quot;input_button_input_device.hpp&quot;
+
+InputButtonInputDevice::InputButtonInputDevice(CL_InputDevice&amp; dev_, int keycode_)
+  : dev(dev_), keycode(keycode_)
+{
+  slots.push_back(dev.sig_key_down().connect(this, &amp;InputButtonInputDevice::on_key_down));
+  slots.push_back(dev.sig_key_up().connect(this, &amp;InputButtonInputDevice::on_key_up));
+}
+
+void
+InputButtonInputDevice::on_key_down(const CL_InputEvent&amp; event)
+{
+  if (keycode == event.id)
+    {
+      button_down();
+    }
+}
+
+void
+InputButtonInputDevice::on_key_up(const CL_InputEvent&amp; event)
+{
+  if (keycode == event.id)
+    {
+      button_up();
+    }
+}
+
+/* EOF */

Deleted: trunk/src/input/input_button_input_device.cxx
===================================================================
--- trunk/src/input/input_button_input_device.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_button_input_device.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,49 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;iostream&gt;
-#include &lt;ClanLib/Display/input_event.h&gt;
-#include &quot;input_button_input_device.hxx&quot;
-
-InputButtonInputDevice::InputButtonInputDevice(CL_InputDevice&amp; dev_, int keycode_)
-  : dev(dev_), keycode(keycode_)
-{
-  slots.push_back(dev.sig_key_down().connect(this, &amp;InputButtonInputDevice::on_key_down));
-  slots.push_back(dev.sig_key_up().connect(this, &amp;InputButtonInputDevice::on_key_up));
-}
-
-void
-InputButtonInputDevice::on_key_down(const CL_InputEvent&amp; event)
-{
-  if (keycode == event.id)
-    {
-      button_down();
-    }
-}
-
-void
-InputButtonInputDevice::on_key_up(const CL_InputEvent&amp; event)
-{
-  if (keycode == event.id)
-    {
-      button_up();
-    }
-}
-
-/* EOF */

Copied: trunk/src/input/input_button_input_device.hpp (from rev 502, trunk/src/input/input_button_input_device.hxx)
===================================================================
--- trunk/src/input/input_button_input_device.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_button_input_device.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,43 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_BOTTON_INPUT_DEVICE_HXX
+#define HEADER_INPUT_BOTTON_INPUT_DEVICE_HXX
+
+#include &lt;ClanLib/Display/input_device.h&gt;
+#include &quot;input_button.hpp&quot;
+
+class InputButtonInputDevice : public InputButton
+{
+private:
+  CL_InputDevice dev;
+  int keycode;
+
+  void on_key_down(const CL_InputEvent&amp; event);
+  void on_key_up(const CL_InputEvent&amp; event);
+
+public:
+  InputButtonInputDevice(CL_InputDevice&amp; dev, int keycode);
+  
+  void update(float ) {}
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/input/input_button_input_device.hxx
===================================================================
--- trunk/src/input/input_button_input_device.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_button_input_device.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,43 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_INPUT_BOTTON_INPUT_DEVICE_HXX
-#define HEADER_INPUT_BOTTON_INPUT_DEVICE_HXX
-
-#include &lt;ClanLib/Display/input_device.h&gt;
-#include &quot;input_button.hxx&quot;
-
-class InputButtonInputDevice : public InputButton
-{
-private:
-  CL_InputDevice dev;
-  int keycode;
-
-  void on_key_down(const CL_InputEvent&amp; event);
-  void on_key_up(const CL_InputEvent&amp; event);
-
-public:
-  InputButtonInputDevice(CL_InputDevice&amp; dev, int keycode);
-  
-  void update(float ) {}
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/input_event.hpp (from rev 502, trunk/src/input/input_event.hxx)
===================================================================
--- trunk/src/input/input_event.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_event.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,71 @@
+//  $Id: input_event.hpp,v 1.4 2003/10/31 23:24:41 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_EVENT_HXX
+#define HEADER_INPUT_EVENT_HXX
+
+#include &lt;vector&gt;
+
+enum InputEventType { BUTTON_EVENT, AXIS_EVENT, KEYBOARD_EVENT };
+
+/** Used for textual input */
+struct KeyboardEvent
+{
+  enum KeyType { LETTER, SPECIAL } key_type;
+  int code;
+};
+
+struct ButtonEvent
+{
+  int name;
+
+  /** true if down, false if up */
+  bool down;
+
+  bool is_down() const { return down; }
+  bool is_up()   const { return !down; }
+};
+
+struct AxisEvent
+{
+  int name;
+
+  /** Pos can be in range from [-1.0, 1.0], some axis will only use [0,1.0] */
+  float pos;
+
+  float get_pos() { return pos; }
+};
+
+struct InputEvent 
+{
+  InputEventType type;
+    
+  union 
+  {
+    struct ButtonEvent   button;
+    struct AxisEvent     axis;
+    struct KeyboardEvent keyboard;
+  };
+};
+
+typedef std::vector&lt;InputEvent&gt; InputEventLst;
+
+#endif
+
+/* EOF */

Deleted: trunk/src/input/input_event.hxx
===================================================================
--- trunk/src/input/input_event.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_event.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,71 +0,0 @@
-//  $Id: input_event.hxx,v 1.4 2003/10/31 23:24:41 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_INPUT_EVENT_HXX
-#define HEADER_INPUT_EVENT_HXX
-
-#include &lt;vector&gt;
-
-enum InputEventType { BUTTON_EVENT, AXIS_EVENT, KEYBOARD_EVENT };
-
-/** Used for textual input */
-struct KeyboardEvent
-{
-  enum KeyType { LETTER, SPECIAL } key_type;
-  int code;
-};
-
-struct ButtonEvent
-{
-  int name;
-
-  /** true if down, false if up */
-  bool down;
-
-  bool is_down() const { return down; }
-  bool is_up()   const { return !down; }
-};
-
-struct AxisEvent
-{
-  int name;
-
-  /** Pos can be in range from [-1.0, 1.0], some axis will only use [0,1.0] */
-  float pos;
-
-  float get_pos() { return pos; }
-};
-
-struct InputEvent 
-{
-  InputEventType type;
-    
-  union 
-  {
-    struct ButtonEvent   button;
-    struct AxisEvent     axis;
-    struct KeyboardEvent keyboard;
-  };
-};
-
-typedef std::vector&lt;InputEvent&gt; InputEventLst;
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/input_keyboard.hpp (from rev 502, trunk/src/input/input_keyboard.hxx)
===================================================================
--- trunk/src/input/input_keyboard.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_keyboard.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,43 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_KEYBOARD_HXX
+#define HEADER_INPUT_KEYBOARD_HXX
+
+#include &quot;input_event.hpp&quot;
+
+/** */
+class InputKeyboard
+{
+protected:
+  std::vector&lt;CL_Slot&gt; slots;
+  CL_Signal_v2&lt;KeyboardEvent::KeyType, int&gt; key;
+
+public:
+  InputKeyboard() {}
+  virtual ~InputKeyboard() {}
+  
+  virtual void update(float ) {}
+
+  CL_Signal_v2&lt;KeyboardEvent::KeyType, int&gt;&amp; on_key() { return key; }
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/input/input_keyboard.hxx
===================================================================
--- trunk/src/input/input_keyboard.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_keyboard.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,43 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_INPUT_KEYBOARD_HXX
-#define HEADER_INPUT_KEYBOARD_HXX
-
-#include &quot;input_event.hxx&quot;
-
-/** */
-class InputKeyboard
-{
-protected:
-  std::vector&lt;CL_Slot&gt; slots;
-  CL_Signal_v2&lt;KeyboardEvent::KeyType, int&gt; key;
-
-public:
-  InputKeyboard() {}
-  virtual ~InputKeyboard() {}
-  
-  virtual void update(float ) {}
-
-  CL_Signal_v2&lt;KeyboardEvent::KeyType, int&gt;&amp; on_key() { return key; }
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/input_keyboard_input_device.cpp (from rev 502, trunk/src/input/input_keyboard_input_device.cxx)
===================================================================
--- trunk/src/input/input_keyboard_input_device.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_keyboard_input_device.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,46 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ctype.h&gt;
+#include &lt;ClanLib/Display/input_event.h&gt;
+#include &quot;input_event.hpp&quot;
+#include &quot;input_keyboard_input_device.hpp&quot;
+
+InputKeyboardInputDevice::InputKeyboardInputDevice(CL_InputDevice&amp; dev_)
+  : dev(dev_)
+{
+  slots.push_back(dev.sig_key_down().connect(this, &amp;InputKeyboardInputDevice::on_key_down)); 
+  slots.push_back(dev.sig_key_up().connect(this, &amp;InputKeyboardInputDevice::on_key_up)); 
+}
+
+void
+InputKeyboardInputDevice::on_key_up(const CL_InputEvent&amp; )
+{
+}
+
+void
+InputKeyboardInputDevice::on_key_down(const CL_InputEvent&amp; event)
+{
+  if (!event.str.empty() &amp;&amp; (isgraph(event.str[0]) || event.str[0] == ' ' ||  event.str[0] == '\t'))
+    key(KeyboardEvent::LETTER, event.str[0]);
+  else
+    key(KeyboardEvent::SPECIAL, event.id);
+}
+
+/* EOF */

Deleted: trunk/src/input/input_keyboard_input_device.cxx
===================================================================
--- trunk/src/input/input_keyboard_input_device.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_keyboard_input_device.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,46 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ctype.h&gt;
-#include &lt;ClanLib/Display/input_event.h&gt;
-#include &quot;input_event.hxx&quot;
-#include &quot;input_keyboard_input_device.hxx&quot;
-
-InputKeyboardInputDevice::InputKeyboardInputDevice(CL_InputDevice&amp; dev_)
-  : dev(dev_)
-{
-  slots.push_back(dev.sig_key_down().connect(this, &amp;InputKeyboardInputDevice::on_key_down)); 
-  slots.push_back(dev.sig_key_up().connect(this, &amp;InputKeyboardInputDevice::on_key_up)); 
-}
-
-void
-InputKeyboardInputDevice::on_key_up(const CL_InputEvent&amp; )
-{
-}
-
-void
-InputKeyboardInputDevice::on_key_down(const CL_InputEvent&amp; event)
-{
-  if (!event.str.empty() &amp;&amp; (isgraph(event.str[0]) || event.str[0] == ' ' ||  event.str[0] == '\t'))
-    key(KeyboardEvent::LETTER, event.str[0]);
-  else
-    key(KeyboardEvent::SPECIAL, event.id);
-}
-
-/* EOF */

Copied: trunk/src/input/input_keyboard_input_device.hpp (from rev 502, trunk/src/input/input_keyboard_input_device.hxx)
===================================================================
--- trunk/src/input/input_keyboard_input_device.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_keyboard_input_device.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,42 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_KEYBOARD_INPUT_DEVICE_HXX
+#define HEADER_INPUT_KEYBOARD_INPUT_DEVICE_HXX
+
+#include &lt;ClanLib/Display/input_device.h&gt;
+#include &quot;input_keyboard.hpp&quot;
+
+/** */
+class InputKeyboardInputDevice : public InputKeyboard
+{
+private:
+  CL_InputDevice dev;
+
+  void on_key_up(const CL_InputEvent&amp; event);
+  void on_key_down(const CL_InputEvent&amp; event);
+
+public:
+  InputKeyboardInputDevice(CL_InputDevice&amp; dev);
+  void update(float) {}
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/input/input_keyboard_input_device.hxx
===================================================================
--- trunk/src/input/input_keyboard_input_device.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_keyboard_input_device.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,42 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_INPUT_KEYBOARD_INPUT_DEVICE_HXX
-#define HEADER_INPUT_KEYBOARD_INPUT_DEVICE_HXX
-
-#include &lt;ClanLib/Display/input_device.h&gt;
-#include &quot;input_keyboard.hxx&quot;
-
-/** */
-class InputKeyboardInputDevice : public InputKeyboard
-{
-private:
-  CL_InputDevice dev;
-
-  void on_key_up(const CL_InputEvent&amp; event);
-  void on_key_down(const CL_InputEvent&amp; event);
-
-public:
-  InputKeyboardInputDevice(CL_InputDevice&amp; dev);
-  void update(float) {}
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/input_manager.cpp (from rev 502, trunk/src/input/input_manager.cxx)
===================================================================
--- trunk/src/input/input_manager.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,96 @@
+//  $Id: input_manager.cxx,v 1.4 2003/08/20 00:15:10 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;iostream&gt;
+#include &lt;assert.h&gt;
+#include &lt;stdexcept&gt;
+#include &lt;sstream&gt;
+#include &lt;memory&gt;
+#include &lt;ClanLib/Display/joystick.h&gt;
+
+#include &quot;lisp/parser.hpp&quot;
+#include &quot;windstille_error.hpp&quot;
+#include &quot;input_manager_custom.hpp&quot;
+#include &quot;input_manager_player.hpp&quot;
+#include &quot;input_manager_impl.hpp&quot;
+#include &quot;input_recorder.hpp&quot;
+#include &quot;input_manager.hpp&quot;
+
+InputManagerImpl* InputManager::impl = 0;
+InputRecorder* InputManager::recorder = 0;
+
+void
+InputManager::init_playback(const std::string&amp; filename)
+{
+  impl = new InputManagerPlayer(filename);
+}
+
+void
+InputManager::init(const std::string&amp; filename)
+{
+  std::auto_ptr&lt;lisp::Lisp&gt; root (lisp::Parser::parse(filename));
+
+  const lisp::Lisp* controller = root-&gt;get_lisp(&quot;windstille-controller&quot;);
+  if(controller == 0) {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;'&quot; &lt;&lt; filename &lt;&lt; &quot;' is not a windstille-controller file&quot;;
+    throw std::runtime_error(msg.str());
+  }
+  
+  impl = new InputManagerCustom(controller);
+}
+
+void
+InputManager::setup_recorder(const std::string&amp; filename)
+{
+  if (recorder)
+    delete recorder;
+
+  recorder = new InputRecorder(filename);
+}
+
+void 
+InputManager::deinit()
+{
+  delete impl;
+}
+
+void
+InputManager::update(float delta)
+{
+  assert(impl);
+  impl-&gt;update(delta);
+  if (recorder)
+    recorder-&gt;record(get_controller());
+}
+
+Controller
+InputManager::get_controller()
+{
+  assert(impl);
+  return impl-&gt;get_controller();
+}
+
+void
+InputManager::clear()
+{
+  impl-&gt;clear();
+}
+
+/* EOF */

Deleted: trunk/src/input/input_manager.cxx
===================================================================
--- trunk/src/input/input_manager.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,96 +0,0 @@
-//  $Id: input_manager.cxx,v 1.4 2003/08/20 00:15:10 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;iostream&gt;
-#include &lt;assert.h&gt;
-#include &lt;stdexcept&gt;
-#include &lt;sstream&gt;
-#include &lt;memory&gt;
-#include &lt;ClanLib/Display/joystick.h&gt;
-
-#include &quot;lisp/parser.hpp&quot;
-#include &quot;windstille_error.hxx&quot;
-#include &quot;input_manager_custom.hxx&quot;
-#include &quot;input_manager_player.hxx&quot;
-#include &quot;input_manager_impl.hxx&quot;
-#include &quot;input_recorder.hxx&quot;
-#include &quot;input_manager.hxx&quot;
-
-InputManagerImpl* InputManager::impl = 0;
-InputRecorder* InputManager::recorder = 0;
-
-void
-InputManager::init_playback(const std::string&amp; filename)
-{
-  impl = new InputManagerPlayer(filename);
-}
-
-void
-InputManager::init(const std::string&amp; filename)
-{
-  std::auto_ptr&lt;lisp::Lisp&gt; root (lisp::Parser::parse(filename));
-
-  const lisp::Lisp* controller = root-&gt;get_lisp(&quot;windstille-controller&quot;);
-  if(controller == 0) {
-    std::ostringstream msg;
-    msg &lt;&lt; &quot;'&quot; &lt;&lt; filename &lt;&lt; &quot;' is not a windstille-controller file&quot;;
-    throw std::runtime_error(msg.str());
-  }
-  
-  impl = new InputManagerCustom(controller);
-}
-
-void
-InputManager::setup_recorder(const std::string&amp; filename)
-{
-  if (recorder)
-    delete recorder;
-
-  recorder = new InputRecorder(filename);
-}
-
-void 
-InputManager::deinit()
-{
-  delete impl;
-}
-
-void
-InputManager::update(float delta)
-{
-  assert(impl);
-  impl-&gt;update(delta);
-  if (recorder)
-    recorder-&gt;record(get_controller());
-}
-
-Controller
-InputManager::get_controller()
-{
-  assert(impl);
-  return impl-&gt;get_controller();
-}
-
-void
-InputManager::clear()
-{
-  impl-&gt;clear();
-}
-
-/* EOF */

Copied: trunk/src/input/input_manager.hpp (from rev 502, trunk/src/input/input_manager.hxx)
===================================================================
--- trunk/src/input/input_manager.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,57 @@
+//  $Id: input_manager.hpp,v 1.3 2003/06/06 18:36:24 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_MANAGER_HXX
+#define HEADER_INPUT_MANAGER_HXX
+
+#include &lt;vector&gt;
+#include &quot;controller.hpp&quot;
+#include &quot;input_event.hpp&quot;
+
+class InputRecorder;
+class InputManagerImpl;
+
+/** */
+class InputManager
+{
+private:
+  static InputManagerImpl* impl;
+  static InputRecorder* recorder;
+public:
+  /** Init the InputManager with the data found in \a filename */
+  static void init(const std::string&amp; filename = std::string());
+
+  /** Init the playback of a previously recorded file */
+  static void init_playback(const std::string&amp; filenam);
+  static void deinit();
+
+  /** Record all input events to \a filename */
+  static void setup_recorder(const std::string&amp; filename);
+
+  static void update(float delta);
+  static Controller get_controller();
+  static void clear();
+private:
+  InputManager(const InputManager&amp;);
+  InputManager&amp; operator=(const InputManager&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/input/input_manager.hxx
===================================================================
--- trunk/src/input/input_manager.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,57 +0,0 @@
-//  $Id: input_manager.hxx,v 1.3 2003/06/06 18:36:24 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_INPUT_MANAGER_HXX
-#define HEADER_INPUT_MANAGER_HXX
-
-#include &lt;vector&gt;
-#include &quot;controller.hxx&quot;
-#include &quot;input_event.hxx&quot;
-
-class InputRecorder;
-class InputManagerImpl;
-
-/** */
-class InputManager
-{
-private:
-  static InputManagerImpl* impl;
-  static InputRecorder* recorder;
-public:
-  /** Init the InputManager with the data found in \a filename */
-  static void init(const std::string&amp; filename = std::string());
-
-  /** Init the playback of a previously recorded file */
-  static void init_playback(const std::string&amp; filenam);
-  static void deinit();
-
-  /** Record all input events to \a filename */
-  static void setup_recorder(const std::string&amp; filename);
-
-  static void update(float delta);
-  static Controller get_controller();
-  static void clear();
-private:
-  InputManager(const InputManager&amp;);
-  InputManager&amp; operator=(const InputManager&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/input_manager_custom.cpp (from rev 502, trunk/src/input/input_manager_custom.cxx)
===================================================================
--- trunk/src/input/input_manager_custom.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager_custom.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,164 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;iostream&gt;
+#include &lt;ClanLib/Display/keyboard.h&gt;
+#include &lt;ClanLib/Display/joystick.h&gt;
+#include &lt;ClanLib/Display/display_iostream.h&gt;
+#include &lt;ClanLib/Display/keys.h&gt;
+
+#include &quot;lisp/list_iterator.hpp&quot;
+#include &quot;controller_def.hpp&quot;
+#include &quot;input_button_input_device.hpp&quot;
+#include &quot;input_axis_input_device.hpp&quot;
+#include &quot;input_keyboard_input_device.hpp&quot;
+#include &quot;button_factory.hpp&quot;
+#include &quot;axis_factory.hpp&quot;
+
+#include &quot;input_manager_custom.hpp&quot;
+
+InputManagerCustom::InputManagerCustom(const lisp::Lisp* lisp)
+{
+  init(lisp);
+
+  for (int i = 0; i &lt; (int)buttons.size(); ++i)
+    {
+      if (buttons[i])
+        {
+          slots.push_back(buttons[i]-&gt;on_key_down().connect(this, &amp;InputManagerCustom::on_button_down, i));
+          slots.push_back(buttons[i]-&gt;on_key_up().connect  (this, &amp;InputManagerCustom::on_button_up,   i));
+        }
+      else
+        {
+          std::cout &lt;&lt; &quot;# Warrning: Button '&quot; &lt;&lt; ControllerDef::button_id2name(i)
+                    &lt;&lt; &quot;' not configured and will not be usable&quot; &lt;&lt; std::endl;
+        }
+    }
+
+  for (int i = 0; i &lt; (int)axes.size(); ++i)
+    {
+      if (axes[i])
+        {
+          slots.push_back(axes[i]-&gt;on_move().connect(this, &amp;InputManagerCustom::on_axis_move, i));
+        }
+      else
+        {
+          std::cout &lt;&lt; &quot;# Warrning: Axis '&quot; &lt;&lt; ControllerDef::axis_id2name(i)
+                    &lt;&lt; &quot;' not configured and will not be usable&quot; &lt;&lt; std::endl;
+        }
+    }
+
+  for (int i = 0; i &lt; (int)keyboards.size(); ++i)
+    {
+      if (keyboards[i])
+        {
+          slots.push_back(keyboards[i]-&gt;on_key().connect(this, &amp;InputManagerCustom::on_key));
+        }
+      else
+        {
+          std::cout &lt;&lt; &quot;# Warrning: Keyboard not configured&quot; &lt;&lt; std::endl;
+        }
+    }
+}
+
+void 
+InputManagerCustom::init(const lisp::Lisp* lisp)
+{
+  buttons.resize(ControllerDef::get_button_count());
+  axes.resize(ControllerDef::get_axis_count());
+  keyboards.resize(ControllerDef::get_keyboard_count());
+
+  lisp::ListIterator iter(lisp);
+  while(iter.next()) {
+    std::string name = iter.item();
+
+    int id = ControllerDef::button_name2id(name);
+    if (id != -1)
+      {
+        buttons[id] = ButtonFactory::create(iter.lisp());
+      }
+    else if (name == &quot;keyboard&quot;)
+      {
+        keyboards[0] = new InputKeyboardInputDevice(CL_Keyboard::get_device());
+      }
+    else
+      {
+        id = ControllerDef::axis_name2id(name);
+        if (id != -1)
+          {
+            axes[id] = AxisFactory::create(iter.lisp());
+          }
+        else
+          {
+            std::cout &lt;&lt; &quot;# Warning: InputManagerCustom::init: Error unknown tag: &quot; &lt;&lt; std::endl;
+          }
+      }
+  }
+}  
+
+void
+InputManagerCustom::on_axis_move(float pos, int name)
+{
+  add_axis_event(name, pos);
+  controller.set_axis_state(name, pos);
+}
+
+void
+InputManagerCustom::on_button_up(int name)
+{
+  add_button_event(name, false);
+  controller.set_button_state(name, false);
+}
+
+void
+InputManagerCustom::on_button_down(int name)
+{
+  add_button_event(name, true);
+  controller.set_button_state(name, true);
+}
+
+void
+InputManagerCustom::on_key(KeyboardEvent::KeyType key_type, int code)
+{
+  add_keyboard_event(0, key_type, code);
+}
+
+void
+InputManagerCustom::update(float delta)
+{
+  for (int i = 0; i &lt; (int)buttons.size(); ++i)
+    {
+      if (buttons[i])
+        buttons[i]-&gt;update(delta);
+    }
+
+  for (int i = 0; i &lt; (int)axes.size(); ++i)
+    {
+      if (axes[i])
+        axes[i]-&gt;update(delta);
+    }
+
+  for (int i = 0; i &lt; (int)keyboards.size(); ++i)
+    {
+      if (keyboards[i])
+        keyboards[i]-&gt;update(delta);
+    }
+}
+
+/* EOF */

Deleted: trunk/src/input/input_manager_custom.cxx
===================================================================
--- trunk/src/input/input_manager_custom.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager_custom.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,164 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;iostream&gt;
-#include &lt;ClanLib/Display/keyboard.h&gt;
-#include &lt;ClanLib/Display/joystick.h&gt;
-#include &lt;ClanLib/Display/display_iostream.h&gt;
-#include &lt;ClanLib/Display/keys.h&gt;
-
-#include &quot;lisp/list_iterator.hpp&quot;
-#include &quot;controller_def.hxx&quot;
-#include &quot;input_button_input_device.hxx&quot;
-#include &quot;input_axis_input_device.hxx&quot;
-#include &quot;input_keyboard_input_device.hxx&quot;
-#include &quot;button_factory.hxx&quot;
-#include &quot;axis_factory.hxx&quot;
-
-#include &quot;input_manager_custom.hxx&quot;
-
-InputManagerCustom::InputManagerCustom(const lisp::Lisp* lisp)
-{
-  init(lisp);
-
-  for (int i = 0; i &lt; (int)buttons.size(); ++i)
-    {
-      if (buttons[i])
-        {
-          slots.push_back(buttons[i]-&gt;on_key_down().connect(this, &amp;InputManagerCustom::on_button_down, i));
-          slots.push_back(buttons[i]-&gt;on_key_up().connect  (this, &amp;InputManagerCustom::on_button_up,   i));
-        }
-      else
-        {
-          std::cout &lt;&lt; &quot;# Warrning: Button '&quot; &lt;&lt; ControllerDef::button_id2name(i)
-                    &lt;&lt; &quot;' not configured and will not be usable&quot; &lt;&lt; std::endl;
-        }
-    }
-
-  for (int i = 0; i &lt; (int)axes.size(); ++i)
-    {
-      if (axes[i])
-        {
-          slots.push_back(axes[i]-&gt;on_move().connect(this, &amp;InputManagerCustom::on_axis_move, i));
-        }
-      else
-        {
-          std::cout &lt;&lt; &quot;# Warrning: Axis '&quot; &lt;&lt; ControllerDef::axis_id2name(i)
-                    &lt;&lt; &quot;' not configured and will not be usable&quot; &lt;&lt; std::endl;
-        }
-    }
-
-  for (int i = 0; i &lt; (int)keyboards.size(); ++i)
-    {
-      if (keyboards[i])
-        {
-          slots.push_back(keyboards[i]-&gt;on_key().connect(this, &amp;InputManagerCustom::on_key));
-        }
-      else
-        {
-          std::cout &lt;&lt; &quot;# Warrning: Keyboard not configured&quot; &lt;&lt; std::endl;
-        }
-    }
-}
-
-void 
-InputManagerCustom::init(const lisp::Lisp* lisp)
-{
-  buttons.resize(ControllerDef::get_button_count());
-  axes.resize(ControllerDef::get_axis_count());
-  keyboards.resize(ControllerDef::get_keyboard_count());
-
-  lisp::ListIterator iter(lisp);
-  while(iter.next()) {
-    std::string name = iter.item();
-
-    int id = ControllerDef::button_name2id(name);
-    if (id != -1)
-      {
-        buttons[id] = ButtonFactory::create(iter.lisp());
-      }
-    else if (name == &quot;keyboard&quot;)
-      {
-        keyboards[0] = new InputKeyboardInputDevice(CL_Keyboard::get_device());
-      }
-    else
-      {
-        id = ControllerDef::axis_name2id(name);
-        if (id != -1)
-          {
-            axes[id] = AxisFactory::create(iter.lisp());
-          }
-        else
-          {
-            std::cout &lt;&lt; &quot;# Warning: InputManagerCustom::init: Error unknown tag: &quot; &lt;&lt; std::endl;
-          }
-      }
-  }
-}  
-
-void
-InputManagerCustom::on_axis_move(float pos, int name)
-{
-  add_axis_event(name, pos);
-  controller.set_axis_state(name, pos);
-}
-
-void
-InputManagerCustom::on_button_up(int name)
-{
-  add_button_event(name, false);
-  controller.set_button_state(name, false);
-}
-
-void
-InputManagerCustom::on_button_down(int name)
-{
-  add_button_event(name, true);
-  controller.set_button_state(name, true);
-}
-
-void
-InputManagerCustom::on_key(KeyboardEvent::KeyType key_type, int code)
-{
-  add_keyboard_event(0, key_type, code);
-}
-
-void
-InputManagerCustom::update(float delta)
-{
-  for (int i = 0; i &lt; (int)buttons.size(); ++i)
-    {
-      if (buttons[i])
-        buttons[i]-&gt;update(delta);
-    }
-
-  for (int i = 0; i &lt; (int)axes.size(); ++i)
-    {
-      if (axes[i])
-        axes[i]-&gt;update(delta);
-    }
-
-  for (int i = 0; i &lt; (int)keyboards.size(); ++i)
-    {
-      if (keyboards[i])
-        keyboards[i]-&gt;update(delta);
-    }
-}
-
-/* EOF */

Copied: trunk/src/input/input_manager_custom.hpp (from rev 502, trunk/src/input/input_manager_custom.hxx)
===================================================================
--- trunk/src/input/input_manager_custom.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager_custom.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,64 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_MANAGER_CUSTOM_HXX
+#define HEADER_INPUT_MANAGER_CUSTOM_HXX
+
+#include &lt;ClanLib/Display/input_device.h&gt;
+#include &lt;ClanLib/Display/input_event.h&gt;
+#include &quot;input_event.hpp&quot;
+#include &quot;input_button.hpp&quot;
+#include &quot;input_axis.hpp&quot;
+#include &quot;input_keyboard.hpp&quot;
+#include &quot;input_manager_impl.hpp&quot;
+#include &quot;lisp/lisp.hpp&quot;
+
+/** */
+class InputManagerCustom : public InputManagerImpl
+{
+private:
+  std::vector&lt;CL_Slot&gt; slots;
+
+  typedef std::vector&lt;InputAxis*&gt;     Axes;
+  typedef std::vector&lt;InputButton*&gt;   Buttons;
+  typedef std::vector&lt;InputKeyboard*&gt; Keyboards;
+
+  Axes      axes;
+  Buttons   buttons;
+  Keyboards keyboards;
+
+public:
+  InputManagerCustom(const lisp::Lisp* lisp);
+  
+  void update(float delta);
+
+  void on_button_up(int name);
+  void on_button_down(int name);
+  void on_axis_move(float pos, int name);
+  void on_key(KeyboardEvent::KeyType key_type, int code);
+private:
+  void init(const lisp::Lisp* lisp);
+
+  InputManagerCustom (const InputManagerCustom&amp;);
+  InputManagerCustom&amp; operator= (const InputManagerCustom&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/input/input_manager_custom.hxx
===================================================================
--- trunk/src/input/input_manager_custom.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager_custom.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,64 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_INPUT_MANAGER_CUSTOM_HXX
-#define HEADER_INPUT_MANAGER_CUSTOM_HXX
-
-#include &lt;ClanLib/Display/input_device.h&gt;
-#include &lt;ClanLib/Display/input_event.h&gt;
-#include &quot;input_event.hxx&quot;
-#include &quot;input_button.hxx&quot;
-#include &quot;input_axis.hxx&quot;
-#include &quot;input_keyboard.hxx&quot;
-#include &quot;input_manager_impl.hxx&quot;
-#include &quot;lisp/lisp.hpp&quot;
-
-/** */
-class InputManagerCustom : public InputManagerImpl
-{
-private:
-  std::vector&lt;CL_Slot&gt; slots;
-
-  typedef std::vector&lt;InputAxis*&gt;     Axes;
-  typedef std::vector&lt;InputButton*&gt;   Buttons;
-  typedef std::vector&lt;InputKeyboard*&gt; Keyboards;
-
-  Axes      axes;
-  Buttons   buttons;
-  Keyboards keyboards;
-
-public:
-  InputManagerCustom(const lisp::Lisp* lisp);
-  
-  void update(float delta);
-
-  void on_button_up(int name);
-  void on_button_down(int name);
-  void on_axis_move(float pos, int name);
-  void on_key(KeyboardEvent::KeyType key_type, int code);
-private:
-  void init(const lisp::Lisp* lisp);
-
-  InputManagerCustom (const InputManagerCustom&amp;);
-  InputManagerCustom&amp; operator= (const InputManagerCustom&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/input_manager_impl.cpp (from rev 502, trunk/src/input/input_manager_impl.cxx)
===================================================================
--- trunk/src/input/input_manager_impl.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager_impl.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,71 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;input_manager_impl.hpp&quot;
+
+InputEventLst
+InputManagerImpl::get_events()
+{
+  return events;
+}
+
+Controller
+InputManagerImpl::get_controller()
+{
+  controller.set_events(events);
+  return controller;
+}
+
+void
+InputManagerImpl::add_axis_event(int name, float pos)
+{
+  InputEvent event;
+  event.type = AXIS_EVENT;
+  event.axis.name = name;
+  event.axis.pos  = pos;
+  events.push_back(event);
+}
+
+void
+InputManagerImpl::add_button_event(int name, bool down)
+{
+  InputEvent event;
+  event.type = BUTTON_EVENT;
+  event.button.name = name;
+  event.button.down = down;
+  events.push_back(event);
+}
+
+void
+InputManagerImpl::add_keyboard_event(int name, KeyboardEvent::KeyType key_type, int code)
+{
+  InputEvent event;
+  event.type = KEYBOARD_EVENT;
+  event.keyboard.key_type = key_type;
+  event.keyboard.code     = code;
+  events.push_back(event);  
+}
+
+void
+InputManagerImpl::clear()
+{
+  events.clear();
+}
+
+/* EOF */

Deleted: trunk/src/input/input_manager_impl.cxx
===================================================================
--- trunk/src/input/input_manager_impl.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager_impl.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,71 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;input_manager_impl.hxx&quot;
-
-InputEventLst
-InputManagerImpl::get_events()
-{
-  return events;
-}
-
-Controller
-InputManagerImpl::get_controller()
-{
-  controller.set_events(events);
-  return controller;
-}
-
-void
-InputManagerImpl::add_axis_event(int name, float pos)
-{
-  InputEvent event;
-  event.type = AXIS_EVENT;
-  event.axis.name = name;
-  event.axis.pos  = pos;
-  events.push_back(event);
-}
-
-void
-InputManagerImpl::add_button_event(int name, bool down)
-{
-  InputEvent event;
-  event.type = BUTTON_EVENT;
-  event.button.name = name;
-  event.button.down = down;
-  events.push_back(event);
-}
-
-void
-InputManagerImpl::add_keyboard_event(int name, KeyboardEvent::KeyType key_type, int code)
-{
-  InputEvent event;
-  event.type = KEYBOARD_EVENT;
-  event.keyboard.key_type = key_type;
-  event.keyboard.code     = code;
-  events.push_back(event);  
-}
-
-void
-InputManagerImpl::clear()
-{
-  events.clear();
-}
-
-/* EOF */

Copied: trunk/src/input/input_manager_impl.hpp (from rev 502, trunk/src/input/input_manager_impl.hxx)
===================================================================
--- trunk/src/input/input_manager_impl.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager_impl.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,54 @@
+//  $Id: input_manager_impl.hpp,v 1.3 2003/06/06 18:36:24 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_MANAGER_IMPL_HXX
+#define HEADER_INPUT_MANAGER_IMPL_HXX
+
+#include &quot;controller.hpp&quot;
+#include &quot;input_event.hpp&quot;
+
+/** */
+class InputManagerImpl
+{
+protected:
+  Controller controller;
+  InputEventLst events;
+
+public:
+  InputManagerImpl() {}
+  virtual ~InputManagerImpl() {}
+
+  virtual void update(float delta) =0;
+  
+  InputEventLst get_events();
+
+  Controller get_controller();
+  void clear();
+
+  void add_axis_event  (int name, float pos);
+  void add_button_event(int name, bool down);
+  void add_keyboard_event(int name, KeyboardEvent::KeyType key_type, int code);
+private:
+  InputManagerImpl(const InputManagerImpl&amp;);
+  InputManagerImpl&amp; operator=(const InputManagerImpl&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/input/input_manager_impl.hxx
===================================================================
--- trunk/src/input/input_manager_impl.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager_impl.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,54 +0,0 @@
-//  $Id: input_manager_impl.hxx,v 1.3 2003/06/06 18:36:24 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_INPUT_MANAGER_IMPL_HXX
-#define HEADER_INPUT_MANAGER_IMPL_HXX
-
-#include &quot;controller.hxx&quot;
-#include &quot;input_event.hxx&quot;
-
-/** */
-class InputManagerImpl
-{
-protected:
-  Controller controller;
-  InputEventLst events;
-
-public:
-  InputManagerImpl() {}
-  virtual ~InputManagerImpl() {}
-
-  virtual void update(float delta) =0;
-  
-  InputEventLst get_events();
-
-  Controller get_controller();
-  void clear();
-
-  void add_axis_event  (int name, float pos);
-  void add_button_event(int name, bool down);
-  void add_keyboard_event(int name, KeyboardEvent::KeyType key_type, int code);
-private:
-  InputManagerImpl(const InputManagerImpl&amp;);
-  InputManagerImpl&amp; operator=(const InputManagerImpl&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/input_manager_player.cpp (from rev 502, trunk/src/input/input_manager_player.cxx)
===================================================================
--- trunk/src/input/input_manager_player.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager_player.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,98 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;iostream&gt;
+#include &quot;input_manager_player.hpp&quot;
+
+InputManagerPlayer::InputManagerPlayer(const std::string&amp; filename)
+{
+  (void) filename;
+#if 0
+  // FIXME
+  std::cout &lt;&lt; &quot;InputManagerPlayer::InputManagerPlayer(&quot; &lt;&lt; filename &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;
+  entry_counter = 0;
+  lisp_object_t* port = lisp_read_from_file(filename.c_str());
+  lisp_object_t* entry;
+  while(scm_eof_object_p(entry = scm_read(port)) == lisp_object_t*_BOOL_F)
+    {
+      InputEventLst lst;
+      int entry_num = lisp_scm2int(lisp_cadr(entry));
+      entry = lisp_cddr(entry);
+      
+      while(lisp_cons_p(entry))
+        {
+          lst.push_back(scm2event(lisp_car(entry)));
+          entry = lisp_cdr(entry);
+        }
+      entries.push(Entry(entry_num, lst));
+    }
+  scm_close_port(port);
+#endif 
+}
+
+InputEvent
+InputManagerPlayer::scm2event(const lisp::Lisp* )
+{
+  InputEvent event;
+#if 0
+  lisp_object_t* sym  = lisp_car(entry);
+  lisp_object_t* data = lisp_cdr(entry);
+
+  if (strcmp(&quot;axis&quot;, lisp_symbol(sym)) == 0)
+    {
+      event.type = AXIS_EVENT;
+      event.axis.name = lisp_integer(lisp_list_nth(data, 0));
+      event.axis.pos  = lisp_real   (lisp_list_nth(data, 1));
+    } 
+  else if (strcmp(&quot;button&quot;, lisp_symbol(sym)) == 0)
+    {
+      event.type = BUTTON_EVENT;
+      event.button.name = lisp_integer(lisp_list_nth(data, 0));
+      event.button.down = lisp_real   (lisp_list_nth(data, 1));
+    } 
+  else 
+    {
+      std::cout &lt;&lt; &quot;scm2event: Unknown sym: &quot; &lt;&lt; std::endl; //Guile::scm2string(sym) &lt;&lt; std::endl;
+    }
+#endif
+  return event;
+}
+  
+void
+InputManagerPlayer::update(float delta)
+{
+  (void) delta;
+  if (entries.front().entry_num == entry_counter)
+    {
+      events = entries.front().events;
+      
+      for (InputEventLst::iterator i = events.begin(); i != events.end(); ++i)
+        {
+          if (i-&gt;type == AXIS_EVENT)
+            controller.set_axis_state(i-&gt;axis.name, i-&gt;axis.pos);
+          else if  (i-&gt;type == BUTTON_EVENT)
+            controller.set_button_state(i-&gt;button.name, i-&gt;button.down);
+        }
+      entries.pop();
+    }
+
+  entry_counter += 1;
+}
+
+/* EOF */

Deleted: trunk/src/input/input_manager_player.cxx
===================================================================
--- trunk/src/input/input_manager_player.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager_player.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,98 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;iostream&gt;
-#include &quot;input_manager_player.hxx&quot;
-
-InputManagerPlayer::InputManagerPlayer(const std::string&amp; filename)
-{
-  (void) filename;
-#if 0
-  // FIXME
-  std::cout &lt;&lt; &quot;InputManagerPlayer::InputManagerPlayer(&quot; &lt;&lt; filename &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;
-  entry_counter = 0;
-  lisp_object_t* port = lisp_read_from_file(filename.c_str());
-  lisp_object_t* entry;
-  while(scm_eof_object_p(entry = scm_read(port)) == lisp_object_t*_BOOL_F)
-    {
-      InputEventLst lst;
-      int entry_num = lisp_scm2int(lisp_cadr(entry));
-      entry = lisp_cddr(entry);
-      
-      while(lisp_cons_p(entry))
-        {
-          lst.push_back(scm2event(lisp_car(entry)));
-          entry = lisp_cdr(entry);
-        }
-      entries.push(Entry(entry_num, lst));
-    }
-  scm_close_port(port);
-#endif 
-}
-
-InputEvent
-InputManagerPlayer::scm2event(const lisp::Lisp* )
-{
-  InputEvent event;
-#if 0
-  lisp_object_t* sym  = lisp_car(entry);
-  lisp_object_t* data = lisp_cdr(entry);
-
-  if (strcmp(&quot;axis&quot;, lisp_symbol(sym)) == 0)
-    {
-      event.type = AXIS_EVENT;
-      event.axis.name = lisp_integer(lisp_list_nth(data, 0));
-      event.axis.pos  = lisp_real   (lisp_list_nth(data, 1));
-    } 
-  else if (strcmp(&quot;button&quot;, lisp_symbol(sym)) == 0)
-    {
-      event.type = BUTTON_EVENT;
-      event.button.name = lisp_integer(lisp_list_nth(data, 0));
-      event.button.down = lisp_real   (lisp_list_nth(data, 1));
-    } 
-  else 
-    {
-      std::cout &lt;&lt; &quot;scm2event: Unknown sym: &quot; &lt;&lt; std::endl; //Guile::scm2string(sym) &lt;&lt; std::endl;
-    }
-#endif
-  return event;
-}
-  
-void
-InputManagerPlayer::update(float delta)
-{
-  (void) delta;
-  if (entries.front().entry_num == entry_counter)
-    {
-      events = entries.front().events;
-      
-      for (InputEventLst::iterator i = events.begin(); i != events.end(); ++i)
-        {
-          if (i-&gt;type == AXIS_EVENT)
-            controller.set_axis_state(i-&gt;axis.name, i-&gt;axis.pos);
-          else if  (i-&gt;type == BUTTON_EVENT)
-            controller.set_button_state(i-&gt;button.name, i-&gt;button.down);
-        }
-      entries.pop();
-    }
-
-  entry_counter += 1;
-}
-
-/* EOF */

Copied: trunk/src/input/input_manager_player.hpp (from rev 502, trunk/src/input/input_manager_player.hxx)
===================================================================
--- trunk/src/input/input_manager_player.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager_player.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,55 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_MANAGER_PLAYER_HXX
+#define HEADER_INPUT_MANAGER_PLAYER_HXX
+
+#include &lt;queue&gt;
+#include &lt;string&gt;
+#include &quot;input_manager_impl.hpp&quot;
+#include &quot;lisp/lisp.hpp&quot;
+
+/** Playback class for events recorded my the InputRecorder */
+class InputManagerPlayer : public InputManagerImpl
+{
+private:
+  struct Entry {
+    Entry(int num, const InputEventLst&amp; lst) 
+      : entry_num(num), events(lst)
+    {}
+    int entry_num;
+    InputEventLst events;
+  };
+
+  int entry_counter;
+  std::queue&lt;Entry&gt; entries;
+public:
+  InputManagerPlayer(const std::string&amp; filename);
+  
+  void update(float delta);
+private:
+  InputEvent scm2event(const lisp::Lisp* lisp);
+
+  InputManagerPlayer (const InputManagerPlayer&amp;);
+  InputManagerPlayer&amp; operator= (const InputManagerPlayer&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/input/input_manager_player.hxx
===================================================================
--- trunk/src/input/input_manager_player.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_manager_player.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,55 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_INPUT_MANAGER_PLAYER_HXX
-#define HEADER_INPUT_MANAGER_PLAYER_HXX
-
-#include &lt;queue&gt;
-#include &lt;string&gt;
-#include &quot;input_manager_impl.hxx&quot;
-#include &quot;lisp/lisp.hpp&quot;
-
-/** Playback class for events recorded my the InputRecorder */
-class InputManagerPlayer : public InputManagerImpl
-{
-private:
-  struct Entry {
-    Entry(int num, const InputEventLst&amp; lst) 
-      : entry_num(num), events(lst)
-    {}
-    int entry_num;
-    InputEventLst events;
-  };
-
-  int entry_counter;
-  std::queue&lt;Entry&gt; entries;
-public:
-  InputManagerPlayer(const std::string&amp; filename);
-  
-  void update(float delta);
-private:
-  InputEvent scm2event(const lisp::Lisp* lisp);
-
-  InputManagerPlayer (const InputManagerPlayer&amp;);
-  InputManagerPlayer&amp; operator= (const InputManagerPlayer&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/input_recorder.cpp (from rev 502, trunk/src/input/input_recorder.cxx)
===================================================================
--- trunk/src/input/input_recorder.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_recorder.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,65 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;input_recorder.hpp&quot;
+
+InputRecorder::InputRecorder(const std::string&amp; filename)
+  : out(filename.c_str())
+{
+  entry_counter = 0;
+}
+
+InputRecorder::~InputRecorder()
+{
+  out.close();
+}
+
+void
+InputRecorder::record(const Controller&amp; controller)
+{
+  InputEventLst lst = controller.get_events();
+
+  if (!lst.empty())
+    {
+      out &lt;&lt; &quot;(entry &quot; &lt;&lt; entry_counter &lt;&lt; std::endl;
+ 
+      for (InputEventLst::iterator i = lst.begin(); i != lst.end(); ++i)
+        {
+          switch(i-&gt;type)
+            {
+            case AXIS_EVENT:
+              out &lt;&lt; &quot;  (axis &quot; &lt;&lt; i-&gt;axis.name &lt;&lt; &quot; &quot; &lt;&lt; i-&gt;axis.get_pos() &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;
+              break;
+          
+            case BUTTON_EVENT:
+              out &lt;&lt; &quot;  (button &quot; &lt;&lt; i-&gt;button.name &lt;&lt; &quot; &quot; &lt;&lt; i-&gt;button.down &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;
+              break;
+              
+            case KEYBOARD_EVENT:
+              out &lt;&lt; &quot;  (keyboard &quot; &lt;&lt; i-&gt;keyboard.key_type &lt;&lt; &quot; &quot; &lt;&lt; i-&gt;keyboard.code &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;
+              break;
+            }
+        }
+      out &lt;&lt; &quot;)\n&quot; &lt;&lt; std::endl;
+    }
+
+  entry_counter += 1;
+}
+
+/* EOF */

Deleted: trunk/src/input/input_recorder.cxx
===================================================================
--- trunk/src/input/input_recorder.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_recorder.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,65 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;input_recorder.hxx&quot;
-
-InputRecorder::InputRecorder(const std::string&amp; filename)
-  : out(filename.c_str())
-{
-  entry_counter = 0;
-}
-
-InputRecorder::~InputRecorder()
-{
-  out.close();
-}
-
-void
-InputRecorder::record(const Controller&amp; controller)
-{
-  InputEventLst lst = controller.get_events();
-
-  if (!lst.empty())
-    {
-      out &lt;&lt; &quot;(entry &quot; &lt;&lt; entry_counter &lt;&lt; std::endl;
- 
-      for (InputEventLst::iterator i = lst.begin(); i != lst.end(); ++i)
-        {
-          switch(i-&gt;type)
-            {
-            case AXIS_EVENT:
-              out &lt;&lt; &quot;  (axis &quot; &lt;&lt; i-&gt;axis.name &lt;&lt; &quot; &quot; &lt;&lt; i-&gt;axis.get_pos() &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;
-              break;
-          
-            case BUTTON_EVENT:
-              out &lt;&lt; &quot;  (button &quot; &lt;&lt; i-&gt;button.name &lt;&lt; &quot; &quot; &lt;&lt; i-&gt;button.down &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;
-              break;
-              
-            case KEYBOARD_EVENT:
-              out &lt;&lt; &quot;  (keyboard &quot; &lt;&lt; i-&gt;keyboard.key_type &lt;&lt; &quot; &quot; &lt;&lt; i-&gt;keyboard.code &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;
-              break;
-            }
-        }
-      out &lt;&lt; &quot;)\n&quot; &lt;&lt; std::endl;
-    }
-
-  entry_counter += 1;
-}
-
-/* EOF */

Copied: trunk/src/input/input_recorder.hpp (from rev 502, trunk/src/input/input_recorder.hxx)
===================================================================
--- trunk/src/input/input_recorder.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_recorder.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,46 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_INPUT_RECORDER_HXX
+#define HEADER_INPUT_RECORDER_HXX
+
+#include &lt;fstream&gt;
+#include &quot;controller.hpp&quot;
+
+/** The InputRecorder hooks into the InputManager and records all
+    input events to a file, thus allowing the later playback of the
+    events. */
+class InputRecorder
+{
+private:
+  std::ofstream out;
+  int entry_counter;
+public:
+  InputRecorder(const std::string&amp; filename);
+  ~InputRecorder();
+
+  void record(const Controller&amp; controller);
+private:
+  InputRecorder (const InputRecorder&amp;);
+  InputRecorder&amp; operator= (const InputRecorder&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/input/input_recorder.hxx
===================================================================
--- trunk/src/input/input_recorder.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/input_recorder.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,46 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_INPUT_RECORDER_HXX
-#define HEADER_INPUT_RECORDER_HXX
-
-#include &lt;fstream&gt;
-#include &quot;controller.hxx&quot;
-
-/** The InputRecorder hooks into the InputManager and records all
-    input events to a file, thus allowing the later playback of the
-    events. */
-class InputRecorder
-{
-private:
-  std::ofstream out;
-  int entry_counter;
-public:
-  InputRecorder(const std::string&amp; filename);
-  ~InputRecorder();
-
-  void record(const Controller&amp; controller);
-private:
-  InputRecorder (const InputRecorder&amp;);
-  InputRecorder&amp; operator= (const InputRecorder&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/input/multi_button.cpp (from rev 502, trunk/src/input/multi_button.cxx)
===================================================================
--- trunk/src/input/multi_button.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/multi_button.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,65 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;iostream&gt;
+#include &quot;multi_button.hpp&quot;
+
+MultiButton::MultiButton()
+{
+  press_count = 0;
+}
+
+void
+MultiButton::add(InputButton* button)
+{
+  buttons.push_back(button);
+  slots.push_back(button-&gt;on_key_down().connect(this, &amp;MultiButton::pressed));
+  slots.push_back(button-&gt;on_key_up().connect(this, &amp;MultiButton::released));
+}
+
+void
+MultiButton::update(float delta)
+{
+  for (Buttons::iterator i = buttons.begin(); i != buttons.end(); ++i)
+    (*i)-&gt;update(delta);
+}
+
+void
+MultiButton::released()
+{
+  press_count -= 1;
+
+  if (press_count == 0)
+    button_up();
+
+  // FIXME: Workaround
+  if (press_count &lt; 0)
+    press_count = 0;
+}
+
+void
+MultiButton::pressed()
+{
+  press_count += 1;
+
+  if (press_count == 1)
+    button_down();
+}
+
+/* EOF */

Deleted: trunk/src/input/multi_button.cxx
===================================================================
--- trunk/src/input/multi_button.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/multi_button.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,65 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;iostream&gt;
-#include &quot;multi_button.hxx&quot;
-
-MultiButton::MultiButton()
-{
-  press_count = 0;
-}
-
-void
-MultiButton::add(InputButton* button)
-{
-  buttons.push_back(button);
-  slots.push_back(button-&gt;on_key_down().connect(this, &amp;MultiButton::pressed));
-  slots.push_back(button-&gt;on_key_up().connect(this, &amp;MultiButton::released));
-}
-
-void
-MultiButton::update(float delta)
-{
-  for (Buttons::iterator i = buttons.begin(); i != buttons.end(); ++i)
-    (*i)-&gt;update(delta);
-}
-
-void
-MultiButton::released()
-{
-  press_count -= 1;
-
-  if (press_count == 0)
-    button_up();
-
-  // FIXME: Workaround
-  if (press_count &lt; 0)
-    press_count = 0;
-}
-
-void
-MultiButton::pressed()
-{
-  press_count += 1;
-
-  if (press_count == 1)
-    button_down();
-}
-
-/* EOF */

Copied: trunk/src/input/multi_button.hpp (from rev 502, trunk/src/input/multi_button.hxx)
===================================================================
--- trunk/src/input/multi_button.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/multi_button.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,46 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_MULTI_BUTTON_HXX
+#define HEADER_MULTI_BUTTON_HXX
+
+#include &lt;vector&gt;
+#include &quot;input_button.hpp&quot;
+
+/** */
+class MultiButton : public InputButton
+{
+private:
+  typedef std::vector&lt;InputButton*&gt; Buttons;
+  Buttons buttons;
+  std::vector&lt;CL_Slot&gt; slots;  
+  int press_count;
+public:
+  MultiButton();
+  
+  void add(InputButton*);
+  void update(float delta);
+private:
+  void released();
+  void pressed();
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/input/multi_button.hxx
===================================================================
--- trunk/src/input/multi_button.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/input/multi_button.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,46 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_MULTI_BUTTON_HXX
-#define HEADER_MULTI_BUTTON_HXX
-
-#include &lt;vector&gt;
-#include &quot;input_button.hxx&quot;
-
-/** */
-class MultiButton : public InputButton
-{
-private:
-  typedef std::vector&lt;InputButton*&gt; Buttons;
-  Buttons buttons;
-  std::vector&lt;CL_Slot&gt; slots;  
-  int press_count;
-public:
-  MultiButton();
-  
-  void add(InputButton*);
-  void update(float delta);
-private:
-  void released();
-  void pressed();
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/laser_shoot.cpp (from rev 502, trunk/src/laser_shoot.cxx)
===================================================================
--- trunk/src/laser_shoot.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/laser_shoot.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,82 @@
+//  $Id: laser_shoot.cxx,v 1.6 2003/10/10 21:06:22 grumbel Exp $
+//
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;assert.h&gt;
+#include &lt;ClanLib/gl.h&gt;
+#include &quot;display.hpp&quot;
+#include &quot;tile_map.hpp&quot;
+#include &quot;globals.hpp&quot;
+#include &quot;sector.hpp&quot;
+#include &quot;animation_obj.hpp&quot;
+#include &quot;laser_shoot.hpp&quot;
+
+LaserShoot::LaserShoot (const CL_Vector&amp; arg_pos, Direction arg_dir, int arg_stage)
+  : pos (arg_pos), direction (arg_dir), stage (arg_stage)
+{
+  assert(stage &gt;= 1 &amp;&amp; stage &lt;= 5);
+
+  sprite = CL_Sprite (std::string(&quot;shoot/laser/stage&quot;) + CL_String::to(stage), resources);
+}
+
+void
+LaserShoot::draw (SceneContext&amp; )
+{
+  if (direction == WEST)
+    sprite.set_scale (-1.0, 1.0);
+  sprite.draw (int (pos.x), int (pos.y));
+
+  if (0) // Laser
+    {
+      Windstille::Display::begin_gl();
+          
+      glBlendFunc( GL_SRC_ALPHA, GL_ONE );
+
+      glBegin(GL_QUADS);
+      {
+        glColor4f(1.0f, 1.0f, 0.0f, 0.9f);
+        glVertex2f(150,  400);
+        glVertex2f(300, 400);
+
+        glColor4f(1.0f, 1.0f, 0.0f, 0.1f);
+        glVertex2f(300, 420);
+        glVertex2f(150,  420);
+      }
+      glEnd();
+
+      Windstille::Display::end_gl();
+    }
+}
+
+void 
+LaserShoot::update (float delta)
+{
+  sprite.update (delta);
+  if (direction == WEST)
+    pos.x -= 2000 * delta;
+  else
+    pos.x += 2000 * delta;
+
+  if (get_world ()-&gt;get_tilemap()-&gt;is_ground (pos.x, pos.y))
+    { 
+      get_world ()-&gt;add (new AnimationObj (&quot;shoot/explosion&quot;, pos));
+      remove ();
+    }
+}
+
+/* EOF */

Deleted: trunk/src/laser_shoot.cxx
===================================================================
--- trunk/src/laser_shoot.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/laser_shoot.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,82 +0,0 @@
-//  $Id: laser_shoot.cxx,v 1.6 2003/10/10 21:06:22 grumbel Exp $
-//
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;assert.h&gt;
-#include &lt;ClanLib/gl.h&gt;
-#include &quot;display.hxx&quot;
-#include &quot;tile_map.hxx&quot;
-#include &quot;globals.hxx&quot;
-#include &quot;sector.hxx&quot;
-#include &quot;animation_obj.hxx&quot;
-#include &quot;laser_shoot.hxx&quot;
-
-LaserShoot::LaserShoot (const CL_Vector&amp; arg_pos, Direction arg_dir, int arg_stage)
-  : pos (arg_pos), direction (arg_dir), stage (arg_stage)
-{
-  assert(stage &gt;= 1 &amp;&amp; stage &lt;= 5);
-
-  sprite = CL_Sprite (std::string(&quot;shoot/laser/stage&quot;) + CL_String::to(stage), resources);
-}
-
-void
-LaserShoot::draw (SceneContext&amp; )
-{
-  if (direction == WEST)
-    sprite.set_scale (-1.0, 1.0);
-  sprite.draw (int (pos.x), int (pos.y));
-
-  if (0) // Laser
-    {
-      Windstille::Display::begin_gl();
-          
-      glBlendFunc( GL_SRC_ALPHA, GL_ONE );
-
-      glBegin(GL_QUADS);
-      {
-        glColor4f(1.0f, 1.0f, 0.0f, 0.9f);
-        glVertex2f(150,  400);
-        glVertex2f(300, 400);
-
-        glColor4f(1.0f, 1.0f, 0.0f, 0.1f);
-        glVertex2f(300, 420);
-        glVertex2f(150,  420);
-      }
-      glEnd();
-
-      Windstille::Display::end_gl();
-    }
-}
-
-void 
-LaserShoot::update (float delta)
-{
-  sprite.update (delta);
-  if (direction == WEST)
-    pos.x -= 2000 * delta;
-  else
-    pos.x += 2000 * delta;
-
-  if (get_world ()-&gt;get_tilemap()-&gt;is_ground (pos.x, pos.y))
-    { 
-      get_world ()-&gt;add (new AnimationObj (&quot;shoot/explosion&quot;, pos));
-      remove ();
-    }
-}
-
-/* EOF */

Copied: trunk/src/laser_shoot.hpp (from rev 502, trunk/src/laser_shoot.hxx)
===================================================================
--- trunk/src/laser_shoot.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/laser_shoot.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,43 @@
+//  $Id: laser_shoot.hpp,v 1.2 2003/08/12 08:24:41 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef LASERSHOOT_HXX
+#define LASERSHOOT_HXX
+
+#include &lt;ClanLib/core.h&gt;
+#include &quot;globals.hpp&quot;
+#include &quot;game_object.hpp&quot;
+
+class LaserShoot : public GameObject
+{
+private:
+  CL_Vector pos;
+  Direction direction;
+  int stage;
+  CL_Sprite sprite;
+public:
+  LaserShoot (const CL_Vector&amp; arg_pos, Direction arg_dir, int arg_stage);
+  virtual ~LaserShoot () {}
+  void draw (SceneContext&amp; gc);
+  void update (float delta);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/laser_shoot.hxx
===================================================================
--- trunk/src/laser_shoot.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/laser_shoot.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,43 +0,0 @@
-//  $Id: laser_shoot.hxx,v 1.2 2003/08/12 08:24:41 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef LASERSHOOT_HXX
-#define LASERSHOOT_HXX
-
-#include &lt;ClanLib/core.h&gt;
-#include &quot;globals.hxx&quot;
-#include &quot;game_object.hxx&quot;
-
-class LaserShoot : public GameObject
-{
-private:
-  CL_Vector pos;
-  Direction direction;
-  int stage;
-  CL_Sprite sprite;
-public:
-  LaserShoot (const CL_Vector&amp; arg_pos, Direction arg_dir, int arg_stage);
-  virtual ~LaserShoot () {}
-  void draw (SceneContext&amp; gc);
-  void update (float delta);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/math.hpp (from rev 502, trunk/src/math.hxx)

Deleted: trunk/src/math.hxx
===================================================================
--- trunk/src/math.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/math.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,53 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_MATH_HXX
-#define HEADER_MATH_HXX
-
-namespace Math {
-
-template&lt;class T&gt; 
-T min (const T&amp; a, const T&amp; b) 
-{
-  if (a &lt; b)
-    return a;
-  else
-    return b;
-}
-
-template&lt;class T&gt; 
-T max (const T&amp; a, const T&amp; b) 
-{
-  if (a &gt; b)
-    return a;
-  else
-    return b;
-}
-
-template&lt;class T&gt; 
-T mid (const T&amp; a, const T&amp; b, const T&amp; c) 
-{
-  return max&lt;T&gt;((a), min&lt;T&gt;((b), (c)));
-}
-
-} // namespace Math
-
-#endif
-
-/* EOF */

Copied: trunk/src/particle_system.cpp (from rev 502, trunk/src/particle_system.cxx)
===================================================================
--- trunk/src/particle_system.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/particle_system.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,390 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;math.h&gt;
+#include &lt;ClanLib/gl.h&gt;
+#include &quot;particle_system.hpp&quot;
+#include &quot;display/scene_context.hpp&quot;
+#include &quot;random.hpp&quot;
+
+class Randomizer 
+{
+public:
+  virtual ~Randomizer() {}
+  virtual void set_pos(Particle&amp; p) =0;
+};
+
+class PointRandomizer : public Randomizer {
+public:
+  void set_pos(Particle&amp; particle) {
+    particle.x = 0;
+    particle.y = 0;
+  }
+};
+
+class RectRandomizer : public Randomizer {
+public:
+  float width;
+  float height;
+
+  RectRandomizer(float width_, float height_) 
+    : width(width_), height(height_) {}
+ 
+  void set_pos(Particle&amp; p) {
+    p.x = rnd.drand(-width/2, width/2);
+    p.y = rnd.drand(-height/2, height/2);
+  }
+};
+
+class CircleRandomizer : public Randomizer  {
+public:
+  float radius;
+
+  CircleRandomizer(float radius_) 
+    : radius(radius_) {}
+
+  void set_pos(Particle&amp; p) {
+    // FIXME: BROKEN!!!!!
+    p.x = rnd.drand(-radius, radius);
+    p.y = sqrt((radius*radius) - (p.x*p.x)) * rnd.drand(-1.0f, 1.0f);
+  }
+};
+
+class LineRandomizer : public Randomizer {
+public:
+  float x1, y1;
+  float x2, y2;
+
+  LineRandomizer(float x1_, float y1_, float x2_, float y2_) 
+    : x1(x1_), y1(y1_), x2(x2_), y2(y2_)
+  {}
+
+  void set_pos(Particle&amp; p) {
+    float l = rnd.drand();
+    p.x = x1 + (x2-x1) * l;
+    p.y = y1 + (y2-y1) * l;
+  }
+};
+
+SurfaceDrawer::SurfaceDrawer(const CL_Surface&amp; sur)
+  : surface(sur)
+{
+}
+
+SurfaceDrawer::~SurfaceDrawer() 
+{
+}
+  
+void
+SurfaceDrawer::set_surface(const CL_Surface&amp; sur)
+{
+  surface = sur;
+  surface.set_alignment(origin_center);
+}
+
+void
+SurfaceDrawer::draw(SceneContext&amp; sc, ParticleSystem&amp; psys) 
+{          
+  for(ParticleSystem::Particles::iterator i = psys.begin(); i != psys.end(); ++i)
+    {
+      // FIXME: use custom OpenGL here
+      if (i-&gt;t != -1.0f)
+        {
+          float p = 1.0f - psys.get_progress(i-&gt;t);
+          surface.set_color(CL_Color(int(psys.color_start.get_red()   * p + psys.color_stop.get_red()   * (1.0f - p)),
+                                     int(psys.color_start.get_green() * p + psys.color_stop.get_green() * (1.0f - p)),
+                                     int(psys.color_start.get_blue()  * p + psys.color_stop.get_blue()  * (1.0f - p)),
+                                     int(psys.color_start.get_alpha() * p + psys.color_stop.get_alpha() * (1.0f - p))));
+
+          surface.set_scale(psys.size_start + psys.get_progress(i-&gt;t)*(psys.size_stop - psys.size_start),
+                            psys.size_start + psys.get_progress(i-&gt;t)*(psys.size_stop - psys.size_start));
+          surface.set_angle(i-&gt;angle);
+          
+          sc.color().draw(surface, 
+                          psys.get_x_pos() + i-&gt;x,
+                          psys.get_y_pos() + i-&gt;y);
+        }
+    }
+}
+
+class SparkDrawerDrawingRequest : public DrawingRequest
+{
+private:
+  ParticleSystem&amp; psys;
+public:
+  SparkDrawerDrawingRequest(ParticleSystem&amp; psys_,
+                            const CL_Vector&amp; pos, const CL_Matrix4x4&amp; modelview = CL_Matrix4x4(true))
+    : DrawingRequest(pos, modelview),
+      psys(psys_)
+  {
+  }
+
+  virtual ~SparkDrawerDrawingRequest() {}
+  
+  void draw(CL_GraphicContext* gc) 
+  {
+    gc-&gt;push_modelview();
+    gc-&gt;add_modelview(modelview);
+
+    CL_OpenGLState state(gc);
+    state.set_active();
+    state.setup_2d();
+  
+    glEnable(GL_BLEND);
+    glBlendFunc( GL_SRC_ALPHA, GL_ONE );
+    glBegin(GL_LINES);
+    for(ParticleSystem::Particles::iterator i = psys.begin(); i != psys.end(); ++i)
+      {
+        glColor4f(1.0, 1.0, 0, 1.0f-psys.get_progress(i-&gt;t));
+        glVertex2f(i-&gt;x, i-&gt;y);
+        glColor4f(0, 0, 0, 0);
+        glVertex2f(i-&gt;x - i-&gt;v_x/10.0f, i-&gt;y - i-&gt;v_y/10.0f);
+      }
+    glEnd();  
+
+    gc-&gt;pop_modelview();
+  }
+};
+
+void
+SparkDrawer::draw(SceneContext&amp; sc, ParticleSystem&amp; psys) 
+{
+  sc.color().draw(new SparkDrawerDrawingRequest(psys, CL_Vector(0, 0, .5f), sc.color().get_modelview()));
+}
+
+ParticleSystem::ParticleSystem()
+{
+  randomizer = new PointRandomizer;
+  drawer     = 0;
+  x_pos      = 320.0f;
+  y_pos      = 240.0f;
+  life_time  = 1.0f;
+
+  gravity_x = 0.0f;
+  gravity_y = -10.0f;
+
+  cone_start = 0;
+  cone_stop  = 2*M_PI;
+
+  size_start = 1.0f;
+  size_stop  = 1.0f;
+
+  speed_start = 100.0;
+  speed_stop  = 200.0f;
+
+  color_start = CL_Color(255, 255, 255, 255);
+  color_stop  = CL_Color(  0,   0,   0,   0);
+
+  set_count(70);
+}
+
+ParticleSystem::~ParticleSystem()
+{
+  delete randomizer;
+  delete drawer;
+}
+
+void
+ParticleSystem::set_drawer(Drawer* drawer_)
+{
+  delete drawer;
+  drawer = drawer_;
+}
+  
+void
+ParticleSystem::draw(SceneContext&amp; sc)
+{
+  if (drawer)
+    {
+      drawer-&gt;draw(sc, *this);
+    }
+  else
+    {
+      std::cout &lt;&lt; &quot;ParticleSystem: No drawer set&quot; &lt;&lt; std::endl;
+    }
+}
+
+void
+ParticleSystem::spawn(Particle&amp; particle)
+{
+  randomizer-&gt;set_pos(particle);
+
+  particle.x   += spawn_x_pos;
+  particle.y   += spawn_y_pos;
+
+  float direction = rnd.drand(cone_start, cone_stop);
+  float speed     = rnd.drand(speed_start, speed_stop);
+  particle.v_x    = cos(direction) * speed;
+  particle.v_y    = sin(direction) * speed;
+
+  particle.angle = rnd.drand(360);
+
+  particle.t   = std::min(std::max(0.0f, particle.t - life_time), life_time);
+}
+
+void
+ParticleSystem::update(float delta)
+{
+  for(Particles::iterator i = particles.begin(); i != particles.end(); ++i)
+    {
+      if (i-&gt;t &gt; life_time)
+        {
+          spawn(*i);
+        }
+      else
+        {
+          i-&gt;t += delta;
+          
+          i-&gt;x += i-&gt;v_x * delta;
+          i-&gt;y += i-&gt;v_y * delta;
+
+          i-&gt;v_x += gravity_x;
+          i-&gt;v_y += gravity_y;
+        }
+    }
+}
+
+void
+ParticleSystem::set_count(int num)
+{
+  particles.resize(num);
+
+  for(Particles::iterator i = particles.begin(); i != particles.end(); ++i)
+    {
+      //i-&gt;t = -1.0f;
+      spawn(*i);
+      i-&gt;t = (life_time * (float(i - particles.begin())/particles.size()));
+    }
+}
+  
+void
+ParticleSystem::set_bunching(float factor)
+{
+  (void) factor; 
+}
+
+void
+ParticleSystem::set_cycles(float num)
+{
+  (void) num;
+}
+
+void
+ParticleSystem::set_pos(float x, float y)
+{
+  x_pos = x;
+  y_pos = y;
+}
+
+void
+ParticleSystem::set_spawn_point(float x, float y)
+{
+  spawn_x_pos = x;
+  spawn_y_pos = y;
+}
+
+void
+ParticleSystem::set_point_distribution()
+{
+  delete randomizer;
+  randomizer = new PointRandomizer();
+}
+
+void
+ParticleSystem::set_line_distribution(float x1, float y1,
+                                      float x2, float y2)
+{
+  delete randomizer;
+  randomizer = new LineRandomizer(x1, y1, x2, y2);
+}
+
+void
+ParticleSystem::set_circle_distribution(float radius)
+{
+  delete randomizer;
+  randomizer = new CircleRandomizer(radius);
+}
+
+void
+ParticleSystem::set_rect_distribution(float width, float height)
+{
+  delete randomizer;
+  randomizer = new RectRandomizer(width,  height);
+}
+
+void
+ParticleSystem::set_cone(float start_angle, float stop_angle)
+{
+  cone_start = start_angle * M_PI/180.0f;
+  cone_stop  = stop_angle  * M_PI/180.0f;
+}
+
+void
+ParticleSystem::set_gravity(float arg_gravity_x, float arg_gravity_y)
+{
+  gravity_x = arg_gravity_x;
+  gravity_y = arg_gravity_y;
+}
+
+void
+ParticleSystem::set_lifetime(float time)
+{
+  life_time = time;
+}
+
+void
+ParticleSystem::set_size(float from, float to)
+{
+  size_start = from;
+  size_stop  = to;
+}
+
+void
+ParticleSystem::set_aspect(float from, float to)
+{
+  (void) from;
+  (void) to;
+}
+
+void
+ParticleSystem::set_color(const CL_Color&amp; color)
+{
+  color_start = color;
+}
+
+void
+ParticleSystem::set_fade_color(const CL_Color&amp; color)
+{
+  color_stop = color;
+}
+
+void
+ParticleSystem::set_speed(float from, float to)
+{
+  speed_start = from;
+  speed_stop  = to;
+}
+
+float
+ParticleSystem::get_progress(float t)
+{
+  return std::max(0.0f, std::min(1.0f, t/life_time));
+}
+
+/* EOF */

Deleted: trunk/src/particle_system.cxx
===================================================================
--- trunk/src/particle_system.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/particle_system.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,390 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;math.h&gt;
-#include &lt;ClanLib/gl.h&gt;
-#include &quot;particle_system.hxx&quot;
-#include &quot;display/scene_context.hxx&quot;
-#include &quot;random.hxx&quot;
-
-class Randomizer 
-{
-public:
-  virtual ~Randomizer() {}
-  virtual void set_pos(Particle&amp; p) =0;
-};
-
-class PointRandomizer : public Randomizer {
-public:
-  void set_pos(Particle&amp; particle) {
-    particle.x = 0;
-    particle.y = 0;
-  }
-};
-
-class RectRandomizer : public Randomizer {
-public:
-  float width;
-  float height;
-
-  RectRandomizer(float width_, float height_) 
-    : width(width_), height(height_) {}
- 
-  void set_pos(Particle&amp; p) {
-    p.x = rnd.drand(-width/2, width/2);
-    p.y = rnd.drand(-height/2, height/2);
-  }
-};
-
-class CircleRandomizer : public Randomizer  {
-public:
-  float radius;
-
-  CircleRandomizer(float radius_) 
-    : radius(radius_) {}
-
-  void set_pos(Particle&amp; p) {
-    // FIXME: BROKEN!!!!!
-    p.x = rnd.drand(-radius, radius);
-    p.y = sqrt((radius*radius) - (p.x*p.x)) * rnd.drand(-1.0f, 1.0f);
-  }
-};
-
-class LineRandomizer : public Randomizer {
-public:
-  float x1, y1;
-  float x2, y2;
-
-  LineRandomizer(float x1_, float y1_, float x2_, float y2_) 
-    : x1(x1_), y1(y1_), x2(x2_), y2(y2_)
-  {}
-
-  void set_pos(Particle&amp; p) {
-    float l = rnd.drand();
-    p.x = x1 + (x2-x1) * l;
-    p.y = y1 + (y2-y1) * l;
-  }
-};
-
-SurfaceDrawer::SurfaceDrawer(const CL_Surface&amp; sur)
-  : surface(sur)
-{
-}
-
-SurfaceDrawer::~SurfaceDrawer() 
-{
-}
-  
-void
-SurfaceDrawer::set_surface(const CL_Surface&amp; sur)
-{
-  surface = sur;
-  surface.set_alignment(origin_center);
-}
-
-void
-SurfaceDrawer::draw(SceneContext&amp; sc, ParticleSystem&amp; psys) 
-{          
-  for(ParticleSystem::Particles::iterator i = psys.begin(); i != psys.end(); ++i)
-    {
-      // FIXME: use custom OpenGL here
-      if (i-&gt;t != -1.0f)
-        {
-          float p = 1.0f - psys.get_progress(i-&gt;t);
-          surface.set_color(CL_Color(int(psys.color_start.get_red()   * p + psys.color_stop.get_red()   * (1.0f - p)),
-                                     int(psys.color_start.get_green() * p + psys.color_stop.get_green() * (1.0f - p)),
-                                     int(psys.color_start.get_blue()  * p + psys.color_stop.get_blue()  * (1.0f - p)),
-                                     int(psys.color_start.get_alpha() * p + psys.color_stop.get_alpha() * (1.0f - p))));
-
-          surface.set_scale(psys.size_start + psys.get_progress(i-&gt;t)*(psys.size_stop - psys.size_start),
-                            psys.size_start + psys.get_progress(i-&gt;t)*(psys.size_stop - psys.size_start));
-          surface.set_angle(i-&gt;angle);
-          
-          sc.color().draw(surface, 
-                          psys.get_x_pos() + i-&gt;x,
-                          psys.get_y_pos() + i-&gt;y);
-        }
-    }
-}
-
-class SparkDrawerDrawingRequest : public DrawingRequest
-{
-private:
-  ParticleSystem&amp; psys;
-public:
-  SparkDrawerDrawingRequest(ParticleSystem&amp; psys_,
-                            const CL_Vector&amp; pos, const CL_Matrix4x4&amp; modelview = CL_Matrix4x4(true))
-    : DrawingRequest(pos, modelview),
-      psys(psys_)
-  {
-  }
-
-  virtual ~SparkDrawerDrawingRequest() {}
-  
-  void draw(CL_GraphicContext* gc) 
-  {
-    gc-&gt;push_modelview();
-    gc-&gt;add_modelview(modelview);
-
-    CL_OpenGLState state(gc);
-    state.set_active();
-    state.setup_2d();
-  
-    glEnable(GL_BLEND);
-    glBlendFunc( GL_SRC_ALPHA, GL_ONE );
-    glBegin(GL_LINES);
-    for(ParticleSystem::Particles::iterator i = psys.begin(); i != psys.end(); ++i)
-      {
-        glColor4f(1.0, 1.0, 0, 1.0f-psys.get_progress(i-&gt;t));
-        glVertex2f(i-&gt;x, i-&gt;y);
-        glColor4f(0, 0, 0, 0);
-        glVertex2f(i-&gt;x - i-&gt;v_x/10.0f, i-&gt;y - i-&gt;v_y/10.0f);
-      }
-    glEnd();  
-
-    gc-&gt;pop_modelview();
-  }
-};
-
-void
-SparkDrawer::draw(SceneContext&amp; sc, ParticleSystem&amp; psys) 
-{
-  sc.color().draw(new SparkDrawerDrawingRequest(psys, CL_Vector(0, 0, .5f), sc.color().get_modelview()));
-}
-
-ParticleSystem::ParticleSystem()
-{
-  randomizer = new PointRandomizer;
-  drawer     = 0;
-  x_pos      = 320.0f;
-  y_pos      = 240.0f;
-  life_time  = 1.0f;
-
-  gravity_x = 0.0f;
-  gravity_y = -10.0f;
-
-  cone_start = 0;
-  cone_stop  = 2*M_PI;
-
-  size_start = 1.0f;
-  size_stop  = 1.0f;
-
-  speed_start = 100.0;
-  speed_stop  = 200.0f;
-
-  color_start = CL_Color(255, 255, 255, 255);
-  color_stop  = CL_Color(  0,   0,   0,   0);
-
-  set_count(70);
-}
-
-ParticleSystem::~ParticleSystem()
-{
-  delete randomizer;
-  delete drawer;
-}
-
-void
-ParticleSystem::set_drawer(Drawer* drawer_)
-{
-  delete drawer;
-  drawer = drawer_;
-}
-  
-void
-ParticleSystem::draw(SceneContext&amp; sc)
-{
-  if (drawer)
-    {
-      drawer-&gt;draw(sc, *this);
-    }
-  else
-    {
-      std::cout &lt;&lt; &quot;ParticleSystem: No drawer set&quot; &lt;&lt; std::endl;
-    }
-}
-
-void
-ParticleSystem::spawn(Particle&amp; particle)
-{
-  randomizer-&gt;set_pos(particle);
-
-  particle.x   += spawn_x_pos;
-  particle.y   += spawn_y_pos;
-
-  float direction = rnd.drand(cone_start, cone_stop);
-  float speed     = rnd.drand(speed_start, speed_stop);
-  particle.v_x    = cos(direction) * speed;
-  particle.v_y    = sin(direction) * speed;
-
-  particle.angle = rnd.drand(360);
-
-  particle.t   = std::min(std::max(0.0f, particle.t - life_time), life_time);
-}
-
-void
-ParticleSystem::update(float delta)
-{
-  for(Particles::iterator i = particles.begin(); i != particles.end(); ++i)
-    {
-      if (i-&gt;t &gt; life_time)
-        {
-          spawn(*i);
-        }
-      else
-        {
-          i-&gt;t += delta;
-          
-          i-&gt;x += i-&gt;v_x * delta;
-          i-&gt;y += i-&gt;v_y * delta;
-
-          i-&gt;v_x += gravity_x;
-          i-&gt;v_y += gravity_y;
-        }
-    }
-}
-
-void
-ParticleSystem::set_count(int num)
-{
-  particles.resize(num);
-
-  for(Particles::iterator i = particles.begin(); i != particles.end(); ++i)
-    {
-      //i-&gt;t = -1.0f;
-      spawn(*i);
-      i-&gt;t = (life_time * (float(i - particles.begin())/particles.size()));
-    }
-}
-  
-void
-ParticleSystem::set_bunching(float factor)
-{
-  (void) factor; 
-}
-
-void
-ParticleSystem::set_cycles(float num)
-{
-  (void) num;
-}
-
-void
-ParticleSystem::set_pos(float x, float y)
-{
-  x_pos = x;
-  y_pos = y;
-}
-
-void
-ParticleSystem::set_spawn_point(float x, float y)
-{
-  spawn_x_pos = x;
-  spawn_y_pos = y;
-}
-
-void
-ParticleSystem::set_point_distribution()
-{
-  delete randomizer;
-  randomizer = new PointRandomizer();
-}
-
-void
-ParticleSystem::set_line_distribution(float x1, float y1,
-                                      float x2, float y2)
-{
-  delete randomizer;
-  randomizer = new LineRandomizer(x1, y1, x2, y2);
-}
-
-void
-ParticleSystem::set_circle_distribution(float radius)
-{
-  delete randomizer;
-  randomizer = new CircleRandomizer(radius);
-}
-
-void
-ParticleSystem::set_rect_distribution(float width, float height)
-{
-  delete randomizer;
-  randomizer = new RectRandomizer(width,  height);
-}
-
-void
-ParticleSystem::set_cone(float start_angle, float stop_angle)
-{
-  cone_start = start_angle * M_PI/180.0f;
-  cone_stop  = stop_angle  * M_PI/180.0f;
-}
-
-void
-ParticleSystem::set_gravity(float arg_gravity_x, float arg_gravity_y)
-{
-  gravity_x = arg_gravity_x;
-  gravity_y = arg_gravity_y;
-}
-
-void
-ParticleSystem::set_lifetime(float time)
-{
-  life_time = time;
-}
-
-void
-ParticleSystem::set_size(float from, float to)
-{
-  size_start = from;
-  size_stop  = to;
-}
-
-void
-ParticleSystem::set_aspect(float from, float to)
-{
-  (void) from;
-  (void) to;
-}
-
-void
-ParticleSystem::set_color(const CL_Color&amp; color)
-{
-  color_start = color;
-}
-
-void
-ParticleSystem::set_fade_color(const CL_Color&amp; color)
-{
-  color_stop = color;
-}
-
-void
-ParticleSystem::set_speed(float from, float to)
-{
-  speed_start = from;
-  speed_stop  = to;
-}
-
-float
-ParticleSystem::get_progress(float t)
-{
-  return std::max(0.0f, std::min(1.0f, t/life_time));
-}
-
-/* EOF */

Copied: trunk/src/particle_system.hpp (from rev 502, trunk/src/particle_system.hxx)
===================================================================
--- trunk/src/particle_system.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/particle_system.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,203 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_PARTICLE_SYSTEM_HXX
+#define HEADER_PARTICLE_SYSTEM_HXX
+
+#include &lt;ClanLib/display.h&gt;
+#include &lt;vector&gt;
+#include &quot;game_object.hpp&quot;
+
+class SceneContext;
+class Randomizer;
+class Particle;
+class ParticleSystem;
+
+class Drawer
+{
+public:
+  virtual ~Drawer() {}
+  virtual void draw(SceneContext&amp; sc, ParticleSystem&amp; psys) =0;
+};
+
+class SparkDrawer : public Drawer
+{
+public:
+  void draw(SceneContext&amp; sc, ParticleSystem&amp; psys);
+};
+
+class SurfaceDrawer : public Drawer
+{
+private:
+  CL_Surface surface;
+  
+public:
+  SurfaceDrawer(const CL_Surface&amp; sur);
+  virtual ~SurfaceDrawer();
+  
+  void set_surface(const CL_Surface&amp; sur);
+  void draw(SceneContext&amp; sc, ParticleSystem&amp; psys);
+};
+
+struct Particle {
+  /** Position of the particle */
+  float x;
+  float y;
+
+  /** Velocity of the particle */
+  float v_x;
+  float v_y;
+
+  /** Rotation angle */
+  float angle;
+
+  /** How long the particle already lifed, -1 means the particle
+      isn't active and ready to respawn */
+  float t;
+};
+
+
+/** */
+class ParticleSystem : public GameObject
+{
+public:
+  typedef std::vector&lt;Particle&gt; Particles;
+  typedef Particles::iterator iterator;
+private:
+  Particles particles;
+
+  float life_time;
+
+  /** Places the particle in its initial position */
+  Randomizer* randomizer;
+  Drawer* drawer;
+
+  float x_pos;
+  float y_pos;
+
+  float spawn_x_pos;
+  float spawn_y_pos;
+
+  float gravity_x;
+  float gravity_y;
+  
+  float cone_start;
+  float cone_stop;
+
+public:
+  float size_start;
+  float size_stop;
+private:
+  float speed_start;
+  float speed_stop;
+
+public:
+  CL_Color color_start;
+  CL_Color color_stop;
+private:
+  void spawn(Particle&amp; particle);
+public:
+  ParticleSystem();
+  virtual ~ParticleSystem();
+
+  void set_drawer(Drawer*);
+
+  /** Draws the particle system to the screen */
+  virtual void draw(SceneContext&amp; sc);
+
+  /** Update the particle system \a delta seconds */
+  virtual void update(float delta);
+  
+  /** Set how many particles will be used */
+  void set_count(int num);
+  
+  /** \a factor == 1 means a constant stream of particles, a value of
+      0 means all particles will be released at once */
+  void set_bunching(float factor);
+
+  /** Set how often the particle generator restarts itself, value of 0
+      means it will work forever, a value of 1 would cause all
+      particles to be emmitted only once */
+  void set_cycles(float num);
+
+  /** The position from which the particles spawn, x,y are in world
+      coordinates */
+  void set_spawn_point(float x, float y);
+
+  void set_pos(float x, float y);
+  
+  /** Causes all particles to spawn from a single point */
+  void set_point_distribution();
+
+  /** Causes all particles to spawn from a line */
+  void set_line_distribution(float x1, float y1,
+                             float x2, float y2);
+
+  /** Causes particles to not be spawned at a single point, but inside
+      the given circle */
+  void set_circle_distribution(float radius);
+
+  /** Causes particles to not be spawned at a single point, but inside
+      the given rectangle */
+  void set_rect_distribution(float width, float height);
+
+  /** Limit the direction into which the new particles spawn by the
+      given angles, angles are given in degrees */
+  void set_cone(float start_angle, float stop_angle);
+
+  /** The gravitiy that pulls the praticles up/down/left/right */
+  void set_gravity(float gravity_x, float gravity_y);
+
+  /** Set how long the particles will be alive */
+  void set_lifetime(float time);
+
+  /** Set the size of the particles, size will scale \a from to \a to
+      along their lifetime */
+  void set_size  (float from, float to);
+
+  /** set the aspect ratio from which they will start and end */
+  void set_aspect(float from, float to);
+
+  /** Set the color at which the particles will start */
+  void set_color(const CL_Color&amp; color);
+
+  /** Set the color at which the particles will end */
+  void set_fade_color(const CL_Color&amp; color);
+
+  /** Set the speed of the particles, it will be randomly distributed
+      from \a from to \a to, direction will be taken from the cone */
+  void set_speed(float from, float to);
+
+  iterator begin() { return particles.begin(); }
+  iterator end()   { return particles.end(); }
+
+  float get_x_pos() { return x_pos; }
+  float get_y_pos() { return y_pos; } 
+
+  /** Returns the how much a particle has progressed, this is
+      particle.life_time with fade_in/fade_out applied  */
+  float get_progress(float t);
+private:
+  ParticleSystem (const ParticleSystem&amp;);
+  ParticleSystem&amp; operator= (const ParticleSystem&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/particle_system.hxx
===================================================================
--- trunk/src/particle_system.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/particle_system.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,203 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_PARTICLE_SYSTEM_HXX
-#define HEADER_PARTICLE_SYSTEM_HXX
-
-#include &lt;ClanLib/display.h&gt;
-#include &lt;vector&gt;
-#include &quot;game_object.hxx&quot;
-
-class SceneContext;
-class Randomizer;
-class Particle;
-class ParticleSystem;
-
-class Drawer
-{
-public:
-  virtual ~Drawer() {}
-  virtual void draw(SceneContext&amp; sc, ParticleSystem&amp; psys) =0;
-};
-
-class SparkDrawer : public Drawer
-{
-public:
-  void draw(SceneContext&amp; sc, ParticleSystem&amp; psys);
-};
-
-class SurfaceDrawer : public Drawer
-{
-private:
-  CL_Surface surface;
-  
-public:
-  SurfaceDrawer(const CL_Surface&amp; sur);
-  virtual ~SurfaceDrawer();
-  
-  void set_surface(const CL_Surface&amp; sur);
-  void draw(SceneContext&amp; sc, ParticleSystem&amp; psys);
-};
-
-struct Particle {
-  /** Position of the particle */
-  float x;
-  float y;
-
-  /** Velocity of the particle */
-  float v_x;
-  float v_y;
-
-  /** Rotation angle */
-  float angle;
-
-  /** How long the particle already lifed, -1 means the particle
-      isn't active and ready to respawn */
-  float t;
-};
-
-
-/** */
-class ParticleSystem : public GameObject
-{
-public:
-  typedef std::vector&lt;Particle&gt; Particles;
-  typedef Particles::iterator iterator;
-private:
-  Particles particles;
-
-  float life_time;
-
-  /** Places the particle in its initial position */
-  Randomizer* randomizer;
-  Drawer* drawer;
-
-  float x_pos;
-  float y_pos;
-
-  float spawn_x_pos;
-  float spawn_y_pos;
-
-  float gravity_x;
-  float gravity_y;
-  
-  float cone_start;
-  float cone_stop;
-
-public:
-  float size_start;
-  float size_stop;
-private:
-  float speed_start;
-  float speed_stop;
-
-public:
-  CL_Color color_start;
-  CL_Color color_stop;
-private:
-  void spawn(Particle&amp; particle);
-public:
-  ParticleSystem();
-  virtual ~ParticleSystem();
-
-  void set_drawer(Drawer*);
-
-  /** Draws the particle system to the screen */
-  virtual void draw(SceneContext&amp; sc);
-
-  /** Update the particle system \a delta seconds */
-  virtual void update(float delta);
-  
-  /** Set how many particles will be used */
-  void set_count(int num);
-  
-  /** \a factor == 1 means a constant stream of particles, a value of
-      0 means all particles will be released at once */
-  void set_bunching(float factor);
-
-  /** Set how often the particle generator restarts itself, value of 0
-      means it will work forever, a value of 1 would cause all
-      particles to be emmitted only once */
-  void set_cycles(float num);
-
-  /** The position from which the particles spawn, x,y are in world
-      coordinates */
-  void set_spawn_point(float x, float y);
-
-  void set_pos(float x, float y);
-  
-  /** Causes all particles to spawn from a single point */
-  void set_point_distribution();
-
-  /** Causes all particles to spawn from a line */
-  void set_line_distribution(float x1, float y1,
-                             float x2, float y2);
-
-  /** Causes particles to not be spawned at a single point, but inside
-      the given circle */
-  void set_circle_distribution(float radius);
-
-  /** Causes particles to not be spawned at a single point, but inside
-      the given rectangle */
-  void set_rect_distribution(float width, float height);
-
-  /** Limit the direction into which the new particles spawn by the
-      given angles, angles are given in degrees */
-  void set_cone(float start_angle, float stop_angle);
-
-  /** The gravitiy that pulls the praticles up/down/left/right */
-  void set_gravity(float gravity_x, float gravity_y);
-
-  /** Set how long the particles will be alive */
-  void set_lifetime(float time);
-
-  /** Set the size of the particles, size will scale \a from to \a to
-      along their lifetime */
-  void set_size  (float from, float to);
-
-  /** set the aspect ratio from which they will start and end */
-  void set_aspect(float from, float to);
-
-  /** Set the color at which the particles will start */
-  void set_color(const CL_Color&amp; color);
-
-  /** Set the color at which the particles will end */
-  void set_fade_color(const CL_Color&amp; color);
-
-  /** Set the speed of the particles, it will be randomly distributed
-      from \a from to \a to, direction will be taken from the cone */
-  void set_speed(float from, float to);
-
-  iterator begin() { return particles.begin(); }
-  iterator end()   { return particles.end(); }
-
-  float get_x_pos() { return x_pos; }
-  float get_y_pos() { return y_pos; } 
-
-  /** Returns the how much a particle has progressed, this is
-      particle.life_time with fade_in/fade_out applied  */
-  float get_progress(float t);
-private:
-  ParticleSystem (const ParticleSystem&amp;);
-  ParticleSystem&amp; operator= (const ParticleSystem&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/player.cpp (from rev 502, trunk/src/player.cxx)
===================================================================
--- trunk/src/player.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/player.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,396 @@
+//  $Id: player.cxx,v 1.19 2003/11/05 13:36:17 grumbel Exp $
+//
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;tile_map.hpp&quot;
+#include &quot;display.hpp&quot;
+#include &quot;sector.hpp&quot;
+#include &quot;default_shoot.hpp&quot;
+#include &quot;laser_shoot.hpp&quot;
+#include &quot;input/controller.hpp&quot;
+#include &quot;input/input_manager.hpp&quot;
+#include &quot;controller_def.hpp&quot;
+#include &quot;player.hpp&quot;
+#include &quot;bomb.hpp&quot;
+#include &quot;globals.hpp&quot;
+
+#define MAX_ENERGIE 16
+
+Player* Player::current_ = 0;
+
+Player::Player () :
+  pos (320, 200),
+  velocity (0, 0),
+  
+  walk     (&quot;human/walk&quot;,   resources),
+  run      (&quot;human/run&quot;,   resources),
+  sit      (&quot;hero/sit&quot;,   resources),
+  jump     (&quot;hero/jump&quot;,  resources),
+  stand    (&quot;human/stand&quot;, resources),
+  killed   (&quot;hero/kill&quot;,  resources),
+  dead     (&quot;hero/dead&quot;,  resources),
+  light    (&quot;hero/light&quot;, resources),
+
+  state (WALKING),
+  gun_state (GUN_READY),
+  ground_state (IN_AIR)
+{
+  light.set_blend_func(blend_src_alpha, blend_one);
+
+  jumping = false;
+  energie = MAX_ENERGIE;
+  current_ = this;
+
+  walk.set_alignment(origin_bottom_center, 0, 3);
+  jump.set_alignment(origin_bottom_center, 0, 3);
+  stand.set_alignment(origin_bottom_center, 0, 3);
+
+  direction = WEST;
+  hit_count = 0.0f;
+}
+
+void
+Player::draw (SceneContext&amp; gc)
+{
+  gc.light().draw(light, pos.x, pos.y, 0);
+  
+  CL_Sprite* sprite = 0;
+
+  switch (ground_state)
+    {
+    case ON_GROUND:
+      switch (state)
+	{
+	case  WALKING:
+	  sprite = &walk;
+	  break;
+
+        case RUNNING:
+          sprite = &run;
+          break;
+
+	case STANDING:
+	  sprite = &stand;
+	  break;
+
+	case SITTING:
+	  sprite = &sit;
+	  break;
+        case KILLED:
+          sprite = &killed;
+          break;
+        case DEAD:
+          sprite = &dead;
+          break;
+          
+        case TURN:
+          sprite = &turn;
+          break;
+	}
+      break;
+    default:
+      sprite = &jump;
+      break;
+    }
+
+  if (sprite)
+    {
+      if (direction == WEST)
+	sprite-&gt;set_scale (1.0, 1.0);
+      else
+	sprite-&gt;set_scale (-1.0, 1.0);
+
+      if (hit_count &gt; 0)
+        {
+          if (rand()%2)
+            sprite-&gt;set_alpha(1.0f);
+          else
+            sprite-&gt;set_alpha(1.0f - hit_count);
+        }
+      else
+        sprite-&gt;set_alpha(1.0f);
+
+      gc.color().draw(*sprite, pos.x, pos.y, 1.0f);
+    }
+}
+
+CL_Rect
+Player::get_bounding_rect() const
+{
+  return CL_Rect(int(pos.x - 20), 
+                 int(pos.y - 112),
+                 int(pos.x + 20), 
+                 int(pos.y));
+}
+
+SubTilePos
+Player::get_subtile_pos()
+{
+  return SubTilePos(int(pos.x/TILE_SIZE), int(pos.y/TILE_SIZE));
+}
+
+void 
+Player::update (float delta)
+{
+  controller = InputManager::get_controller();
+
+  if (state == KILLED)
+    {
+      switch (ground_state)
+        {
+        case IN_AIR:
+          update_air(delta);
+          break;
+        case ON_GROUND:
+          killed.update(delta);
+          if (killed.is_finished())
+            {
+              state = DEAD;
+            }
+          break;
+        }
+    }
+  else if (state == DEAD)
+    {
+      if (controller.get_button_state(FIRE_BUTTON))
+        {
+          set_position(CL_Vector(258, 0));
+          set_direction(EAST);
+          killed.restart();
+          state = WALKING;
+          gun_state = GUN_READY;
+          ground_state = IN_AIR;
+          energie = MAX_ENERGIE;
+          velocity = CL_Vector();
+        }
+    }
+  else
+    {
+      if (hit_count &gt; 0)
+        hit_count -= delta;
+
+      walk.update(delta);
+      run.update(delta);
+  
+      if (controller.get_button_state(LEFT_BUTTON))
+        direction = WEST;
+      else if  (controller.get_button_state(RIGHT_BUTTON))
+        direction = EAST;
+
+      switch(ground_state)
+        {
+        case ON_GROUND:
+          update_ground (delta);
+          if (!on_ground ())
+            ground_state = IN_AIR;
+          break;
+        case IN_AIR:
+          update_air (delta);
+          break;
+        }
+
+      SubTilePos new_subtile_pos = get_subtile_pos();
+      if (!(subtile_pos == new_subtile_pos))
+        {
+          if (get_world()-&gt;get_tilemap()-&gt;get_pixel(new_subtile_pos.x, new_subtile_pos.y))
+            {
+              pos.x = subtile_pos.x * TILE_SIZE;
+              pos.y = subtile_pos.y * TILE_SIZE;
+            }
+          else
+            {
+              subtile_pos = new_subtile_pos;
+            }
+        }
+    }
+}
+
+void 
+Player::update_shooting (float delta)
+{
+  switch (gun_state)
+    {
+    case GUN_READY:
+      if (controller.get_button_state(FIRE_BUTTON))
+        {
+          //get_world ()-&gt;add (new DefaultShoot (pos, (DefaultShoot::DirectionState) direction));
+          get_world ()-&gt;add (new LaserShoot (pos, direction, 5));
+          gun_state = GUN_RELOADING;
+          reload_time = 0;
+        }
+      break;
+    case GUN_RELOADING:
+      if (reload_time &gt; 1)
+        gun_state = GUN_READY;
+      reload_time += 20 * delta;
+      break;
+    }
+}
+
+void 
+Player::update_ground (float delta)
+{
+  velocity = CL_Vector();
+
+  if (controller.get_button_state(JUMP_BUTTON) &amp;&amp; !jumping)
+    {
+      jumping = true;
+      velocity.y = -750;
+      ground_state = IN_AIR;
+    } 
+  else
+    {
+      if (!controller.get_button_state(JUMP_BUTTON))
+        jumping = false;
+
+      float tmp_x_pos = pos.x;
+
+      if (controller.get_button_state(DOWN_BUTTON))
+        {
+          state = SITTING;
+          if (controller.get_button_state(FIRE_BUTTON) &amp;&amp; !bomb_placed)
+            {
+              Sector::current()-&gt;add(new Bomb(int(pos.x), int(pos.y)));
+              bomb_placed = true;
+            }
+        }
+      else
+        {
+          bomb_placed = false;
+          if (controller.get_button_state(RUN_BUTTON))
+            {
+              if (controller.get_button_state(LEFT_BUTTON))
+                {
+                  pos.x -= 256 * delta;
+                  state = RUNNING;
+                }
+              else if (controller.get_button_state(RIGHT_BUTTON))
+                {
+                  pos.x += 256 * delta;
+                  state = RUNNING;
+                }
+            }
+          else
+            {
+              if (controller.get_button_state(LEFT_BUTTON))
+                {
+                  pos.x -= 128 * delta;
+                  state = WALKING;
+                }
+              else if (controller.get_button_state(RIGHT_BUTTON))
+                {
+                  pos.x += 128 * delta;
+                  state = WALKING;
+                }
+              else
+                {
+                  state = STANDING;
+                }
+            }
+          
+          if (stuck ()) 
+            {
+              // FIXME: Calculate nearest position to colliding object here
+              pos.x = tmp_x_pos;
+            }
+        }
+    }
+}
+
+void 
+Player::update_air (float delta)
+{
+  if (!controller.get_button_state(JUMP_BUTTON) &amp;&amp; velocity.y &lt; 0) 
+    {
+      velocity.y = velocity.y/2;
+      //ground_state = IN_AIR;
+    }
+
+  float tmp_x_pos = pos.x;
+  if (controller.get_button_state(LEFT_BUTTON))
+    pos.x -= 300 * delta;
+  else if (controller.get_button_state(RIGHT_BUTTON))
+    pos.x += 300 * delta;
+  if (stuck ())
+    pos.x = tmp_x_pos;
+
+  pos += velocity * delta;
+  velocity.y += 1500 * delta;
+
+  if (on_ground () &amp;&amp; velocity.y &gt; 0) 
+    {
+      ground_state = ON_GROUND;
+      // Cut the position to the tile size 
+      pos.y = int(pos.y / TILE_SIZE) * TILE_SIZE + TILE_SIZE - 1;
+    } 
+}
+  
+void 
+Player::set_position (const CL_Vector&amp; arg_pos)
+{
+  pos = arg_pos;
+}
+
+void 
+Player::set_direction (Direction dir)
+{
+  direction = dir;
+}
+
+bool
+Player::on_ground ()
+{
+  return get_world ()-&gt;get_tilemap()-&gt;is_ground(pos.x, pos.y+16);
+}
+
+bool 
+Player::stuck ()
+{
+  return get_world ()-&gt;get_tilemap()-&gt;is_ground(pos.x, pos.y);
+}
+
+int
+Player::get_energie()
+{
+  return energie;
+}
+
+int
+Player::get_max_energie()
+{
+  return MAX_ENERGIE;
+}
+
+void
+Player::hit(int points)
+{
+  if (energie &gt; 0 &amp;&amp; hit_count &lt;= 0)
+    {
+      energie -= points;
+      hit_count = 1.0f;
+
+      if (energie &lt;= 0)
+        {
+          state = KILLED;
+          hit_count = 0;
+          killed.set_frame(0);
+        }
+    }
+}
+
+/* EOF */

Deleted: trunk/src/player.cxx
===================================================================
--- trunk/src/player.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/player.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,396 +0,0 @@
-//  $Id: player.cxx,v 1.19 2003/11/05 13:36:17 grumbel Exp $
-//
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;tile_map.hxx&quot;
-#include &quot;display.hxx&quot;
-#include &quot;sector.hxx&quot;
-#include &quot;default_shoot.hxx&quot;
-#include &quot;laser_shoot.hxx&quot;
-#include &quot;input/controller.hxx&quot;
-#include &quot;input/input_manager.hxx&quot;
-#include &quot;controller_def.hxx&quot;
-#include &quot;player.hxx&quot;
-#include &quot;bomb.hxx&quot;
-#include &quot;globals.hxx&quot;
-
-#define MAX_ENERGIE 16
-
-Player* Player::current_ = 0;
-
-Player::Player () :
-  pos (320, 200),
-  velocity (0, 0),
-  
-  walk     (&quot;human/walk&quot;,   resources),
-  run      (&quot;human/run&quot;,   resources),
-  sit      (&quot;hero/sit&quot;,   resources),
-  jump     (&quot;hero/jump&quot;,  resources),
-  stand    (&quot;human/stand&quot;, resources),
-  killed   (&quot;hero/kill&quot;,  resources),
-  dead     (&quot;hero/dead&quot;,  resources),
-  light    (&quot;hero/light&quot;, resources),
-
-  state (WALKING),
-  gun_state (GUN_READY),
-  ground_state (IN_AIR)
-{
-  light.set_blend_func(blend_src_alpha, blend_one);
-
-  jumping = false;
-  energie = MAX_ENERGIE;
-  current_ = this;
-
-  walk.set_alignment(origin_bottom_center, 0, 3);
-  jump.set_alignment(origin_bottom_center, 0, 3);
-  stand.set_alignment(origin_bottom_center, 0, 3);
-
-  direction = WEST;
-  hit_count = 0.0f;
-}
-
-void
-Player::draw (SceneContext&amp; gc)
-{
-  gc.light().draw(light, pos.x, pos.y, 0);
-  
-  CL_Sprite* sprite = 0;
-
-  switch (ground_state)
-    {
-    case ON_GROUND:
-      switch (state)
-	{
-	case  WALKING:
-	  sprite = &walk;
-	  break;
-
-        case RUNNING:
-          sprite = &run;
-          break;
-
-	case STANDING:
-	  sprite = &stand;
-	  break;
-
-	case SITTING:
-	  sprite = &sit;
-	  break;
-        case KILLED:
-          sprite = &killed;
-          break;
-        case DEAD:
-          sprite = &dead;
-          break;
-          
-        case TURN:
-          sprite = &turn;
-          break;
-	}
-      break;
-    default:
-      sprite = &jump;
-      break;
-    }
-
-  if (sprite)
-    {
-      if (direction == WEST)
-	sprite-&gt;set_scale (1.0, 1.0);
-      else
-	sprite-&gt;set_scale (-1.0, 1.0);
-
-      if (hit_count &gt; 0)
-        {
-          if (rand()%2)
-            sprite-&gt;set_alpha(1.0f);
-          else
-            sprite-&gt;set_alpha(1.0f - hit_count);
-        }
-      else
-        sprite-&gt;set_alpha(1.0f);
-
-      gc.color().draw(*sprite, pos.x, pos.y, 1.0f);
-    }
-}
-
-CL_Rect
-Player::get_bounding_rect() const
-{
-  return CL_Rect(int(pos.x - 20), 
-                 int(pos.y - 112),
-                 int(pos.x + 20), 
-                 int(pos.y));
-}
-
-SubTilePos
-Player::get_subtile_pos()
-{
-  return SubTilePos(int(pos.x/TILE_SIZE), int(pos.y/TILE_SIZE));
-}
-
-void 
-Player::update (float delta)
-{
-  controller = InputManager::get_controller();
-
-  if (state == KILLED)
-    {
-      switch (ground_state)
-        {
-        case IN_AIR:
-          update_air(delta);
-          break;
-        case ON_GROUND:
-          killed.update(delta);
-          if (killed.is_finished())
-            {
-              state = DEAD;
-            }
-          break;
-        }
-    }
-  else if (state == DEAD)
-    {
-      if (controller.get_button_state(FIRE_BUTTON))
-        {
-          set_position(CL_Vector(258, 0));
-          set_direction(EAST);
-          killed.restart();
-          state = WALKING;
-          gun_state = GUN_READY;
-          ground_state = IN_AIR;
-          energie = MAX_ENERGIE;
-          velocity = CL_Vector();
-        }
-    }
-  else
-    {
-      if (hit_count &gt; 0)
-        hit_count -= delta;
-
-      walk.update(delta);
-      run.update(delta);
-  
-      if (controller.get_button_state(LEFT_BUTTON))
-        direction = WEST;
-      else if  (controller.get_button_state(RIGHT_BUTTON))
-        direction = EAST;
-
-      switch(ground_state)
-        {
-        case ON_GROUND:
-          update_ground (delta);
-          if (!on_ground ())
-            ground_state = IN_AIR;
-          break;
-        case IN_AIR:
-          update_air (delta);
-          break;
-        }
-
-      SubTilePos new_subtile_pos = get_subtile_pos();
-      if (!(subtile_pos == new_subtile_pos))
-        {
-          if (get_world()-&gt;get_tilemap()-&gt;get_pixel(new_subtile_pos.x, new_subtile_pos.y))
-            {
-              pos.x = subtile_pos.x * TILE_SIZE;
-              pos.y = subtile_pos.y * TILE_SIZE;
-            }
-          else
-            {
-              subtile_pos = new_subtile_pos;
-            }
-        }
-    }
-}
-
-void 
-Player::update_shooting (float delta)
-{
-  switch (gun_state)
-    {
-    case GUN_READY:
-      if (controller.get_button_state(FIRE_BUTTON))
-        {
-          //get_world ()-&gt;add (new DefaultShoot (pos, (DefaultShoot::DirectionState) direction));
-          get_world ()-&gt;add (new LaserShoot (pos, direction, 5));
-          gun_state = GUN_RELOADING;
-          reload_time = 0;
-        }
-      break;
-    case GUN_RELOADING:
-      if (reload_time &gt; 1)
-        gun_state = GUN_READY;
-      reload_time += 20 * delta;
-      break;
-    }
-}
-
-void 
-Player::update_ground (float delta)
-{
-  velocity = CL_Vector();
-
-  if (controller.get_button_state(JUMP_BUTTON) &amp;&amp; !jumping)
-    {
-      jumping = true;
-      velocity.y = -750;
-      ground_state = IN_AIR;
-    } 
-  else
-    {
-      if (!controller.get_button_state(JUMP_BUTTON))
-        jumping = false;
-
-      float tmp_x_pos = pos.x;
-
-      if (controller.get_button_state(DOWN_BUTTON))
-        {
-          state = SITTING;
-          if (controller.get_button_state(FIRE_BUTTON) &amp;&amp; !bomb_placed)
-            {
-              Sector::current()-&gt;add(new Bomb(int(pos.x), int(pos.y)));
-              bomb_placed = true;
-            }
-        }
-      else
-        {
-          bomb_placed = false;
-          if (controller.get_button_state(RUN_BUTTON))
-            {
-              if (controller.get_button_state(LEFT_BUTTON))
-                {
-                  pos.x -= 256 * delta;
-                  state = RUNNING;
-                }
-              else if (controller.get_button_state(RIGHT_BUTTON))
-                {
-                  pos.x += 256 * delta;
-                  state = RUNNING;
-                }
-            }
-          else
-            {
-              if (controller.get_button_state(LEFT_BUTTON))
-                {
-                  pos.x -= 128 * delta;
-                  state = WALKING;
-                }
-              else if (controller.get_button_state(RIGHT_BUTTON))
-                {
-                  pos.x += 128 * delta;
-                  state = WALKING;
-                }
-              else
-                {
-                  state = STANDING;
-                }
-            }
-          
-          if (stuck ()) 
-            {
-              // FIXME: Calculate nearest position to colliding object here
-              pos.x = tmp_x_pos;
-            }
-        }
-    }
-}
-
-void 
-Player::update_air (float delta)
-{
-  if (!controller.get_button_state(JUMP_BUTTON) &amp;&amp; velocity.y &lt; 0) 
-    {
-      velocity.y = velocity.y/2;
-      //ground_state = IN_AIR;
-    }
-
-  float tmp_x_pos = pos.x;
-  if (controller.get_button_state(LEFT_BUTTON))
-    pos.x -= 300 * delta;
-  else if (controller.get_button_state(RIGHT_BUTTON))
-    pos.x += 300 * delta;
-  if (stuck ())
-    pos.x = tmp_x_pos;
-
-  pos += velocity * delta;
-  velocity.y += 1500 * delta;
-
-  if (on_ground () &amp;&amp; velocity.y &gt; 0) 
-    {
-      ground_state = ON_GROUND;
-      // Cut the position to the tile size 
-      pos.y = int(pos.y / TILE_SIZE) * TILE_SIZE + TILE_SIZE - 1;
-    } 
-}
-  
-void 
-Player::set_position (const CL_Vector&amp; arg_pos)
-{
-  pos = arg_pos;
-}
-
-void 
-Player::set_direction (Direction dir)
-{
-  direction = dir;
-}
-
-bool
-Player::on_ground ()
-{
-  return get_world ()-&gt;get_tilemap()-&gt;is_ground(pos.x, pos.y+16);
-}
-
-bool 
-Player::stuck ()
-{
-  return get_world ()-&gt;get_tilemap()-&gt;is_ground(pos.x, pos.y);
-}
-
-int
-Player::get_energie()
-{
-  return energie;
-}
-
-int
-Player::get_max_energie()
-{
-  return MAX_ENERGIE;
-}
-
-void
-Player::hit(int points)
-{
-  if (energie &gt; 0 &amp;&amp; hit_count &lt;= 0)
-    {
-      energie -= points;
-      hit_count = 1.0f;
-
-      if (energie &lt;= 0)
-        {
-          state = KILLED;
-          hit_count = 0;
-          killed.set_frame(0);
-        }
-    }
-}
-
-/* EOF */

Copied: trunk/src/player.hpp (from rev 502, trunk/src/player.hxx)
===================================================================
--- trunk/src/player.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/player.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,132 @@
+//  $Id: player.hpp,v 1.11 2003/11/05 13:36:17 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef PLAYER_HXX
+#define PLAYER_HXX
+
+#include &lt;ClanLib/core.h&gt;
+#include &lt;ClanLib/gl.h&gt;
+#include &lt;ClanLib/display.h&gt;
+
+#include &quot;input/controller.hpp&quot;
+#include &quot;globals.hpp&quot;
+#include &quot;game_object.hpp&quot;
+
+class Controller;
+
+/** A position in units of subtiles */
+struct SubTilePos {
+  SubTilePos() : x(0), y(0) {}
+
+  SubTilePos(int x_, int y_) 
+    : x(x_), y(y_)
+  {}
+
+  bool operator==(const SubTilePos&amp; pos) {
+    return pos.x == x &amp;&amp; pos.y == y;
+  }
+
+  int x;
+  int y;
+};
+
+class Player : public GameObject
+{
+private:
+  Controller controller;
+
+  /** Position as a float */
+  CL_Vector pos;
+  
+  SubTilePos subtile_pos;
+
+  /** X-Position in subtile coordinates */
+  int x_pos;
+  /** Y-Position in subtile coordinates */
+  int y_pos;
+  
+  CL_Vector velocity;
+  
+  CL_Sprite walk;
+  CL_Sprite run;
+  CL_Sprite turn;
+  CL_Sprite sit;
+  CL_Sprite jump;
+  CL_Sprite stand;
+  CL_Sprite killed;
+  CL_Sprite dead;
+  CL_Sprite light;
+
+  CL_Sprite roll;
+  CL_Sprite surround;
+
+  bool jumping;
+  bool bomb_placed;
+  float hit_count;
+  int energie;
+public:
+  typedef enum { WALKING, RUNNING, TURN, SITTING, STANDING, KILLED, DEAD } MovementState;
+  typedef enum { GUN_READY, GUN_RELOADING } GunState;
+  typedef enum { ON_GROUND, IN_AIR } GroundState;
+
+  //{ BOUNCE, SPREAD, LASER }
+private:
+  MovementState state;
+  GunState gun_state;
+  Direction direction;
+  GroundState ground_state;
+  
+  double reload_time;
+  static Player* current_;
+public:
+  Player ();
+  virtual ~Player () {}
+
+  static Player* current() { return current_; }
+
+  int get_movement_state() { return state; }
+
+  void draw (SceneContext&amp; gc);
+  void update (float delta);
+
+  void set_position (const CL_Vector&amp; arg_pos);
+  void set_direction (Direction dir);
+
+  CL_Vector get_pos () const { return pos; }
+  SubTilePos get_subtile_pos();
+  
+  int get_energie();
+  int get_max_energie();
+  void hit(int points);
+
+  CL_Rect get_bounding_rect() const; 
+private:
+  // true if the tile under Player is ground
+  bool on_ground ();
+  // true if Player is inside a ground tile
+  bool stuck ();
+
+  void update_ground (float delta);
+  void update_air (float delta);
+  void update_shooting (float delta);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/player.hxx
===================================================================
--- trunk/src/player.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/player.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,132 +0,0 @@
-//  $Id: player.hxx,v 1.11 2003/11/05 13:36:17 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef PLAYER_HXX
-#define PLAYER_HXX
-
-#include &lt;ClanLib/core.h&gt;
-#include &lt;ClanLib/gl.h&gt;
-#include &lt;ClanLib/display.h&gt;
-
-#include &quot;input/controller.hxx&quot;
-#include &quot;globals.hxx&quot;
-#include &quot;game_object.hxx&quot;
-
-class Controller;
-
-/** A position in units of subtiles */
-struct SubTilePos {
-  SubTilePos() : x(0), y(0) {}
-
-  SubTilePos(int x_, int y_) 
-    : x(x_), y(y_)
-  {}
-
-  bool operator==(const SubTilePos&amp; pos) {
-    return pos.x == x &amp;&amp; pos.y == y;
-  }
-
-  int x;
-  int y;
-};
-
-class Player : public GameObject
-{
-private:
-  Controller controller;
-
-  /** Position as a float */
-  CL_Vector pos;
-  
-  SubTilePos subtile_pos;
-
-  /** X-Position in subtile coordinates */
-  int x_pos;
-  /** Y-Position in subtile coordinates */
-  int y_pos;
-  
-  CL_Vector velocity;
-  
-  CL_Sprite walk;
-  CL_Sprite run;
-  CL_Sprite turn;
-  CL_Sprite sit;
-  CL_Sprite jump;
-  CL_Sprite stand;
-  CL_Sprite killed;
-  CL_Sprite dead;
-  CL_Sprite light;
-
-  CL_Sprite roll;
-  CL_Sprite surround;
-
-  bool jumping;
-  bool bomb_placed;
-  float hit_count;
-  int energie;
-public:
-  typedef enum { WALKING, RUNNING, TURN, SITTING, STANDING, KILLED, DEAD } MovementState;
-  typedef enum { GUN_READY, GUN_RELOADING } GunState;
-  typedef enum { ON_GROUND, IN_AIR } GroundState;
-
-  //{ BOUNCE, SPREAD, LASER }
-private:
-  MovementState state;
-  GunState gun_state;
-  Direction direction;
-  GroundState ground_state;
-  
-  double reload_time;
-  static Player* current_;
-public:
-  Player ();
-  virtual ~Player () {}
-
-  static Player* current() { return current_; }
-
-  int get_movement_state() { return state; }
-
-  void draw (SceneContext&amp; gc);
-  void update (float delta);
-
-  void set_position (const CL_Vector&amp; arg_pos);
-  void set_direction (Direction dir);
-
-  CL_Vector get_pos () const { return pos; }
-  SubTilePos get_subtile_pos();
-  
-  int get_energie();
-  int get_max_energie();
-  void hit(int points);
-
-  CL_Rect get_bounding_rect() const; 
-private:
-  // true if the tile under Player is ground
-  bool on_ground ();
-  // true if Player is inside a ground tile
-  bool stuck ();
-
-  void update_ground (float delta);
-  void update_air (float delta);
-  void update_shooting (float delta);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/random.cpp (from rev 502, trunk/src/random.cxx)
===================================================================
--- trunk/src/random.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/random.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,132 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;random.hpp&quot;
+
+/* This file is based on:
+ * A C-program for MT19937, with initialization improved 2002/1/26.
+ *  Coded by Takuji Nishimura and Makoto Matsumoto.
+ * <A HREF="http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/MT2002/CODES/mt19937ar.c">http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/MT2002/CODES/mt19937ar.c</A> 
+ */
+
+Random::Random(unsigned long s)
+{
+  mt[0]= s &amp; 0xffffffffUL;
+  for (mti=1; mti&lt;N; mti++) {
+    mt[mti] =
+      (1812433253UL * (mt[mti-1] ^ (mt[mti-1] &gt;&gt; 30)) + mti);
+    /* See Knuth TAOCP Vol2. 3rd Ed. P.106 for multiplier. */
+    /* In the previous versions, MSBs of the seed affect   */
+    /* only MSBs of the array mt[].                        */
+    /* 2002/01/09 modified by Makoto Matsumoto             */
+    mt[mti] &amp;= 0xffffffffUL;
+    /* for &gt;32 bit machines */
+  }
+}
+
+unsigned long
+Random::rand()
+{
+  unsigned long y;
+  static unsigned long mag01[2]={0x0UL, MATRIX_A};
+  /* mag01[x] = x * MATRIX_A  for x=0,1 */
+
+  if (mti &gt;= N) { /* generate N words at one time */
+    unsigned long kk;
+
+    for (kk=0;kk&lt;N-M;kk++) {
+      y = (mt[kk]&amp;UPPER_MASK)|(mt[kk+1]&amp;LOWER_MASK);
+      mt[kk] = mt[kk+M] ^ (y &gt;&gt; 1) ^ mag01[y &amp; 0x1UL];
+    }
+    for (;kk&lt;N-1;kk++) {
+      y = (mt[kk]&amp;UPPER_MASK)|(mt[kk+1]&amp;LOWER_MASK);
+      mt[kk] = mt[kk+(M-N)] ^ (y &gt;&gt; 1) ^ mag01[y &amp; 0x1UL];
+    }
+    y = (mt[N-1]&amp;UPPER_MASK)|(mt[0]&amp;LOWER_MASK);
+    mt[N-1] = mt[M-1] ^ (y &gt;&gt; 1) ^ mag01[y &amp; 0x1UL];
+
+    mti = 0;
+  }
+  
+  y = mt[mti++];
+
+  /* Tempering */
+  y ^= (y &gt;&gt; 11);
+  y ^= (y &lt;&lt; 7) &amp; 0x9d2c5680UL;
+  y ^= (y &lt;&lt; 15) &amp; 0xefc60000UL;
+  y ^= (y &gt;&gt; 18);
+
+  return y;
+}
+
+long
+Random::rand(long range)
+{
+  return rand()/(0xffffffffUL/(range+1));
+}
+
+long
+Random::rand(int start, int end)
+{
+  return start + rand()/(0xffffffffUL/(end-start+1));
+}
+
+double
+Random::drand(double range)
+{
+  return drand()*range;
+}
+
+double
+Random::drand(double start, double end)
+{
+  return (start + (drand()*(end-start)));
+}
+
+/* generates a random number on [0,1]-real-interval */
+double
+Random::drand()
+{
+  return rand()*(1.0/4294967295.0);
+  /* divided by 2^32-1 */
+}
+
+int
+Random::sign()
+{
+  return (rand()%2)?-1:1;
+}
+
+Random rnd;
+
+#ifdef __TEST__
+#include &lt;iostream&gt;
+
+int main()
+{
+  Random random(5489UL);
+  for(int i = 0; i &lt; 1000000; ++i)
+    {
+      std::cout &lt;&lt; random.drand(0, 5) &lt;&lt; std::endl;
+    }
+  return 0;
+}
+#endif
+
+/* EOF */

Deleted: trunk/src/random.cxx
===================================================================
--- trunk/src/random.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/random.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,132 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;random.hxx&quot;
-
-/* This file is based on:
- * A C-program for MT19937, with initialization improved 2002/1/26.
- *  Coded by Takuji Nishimura and Makoto Matsumoto.
- * <A HREF="http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/MT2002/CODES/mt19937ar.c">http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/MT2002/CODES/mt19937ar.c</A> 
- */
-
-Random::Random(unsigned long s)
-{
-  mt[0]= s &amp; 0xffffffffUL;
-  for (mti=1; mti&lt;N; mti++) {
-    mt[mti] =
-      (1812433253UL * (mt[mti-1] ^ (mt[mti-1] &gt;&gt; 30)) + mti);
-    /* See Knuth TAOCP Vol2. 3rd Ed. P.106 for multiplier. */
-    /* In the previous versions, MSBs of the seed affect   */
-    /* only MSBs of the array mt[].                        */
-    /* 2002/01/09 modified by Makoto Matsumoto             */
-    mt[mti] &amp;= 0xffffffffUL;
-    /* for &gt;32 bit machines */
-  }
-}
-
-unsigned long
-Random::rand()
-{
-  unsigned long y;
-  static unsigned long mag01[2]={0x0UL, MATRIX_A};
-  /* mag01[x] = x * MATRIX_A  for x=0,1 */
-
-  if (mti &gt;= N) { /* generate N words at one time */
-    unsigned long kk;
-
-    for (kk=0;kk&lt;N-M;kk++) {
-      y = (mt[kk]&amp;UPPER_MASK)|(mt[kk+1]&amp;LOWER_MASK);
-      mt[kk] = mt[kk+M] ^ (y &gt;&gt; 1) ^ mag01[y &amp; 0x1UL];
-    }
-    for (;kk&lt;N-1;kk++) {
-      y = (mt[kk]&amp;UPPER_MASK)|(mt[kk+1]&amp;LOWER_MASK);
-      mt[kk] = mt[kk+(M-N)] ^ (y &gt;&gt; 1) ^ mag01[y &amp; 0x1UL];
-    }
-    y = (mt[N-1]&amp;UPPER_MASK)|(mt[0]&amp;LOWER_MASK);
-    mt[N-1] = mt[M-1] ^ (y &gt;&gt; 1) ^ mag01[y &amp; 0x1UL];
-
-    mti = 0;
-  }
-  
-  y = mt[mti++];
-
-  /* Tempering */
-  y ^= (y &gt;&gt; 11);
-  y ^= (y &lt;&lt; 7) &amp; 0x9d2c5680UL;
-  y ^= (y &lt;&lt; 15) &amp; 0xefc60000UL;
-  y ^= (y &gt;&gt; 18);
-
-  return y;
-}
-
-long
-Random::rand(long range)
-{
-  return rand()/(0xffffffffUL/(range+1));
-}
-
-long
-Random::rand(int start, int end)
-{
-  return start + rand()/(0xffffffffUL/(end-start+1));
-}
-
-double
-Random::drand(double range)
-{
-  return drand()*range;
-}
-
-double
-Random::drand(double start, double end)
-{
-  return (start + (drand()*(end-start)));
-}
-
-/* generates a random number on [0,1]-real-interval */
-double
-Random::drand()
-{
-  return rand()*(1.0/4294967295.0);
-  /* divided by 2^32-1 */
-}
-
-int
-Random::sign()
-{
-  return (rand()%2)?-1:1;
-}
-
-Random rnd;
-
-#ifdef __TEST__
-#include &lt;iostream&gt;
-
-int main()
-{
-  Random random(5489UL);
-  for(int i = 0; i &lt; 1000000; ++i)
-    {
-      std::cout &lt;&lt; random.drand(0, 5) &lt;&lt; std::endl;
-    }
-  return 0;
-}
-#endif
-
-/* EOF */

Copied: trunk/src/random.hpp (from rev 502, trunk/src/random.hxx)

Deleted: trunk/src/random.hxx
===================================================================
--- trunk/src/random.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/random.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,65 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_RANDOM_HXX
-#define HEADER_RANDOM_HXX
-
-/** */
-class Random
-{
-private:
-  /* Period parameters */
-  static const unsigned long N = 624;
-  static const unsigned long M = 397;
-  static const unsigned long MATRIX_A   = 0x9908b0dfUL;   /* constant vector a */
-  static const unsigned long UPPER_MASK = 0x80000000UL; /* most significant w-r bits */
-  static const unsigned long LOWER_MASK = 0x7fffffffUL; /* least significant r bits */
-
-  unsigned long mt[N]; /* the array for the state vector  */
-  unsigned long mti;
-
-public:
-  Random(unsigned long seed = 5489UL);
-
-  /** generates a random number on [0,0xffffffff]-interval */
-  unsigned long rand();
-
-  long rand(long range);
-  long rand(int start, int end);
-
-  /** Returns float random number between [start, end] */
-  double drand();
-
-  double drand(double range);
-
-  /** Returns a random number between \a start and \a end */
-  double drand(double start, double end);
-
-  /** Returns either 1 or -1 */
-  int sign();
-private:
-  Random (const Random&amp;);
-  Random&amp; operator= (const Random&amp;);
-};
-
-extern Random rnd;
-
-#endif
-
-/* EOF */

Copied: trunk/src/screen.cpp (from rev 502, trunk/src/screen.cxx)
===================================================================
--- trunk/src/screen.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/screen.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,129 @@
+//  $Id: screen.cxx,v 1.3 2003/10/10 21:06:22 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ClanLib/display.h&gt;
+
+#include &quot;windstille_main.hpp&quot;
+#include &quot;delta_manager.hpp&quot;
+#include &quot;screen.hpp&quot;
+#include &quot;fonts.hpp&quot;
+#include &quot;gameconfig.hpp&quot;
+#include &quot;sound/sound_manager.hpp&quot;
+
+namespace Windstille {
+
+Screen::Screen()
+  : frames(0)
+{
+}
+
+void 
+Screen::display()
+{
+  do_pause = false;
+  do_quit  = false;
+
+  on_startup();
+
+  DeltaManager delta_manager;
+
+  slot = CL_Keyboard::sig_key_down().connect(this, &amp;Screen::key_down);
+  while (!do_quit)
+    {
+      draw();
+      float delta = delta_manager.getset ();
+      float step = 10/1000.0f;
+      if (config-&gt;show_fps)
+        draw_fps(delta);
+      CL_Display::flip(0);
+      
+      ++frames;
+      
+      while (delta &gt; step)
+        {
+          update(step);
+          delta -= step;
+        }
+      // FIXME: non constant delta isn't a good idea
+      update(delta);
+      
+      // update(0.020f);
+
+      sound_manager-&gt;update();
+      CL_System::keep_alive ();
+      //CL_System::sleep (1);
+    }
+  CL_Keyboard::sig_key_down().disconnect(slot);
+
+  on_shutdown();
+}
+
+void 
+Screen::draw_fps(float delta)
+{
+  static float time_counter = 0;
+  static int fps_counter = 0;
+  static int fps_save = 0;
+
+  time_counter += delta;
+  ++fps_counter;
+
+  if (time_counter &gt; 1)
+  {
+    fps_save = fps_counter;
+    time_counter = 0;
+    fps_counter = 0;
+  }
+  
+  char output[20];
+  sprintf(output, &quot;FPS: %d&quot;, fps_save);
+  
+  Fonts::copyright.set_alpha(1.0f);
+  Fonts::copyright.set_alignment(origin_bottom_left);
+  Fonts::copyright.draw(CL_Display::get_width() - 100, 30, output);
+}
+
+void
+Screen::key_down(const CL_InputEvent&amp; event)
+{
+  switch (event.id) {
+    case CL_KEY_F10:
+      config-&gt;show_fps = ! (config-&gt;show_fps);
+      break;
+    case CL_KEY_F11:
+      config-&gt;use_fullscreen = ! (config-&gt;use_fullscreen);
+      
+      if (config-&gt;use_fullscreen)
+        CL_Display::set_fullscreen(config-&gt;screen_width,
+                                   config-&gt;screen_height, 32);
+      else
+        CL_Display::set_windowed();
+      break;
+    case CL_KEY_F12:
+      std::string filename = &quot;screenshot.png&quot;;
+      std::cout &lt;&lt; &quot;Saving screenshot to: &quot; &lt;&lt; filename &lt;&lt; std::endl;
+      CL_ProviderFactory::save(CL_Display::get_front_buffer(),
+                               filename);
+    break;
+    }
+}
+
+} // namespace Windstille
+
+/* EOF */

Deleted: trunk/src/screen.cxx
===================================================================
--- trunk/src/screen.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/screen.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,129 +0,0 @@
-//  $Id: screen.cxx,v 1.3 2003/10/10 21:06:22 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ClanLib/display.h&gt;
-
-#include &quot;windstille_main.hxx&quot;
-#include &quot;delta_manager.hxx&quot;
-#include &quot;screen.hxx&quot;
-#include &quot;fonts.hxx&quot;
-#include &quot;gameconfig.hpp&quot;
-#include &quot;sound/sound_manager.hpp&quot;
-
-namespace Windstille {
-
-Screen::Screen()
-  : frames(0)
-{
-}
-
-void 
-Screen::display()
-{
-  do_pause = false;
-  do_quit  = false;
-
-  on_startup();
-
-  DeltaManager delta_manager;
-
-  slot = CL_Keyboard::sig_key_down().connect(this, &amp;Screen::key_down);
-  while (!do_quit)
-    {
-      draw();
-      float delta = delta_manager.getset ();
-      float step = 10/1000.0f;
-      if (config-&gt;show_fps)
-        draw_fps(delta);
-      CL_Display::flip(0);
-      
-      ++frames;
-      
-      while (delta &gt; step)
-        {
-          update(step);
-          delta -= step;
-        }
-      // FIXME: non constant delta isn't a good idea
-      update(delta);
-      
-      // update(0.020f);
-
-      sound_manager-&gt;update();
-      CL_System::keep_alive ();
-      //CL_System::sleep (1);
-    }
-  CL_Keyboard::sig_key_down().disconnect(slot);
-
-  on_shutdown();
-}
-
-void 
-Screen::draw_fps(float delta)
-{
-  static float time_counter = 0;
-  static int fps_counter = 0;
-  static int fps_save = 0;
-
-  time_counter += delta;
-  ++fps_counter;
-
-  if (time_counter &gt; 1)
-  {
-    fps_save = fps_counter;
-    time_counter = 0;
-    fps_counter = 0;
-  }
-  
-  char output[20];
-  sprintf(output, &quot;FPS: %d&quot;, fps_save);
-  
-  Fonts::copyright.set_alpha(1.0f);
-  Fonts::copyright.set_alignment(origin_bottom_left);
-  Fonts::copyright.draw(CL_Display::get_width() - 100, 30, output);
-}
-
-void
-Screen::key_down(const CL_InputEvent&amp; event)
-{
-  switch (event.id) {
-    case CL_KEY_F10:
-      config-&gt;show_fps = ! (config-&gt;show_fps);
-      break;
-    case CL_KEY_F11:
-      config-&gt;use_fullscreen = ! (config-&gt;use_fullscreen);
-      
-      if (config-&gt;use_fullscreen)
-        CL_Display::set_fullscreen(config-&gt;screen_width,
-                                   config-&gt;screen_height, 32);
-      else
-        CL_Display::set_windowed();
-      break;
-    case CL_KEY_F12:
-      std::string filename = &quot;screenshot.png&quot;;
-      std::cout &lt;&lt; &quot;Saving screenshot to: &quot; &lt;&lt; filename &lt;&lt; std::endl;
-      CL_ProviderFactory::save(CL_Display::get_front_buffer(),
-                               filename);
-    break;
-    }
-}
-
-} // namespace Windstille
-
-/* EOF */

Copied: trunk/src/screen.hpp (from rev 502, trunk/src/screen.hxx)
===================================================================
--- trunk/src/screen.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/screen.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,65 @@
+//  $Id: screen.hpp,v 1.3 2003/10/10 21:06:22 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_SCREEN_HXX
+#define HEADER_SCREEN_HXX
+
+class CL_InputEvent;
+
+namespace Windstille {
+
+/** */
+class Screen
+{
+private:
+  void draw_fps(float delta);
+  void key_down(const CL_InputEvent&amp; event);
+  
+  bool do_quit;
+  bool do_pause;
+  CL_Slot slot;
+  
+protected:
+  int frames;
+  
+public:
+  Screen();
+  virtual ~Screen() {}
+
+  virtual void draw() =0;
+  virtual void update(float delta) =0;
+
+  virtual void on_startup() {}
+  virtual void on_shutdown() {}
+
+  void display();
+
+  virtual void quit() { do_quit = true; }
+  void set_pause(bool p) { do_pause = p; }
+  bool get_pause() { return do_pause; }
+private:
+  Screen (const Screen&amp;);
+  Screen&amp; operator= (const Screen&amp;);
+};
+
+} // namespace Windstille
+
+#endif
+
+/* EOF */

Deleted: trunk/src/screen.hxx
===================================================================
--- trunk/src/screen.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/screen.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,65 +0,0 @@
-//  $Id: screen.hxx,v 1.3 2003/10/10 21:06:22 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_SCREEN_HXX
-#define HEADER_SCREEN_HXX
-
-class CL_InputEvent;
-
-namespace Windstille {
-
-/** */
-class Screen
-{
-private:
-  void draw_fps(float delta);
-  void key_down(const CL_InputEvent&amp; event);
-  
-  bool do_quit;
-  bool do_pause;
-  CL_Slot slot;
-  
-protected:
-  int frames;
-  
-public:
-  Screen();
-  virtual ~Screen() {}
-
-  virtual void draw() =0;
-  virtual void update(float delta) =0;
-
-  virtual void on_startup() {}
-  virtual void on_shutdown() {}
-
-  void display();
-
-  virtual void quit() { do_quit = true; }
-  void set_pause(bool p) { do_pause = p; }
-  bool get_pause() { return do_pause; }
-private:
-  Screen (const Screen&amp;);
-  Screen&amp; operator= (const Screen&amp;);
-};
-
-} // namespace Windstille
-
-#endif
-
-/* EOF */

Modified: trunk/src/script_manager.cpp
===================================================================
--- trunk/src/script_manager.cpp	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/script_manager.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -11,7 +11,7 @@
 #include &lt;sqstdmath.h&gt;
 #include &lt;sqstdstring.h&gt;
 
-#include &quot;console.hxx&quot;
+#include &quot;console.hpp&quot;
 #include &quot;timer.hpp&quot;
 #include &quot;scripting/wrapper.hpp&quot;
 #include &quot;scripting/wrapper_util.hpp&quot;
@@ -54,8 +54,7 @@
   sq_setprintfunc(v, printfunc);
   
   // register windstille API
-  register_functions(v, windstille_global_functions);
-  register_classes(v, windstille_classes);
+  register_windstille_wrapper(v);
 }
 
 ScriptManager::~ScriptManager()

Modified: trunk/src/scripting/interface.cpp
===================================================================
--- trunk/src/scripting/interface.cpp	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/scripting/interface.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,7 +1,7 @@
 #include &quot;interface.hpp&quot;
 #include &quot;sound/sound_manager.hpp&quot;
-#include &quot;game_session.hxx&quot;
-#include &quot;dialog_manager.hxx&quot;
+#include &quot;game_session.hpp&quot;
+#include &quot;dialog_manager.hpp&quot;
 #include &quot;script_manager.hpp&quot;
 
 namespace Scripting
@@ -17,15 +17,21 @@
   sound_manager-&gt;play(soundfile);
 }
 
-void show_dialog(const std::string&amp; portrait, const std::string&amp; text)
+void set_dialog(int alignment, const std::string&amp; portrait,
+        const std::string&amp; text)
 {
-  DialogManager::current()-&gt;add_dialog(portrait, text);
+  DialogManager::current()-&gt;add_dialog(alignment, portrait, text);
+}
+
+void show_dialog(float fadein_time)
+{
+  (void) fadein_time;
   GameSession::current()-&gt;set_dialog_state();
 }
 
-void clear_dialog()
+void hide_dialog(float fadeout_time)
 {
-  DialogManager::current()-&gt;clear();
+  (void) fadeout_time;
   GameSession::current()-&gt;set_game_state();
 }
 

Modified: trunk/src/scripting/interface.hpp
===================================================================
--- trunk/src/scripting/interface.hpp	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/scripting/interface.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -13,10 +13,21 @@
 
 void play_sound(const std::string&amp; soundfile);
 
-void show_dialog(const std::string&amp; portrait, const std::string&amp; text);
+// alignment constants
+static const int VCENTER = 0x00;
+static const int LEFT    = 0x01;
+static const int RIGHT   = 0x02;
+static const int HCENTER = 0x00;
+static const int TOP     = 0x10;
+static const int BOTTOM  = 0x20;
 
-void clear_dialog();
+void set_dialog(int alignment, const std::string&amp; portrait,
+                const std::string&amp; text);
 
+void show_dialog(float fadein_time);
+
+void hide_dialog(float fadeout_time);
+
 /** @SUSPEND@
  * Waits the specified time in seconds.
  */

Modified: trunk/src/scripting/wrapper.cpp
===================================================================
--- trunk/src/scripting/wrapper.cpp	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/scripting/wrapper.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -34,27 +34,40 @@
   return 0;
 }
 
-static int show_dialog_wrapper(HSQUIRRELVM v)
+static int set_dialog_wrapper(HSQUIRRELVM v)
 {
-  const char* arg0;
-  sq_getstring(v, 2, &amp;arg0);
+  int arg0;
+  sq_getinteger(v, 2, &amp;arg0);
   const char* arg1;
   sq_getstring(v, 3, &amp;arg1);
+  const char* arg2;
+  sq_getstring(v, 4, &amp;arg2);
   
-  Scripting::show_dialog(arg0, arg1);
+  Scripting::set_dialog(arg0, arg1, arg2);
   
   return 0;
 }
 
-static int clear_dialog_wrapper(HSQUIRRELVM v)
+static int show_dialog_wrapper(HSQUIRRELVM v)
 {
-  (void) v;
+  float arg0;
+  sq_getfloat(v, 2, &amp;arg0);
   
-  Scripting::clear_dialog();
+  Scripting::show_dialog(arg0);
   
   return 0;
 }
 
+static int hide_dialog_wrapper(HSQUIRRELVM v)
+{
+  float arg0;
+  sq_getfloat(v, 2, &amp;arg0);
+  
+  Scripting::hide_dialog(arg0);
+  
+  return 0;
+}
+
 static int wait_wrapper(HSQUIRRELVM v)
 {
   HSQUIRRELVM arg0 = v;
@@ -69,13 +82,32 @@
 WrappedFunction windstille_global_functions[] = {
   { &quot;play_music&quot;, &amp;play_music_wrapper },
   { &quot;play_sound&quot;, &amp;play_sound_wrapper },
+  { &quot;set_dialog&quot;, &amp;set_dialog_wrapper },
   { &quot;show_dialog&quot;, &amp;show_dialog_wrapper },
-  { &quot;clear_dialog&quot;, &amp;clear_dialog_wrapper },
+  { &quot;hide_dialog&quot;, &amp;hide_dialog_wrapper },
   { &quot;wait&quot;, &amp;wait_wrapper },
   { 0, 0 }
 };
 
+WrappedConstant&lt;int&gt; windstille_int_constants[] = {
+  { &quot;VCENTER&quot;, 0},
+  { &quot;LEFT&quot;, 1},
+  { &quot;RIGHT&quot;, 2},
+  { &quot;HCENTER&quot;, 0},
+  { &quot;TOP&quot;, 16},
+  { &quot;BOTTOM&quot;, 32},
+  { 0, 0}
+};
+
+WrappedConstant&lt;float&gt; windstille_float_constants[] = {
+  { 0, 0}
+};
+
+WrappedConstant&lt;const char*&gt; windstille_string_constants[] = {
+  { 0, 0}
+};
+
 WrappedClass windstille_classes[] = {
-  { 0, 0 }
+  { 0, 0, 0, 0, 0 }
 };
 

Modified: trunk/src/scripting/wrapper.hpp
===================================================================
--- trunk/src/scripting/wrapper.hpp	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/scripting/wrapper.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -10,6 +10,18 @@
 
 extern WrappedFunction windstille_global_functions[];
 extern WrappedClass windstille_classes[];
+extern WrappedConstant&lt;int&gt; windstille_int_constants[];
+extern WrappedConstant&lt;float&gt; windstille_float_constants[];
+extern WrappedConstant&lt;const char*&gt; windstille_string_constants[];
 
+static inline void register_windstille_wrapper(HSQUIRRELVM v)
+{
+    register_functions(v, windstille_global_functions);
+    register_classes(v, windstille_classes);
+    register_constants(v, windstille_int_constants);
+    register_constants(v, windstille_float_constants);
+    register_constants(v, windstille_string_constants);
+}
+
 #endif
 

Copied: trunk/src/sector.cpp (from rev 502, trunk/src/sector.cxx)
===================================================================
--- trunk/src/sector.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/sector.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,186 @@
+//  $Id$
+//
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2005 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;iostream&gt;
+#include &lt;sstream&gt;
+#include &lt;stdexcept&gt;
+#include &quot;lisp/list_iterator.hpp&quot;
+#include &quot;lisp/parser.hpp&quot;
+#include &quot;globals.hpp&quot;
+#include &quot;display/scene_context.hpp&quot;
+#include &quot;tile_map.hpp&quot;
+#include &quot;game_object.hpp&quot;
+#include &quot;player.hpp&quot;
+#include &quot;trigger.hpp&quot;
+#include &quot;sector.hpp&quot;
+#include &quot;sound/sound_manager.hpp&quot;
+#include &quot;script_manager.hpp&quot;
+
+Sector* Sector::current_ = 0;
+
+Sector::Sector(const std::string&amp; filename)
+{
+  current_ = this;
+  interactive_tilemap = 0;
+  ambient_light = CL_Color(0, 0, 0);
+  parse_file(filename);
+  if (!interactive_tilemap)
+    std::cout &lt;&lt; &quot;Error: Sector: No interactive-tilemap available&quot; &lt;&lt; std::endl;
+}
+
+Sector::~Sector()
+{
+}
+
+void
+Sector::parse_file(const std::string&amp; filename)
+{
+  std::auto_ptr&lt;lisp::Lisp&gt; root(lisp::Parser::parse(filename));
+
+  const lisp::Lisp* sector = root-&gt;get_lisp(&quot;windstille-sector&quot;);
+  if(!sector) {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;'&quot; &lt;&lt; filename &lt;&lt; &quot;' is not a windstille-sector file&quot;;
+    throw std::runtime_error(msg.str());
+  }
+
+  std::vector&lt;int&gt; ambient_colors;
+  
+  lisp::ListIterator iter(sector);
+  while(iter.next()) {
+    if(iter.item() == &quot;version&quot;) {
+      if(iter.value().get_int() &gt; 2) {
+        std::cerr &lt;&lt; &quot;Warning: Levelformat is newer than game.\n&quot;;
+      }
+    } else if(iter.item() == &quot;name&quot;) {
+      name = iter.value().get_string();
+    } else if(iter.item() == &quot;music&quot;) {
+      music = iter.value().get_string();
+    } else if(iter.item() == &quot;init-script&quot;) {
+      init_script = iter.value().get_string();
+    } else if(iter.item() == &quot;ambient-color&quot;) {
+      iter.lisp()-&gt;get_vector(ambient_colors);
+      if(ambient_colors.size() != 3)
+        throw std::runtime_error(
+            &quot;ambient-color contains has to contain exactly 3 values&quot;);
+      ambient_light 
+        = CL_Color(ambient_colors[0], ambient_colors[1], ambient_colors[2]);
+    } else if(iter.item() == &quot;objects&quot;) {
+      lisp::ListIterator oiter(iter.lisp());
+      while(oiter.next()) {
+        parse_object(oiter.item(), oiter.lisp());
+      }
+    } else {
+      std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot; &lt;&lt; iter.item() &lt;&lt; &quot;' in sector\n&quot;;
+    }
+  }
+}
+
+void
+Sector::parse_object(const std::string&amp; name, const lisp::Lisp* lisp)
+{
+  if(name == &quot;tilemap&quot;) {
+    TileMap* tilemap = new TileMap(lisp);
+    add(tilemap);
+    if (tilemap-&gt;get_name() == &quot;interactive&quot;)
+      interactive_tilemap = tilemap;
+  } else if(name == &quot;background&quot;) {
+    // TODO
+  } else if(name == &quot;trigger&quot;) {
+    add(new Trigger(lisp));
+  } else {
+    std::cout &lt;&lt; &quot;Skipping unknown Object: &quot; &lt;&lt; name &lt;&lt; &quot;\n&quot;;
+  }
+}
+
+void
+Sector::activate()
+{
+  commit_adds();
+  commit_removes();
+
+  sound_manager-&gt;play_music(music);
+  script_manager-&gt;run_script(init_script, &quot;sector-init&quot;);
+}
+
+void
+Sector::draw(SceneContext&amp; sc)
+{
+  sc.light().fill_screen(ambient_light);
+
+  for(Objects::iterator i = objects.begin(); i != objects.end(); ++i)
+    {
+      (*i)-&gt;draw(sc);
+    }
+}
+
+void Sector::commit_adds()
+{
+  // Add new game objects
+  for(Objects::iterator i = new_objects.begin(); i != new_objects.end(); ++i) {
+    objects.push_back(*i);
+  }
+  new_objects.clear();
+}
+
+void Sector::update(float delta)
+{
+  commit_adds();
+  for(Objects::iterator i = objects.begin(); i != objects.end(); ++i) {
+    GameObject* object = *i;
+    object-&gt;update(delta);
+  }
+  commit_removes();
+}
+
+void
+Sector::commit_removes()
+{
+  // remove objects
+  for(Objects::iterator i = objects.begin(); i != objects.end(); ) {
+    GameObject* object = *i;
+    if(object-&gt;is_removable()) {
+      delete object;
+      i = objects.erase(i);
+      continue;
+    }
+
+    ++i;
+  }
+}
+
+void
+Sector::add(GameObject* obj)
+{
+  new_objects.push_back(obj);
+}
+
+int
+Sector::get_width () const
+{
+  return interactive_tilemap-&gt;get_width() * TILE_SIZE;
+}
+
+int
+Sector::get_height () const
+{
+  return interactive_tilemap-&gt;get_height() * TILE_SIZE;
+}
+
+/* EOF */

Deleted: trunk/src/sector.cxx
===================================================================
--- trunk/src/sector.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/sector.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,186 +0,0 @@
-//  $Id$
-//
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2005 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;iostream&gt;
-#include &lt;sstream&gt;
-#include &lt;stdexcept&gt;
-#include &quot;lisp/list_iterator.hpp&quot;
-#include &quot;lisp/parser.hpp&quot;
-#include &quot;globals.hxx&quot;
-#include &quot;display/scene_context.hxx&quot;
-#include &quot;tile_map.hxx&quot;
-#include &quot;game_object.hxx&quot;
-#include &quot;player.hxx&quot;
-#include &quot;trigger.hxx&quot;
-#include &quot;sector.hxx&quot;
-#include &quot;sound/sound_manager.hpp&quot;
-#include &quot;script_manager.hpp&quot;
-
-Sector* Sector::current_ = 0;
-
-Sector::Sector(const std::string&amp; filename)
-{
-  current_ = this;
-  interactive_tilemap = 0;
-  ambient_light = CL_Color(0, 0, 0);
-  parse_file(filename);
-  if (!interactive_tilemap)
-    std::cout &lt;&lt; &quot;Error: Sector: No interactive-tilemap available&quot; &lt;&lt; std::endl;
-}
-
-Sector::~Sector()
-{
-}
-
-void
-Sector::parse_file(const std::string&amp; filename)
-{
-  std::auto_ptr&lt;lisp::Lisp&gt; root(lisp::Parser::parse(filename));
-
-  const lisp::Lisp* sector = root-&gt;get_lisp(&quot;windstille-sector&quot;);
-  if(!sector) {
-    std::ostringstream msg;
-    msg &lt;&lt; &quot;'&quot; &lt;&lt; filename &lt;&lt; &quot;' is not a windstille-sector file&quot;;
-    throw std::runtime_error(msg.str());
-  }
-
-  std::vector&lt;int&gt; ambient_colors;
-  
-  lisp::ListIterator iter(sector);
-  while(iter.next()) {
-    if(iter.item() == &quot;version&quot;) {
-      if(iter.value().get_int() &gt; 2) {
-        std::cerr &lt;&lt; &quot;Warning: Levelformat is newer than game.\n&quot;;
-      }
-    } else if(iter.item() == &quot;name&quot;) {
-      name = iter.value().get_string();
-    } else if(iter.item() == &quot;music&quot;) {
-      music = iter.value().get_string();
-    } else if(iter.item() == &quot;init-script&quot;) {
-      init_script = iter.value().get_string();
-    } else if(iter.item() == &quot;ambient-color&quot;) {
-      iter.lisp()-&gt;get_vector(ambient_colors);
-      if(ambient_colors.size() != 3)
-        throw std::runtime_error(
-            &quot;ambient-color contains has to contain exactly 3 values&quot;);
-      ambient_light 
-        = CL_Color(ambient_colors[0], ambient_colors[1], ambient_colors[2]);
-    } else if(iter.item() == &quot;objects&quot;) {
-      lisp::ListIterator oiter(iter.lisp());
-      while(oiter.next()) {
-        parse_object(oiter.item(), oiter.lisp());
-      }
-    } else {
-      std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot; &lt;&lt; iter.item() &lt;&lt; &quot;' in sector\n&quot;;
-    }
-  }
-}
-
-void
-Sector::parse_object(const std::string&amp; name, const lisp::Lisp* lisp)
-{
-  if(name == &quot;tilemap&quot;) {
-    TileMap* tilemap = new TileMap(lisp);
-    add(tilemap);
-    if (tilemap-&gt;get_name() == &quot;interactive&quot;)
-      interactive_tilemap = tilemap;
-  } else if(name == &quot;background&quot;) {
-    // TODO
-  } else if(name == &quot;trigger&quot;) {
-    add(new Trigger(lisp));
-  } else {
-    std::cout &lt;&lt; &quot;Skipping unknown Object: &quot; &lt;&lt; name &lt;&lt; &quot;\n&quot;;
-  }
-}
-
-void
-Sector::activate()
-{
-  commit_adds();
-  commit_removes();
-
-  sound_manager-&gt;play_music(music);
-  script_manager-&gt;run_script(init_script, &quot;sector-init&quot;);
-}
-
-void
-Sector::draw(SceneContext&amp; sc)
-{
-  sc.light().fill_screen(ambient_light);
-
-  for(Objects::iterator i = objects.begin(); i != objects.end(); ++i)
-    {
-      (*i)-&gt;draw(sc);
-    }
-}
-
-void Sector::commit_adds()
-{
-  // Add new game objects
-  for(Objects::iterator i = new_objects.begin(); i != new_objects.end(); ++i) {
-    objects.push_back(*i);
-  }
-  new_objects.clear();
-}
-
-void Sector::update(float delta)
-{
-  commit_adds();
-  for(Objects::iterator i = objects.begin(); i != objects.end(); ++i) {
-    GameObject* object = *i;
-    object-&gt;update(delta);
-  }
-  commit_removes();
-}
-
-void
-Sector::commit_removes()
-{
-  // remove objects
-  for(Objects::iterator i = objects.begin(); i != objects.end(); ) {
-    GameObject* object = *i;
-    if(object-&gt;is_removable()) {
-      delete object;
-      i = objects.erase(i);
-      continue;
-    }
-
-    ++i;
-  }
-}
-
-void
-Sector::add(GameObject* obj)
-{
-  new_objects.push_back(obj);
-}
-
-int
-Sector::get_width () const
-{
-  return interactive_tilemap-&gt;get_width() * TILE_SIZE;
-}
-
-int
-Sector::get_height () const
-{
-  return interactive_tilemap-&gt;get_height() * TILE_SIZE;
-}
-
-/* EOF */

Copied: trunk/src/sector.hpp (from rev 502, trunk/src/sector.hxx)

Deleted: trunk/src/sector.hxx
===================================================================
--- trunk/src/sector.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/sector.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,91 +0,0 @@
-//  $Id$
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2005 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_SECTOR_HXX
-#define HEADER_SECTOR_HXX
-
-#include &lt;string&gt;
-#include &lt;vector&gt;
-#include &lt;ClanLib/Display/color.h&gt;
-#include &quot;lisp/lisp.hpp&quot;
-
-class GameObject;
-class TileMap;
-class Player;
-class SceneContext;
-
-/** */
-class Sector
-{
-private:
-  std::string name;
-  std::string music;
-  std::string init_script;
-
-  typedef std::vector&lt;GameObject*&gt; Objects;
-  Objects objects;
-  /** container for newly created GameObjects (they'll be added once per frame
-   * in the update function
-   */
-  Objects new_objects;
-
-  CL_Color ambient_light;
-
-  /** The TileMap with which the player interacts */
-  TileMap* interactive_tilemap;
-
-  Player* player;
-
-  void parse_file(const std::string&amp; filename);
-  void parse_object(const std::string&amp; name, const lisp::Lisp* lisp);
-
-  static Sector* current_;
-
-  void commit_adds();
-  void commit_removes();
-public:
-  Sector(const std::string&amp; filename);
-  ~Sector();
-
-  static Sector* current() { return current_; }
-
-  void draw(SceneContext&amp; gc);
-  void update(float delta);
-
-  /**
-   * activates the sector. (Runs init script, changes music)
-   */
-  void activate();
-
-  int get_width () const;
-  int get_height () const;
-
-  void add(GameObject*);
-
-  std::vector&lt;GameObject*&gt;* get_objects() { return &objects; }
-  TileMap* get_tilemap() { return interactive_tilemap; }
-  
-private:
-  Sector (const Sector&amp;);
-  Sector&amp; operator= (const Sector&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/sprite3d.cpp (from rev 502, trunk/src/sprite3d.cxx)
===================================================================
--- trunk/src/sprite3d.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/sprite3d.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,333 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;vector&gt;
+#include &lt;ClanLib/gl.h&gt;
+#include &lt;ClanLib/display.h&gt;
+#include &quot;lisp/lisp.hpp&quot;
+#include &quot;lisp/parser.hpp&quot;
+#include &quot;lisp/list_iterator.hpp&quot;
+#include &quot;display/drawing_request.hpp&quot;
+#include &quot;display/scene_context.hpp&quot;
+#include &quot;sprite3d.hpp&quot;
+#include &quot;lisp_util.hpp&quot;
+#include &quot;globals.hpp&quot;
+
+struct Vertex
+{
+  CL_Vector pos;
+  CL_Vector normal;
+};
+
+struct Vert
+{
+  /** Vertex index */
+  unsigned int index;
+  float u;
+  float v;
+};
+
+struct Face
+{
+  // Vertices
+  Vert v[3];
+};
+
+static inline void read_vector(const lisp::Lisp* lisp, CL_Vector&amp; vec)
+{
+  if(lisp-&gt;get_type() != lisp::Lisp::TYPE_CONS || lisp-&gt;get_car() == 0)
+    throw std::runtime_error(&quot;Invalid data when reading CL_Vector&quot;);
+  vec.x = lisp-&gt;get_car()-&gt;get_float();
+  if(lisp-&gt;get_cdr() == 0)
+    throw std::runtime_error(&quot;Must specified 3 floats for CL_vector&quot;);
+  lisp = lisp-&gt;get_cdr();
+  if(lisp-&gt;get_type() != lisp::Lisp::TYPE_CONS || lisp-&gt;get_car() == 0)
+    throw std::runtime_error(&quot;Invalid data when reading CL_Vector&quot;);
+  vec.y = lisp-&gt;get_car()-&gt;get_float();
+  if(lisp-&gt;get_cdr() == 0)
+    throw std::runtime_error(&quot;Must specified 3 floats for CL_vector&quot;);
+  lisp = lisp-&gt;get_cdr();
+  if(lisp-&gt;get_type() != lisp::Lisp::TYPE_CONS || lisp-&gt;get_car() == 0)
+    throw std::runtime_error(&quot;Invalid data when reading CL_Vector&quot;);
+  vec.z = lisp-&gt;get_car()-&gt;get_float();
+}
+
+static void read_vert(const lisp::Lisp* lisp, Vert&amp; vert)
+{
+  if(lisp-&gt;get_type() != lisp::Lisp::TYPE_CONS || lisp-&gt;get_car() == 0)
+    throw std::runtime_error(&quot;Invalid data when reading CL_Vector&quot;);
+  vert.index = lisp-&gt;get_car()-&gt;get_int();
+  if(lisp-&gt;get_cdr() == 0)
+    throw std::runtime_error(&quot;Must specified 3 floats for CL_vector&quot;);
+  lisp = lisp-&gt;get_cdr();
+  if(lisp-&gt;get_type() != lisp::Lisp::TYPE_CONS || lisp-&gt;get_car() == 0)
+    throw std::runtime_error(&quot;Invalid data when reading CL_Vector&quot;);
+  vert.u = lisp-&gt;get_car()-&gt;get_float();
+  if(lisp-&gt;get_cdr() == 0)
+    throw std::runtime_error(&quot;Must specified 3 floats for CL_vector&quot;);
+  lisp = lisp-&gt;get_cdr();
+  if(lisp-&gt;get_type() != lisp::Lisp::TYPE_CONS || lisp-&gt;get_car() == 0)
+    throw std::runtime_error(&quot;Invalid data when reading CL_Vector&quot;);
+  vert.v = lisp-&gt;get_car()-&gt;get_float();
+}
+
+static void read_face(const lisp::Lisp* lisp, Face&amp; face)
+{
+  lisp::ListIterator iter(lisp);
+  int i = 0;
+  while(iter.next()) {
+    if(iter.item() == &quot;vert&quot;) {
+      if(i &gt;= 3)
+        throw std::runtime_error(&quot;Too many vertices for face (should be 3)&quot;);
+      read_vert(iter.lisp(), face.v[i]);
+      i++;
+    } else {
+      std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot; &lt;&lt; iter.item() &lt;&lt; &quot;' in face.\n&quot;;
+    }
+  }
+  if(i &lt; 2) {
+    throw std::runtime_error(&quot;Too few vertices in face (should be 3)&quot;);
+  }
+}
+
+class Sprite3DImpl
+{
+public:
+  typedef std::vector&lt;Vertex&gt; Vertices;
+  typedef std::vector&lt;Face&gt;   Faces;
+
+  Vertices vertices;
+  Faces    faces;
+  CL_OpenGLSurface surface;
+
+  GLuint buffer_id;
+  typedef std::vector&lt;float&gt; Floats;
+  Floats raw_data;
+  int    normals_offset;
+  int    texcoord_offset;
+  bool   use_vbo;
+
+  float angle;
+
+  Sprite3DImpl()
+    : buffer_id(0), 
+      use_vbo(false),
+      angle(0)
+  {
+  }
+
+  ~Sprite3DImpl()
+  {
+    if (use_vbo)
+      {
+        clDeleteBuffers(1, &amp;buffer_id);
+      }
+  }
+
+  void create_vertex_arrays()
+  {
+    Floats raw_texcoords;
+    Floats raw_normals;
+    Floats raw_vertices;
+
+    for(Sprite3DImpl::Faces::iterator i = faces.begin(); i != faces.end(); ++i)
+      {
+        const Face&amp; face = *i;
+        for(int v = 0; v &lt; 3; ++v) {
+          const Vert&amp; vert = face.v[v];
+
+          raw_texcoords.push_back(vert.u);
+          raw_texcoords.push_back(vert.v);
+
+          const Vertex&amp; vertex = vertices[vert.index];
+
+          raw_normals.push_back(vertex.normal.x);
+          raw_normals.push_back(vertex.normal.y);
+          raw_normals.push_back(vertex.normal.z);
+
+          raw_vertices.push_back(vertex.pos.x);
+          raw_vertices.push_back(vertex.pos.y);
+          raw_vertices.push_back(vertex.pos.z);
+        }
+      }
+
+    std::copy(raw_vertices.begin(),  raw_vertices.end(),  std::back_inserter(raw_data));
+    std::copy(raw_normals.begin(),   raw_normals.end(),   std::back_inserter(raw_data));
+    std::copy(raw_texcoords.begin(), raw_texcoords.end(), std::back_inserter(raw_data));
+
+    normals_offset  = raw_vertices.size() * sizeof(float);
+    texcoord_offset = normals_offset + raw_normals.size() * sizeof(float);
+
+    if (use_vbo)
+      {
+        clGenBuffers(1, &amp;buffer_id);
+        clBindBuffer(CL_ARRAY_BUFFER, buffer_id);
+        clBufferData(CL_ARRAY_BUFFER, raw_data.size() * sizeof(float), &amp;(*raw_data.begin()), CL_STATIC_DRAW);
+      }
+  }
+
+  void parse_file(const std::string&amp; filename)
+  {
+    std::auto_ptr&lt;lisp::Lisp&gt; root (lisp::Parser::parse(filename));
+
+    const lisp::Lisp* spritelisp = root-&gt;get_lisp(&quot;windstille-3dsprite&quot;);
+    if(!spritelisp) {
+      std::ostringstream msg;
+      msg &lt;&lt; &quot;'&quot; &lt;&lt; filename &lt;&lt; &quot;' is not a windstille-3dsprite file&quot;;
+      throw std::runtime_error(msg.str());
+    }
+
+    lisp::ListIterator iter(spritelisp);
+    while(iter.next()) {
+      if(iter.item() == &quot;texture&quot;) {
+        surface = CL_OpenGLSurface(datadir + iter.value().get_string());
+      } else if(iter.item() == &quot;vertices&quot;) {
+        lisp::ListIterator vertices_iter(iter.lisp());
+        while(vertices_iter.next()) {
+          if(vertices_iter.item() == &quot;vertex&quot;) {
+            const lisp::Lisp* vlisp = vertices_iter.lisp();
+            Vertex vertex;
+            const lisp::Lisp* poslisp = vlisp-&gt;get_lisp(&quot;pos&quot;);
+            if(poslisp == 0)
+              throw std::runtime_error(&quot;Vertex without pos found&quot;);
+            read_vector(poslisp, vertex.pos);
+            const lisp::Lisp* normallisp = vlisp-&gt;get_lisp(&quot;normal&quot;);
+            if(normallisp == 0)
+              throw std::runtime_error(&quot;Vertex without normal found&quot;);
+            read_vector(normallisp, vertex.normal);
+                        
+            vertices.push_back(vertex);
+          } else {
+            std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot; 
+                      &lt;&lt; vertices_iter.item() &lt;&lt; &quot;' in vertices\n&quot;;
+          }
+        }
+      } else if(iter.item() == &quot;faces&quot;) {
+        lisp::ListIterator faces_iter(iter.lisp());
+        while(faces_iter.next()) {
+          if(faces_iter.item() == &quot;face&quot;) {
+            Face face;
+            read_face(faces_iter.lisp(), face);
+            faces.push_back(face);                        
+          } else {
+            std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot;
+                      &lt;&lt; faces_iter.item() &lt;&lt; &quot;' in faces\n&quot;;
+          }
+        }
+      } else {
+        std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot;
+                  &lt;&lt; iter.item() &lt;&lt; &quot;' in sprite3d\n&quot;;
+      }
+    }
+
+    create_vertex_arrays();
+  }
+};
+
+Sprite3D::Sprite3D(const std::string&amp; filename)
+  : impl(new Sprite3DImpl)
+{
+  impl-&gt;parse_file(filename);
+}
+
+Sprite3D::~Sprite3D()
+{
+  delete impl;
+}
+
+void
+Sprite3D::update(float delta)
+{
+  impl-&gt;angle += 30.0f* delta;
+}
+
+class Sprite3DDrawingRequest : public DrawingRequest
+{
+private:
+  Sprite3DImpl* impl;
+
+public:
+  Sprite3DDrawingRequest(Sprite3DImpl* impl_,
+                         const CL_Vector&amp; pos, const CL_Matrix4x4&amp; modelview = CL_Matrix4x4(true))
+    : DrawingRequest(pos, modelview), 
+      impl(impl_)
+  {
+  }
+
+  virtual ~Sprite3DDrawingRequest() {}
+
+  void draw(CL_GraphicContext* gc) 
+  {
+    // FIXME: This must be moved into a DrawingRequest
+    CL_OpenGLState state(gc);
+    state.set_active();
+    state.setup_2d();
+  
+    glPushMatrix();
+
+    glMultMatrixd(modelview);
+
+    glTranslatef(pos.x, pos.y, pos.z); //pos.z);
+    
+    // FIXME: just for testing, remove for production
+    glRotated(impl-&gt;angle, 0, 1.0, 0);
+
+    glClear(GL_DEPTH_BUFFER_BIT);
+    glEnable(GL_DEPTH_TEST);
+    glEnable(GL_TEXTURE_2D);
+    impl-&gt;surface.bind();
+
+    {
+      GLbyte* data = impl-&gt;use_vbo ? 0 : reinterpret_cast&lt;GLbyte*&gt;(&amp;*impl-&gt;raw_data.begin());
+
+      if (impl-&gt;use_vbo)
+        clBindBuffer(CL_ARRAY_BUFFER, impl-&gt;buffer_id);
+
+      clVertexPointer  (3, CL_FLOAT, 0, data);
+      clNormalPointer     (CL_FLOAT, 0, data + impl-&gt;normals_offset);
+      clTexCoordPointer(2, CL_FLOAT, 0, data + impl-&gt;texcoord_offset);
+    
+      // Enable arrays
+      clEnableClientState(CL_TEXTURE_COORD_ARRAY);
+      clEnableClientState(CL_NORMAL_ARRAY);
+      clEnableClientState(CL_VERTEX_ARRAY);
+    
+      // Draw arrays
+      clDrawArrays(CL_TRIANGLES, 0, impl-&gt;faces.size()*3);
+
+      // Disable arrays
+      clDisableClientState(CL_TEXTURE_COORD_ARRAY);
+      clDisableClientState(CL_NORMAL_ARRAY);
+      clDisableClientState(CL_VERTEX_ARRAY);
+
+      if (impl-&gt;use_vbo)
+        clBindBuffer(CL_ARRAY_BUFFER, 0);
+    }
+
+    glPopMatrix();   
+  }
+};
+
+void
+Sprite3D::draw(SceneContext&amp; sc)
+{
+  sc.color().draw(new Sprite3DDrawingRequest(impl, CL_Vector(12*32, 26*32, 100), sc.color().get_modelview()));
+}
+
+/* EOF */

Deleted: trunk/src/sprite3d.cxx
===================================================================
--- trunk/src/sprite3d.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/sprite3d.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,333 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;vector&gt;
-#include &lt;ClanLib/gl.h&gt;
-#include &lt;ClanLib/display.h&gt;
-#include &quot;lisp/lisp.hpp&quot;
-#include &quot;lisp/parser.hpp&quot;
-#include &quot;lisp/list_iterator.hpp&quot;
-#include &quot;display/drawing_request.hxx&quot;
-#include &quot;display/scene_context.hxx&quot;
-#include &quot;sprite3d.hxx&quot;
-#include &quot;lisp_util.hpp&quot;
-#include &quot;globals.hxx&quot;
-
-struct Vertex
-{
-  CL_Vector pos;
-  CL_Vector normal;
-};
-
-struct Vert
-{
-  /** Vertex index */
-  unsigned int index;
-  float u;
-  float v;
-};
-
-struct Face
-{
-  // Vertices
-  Vert v[3];
-};
-
-static inline void read_vector(const lisp::Lisp* lisp, CL_Vector&amp; vec)
-{
-  if(lisp-&gt;get_type() != lisp::Lisp::TYPE_CONS || lisp-&gt;get_car() == 0)
-    throw std::runtime_error(&quot;Invalid data when reading CL_Vector&quot;);
-  vec.x = lisp-&gt;get_car()-&gt;get_float();
-  if(lisp-&gt;get_cdr() == 0)
-    throw std::runtime_error(&quot;Must specified 3 floats for CL_vector&quot;);
-  lisp = lisp-&gt;get_cdr();
-  if(lisp-&gt;get_type() != lisp::Lisp::TYPE_CONS || lisp-&gt;get_car() == 0)
-    throw std::runtime_error(&quot;Invalid data when reading CL_Vector&quot;);
-  vec.y = lisp-&gt;get_car()-&gt;get_float();
-  if(lisp-&gt;get_cdr() == 0)
-    throw std::runtime_error(&quot;Must specified 3 floats for CL_vector&quot;);
-  lisp = lisp-&gt;get_cdr();
-  if(lisp-&gt;get_type() != lisp::Lisp::TYPE_CONS || lisp-&gt;get_car() == 0)
-    throw std::runtime_error(&quot;Invalid data when reading CL_Vector&quot;);
-  vec.z = lisp-&gt;get_car()-&gt;get_float();
-}
-
-static void read_vert(const lisp::Lisp* lisp, Vert&amp; vert)
-{
-  if(lisp-&gt;get_type() != lisp::Lisp::TYPE_CONS || lisp-&gt;get_car() == 0)
-    throw std::runtime_error(&quot;Invalid data when reading CL_Vector&quot;);
-  vert.index = lisp-&gt;get_car()-&gt;get_int();
-  if(lisp-&gt;get_cdr() == 0)
-    throw std::runtime_error(&quot;Must specified 3 floats for CL_vector&quot;);
-  lisp = lisp-&gt;get_cdr();
-  if(lisp-&gt;get_type() != lisp::Lisp::TYPE_CONS || lisp-&gt;get_car() == 0)
-    throw std::runtime_error(&quot;Invalid data when reading CL_Vector&quot;);
-  vert.u = lisp-&gt;get_car()-&gt;get_float();
-  if(lisp-&gt;get_cdr() == 0)
-    throw std::runtime_error(&quot;Must specified 3 floats for CL_vector&quot;);
-  lisp = lisp-&gt;get_cdr();
-  if(lisp-&gt;get_type() != lisp::Lisp::TYPE_CONS || lisp-&gt;get_car() == 0)
-    throw std::runtime_error(&quot;Invalid data when reading CL_Vector&quot;);
-  vert.v = lisp-&gt;get_car()-&gt;get_float();
-}
-
-static void read_face(const lisp::Lisp* lisp, Face&amp; face)
-{
-  lisp::ListIterator iter(lisp);
-  int i = 0;
-  while(iter.next()) {
-    if(iter.item() == &quot;vert&quot;) {
-      if(i &gt;= 3)
-        throw std::runtime_error(&quot;Too many vertices for face (should be 3)&quot;);
-      read_vert(iter.lisp(), face.v[i]);
-      i++;
-    } else {
-      std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot; &lt;&lt; iter.item() &lt;&lt; &quot;' in face.\n&quot;;
-    }
-  }
-  if(i &lt; 2) {
-    throw std::runtime_error(&quot;Too few vertices in face (should be 3)&quot;);
-  }
-}
-
-class Sprite3DImpl
-{
-public:
-  typedef std::vector&lt;Vertex&gt; Vertices;
-  typedef std::vector&lt;Face&gt;   Faces;
-
-  Vertices vertices;
-  Faces    faces;
-  CL_OpenGLSurface surface;
-
-  GLuint buffer_id;
-  typedef std::vector&lt;float&gt; Floats;
-  Floats raw_data;
-  int    normals_offset;
-  int    texcoord_offset;
-  bool   use_vbo;
-
-  float angle;
-
-  Sprite3DImpl()
-    : buffer_id(0), 
-      use_vbo(false),
-      angle(0)
-  {
-  }
-
-  ~Sprite3DImpl()
-  {
-    if (use_vbo)
-      {
-        clDeleteBuffers(1, &amp;buffer_id);
-      }
-  }
-
-  void create_vertex_arrays()
-  {
-    Floats raw_texcoords;
-    Floats raw_normals;
-    Floats raw_vertices;
-
-    for(Sprite3DImpl::Faces::iterator i = faces.begin(); i != faces.end(); ++i)
-      {
-        const Face&amp; face = *i;
-        for(int v = 0; v &lt; 3; ++v) {
-          const Vert&amp; vert = face.v[v];
-
-          raw_texcoords.push_back(vert.u);
-          raw_texcoords.push_back(vert.v);
-
-          const Vertex&amp; vertex = vertices[vert.index];
-
-          raw_normals.push_back(vertex.normal.x);
-          raw_normals.push_back(vertex.normal.y);
-          raw_normals.push_back(vertex.normal.z);
-
-          raw_vertices.push_back(vertex.pos.x);
-          raw_vertices.push_back(vertex.pos.y);
-          raw_vertices.push_back(vertex.pos.z);
-        }
-      }
-
-    std::copy(raw_vertices.begin(),  raw_vertices.end(),  std::back_inserter(raw_data));
-    std::copy(raw_normals.begin(),   raw_normals.end(),   std::back_inserter(raw_data));
-    std::copy(raw_texcoords.begin(), raw_texcoords.end(), std::back_inserter(raw_data));
-
-    normals_offset  = raw_vertices.size() * sizeof(float);
-    texcoord_offset = normals_offset + raw_normals.size() * sizeof(float);
-
-    if (use_vbo)
-      {
-        clGenBuffers(1, &amp;buffer_id);
-        clBindBuffer(CL_ARRAY_BUFFER, buffer_id);
-        clBufferData(CL_ARRAY_BUFFER, raw_data.size() * sizeof(float), &amp;(*raw_data.begin()), CL_STATIC_DRAW);
-      }
-  }
-
-  void parse_file(const std::string&amp; filename)
-  {
-    std::auto_ptr&lt;lisp::Lisp&gt; root (lisp::Parser::parse(filename));
-
-    const lisp::Lisp* spritelisp = root-&gt;get_lisp(&quot;windstille-3dsprite&quot;);
-    if(!spritelisp) {
-      std::ostringstream msg;
-      msg &lt;&lt; &quot;'&quot; &lt;&lt; filename &lt;&lt; &quot;' is not a windstille-3dsprite file&quot;;
-      throw std::runtime_error(msg.str());
-    }
-
-    lisp::ListIterator iter(spritelisp);
-    while(iter.next()) {
-      if(iter.item() == &quot;texture&quot;) {
-        surface = CL_OpenGLSurface(datadir + iter.value().get_string());
-      } else if(iter.item() == &quot;vertices&quot;) {
-        lisp::ListIterator vertices_iter(iter.lisp());
-        while(vertices_iter.next()) {
-          if(vertices_iter.item() == &quot;vertex&quot;) {
-            const lisp::Lisp* vlisp = vertices_iter.lisp();
-            Vertex vertex;
-            const lisp::Lisp* poslisp = vlisp-&gt;get_lisp(&quot;pos&quot;);
-            if(poslisp == 0)
-              throw std::runtime_error(&quot;Vertex without pos found&quot;);
-            read_vector(poslisp, vertex.pos);
-            const lisp::Lisp* normallisp = vlisp-&gt;get_lisp(&quot;normal&quot;);
-            if(normallisp == 0)
-              throw std::runtime_error(&quot;Vertex without normal found&quot;);
-            read_vector(normallisp, vertex.normal);
-                        
-            vertices.push_back(vertex);
-          } else {
-            std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot; 
-                      &lt;&lt; vertices_iter.item() &lt;&lt; &quot;' in vertices\n&quot;;
-          }
-        }
-      } else if(iter.item() == &quot;faces&quot;) {
-        lisp::ListIterator faces_iter(iter.lisp());
-        while(faces_iter.next()) {
-          if(faces_iter.item() == &quot;face&quot;) {
-            Face face;
-            read_face(faces_iter.lisp(), face);
-            faces.push_back(face);                        
-          } else {
-            std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot;
-                      &lt;&lt; faces_iter.item() &lt;&lt; &quot;' in faces\n&quot;;
-          }
-        }
-      } else {
-        std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot;
-                  &lt;&lt; iter.item() &lt;&lt; &quot;' in sprite3d\n&quot;;
-      }
-    }
-
-    create_vertex_arrays();
-  }
-};
-
-Sprite3D::Sprite3D(const std::string&amp; filename)
-  : impl(new Sprite3DImpl)
-{
-  impl-&gt;parse_file(filename);
-}
-
-Sprite3D::~Sprite3D()
-{
-  delete impl;
-}
-
-void
-Sprite3D::update(float delta)
-{
-  impl-&gt;angle += 30.0f* delta;
-}
-
-class Sprite3DDrawingRequest : public DrawingRequest
-{
-private:
-  Sprite3DImpl* impl;
-
-public:
-  Sprite3DDrawingRequest(Sprite3DImpl* impl_,
-                         const CL_Vector&amp; pos, const CL_Matrix4x4&amp; modelview = CL_Matrix4x4(true))
-    : DrawingRequest(pos, modelview), 
-      impl(impl_)
-  {
-  }
-
-  virtual ~Sprite3DDrawingRequest() {}
-
-  void draw(CL_GraphicContext* gc) 
-  {
-    // FIXME: This must be moved into a DrawingRequest
-    CL_OpenGLState state(gc);
-    state.set_active();
-    state.setup_2d();
-  
-    glPushMatrix();
-
-    glMultMatrixd(modelview);
-
-    glTranslatef(pos.x, pos.y, pos.z); //pos.z);
-    
-    // FIXME: just for testing, remove for production
-    glRotated(impl-&gt;angle, 0, 1.0, 0);
-
-    glClear(GL_DEPTH_BUFFER_BIT);
-    glEnable(GL_DEPTH_TEST);
-    glEnable(GL_TEXTURE_2D);
-    impl-&gt;surface.bind();
-
-    {
-      GLbyte* data = impl-&gt;use_vbo ? 0 : reinterpret_cast&lt;GLbyte*&gt;(&amp;*impl-&gt;raw_data.begin());
-
-      if (impl-&gt;use_vbo)
-        clBindBuffer(CL_ARRAY_BUFFER, impl-&gt;buffer_id);
-
-      clVertexPointer  (3, CL_FLOAT, 0, data);
-      clNormalPointer     (CL_FLOAT, 0, data + impl-&gt;normals_offset);
-      clTexCoordPointer(2, CL_FLOAT, 0, data + impl-&gt;texcoord_offset);
-    
-      // Enable arrays
-      clEnableClientState(CL_TEXTURE_COORD_ARRAY);
-      clEnableClientState(CL_NORMAL_ARRAY);
-      clEnableClientState(CL_VERTEX_ARRAY);
-    
-      // Draw arrays
-      clDrawArrays(CL_TRIANGLES, 0, impl-&gt;faces.size()*3);
-
-      // Disable arrays
-      clDisableClientState(CL_TEXTURE_COORD_ARRAY);
-      clDisableClientState(CL_NORMAL_ARRAY);
-      clDisableClientState(CL_VERTEX_ARRAY);
-
-      if (impl-&gt;use_vbo)
-        clBindBuffer(CL_ARRAY_BUFFER, 0);
-    }
-
-    glPopMatrix();   
-  }
-};
-
-void
-Sprite3D::draw(SceneContext&amp; sc)
-{
-  sc.color().draw(new Sprite3DDrawingRequest(impl, CL_Vector(12*32, 26*32, 100), sc.color().get_modelview()));
-}
-
-/* EOF */

Copied: trunk/src/sprite3d.hpp (from rev 502, trunk/src/sprite3d.hxx)
===================================================================
--- trunk/src/sprite3d.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/sprite3d.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,49 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_SPRITE3D_HXX
+#define HEADER_SPRITE3D_HXX
+
+#include &lt;string&gt;
+#include &quot;game_object.hpp&quot;
+
+class SceneContext;
+class Sprite3DImpl;
+
+/** */
+class Sprite3D : public GameObject
+{
+private:
+public:
+  Sprite3D(const std::string&amp; filename);
+  virtual ~Sprite3D();
+
+  void update(float delta);
+  void draw(SceneContext&amp; sc);
+
+private:
+  Sprite3D (const Sprite3D&amp;);
+  Sprite3D&amp; operator= (const Sprite3D&amp;);
+
+  Sprite3DImpl* impl;
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/sprite3d.hxx
===================================================================
--- trunk/src/sprite3d.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/sprite3d.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,49 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_SPRITE3D_HXX
-#define HEADER_SPRITE3D_HXX
-
-#include &lt;string&gt;
-#include &quot;game_object.hxx&quot;
-
-class SceneContext;
-class Sprite3DImpl;
-
-/** */
-class Sprite3D : public GameObject
-{
-private:
-public:
-  Sprite3D(const std::string&amp; filename);
-  virtual ~Sprite3D();
-
-  void update(float delta);
-  void draw(SceneContext&amp; sc);
-
-private:
-  Sprite3D (const Sprite3D&amp;);
-  Sprite3D&amp; operator= (const Sprite3D&amp;);
-
-  Sprite3DImpl* impl;
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/tile.cpp (from rev 502, trunk/src/tile.cxx)
===================================================================
--- trunk/src/tile.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/tile.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,65 @@
+//  $Id: tile.cxx,v 1.4 2003/09/22 18:37:05 grumbel Exp $
+//
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ClanLib/Core/System/error.h&gt;
+#include &lt;ClanLib/Display/sprite_description.h&gt;
+#include &lt;ClanLib/Display/pixel_buffer.h&gt;
+#include &lt;iostream&gt;
+#include &quot;globals.hpp&quot;
+#include &quot;tile.hpp&quot;
+
+Tile::Tile(const std::string&amp; filename, 
+           const std::string&amp; highlight_filename,
+           unsigned int arg_colmap)
+  : colmap(arg_colmap)
+{
+  color     = CL_Sprite(filename, resources);
+  highlight = CL_Sprite(highlight_filename, resources);
+}
+
+Tile::Tile(const CL_PixelBuffer&amp; buffer, 
+           const CL_PixelBuffer&amp; hl_buffer, 
+           unsigned int arg_colmap)
+  : colmap(arg_colmap)
+{
+  CL_SpriteDescription desc;
+  desc.add_frame(buffer);
+  color = CL_Sprite(desc);
+
+  if (hl_buffer)
+    {
+      CL_SpriteDescription hl_desc;
+      hl_desc.add_frame(hl_buffer);
+      highlight = CL_Sprite(hl_desc);
+    }
+}
+
+CL_Sprite&amp;
+Tile::get_color_sprite()
+{
+  return color;
+}
+
+CL_Sprite&amp;
+Tile::get_highlight_sprite()
+{
+  return highlight;
+}
+
+/* EOF */

Deleted: trunk/src/tile.cxx
===================================================================
--- trunk/src/tile.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/tile.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,65 +0,0 @@
-//  $Id: tile.cxx,v 1.4 2003/09/22 18:37:05 grumbel Exp $
-//
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ClanLib/Core/System/error.h&gt;
-#include &lt;ClanLib/Display/sprite_description.h&gt;
-#include &lt;ClanLib/Display/pixel_buffer.h&gt;
-#include &lt;iostream&gt;
-#include &quot;globals.hxx&quot;
-#include &quot;tile.hxx&quot;
-
-Tile::Tile(const std::string&amp; filename, 
-           const std::string&amp; highlight_filename,
-           unsigned int arg_colmap)
-  : colmap(arg_colmap)
-{
-  color     = CL_Sprite(filename, resources);
-  highlight = CL_Sprite(highlight_filename, resources);
-}
-
-Tile::Tile(const CL_PixelBuffer&amp; buffer, 
-           const CL_PixelBuffer&amp; hl_buffer, 
-           unsigned int arg_colmap)
-  : colmap(arg_colmap)
-{
-  CL_SpriteDescription desc;
-  desc.add_frame(buffer);
-  color = CL_Sprite(desc);
-
-  if (hl_buffer)
-    {
-      CL_SpriteDescription hl_desc;
-      hl_desc.add_frame(hl_buffer);
-      highlight = CL_Sprite(hl_desc);
-    }
-}
-
-CL_Sprite&amp;
-Tile::get_color_sprite()
-{
-  return color;
-}
-
-CL_Sprite&amp;
-Tile::get_highlight_sprite()
-{
-  return highlight;
-}
-
-/* EOF */

Copied: trunk/src/tile.hpp (from rev 502, trunk/src/tile.hxx)
===================================================================
--- trunk/src/tile.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/tile.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,65 @@
+//  $Id: tile.hpp,v 1.6 2003/09/22 18:37:05 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_TILE_HXX
+#define HEADER_TILE_HXX
+
+#include &lt;assert.h&gt;
+#include &lt;ClanLib/Display/sprite.h&gt;
+#include &lt;ClanLib/GL/opengl_surface.h&gt;
+
+/** A Tile is a surface or sprite together with information for
+ *  collision detection (aka colmap). The collision map is at a
+ *  resolution of 8x8 bits. Position information is handled in the
+ *  TileMap and not here. (flyweight pattern). */
+class Tile
+{
+private:
+  CL_Sprite color;
+  CL_Sprite highlight;
+
+public:
+  CL_Rectf         color_rect;
+  int              color_packer;
+
+  CL_Rectf         highlight_rect;
+  int              highlight_packer;
+
+  int id; 
+  /** Bitmaps that holds the collision attributes for this tile */
+  unsigned int colmap;
+
+  /** @param filename Surface to use 
+   *  @param arg_colmap a 8 char long array */
+  Tile(const std::string&amp; filename, 
+       const std::string&amp; highlight_filename, 
+       unsigned int arg_colmap);
+
+  Tile(const CL_PixelBuffer&amp; buffer, 
+       const CL_PixelBuffer&amp; hl_buffer, 
+       unsigned int arg_colmap);
+
+  unsigned get_colmap() const { return colmap; }
+  CL_Sprite&amp; get_color_sprite();
+  CL_Sprite&amp; get_highlight_sprite();
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/tile.hxx
===================================================================
--- trunk/src/tile.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/tile.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,65 +0,0 @@
-//  $Id: tile.hxx,v 1.6 2003/09/22 18:37:05 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_TILE_HXX
-#define HEADER_TILE_HXX
-
-#include &lt;assert.h&gt;
-#include &lt;ClanLib/Display/sprite.h&gt;
-#include &lt;ClanLib/GL/opengl_surface.h&gt;
-
-/** A Tile is a surface or sprite together with information for
- *  collision detection (aka colmap). The collision map is at a
- *  resolution of 8x8 bits. Position information is handled in the
- *  TileMap and not here. (flyweight pattern). */
-class Tile
-{
-private:
-  CL_Sprite color;
-  CL_Sprite highlight;
-
-public:
-  CL_Rectf         color_rect;
-  int              color_packer;
-
-  CL_Rectf         highlight_rect;
-  int              highlight_packer;
-
-  int id; 
-  /** Bitmaps that holds the collision attributes for this tile */
-  unsigned int colmap;
-
-  /** @param filename Surface to use 
-   *  @param arg_colmap a 8 char long array */
-  Tile(const std::string&amp; filename, 
-       const std::string&amp; highlight_filename, 
-       unsigned int arg_colmap);
-
-  Tile(const CL_PixelBuffer&amp; buffer, 
-       const CL_PixelBuffer&amp; hl_buffer, 
-       unsigned int arg_colmap);
-
-  unsigned get_colmap() const { return colmap; }
-  CL_Sprite&amp; get_color_sprite();
-  CL_Sprite&amp; get_highlight_sprite();
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/tile_factory.cpp (from rev 502, trunk/src/tile_factory.cxx)
===================================================================
--- trunk/src/tile_factory.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/tile_factory.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,236 @@
+//  $Id: tile_factory.cxx,v 1.10 2003/09/22 18:37:05 grumbel Exp $
+//
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;string&gt;
+#include &lt;ClanLib/gl.h&gt;
+#include &lt;ClanLib/Core/System/system.h&gt;
+#include &lt;ClanLib/Display/pixel_buffer.h&gt;
+#include &lt;ClanLib/Display/pixel_format.h&gt;
+#include &lt;ClanLib/Display/Providers/provider_factory.h&gt;
+#include &lt;ClanLib/Display/Providers/provider_factory.h&gt;
+#include &lt;assert.h&gt;
+#include &lt;sstream&gt;
+#include &lt;iostream&gt;
+#include &lt;memory&gt;
+#include &quot;globals.hpp&quot;
+#include &quot;tile.hpp&quot;
+#include &quot;tile_packer.hpp&quot;
+#include &quot;tile_factory.hpp&quot;
+#include &quot;lisp/lisp.hpp&quot;
+#include &quot;lisp/parser.hpp&quot;
+#include &quot;lisp/list_iterator.hpp&quot;
+
+extern CL_ResourceManager* resources;
+
+TileFactory* TileFactory::current_ = 0;
+
+std::string TileFactory::tile_def_file = &quot;tiles.scm&quot;;
+
+TileFactory::TileFactory (const std::string&amp; filename)
+{
+  std::auto_ptr&lt;lisp::Lisp&gt; root (lisp::Parser::parse(filename));
+
+  packers.push_back(new TilePacker(1024, 1024));
+  packers.push_back(new TilePacker(1024, 1024));
+  color_packer     = 0;
+  highlight_packer = 1;
+
+  const lisp::Lisp* tiles_lisp = root-&gt;get_lisp(&quot;windstille-tiles&quot;);
+  if(!tiles_lisp) {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;'&quot; &lt;&lt; filename &lt;&lt; &quot;' is not a windstille tiles file&quot;;
+    throw std::runtime_error(msg.str());
+  }
+
+  lisp::ListIterator iter(tiles_lisp);
+  while(iter.next()) {
+    if(iter.item() == &quot;tiles&quot;) {
+      parse_tiles(iter.lisp());
+    } else {
+      std::cout &lt;&lt; &quot;Unknown tag in tiles file: &quot; &lt;&lt; iter.item() &lt;&lt; &quot;\n&quot;;
+    }
+  }
+  
+  for(TilePackers::size_type i = 0; i &lt; packers.size(); ++i)
+    {
+      char str[1024];
+      sprintf(str, &quot;/tmp/packtiles%d.png&quot;, i);
+      CL_ProviderFactory::save(packers[i]-&gt;get_pixelbuffer(), str);
+    }
+}
+
+TileFactory::~TileFactory()
+{
+  for(Tiles::iterator i = tiles.begin(); i != tiles.end(); ++i)
+    {
+      delete *i;
+    }
+  tiles.clear();
+}
+
+void
+TileFactory::parse_tiles(const lisp::Lisp* data)
+{
+  assert(data);
+
+  std::string filename;
+  std::string highlight_filename;
+  std::vector&lt;int&gt; colmap;
+  int id = -1;
+  
+  lisp::ListIterator iter(data);
+  while(iter.next()) {
+    if(iter.item() == &quot;id&quot;) {
+      id = iter.value().get_int();
+    } else if(iter.item() == &quot;color-image&quot;) {
+      filename = iter.value().get_string();
+    } else if(iter.item() == &quot;highlight-image&quot;) {
+      highlight_filename = iter.value().get_string();
+    } else if(iter.item() == &quot;colmap&quot;) {
+      iter.lisp()-&gt;get_vector(colmap);
+    } else {
+      std::cerr &lt;&lt; &quot;Unknown tag '&quot; &lt;&lt; iter.item() &lt;&lt; &quot;' found in tiles\n&quot;;
+    }
+  }
+
+  if(id &lt; 0)
+    throw std::runtime_error(&quot;Invalid or missing tile id&quot;);
+  if(filename == &quot;&quot;)
+    throw std::runtime_error(&quot;Missing color-image&quot;);
+  
+  CL_PixelBuffer image = CL_ProviderFactory::load(datadir + filename);
+  CL_PixelBuffer hl_image;
+  
+  if(highlight_filename != &quot;&quot;)
+    hl_image = CL_ProviderFactory::load(datadir + highlight_filename);
+
+  int num_tiles = (image.get_width()/TILE_SIZE) * (image.get_height()/TILE_SIZE);
+  if (int(colmap.size()) != num_tiles)
+    throw std::runtime_error(&quot;Not enough colmap information for tiles&quot;);
+  
+  if ((id + num_tiles) &gt;= int(tiles.size()))
+    tiles.resize(id + num_tiles + 1);
+
+  // FIMXE: Tiles should share one OpenGL texture
+  for (int y = 0; y &lt; image.get_height(); y += TILE_SIZE)
+    {
+      for (int x = 0; x &lt; image.get_width(); x += TILE_SIZE)
+        {
+          CL_PixelBuffer chopped_image(TILE_SIZE, TILE_SIZE,
+                                       image.get_format().get_depth()*TILE_SIZE,
+                                       image.get_format(), NULL);
+          chopped_image.lock();
+          image.convert(chopped_image.get_data(), 
+                        chopped_image.get_format(), 
+                        image.get_format().get_depth()*TILE_SIZE, 
+                        CL_Rect(CL_Point(0, 0), CL_Size(TILE_SIZE, TILE_SIZE)),
+                        CL_Rect(CL_Point(x, y), CL_Size(TILE_SIZE, TILE_SIZE)));
+          chopped_image.unlock();
+
+          CL_PixelBuffer hl_chopped_image;
+
+          if (hl_image)
+            {
+              hl_chopped_image = CL_PixelBuffer(TILE_SIZE, TILE_SIZE,
+                                                hl_image.get_format().get_depth()*TILE_SIZE,
+                                                hl_image.get_format(), NULL);
+              hl_chopped_image.lock();
+              hl_image.convert(hl_chopped_image.get_data(), 
+                               hl_chopped_image.get_format(), 
+                               hl_image.get_format().get_depth()*TILE_SIZE, 
+                               CL_Rect(CL_Point(0, 0), CL_Size(TILE_SIZE, TILE_SIZE)),
+                               CL_Rect(CL_Point(x, y), CL_Size(TILE_SIZE, TILE_SIZE)));
+              hl_chopped_image.unlock();
+            }
+
+          pack(id, colmap[y/TILE_SIZE * image.get_width()/TILE_SIZE + x/TILE_SIZE],
+               chopped_image, hl_chopped_image);
+
+          id += 1;
+        }
+    }
+}
+
+void
+TileFactory::pack(int id, int colmap, CL_PixelBuffer color, CL_PixelBuffer highlight)
+{
+  tiles[id] = new Tile(color, highlight, colmap);
+          
+  tiles[id]-&gt;id = id;
+
+  tiles[id]-&gt;color_rect     = packers[color_packer]-&gt;pack(color);
+  tiles[id]-&gt;color_packer   = color_packer;
+
+  if (highlight)
+    {
+      tiles[id]-&gt;highlight_rect   = packers[highlight_packer]-&gt;pack(highlight);
+      tiles[id]-&gt;highlight_packer = highlight_packer;
+    }
+
+  if (packers[color_packer]-&gt;is_full())
+    {
+      packers.push_back(new TilePacker(1024, 1024));
+      color_packer = packers.size() - 1;
+    }
+
+  if (packers[highlight_packer]-&gt;is_full())
+    {
+      packers.push_back(new TilePacker(1024, 1024));
+      highlight_packer = packers.size() - 1;
+    }
+}
+
+Tile* 
+TileFactory::create (int id)
+{
+  // id 0 is always the empty tile
+  if (id == 0)
+    { 
+      return 0;
+    }
+  else
+    {
+      if (id &gt; 0 &amp;&amp; id &lt; int(tiles.size()))
+        return tiles[id];
+      else
+        return 0;
+    }
+}
+
+CL_OpenGLSurface
+TileFactory::get_texture(int id)
+{
+  return packers[id]-&gt;get_texture();
+}
+
+void
+TileFactory::init()
+{
+  assert(current_ == 0);
+  current_ = new TileFactory(tile_def_file);
+}
+
+/** Destroy the default TileFactor*/
+void
+TileFactory::deinit()
+{
+  delete current_;
+}
+
+/* EOF */

Deleted: trunk/src/tile_factory.cxx
===================================================================
--- trunk/src/tile_factory.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/tile_factory.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,236 +0,0 @@
-//  $Id: tile_factory.cxx,v 1.10 2003/09/22 18:37:05 grumbel Exp $
-//
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;string&gt;
-#include &lt;ClanLib/gl.h&gt;
-#include &lt;ClanLib/Core/System/system.h&gt;
-#include &lt;ClanLib/Display/pixel_buffer.h&gt;
-#include &lt;ClanLib/Display/pixel_format.h&gt;
-#include &lt;ClanLib/Display/Providers/provider_factory.h&gt;
-#include &lt;ClanLib/Display/Providers/provider_factory.h&gt;
-#include &lt;assert.h&gt;
-#include &lt;sstream&gt;
-#include &lt;iostream&gt;
-#include &lt;memory&gt;
-#include &quot;globals.hxx&quot;
-#include &quot;tile.hxx&quot;
-#include &quot;tile_packer.hxx&quot;
-#include &quot;tile_factory.hxx&quot;
-#include &quot;lisp/lisp.hpp&quot;
-#include &quot;lisp/parser.hpp&quot;
-#include &quot;lisp/list_iterator.hpp&quot;
-
-extern CL_ResourceManager* resources;
-
-TileFactory* TileFactory::current_ = 0;
-
-std::string TileFactory::tile_def_file = &quot;tiles.scm&quot;;
-
-TileFactory::TileFactory (const std::string&amp; filename)
-{
-  std::auto_ptr&lt;lisp::Lisp&gt; root (lisp::Parser::parse(filename));
-
-  packers.push_back(new TilePacker(1024, 1024));
-  packers.push_back(new TilePacker(1024, 1024));
-  color_packer     = 0;
-  highlight_packer = 1;
-
-  const lisp::Lisp* tiles_lisp = root-&gt;get_lisp(&quot;windstille-tiles&quot;);
-  if(!tiles_lisp) {
-    std::ostringstream msg;
-    msg &lt;&lt; &quot;'&quot; &lt;&lt; filename &lt;&lt; &quot;' is not a windstille tiles file&quot;;
-    throw std::runtime_error(msg.str());
-  }
-
-  lisp::ListIterator iter(tiles_lisp);
-  while(iter.next()) {
-    if(iter.item() == &quot;tiles&quot;) {
-      parse_tiles(iter.lisp());
-    } else {
-      std::cout &lt;&lt; &quot;Unknown tag in tiles file: &quot; &lt;&lt; iter.item() &lt;&lt; &quot;\n&quot;;
-    }
-  }
-  
-  for(TilePackers::size_type i = 0; i &lt; packers.size(); ++i)
-    {
-      char str[1024];
-      sprintf(str, &quot;/tmp/packtiles%d.png&quot;, i);
-      CL_ProviderFactory::save(packers[i]-&gt;get_pixelbuffer(), str);
-    }
-}
-
-TileFactory::~TileFactory()
-{
-  for(Tiles::iterator i = tiles.begin(); i != tiles.end(); ++i)
-    {
-      delete *i;
-    }
-  tiles.clear();
-}
-
-void
-TileFactory::parse_tiles(const lisp::Lisp* data)
-{
-  assert(data);
-
-  std::string filename;
-  std::string highlight_filename;
-  std::vector&lt;int&gt; colmap;
-  int id = -1;
-  
-  lisp::ListIterator iter(data);
-  while(iter.next()) {
-    if(iter.item() == &quot;id&quot;) {
-      id = iter.value().get_int();
-    } else if(iter.item() == &quot;color-image&quot;) {
-      filename = iter.value().get_string();
-    } else if(iter.item() == &quot;highlight-image&quot;) {
-      highlight_filename = iter.value().get_string();
-    } else if(iter.item() == &quot;colmap&quot;) {
-      iter.lisp()-&gt;get_vector(colmap);
-    } else {
-      std::cerr &lt;&lt; &quot;Unknown tag '&quot; &lt;&lt; iter.item() &lt;&lt; &quot;' found in tiles\n&quot;;
-    }
-  }
-
-  if(id &lt; 0)
-    throw std::runtime_error(&quot;Invalid or missing tile id&quot;);
-  if(filename == &quot;&quot;)
-    throw std::runtime_error(&quot;Missing color-image&quot;);
-  
-  CL_PixelBuffer image = CL_ProviderFactory::load(datadir + filename);
-  CL_PixelBuffer hl_image;
-  
-  if(highlight_filename != &quot;&quot;)
-    hl_image = CL_ProviderFactory::load(datadir + highlight_filename);
-
-  int num_tiles = (image.get_width()/TILE_SIZE) * (image.get_height()/TILE_SIZE);
-  if (int(colmap.size()) != num_tiles)
-    throw std::runtime_error(&quot;Not enough colmap information for tiles&quot;);
-  
-  if ((id + num_tiles) &gt;= int(tiles.size()))
-    tiles.resize(id + num_tiles + 1);
-
-  // FIMXE: Tiles should share one OpenGL texture
-  for (int y = 0; y &lt; image.get_height(); y += TILE_SIZE)
-    {
-      for (int x = 0; x &lt; image.get_width(); x += TILE_SIZE)
-        {
-          CL_PixelBuffer chopped_image(TILE_SIZE, TILE_SIZE,
-                                       image.get_format().get_depth()*TILE_SIZE,
-                                       image.get_format(), NULL);
-          chopped_image.lock();
-          image.convert(chopped_image.get_data(), 
-                        chopped_image.get_format(), 
-                        image.get_format().get_depth()*TILE_SIZE, 
-                        CL_Rect(CL_Point(0, 0), CL_Size(TILE_SIZE, TILE_SIZE)),
-                        CL_Rect(CL_Point(x, y), CL_Size(TILE_SIZE, TILE_SIZE)));
-          chopped_image.unlock();
-
-          CL_PixelBuffer hl_chopped_image;
-
-          if (hl_image)
-            {
-              hl_chopped_image = CL_PixelBuffer(TILE_SIZE, TILE_SIZE,
-                                                hl_image.get_format().get_depth()*TILE_SIZE,
-                                                hl_image.get_format(), NULL);
-              hl_chopped_image.lock();
-              hl_image.convert(hl_chopped_image.get_data(), 
-                               hl_chopped_image.get_format(), 
-                               hl_image.get_format().get_depth()*TILE_SIZE, 
-                               CL_Rect(CL_Point(0, 0), CL_Size(TILE_SIZE, TILE_SIZE)),
-                               CL_Rect(CL_Point(x, y), CL_Size(TILE_SIZE, TILE_SIZE)));
-              hl_chopped_image.unlock();
-            }
-
-          pack(id, colmap[y/TILE_SIZE * image.get_width()/TILE_SIZE + x/TILE_SIZE],
-               chopped_image, hl_chopped_image);
-
-          id += 1;
-        }
-    }
-}
-
-void
-TileFactory::pack(int id, int colmap, CL_PixelBuffer color, CL_PixelBuffer highlight)
-{
-  tiles[id] = new Tile(color, highlight, colmap);
-          
-  tiles[id]-&gt;id = id;
-
-  tiles[id]-&gt;color_rect     = packers[color_packer]-&gt;pack(color);
-  tiles[id]-&gt;color_packer   = color_packer;
-
-  if (highlight)
-    {
-      tiles[id]-&gt;highlight_rect   = packers[highlight_packer]-&gt;pack(highlight);
-      tiles[id]-&gt;highlight_packer = highlight_packer;
-    }
-
-  if (packers[color_packer]-&gt;is_full())
-    {
-      packers.push_back(new TilePacker(1024, 1024));
-      color_packer = packers.size() - 1;
-    }
-
-  if (packers[highlight_packer]-&gt;is_full())
-    {
-      packers.push_back(new TilePacker(1024, 1024));
-      highlight_packer = packers.size() - 1;
-    }
-}
-
-Tile* 
-TileFactory::create (int id)
-{
-  // id 0 is always the empty tile
-  if (id == 0)
-    { 
-      return 0;
-    }
-  else
-    {
-      if (id &gt; 0 &amp;&amp; id &lt; int(tiles.size()))
-        return tiles[id];
-      else
-        return 0;
-    }
-}
-
-CL_OpenGLSurface
-TileFactory::get_texture(int id)
-{
-  return packers[id]-&gt;get_texture();
-}
-
-void
-TileFactory::init()
-{
-  assert(current_ == 0);
-  current_ = new TileFactory(tile_def_file);
-}
-
-/** Destroy the default TileFactor*/
-void
-TileFactory::deinit()
-{
-  delete current_;
-}
-
-/* EOF */

Copied: trunk/src/tile_factory.hpp (from rev 502, trunk/src/tile_factory.hxx)
===================================================================
--- trunk/src/tile_factory.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/tile_factory.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,82 @@
+//  $Id: tile_factory.hpp,v 1.8 2003/09/22 18:37:05 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef TILEFACTORY_HXX
+#define TILEFACTORY_HXX
+
+#include &lt;map&gt;
+#include &lt;string&gt;
+#include &quot;lisp/lisp.hpp&quot;
+
+class Tile;
+class TilePacker;
+
+/** */
+class TileFactory
+{
+private:
+  // FIXME: Replace ths with a vector, map is potentially slow
+  //typedef std::map&lt;int, Tile*&gt; Tiles;
+  typedef std::vector&lt;Tile*&gt; Tiles;
+  Tiles tiles;
+  typedef std::vector&lt;TilePacker*&gt; TilePackers;
+  TilePackers packers;
+  int highlight_packer;
+  int color_packer;
+
+  static TileFactory* current_;
+public:
+  static std::string tile_def_file;
+
+  typedef Tiles::iterator iterator;
+  
+  iterator begin() { return tiles.begin(); }
+  iterator end()   { return tiles.end(); }
+
+  /** Create a TileFactory from a given tile definition file */
+  TileFactory(const std::string&amp; filename);
+  ~TileFactory();
+
+  CL_OpenGLSurface get_texture(int id);
+
+  /** Check if the tile is already loaded and return it. If it is not
+   *  already loaded, load it 
+   *
+   *  @param id The id of the tile to create as defined in the def. file
+   *
+   *  @return on success the tile is returned, on failure 0 */
+  Tile* create(int id);
+
+  /** Create the default TileFactor*/
+  static void init();
+
+  /** Destroy the default TileFactor*/
+  static void deinit();
+
+  /** Access the default TileFactor*/
+  static TileFactory* current() { return current_; }
+
+private:
+  void parse_tiles(const lisp::Lisp* data);
+  void pack(int id, int colmap, CL_PixelBuffer color, CL_PixelBuffer highlight);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/tile_factory.hxx
===================================================================
--- trunk/src/tile_factory.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/tile_factory.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,82 +0,0 @@
-//  $Id: tile_factory.hxx,v 1.8 2003/09/22 18:37:05 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef TILEFACTORY_HXX
-#define TILEFACTORY_HXX
-
-#include &lt;map&gt;
-#include &lt;string&gt;
-#include &quot;lisp/lisp.hpp&quot;
-
-class Tile;
-class TilePacker;
-
-/** */
-class TileFactory
-{
-private:
-  // FIXME: Replace ths with a vector, map is potentially slow
-  //typedef std::map&lt;int, Tile*&gt; Tiles;
-  typedef std::vector&lt;Tile*&gt; Tiles;
-  Tiles tiles;
-  typedef std::vector&lt;TilePacker*&gt; TilePackers;
-  TilePackers packers;
-  int highlight_packer;
-  int color_packer;
-
-  static TileFactory* current_;
-public:
-  static std::string tile_def_file;
-
-  typedef Tiles::iterator iterator;
-  
-  iterator begin() { return tiles.begin(); }
-  iterator end()   { return tiles.end(); }
-
-  /** Create a TileFactory from a given tile definition file */
-  TileFactory(const std::string&amp; filename);
-  ~TileFactory();
-
-  CL_OpenGLSurface get_texture(int id);
-
-  /** Check if the tile is already loaded and return it. If it is not
-   *  already loaded, load it 
-   *
-   *  @param id The id of the tile to create as defined in the def. file
-   *
-   *  @return on success the tile is returned, on failure 0 */
-  Tile* create(int id);
-
-  /** Create the default TileFactor*/
-  static void init();
-
-  /** Destroy the default TileFactor*/
-  static void deinit();
-
-  /** Access the default TileFactor*/
-  static TileFactory* current() { return current_; }
-
-private:
-  void parse_tiles(const lisp::Lisp* data);
-  void pack(int id, int colmap, CL_PixelBuffer color, CL_PixelBuffer highlight);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/tile_map.cpp (from rev 502, trunk/src/tile_map.cxx)
===================================================================
--- trunk/src/tile_map.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/tile_map.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,286 @@
+//  $Id: tile_map.cxx,v 1.18 2003/11/05 11:09:36 grumbel Exp $
+//
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ClanLib/gl.h&gt;
+#include &lt;ClanLib/display.h&gt;
+#include &lt;sstream&gt;
+#include &quot;lisp/list_iterator.hpp&quot;
+#include &quot;tile_map.hpp&quot;
+#include &quot;tile.hpp&quot;
+#include &quot;tile_factory.hpp&quot;
+#include &quot;globals.hpp&quot;
+#include &quot;view.hpp&quot;
+#include &quot;display/drawing_request.hpp&quot;
+
+extern CL_ResourceManager* resources;
+
+TileMap::TileMap(const lisp::Lisp* lisp)
+{
+  int width = -1;
+  int height = -1;
+  z_pos = 0;
+  total_time = 0;
+  
+  lisp::ListIterator iter(lisp);
+  while(iter.next()) {
+    if(iter.item() == &quot;name&quot;) {
+      name = iter.value().get_string();
+    } else if(iter.item() == &quot;z-pos&quot;) {
+      z_pos = iter.value().get_float();
+    } else if(iter.item() == &quot;width&quot;) {
+      width = iter.value().get_int();
+    } else if(iter.item() == &quot;height&quot;) {
+      height = iter.value().get_int();
+    } else if(iter.item() == &quot;data&quot;) {
+      if(width &lt;= 0 || height &lt;= 0) {
+        throw std::runtime_error(
+            &quot;Invalid width or height defined or &quot;
+            &quot;data defined before width and height&quot;);
+      }
+      Field&lt;int&gt; tmpfield(width, height);
+      iter.lisp()-&gt;get_vector(tmpfield.get_vector());
+    
+      field = Field&lt;Tile*&gt;(width, height);
+
+      for (int y = 0; y &lt; field.get_height (); ++y) 
+        {
+          for (int x = 0; x &lt; field.get_width (); ++x)
+            {
+              field(x, y) = TileFactory::current()-&gt;create(tmpfield(x, y));
+            }
+        }
+    } else {
+      std::cout &lt;&lt; &quot;Skipping unknown Tag '&quot; &lt;&lt; iter.item() &lt;&lt; &quot;' in tilemap\n&quot;;
+    }
+  }
+
+  if(field.size() == 0)
+    throw std::runtime_error(&quot;No tiles defined in tilemap&quot;);  
+}
+
+TileMap::TileMap (Field&lt;int&gt;* data)
+  : field(data-&gt;get_width(),
+          data-&gt;get_height())
+{
+  if (debug)
+    {
+      std::cout &lt;&lt; &quot;TileMap: Size: &quot; 
+                &lt;&lt; data-&gt;get_width() &lt;&lt; &quot;x&quot; &lt;&lt; data-&gt;get_height() &lt;&lt; std::endl;
+    }
+
+  for (int y = 0; y &lt; field.get_height (); ++y) 
+    {
+      for (int x = 0; x &lt; field.get_width (); ++x)
+        {
+          field(x, y) = TileFactory::current()-&gt;create((*data)(x, y));
+        }
+    }
+}
+
+TileMap::~TileMap()
+{
+}
+
+void 
+TileMap::update (float delta)
+{
+  total_time += delta;
+  /*for (FieldIter i = field.begin (); i != field.end (); ++i)
+    {
+      (*i)-&gt;update (delta);
+      }*/
+}
+
+class TileMapDrawingRequest : public DrawingRequest
+{
+private:
+  TileMap* tilemap;
+  bool highlight;
+  CL_Rect rect;
+
+public:
+  TileMapDrawingRequest(TileMap* tilemap_, bool highlight_,
+                        const CL_Rect&amp; rect_,
+                        const CL_Vector&amp; pos, const CL_Matrix4x4&amp; modelview)
+    : DrawingRequest(pos, modelview),
+      tilemap(tilemap_),
+      highlight(highlight_),
+      rect(rect_)
+  {}
+
+  void draw(CL_GraphicContext* gc)
+  {
+    if (CL_Keyboard::get_keycode(CL_KEY_Z))
+      draw_new(gc);
+    else
+      draw_classic(gc);
+  }
+
+  inline void Vertex2f(float x, float y)
+  {
+    clVertex2f(x + sin(tilemap-&gt;total_time + y)*60.0f, 
+               y + cos(tilemap-&gt;total_time + x)*60.0f);
+  }
+
+  void draw_new(CL_GraphicContext* gc)
+  {
+    Field&lt;Tile*&gt;&amp; field = tilemap-&gt;field;
+
+    CL_OpenGLState state(gc);
+    state.set_active();
+    state.setup_2d();
+
+    clPushMatrix();
+    clMultMatrixd(modelview);
+      
+    clEnable(CL_TEXTURE_2D);
+    clEnable(CL_BLEND);
+    glBlendFunc( GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA );
+    TileFactory::current()-&gt;get_texture(0).bind();
+
+    clTexParameteri(CL_TEXTURE_2D, CL_TEXTURE_MIN_FILTER, CL_LINEAR);
+    clTexParameteri(CL_TEXTURE_2D, CL_TEXTURE_MAG_FILTER, CL_LINEAR);
+    clTexParameteri(CL_TEXTURE_2D, CL_TEXTURE_WRAP_S, CL_CLAMP_TO_EDGE);
+    clTexParameteri(CL_TEXTURE_2D, CL_TEXTURE_WRAP_T, CL_CLAMP_TO_EDGE);
+      
+    clBegin(CL_QUADS);
+    for (int y = rect.top;   y &lt; rect.bottom; ++y)
+      for (int x = rect.left; x &lt; rect.right; ++x)
+        {
+          Tile* tile = field(x, y);
+          if (tile &amp;&amp; !highlight)
+            {
+              clTexCoord2f(tile-&gt;color_rect.left,
+                           tile-&gt;color_rect.top);
+              Vertex2f(x * TILE_SIZE, 
+                       y * TILE_SIZE);
+
+              clTexCoord2f(tile-&gt;color_rect.right,
+                           tile-&gt;color_rect.top);
+              Vertex2f(x * TILE_SIZE + TILE_SIZE,
+                       y * TILE_SIZE);
+
+              clTexCoord2f(tile-&gt;color_rect.right,
+                           tile-&gt;color_rect.bottom);
+              Vertex2f(x * TILE_SIZE + TILE_SIZE,
+                       y * TILE_SIZE + TILE_SIZE);
+
+              clTexCoord2f(tile-&gt;color_rect.left,
+                           tile-&gt;color_rect.bottom);
+              Vertex2f(x * TILE_SIZE,
+                       y * TILE_SIZE + TILE_SIZE);
+            }
+        }     
+    clEnd();
+      
+    clPopMatrix();
+  }
+
+  void draw_classic(CL_GraphicContext* gc)
+  {
+    gc-&gt;push_modelview();
+    gc-&gt;add_modelview(modelview);
+
+    Field&lt;Tile*&gt;&amp; field = tilemap-&gt;field;
+
+    for (int y = rect.top;   y &lt; rect.bottom; ++y)
+      for (int x = rect.left; x &lt; rect.right; ++x)
+        {
+          if (field(x,y))
+            {
+              if (!highlight)
+                {
+                  field(x,y)-&gt;get_color_sprite().draw(x * TILE_SIZE, y * TILE_SIZE);
+                }
+              else
+                {
+                  if (field(x, y)-&gt;get_highlight_sprite())
+                    field(x,y)-&gt;get_highlight_sprite().draw(x * TILE_SIZE, y * TILE_SIZE);
+                }
+            }
+        }
+    gc-&gt;pop_modelview();
+  }
+};
+
+void
+TileMap::draw (SceneContext&amp; sc)
+{
+  CL_Rect rect = CL_Rect(View::current()-&gt;get_clip_rect());
+
+  int start_x = std::max(0, rect.left/TILE_SIZE);
+  int start_y = std::max(0, rect.top/TILE_SIZE);
+  int end_x   = std::min(field.get_width(),  rect.right/TILE_SIZE + 1);
+  int end_y   = std::min(field.get_height(), rect.bottom/TILE_SIZE + 1);
+
+  sc.color().draw(new TileMapDrawingRequest(this, false, CL_Rect(start_x, start_y,
+                                                                 end_x,   end_y),
+                                            CL_Vector(0,0,z_pos),
+                                            sc.color().get_modelview()));
+  sc.highlight().draw(new TileMapDrawingRequest(this, true, CL_Rect(start_x, start_y,
+                                                                    end_x,   end_y),
+                                                CL_Vector(0,0,z_pos),
+                                                sc.color().get_modelview()));
+}
+
+unsigned int
+TileMap::get_pixel(int x, int y)
+{
+  if (x &lt; 0 || y &lt; 0 
+      || x &gt;= int(field.get_width())
+      || y &gt;= int(field.get_height()))
+    {
+      //std::cout &lt;&lt; &quot;Out of bounce: &quot; &lt;&lt; x &lt;&lt; &quot;, &quot; &lt;&lt; y &lt;&lt; std::endl;
+      return 0;
+    }
+  else
+    {
+      Tile* tile = field(x, y);
+      
+      if (tile)
+        return tile-&gt;get_colmap();
+      else
+        return 0;     
+    }
+}
+
+bool
+TileMap::is_ground (float x, float y)
+{
+  int x_pos = int(x) / TILE_SIZE;
+  int y_pos = int(y) / TILE_SIZE;
+
+  if (x &lt; 0 || x_pos &gt;= field.get_width())
+    {
+      //std::cout &lt;&lt; &quot;TileMap::is_ground (): Out of range: &quot; &lt;&lt; x_pos &lt;&lt; &quot; &quot; &lt;&lt; y_pos &lt;&lt; std::endl;
+      return 1;
+    }
+  else if (y &lt; 0 || y_pos &gt;= field.get_height())
+    {
+      return 0;
+    }
+
+
+  if (field (x_pos, y_pos))
+    return field(x_pos, y_pos)-&gt;get_colmap();
+  else
+    return 0;
+}
+
+/* EOF */

Deleted: trunk/src/tile_map.cxx
===================================================================
--- trunk/src/tile_map.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/tile_map.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,286 +0,0 @@
-//  $Id: tile_map.cxx,v 1.18 2003/11/05 11:09:36 grumbel Exp $
-//
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ClanLib/gl.h&gt;
-#include &lt;ClanLib/display.h&gt;
-#include &lt;sstream&gt;
-#include &quot;lisp/list_iterator.hpp&quot;
-#include &quot;tile_map.hxx&quot;
-#include &quot;tile.hxx&quot;
-#include &quot;tile_factory.hxx&quot;
-#include &quot;globals.hxx&quot;
-#include &quot;view.hxx&quot;
-#include &quot;display/drawing_request.hxx&quot;
-
-extern CL_ResourceManager* resources;
-
-TileMap::TileMap(const lisp::Lisp* lisp)
-{
-  int width = -1;
-  int height = -1;
-  z_pos = 0;
-  total_time = 0;
-  
-  lisp::ListIterator iter(lisp);
-  while(iter.next()) {
-    if(iter.item() == &quot;name&quot;) {
-      name = iter.value().get_string();
-    } else if(iter.item() == &quot;z-pos&quot;) {
-      z_pos = iter.value().get_float();
-    } else if(iter.item() == &quot;width&quot;) {
-      width = iter.value().get_int();
-    } else if(iter.item() == &quot;height&quot;) {
-      height = iter.value().get_int();
-    } else if(iter.item() == &quot;data&quot;) {
-      if(width &lt;= 0 || height &lt;= 0) {
-        throw std::runtime_error(
-            &quot;Invalid width or height defined or &quot;
-            &quot;data defined before width and height&quot;);
-      }
-      Field&lt;int&gt; tmpfield(width, height);
-      iter.lisp()-&gt;get_vector(tmpfield.get_vector());
-    
-      field = Field&lt;Tile*&gt;(width, height);
-
-      for (int y = 0; y &lt; field.get_height (); ++y) 
-        {
-          for (int x = 0; x &lt; field.get_width (); ++x)
-            {
-              field(x, y) = TileFactory::current()-&gt;create(tmpfield(x, y));
-            }
-        }
-    } else {
-      std::cout &lt;&lt; &quot;Skipping unknown Tag '&quot; &lt;&lt; iter.item() &lt;&lt; &quot;' in tilemap\n&quot;;
-    }
-  }
-
-  if(field.size() == 0)
-    throw std::runtime_error(&quot;No tiles defined in tilemap&quot;);  
-}
-
-TileMap::TileMap (Field&lt;int&gt;* data)
-  : field(data-&gt;get_width(),
-          data-&gt;get_height())
-{
-  if (debug)
-    {
-      std::cout &lt;&lt; &quot;TileMap: Size: &quot; 
-                &lt;&lt; data-&gt;get_width() &lt;&lt; &quot;x&quot; &lt;&lt; data-&gt;get_height() &lt;&lt; std::endl;
-    }
-
-  for (int y = 0; y &lt; field.get_height (); ++y) 
-    {
-      for (int x = 0; x &lt; field.get_width (); ++x)
-        {
-          field(x, y) = TileFactory::current()-&gt;create((*data)(x, y));
-        }
-    }
-}
-
-TileMap::~TileMap()
-{
-}
-
-void 
-TileMap::update (float delta)
-{
-  total_time += delta;
-  /*for (FieldIter i = field.begin (); i != field.end (); ++i)
-    {
-      (*i)-&gt;update (delta);
-      }*/
-}
-
-class TileMapDrawingRequest : public DrawingRequest
-{
-private:
-  TileMap* tilemap;
-  bool highlight;
-  CL_Rect rect;
-
-public:
-  TileMapDrawingRequest(TileMap* tilemap_, bool highlight_,
-                        const CL_Rect&amp; rect_,
-                        const CL_Vector&amp; pos, const CL_Matrix4x4&amp; modelview)
-    : DrawingRequest(pos, modelview),
-      tilemap(tilemap_),
-      highlight(highlight_),
-      rect(rect_)
-  {}
-
-  void draw(CL_GraphicContext* gc)
-  {
-    if (CL_Keyboard::get_keycode(CL_KEY_Z))
-      draw_new(gc);
-    else
-      draw_classic(gc);
-  }
-
-  inline void Vertex2f(float x, float y)
-  {
-    clVertex2f(x + sin(tilemap-&gt;total_time + y)*60.0f, 
-               y + cos(tilemap-&gt;total_time + x)*60.0f);
-  }
-
-  void draw_new(CL_GraphicContext* gc)
-  {
-    Field&lt;Tile*&gt;&amp; field = tilemap-&gt;field;
-
-    CL_OpenGLState state(gc);
-    state.set_active();
-    state.setup_2d();
-
-    clPushMatrix();
-    clMultMatrixd(modelview);
-      
-    clEnable(CL_TEXTURE_2D);
-    clEnable(CL_BLEND);
-    glBlendFunc( GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA );
-    TileFactory::current()-&gt;get_texture(0).bind();
-
-    clTexParameteri(CL_TEXTURE_2D, CL_TEXTURE_MIN_FILTER, CL_LINEAR);
-    clTexParameteri(CL_TEXTURE_2D, CL_TEXTURE_MAG_FILTER, CL_LINEAR);
-    clTexParameteri(CL_TEXTURE_2D, CL_TEXTURE_WRAP_S, CL_CLAMP_TO_EDGE);
-    clTexParameteri(CL_TEXTURE_2D, CL_TEXTURE_WRAP_T, CL_CLAMP_TO_EDGE);
-      
-    clBegin(CL_QUADS);
-    for (int y = rect.top;   y &lt; rect.bottom; ++y)
-      for (int x = rect.left; x &lt; rect.right; ++x)
-        {
-          Tile* tile = field(x, y);
-          if (tile &amp;&amp; !highlight)
-            {
-              clTexCoord2f(tile-&gt;color_rect.left,
-                           tile-&gt;color_rect.top);
-              Vertex2f(x * TILE_SIZE, 
-                       y * TILE_SIZE);
-
-              clTexCoord2f(tile-&gt;color_rect.right,
-                           tile-&gt;color_rect.top);
-              Vertex2f(x * TILE_SIZE + TILE_SIZE,
-                       y * TILE_SIZE);
-
-              clTexCoord2f(tile-&gt;color_rect.right,
-                           tile-&gt;color_rect.bottom);
-              Vertex2f(x * TILE_SIZE + TILE_SIZE,
-                       y * TILE_SIZE + TILE_SIZE);
-
-              clTexCoord2f(tile-&gt;color_rect.left,
-                           tile-&gt;color_rect.bottom);
-              Vertex2f(x * TILE_SIZE,
-                       y * TILE_SIZE + TILE_SIZE);
-            }
-        }     
-    clEnd();
-      
-    clPopMatrix();
-  }
-
-  void draw_classic(CL_GraphicContext* gc)
-  {
-    gc-&gt;push_modelview();
-    gc-&gt;add_modelview(modelview);
-
-    Field&lt;Tile*&gt;&amp; field = tilemap-&gt;field;
-
-    for (int y = rect.top;   y &lt; rect.bottom; ++y)
-      for (int x = rect.left; x &lt; rect.right; ++x)
-        {
-          if (field(x,y))
-            {
-              if (!highlight)
-                {
-                  field(x,y)-&gt;get_color_sprite().draw(x * TILE_SIZE, y * TILE_SIZE);
-                }
-              else
-                {
-                  if (field(x, y)-&gt;get_highlight_sprite())
-                    field(x,y)-&gt;get_highlight_sprite().draw(x * TILE_SIZE, y * TILE_SIZE);
-                }
-            }
-        }
-    gc-&gt;pop_modelview();
-  }
-};
-
-void
-TileMap::draw (SceneContext&amp; sc)
-{
-  CL_Rect rect = CL_Rect(View::current()-&gt;get_clip_rect());
-
-  int start_x = std::max(0, rect.left/TILE_SIZE);
-  int start_y = std::max(0, rect.top/TILE_SIZE);
-  int end_x   = std::min(field.get_width(),  rect.right/TILE_SIZE + 1);
-  int end_y   = std::min(field.get_height(), rect.bottom/TILE_SIZE + 1);
-
-  sc.color().draw(new TileMapDrawingRequest(this, false, CL_Rect(start_x, start_y,
-                                                                 end_x,   end_y),
-                                            CL_Vector(0,0,z_pos),
-                                            sc.color().get_modelview()));
-  sc.highlight().draw(new TileMapDrawingRequest(this, true, CL_Rect(start_x, start_y,
-                                                                    end_x,   end_y),
-                                                CL_Vector(0,0,z_pos),
-                                                sc.color().get_modelview()));
-}
-
-unsigned int
-TileMap::get_pixel(int x, int y)
-{
-  if (x &lt; 0 || y &lt; 0 
-      || x &gt;= int(field.get_width())
-      || y &gt;= int(field.get_height()))
-    {
-      //std::cout &lt;&lt; &quot;Out of bounce: &quot; &lt;&lt; x &lt;&lt; &quot;, &quot; &lt;&lt; y &lt;&lt; std::endl;
-      return 0;
-    }
-  else
-    {
-      Tile* tile = field(x, y);
-      
-      if (tile)
-        return tile-&gt;get_colmap();
-      else
-        return 0;     
-    }
-}
-
-bool
-TileMap::is_ground (float x, float y)
-{
-  int x_pos = int(x) / TILE_SIZE;
-  int y_pos = int(y) / TILE_SIZE;
-
-  if (x &lt; 0 || x_pos &gt;= field.get_width())
-    {
-      //std::cout &lt;&lt; &quot;TileMap::is_ground (): Out of range: &quot; &lt;&lt; x_pos &lt;&lt; &quot; &quot; &lt;&lt; y_pos &lt;&lt; std::endl;
-      return 1;
-    }
-  else if (y &lt; 0 || y_pos &gt;= field.get_height())
-    {
-      return 0;
-    }
-
-
-  if (field (x_pos, y_pos))
-    return field(x_pos, y_pos)-&gt;get_colmap();
-  else
-    return 0;
-}
-
-/* EOF */

Copied: trunk/src/tile_map.hpp (from rev 502, trunk/src/tile_map.hxx)
===================================================================
--- trunk/src/tile_map.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/tile_map.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,69 @@
+//  $Id: tile_map.hpp,v 1.7 2003/09/13 18:01:17 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef TILEMAP_HXX
+#define TILEMAP_HXX
+
+#include &lt;ClanLib/core.h&gt;
+#include &lt;ClanLib/display.h&gt;
+#include &lt;string&gt;
+
+#include &quot;globals.hpp&quot;
+#include &quot;field.hpp&quot;
+#include &quot;lisp/lisp.hpp&quot;
+#include &quot;game_object.hpp&quot;
+#include &quot;display/scene_context.hpp&quot;
+
+class Tile;
+
+class TileMap : public GameObject
+{
+private:
+  friend class TileMapDrawingRequest;
+  Field&lt;Tile*&gt; field;
+  typedef Field&lt;Tile*&gt;::iterator FieldIter;
+  std::string name;
+  float z_pos; 
+  float total_time;
+public:
+  TileMap(const lisp::Lisp* lisp);
+  TileMap(const std::string&amp; name, int w, int h);
+  TileMap(Field&lt;int&gt;* data);
+  virtual ~TileMap();
+
+  void update (float delta);
+  void draw (SceneContext&amp; gc);
+  
+  /** @return the type of ground at the given world coordinates */
+  bool is_ground(float x, float y);
+
+  /** @return the type of ground at the given subtile coordinates */
+  unsigned int get_pixel(int x, int y);
+  
+  int get_width () const { return field.get_width(); }
+  int get_height () const { return field.get_height (); }
+
+  int get_tile_size () const { return TILE_SIZE; }
+
+  std::string get_name() const { return name; }
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/tile_map.hxx
===================================================================
--- trunk/src/tile_map.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/tile_map.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,69 +0,0 @@
-//  $Id: tile_map.hxx,v 1.7 2003/09/13 18:01:17 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef TILEMAP_HXX
-#define TILEMAP_HXX
-
-#include &lt;ClanLib/core.h&gt;
-#include &lt;ClanLib/display.h&gt;
-#include &lt;string&gt;
-
-#include &quot;globals.hxx&quot;
-#include &quot;field.hxx&quot;
-#include &quot;lisp/lisp.hpp&quot;
-#include &quot;game_object.hxx&quot;
-#include &quot;display/scene_context.hxx&quot;
-
-class Tile;
-
-class TileMap : public GameObject
-{
-private:
-  friend class TileMapDrawingRequest;
-  Field&lt;Tile*&gt; field;
-  typedef Field&lt;Tile*&gt;::iterator FieldIter;
-  std::string name;
-  float z_pos; 
-  float total_time;
-public:
-  TileMap(const lisp::Lisp* lisp);
-  TileMap(const std::string&amp; name, int w, int h);
-  TileMap(Field&lt;int&gt;* data);
-  virtual ~TileMap();
-
-  void update (float delta);
-  void draw (SceneContext&amp; gc);
-  
-  /** @return the type of ground at the given world coordinates */
-  bool is_ground(float x, float y);
-
-  /** @return the type of ground at the given subtile coordinates */
-  unsigned int get_pixel(int x, int y);
-  
-  int get_width () const { return field.get_width(); }
-  int get_height () const { return field.get_height (); }
-
-  int get_tile_size () const { return TILE_SIZE; }
-
-  std::string get_name() const { return name; }
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/tile_packer.cpp (from rev 502, trunk/src/tile_packer.cxx)
===================================================================
--- trunk/src/tile_packer.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/tile_packer.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,117 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;assert.h&gt;
+#include &lt;ClanLib/Core/Math/rect.h&gt;
+#include &lt;ClanLib/Core/Math/point.h&gt;
+#include &lt;ClanLib/Display/pixel_buffer.h&gt;
+#include &lt;ClanLib/Display/pixel_format.h&gt;
+#include &lt;ClanLib/gl.h&gt;
+#include &quot;windstille_error.hpp&quot;
+#include &quot;blitter.hpp&quot;
+#include &quot;globals.hpp&quot;
+#include &quot;tile_packer.hpp&quot;
+
+class TilePackerImpl
+{
+public:
+  // Position for the next tile
+  int x_pos;
+  int y_pos;
+
+  CL_PixelBuffer buffer;
+  CL_OpenGLSurface texture;
+};
+
+TilePacker::TilePacker(int width, int height)
+  : impl(new TilePackerImpl())
+{
+  impl-&gt;x_pos = 0;
+  impl-&gt;y_pos = 0;
+
+  impl-&gt;buffer = CL_PixelBuffer(width, height, width*4,
+                                CL_PixelFormat::rgba8888);
+}
+
+TilePacker::~TilePacker()
+{
+  delete impl;
+}
+
+/** Pack a tile and return the position where it is placed in the
+    pixel buffer */
+CL_Rectf
+TilePacker::pack(CL_PixelBuffer tile)
+{
+  assert(tile.get_width() == TILE_SIZE &amp;&amp; tile.get_height() == TILE_SIZE);
+  assert(!is_full());
+
+  blit_opaque(impl-&gt;buffer, tile, impl-&gt;x_pos+1, impl-&gt;y_pos+1);
+  blit_opaque(impl-&gt;buffer, tile, impl-&gt;x_pos+1, impl-&gt;y_pos);
+  blit_opaque(impl-&gt;buffer, tile, impl-&gt;x_pos, impl-&gt;y_pos+1);
+
+  blit_opaque(impl-&gt;buffer, tile, impl-&gt;x_pos, impl-&gt;y_pos);
+
+  float factor = 0;
+  CL_Rectf rect(CL_Pointf((impl-&gt;x_pos)/1024.0f, 
+                          (impl-&gt;y_pos)/1024.0f), 
+                CL_Sizef((TILE_SIZE+factor)/1024.0f, 
+                         (TILE_SIZE+factor)/1024.0f));
+
+  // we move by TILE_SIZE+1 to avoid tiles bleeding into each other
+  // when blending
+  impl-&gt;x_pos += TILE_SIZE + 2; 
+
+  if (impl-&gt;x_pos + TILE_SIZE &gt; impl-&gt;buffer.get_width())
+    {
+      impl-&gt;x_pos = 0;
+      impl-&gt;y_pos += TILE_SIZE + 2;
+    }
+
+  return rect;
+}
+
+/** Return true if the PixelBuffer is full */
+bool
+TilePacker::is_full() const
+{
+  return (impl-&gt;y_pos + TILE_SIZE &gt; impl-&gt;buffer.get_height());
+}
+
+CL_OpenGLSurface
+TilePacker::get_texture()
+{
+  if (impl-&gt;texture)
+    {
+      return CL_Surface(impl-&gt;texture);
+    }
+  else
+    {
+      impl-&gt;texture = CL_Surface(CL_OpenGLSurface(impl-&gt;buffer));
+      return CL_Surface(impl-&gt;texture);
+    }
+}
+
+CL_PixelBuffer
+TilePacker::get_pixelbuffer() const
+{
+  return impl-&gt;buffer;
+}
+
+/* EOF */

Deleted: trunk/src/tile_packer.cxx
===================================================================
--- trunk/src/tile_packer.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/tile_packer.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,117 +0,0 @@
-//  $Id$
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;assert.h&gt;
-#include &lt;ClanLib/Core/Math/rect.h&gt;
-#include &lt;ClanLib/Core/Math/point.h&gt;
-#include &lt;ClanLib/Display/pixel_buffer.h&gt;
-#include &lt;ClanLib/Display/pixel_format.h&gt;
-#include &lt;ClanLib/gl.h&gt;
-#include &quot;windstille_error.hxx&quot;
-#include &quot;blitter.hxx&quot;
-#include &quot;globals.hxx&quot;
-#include &quot;tile_packer.hxx&quot;
-
-class TilePackerImpl
-{
-public:
-  // Position for the next tile
-  int x_pos;
-  int y_pos;
-
-  CL_PixelBuffer buffer;
-  CL_OpenGLSurface texture;
-};
-
-TilePacker::TilePacker(int width, int height)
-  : impl(new TilePackerImpl())
-{
-  impl-&gt;x_pos = 0;
-  impl-&gt;y_pos = 0;
-
-  impl-&gt;buffer = CL_PixelBuffer(width, height, width*4,
-                                CL_PixelFormat::rgba8888);
-}
-
-TilePacker::~TilePacker()
-{
-  delete impl;
-}
-
-/** Pack a tile and return the position where it is placed in the
-    pixel buffer */
-CL_Rectf
-TilePacker::pack(CL_PixelBuffer tile)
-{
-  assert(tile.get_width() == TILE_SIZE &amp;&amp; tile.get_height() == TILE_SIZE);
-  assert(!is_full());
-
-  blit_opaque(impl-&gt;buffer, tile, impl-&gt;x_pos+1, impl-&gt;y_pos+1);
-  blit_opaque(impl-&gt;buffer, tile, impl-&gt;x_pos+1, impl-&gt;y_pos);
-  blit_opaque(impl-&gt;buffer, tile, impl-&gt;x_pos, impl-&gt;y_pos+1);
-
-  blit_opaque(impl-&gt;buffer, tile, impl-&gt;x_pos, impl-&gt;y_pos);
-
-  float factor = 0;
-  CL_Rectf rect(CL_Pointf((impl-&gt;x_pos)/1024.0f, 
-                          (impl-&gt;y_pos)/1024.0f), 
-                CL_Sizef((TILE_SIZE+factor)/1024.0f, 
-                         (TILE_SIZE+factor)/1024.0f));
-
-  // we move by TILE_SIZE+1 to avoid tiles bleeding into each other
-  // when blending
-  impl-&gt;x_pos += TILE_SIZE + 2; 
-
-  if (impl-&gt;x_pos + TILE_SIZE &gt; impl-&gt;buffer.get_width())
-    {
-      impl-&gt;x_pos = 0;
-      impl-&gt;y_pos += TILE_SIZE + 2;
-    }
-
-  return rect;
-}
-
-/** Return true if the PixelBuffer is full */
-bool
-TilePacker::is_full() const
-{
-  return (impl-&gt;y_pos + TILE_SIZE &gt; impl-&gt;buffer.get_height());
-}
-
-CL_OpenGLSurface
-TilePacker::get_texture()
-{
-  if (impl-&gt;texture)
-    {
-      return CL_Surface(impl-&gt;texture);
-    }
-  else
-    {
-      impl-&gt;texture = CL_Surface(CL_OpenGLSurface(impl-&gt;buffer));
-      return CL_Surface(impl-&gt;texture);
-    }
-}
-
-CL_PixelBuffer
-TilePacker::get_pixelbuffer() const
-{
-  return impl-&gt;buffer;
-}
-
-/* EOF */

Copied: trunk/src/tile_packer.hpp (from rev 502, trunk/src/tile_packer.hxx)

Deleted: trunk/src/tile_packer.hxx
===================================================================
--- trunk/src/tile_packer.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/tile_packer.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,55 +0,0 @@
-//  $Id$
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_TILE_PACKER_HXX
-#define HEADER_TILE_PACKER_HXX
-
-#include &lt;ClanLib/GL/texture.h&gt;
-
-class TilePackerImpl;
-
-/** Creates a pixelbuffer of the given size and packs 32x32 large
-    tiles into it for later conversion to a texture */
-class TilePacker
-{
-private:
-public:
-  /** Let the texture be width/height large (only power of two values
-      recomment) */
-  TilePacker(int width, int height);
-  ~TilePacker();
-
-  /** Pack a tile and return the position where it is placed in the
-      pixel buffer */
-  CL_Rectf pack(CL_PixelBuffer buffer);
-
-  /** Return true if the PixelBuffer is full */
-  bool is_full() const;
-
-  CL_OpenGLSurface get_texture();
-
-  CL_PixelBuffer get_pixelbuffer() const;
-
-private:
-  TilePackerImpl* impl;
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/trigger.cpp (from rev 502, trunk/src/trigger.cxx)
===================================================================
--- trunk/src/trigger.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/trigger.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,99 @@
+//  $Id: trigger.cxx,v 1.3 2003/09/21 17:34:00 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;list&gt;
+#include &quot;sector.hpp&quot;
+#include &quot;trigger.hpp&quot;
+#include &quot;player.hpp&quot;
+#include &quot;script_manager.hpp&quot;
+#include &quot;lisp/lisp.hpp&quot;
+#include &quot;lisp/list_iterator.hpp&quot;
+
+Trigger::Trigger(const lisp::Lisp* lisp)
+  : triggered(false), one_time_trigger(false)
+{
+  float x = -1;
+  float y = -1;
+  float width = -1;
+  float height = -1;
+  
+  lisp::ListIterator iter(lisp);
+  while(iter.next()) {
+    if(iter.item() == &quot;x&quot;) {
+      x = iter.value().get_float();
+    } else if(iter.item() == &quot;y&quot;) {
+      y = iter.value().get_float();
+    } else if(iter.item() == &quot;width&quot;) {
+      width = iter.value().get_float();
+    } else if(iter.item() == &quot;height&quot;) {
+      height = iter.value().get_float();
+    } else if(iter.item() == &quot;script&quot;) {
+      script = iter.value().get_string();
+    } else if(iter.item() == &quot;one_time_trigger&quot;) {
+      one_time_trigger = iter.value().get_bool();
+    } else {
+      std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot;
+                &lt;&lt; iter.item() &lt;&lt; &quot;' in Trigger object.\n&quot;;
+    }
+  }
+
+  if(x &lt; 0 || y &lt; 0 || width &lt; 0 || height &lt; 0)
+    throw std::runtime_error(&quot;Invalid or missing area in Trigger object&quot;);
+ 
+  area.left = x;
+  area.top = y;
+  area.right = area.left + width;
+  area.bottom = area.top + height;
+}
+
+Trigger::~Trigger()
+{
+}
+
+void
+Trigger::draw (SceneContext&amp; )
+{
+}
+
+void
+Trigger::update (float )
+{
+  Player* player = Player::current();
+  if(!area.is_inside(CL_Pointf(player-&gt;get_pos().x,
+                                  player-&gt;get_pos().y))) {
+    last_trigger = false;
+    return;
+  }
+  
+  if(triggered &amp;&amp; one_time_trigger)
+    return;
+
+  if(last_trigger == false) {
+    triggered = true;
+    try {
+      //for(int i = 0; i &lt; 1000; ++i)
+      script_manager-&gt;run_script(script, &quot;TriggerObject&quot;);
+    } catch(std::exception&amp; e) {
+      std::cerr &lt;&lt; &quot;Couldn't run trigger-script: &quot; &lt;&lt; e.what() &lt;&lt; &quot;\n&quot;;
+    }
+  }
+  last_trigger = true;
+}
+
+/* EOF */

Deleted: trunk/src/trigger.cxx
===================================================================
--- trunk/src/trigger.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/trigger.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,99 +0,0 @@
-//  $Id: trigger.cxx,v 1.3 2003/09/21 17:34:00 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;list&gt;
-#include &quot;sector.hxx&quot;
-#include &quot;trigger.hxx&quot;
-#include &quot;player.hxx&quot;
-#include &quot;script_manager.hpp&quot;
-#include &quot;lisp/lisp.hpp&quot;
-#include &quot;lisp/list_iterator.hpp&quot;
-
-Trigger::Trigger(const lisp::Lisp* lisp)
-  : triggered(false), one_time_trigger(false)
-{
-  float x = -1;
-  float y = -1;
-  float width = -1;
-  float height = -1;
-  
-  lisp::ListIterator iter(lisp);
-  while(iter.next()) {
-    if(iter.item() == &quot;x&quot;) {
-      x = iter.value().get_float();
-    } else if(iter.item() == &quot;y&quot;) {
-      y = iter.value().get_float();
-    } else if(iter.item() == &quot;width&quot;) {
-      width = iter.value().get_float();
-    } else if(iter.item() == &quot;height&quot;) {
-      height = iter.value().get_float();
-    } else if(iter.item() == &quot;script&quot;) {
-      script = iter.value().get_string();
-    } else if(iter.item() == &quot;one_time_trigger&quot;) {
-      one_time_trigger = iter.value().get_bool();
-    } else {
-      std::cerr &lt;&lt; &quot;Skipping unknown tag '&quot;
-                &lt;&lt; iter.item() &lt;&lt; &quot;' in Trigger object.\n&quot;;
-    }
-  }
-
-  if(x &lt; 0 || y &lt; 0 || width &lt; 0 || height &lt; 0)
-    throw std::runtime_error(&quot;Invalid or missing area in Trigger object&quot;);
- 
-  area.left = x;
-  area.top = y;
-  area.right = area.left + width;
-  area.bottom = area.top + height;
-}
-
-Trigger::~Trigger()
-{
-}
-
-void
-Trigger::draw (SceneContext&amp; )
-{
-}
-
-void
-Trigger::update (float )
-{
-  Player* player = Player::current();
-  if(!area.is_inside(CL_Pointf(player-&gt;get_pos().x,
-                                  player-&gt;get_pos().y))) {
-    last_trigger = false;
-    return;
-  }
-  
-  if(triggered &amp;&amp; one_time_trigger)
-    return;
-
-  if(last_trigger == false) {
-    triggered = true;
-    try {
-      //for(int i = 0; i &lt; 1000; ++i)
-      script_manager-&gt;run_script(script, &quot;TriggerObject&quot;);
-    } catch(std::exception&amp; e) {
-      std::cerr &lt;&lt; &quot;Couldn't run trigger-script: &quot; &lt;&lt; e.what() &lt;&lt; &quot;\n&quot;;
-    }
-  }
-  last_trigger = true;
-}
-
-/* EOF */

Copied: trunk/src/trigger.hpp (from rev 502, trunk/src/trigger.hxx)
===================================================================
--- trunk/src/trigger.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/trigger.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,49 @@
+//  $Id: trigger.hpp,v 1.2 2003/09/21 17:34:00 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_TRIGGER_HXX
+#define HEADER_TRIGGER_HXX
+
+#include &lt;vector&gt;
+#include &lt;ClanLib/Core/Math/rect.h&gt;
+#include &quot;game_object.hpp&quot;
+
+/** */
+class Trigger : public GameObject
+{
+private:
+  CL_Rectf area;
+  std::string script;
+  /// has the trigger been activated at least once
+  bool triggered;
+  /// trigger active in last frame
+  bool last_trigger;
+  bool one_time_trigger;
+  
+public:
+  Trigger(const lisp::Lisp* lisp);
+  virtual ~Trigger();
+
+  void draw (SceneContext&amp; gc);
+  void update (float delta);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/trigger.hxx
===================================================================
--- trunk/src/trigger.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/trigger.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,49 +0,0 @@
-//  $Id: trigger.hxx,v 1.2 2003/09/21 17:34:00 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_TRIGGER_HXX
-#define HEADER_TRIGGER_HXX
-
-#include &lt;vector&gt;
-#include &lt;ClanLib/Core/Math/rect.h&gt;
-#include &quot;game_object.hxx&quot;
-
-/** */
-class Trigger : public GameObject
-{
-private:
-  CL_Rectf area;
-  std::string script;
-  /// has the trigger been activated at least once
-  bool triggered;
-  /// trigger active in last frame
-  bool last_trigger;
-  bool one_time_trigger;
-  
-public:
-  Trigger(const lisp::Lisp* lisp);
-  virtual ~Trigger();
-
-  void draw (SceneContext&amp; gc);
-  void update (float delta);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/view.cpp (from rev 502, trunk/src/view.cxx)
===================================================================
--- trunk/src/view.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/view.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,69 @@
+//  $Id: view.cxx,v 1.1 2003/09/21 18:05:21 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;player.hpp&quot;
+#include &quot;sector.hpp&quot;
+#include &quot;view.hpp&quot;
+
+View* View::current_ = 0;
+
+View::View()
+  : state(CL_Display::get_width(), CL_Display::get_height())
+{
+  current_ = this;
+}
+
+void
+View::draw (SceneContext&amp; sc)
+{
+  state.set_pos(camera.get_pos());
+
+  static float zoom = 1.0f;
+
+  if (CL_Keyboard::get_keycode(CL_KEY_A))
+    zoom *= 1.01f/1.0f;
+  if (CL_Keyboard::get_keycode(CL_KEY_O))
+    zoom *= 1.0f/1.01f;
+  
+  state.set_zoom(zoom);
+
+  state.push(sc);
+  Sector::current()-&gt;draw(sc);
+  state.pop(sc);
+}
+
+void
+View::update (float delta)
+{
+  camera.update(delta);
+}
+
+CL_Rectf
+View::get_clip_rect()
+{
+  return state.get_clip_rect();
+}
+
+CL_Pointf
+View::screen2world(CL_Pointf point)
+{
+  return state.screen2world(CL_Point(point));
+}
+
+/* EOF */

Deleted: trunk/src/view.cxx
===================================================================
--- trunk/src/view.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/view.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,69 +0,0 @@
-//  $Id: view.cxx,v 1.1 2003/09/21 18:05:21 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;player.hxx&quot;
-#include &quot;sector.hxx&quot;
-#include &quot;view.hxx&quot;
-
-View* View::current_ = 0;
-
-View::View()
-  : state(CL_Display::get_width(), CL_Display::get_height())
-{
-  current_ = this;
-}
-
-void
-View::draw (SceneContext&amp; sc)
-{
-  state.set_pos(camera.get_pos());
-
-  static float zoom = 1.0f;
-
-  if (CL_Keyboard::get_keycode(CL_KEY_A))
-    zoom *= 1.01f/1.0f;
-  if (CL_Keyboard::get_keycode(CL_KEY_O))
-    zoom *= 1.0f/1.01f;
-  
-  state.set_zoom(zoom);
-
-  state.push(sc);
-  Sector::current()-&gt;draw(sc);
-  state.pop(sc);
-}
-
-void
-View::update (float delta)
-{
-  camera.update(delta);
-}
-
-CL_Rectf
-View::get_clip_rect()
-{
-  return state.get_clip_rect();
-}
-
-CL_Pointf
-View::screen2world(CL_Pointf point)
-{
-  return state.screen2world(CL_Point(point));
-}
-
-/* EOF */

Copied: trunk/src/view.hpp (from rev 502, trunk/src/view.hxx)
===================================================================
--- trunk/src/view.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/view.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,59 @@
+//  $Id: view.hpp,v 1.2 2003/10/11 12:15:59 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_VIEW_HXX
+#define HEADER_VIEW_HXX
+
+#include &lt;ClanLib/Core/Math/rect.h&gt;
+#include &lt;ClanLib/Core/Math/cl_vector.h&gt;
+#include &quot;camera.hpp&quot;
+#include &quot;graphic_context_state.hpp&quot;
+
+class Player;
+class Sector;
+class SceneContext;
+
+/** This class is the gui component which renders the world to the
+    screen */
+class View
+{
+private:
+  GraphicContextState state;
+  Camera camera;
+
+public:
+  View();
+
+  /** @return the rectangle which represents the currently visible
+      area, everything outside of it doesn't have to be drawn */
+  CL_Rectf get_clip_rect();
+  CL_Pointf screen2world(CL_Pointf point);
+
+  void draw(SceneContext&amp; gc);
+  void update(float delta);
+
+  static View* current() { return current_; }
+
+protected:
+  static View* current_;
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/view.hxx
===================================================================
--- trunk/src/view.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/view.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,59 +0,0 @@
-//  $Id: view.hxx,v 1.2 2003/10/11 12:15:59 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_VIEW_HXX
-#define HEADER_VIEW_HXX
-
-#include &lt;ClanLib/Core/Math/rect.h&gt;
-#include &lt;ClanLib/Core/Math/cl_vector.h&gt;
-#include &quot;camera.hxx&quot;
-#include &quot;graphic_context_state.hxx&quot;
-
-class Player;
-class Sector;
-class SceneContext;
-
-/** This class is the gui component which renders the world to the
-    screen */
-class View
-{
-private:
-  GraphicContextState state;
-  Camera camera;
-
-public:
-  View();
-
-  /** @return the rectangle which represents the currently visible
-      area, everything outside of it doesn't have to be drawn */
-  CL_Rectf get_clip_rect();
-  CL_Pointf screen2world(CL_Pointf point);
-
-  void draw(SceneContext&amp; gc);
-  void update(float delta);
-
-  static View* current() { return current_; }
-
-protected:
-  static View* current_;
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/water_map.cpp (from rev 502, trunk/src/water_map.cxx)
===================================================================
--- trunk/src/water_map.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/water_map.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,126 @@
+//  $Id: water_map.cxx,v 1.4 2003/09/27 08:29:12 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ClanLib/Display/display.h&gt;
+#include &quot;globals.hpp&quot;
+#include &quot;player.hpp&quot;
+#include &quot;sector.hpp&quot;
+#include &quot;water_map.hpp&quot;
+#include &quot;water_splash.hpp&quot;
+
+WaterMap::WaterMap()
+{
+}
+
+WaterMap::~WaterMap()
+{
+}
+
+void
+WaterMap::draw(SceneContext&amp; )
+{
+  for (Waters::iterator i = waters.begin(); i != waters.end(); ++i)
+    {
+      // Transform subtile CO to pixels
+      int x = i-&gt;x;
+      int y = i-&gt;y;
+      int w = i-&gt;w;
+      int h = i-&gt;h;
+
+      CL_Display::fill_rect(CL_Rect(x, y, x + w, y + 15), 
+                            CL_Gradient(CL_Color(200, 200, 200, 128),
+                                        CL_Color(200, 200, 200, 128),
+                                        CL_Color(  0,   0, 200, 128),
+                                        CL_Color(  0,   0, 200, 128)));
+
+      CL_Display::fill_rect(CL_Rect(x, y+15, x + w, y + h - 15), 
+                            CL_Gradient(CL_Color(  0,   0, 200, 128),
+                                        CL_Color(  0,   0, 200, 128),
+                                        CL_Color(  0,   0,  50, 128),
+                                        CL_Color(  0,   0,  50, 128)));
+    }
+
+  /*
+    if (0) // Water
+    {
+    int x1 = 0;
+    int y1 = 100;
+    int x2 = 8000;
+    int y2 = 5000;
+      
+    Display::begin_gl();
+    {
+    glEnable (GL_BLEND);
+    glBlendFunc( GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA );
+    glBegin(GL_QUADS);
+    { // Water
+    glColor4f(0.8f, 0.8f, 1.0f, 0.5f);
+
+    glVertex2f(x1, y1);
+    glVertex2f(x2, y1);
+ 
+    glColor4f(0.0f, 0.0f, 0.8f, 0.5f);
+    glVertex2f(x2, y1 + 15);
+    glVertex2f(x1, y1 + 15);
+
+    glVertex2f(x1,  y1 + 15);
+    glVertex2f(800, y1 + 15);
+
+    glColor4f(0.0f, 0.0f, .2f, 0.5f);
+    glVertex2f(x2, y2);
+    glVertex2f(x1, y2);
+    }
+    glEnd();
+    }
+    Display::end_gl();
+    }*/
+}
+
+void
+WaterMap::update(float )
+{
+  CL_Vector pos = Player::current()-&gt;get_pos();
+
+  for (Waters::iterator i = waters.begin(); i != waters.end(); ++i)
+    {
+      // Transform subtile CO to pixels
+      int x = i-&gt;x;
+      int y = i-&gt;y;
+      int w = i-&gt;w;
+
+      if (pos.x &gt; x &amp;&amp; pos.x &lt; x + w)
+        {
+          // Player went through water
+          if ((old_pos.y &lt; y &amp;&amp; pos.y &gt; y)
+              || (old_pos.y &gt; y &amp;&amp; pos.y &lt; y))
+            {
+              Sector::current()-&gt;add(new WaterSplash(pos.x, y));
+            }
+        }
+    }
+  old_pos = pos;
+}
+
+void
+WaterMap::add_water(int x, int y, int w, int h)
+{
+  waters.push_back(Water(x, y, w, h));
+}
+
+/* EOF */

Deleted: trunk/src/water_map.cxx
===================================================================
--- trunk/src/water_map.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/water_map.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,126 +0,0 @@
-//  $Id: water_map.cxx,v 1.4 2003/09/27 08:29:12 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ClanLib/Display/display.h&gt;
-#include &quot;globals.hxx&quot;
-#include &quot;player.hxx&quot;
-#include &quot;sector.hxx&quot;
-#include &quot;water_map.hxx&quot;
-#include &quot;water_splash.hxx&quot;
-
-WaterMap::WaterMap()
-{
-}
-
-WaterMap::~WaterMap()
-{
-}
-
-void
-WaterMap::draw(SceneContext&amp; )
-{
-  for (Waters::iterator i = waters.begin(); i != waters.end(); ++i)
-    {
-      // Transform subtile CO to pixels
-      int x = i-&gt;x;
-      int y = i-&gt;y;
-      int w = i-&gt;w;
-      int h = i-&gt;h;
-
-      CL_Display::fill_rect(CL_Rect(x, y, x + w, y + 15), 
-                            CL_Gradient(CL_Color(200, 200, 200, 128),
-                                        CL_Color(200, 200, 200, 128),
-                                        CL_Color(  0,   0, 200, 128),
-                                        CL_Color(  0,   0, 200, 128)));
-
-      CL_Display::fill_rect(CL_Rect(x, y+15, x + w, y + h - 15), 
-                            CL_Gradient(CL_Color(  0,   0, 200, 128),
-                                        CL_Color(  0,   0, 200, 128),
-                                        CL_Color(  0,   0,  50, 128),
-                                        CL_Color(  0,   0,  50, 128)));
-    }
-
-  /*
-    if (0) // Water
-    {
-    int x1 = 0;
-    int y1 = 100;
-    int x2 = 8000;
-    int y2 = 5000;
-      
-    Display::begin_gl();
-    {
-    glEnable (GL_BLEND);
-    glBlendFunc( GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA );
-    glBegin(GL_QUADS);
-    { // Water
-    glColor4f(0.8f, 0.8f, 1.0f, 0.5f);
-
-    glVertex2f(x1, y1);
-    glVertex2f(x2, y1);
- 
-    glColor4f(0.0f, 0.0f, 0.8f, 0.5f);
-    glVertex2f(x2, y1 + 15);
-    glVertex2f(x1, y1 + 15);
-
-    glVertex2f(x1,  y1 + 15);
-    glVertex2f(800, y1 + 15);
-
-    glColor4f(0.0f, 0.0f, .2f, 0.5f);
-    glVertex2f(x2, y2);
-    glVertex2f(x1, y2);
-    }
-    glEnd();
-    }
-    Display::end_gl();
-    }*/
-}
-
-void
-WaterMap::update(float )
-{
-  CL_Vector pos = Player::current()-&gt;get_pos();
-
-  for (Waters::iterator i = waters.begin(); i != waters.end(); ++i)
-    {
-      // Transform subtile CO to pixels
-      int x = i-&gt;x;
-      int y = i-&gt;y;
-      int w = i-&gt;w;
-
-      if (pos.x &gt; x &amp;&amp; pos.x &lt; x + w)
-        {
-          // Player went through water
-          if ((old_pos.y &lt; y &amp;&amp; pos.y &gt; y)
-              || (old_pos.y &gt; y &amp;&amp; pos.y &lt; y))
-            {
-              Sector::current()-&gt;add(new WaterSplash(pos.x, y));
-            }
-        }
-    }
-  old_pos = pos;
-}
-
-void
-WaterMap::add_water(int x, int y, int w, int h)
-{
-  waters.push_back(Water(x, y, w, h));
-}
-
-/* EOF */

Copied: trunk/src/water_map.hpp (from rev 502, trunk/src/water_map.hxx)
===================================================================
--- trunk/src/water_map.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/water_map.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,58 @@
+//  $Id: water_map.hpp,v 1.2 2003/09/12 20:17:06 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_WATER_MAP_HXX
+#define HEADER_WATER_MAP_HXX
+
+#include &lt;vector&gt;
+#include &lt;ClanLib/Core/Math/cl_vector.h&gt;
+
+/** */
+class WaterMap
+{
+private:
+  struct Water {
+    Water(int x, int y, int w, int h)
+      : x(x), y(y), w(w), h(h)
+    {
+    }
+    int x, y;
+    int w, h;
+  };  
+
+  typedef std::vector&lt;Water&gt; Waters;
+  Waters waters;
+  CL_Vector old_pos;
+public:
+  WaterMap();
+  ~WaterMap();
+
+  void draw(SceneContext&amp; gc);
+  void update(float delta);
+
+  void add_water(int x, int y, int w, int h);
+
+private:
+  WaterMap (const WaterMap&amp;);
+  WaterMap&amp; operator= (const WaterMap&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/water_map.hxx
===================================================================
--- trunk/src/water_map.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/water_map.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,58 +0,0 @@
-//  $Id: water_map.hxx,v 1.2 2003/09/12 20:17:06 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_WATER_MAP_HXX
-#define HEADER_WATER_MAP_HXX
-
-#include &lt;vector&gt;
-#include &lt;ClanLib/Core/Math/cl_vector.h&gt;
-
-/** */
-class WaterMap
-{
-private:
-  struct Water {
-    Water(int x, int y, int w, int h)
-      : x(x), y(y), w(w), h(h)
-    {
-    }
-    int x, y;
-    int w, h;
-  };  
-
-  typedef std::vector&lt;Water&gt; Waters;
-  Waters waters;
-  CL_Vector old_pos;
-public:
-  WaterMap();
-  ~WaterMap();
-
-  void draw(SceneContext&amp; gc);
-  void update(float delta);
-
-  void add_water(int x, int y, int w, int h);
-
-private:
-  WaterMap (const WaterMap&amp;);
-  WaterMap&amp; operator= (const WaterMap&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/water_splash.cpp (from rev 502, trunk/src/water_splash.cxx)
===================================================================
--- trunk/src/water_splash.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/water_splash.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,57 @@
+//  $Id: water_splash.cxx,v 1.3 2003/09/13 10:11:33 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;globals.hpp&quot;
+#include &quot;water_splash.hpp&quot;
+
+WaterSplash::WaterSplash(float x, float y)
+  : sprite(&quot;watersplash&quot;, resources)
+{
+  pos = CL_Vector(x, y);
+  time = 0;
+}
+
+WaterSplash::~WaterSplash()
+{
+}
+
+void
+WaterSplash::draw (SceneContext&amp; )
+{
+  float factor = time * 2.0f;
+  
+  factor -= 0.5f;
+  factor *= 2.0f;
+  factor = (1.0f-(factor*factor*factor*factor));
+
+  sprite.set_scale(1.0f, 2*factor);
+    
+  sprite.draw((int)pos.x, (int)pos.y);
+}
+
+void
+WaterSplash::update (float delta)
+{
+  time += delta;
+
+  if (time &gt; 1.0f/2)
+    remove();
+}
+
+/* EOF */

Deleted: trunk/src/water_splash.cxx
===================================================================
--- trunk/src/water_splash.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/water_splash.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,57 +0,0 @@
-//  $Id: water_splash.cxx,v 1.3 2003/09/13 10:11:33 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;globals.hxx&quot;
-#include &quot;water_splash.hxx&quot;
-
-WaterSplash::WaterSplash(float x, float y)
-  : sprite(&quot;watersplash&quot;, resources)
-{
-  pos = CL_Vector(x, y);
-  time = 0;
-}
-
-WaterSplash::~WaterSplash()
-{
-}
-
-void
-WaterSplash::draw (SceneContext&amp; )
-{
-  float factor = time * 2.0f;
-  
-  factor -= 0.5f;
-  factor *= 2.0f;
-  factor = (1.0f-(factor*factor*factor*factor));
-
-  sprite.set_scale(1.0f, 2*factor);
-    
-  sprite.draw((int)pos.x, (int)pos.y);
-}
-
-void
-WaterSplash::update (float delta)
-{
-  time += delta;
-
-  if (time &gt; 1.0f/2)
-    remove();
-}
-
-/* EOF */

Copied: trunk/src/water_splash.hpp (from rev 502, trunk/src/water_splash.hxx)
===================================================================
--- trunk/src/water_splash.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/water_splash.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,47 @@
+//  $Id: water_splash.hpp,v 1.1 2003/09/12 20:17:06 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_WATER_SPLASH_HXX
+#define HEADER_WATER_SPLASH_HXX
+
+#include &lt;ClanLib/Display/sprite.h&gt;
+#include &lt;ClanLib/Core/Math/cl_vector.h&gt;
+#include &quot;game_object.hpp&quot;
+
+/** */
+class WaterSplash : public GameObject
+{
+private:
+  CL_Vector pos;
+  CL_Sprite sprite;
+  float time;
+public:
+  WaterSplash(float x, float y);
+  virtual ~WaterSplash();
+
+  void draw (SceneContext&amp; gc);
+  void update (float);
+private:
+  WaterSplash (const WaterSplash&amp;);
+  WaterSplash&amp; operator= (const WaterSplash&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/water_splash.hxx
===================================================================
--- trunk/src/water_splash.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/water_splash.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,47 +0,0 @@
-//  $Id: water_splash.hxx,v 1.1 2003/09/12 20:17:06 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_WATER_SPLASH_HXX
-#define HEADER_WATER_SPLASH_HXX
-
-#include &lt;ClanLib/Display/sprite.h&gt;
-#include &lt;ClanLib/Core/Math/cl_vector.h&gt;
-#include &quot;game_object.hxx&quot;
-
-/** */
-class WaterSplash : public GameObject
-{
-private:
-  CL_Vector pos;
-  CL_Sprite sprite;
-  float time;
-public:
-  WaterSplash(float x, float y);
-  virtual ~WaterSplash();
-
-  void draw (SceneContext&amp; gc);
-  void update (float);
-private:
-  WaterSplash (const WaterSplash&amp;);
-  WaterSplash&amp; operator= (const WaterSplash&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/windstille_bonus.cpp (from rev 502, trunk/src/windstille_bonus.cxx)
===================================================================
--- trunk/src/windstille_bonus.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_bonus.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,174 @@
+//  $Id: windstille_bonus.cxx,v 1.6 2003/11/13 12:59:42 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;iostream&gt;
+#include &lt;algorithm&gt;
+#include &lt;ClanLib/Display/display.h&gt;
+#include &lt;ClanLib/Display/display_window.h&gt;
+#include &lt;ClanLib/Display/keyboard.h&gt;
+#include &lt;ClanLib/Display/keys.h&gt;
+#include &lt;ClanLib/Display/font.h&gt;
+#include &lt;list&gt;
+#include &quot;fonts.hpp&quot;
+#include &quot;globals.hpp&quot;
+#include &quot;windstille_bonus.hpp&quot;
+#include &quot;sound/sound_manager.hpp&quot;
+
+WindstilleBonus::WindstilleBonus()
+{
+  std::cout &lt;&lt; &quot;WindstilleBonus: &quot; &lt;&lt; resources &lt;&lt; std::endl;
+  lst = resources-&gt;get_all_resources(&quot;bonus&quot;);
+  std::cout &lt;&lt; &quot;Crash&quot; &lt;&lt; std::endl;
+  
+  std::random_shuffle(lst.begin(), lst.end());
+
+  lst.push_back(&quot;bonus_end&quot;);
+
+  index = 0;
+  state = FADEIN;
+  fadeout_value = 0;
+  passed_time = 0;
+  pos.x = rand()%400 + 200;
+  pos.y = rand()%300 + 150;
+  sprite = CL_Sprite(lst[index], resources);
+  sprite.set_alignment(origin_center);
+}
+
+WindstilleBonus::~WindstilleBonus()
+{
+}
+  
+void
+WindstilleBonus::draw()
+{
+  //CL_Display::clear();
+  CL_Display::fill_rect(CL_Rect(0, 0, CL_Display::get_width(), CL_Display::get_height()),
+                        CL_Gradient(CL_Color(0,0,0),
+                                    CL_Color(0,0,100),
+                                    CL_Color(0,0,100),
+                                    CL_Color(0,0,50)));
+  {
+    CL_Font font = Fonts::dialog;
+    font.set_alignment(origin_top_left);
+    font.draw(20, 20, &quot;What's to come?&quot;);
+    font.set_alignment(origin_bottom_right);
+    font.draw(CL_Display::get_width() - 20,
+              CL_Display::get_height() - 20, &quot;You'll never know...&quot;);
+  }
+  
+  if (state == RUNNING || state == FADEOUT)
+    sprite.draw(pos.x, pos.y);
+
+  switch (state)
+    {
+    case FADEOUT:
+      CL_Display::fill_rect(CL_Rect(0, 0, 
+                                    CL_Display::get_width(), CL_Display::get_height()),
+                            CL_Color(0,0,0, std::min(int(fadeout_value*255), 255)));
+      break;
+    case FADEIN:
+      CL_Display::fill_rect(CL_Rect(0, 0, 
+                                    CL_Display::get_width(), CL_Display::get_height()),
+                            CL_Color(0,0,0, 255-std::min(int(fadeout_value*255), 255)));
+      break;
+    default:
+      break;
+    }
+}
+
+void
+WindstilleBonus::update(float delta)
+{
+  switch (state)
+    {
+    case FADEIN:
+      if (fadeout_value &gt; 1.0f)
+        {
+          state = RUNNING;
+          sound_manager-&gt;play_music(&quot;music/Windstille_Ralph_Weinert.ogg&quot;);
+        }
+      fadeout_value += delta;
+      break;
+
+    case FADEOUT:
+      if (fadeout_value &gt; 1.0f)
+        Screen::quit();
+
+      fadeout_value += delta;
+      break;
+
+    case RUNNING:
+      if (CL_Keyboard::get_keycode(CL_KEY_ESCAPE))
+        quit();
+
+      passed_time += delta;
+
+      if (passed_time &gt; 1.85f)
+        {
+          index += 1;
+
+          if (index &lt; int(lst.size()))
+            {
+              passed_time = 0;
+              sprite = CL_Sprite(lst[index], resources);
+              sprite.set_alignment(origin_center);
+
+              if (index == int(lst.size()) - 1)
+                {
+                  pos.x = 400;
+                  pos.y = 300;
+                }
+              else
+                {
+                  pos.x = rand()%400 + 200;
+                  pos.y = rand()%300 + 150;
+                }
+            }
+          else
+            {
+              quit();
+            }
+        }
+
+      sprite.set_scale(1.0f + passed_time/3.0f,
+                       1.0f + passed_time/3.0f);
+      sprite.set_alpha(std::max(0.0f, std::min(1.0f, 1.0f - passed_time/1.85f)));
+      break;
+    }
+}
+
+void
+WindstilleBonus::quit()
+{
+  sound_manager-&gt;stop_music();
+  state = FADEOUT;
+  fadeout_value = 0;
+}
+
+void
+WindstilleBonus::on_startup()
+{
+}
+
+void
+WindstilleBonus::on_shutdown()
+{
+}
+
+/* EOF */

Deleted: trunk/src/windstille_bonus.cxx
===================================================================
--- trunk/src/windstille_bonus.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_bonus.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,174 +0,0 @@
-//  $Id: windstille_bonus.cxx,v 1.6 2003/11/13 12:59:42 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;iostream&gt;
-#include &lt;algorithm&gt;
-#include &lt;ClanLib/Display/display.h&gt;
-#include &lt;ClanLib/Display/display_window.h&gt;
-#include &lt;ClanLib/Display/keyboard.h&gt;
-#include &lt;ClanLib/Display/keys.h&gt;
-#include &lt;ClanLib/Display/font.h&gt;
-#include &lt;list&gt;
-#include &quot;fonts.hxx&quot;
-#include &quot;globals.hxx&quot;
-#include &quot;windstille_bonus.hxx&quot;
-#include &quot;sound/sound_manager.hpp&quot;
-
-WindstilleBonus::WindstilleBonus()
-{
-  std::cout &lt;&lt; &quot;WindstilleBonus: &quot; &lt;&lt; resources &lt;&lt; std::endl;
-  lst = resources-&gt;get_all_resources(&quot;bonus&quot;);
-  std::cout &lt;&lt; &quot;Crash&quot; &lt;&lt; std::endl;
-  
-  std::random_shuffle(lst.begin(), lst.end());
-
-  lst.push_back(&quot;bonus_end&quot;);
-
-  index = 0;
-  state = FADEIN;
-  fadeout_value = 0;
-  passed_time = 0;
-  pos.x = rand()%400 + 200;
-  pos.y = rand()%300 + 150;
-  sprite = CL_Sprite(lst[index], resources);
-  sprite.set_alignment(origin_center);
-}
-
-WindstilleBonus::~WindstilleBonus()
-{
-}
-  
-void
-WindstilleBonus::draw()
-{
-  //CL_Display::clear();
-  CL_Display::fill_rect(CL_Rect(0, 0, CL_Display::get_width(), CL_Display::get_height()),
-                        CL_Gradient(CL_Color(0,0,0),
-                                    CL_Color(0,0,100),
-                                    CL_Color(0,0,100),
-                                    CL_Color(0,0,50)));
-  {
-    CL_Font font = Fonts::dialog;
-    font.set_alignment(origin_top_left);
-    font.draw(20, 20, &quot;What's to come?&quot;);
-    font.set_alignment(origin_bottom_right);
-    font.draw(CL_Display::get_width() - 20,
-              CL_Display::get_height() - 20, &quot;You'll never know...&quot;);
-  }
-  
-  if (state == RUNNING || state == FADEOUT)
-    sprite.draw(pos.x, pos.y);
-
-  switch (state)
-    {
-    case FADEOUT:
-      CL_Display::fill_rect(CL_Rect(0, 0, 
-                                    CL_Display::get_width(), CL_Display::get_height()),
-                            CL_Color(0,0,0, std::min(int(fadeout_value*255), 255)));
-      break;
-    case FADEIN:
-      CL_Display::fill_rect(CL_Rect(0, 0, 
-                                    CL_Display::get_width(), CL_Display::get_height()),
-                            CL_Color(0,0,0, 255-std::min(int(fadeout_value*255), 255)));
-      break;
-    default:
-      break;
-    }
-}
-
-void
-WindstilleBonus::update(float delta)
-{
-  switch (state)
-    {
-    case FADEIN:
-      if (fadeout_value &gt; 1.0f)
-        {
-          state = RUNNING;
-          sound_manager-&gt;play_music(&quot;music/Windstille_Ralph_Weinert.ogg&quot;);
-        }
-      fadeout_value += delta;
-      break;
-
-    case FADEOUT:
-      if (fadeout_value &gt; 1.0f)
-        Screen::quit();
-
-      fadeout_value += delta;
-      break;
-
-    case RUNNING:
-      if (CL_Keyboard::get_keycode(CL_KEY_ESCAPE))
-        quit();
-
-      passed_time += delta;
-
-      if (passed_time &gt; 1.85f)
-        {
-          index += 1;
-
-          if (index &lt; int(lst.size()))
-            {
-              passed_time = 0;
-              sprite = CL_Sprite(lst[index], resources);
-              sprite.set_alignment(origin_center);
-
-              if (index == int(lst.size()) - 1)
-                {
-                  pos.x = 400;
-                  pos.y = 300;
-                }
-              else
-                {
-                  pos.x = rand()%400 + 200;
-                  pos.y = rand()%300 + 150;
-                }
-            }
-          else
-            {
-              quit();
-            }
-        }
-
-      sprite.set_scale(1.0f + passed_time/3.0f,
-                       1.0f + passed_time/3.0f);
-      sprite.set_alpha(std::max(0.0f, std::min(1.0f, 1.0f - passed_time/1.85f)));
-      break;
-    }
-}
-
-void
-WindstilleBonus::quit()
-{
-  sound_manager-&gt;stop_music();
-  state = FADEOUT;
-  fadeout_value = 0;
-}
-
-void
-WindstilleBonus::on_startup()
-{
-}
-
-void
-WindstilleBonus::on_shutdown()
-{
-}
-
-/* EOF */

Copied: trunk/src/windstille_bonus.hpp (from rev 502, trunk/src/windstille_bonus.hxx)
===================================================================
--- trunk/src/windstille_bonus.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_bonus.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,56 @@
+//  $Id: windstille_bonus.hpp,v 1.2 2003/11/06 10:32:22 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_WINDSTILLE_BONUS_HXX
+#define HEADER_WINDSTILLE_BONUS_HXX
+
+#include &lt;vector&gt;
+#include &lt;ClanLib/Display/sprite.h&gt;
+#include &quot;screen.hpp&quot;
+
+/** */
+class WindstilleBonus : public Windstille::Screen
+{
+private:
+  float passed_time;
+  int index;
+  CL_Sprite sprite;
+  CL_Point pos;
+
+  float fadeout_value;
+  enum { FADEIN, RUNNING, FADEOUT } state;
+
+  typedef std::vector&lt;std::string&gt; Names;
+  Names lst;
+public:
+  WindstilleBonus();
+  ~WindstilleBonus();
+  
+  void draw();
+  void update(float delta);
+
+  void quit();
+
+  void on_startup();
+  void on_shutdown();
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/windstille_bonus.hxx
===================================================================
--- trunk/src/windstille_bonus.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_bonus.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,56 +0,0 @@
-//  $Id: windstille_bonus.hxx,v 1.2 2003/11/06 10:32:22 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_WINDSTILLE_BONUS_HXX
-#define HEADER_WINDSTILLE_BONUS_HXX
-
-#include &lt;vector&gt;
-#include &lt;ClanLib/Display/sprite.h&gt;
-#include &quot;screen.hxx&quot;
-
-/** */
-class WindstilleBonus : public Windstille::Screen
-{
-private:
-  float passed_time;
-  int index;
-  CL_Sprite sprite;
-  CL_Point pos;
-
-  float fadeout_value;
-  enum { FADEIN, RUNNING, FADEOUT } state;
-
-  typedef std::vector&lt;std::string&gt; Names;
-  Names lst;
-public:
-  WindstilleBonus();
-  ~WindstilleBonus();
-  
-  void draw();
-  void update(float delta);
-
-  void quit();
-
-  void on_startup();
-  void on_shutdown();
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/windstille_error.cpp (from rev 502, trunk/src/windstille_error.cxx)
===================================================================
--- trunk/src/windstille_error.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_error.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,43 @@
+//  $Id: windstille_error.cxx,v 1.1 2003/11/05 22:51:27 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 1999 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &quot;windstille_error.hpp&quot;
+
+WindstilleError::WindstilleError (const std::string&amp; mes) 
+  : message(&quot;WindstilleError: &quot; + mes)
+{
+}
+
+WindstilleError::~WindstilleError() throw()
+{
+}
+
+const std::string&amp;
+WindstilleError::get_message () const
+{
+  return message;
+}
+
+const char* 
+WindstilleError::what() const throw()
+{
+  return message.c_str(); 
+}
+
+/* EOF */

Deleted: trunk/src/windstille_error.cxx
===================================================================
--- trunk/src/windstille_error.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_error.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,43 +0,0 @@
-//  $Id: windstille_error.cxx,v 1.1 2003/11/05 22:51:27 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 1999 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &quot;windstille_error.hxx&quot;
-
-WindstilleError::WindstilleError (const std::string&amp; mes) 
-  : message(&quot;WindstilleError: &quot; + mes)
-{
-}
-
-WindstilleError::~WindstilleError() throw()
-{
-}
-
-const std::string&amp;
-WindstilleError::get_message () const
-{
-  return message;
-}
-
-const char* 
-WindstilleError::what() const throw()
-{
-  return message.c_str(); 
-}
-
-/* EOF */

Copied: trunk/src/windstille_error.hpp (from rev 502, trunk/src/windstille_error.hxx)
===================================================================
--- trunk/src/windstille_error.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_error.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,42 @@
+//  $Id: windstille_error.hpp,v 1.1 2003/11/05 22:51:27 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_WINDSTILLE_ERROR_HXX
+#define HEADER_WINDSTILLE_ERROR_HXX
+
+#include &lt;string&gt;
+#include &lt;exception&gt;
+
+/** A WindstilleError is thrown in situation where an error occured due to
+    invalid user input, file not found events or similar stuff. */
+class WindstilleError : public std::exception
+{
+protected:
+  std::string message;
+public:
+  WindstilleError(const std::string&amp; mes);
+  ~WindstilleError() throw();
+
+  const std::string&amp; get_message () const;
+  const char* what() const throw();
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/windstille_error.hxx
===================================================================
--- trunk/src/windstille_error.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_error.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,42 +0,0 @@
-//  $Id: windstille_error.hxx,v 1.1 2003/11/05 22:51:27 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_WINDSTILLE_ERROR_HXX
-#define HEADER_WINDSTILLE_ERROR_HXX
-
-#include &lt;string&gt;
-#include &lt;exception&gt;
-
-/** A WindstilleError is thrown in situation where an error occured due to
-    invalid user input, file not found events or similar stuff. */
-class WindstilleError : public std::exception
-{
-protected:
-  std::string message;
-public:
-  WindstilleError(const std::string&amp; mes);
-  ~WindstilleError() throw();
-
-  const std::string&amp; get_message () const;
-  const char* what() const throw();
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/windstille_main.cpp (from rev 502, trunk/src/windstille_main.cxx)
===================================================================
--- trunk/src/windstille_main.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_main.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,429 @@
+//  $Id: windstille_main.cxx,v 1.30 2003/11/13 12:59:42 grumbel Exp $
+//
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;ClanLib/core.h&gt;
+#include &lt;ClanLib/vorbis.h&gt;
+#include &lt;ClanLib/display.h&gt;
+#include &lt;physfs.h&gt;
+
+#include &quot;windstille_error.hpp&quot;
+#include &quot;globals.hpp&quot;
+#include &quot;game_session.hpp&quot;
+#include &quot;windstille_main.hpp&quot;
+#include &quot;windstille_menu.hpp&quot;
+#include &quot;fonts.hpp&quot;
+#include &quot;sector.hpp&quot;
+#include &quot;input/input_manager.hpp&quot;
+#include &quot;sound/sound_manager.hpp&quot;
+#include &quot;tile_factory.hpp&quot;
+#include &quot;script_manager.hpp&quot;
+#include &quot;tinygettext/gettext.hpp&quot;
+#include &quot;gameconfig.hpp&quot;
+
+WindstilleMain main_app;
+CL_ResourceManager* resources;
+
+WindstilleMain::WindstilleMain()
+{
+  game_definition_file = &quot;windstille.rb&quot;;
+}
+
+WindstilleMain::~WindstilleMain()
+{
+}
+
+void
+WindstilleMain::parse_command_line(int argc, char** argv)
+{
+  CL_CommandLine argp;
+
+  const int debug_flag = 256;
+  const int game_flag = 257;
+    
+  argp.set_help_indent(22);
+  argp.add_usage (&quot;[LEVELFILE]&quot;);
+  argp.add_doc   (&quot;Windstille is a classic Jump'n Run game.&quot;);
+
+  argp.add_group(&quot;Display Options:&quot;);
+  argp.add_option('g', &quot;geometry&quot;,   &quot;WxH&quot;, &quot;Change window size to WIDTH and HEIGHT&quot;);
+  argp.add_option('f', &quot;fullscreen&quot;, &quot;&quot;, &quot;Launch the game in fullscreen&quot;);
+
+  argp.add_group(&quot;Sound Options:&quot;);
+  argp.add_option('s', &quot;disable-sound&quot;, &quot;&quot;, &quot;Disable sound&quot;);
+  argp.add_option('S', &quot;enable-sound&quot;, &quot;&quot;, &quot;Enable sound&quot;);
+
+  argp.add_group(&quot;Controlls Options:&quot;);
+  argp.add_option('c', &quot;controller&quot;, &quot;FILE&quot;, &quot;Use controller as defined in FILE&quot;);
+
+  argp.add_group(&quot;Misc Options:&quot;);
+  argp.add_option(game_flag, &quot;game&quot;, &quot;GAME&quot;, &quot;Load the game definition file at startup&quot;);
+  argp.add_option('d', &quot;datadir&quot;,    &quot;DIR&quot;, &quot;Fetch game data from DIR&quot;);
+  argp.add_option(debug_flag, &quot;debug&quot;,      &quot;&quot;, &quot;Turn on debug output&quot;);
+  argp.add_option('h', &quot;help&quot;,       &quot;&quot;, &quot;Print this help&quot;);
+
+  argp.add_group(&quot;Demo Recording/Playback Options:&quot;);
+  argp.add_option('r', &quot;record&quot;,      &quot;FILE&quot;, &quot;Record input events to FILE&quot;);
+  argp.add_option('a', &quot;record-video&quot;,&quot;DIR&quot;,  &quot;Record a gameplay video to DIR&quot;);
+  argp.add_option('p', &quot;play&quot;,        &quot;FILE&quot;, &quot;Playback input events from FILE&quot;);
+
+  argp.parse_args(argc, argv);
+
+  while (argp.next())
+    {
+      switch (argp.get_key())
+        {
+        case 'r':
+          recorder_file = argp.get_argument();
+          break;
+
+        case 'a':
+          screenshot_dir = argp.get_argument();
+          break;
+
+        case 'p':
+          playback_file = argp.get_argument();
+          break;
+
+        case 'd':
+          datadir = argp.get_argument();
+          break;
+
+        case game_flag:
+          game_definition_file = argp.get_argument();
+          break;
+
+        case debug_flag:
+          debug = 1;
+          break;
+
+        case 'f':
+          config-&gt;use_fullscreen = true;
+          break;
+
+        case 'g':
+          if (sscanf(argp.get_argument().c_str(), &quot;%dx%d&quot;,
+                     &amp;config-&gt;screen_width, &amp;config-&gt;screen_height) == 2)
+            std::cout &lt;&lt; &quot;Geometry: &quot; &lt;&lt; config-&gt;screen_width
+                      &lt;&lt; &quot;x&quot; &lt;&lt; config-&gt;screen_height &lt;&lt; std::endl;
+          else
+            throw CL_Error(&quot;Geometry option '-g' requires argument of type {WIDTH}x{HEIGHT}&quot;);
+          break;
+        
+        case 's':
+          sound_disabled = true;
+          break;
+
+        case 'S':
+          sound_disabled = false;
+          break;  
+
+        case 'c':
+          controller_file = argp.get_argument();
+          break;
+
+        case 'h':
+          argp.print_help();
+          exit(EXIT_SUCCESS);
+          break;
+
+        case CL_CommandLine::REST_ARG:
+          levelfile = argp.get_argument();
+          break;
+        }
+    }
+}
+
+std::string dirname(const std::string&amp; filename)
+{
+  std::string::size_type p = filename.find_last_of('/');
+  if(p == std::string::npos)
+    return &quot;&quot;;
+
+  return filename.substr(0, p+1);        
+}
+
+std::string basename(const std::string&amp; filename)
+{
+  std::string::size_type p = filename.find_last_of('/');
+  if(p == std::string::npos)
+    return filename;
+
+  return filename.substr(p, filename.size()-p);
+}
+
+int 
+WindstilleMain::main(int argc, char** argv)
+{
+#ifdef WIN32
+  CL_ConsoleWindow console(&quot;Console Output&quot;);
+  console.redirect_stdio(&quot;windstille.log&quot;);
+#endif
+
+  try {
+    init_physfs(argv[0]);
+    
+    dictionaryManager = new TinyGetText::DictionaryManager();
+    dictionaryManager-&gt;set_charset(&quot;iso8859-1&quot;);
+    dictionaryManager-&gt;add_directory(&quot;locale&quot;);                    
+
+    config = new Config();
+    config-&gt;load();
+  } catch(std::exception&amp; e) {
+    std::cout &lt;&lt; &quot;std::exception: &quot; &lt;&lt; e.what() &lt;&lt; std::endl;
+    return 1;
+  }
+
+  // Init the path
+  bindir  = CL_System::get_exe_path();
+
+  if (datadir.empty())
+    datadir = bindir + &quot;data/&quot;;
+
+#ifndef WIN32
+  char* home_c = getenv(&quot;HOME&quot;);
+  if (home_c) 
+    {
+      std::string home = home_c; 
+      home += &quot;/.windstille&quot;;
+      if (CL_Directory::create(home))
+        std::cout &lt;&lt; &quot;Created &quot; &lt;&lt; home &lt;&lt; std::endl;
+      homedir = home + &quot;/&quot;;
+    }
+  else
+    {
+      throw WindstilleError(&quot;Couldn't find environment variable HOME&quot;);
+    }
+#else
+  homedir = &quot;config/&quot;;
+#endif
+
+  try {
+    parse_command_line(argc, argv);
+    init_modules();
+
+    if (playback_file.empty())
+      {
+        if (!controller_file.empty())
+          InputManager::init(controller_file);
+        else
+          InputManager::init(&quot;controller/keyboard.scm&quot;);
+      }
+    else
+      {
+        InputManager::init_playback(playback_file);
+      }
+
+    if (!recorder_file.empty())
+      InputManager::setup_recorder(recorder_file);
+
+    TileFactory::init();
+    if (levelfile.empty())
+      {
+        if (debug) std::cout &lt;&lt; &quot;Starting Menu&quot; &lt;&lt; std::endl;
+        WindstilleMenu menu;
+        menu.display();
+      }
+    else 
+      {
+        std::string leveldir = dirname(levelfile);
+        PHYSFS_addToSearchPath(leveldir.c_str(), true);
+        GameSession game (basename(levelfile));
+        game.display ();
+      }
+    TileFactory::deinit();
+    InputManager::deinit();
+
+    deinit_modules();
+
+  } catch (CL_Error&amp; error) {
+    std::cout &lt;&lt; &quot;CL_Error: &quot; &lt;&lt; error.message &lt;&lt; std::endl;
+  } catch (WindstilleError&amp; err) {
+    std::cout &lt;&lt; &quot;WindstilleError: &quot; &lt;&lt; err.what() &lt;&lt; std::endl;
+  } catch (std::exception&amp; err) {
+    std::cout &lt;&lt; &quot;std::exception: &quot; &lt;&lt; err.what() &lt;&lt; std::endl;
+  } catch (...) {
+    std::cout &lt;&lt; &quot;Error catched something unknown?!&quot; &lt;&lt; std::endl;
+  }
+
+  config-&gt;save();
+  delete config;
+  config = 0;
+
+  delete dictionaryManager;
+  dictionaryManager = 0;
+  
+  PHYSFS_deinit();
+
+  return 0;
+}
+
+void
+WindstilleMain::init_modules()
+{
+  // Init ClanLib
+  CL_SetupCore::init();
+  
+  CL_SetupGL::init();
+
+  CL_SetupDisplay::init();
+
+  window = new CL_DisplayWindow(&quot;Windstille&quot;,
+                                config-&gt;screen_width, config-&gt;screen_height,
+                                config-&gt;use_fullscreen, false);
+  CL_Display::clear();
+  CL_Display::flip(0);
+
+  resources =  new CL_ResourceManager();
+  resources-&gt;add_resources(CL_ResourceManager(datadir + &quot;windstille.xml&quot;, false));
+  resources-&gt;add_resources(CL_ResourceManager(datadir + &quot;tiles.xml&quot;, false));
+
+  Fonts::init(); 
+  sound_manager = new SoundManager();
+  sound_manager-&gt;enable_sound(config-&gt;sound_enabled);
+  sound_manager-&gt;enable_music(config-&gt;music_enabled);
+
+  script_manager = new ScriptManager();
+}
+
+void
+WindstilleMain::deinit_modules()
+{
+  delete script_manager;
+  script_manager = 0;
+  
+  delete sound_manager;
+  sound_manager = 0;
+  Fonts::deinit();
+
+  delete window;
+
+  CL_SetupDisplay::init();
+
+  CL_SetupGL::init();
+
+  CL_SetupCore::init(); 
+}
+
+void
+WindstilleMain::init_physfs(const char* argv0)
+{
+  if(!PHYSFS_init(argv0)) {
+    std::stringstream msg;
+    msg &lt;&lt; &quot;Couldn't initialize physfs: &quot; &lt;&lt; PHYSFS_getLastError();
+    throw std::runtime_error(msg.str());
+  }
+
+  // Initialize physfs (this is a slightly modified version of
+  // PHYSFS_setSaneConfig
+  const char* application = PACKAGE_NAME;
+  const char* userdir = PHYSFS_getUserDir();
+  const char* dirsep = PHYSFS_getDirSeparator();
+  char* writedir = new char[strlen(userdir) + strlen(application) + 2];
+
+  // Set configuration directory
+  sprintf(writedir, &quot;%s.%s&quot;, userdir, application);
+  if(!PHYSFS_setWriteDir(writedir)) {
+    // try to create the directory
+    char* mkdir = new char[strlen(application) + 2];
+    sprintf(mkdir, &quot;.%s&quot;, application);
+    if(!PHYSFS_setWriteDir(userdir) || !PHYSFS_mkdir(mkdir)) {
+      std::ostringstream msg;
+      msg &lt;&lt; &quot;Failed creating configuration directory '&quot;
+          &lt;&lt; writedir &lt;&lt; &quot;': &quot; &lt;&lt; PHYSFS_getLastError();
+      delete[] writedir;
+      delete[] mkdir;
+      throw std::runtime_error(msg.str());
+    }
+    delete[] mkdir;
+
+    if(!PHYSFS_setWriteDir(writedir)) {
+      std::ostringstream msg;
+      msg &lt;&lt; &quot;Failed to use configuration directory '&quot;
+          &lt;&lt;  writedir &lt;&lt; &quot;': &quot; &lt;&lt; PHYSFS_getLastError();
+      delete[] writedir;
+      throw std::runtime_error(msg.str());
+    }
+  }
+  PHYSFS_addToSearchPath(writedir, 0);
+  delete[] writedir;
+
+  // Search for archives and add them to the search path
+  const char* archiveExt = &quot;zip&quot;;
+  char** rc = PHYSFS_enumerateFiles(&quot;/&quot;);
+  size_t extlen = strlen(archiveExt);
+
+  for(char** i = rc; *i != 0; ++i) {
+    size_t l = strlen(*i);
+    if((l &gt; extlen) &amp;&amp; ((*i)[l - extlen - 1] == '.')) {
+      const char* ext = (*i) + (l - extlen);
+      if(strcasecmp(ext, archiveExt) == 0) {
+        const char* d = PHYSFS_getRealDir(*i);
+        char* str = new char[strlen(d) + strlen(dirsep) + l + 1];
+        sprintf(str, &quot;%s%s%s&quot;, d, dirsep, *i);
+        PHYSFS_addToSearchPath(str, 1);
+        delete[] str;
+      }
+    }
+  }
+
+  PHYSFS_freeList(rc);
+
+  // when started from source dir...
+  std::string dir = PHYSFS_getBaseDir();
+  dir += &quot;data&quot;;
+  std::string testfname = dir;
+  testfname += &quot;/tiles.scm&quot;;
+  bool sourcedir = false;
+  FILE* f = fopen(testfname.c_str(), &quot;r&quot;);
+  if(f) {
+    fclose(f);
+    if(!PHYSFS_addToSearchPath(dir.c_str(), 1)) {
+      std::cout &lt;&lt; &quot;Warning: Couldn't add '&quot; &lt;&lt; dir
+                &lt;&lt; &quot;' to physfs searchpath: &quot; &lt;&lt; PHYSFS_getLastError() &lt;&lt; &quot;\n&quot;;
+    } else {
+      sourcedir = true;
+    }
+  }
+
+  if(!sourcedir) {
+#if defined(APPDATADIR) || defined(ENABLE_BINRELOC)
+    std::string datadir;
+#ifdef ENABLE_BINRELOC
+    char* brdatadir = br_strcat(DATADIR, &quot;/&quot; PACKAGE_NAME);
+    datadir = brdatadir;
+    free(brdatadir);
+#else
+    datadir = APPDATADIR;
+#endif
+    if(!PHYSFS_addToSearchPath(datadir.c_str(), 1)) {
+      std::cout &lt;&lt; &quot;Couldn't add '&quot; &lt;&lt; datadir
+        &lt;&lt; &quot;' to physfs searchpath: &quot; &lt;&lt; PHYSFS_getLastError() &lt;&lt; &quot;\n&quot;;
+    }
+#endif
+  }
+
+  // allow symbolic links
+  PHYSFS_permitSymbolicLinks(1);
+
+  //show search Path
+  for(char** i = PHYSFS_getSearchPath(); *i != NULL; i++)
+    printf(&quot;[%s] is in the search path.\n&quot;, *i);
+}
+
+/* EOF */

Deleted: trunk/src/windstille_main.cxx
===================================================================
--- trunk/src/windstille_main.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_main.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,429 +0,0 @@
-//  $Id: windstille_main.cxx,v 1.30 2003/11/13 12:59:42 grumbel Exp $
-//
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;ClanLib/core.h&gt;
-#include &lt;ClanLib/vorbis.h&gt;
-#include &lt;ClanLib/display.h&gt;
-#include &lt;physfs.h&gt;
-
-#include &quot;windstille_error.hxx&quot;
-#include &quot;globals.hxx&quot;
-#include &quot;game_session.hxx&quot;
-#include &quot;windstille_main.hxx&quot;
-#include &quot;windstille_menu.hxx&quot;
-#include &quot;fonts.hxx&quot;
-#include &quot;sector.hxx&quot;
-#include &quot;input/input_manager.hxx&quot;
-#include &quot;sound/sound_manager.hpp&quot;
-#include &quot;tile_factory.hxx&quot;
-#include &quot;script_manager.hpp&quot;
-#include &quot;tinygettext/gettext.hpp&quot;
-#include &quot;gameconfig.hpp&quot;
-
-WindstilleMain main_app;
-CL_ResourceManager* resources;
-
-WindstilleMain::WindstilleMain()
-{
-  game_definition_file = &quot;windstille.rb&quot;;
-}
-
-WindstilleMain::~WindstilleMain()
-{
-}
-
-void
-WindstilleMain::parse_command_line(int argc, char** argv)
-{
-  CL_CommandLine argp;
-
-  const int debug_flag = 256;
-  const int game_flag = 257;
-    
-  argp.set_help_indent(22);
-  argp.add_usage (&quot;[LEVELFILE]&quot;);
-  argp.add_doc   (&quot;Windstille is a classic Jump'n Run game.&quot;);
-
-  argp.add_group(&quot;Display Options:&quot;);
-  argp.add_option('g', &quot;geometry&quot;,   &quot;WxH&quot;, &quot;Change window size to WIDTH and HEIGHT&quot;);
-  argp.add_option('f', &quot;fullscreen&quot;, &quot;&quot;, &quot;Launch the game in fullscreen&quot;);
-
-  argp.add_group(&quot;Sound Options:&quot;);
-  argp.add_option('s', &quot;disable-sound&quot;, &quot;&quot;, &quot;Disable sound&quot;);
-  argp.add_option('S', &quot;enable-sound&quot;, &quot;&quot;, &quot;Enable sound&quot;);
-
-  argp.add_group(&quot;Controlls Options:&quot;);
-  argp.add_option('c', &quot;controller&quot;, &quot;FILE&quot;, &quot;Use controller as defined in FILE&quot;);
-
-  argp.add_group(&quot;Misc Options:&quot;);
-  argp.add_option(game_flag, &quot;game&quot;, &quot;GAME&quot;, &quot;Load the game definition file at startup&quot;);
-  argp.add_option('d', &quot;datadir&quot;,    &quot;DIR&quot;, &quot;Fetch game data from DIR&quot;);
-  argp.add_option(debug_flag, &quot;debug&quot;,      &quot;&quot;, &quot;Turn on debug output&quot;);
-  argp.add_option('h', &quot;help&quot;,       &quot;&quot;, &quot;Print this help&quot;);
-
-  argp.add_group(&quot;Demo Recording/Playback Options:&quot;);
-  argp.add_option('r', &quot;record&quot;,      &quot;FILE&quot;, &quot;Record input events to FILE&quot;);
-  argp.add_option('a', &quot;record-video&quot;,&quot;DIR&quot;,  &quot;Record a gameplay video to DIR&quot;);
-  argp.add_option('p', &quot;play&quot;,        &quot;FILE&quot;, &quot;Playback input events from FILE&quot;);
-
-  argp.parse_args(argc, argv);
-
-  while (argp.next())
-    {
-      switch (argp.get_key())
-        {
-        case 'r':
-          recorder_file = argp.get_argument();
-          break;
-
-        case 'a':
-          screenshot_dir = argp.get_argument();
-          break;
-
-        case 'p':
-          playback_file = argp.get_argument();
-          break;
-
-        case 'd':
-          datadir = argp.get_argument();
-          break;
-
-        case game_flag:
-          game_definition_file = argp.get_argument();
-          break;
-
-        case debug_flag:
-          debug = 1;
-          break;
-
-        case 'f':
-          config-&gt;use_fullscreen = true;
-          break;
-
-        case 'g':
-          if (sscanf(argp.get_argument().c_str(), &quot;%dx%d&quot;,
-                     &amp;config-&gt;screen_width, &amp;config-&gt;screen_height) == 2)
-            std::cout &lt;&lt; &quot;Geometry: &quot; &lt;&lt; config-&gt;screen_width
-                      &lt;&lt; &quot;x&quot; &lt;&lt; config-&gt;screen_height &lt;&lt; std::endl;
-          else
-            throw CL_Error(&quot;Geometry option '-g' requires argument of type {WIDTH}x{HEIGHT}&quot;);
-          break;
-        
-        case 's':
-          sound_disabled = true;
-          break;
-
-        case 'S':
-          sound_disabled = false;
-          break;  
-
-        case 'c':
-          controller_file = argp.get_argument();
-          break;
-
-        case 'h':
-          argp.print_help();
-          exit(EXIT_SUCCESS);
-          break;
-
-        case CL_CommandLine::REST_ARG:
-          levelfile = argp.get_argument();
-          break;
-        }
-    }
-}
-
-std::string dirname(const std::string&amp; filename)
-{
-  std::string::size_type p = filename.find_last_of('/');
-  if(p == std::string::npos)
-    return &quot;&quot;;
-
-  return filename.substr(0, p+1);        
-}
-
-std::string basename(const std::string&amp; filename)
-{
-  std::string::size_type p = filename.find_last_of('/');
-  if(p == std::string::npos)
-    return filename;
-
-  return filename.substr(p, filename.size()-p);
-}
-
-int 
-WindstilleMain::main(int argc, char** argv)
-{
-#ifdef WIN32
-  CL_ConsoleWindow console(&quot;Console Output&quot;);
-  console.redirect_stdio(&quot;windstille.log&quot;);
-#endif
-
-  try {
-    init_physfs(argv[0]);
-    
-    dictionaryManager = new TinyGetText::DictionaryManager();
-    dictionaryManager-&gt;set_charset(&quot;iso8859-1&quot;);
-    dictionaryManager-&gt;add_directory(&quot;locale&quot;);                    
-
-    config = new Config();
-    config-&gt;load();
-  } catch(std::exception&amp; e) {
-    std::cout &lt;&lt; &quot;std::exception: &quot; &lt;&lt; e.what() &lt;&lt; std::endl;
-    return 1;
-  }
-
-  // Init the path
-  bindir  = CL_System::get_exe_path();
-
-  if (datadir.empty())
-    datadir = bindir + &quot;data/&quot;;
-
-#ifndef WIN32
-  char* home_c = getenv(&quot;HOME&quot;);
-  if (home_c) 
-    {
-      std::string home = home_c; 
-      home += &quot;/.windstille&quot;;
-      if (CL_Directory::create(home))
-        std::cout &lt;&lt; &quot;Created &quot; &lt;&lt; home &lt;&lt; std::endl;
-      homedir = home + &quot;/&quot;;
-    }
-  else
-    {
-      throw WindstilleError(&quot;Couldn't find environment variable HOME&quot;);
-    }
-#else
-  homedir = &quot;config/&quot;;
-#endif
-
-  try {
-    parse_command_line(argc, argv);
-    init_modules();
-
-    if (playback_file.empty())
-      {
-        if (!controller_file.empty())
-          InputManager::init(controller_file);
-        else
-          InputManager::init(&quot;controller/keyboard.scm&quot;);
-      }
-    else
-      {
-        InputManager::init_playback(playback_file);
-      }
-
-    if (!recorder_file.empty())
-      InputManager::setup_recorder(recorder_file);
-
-    TileFactory::init();
-    if (levelfile.empty())
-      {
-        if (debug) std::cout &lt;&lt; &quot;Starting Menu&quot; &lt;&lt; std::endl;
-        WindstilleMenu menu;
-        menu.display();
-      }
-    else 
-      {
-        std::string leveldir = dirname(levelfile);
-        PHYSFS_addToSearchPath(leveldir.c_str(), true);
-        GameSession game (basename(levelfile));
-        game.display ();
-      }
-    TileFactory::deinit();
-    InputManager::deinit();
-
-    deinit_modules();
-
-  } catch (CL_Error&amp; error) {
-    std::cout &lt;&lt; &quot;CL_Error: &quot; &lt;&lt; error.message &lt;&lt; std::endl;
-  } catch (WindstilleError&amp; err) {
-    std::cout &lt;&lt; &quot;WindstilleError: &quot; &lt;&lt; err.what() &lt;&lt; std::endl;
-  } catch (std::exception&amp; err) {
-    std::cout &lt;&lt; &quot;std::exception: &quot; &lt;&lt; err.what() &lt;&lt; std::endl;
-  } catch (...) {
-    std::cout &lt;&lt; &quot;Error catched something unknown?!&quot; &lt;&lt; std::endl;
-  }
-
-  config-&gt;save();
-  delete config;
-  config = 0;
-
-  delete dictionaryManager;
-  dictionaryManager = 0;
-  
-  PHYSFS_deinit();
-
-  return 0;
-}
-
-void
-WindstilleMain::init_modules()
-{
-  // Init ClanLib
-  CL_SetupCore::init();
-  
-  CL_SetupGL::init();
-
-  CL_SetupDisplay::init();
-
-  window = new CL_DisplayWindow(&quot;Windstille&quot;,
-                                config-&gt;screen_width, config-&gt;screen_height,
-                                config-&gt;use_fullscreen, false);
-  CL_Display::clear();
-  CL_Display::flip(0);
-
-  resources =  new CL_ResourceManager();
-  resources-&gt;add_resources(CL_ResourceManager(datadir + &quot;windstille.xml&quot;, false));
-  resources-&gt;add_resources(CL_ResourceManager(datadir + &quot;tiles.xml&quot;, false));
-
-  Fonts::init(); 
-  sound_manager = new SoundManager();
-  sound_manager-&gt;enable_sound(config-&gt;sound_enabled);
-  sound_manager-&gt;enable_music(config-&gt;music_enabled);
-
-  script_manager = new ScriptManager();
-}
-
-void
-WindstilleMain::deinit_modules()
-{
-  delete script_manager;
-  script_manager = 0;
-  
-  delete sound_manager;
-  sound_manager = 0;
-  Fonts::deinit();
-
-  delete window;
-
-  CL_SetupDisplay::init();
-
-  CL_SetupGL::init();
-
-  CL_SetupCore::init(); 
-}
-
-void
-WindstilleMain::init_physfs(const char* argv0)
-{
-  if(!PHYSFS_init(argv0)) {
-    std::stringstream msg;
-    msg &lt;&lt; &quot;Couldn't initialize physfs: &quot; &lt;&lt; PHYSFS_getLastError();
-    throw std::runtime_error(msg.str());
-  }
-
-  // Initialize physfs (this is a slightly modified version of
-  // PHYSFS_setSaneConfig
-  const char* application = PACKAGE_NAME;
-  const char* userdir = PHYSFS_getUserDir();
-  const char* dirsep = PHYSFS_getDirSeparator();
-  char* writedir = new char[strlen(userdir) + strlen(application) + 2];
-
-  // Set configuration directory
-  sprintf(writedir, &quot;%s.%s&quot;, userdir, application);
-  if(!PHYSFS_setWriteDir(writedir)) {
-    // try to create the directory
-    char* mkdir = new char[strlen(application) + 2];
-    sprintf(mkdir, &quot;.%s&quot;, application);
-    if(!PHYSFS_setWriteDir(userdir) || !PHYSFS_mkdir(mkdir)) {
-      std::ostringstream msg;
-      msg &lt;&lt; &quot;Failed creating configuration directory '&quot;
-          &lt;&lt; writedir &lt;&lt; &quot;': &quot; &lt;&lt; PHYSFS_getLastError();
-      delete[] writedir;
-      delete[] mkdir;
-      throw std::runtime_error(msg.str());
-    }
-    delete[] mkdir;
-
-    if(!PHYSFS_setWriteDir(writedir)) {
-      std::ostringstream msg;
-      msg &lt;&lt; &quot;Failed to use configuration directory '&quot;
-          &lt;&lt;  writedir &lt;&lt; &quot;': &quot; &lt;&lt; PHYSFS_getLastError();
-      delete[] writedir;
-      throw std::runtime_error(msg.str());
-    }
-  }
-  PHYSFS_addToSearchPath(writedir, 0);
-  delete[] writedir;
-
-  // Search for archives and add them to the search path
-  const char* archiveExt = &quot;zip&quot;;
-  char** rc = PHYSFS_enumerateFiles(&quot;/&quot;);
-  size_t extlen = strlen(archiveExt);
-
-  for(char** i = rc; *i != 0; ++i) {
-    size_t l = strlen(*i);
-    if((l &gt; extlen) &amp;&amp; ((*i)[l - extlen - 1] == '.')) {
-      const char* ext = (*i) + (l - extlen);
-      if(strcasecmp(ext, archiveExt) == 0) {
-        const char* d = PHYSFS_getRealDir(*i);
-        char* str = new char[strlen(d) + strlen(dirsep) + l + 1];
-        sprintf(str, &quot;%s%s%s&quot;, d, dirsep, *i);
-        PHYSFS_addToSearchPath(str, 1);
-        delete[] str;
-      }
-    }
-  }
-
-  PHYSFS_freeList(rc);
-
-  // when started from source dir...
-  std::string dir = PHYSFS_getBaseDir();
-  dir += &quot;data&quot;;
-  std::string testfname = dir;
-  testfname += &quot;/tiles.scm&quot;;
-  bool sourcedir = false;
-  FILE* f = fopen(testfname.c_str(), &quot;r&quot;);
-  if(f) {
-    fclose(f);
-    if(!PHYSFS_addToSearchPath(dir.c_str(), 1)) {
-      std::cout &lt;&lt; &quot;Warning: Couldn't add '&quot; &lt;&lt; dir
-                &lt;&lt; &quot;' to physfs searchpath: &quot; &lt;&lt; PHYSFS_getLastError() &lt;&lt; &quot;\n&quot;;
-    } else {
-      sourcedir = true;
-    }
-  }
-
-  if(!sourcedir) {
-#if defined(APPDATADIR) || defined(ENABLE_BINRELOC)
-    std::string datadir;
-#ifdef ENABLE_BINRELOC
-    char* brdatadir = br_strcat(DATADIR, &quot;/&quot; PACKAGE_NAME);
-    datadir = brdatadir;
-    free(brdatadir);
-#else
-    datadir = APPDATADIR;
-#endif
-    if(!PHYSFS_addToSearchPath(datadir.c_str(), 1)) {
-      std::cout &lt;&lt; &quot;Couldn't add '&quot; &lt;&lt; datadir
-        &lt;&lt; &quot;' to physfs searchpath: &quot; &lt;&lt; PHYSFS_getLastError() &lt;&lt; &quot;\n&quot;;
-    }
-#endif
-  }
-
-  // allow symbolic links
-  PHYSFS_permitSymbolicLinks(1);
-
-  //show search Path
-  for(char** i = PHYSFS_getSearchPath(); *i != NULL; i++)
-    printf(&quot;[%s] is in the search path.\n&quot;, *i);
-}
-
-/* EOF */

Copied: trunk/src/windstille_main.hpp (from rev 502, trunk/src/windstille_main.hxx)
===================================================================
--- trunk/src/windstille_main.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_main.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,55 @@
+//  $Id: windstille_main.hpp,v 1.4 2003/11/07 13:00:39 grumbel Exp $
+// 
+//  Windstille - A Jump'n Shoot Game
+//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef WINDSTILLEMAIN_HXX
+#define WINDSTILLEMAIN_HXX
+
+#include &lt;ClanLib/gl.h&gt;
+#include &lt;ClanLib/application.h&gt;
+
+class WindstilleMain : public CL_ClanApplication
+{
+public:
+  std::string levelfile;
+  std::string game_definition_file;
+  std::string controller_file;
+  std::string recorder_file;
+  std::string playback_file;
+  std::string screenshot_dir;
+  
+  CL_DisplayWindow* window;
+public:
+  WindstilleMain();
+  ~WindstilleMain();
+
+  virtual char* get_title() { return &quot;Windstille&quot;; }
+  virtual int main(int argc, char** argv);
+
+private:
+  void init_physfs(const char* argv0);
+  void parse_command_line(int argc, char** argv);
+  void init_modules();
+  void deinit_modules();
+};
+
+extern WindstilleMain main_app;
+
+#endif
+
+/* EOF */

Deleted: trunk/src/windstille_main.hxx
===================================================================
--- trunk/src/windstille_main.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_main.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,55 +0,0 @@
-//  $Id: windstille_main.hxx,v 1.4 2003/11/07 13:00:39 grumbel Exp $
-// 
-//  Windstille - A Jump'n Shoot Game
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef WINDSTILLEMAIN_HXX
-#define WINDSTILLEMAIN_HXX
-
-#include &lt;ClanLib/gl.h&gt;
-#include &lt;ClanLib/application.h&gt;
-
-class WindstilleMain : public CL_ClanApplication
-{
-public:
-  std::string levelfile;
-  std::string game_definition_file;
-  std::string controller_file;
-  std::string recorder_file;
-  std::string playback_file;
-  std::string screenshot_dir;
-  
-  CL_DisplayWindow* window;
-public:
-  WindstilleMain();
-  ~WindstilleMain();
-
-  virtual char* get_title() { return &quot;Windstille&quot;; }
-  virtual int main(int argc, char** argv);
-
-private:
-  void init_physfs(const char* argv0);
-  void parse_command_line(int argc, char** argv);
-  void init_modules();
-  void deinit_modules();
-};
-
-extern WindstilleMain main_app;
-
-#endif
-
-/* EOF */

Copied: trunk/src/windstille_menu.cpp (from rev 502, trunk/src/windstille_menu.cxx)
===================================================================
--- trunk/src/windstille_menu.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_menu.cpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,246 @@
+//  $Id: windstille_menu.cxx,v 1.11 2003/11/13 12:59:42 grumbel Exp $
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include &lt;iostream&gt;
+#include &lt;ClanLib/Display/display.h&gt;
+#include &lt;ClanLib/Display/display_window.h&gt;
+#include &lt;ClanLib/Display/keys.h&gt;
+#include &lt;ClanLib/Core/System/system.h&gt;
+#include &lt;ClanLib/Display/keyboard.h&gt;
+#include &quot;globals.hpp&quot;
+#include &quot;fonts.hpp&quot;
+#include &quot;input/controller.hpp&quot;
+#include &quot;windstille_menu.hpp&quot;
+#include &quot;game_session.hpp&quot;
+#include &quot;sound/sound_manager.hpp&quot;
+#include &quot;windstille_bonus.hpp&quot;
+#include &quot;input/input_manager.hpp&quot;
+#include &quot;tinygettext/gettext.hpp&quot;
+
+WindstilleMenu::WindstilleMenu()
+  : background(&quot;menu_background&quot;, resources),
+    windstille(&quot;logo_large&quot;, resources)
+{
+  current_choice = 0;
+  windstille.set_alignment(origin_center);
+  passed_time = 0;
+}
+
+WindstilleMenu::~WindstilleMenu()
+{
+  
+}
+
+void
+WindstilleMenu::update(float delta)
+{
+  InputManager::update(delta);
+
+  passed_time += delta;
+
+  background.update(delta);
+  windstille.update(delta);
+
+  if (CL_Keyboard::get_keycode(CL_KEY_ESCAPE))
+    quit();
+
+  InputEventLst events = InputManager::get_controller().get_events();
+
+  for (InputEventLst::iterator i = events.begin();
+       i != events.end(); ++i)
+    {
+      if ((*i).type == BUTTON_EVENT)
+        {
+          if ((*i).button.name == FIRE_BUTTON &amp;&amp; (*i).button.down == true)
+            {
+              if ((current_choice == 1 &amp;&amp; !bonus_active)
+                  || (current_choice == 2 &amp;&amp; bonus_active))// QUIT
+                {
+                  sound_manager-&gt;stop_music();
+                  fadeout();
+                  quit();
+                  break;
+                }
+              else if (current_choice == 1 &amp;&amp; bonus_active)
+                {
+                  sound_manager-&gt;stop_music();
+                  fadeout();
+                  WindstilleBonus bonus;
+                  bonus.display();
+                  on_startup();
+                  break;
+                }
+              else if (current_choice == 0) // start game
+                {
+                  InputManager::clear();
+                  sound_manager-&gt;stop_music();
+                  fadeout();
+                  GameSession game(&quot;levels/newformat2.wst&quot;);
+                  game.display ();
+                  on_startup();
+                  break;
+                }
+              else if (current_choice == 1) // start editor
+                {
+                  /*
+                  InputManager::clear();
+                  fadeout();
+                  Editor editor;
+                  editor.run();
+                  on_startup();
+                  */
+                  break;
+                }
+            }
+          else if ((*i).button.name == UP_BUTTON &amp;&amp; (*i).button.down == true)
+            {
+              current_choice -= 1;
+              passed_time = 0;
+            }
+          else if ((*i).button.name == DOWN_BUTTON &amp;&amp; (*i).button.down == true)
+            {
+              current_choice += 1;
+              passed_time = 0;
+            }
+        }
+    }
+
+  while (CL_Keyboard::get_keycode(CL_KEY_ESCAPE))
+    CL_System::keep_alive();
+
+  if (current_choice &lt; 0)
+    {
+      if (bonus_active)
+        current_choice = 2;
+      else
+        current_choice = 1;
+    }
+  else if (current_choice &gt; 1 &amp;&amp; !bonus_active)
+    current_choice = 0;
+  else if (current_choice &gt; 2 &amp;&amp; bonus_active)
+    current_choice = 0;
+
+  InputManager::clear();
+}
+
+void
+WindstilleMenu::draw()
+{
+  //std::cout &lt;&lt; &quot;Draw... &quot; &lt;&lt; std::endl;
+  background.draw(0,0);
+
+  if (0) // ugly wooble
+    {
+      windstille.set_color(
+                           sin(passed_time*3.141f)*.2f + .8f,
+                           sin(passed_time*3.141f)*.2f + .8f,
+                           sin(passed_time*3.141f)*.2f + .8f
+                           );
+      windstille.set_scale(cos(passed_time*3.141f)*.05f + .95f,
+                           cos(passed_time*3.141f)*.05f + .95f);
+    }
+
+  windstille.draw(CL_Display::get_width()/2, 145);
+  
+  Fonts::menu.set_alignment(origin_bottom_center);
+  Fonts::menu_h.set_alignment(origin_bottom_center);
+
+  Fonts::menu_h.set_alpha(cos(passed_time*3.141f)*.4f + .6f);
+
+  if (current_choice == 0)
+    {
+      Fonts::menu.draw(580, 330, _(&quot;[Start Game]&quot;));
+      Fonts::menu_h.draw(580, 330, _(&quot;[Start Game]&quot;));
+    }
+  else
+    Fonts::menu.draw(580, 330, _(&quot;Start Game&quot;));
+
+  if (bonus_active)
+    {
+      if (current_choice == 1)
+        {
+          Fonts::menu.draw(580, 385, _(&quot;[Extras]&quot;));
+          Fonts::menu_h.draw(580, 385, _(&quot;[Extras]&quot;));
+        }
+      else
+        Fonts::menu.draw(580, 385, _(&quot;Extras&quot;));
+
+      if (current_choice == 2)
+        {
+          Fonts::menu.draw(580, 440, _(&quot;[Quit]&quot;));
+          Fonts::menu_h.draw(580, 440, _(&quot;[Quit]&quot;));
+        }
+      else
+        Fonts::menu.draw(580, 440, _(&quot;Quit&quot;));
+    }
+  else
+    {
+      if (current_choice == 1 || (bonus_active &amp;&amp; current_choice == 3))
+        {
+          Fonts::menu.draw(580, 440, _(&quot;[Quit]&quot;));
+          Fonts::menu_h.draw(580, 440, _(&quot;[Quit]&quot;));
+        }
+      else
+        Fonts::menu.draw(580, 440, &quot;Quit&quot;);
+    }
+
+  std::string copyright = &quot;Windstille &quot; PACKAGE_VERSION &quot;\n&quot;;
+  copyright += _(&quot;Copyright (c) 2003 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;\n&quot;
+                 &quot;This game comes with ABSOLUTELY NO WARRANTY. &quot;
+                 &quot;This is free software, and you are welcome\n&quot;
+                 &quot;to redistribute it under certain conditions; &quot;
+                 &quot;see the file COPYING for details.\n&quot;);
+
+  Fonts::copyright.set_alignment(origin_bottom_left);
+  Fonts::copyright.draw(15, CL_Display::get_height() - 10, copyright.c_str());
+}
+
+void
+WindstilleMenu::fadeout()
+{
+  int alpha = 0;
+  while (alpha &lt;= 255)
+    {
+      background.draw(0,0);
+
+      windstille.draw(CL_Display::get_width()/2,
+                      145);
+      CL_Display::fill_rect(CL_Rect(0, 0, 
+                                    CL_Display::get_width(), CL_Display::get_height()),
+                            CL_Color(0,0,0, std::min(alpha, 255)));
+      CL_Display::flip(0);
+      sound_manager-&gt;update();
+      CL_System::keep_alive();
+      CL_System::sleep(50);
+      alpha += 15;
+    }
+}
+
+void
+WindstilleMenu::on_startup()
+{
+  sound_manager-&gt;play_music(&quot;music/jingle.ogg&quot;);
+}
+
+void
+WindstilleMenu::on_shutdown()
+{
+}
+
+/* EOF */

Deleted: trunk/src/windstille_menu.cxx
===================================================================
--- trunk/src/windstille_menu.cxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_menu.cxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,246 +0,0 @@
-//  $Id: windstille_menu.cxx,v 1.11 2003/11/13 12:59:42 grumbel Exp $
-//
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#include &lt;iostream&gt;
-#include &lt;ClanLib/Display/display.h&gt;
-#include &lt;ClanLib/Display/display_window.h&gt;
-#include &lt;ClanLib/Display/keys.h&gt;
-#include &lt;ClanLib/Core/System/system.h&gt;
-#include &lt;ClanLib/Display/keyboard.h&gt;
-#include &quot;globals.hxx&quot;
-#include &quot;fonts.hxx&quot;
-#include &quot;input/controller.hxx&quot;
-#include &quot;windstille_menu.hxx&quot;
-#include &quot;game_session.hxx&quot;
-#include &quot;sound/sound_manager.hpp&quot;
-#include &quot;windstille_bonus.hxx&quot;
-#include &quot;input/input_manager.hxx&quot;
-#include &quot;tinygettext/gettext.hpp&quot;
-
-WindstilleMenu::WindstilleMenu()
-  : background(&quot;menu_background&quot;, resources),
-    windstille(&quot;logo_large&quot;, resources)
-{
-  current_choice = 0;
-  windstille.set_alignment(origin_center);
-  passed_time = 0;
-}
-
-WindstilleMenu::~WindstilleMenu()
-{
-  
-}
-
-void
-WindstilleMenu::update(float delta)
-{
-  InputManager::update(delta);
-
-  passed_time += delta;
-
-  background.update(delta);
-  windstille.update(delta);
-
-  if (CL_Keyboard::get_keycode(CL_KEY_ESCAPE))
-    quit();
-
-  InputEventLst events = InputManager::get_controller().get_events();
-
-  for (InputEventLst::iterator i = events.begin();
-       i != events.end(); ++i)
-    {
-      if ((*i).type == BUTTON_EVENT)
-        {
-          if ((*i).button.name == FIRE_BUTTON &amp;&amp; (*i).button.down == true)
-            {
-              if ((current_choice == 1 &amp;&amp; !bonus_active)
-                  || (current_choice == 2 &amp;&amp; bonus_active))// QUIT
-                {
-                  sound_manager-&gt;stop_music();
-                  fadeout();
-                  quit();
-                  break;
-                }
-              else if (current_choice == 1 &amp;&amp; bonus_active)
-                {
-                  sound_manager-&gt;stop_music();
-                  fadeout();
-                  WindstilleBonus bonus;
-                  bonus.display();
-                  on_startup();
-                  break;
-                }
-              else if (current_choice == 0) // start game
-                {
-                  InputManager::clear();
-                  sound_manager-&gt;stop_music();
-                  fadeout();
-                  GameSession game(&quot;levels/newformat2.wst&quot;);
-                  game.display ();
-                  on_startup();
-                  break;
-                }
-              else if (current_choice == 1) // start editor
-                {
-                  /*
-                  InputManager::clear();
-                  fadeout();
-                  Editor editor;
-                  editor.run();
-                  on_startup();
-                  */
-                  break;
-                }
-            }
-          else if ((*i).button.name == UP_BUTTON &amp;&amp; (*i).button.down == true)
-            {
-              current_choice -= 1;
-              passed_time = 0;
-            }
-          else if ((*i).button.name == DOWN_BUTTON &amp;&amp; (*i).button.down == true)
-            {
-              current_choice += 1;
-              passed_time = 0;
-            }
-        }
-    }
-
-  while (CL_Keyboard::get_keycode(CL_KEY_ESCAPE))
-    CL_System::keep_alive();
-
-  if (current_choice &lt; 0)
-    {
-      if (bonus_active)
-        current_choice = 2;
-      else
-        current_choice = 1;
-    }
-  else if (current_choice &gt; 1 &amp;&amp; !bonus_active)
-    current_choice = 0;
-  else if (current_choice &gt; 2 &amp;&amp; bonus_active)
-    current_choice = 0;
-
-  InputManager::clear();
-}
-
-void
-WindstilleMenu::draw()
-{
-  //std::cout &lt;&lt; &quot;Draw... &quot; &lt;&lt; std::endl;
-  background.draw(0,0);
-
-  if (0) // ugly wooble
-    {
-      windstille.set_color(
-                           sin(passed_time*3.141f)*.2f + .8f,
-                           sin(passed_time*3.141f)*.2f + .8f,
-                           sin(passed_time*3.141f)*.2f + .8f
-                           );
-      windstille.set_scale(cos(passed_time*3.141f)*.05f + .95f,
-                           cos(passed_time*3.141f)*.05f + .95f);
-    }
-
-  windstille.draw(CL_Display::get_width()/2, 145);
-  
-  Fonts::menu.set_alignment(origin_bottom_center);
-  Fonts::menu_h.set_alignment(origin_bottom_center);
-
-  Fonts::menu_h.set_alpha(cos(passed_time*3.141f)*.4f + .6f);
-
-  if (current_choice == 0)
-    {
-      Fonts::menu.draw(580, 330, _(&quot;[Start Game]&quot;));
-      Fonts::menu_h.draw(580, 330, _(&quot;[Start Game]&quot;));
-    }
-  else
-    Fonts::menu.draw(580, 330, _(&quot;Start Game&quot;));
-
-  if (bonus_active)
-    {
-      if (current_choice == 1)
-        {
-          Fonts::menu.draw(580, 385, _(&quot;[Extras]&quot;));
-          Fonts::menu_h.draw(580, 385, _(&quot;[Extras]&quot;));
-        }
-      else
-        Fonts::menu.draw(580, 385, _(&quot;Extras&quot;));
-
-      if (current_choice == 2)
-        {
-          Fonts::menu.draw(580, 440, _(&quot;[Quit]&quot;));
-          Fonts::menu_h.draw(580, 440, _(&quot;[Quit]&quot;));
-        }
-      else
-        Fonts::menu.draw(580, 440, _(&quot;Quit&quot;));
-    }
-  else
-    {
-      if (current_choice == 1 || (bonus_active &amp;&amp; current_choice == 3))
-        {
-          Fonts::menu.draw(580, 440, _(&quot;[Quit]&quot;));
-          Fonts::menu_h.draw(580, 440, _(&quot;[Quit]&quot;));
-        }
-      else
-        Fonts::menu.draw(580, 440, &quot;Quit&quot;);
-    }
-
-  std::string copyright = &quot;Windstille &quot; PACKAGE_VERSION &quot;\n&quot;;
-  copyright += _(&quot;Copyright (c) 2003 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;\n&quot;
-                 &quot;This game comes with ABSOLUTELY NO WARRANTY. &quot;
-                 &quot;This is free software, and you are welcome\n&quot;
-                 &quot;to redistribute it under certain conditions; &quot;
-                 &quot;see the file COPYING for details.\n&quot;);
-
-  Fonts::copyright.set_alignment(origin_bottom_left);
-  Fonts::copyright.draw(15, CL_Display::get_height() - 10, copyright.c_str());
-}
-
-void
-WindstilleMenu::fadeout()
-{
-  int alpha = 0;
-  while (alpha &lt;= 255)
-    {
-      background.draw(0,0);
-
-      windstille.draw(CL_Display::get_width()/2,
-                      145);
-      CL_Display::fill_rect(CL_Rect(0, 0, 
-                                    CL_Display::get_width(), CL_Display::get_height()),
-                            CL_Color(0,0,0, std::min(alpha, 255)));
-      CL_Display::flip(0);
-      sound_manager-&gt;update();
-      CL_System::keep_alive();
-      CL_System::sleep(50);
-      alpha += 15;
-    }
-}
-
-void
-WindstilleMenu::on_startup()
-{
-  sound_manager-&gt;play_music(&quot;music/jingle.ogg&quot;);
-}
-
-void
-WindstilleMenu::on_shutdown()
-{
-}
-
-/* EOF */

Copied: trunk/src/windstille_menu.hpp (from rev 502, trunk/src/windstille_menu.hxx)
===================================================================
--- trunk/src/windstille_menu.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_menu.hpp	2005-07-01 22:34:46 UTC (rev 503)
@@ -0,0 +1,53 @@
+//  $Id: windstille_menu.hpp,v 1.6 2003/11/06 09:24:17 grumbel Exp $
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_WINDESTILLE_MENU_HXX
+#define HEADER_WINDESTILLE_MENU_HXX
+
+#include &lt;ClanLib/Display/sprite.h&gt;
+#include &quot;screen.hpp&quot;
+
+/** */
+class WindstilleMenu : public Windstille::Screen
+{
+private:
+  CL_Sprite background;
+  CL_Sprite windstille;
+  int current_choice;
+  float passed_time;
+
+public:
+  WindstilleMenu();
+  ~WindstilleMenu();
+  
+  void update(float delta);
+  void draw();
+  
+  void on_startup();
+  void on_shutdown();
+
+private:
+  void fadeout();
+  WindstilleMenu (const WindstilleMenu&amp;);
+  WindstilleMenu&amp; operator= (const WindstilleMenu&amp;);
+};
+
+#endif
+
+/* EOF */

Deleted: trunk/src/windstille_menu.hxx
===================================================================
--- trunk/src/windstille_menu.hxx	2005-07-01 21:55:48 UTC (rev 502)
+++ trunk/src/windstille_menu.hxx	2005-07-01 22:34:46 UTC (rev 503)
@@ -1,53 +0,0 @@
-//  $Id: windstille_menu.hxx,v 1.6 2003/11/06 09:24:17 grumbel Exp $
-// 
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2002 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software; you can redistribute it and/or
-//  modify it under the terms of the GNU General Public License
-//  as published by the Free Software Foundation; either version 2
-//  of the License, or (at your option) any later version.
-//
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-// 
-//  You should have received a copy of the GNU General Public License
-//  along with this program; if not, write to the Free Software
-//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-
-#ifndef HEADER_WINDESTILLE_MENU_HXX
-#define HEADER_WINDESTILLE_MENU_HXX
-
-#include &lt;ClanLib/Display/sprite.h&gt;
-#include &quot;screen.hxx&quot;
-
-/** */
-class WindstilleMenu : public Windstille::Screen
-{
-private:
-  CL_Sprite background;
-  CL_Sprite windstille;
-  int current_choice;
-  float passed_time;
-
-public:
-  WindstilleMenu();
-  ~WindstilleMenu();
-  
-  void update(float delta);
-  void draw();
-  
-  void on_startup();
-  void on_shutdown();
-
-private:
-  void fadeout();
-  WindstilleMenu (const WindstilleMenu&amp;);
-  WindstilleMenu&amp; operator= (const WindstilleMenu&amp;);
-};
-
-#endif
-
-/* EOF */


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000159.html">[Windstille-commit] r502 - trunk/src/scripting
</A></li>
	<LI>Next message: <A HREF="000160.html">[Windstille-commit] r504 - in trunk: data data/images data/levels data/sounds data/sounds/speech src src/scripting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#668">[ date ]</a>
              <a href="thread.html#668">[ thread ]</a>
              <a href="subject.html#668">[ subject ]</a>
              <a href="author.html#668">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/windstille-commit">More information about the Windstille-commit
mailing list</a><br>
</body></html>
