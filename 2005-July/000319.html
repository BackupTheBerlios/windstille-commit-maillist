<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Windstille-commit] r666 - in trunk/src: . scripting
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/windstille-commit/2005-July/index.html" >
   <LINK REL="made" HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r666%20-%20in%20trunk/src%3A%20.%20scripting&In-Reply-To=%3C200507181508.j6IF8hdB009569%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000318.html">
   <LINK REL="Next"  HREF="000320.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Windstille-commit] r666 - in trunk/src: . scripting</H1>
    <B>Ingo Ruhnke at BerliOS</B> 
    <A HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r666%20-%20in%20trunk/src%3A%20.%20scripting&In-Reply-To=%3C200507181508.j6IF8hdB009569%40sheep.berlios.de%3E"
       TITLE="[Windstille-commit] r666 - in trunk/src: . scripting">grumbel at berlios.de
       </A><BR>
    <I>Mon Jul 18 17:08:43 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000318.html">[Windstille-commit] r665 - trunk
</A></li>
        <LI>Next message: <A HREF="000320.html">[Windstille-commit] r667 - trunk/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#319">[ date ]</a>
              <a href="thread.html#319">[ thread ]</a>
              <a href="subject.html#319">[ subject ]</a>
              <a href="author.html#319">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: grumbel
Date: 2005-07-18 17:08:42 +0200 (Mon, 18 Jul 2005)
New Revision: 666

Modified:
   trunk/src/globals.cpp
   trunk/src/scripting/interface.cpp
   trunk/src/scripting/interface.hpp
   trunk/src/scripting/wrapper.cpp
   trunk/src/scripting/wrapper.hpp
   trunk/src/tile_factory.cpp
   trunk/src/tile_packer.cpp
Log:
- added function to change gamespeed via console
- added border generator for the tilemap, now draws almost correctly

Modified: trunk/src/globals.cpp
===================================================================
--- trunk/src/globals.cpp	2005-07-18 01:05:19 UTC (rev 665)
+++ trunk/src/globals.cpp	2005-07-18 15:08:42 UTC (rev 666)
@@ -23,8 +23,6 @@
 
 int TILE_SIZE    = 32;
 int TILE_RESOLUTION = 64;
-int SUBTILE_SIZE = 32;
-int SUBTILE_NUM  = (TILE_SIZE/SUBTILE_SIZE);
 
 float game_speed = 1.0f;
 #ifdef DEBUG

Modified: trunk/src/scripting/interface.cpp
===================================================================
--- trunk/src/scripting/interface.cpp	2005-07-18 01:05:19 UTC (rev 665)
+++ trunk/src/scripting/interface.cpp	2005-07-18 15:08:42 UTC (rev 666)
@@ -119,4 +119,14 @@
     }
 }
 
+float get_game_speed()
+{
+  return game_speed;
 }
+
+void set_game_speed(float v)
+{
+  game_speed = v;
+}
+
+}

Modified: trunk/src/scripting/interface.hpp
===================================================================
--- trunk/src/scripting/interface.hpp	2005-07-18 01:05:19 UTC (rev 665)
+++ trunk/src/scripting/interface.hpp	2005-07-18 15:08:42 UTC (rev 666)
@@ -42,6 +42,9 @@
 void activate_object(const std::string&amp; name, bool active);
 void list_objects();
 
+float get_game_speed();
+void  set_game_speed(float v);
+
 //Waits the specified time in seconds.
 void wait(HSQUIRRELVM vm, float time) __suspend;
 

Modified: trunk/src/scripting/wrapper.cpp
===================================================================
--- trunk/src/scripting/wrapper.cpp	2005-07-18 01:05:19 UTC (rev 665)
+++ trunk/src/scripting/wrapper.cpp	2005-07-18 15:08:42 UTC (rev 666)
@@ -1,6 +1,6 @@
 /**
  * WARNING: This file is automatically generated from:
- *  'scripting/wrapper.interface.hpp'
+ *  'src/scripting/wrapper.interface.hpp'
  * DO NOT CHANGE
  */
 #include &lt;config.h&gt;
@@ -402,6 +402,25 @@
   return 0;
 }
 
+static int get_game_speed_wrapper(HSQUIRRELVM v)
+{
+  
+  float return_value = Scripting::get_game_speed();
+  
+  sq_pushfloat(v, return_value);
+  return 1;
+}
+
+static int set_game_speed_wrapper(HSQUIRRELVM v)
+{
+  float arg0;
+  sq_getfloat(v, 2, &amp;arg0);
+  
+  Scripting::set_game_speed(arg0);
+  
+  return 0;
+}
+
 static int wait_wrapper(HSQUIRRELVM v)
 {
   HSQUIRRELVM arg0 = v;
@@ -597,6 +616,22 @@
     throw SquirrelError(v, msg.str());
   }
 
+  sq_pushstring(v, &quot;get_game_speed&quot;, -1);
+  sq_newclosure(v, &amp;get_game_speed_wrapper, 0);
+  if(sq_createslot(v, -3) &lt; 0) {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;Couldn't register function'get_game_speed'&quot;;
+    throw SquirrelError(v, msg.str());
+  }
+
+  sq_pushstring(v, &quot;set_game_speed&quot;, -1);
+  sq_newclosure(v, &amp;set_game_speed_wrapper, 0);
+  if(sq_createslot(v, -3) &lt; 0) {
+    std::ostringstream msg;
+    msg &lt;&lt; &quot;Couldn't register function'set_game_speed'&quot;;
+    throw SquirrelError(v, msg.str());
+  }
+
   sq_pushstring(v, &quot;wait&quot;, -1);
   sq_newclosure(v, &amp;wait_wrapper, 0);
   if(sq_createslot(v, -3) &lt; 0) {

Modified: trunk/src/scripting/wrapper.hpp
===================================================================
--- trunk/src/scripting/wrapper.hpp	2005-07-18 01:05:19 UTC (rev 665)
+++ trunk/src/scripting/wrapper.hpp	2005-07-18 15:08:42 UTC (rev 666)
@@ -1,6 +1,6 @@
 /**
  * WARNING: This file is automatically generated from:
- *  'scripting/wrapper.interface.hpp'
+ *  'src/scripting/wrapper.interface.hpp'
  * DO NOT CHANGE
  */
 #ifndef __windstille_WRAPPER_H__

Modified: trunk/src/tile_factory.cpp
===================================================================
--- trunk/src/tile_factory.cpp	2005-07-18 01:05:19 UTC (rev 665)
+++ trunk/src/tile_factory.cpp	2005-07-18 15:08:42 UTC (rev 666)
@@ -180,6 +180,8 @@
           i += 1;
         }
     }
+  
+  //CL_ProviderFactory::save(packers[0]-&gt;get_pixelbuffer(), &quot;/tmp/pack.png&quot;);
 }
 
 void

Modified: trunk/src/tile_packer.cpp
===================================================================
--- trunk/src/tile_packer.cpp	2005-07-18 01:05:19 UTC (rev 665)
+++ trunk/src/tile_packer.cpp	2005-07-18 15:08:42 UTC (rev 666)
@@ -54,6 +54,38 @@
   delete impl;
 }
 
+static void generate_border(CL_PixelBuffer buffer, int x_pos, int y_pos)
+{
+  buffer.lock();
+  unsigned char* data = static_cast&lt;unsigned char*&gt;(buffer.get_data());
+  int pitch = buffer.get_pitch();
+
+  // duplicate the top line
+  memcpy(data + (y_pos-1)*pitch + 4*x_pos, 
+         data + (y_pos)*pitch + 4*x_pos,
+         4*(TILE_RESOLUTION+2));
+  // duplicate the bottom line
+  memcpy(data + (y_pos+TILE_RESOLUTION)*pitch + 4*x_pos, 
+         data + (y_pos+TILE_RESOLUTION-1)*pitch + 4*x_pos,  
+         4*(TILE_RESOLUTION+2));
+
+  // duplicate left and right borders
+  for(int y = y_pos-1; y &lt; y_pos + TILE_RESOLUTION+1; ++y)
+    {
+      data[y*pitch + 4*(x_pos-1) + 0] = data[y*pitch + 4*(x_pos) + 0];
+      data[y*pitch + 4*(x_pos-1) + 1] = data[y*pitch + 4*(x_pos) + 1];
+      data[y*pitch + 4*(x_pos-1) + 2] = data[y*pitch + 4*(x_pos) + 2];
+      data[y*pitch + 4*(x_pos-1) + 3] = data[y*pitch + 4*(x_pos) + 3];
+
+      data[y*pitch + 4*(x_pos + TILE_RESOLUTION) + 0] = data[y*pitch + 4*(x_pos + TILE_RESOLUTION-1) + 0];
+      data[y*pitch + 4*(x_pos + TILE_RESOLUTION) + 1] = data[y*pitch + 4*(x_pos + TILE_RESOLUTION-1) + 1];
+      data[y*pitch + 4*(x_pos + TILE_RESOLUTION) + 2] = data[y*pitch + 4*(x_pos + TILE_RESOLUTION-1) + 2];
+      data[y*pitch + 4*(x_pos + TILE_RESOLUTION) + 3] = data[y*pitch + 4*(x_pos + TILE_RESOLUTION-1) + 3];
+    }
+
+  buffer.unlock();
+}
+
 /** Pack a tile and return the position where it is placed in the
     pixel buffer */
 CL_Rectf
@@ -63,17 +95,13 @@
   assert(!is_full());
 
   blit_opaque(impl-&gt;buffer, tile, impl-&gt;x_pos+1, impl-&gt;y_pos+1);
-  blit_opaque(impl-&gt;buffer, tile, impl-&gt;x_pos+1, impl-&gt;y_pos);
-  blit_opaque(impl-&gt;buffer, tile, impl-&gt;x_pos, impl-&gt;y_pos+1);
+  generate_border(impl-&gt;buffer, impl-&gt;x_pos+1, impl-&gt;y_pos+1);
 
-  blit_opaque(impl-&gt;buffer, tile, impl-&gt;x_pos, impl-&gt;y_pos);
+  CL_Rectf rect(CL_Pointf((impl-&gt;x_pos+1)/1024.0f, 
+                          (impl-&gt;y_pos+1)/1024.0f), 
+                CL_Sizef((TILE_RESOLUTION)/1024.0f, 
+                         (TILE_RESOLUTION)/1024.0f));
 
-  float factor = 0;
-  CL_Rectf rect(CL_Pointf((impl-&gt;x_pos)/1024.0f, 
-                          (impl-&gt;y_pos)/1024.0f), 
-                CL_Sizef((TILE_RESOLUTION+factor)/1024.0f, 
-                         (TILE_RESOLUTION+factor)/1024.0f));
-
   // we move by TILE_RESOLUTION+1 to avoid tiles bleeding into each other
   // when blending
   impl-&gt;x_pos += TILE_RESOLUTION + 2; 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000318.html">[Windstille-commit] r665 - trunk
</A></li>
	<LI>Next message: <A HREF="000320.html">[Windstille-commit] r667 - trunk/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#319">[ date ]</a>
              <a href="thread.html#319">[ thread ]</a>
              <a href="subject.html#319">[ subject ]</a>
              <a href="author.html#319">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/windstille-commit">More information about the Windstille-commit
mailing list</a><br>
</body></html>
