<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Windstille-commit] r3365 - in trunk/windstille/src: display font	gui tile
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/windstille-commit/2010-September/index.html" >
   <LINK REL="made" HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r3365%20-%20in%20trunk/windstille/src%3A%20display%20font%0A%09gui%20tile&In-Reply-To=%3C20100922104651.AF28E480F5C%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002361.html">
   <LINK REL="Next"  HREF="002363.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Windstille-commit] r3365 - in trunk/windstille/src: display font	gui tile</H1>
    <B>grumbel at mail.berlios.de</B> 
    <A HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r3365%20-%20in%20trunk/windstille/src%3A%20display%20font%0A%09gui%20tile&In-Reply-To=%3C20100922104651.AF28E480F5C%40sheep.berlios.de%3E"
       TITLE="[Windstille-commit] r3365 - in trunk/windstille/src: display font	gui tile">grumbel at mail.berlios.de
       </A><BR>
    <I>Wed Sep 22 12:46:51 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002361.html">[Windstille-commit] r3364 - in trunk/windstille/src: display gui	objects particles scenegraph sprite2d
</A></li>
        <LI>Next message: <A HREF="002363.html">[Windstille-commit] r3366 - trunk/windstille/src/display
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2362">[ date ]</a>
              <a href="thread.html#2362">[ thread ]</a>
              <a href="subject.html#2362">[ subject ]</a>
              <a href="author.html#2362">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: grumbel
Date: 2010-09-22 12:46:51 +0200 (Wed, 22 Sep 2010)
New Revision: 3365

Modified:
   trunk/windstille/src/display/blitter.cpp
   trunk/windstille/src/display/blitter.hpp
   trunk/windstille/src/display/software_surface.cpp
   trunk/windstille/src/display/software_surface.hpp
   trunk/windstille/src/display/surface.hpp
   trunk/windstille/src/display/surface_manager.cpp
   trunk/windstille/src/display/surface_manager.hpp
   trunk/windstille/src/display/texture.cpp
   trunk/windstille/src/display/texture.hpp
   trunk/windstille/src/display/texture_manager.cpp
   trunk/windstille/src/display/texture_packer.cpp
   trunk/windstille/src/display/texture_packer.hpp
   trunk/windstille/src/font/border_font_effect.cpp
   trunk/windstille/src/font/border_font_effect.hpp
   trunk/windstille/src/font/font_effect.hpp
   trunk/windstille/src/font/no_font_effect.cpp
   trunk/windstille/src/font/no_font_effect.hpp
   trunk/windstille/src/font/ttf_font.cpp
   trunk/windstille/src/gui/automap.cpp
   trunk/windstille/src/tile/tile_description.cpp
   trunk/windstille/src/tile/tile_factory.cpp
   trunk/windstille/src/tile/tile_factory.hpp
   trunk/windstille/src/tile/tile_packer.cpp
   trunk/windstille/src/tile/tile_packer.hpp
Log:
Replaced SoftwareSurface with SoftwareSurfacePtr


Modified: trunk/windstille/src/display/blitter.cpp
===================================================================
--- trunk/windstille/src/display/blitter.cpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/display/blitter.cpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -24,13 +24,13 @@
 
 #include &quot;display/software_surface.hpp&quot;
 
-void generate_border(const SoftwareSurface&amp; surface,
+void generate_border(SoftwareSurfacePtr surface,
                      int x_pos, int y_pos, int width, int height)
 {
-  assert(surface.get_bits_per_pixel() == 32);
+  assert(surface-&gt;get_bits_per_pixel() == 32);
  
-  uint8_t* data = static_cast&lt;uint8_t*&gt;(surface.get_pixels());
-  int pitch = surface.get_pitch();
+  uint8_t* data = static_cast&lt;uint8_t*&gt;(surface-&gt;get_pixels());
+  int pitch = surface-&gt;get_pitch();
 
   // duplicate the top line
   memcpy(data + (y_pos-1)*pitch + 4*x_pos, 

Modified: trunk/windstille/src/display/blitter.hpp
===================================================================
--- trunk/windstille/src/display/blitter.hpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/display/blitter.hpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -18,7 +18,7 @@
 #ifndef HEADER_WINDSTILLE_DISPLAY_BLITTER_HPP
 #define HEADER_WINDSTILLE_DISPLAY_BLITTER_HPP
 
-class SoftwareSurface;
+#include &quot;display/software_surface.hpp&quot;
 
 /** Duplicate all the edge pixel of the given rectangle to the outside
     of the rectangle, thus creating a border around the given
@@ -30,7 +30,7 @@
     X 4 5 6 X  / 4 4 5 6 6
     X X X X X    4 4 5 6 6
 */
-void generate_border(const SoftwareSurface&amp; surface, int x_pos, int y_pos, int width, int height);
+void generate_border(SoftwareSurfacePtr surface, int x_pos, int y_pos, int width, int height);
 
 #endif
 

Modified: trunk/windstille/src/display/software_surface.cpp
===================================================================
--- trunk/windstille/src/display/software_surface.cpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/display/software_surface.cpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -26,18 +26,24 @@
 #include &quot;math/rect.hpp&quot;
 #include &quot;display/software_surface.hpp&quot;
 
-class SoftwareSurfaceImpl
+SoftwareSurfacePtr
+SoftwareSurface::create(const Pathname&amp; filename)
 {
-public:
-  SDL_Surface* surface;
-};
+  return SoftwareSurfacePtr(new SoftwareSurface(filename));
+}
+
+SoftwareSurfacePtr
+SoftwareSurface::create(int width, int height, Format format)
+{
+  return SoftwareSurfacePtr(new SoftwareSurface(width, height, format));
+}
 
 SoftwareSurface::SoftwareSurface(const Pathname&amp; filename) :
-  impl(new SoftwareSurfaceImpl())
+  m_surface(0)
 {
-  impl-&gt;surface = IMG_Load(filename.get_sys_path().c_str());
+  m_surface = IMG_Load(filename.get_sys_path().c_str());
 
-  if (!impl-&gt;surface)
+  if (!m_surface)
   {
     std::ostringstream str;
     str &lt;&lt; &quot;SoftwareSurface: Couldn't load: &quot; &lt;&lt; filename &lt;&lt; std::endl;
@@ -45,101 +51,98 @@
   }
   else
   {
-    SDL_SetAlpha(impl-&gt;surface, 0, 0);
+    SDL_SetAlpha(m_surface, 0, 0);
 
-    assert(!SDL_MUSTLOCK(impl-&gt;surface));
+    assert(!SDL_MUSTLOCK(m_surface));
   }
 }
 
 SoftwareSurface::SoftwareSurface(int width, int height, Format format) :
-  impl(new SoftwareSurfaceImpl())
+  m_surface(0)
 {
   assert(format == RGBA);
 
 #if SDL_BYTEORDER == SDL_BIG_ENDIAN
-  impl-&gt;surface = SDL_CreateRGBSurface(SDL_SWSURFACE,
+  m_surface = SDL_CreateRGBSurface(SDL_SWSURFACE,
                                        width, height, 32,
                                        0xff000000, 0x00ff0000, 0x0000ff00, 0x000000ff);
 #else
-  impl-&gt;surface = SDL_CreateRGBSurface(SDL_SWSURFACE,
+  m_surface = SDL_CreateRGBSurface(SDL_SWSURFACE,
                                        width, height, 32,
                                        0x000000ff, 0x0000ff00, 0x00ff0000, 0xff000000);
 #endif
 
-  SDL_SetAlpha(impl-&gt;surface, 0, 0);
+  SDL_SetAlpha(m_surface, 0, 0);
 
-  assert(!SDL_MUSTLOCK(impl-&gt;surface));
+  assert(!SDL_MUSTLOCK(m_surface));
 }
 
 SoftwareSurface::~SoftwareSurface()
 {
-  if (impl)
-  {
-    SDL_FreeSurface(impl-&gt;surface);
-  }
+  SDL_FreeSurface(m_surface);
 }
 
 int
 SoftwareSurface::get_bytes_per_pixel() const
 {
-  return impl-&gt;surface-&gt;format-&gt;BytesPerPixel;
+  return m_surface-&gt;format-&gt;BytesPerPixel;
 }
 
 int
 SoftwareSurface::get_bits_per_pixel() const
 {
-  return impl-&gt;surface-&gt;format-&gt;BitsPerPixel;
+  return m_surface-&gt;format-&gt;BitsPerPixel;
 }
 
 int
 SoftwareSurface::get_width() const
 {
-  return impl-&gt;surface-&gt;w;
+  return m_surface-&gt;w;
 }
 
 int
 SoftwareSurface::get_height() const
 {
-  return impl-&gt;surface-&gt;h;
+  return m_surface-&gt;h;
 }
 
 Size
 SoftwareSurface::get_size() const
 {
-  return Size(impl-&gt;surface-&gt;w, 
-              impl-&gt;surface-&gt;h);
+  return Size(m_surface-&gt;w, 
+              m_surface-&gt;h);
 }
 
 int
 SoftwareSurface::get_pitch() const
 {
-  return impl-&gt;surface-&gt;pitch;
+  return m_surface-&gt;pitch;
 }
 
 void*
 SoftwareSurface::get_pixels() const
 {
-  return impl-&gt;surface-&gt;pixels;
+  return m_surface-&gt;pixels;
 }
 
 SDL_Surface*
 SoftwareSurface::get_surface() const
 {
-  return impl-&gt;surface;
+  return m_surface;
 }
 
 void
-SoftwareSurface::blit(SoftwareSurface&amp; dst, int x, int y) const
+SoftwareSurface::blit(SoftwareSurfacePtr dst, int x, int y) const
 {
   SDL_Rect dst_rect; 
   dst_rect.x = static_cast&lt;Sint16&gt;(x);
   dst_rect.y = static_cast&lt;Sint16&gt;(y);
 
-  SDL_BlitSurface(impl-&gt;surface, 0, dst.impl-&gt;surface, &amp;dst_rect);
+  SDL_BlitSurface(m_surface, 0, dst-&gt;m_surface, &amp;dst_rect);
 }
 
 void
-SoftwareSurface::blit(const Rect&amp; src_rect_, SoftwareSurface&amp; dst, int x, int y) const
+SoftwareSurface::blit(const Rect&amp; src_rect_, SoftwareSurfacePtr dst, int x, int y) const
 {
   SDL_Rect src_rect;
   src_rect.x = static_cast&lt;Sint16&gt;(src_rect_.left);
@@ -151,20 +154,20 @@
   dst_rect.x = static_cast&lt;Sint16&gt;(x);
   dst_rect.y = static_cast&lt;Sint16&gt;(y);
   
-  SDL_BlitSurface(impl-&gt;surface, &amp;src_rect, dst.impl-&gt;surface, &amp;dst_rect);
+  SDL_BlitSurface(m_surface, &amp;src_rect, dst-&gt;m_surface, &amp;dst_rect);
 }
 
 bool
 SoftwareSurface::is_at(int x, int y) const
 {
-  if (x &gt;= 0 &amp;&amp; x &lt; impl-&gt;surface-&gt;w &amp;&amp;
-      y &gt;= 0 &amp;&amp; y &lt; impl-&gt;surface-&gt;h)
+  if (x &gt;= 0 &amp;&amp; x &lt; m_surface-&gt;w &amp;&amp;
+      y &gt;= 0 &amp;&amp; y &lt; m_surface-&gt;h)
   {
     if (get_bits_per_pixel() == 32)
     {
-      uint8_t* pixels = static_cast&lt;uint8_t*&gt;(impl-&gt;surface-&gt;pixels);
+      uint8_t* pixels = static_cast&lt;uint8_t*&gt;(m_surface-&gt;pixels);
           
-      return pixels[y * impl-&gt;surface-&gt;pitch + x*4 + 3] &gt; 128;
+      return pixels[y * m_surface-&gt;pitch + x*4 + 3] &gt; 128;
     }
     else
     {

Modified: trunk/windstille/src/display/software_surface.hpp
===================================================================
--- trunk/windstille/src/display/software_surface.hpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/display/software_surface.hpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -28,7 +28,8 @@
 
 
 class Rect;
-class SoftwareSurfaceImpl;
+class SoftwareSurface;
+typedef boost::shared_ptr&lt;SoftwareSurface&gt; SoftwareSurfacePtr;
 
 class SoftwareSurface
 {
@@ -38,9 +39,15 @@
     RGBA
   };
 
-  SoftwareSurface() : impl() {}
+public:
+  static SoftwareSurfacePtr create(const Pathname&amp; filename);
+  static SoftwareSurfacePtr create(int width, int height, Format format = RGBA);
+
+private:
   explicit SoftwareSurface(const Pathname&amp; filename);
   SoftwareSurface(int width, int height, Format format = RGBA);
+
+public:
   ~SoftwareSurface();
 
   int   get_bytes_per_pixel() const;
@@ -51,8 +58,8 @@
   Size  get_size() const;
   void* get_pixels() const;
 
-  void blit(SoftwareSurface&amp; dst, int x, int y) const;
-  void blit(const Rect&amp; src_rect, SoftwareSurface&amp; dst, int x, int y) const;
+  void blit(SoftwareSurfacePtr dst, int x, int y) const;
+  void blit(const Rect&amp; src_rect, SoftwareSurfacePtr dst, int x, int y) const;
 
   void save_png(const std::string&amp; filename) const;
 
@@ -60,10 +67,12 @@
 
   bool is_at(int x, int y) const;
 
-  operator bool() { return impl; }
+private:
+  SDL_Surface* m_surface;
 
 private:
-  boost::shared_ptr&lt;SoftwareSurfaceImpl&gt; impl;
+  SoftwareSurface(const SoftwareSurface&amp;);
+  SoftwareSurface&amp; operator=(const SoftwareSurface&amp;);
 };
 
 #endif

Modified: trunk/windstille/src/display/surface.hpp
===================================================================
--- trunk/windstille/src/display/surface.hpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/display/surface.hpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -19,8 +19,9 @@
 #ifndef HEADER_WINDSTILLE_DISPLAY_SURFACE_HPP
 #define HEADER_WINDSTILLE_DISPLAY_SURFACE_HPP
 
+#include &quot;display/texture.hpp&quot;
 #include &quot;math/rect.hpp&quot;
-#include &quot;display/texture.hpp&quot;
+#include &quot;util/pathname.hpp&quot;
 
 class SurfaceDrawingParameters;
 class Surface;

Modified: trunk/windstille/src/display/surface_manager.cpp
===================================================================
--- trunk/windstille/src/display/surface_manager.cpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/display/surface_manager.cpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -56,7 +56,7 @@
   }
   else
   {
-    SoftwareSurface software_surface(filename);
+    SoftwareSurfacePtr software_surface = SoftwareSurface::create(filename);
 
     if (texture_packer)
     {
@@ -82,8 +82,8 @@
       }
         
       SurfacePtr result = Surface::create(texture, Rectf(0.0f, 0.0f, maxu, maxv),
-                                          Sizef(static_cast&lt;float&gt;(software_surface.get_width()),
-                                                static_cast&lt;float&gt;(software_surface.get_height())));
+                                          Sizef(static_cast&lt;float&gt;(software_surface-&gt;get_width()),
+                                                static_cast&lt;float&gt;(software_surface-&gt;get_height())));
       surfaces.insert(std::make_pair(filename, result));
       return result;
     }
@@ -95,7 +95,7 @@
                           std::vector&lt;SurfacePtr&gt;&amp; out_surfaces,
                           int width, int height)
 {
-  SoftwareSurface image(filename);
+  SoftwareSurfacePtr image = SoftwareSurface::create(filename);
   float maxu, maxv;
 
   TexturePtr texture;
@@ -104,21 +104,21 @@
   {                                                                       
     texture = create_texture(image, &amp;maxu, &amp;maxv);
   }
-  catch(std::exception&amp; e)
+  catch(const std::exception&amp; e)
   {
     std::ostringstream msg;
     msg &lt;&lt; &quot;Couldn't create texture for '&quot; &lt;&lt; filename &lt;&lt; &quot;': &quot; &lt;&lt; e.what();
     throw std::runtime_error(msg.str());                                      
   }
 
-  for(int y = 0; y &lt;= image.get_height() - height + 1; y += height)
+  for(int y = 0; y &lt;= image-&gt;get_height() - height + 1; y += height)
   {
-    for(int x = 0; x &lt;= image.get_width() - width + 1; x += width)
+    for(int x = 0; x &lt;= image-&gt;get_width() - width + 1; x += width)
     {
-      float s_min_u = maxu * static_cast&lt;float&gt;(x) / static_cast&lt;float&gt;(image.get_width());
-      float s_min_v = maxv * static_cast&lt;float&gt;(x) / static_cast&lt;float&gt;(image.get_height());
-      float s_max_u = (maxu * (static_cast&lt;float&gt;(x + width)))  / static_cast&lt;float&gt;(image.get_width());
-      float s_max_v = (maxv * (static_cast&lt;float&gt;(x + height))) / static_cast&lt;float&gt;(image.get_height());
+      float s_min_u = maxu * static_cast&lt;float&gt;(x) / static_cast&lt;float&gt;(image-&gt;get_width());
+      float s_min_v = maxv * static_cast&lt;float&gt;(x) / static_cast&lt;float&gt;(image-&gt;get_height());
+      float s_max_u = (maxu * (static_cast&lt;float&gt;(x + width)))  / static_cast&lt;float&gt;(image-&gt;get_width());
+      float s_max_v = (maxv * (static_cast&lt;float&gt;(x + height))) / static_cast&lt;float&gt;(image-&gt;get_height());
 
       out_surfaces.push_back(Surface::create(texture, 
                                              Rectf(s_min_u, s_min_v, s_max_u, s_max_v), 
@@ -129,21 +129,21 @@
 }
 
 TexturePtr
-SurfaceManager::create_texture(const SoftwareSurface&amp; image,
+SurfaceManager::create_texture(SoftwareSurfacePtr image,
                                float* maxu, float* maxv)
 {
   // OpenGL2.0 should be fine with non-power-of-two
-  int texture_w = image.get_width();  //math::round_to_power_of_two(image.get_width());
-  int texture_h = image.get_height(); //math::round_to_power_of_two(image.get_height());
+  int texture_w = image-&gt;get_width();  //math::round_to_power_of_two(image-&gt;get_width());
+  int texture_h = image-&gt;get_height(); //math::round_to_power_of_two(image-&gt;get_height());
 
-  SoftwareSurface convert(texture_w, texture_h);
+  SoftwareSurfacePtr convert = SoftwareSurface::create(texture_w, texture_h);
 
-  image.blit(convert, 0, 0);
+  image-&gt;blit(convert, 0, 0);
 
   TexturePtr texture = Texture::create(convert);
   
-  *maxu = static_cast&lt;float&gt;(image.get_width())  / static_cast&lt;float&gt;(texture_w);
-  *maxv = static_cast&lt;float&gt;(image.get_height()) / static_cast&lt;float&gt;(texture_h);
+  *maxu = static_cast&lt;float&gt;(image-&gt;get_width())  / static_cast&lt;float&gt;(texture_w);
+  *maxv = static_cast&lt;float&gt;(image-&gt;get_height()) / static_cast&lt;float&gt;(texture_h);
 
   return texture;
 }

Modified: trunk/windstille/src/display/surface_manager.hpp
===================================================================
--- trunk/windstille/src/display/surface_manager.hpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/display/surface_manager.hpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -56,7 +56,7 @@
   void load_grid(const Pathname&amp; filename,
                  std::vector&lt;SurfacePtr&gt;&amp; surfaces, int width, int height);
 
-  TexturePtr create_texture(const SoftwareSurface&amp; image,
+  TexturePtr create_texture(SoftwareSurfacePtr image,
                             float* maxu, float* maxv);
 
   /** Removes all cached Sprites that are no longer in use */

Modified: trunk/windstille/src/display/texture.cpp
===================================================================
--- trunk/windstille/src/display/texture.cpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/display/texture.cpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -40,7 +40,7 @@
 }
 
 TexturePtr
-Texture::create(const SoftwareSurface&amp; image, GLint format)
+Texture::create(SoftwareSurfacePtr image, GLint format)
 {
   return TexturePtr(new Texture(image, format));
 }
@@ -82,20 +82,20 @@
   glTexParameteri(target, GL_TEXTURE_WRAP_R, GL_CLAMP_TO_EDGE);
 }
 
-Texture::Texture(const SoftwareSurface&amp; image, GLint glformat) :
+Texture::Texture(SoftwareSurfacePtr image, GLint glformat) :
   m_target(GL_TEXTURE_2D),
   m_handle(0),
-  m_width(image.get_width()),
-  m_height(image.get_height())
+  m_width(image-&gt;get_width()),
+  m_height(image-&gt;get_height())
 {
   glGenTextures(1, &amp;m_handle);
   assert_gl(&quot;Texture::Texture()&quot;); 
 
   // Should be ok with OpenGL2.0
-  //if(!is_power_of_2(image.get_width()) || !is_power_of_2(image.get_height()))
+  //if(!is_power_of_2(image-&gt;get_width()) || !is_power_of_2(image-&gt;get_height()))
   //throw std::runtime_error(&quot;image has no power of 2 size&quot;);
 
-  if (image.get_bits_per_pixel() != 24 &amp;&amp; image.get_bits_per_pixel() != 32)
+  if (image-&gt;get_bits_per_pixel() != 24 &amp;&amp; image-&gt;get_bits_per_pixel() != 32)
     throw std::runtime_error(&quot;image has not 24 or 32 bit color depth&quot;);
 
   // FIXME: User SDL_ConvertSurface to bring images in the right format
@@ -106,18 +106,18 @@
     GLint maxt;
     glGetIntegerv(GL_MAX_TEXTURE_SIZE, &amp;maxt);
 
-    if(image.get_width() &gt; maxt || image.get_height() &gt; maxt)
+    if(image-&gt;get_width() &gt; maxt || image-&gt;get_height() &gt; maxt)
     {
       throw std::runtime_error(&quot;Texture size not supported&quot;);
     }
 
     GLint sdl_format;
 
-    if (image.get_bytes_per_pixel() == 3)
+    if (image-&gt;get_bytes_per_pixel() == 3)
     {
       sdl_format = GL_RGB;
     }
-    else if (image.get_bytes_per_pixel() == 4)
+    else if (image-&gt;get_bytes_per_pixel() == 4)
     {
       sdl_format = GL_RGBA;
     }
@@ -129,13 +129,13 @@
     glBindTexture(GL_TEXTURE_2D, m_handle);
 
     glPixelStorei(GL_UNPACK_ALIGNMENT, 1);
-    glPixelStorei(GL_UNPACK_ROW_LENGTH, image.get_pitch() / image.get_bytes_per_pixel());
+    glPixelStorei(GL_UNPACK_ROW_LENGTH, image-&gt;get_pitch() / image-&gt;get_bytes_per_pixel());
 
     if (0)
     { // no mipmapping
       glTexImage2D(m_target, 0, glformat,
-                   image.get_width(), image.get_height(), 0, sdl_format,
-                   GL_UNSIGNED_BYTE, image.get_pixels());
+                   image-&gt;get_width(), image-&gt;get_height(), 0, sdl_format,
+                   GL_UNSIGNED_BYTE, image-&gt;get_pixels());
         
       glTexParameteri(m_target, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
       glTexParameteri(m_target, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
@@ -143,8 +143,8 @@
     else
     { // use mipmapping
       gluBuild2DMipmaps(m_target, glformat,
-                        image.get_width(), image.get_height(), sdl_format,
-                        GL_UNSIGNED_BYTE, image.get_pixels());
+                        image-&gt;get_width(), image-&gt;get_height(), sdl_format,
+                        GL_UNSIGNED_BYTE, image-&gt;get_pixels());
         
       glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR_MIPMAP_LINEAR);
       glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
@@ -188,15 +188,15 @@
 }
 
 void
-Texture::put(const SoftwareSurface&amp; image, const Rect&amp; srcrect, int x, int y)
+Texture::put(SoftwareSurfacePtr image, const Rect&amp; srcrect, int x, int y)
 {
   GLint sdl_format;
 
-  if (image.get_bytes_per_pixel() == 3)
+  if (image-&gt;get_bytes_per_pixel() == 3)
   {
     sdl_format = GL_RGB;
   }
-  else if (image.get_bytes_per_pixel() == 4)
+  else if (image-&gt;get_bytes_per_pixel() == 4)
   {
     sdl_format = GL_RGBA;
   }
@@ -210,19 +210,19 @@
   // FIXME: Add some checks here to make sure image has the right format 
   glPixelStorei(GL_UNPACK_ALIGNMENT, 4); // FIXME: Does SDL always use 4?
   glPixelStorei(GL_UNPACK_ROW_LENGTH,
-                image.get_pitch() / image.get_bytes_per_pixel());
+                image-&gt;get_pitch() / image-&gt;get_bytes_per_pixel());
 
   glTexSubImage2D(m_target, 0, x, y,
                   srcrect.get_width(), srcrect.get_height(), sdl_format, GL_UNSIGNED_BYTE,
-                  static_cast&lt;uint8_t*&gt;(image.get_pixels())
-                  + srcrect.top  * image.get_pitch()
-                  + srcrect.left * image.get_bytes_per_pixel());
+                  static_cast&lt;uint8_t*&gt;(image-&gt;get_pixels())
+                  + srcrect.top  * image-&gt;get_pitch()
+                  + srcrect.left * image-&gt;get_bytes_per_pixel());
 }
 
 void
-Texture::put(const SoftwareSurface&amp; image, int x, int y)
+Texture::put(SoftwareSurfacePtr image, int x, int y)
 {
-  put(image, Rect(0, 0, image.get_width(), image.get_height()), x, y);
+  put(image, Rect(0, 0, image-&gt;get_width(), image-&gt;get_height()), x, y);
 }
 
 void
@@ -244,14 +244,14 @@
   glTexParameteri(m_target, GL_TEXTURE_MAG_FILTER, mode);
 }
 
-SoftwareSurface
+SoftwareSurfacePtr
 Texture::get_software_surface() const
 {
   glBindTexture(GL_TEXTURE_2D, m_handle);
 
-  SoftwareSurface surface(m_width, m_height);
+  SoftwareSurfacePtr surface = SoftwareSurface::create(m_width, m_height);
 
-  glGetTexImage(GL_TEXTURE_2D, 0, GL_RGBA, GL_UNSIGNED_BYTE, surface.get_pixels());
+  glGetTexImage(GL_TEXTURE_2D, 0, GL_RGBA, GL_UNSIGNED_BYTE, surface-&gt;get_pixels());
 
   return surface;
 }

Modified: trunk/windstille/src/display/texture.hpp
===================================================================
--- trunk/windstille/src/display/texture.hpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/display/texture.hpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -25,6 +25,7 @@
 #include &lt;GL/gl.h&gt;
 #include &lt;boost/shared_ptr.hpp&gt;
 
+#include &quot;display/software_surface.hpp&quot;
 #include &quot;util/pathname.hpp&quot;
 
 class SoftwareSurface;
@@ -44,7 +45,7 @@
    * Upload an SoftwareSurface onto an OpenGL texture. The surface must have power
    * of 2 dimensions
    * */
-  static TexturePtr create(const SoftwareSurface&amp; image, GLint format = GL_RGBA);
+  static TexturePtr create(SoftwareSurfacePtr image, GLint format = GL_RGBA);
   
   /** 
    * Create an empty Texture with the given dimensions
@@ -53,7 +54,7 @@
   
 private:
   Texture();
-  Texture(const SoftwareSurface&amp; image, GLint format = GL_RGBA);
+  Texture(SoftwareSurfacePtr image, GLint format = GL_RGBA);
   Texture(GLenum target, int width, int height, GLint format = GL_RGBA);
 
 public:
@@ -70,11 +71,11 @@
   void set_filter(GLenum mode);
 
   /** Uploads the given image to the given coordinates */
-  void put(const SoftwareSurface&amp; image, int x, int y);
+  void put(SoftwareSurfacePtr image, int x, int y);
   
   /** Uploads the given subsection \a srcrect of \a image to the given
       coordinates */
-  void put(const SoftwareSurface&amp; image, const Rect&amp; srcrect, int x, int y);
+  void put(SoftwareSurfacePtr image, const Rect&amp; srcrect, int x, int y);
 
   GLuint get_handle() const;
   
@@ -83,7 +84,7 @@
    */ 
   GLenum get_target() const;
 
-  SoftwareSurface get_software_surface() const;
+  SoftwareSurfacePtr get_software_surface() const;
 
 private:
   GLenum m_target;

Modified: trunk/windstille/src/display/texture_manager.cpp
===================================================================
--- trunk/windstille/src/display/texture_manager.cpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/display/texture_manager.cpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -50,7 +50,7 @@
   {
     try 
     {
-      SoftwareSurface image(filename);
+      SoftwareSurfacePtr image = SoftwareSurface::create(filename);
       TexturePtr texture = Texture::create(image);
 
       textures.insert(std::make_pair(filename, texture));

Modified: trunk/windstille/src/display/texture_packer.cpp
===================================================================
--- trunk/windstille/src/display/texture_packer.cpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/display/texture_packer.cpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -149,12 +149,12 @@
 }
 
 SurfacePtr
-TexturePacker::upload(const SoftwareSurface&amp; surface)
+TexturePacker::upload(SoftwareSurfacePtr surface)
 {
   // Add a 1px border around surfaces to avoid blending artifacts
   //SoftwareSurface surface = in_surface.add_1px_border();
 
-  Size    size(surface.get_width()+2, surface.get_height()+2);
+  Size    size(surface-&gt;get_width()+2, surface-&gt;get_height()+2);
   Rect    rect;
   TexturePtr texture;
 
@@ -167,26 +167,26 @@
     // duplicate border pixel
 
     // top
-    texture-&gt;put(surface, Rect(Point(0, 0), Size(surface.get_width(), 1)), 
+    texture-&gt;put(surface, Rect(Point(0, 0), Size(surface-&gt;get_width(), 1)), 
                  rect.left+1, rect.top);
     // bottom
-    texture-&gt;put(surface, Rect(Point(0, surface.get_height()-1), Size(surface.get_width(), 1)), 
+    texture-&gt;put(surface, Rect(Point(0, surface-&gt;get_height()-1), Size(surface-&gt;get_width(), 1)), 
                  rect.left+1, rect.bottom-1);
     // left
-    texture-&gt;put(surface, Rect(Point(0, 0), Size(1, surface.get_height())), 
+    texture-&gt;put(surface, Rect(Point(0, 0), Size(1, surface-&gt;get_height())), 
                  rect.left, rect.top+1);
     // right
-    texture-&gt;put(surface, Rect(Point(surface.get_width()-1, 0), Size(1, surface.get_height())),
+    texture-&gt;put(surface, Rect(Point(surface-&gt;get_width()-1, 0), Size(1, surface-&gt;get_height())),
                  rect.right-1, rect.top+1);
 
     // duplicate corner pixels
     texture-&gt;put(surface, Rect(Point(0, 0), Size(1, 1)), 
                  rect.left, rect.top);     
-    texture-&gt;put(surface, Rect(Point(surface.get_width()-1, 0), Size(1, 1)), 
+    texture-&gt;put(surface, Rect(Point(surface-&gt;get_width()-1, 0), Size(1, 1)), 
                  rect.right-1, rect.top);
-    texture-&gt;put(surface, Rect(Point(surface.get_width()-1, surface.get_height()-1), Size(1, 1)), 
+    texture-&gt;put(surface, Rect(Point(surface-&gt;get_width()-1, surface-&gt;get_height()-1), Size(1, 1)), 
                  rect.right-1, rect.bottom-1);
-    texture-&gt;put(surface, Rect(Point(0, surface.get_height()-1), Size(1, 1)),
+    texture-&gt;put(surface, Rect(Point(0, surface-&gt;get_height()-1), Size(1, 1)),
                  rect.left, rect.bottom-1);
 
     // draw the main surface
@@ -197,7 +197,7 @@
                                  static_cast&lt;float&gt;(rect.top+1)    / static_cast&lt;float&gt;(texture-&gt;get_height()),
                                  static_cast&lt;float&gt;(rect.right-1)  / static_cast&lt;float&gt;(texture-&gt;get_width()), 
                                  static_cast&lt;float&gt;(rect.bottom-1) / static_cast&lt;float&gt;(texture-&gt;get_height())),
-                           Sizef(static_cast&lt;float&gt;(surface.get_width()), static_cast&lt;float&gt;(surface.get_height())));
+                           Sizef(static_cast&lt;float&gt;(surface-&gt;get_width()), static_cast&lt;float&gt;(surface-&gt;get_height())));
   }
 }
 
@@ -207,12 +207,12 @@
   for(Textures::const_iterator i = textures.begin(); i != textures.end(); ++i)
   {
     TexturePtr texture = (*i)-&gt;get_texture();
-    SoftwareSurface surface = texture-&gt;get_software_surface();
+    SoftwareSurfacePtr surface = texture-&gt;get_software_surface();
 
     char filename[1024];
     sprintf(filename, &quot;/tmp/texture_packer%04d.png&quot;, int(i - textures.begin()));
     std::cout &lt;&lt; &quot;Saving: &quot; &lt;&lt; filename &lt;&lt; std::endl;
-    surface.save_png(filename);
+    surface-&gt;save_png(filename);
   }
 }
 

Modified: trunk/windstille/src/display/texture_packer.hpp
===================================================================
--- trunk/windstille/src/display/texture_packer.hpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/display/texture_packer.hpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -41,7 +41,7 @@
   TexturePacker(const Size&amp; texture_size);
   ~TexturePacker();
   
-  SurfacePtr upload(const SoftwareSurface&amp; surface);
+  SurfacePtr upload(SoftwareSurfacePtr surface);
   bool allocate(const Size&amp; size, Rect&amp; rect, TexturePtr&amp; out_texture);
   
   void save_all_as_png() const;

Modified: trunk/windstille/src/font/border_font_effect.cpp
===================================================================
--- trunk/windstille/src/font/border_font_effect.cpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/font/border_font_effect.cpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -62,7 +62,7 @@
 }
 
 void
-BorderFontEffect::blit(const SoftwareSurface&amp; target, const FT_Bitmap&amp; brush, int x_pos, int y_pos) const
+BorderFontEffect::blit(SoftwareSurfacePtr target, const FT_Bitmap&amp; brush, int x_pos, int y_pos) const
 {
   x_pos += size;
   y_pos += size;
@@ -70,12 +70,12 @@
   int start_x = std::max(0, -x_pos);
   int start_y = std::max(0, -y_pos);
   
-  int end_x = std::min(brush.width, target.get_width()  - x_pos);
-  int end_y = std::min(brush.rows,  target.get_height() - y_pos);
+  int end_x = std::min(brush.width, target-&gt;get_width()  - x_pos);
+  int end_y = std::min(brush.rows,  target-&gt;get_height() - y_pos);
 
-  unsigned char* target_buf = static_cast&lt;unsigned char*&gt;(target.get_pixels());
+  unsigned char* target_buf = static_cast&lt;unsigned char*&gt;(target-&gt;get_pixels());
 
-  int target_pitch = target.get_pitch();
+  int target_pitch = target-&gt;get_pitch();
 
   uint8_t red   = 0;
   uint8_t blue  = 0;

Modified: trunk/windstille/src/font/border_font_effect.hpp
===================================================================
--- trunk/windstille/src/font/border_font_effect.hpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/font/border_font_effect.hpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -45,7 +45,7 @@
   int get_x_offset(int orig_glyph_offset) const;
   int get_y_offset(int orig_glyph_offset) const;
   
-  void blit(const SoftwareSurface&amp; target, const FT_Bitmap&amp; brush, int x_pos, int y_pos) const;
+  void blit(SoftwareSurfacePtr target, const FT_Bitmap&amp; brush, int x_pos, int y_pos) const;
 
   /* disabled for g++-4.2 compatibilty
      private:

Modified: trunk/windstille/src/font/font_effect.hpp
===================================================================
--- trunk/windstille/src/font/font_effect.hpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/font/font_effect.hpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -22,9 +22,9 @@
 #include &lt;ft2build.h&gt;
 #include FT_FREETYPE_H
 #include FT_GLYPH_H
+
+#include &quot;display/software_surface.hpp&quot;
 
-class SoftwareSurface;
-
 /** 
  *  The FontEffect class manages the blitting from a glyph bitmap to
  *  the SDL_Surface, it allows to apply different kinds of effects to
@@ -46,7 +46,7 @@
   virtual int get_x_offset(int orig_glyph_offset) const =0;
   virtual int get_y_offset(int orig_glyph_offset) const =0;
   
-  virtual void blit(const SoftwareSurface&amp; target, const FT_Bitmap&amp; brush, int x_pos, int y_pos) const =0;
+  virtual void blit(SoftwareSurfacePtr target, const FT_Bitmap&amp; brush, int x_pos, int y_pos) const =0;
 
   /* disabled for g++-4.2 compatibilty
      private:

Modified: trunk/windstille/src/font/no_font_effect.cpp
===================================================================
--- trunk/windstille/src/font/no_font_effect.cpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/font/no_font_effect.cpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -20,17 +20,17 @@
 #include &quot;font/no_font_effect.hpp&quot;
 
 void
-NoFontEffect::blit(const SoftwareSurface&amp; target, const FT_Bitmap&amp; brush, int x_pos, int y_pos) const
+NoFontEffect::blit(SoftwareSurfacePtr target, const FT_Bitmap&amp; brush, int x_pos, int y_pos) const
 {
   int start_x = std::max(0, -x_pos);
   int start_y = std::max(0, -y_pos);
   
-  int end_x = std::min(brush.width, target.get_width()  - x_pos);
-  int end_y = std::min(brush.rows,  target.get_height() - y_pos);
+  int end_x = std::min(brush.width, target-&gt;get_width()  - x_pos);
+  int end_y = std::min(brush.rows,  target-&gt;get_height() - y_pos);
 
-  unsigned char* target_buf = static_cast&lt;unsigned char*&gt;(target.get_pixels());
+  unsigned char* target_buf = static_cast&lt;unsigned char*&gt;(target-&gt;get_pixels());
 
-  int target_pitch = target.get_pitch();
+  int target_pitch = target-&gt;get_pitch();
 
   for (int y = start_y; y &lt; end_y; ++y)
     for (int x = start_x; x &lt; end_x; ++x)

Modified: trunk/windstille/src/font/no_font_effect.hpp
===================================================================
--- trunk/windstille/src/font/no_font_effect.hpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/font/no_font_effect.hpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -36,7 +36,7 @@
   int get_x_offset(int orig_glyph_offset) const { return orig_glyph_offset; }
   int get_y_offset(int orig_glyph_offset) const { return orig_glyph_offset; }
   
-  void blit(const SoftwareSurface&amp; target, const FT_Bitmap&amp; brush, int x_pos, int y_pos) const;
+  void blit(SoftwareSurfacePtr target, const FT_Bitmap&amp; brush, int x_pos, int y_pos) const;
   
   /* disabled for g++-4.2 compatibilty
      private:

Modified: trunk/windstille/src/font/ttf_font.cpp
===================================================================
--- trunk/windstille/src/font/ttf_font.cpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/font/ttf_font.cpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -89,7 +89,7 @@
   FT_Select_Charmap(face,  FT_ENCODING_UNICODE);
 
   // FIXME: should calculate texture size, based on font size
-  SoftwareSurface pixelbuffer(1024, 1024);
+  SoftwareSurfacePtr pixelbuffer = SoftwareSurface::create(1024, 1024);
   
   int x_pos = 1;
   int y_pos = 1;
@@ -127,23 +127,23 @@
                      effect.get_y_offset(-face-&gt;glyph-&gt;bitmap_top)),
                Size(glyph_width, glyph_height));
 
-      Rectf uv(static_cast&lt;float&gt;(x_pos) / static_cast&lt;float&gt;(pixelbuffer.get_width()),
-               static_cast&lt;float&gt;(y_pos) / static_cast&lt;float&gt;(pixelbuffer.get_height()),
-               static_cast&lt;float&gt;(x_pos + glyph_width)/static_cast&lt;float&gt;(pixelbuffer.get_width()),
-               static_cast&lt;float&gt;(y_pos + glyph_height)/static_cast&lt;float&gt;(pixelbuffer.get_height()));
+      Rectf uv(static_cast&lt;float&gt;(x_pos) / static_cast&lt;float&gt;(pixelbuffer-&gt;get_width()),
+               static_cast&lt;float&gt;(y_pos) / static_cast&lt;float&gt;(pixelbuffer-&gt;get_height()),
+               static_cast&lt;float&gt;(x_pos + glyph_width)/static_cast&lt;float&gt;(pixelbuffer-&gt;get_width()),
+               static_cast&lt;float&gt;(y_pos + glyph_height)/static_cast&lt;float&gt;(pixelbuffer-&gt;get_height()));
       
       impl-&gt;characters.push_back(TTFCharacter(pos, uv,
                                               face-&gt;glyph-&gt;advance.x &gt;&gt; 6));
 
       // we leave a one pixel border around the letters which we fill with generate_border
       x_pos += glyph_width + 2;
-      if (x_pos + max_glyph_height + 2 &gt; pixelbuffer.get_width()) // FIXME: should use glyph_width of the next glyph instead of max_glyph_height
+      if (x_pos + max_glyph_height + 2 &gt; pixelbuffer-&gt;get_width()) // FIXME: should use glyph_width of the next glyph instead of max_glyph_height
       {
         y_pos += max_glyph_height + 2;
         x_pos = 1;
       }
 
-      if (y_pos + max_glyph_height + 2 &gt; pixelbuffer.get_height())
+      if (y_pos + max_glyph_height + 2 &gt; pixelbuffer-&gt;get_height())
         throw std::runtime_error(&quot;Font Texture to small&quot;);
     }
   }

Modified: trunk/windstille/src/gui/automap.cpp
===================================================================
--- trunk/windstille/src/gui/automap.cpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/gui/automap.cpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -43,26 +43,26 @@
 {
   TileMap* tilemap = Sector::current()-&gt;get_tilemap();
 
-  SoftwareSurface image(tilemap-&gt;get_width(), tilemap-&gt;get_height());
+  SoftwareSurfacePtr image = SoftwareSurface::create(tilemap-&gt;get_width(), tilemap-&gt;get_height());
   
-  unsigned char* buffer = static_cast&lt;unsigned char*&gt;(image.get_pixels());
+  unsigned char* buffer = static_cast&lt;unsigned char*&gt;(image-&gt;get_pixels());
 
-  for(int y = 0; y &lt; image.get_height(); ++y)
-    for(int x = 0; x &lt; image.get_width(); ++x)
+  for(int y = 0; y &lt; image-&gt;get_height(); ++y)
+    for(int x = 0; x &lt; image-&gt;get_width(); ++x)
     {
       if (tilemap-&gt;get_pixel(x, y))
       {
-        buffer[image.get_pitch() * y + 4*x + 0] = 255;
-        buffer[image.get_pitch() * y + 4*x + 1] = 255;
-        buffer[image.get_pitch() * y + 4*x + 2] = 255;
-        buffer[image.get_pitch() * y + 4*x + 3] = 255;
+        buffer[image-&gt;get_pitch() * y + 4*x + 0] = 255;
+        buffer[image-&gt;get_pitch() * y + 4*x + 1] = 255;
+        buffer[image-&gt;get_pitch() * y + 4*x + 2] = 255;
+        buffer[image-&gt;get_pitch() * y + 4*x + 3] = 255;
       }
       else
       {
-        buffer[image.get_pitch() * y + 4*x + 0] = 0;
-        buffer[image.get_pitch() * y + 4*x + 1] = 0;
-        buffer[image.get_pitch() * y + 4*x + 2] = 0;
-        buffer[image.get_pitch() * y + 4*x + 3] = 255;
+        buffer[image-&gt;get_pitch() * y + 4*x + 0] = 0;
+        buffer[image-&gt;get_pitch() * y + 4*x + 1] = 0;
+        buffer[image-&gt;get_pitch() * y + 4*x + 2] = 0;
+        buffer[image-&gt;get_pitch() * y + 4*x + 3] = 255;
       }
     }
 

Modified: trunk/windstille/src/tile/tile_description.cpp
===================================================================
--- trunk/windstille/src/tile/tile_description.cpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/tile/tile_description.cpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -45,7 +45,7 @@
 TileDescription::load(TileFactory* factory)
 {  
   // FIXM: SoftwareSurface image(Pathname(filename)); doesn't work, as its handled as function declaration!?
-  SoftwareSurface image = SoftwareSurface(Pathname(filename));
+  SoftwareSurfacePtr image = SoftwareSurface::create(Pathname(filename));
 
   int num_tiles = width * height; //(image-&gt;w/TILE_RESOLUTION) * (image-&gt;h/TILE_RESOLUTION);
   if (int(colmap.size()) != num_tiles)

Modified: trunk/windstille/src/tile/tile_factory.cpp
===================================================================
--- trunk/windstille/src/tile/tile_factory.cpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/tile/tile_factory.cpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -27,14 +27,14 @@
 #include &quot;display/software_surface.hpp&quot;
 
 /** Check if the given region of the given image is fully transparent */
-bool surface_empty(const SoftwareSurface&amp; image, int sx, int sy, int w, int h)
+bool surface_empty(SoftwareSurfacePtr image, int sx, int sy, int w, int h)
 { 
-  unsigned char* data = static_cast&lt;unsigned char*&gt;(image.get_pixels());
+  unsigned char* data = static_cast&lt;unsigned char*&gt;(image-&gt;get_pixels());
   
   for(int y = sy; y &lt; sy + h; ++y)
     for(int x = sx; x &lt; sx + w; ++x)
     {
-      if (data[y * image.get_pitch() + 4*x + 3] != 0)
+      if (data[y * image-&gt;get_pitch() + 4*x + 3] != 0)
       { 
         return false;
       }
@@ -117,7 +117,7 @@
 }
 
 void
-TileFactory::pack(int id, int colmap, const SoftwareSurface&amp; image, const Rect&amp; rect)
+TileFactory::pack(int id, int colmap, SoftwareSurfacePtr image, const Rect&amp; rect)
 {
   if(id &lt; int(tiles.size())
      &amp;&amp; tiles[id] != 0

Modified: trunk/windstille/src/tile/tile_factory.hpp
===================================================================
--- trunk/windstille/src/tile/tile_factory.hpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/tile/tile_factory.hpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -22,6 +22,7 @@
 #include &lt;map&gt;
 #include &lt;string&gt;
 
+#include &quot;display/software_surface.hpp&quot;
 #include &quot;tile/tile_description.hpp&quot;
 #include &quot;util/currenton.hpp&quot;
 
@@ -63,7 +64,7 @@
   /** 
    * Adds a surface to the TileFactory
    */
-  void pack(int id, int colmap, const SoftwareSurface&amp; image, const Rect&amp; rect);
+  void pack(int id, int colmap, SoftwareSurfacePtr image, const Rect&amp; rect);
 
 private:
   void parse_tiles(FileReader&amp; reader);

Modified: trunk/windstille/src/tile/tile_packer.cpp
===================================================================
--- trunk/windstille/src/tile/tile_packer.cpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/tile/tile_packer.cpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -67,12 +67,12 @@
 /** Pack a tile and return the position where it is placed in the
     pixel buffer */
 Rectf
-TilePacker::pack(const SoftwareSurface&amp; image, int x, int y, int w, int h)
+TilePacker::pack(SoftwareSurfacePtr image, int x, int y, int w, int h)
 {
   assert(w == TILE_RESOLUTION &amp;&amp; h == TILE_RESOLUTION);
   assert(!is_full());
 
-  SoftwareSurface convert(w+2, h+2);
+  SoftwareSurfacePtr convert = SoftwareSurface::create(w+2, h+2);
 
   SDL_Rect source_rect;
   source_rect.x = static_cast&lt;Sint16&gt;(x);
@@ -86,7 +86,7 @@
   dest_rect.w = static_cast&lt;Sint16&gt;(w);
   dest_rect.h = static_cast&lt;Sint16&gt;(h);
 
-  SDL_BlitSurface(image.get_surface(), &amp;source_rect, convert.get_surface(), &amp;dest_rect);
+  SDL_BlitSurface(image-&gt;get_surface(), &amp;source_rect, convert-&gt;get_surface(), &amp;dest_rect);
 
   generate_border(convert, 1, 1, TILE_RESOLUTION, TILE_RESOLUTION);
 

Modified: trunk/windstille/src/tile/tile_packer.hpp
===================================================================
--- trunk/windstille/src/tile/tile_packer.hpp	2010-09-22 10:16:26 UTC (rev 3364)
+++ trunk/windstille/src/tile/tile_packer.hpp	2010-09-22 10:46:51 UTC (rev 3365)
@@ -42,7 +42,7 @@
 
   /** Pack a tile and return the position where it is placed in the
       pixel buffer */
-  Rectf pack(const SoftwareSurface&amp; image, int x, int y, int w, int h);
+  Rectf pack(SoftwareSurfacePtr image, int x, int y, int w, int h);
 
   /** Return true if the PixelBuffer is full */
   bool is_full() const;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002361.html">[Windstille-commit] r3364 - in trunk/windstille/src: display gui	objects particles scenegraph sprite2d
</A></li>
	<LI>Next message: <A HREF="002363.html">[Windstille-commit] r3366 - trunk/windstille/src/display
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2362">[ date ]</a>
              <a href="thread.html#2362">[ thread ]</a>
              <a href="subject.html#2362">[ subject ]</a>
              <a href="author.html#2362">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/windstille-commit">More information about the Windstille-commit
mailing list</a><br>
</body></html>
