<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Windstille-commit] r3363 - in trunk/windstille/src: armature	display font gui objects particles scenegraph screen sprite3d tile
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/windstille-commit/2010-September/index.html" >
   <LINK REL="made" HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r3363%20-%20in%20trunk/windstille/src%3A%20armature%0A%09display%20font%20gui%20objects%20particles%20scenegraph%20screen%20sprite3d%20tile&In-Reply-To=%3C20100921215403.44983480AC8%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002359.html">
   <LINK REL="Next"  HREF="002361.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Windstille-commit] r3363 - in trunk/windstille/src: armature	display font gui objects particles scenegraph screen sprite3d tile</H1>
    <B>grumbel at mail.berlios.de</B> 
    <A HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r3363%20-%20in%20trunk/windstille/src%3A%20armature%0A%09display%20font%20gui%20objects%20particles%20scenegraph%20screen%20sprite3d%20tile&In-Reply-To=%3C20100921215403.44983480AC8%40sheep.berlios.de%3E"
       TITLE="[Windstille-commit] r3363 - in trunk/windstille/src: armature	display font gui objects particles scenegraph screen sprite3d tile">grumbel at mail.berlios.de
       </A><BR>
    <I>Tue Sep 21 23:54:03 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002359.html">[Windstille-commit] r3362 - trunk/windstille/src/display
</A></li>
        <LI>Next message: <A HREF="002361.html">[Windstille-commit] r3364 - in trunk/windstille/src: display gui	objects particles scenegraph sprite2d
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2360">[ date ]</a>
              <a href="thread.html#2360">[ thread ]</a>
              <a href="subject.html#2360">[ subject ]</a>
              <a href="author.html#2360">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: grumbel
Date: 2010-09-21 23:54:02 +0200 (Tue, 21 Sep 2010)
New Revision: 3363

Modified:
   trunk/windstille/src/armature/mesh.hpp
   trunk/windstille/src/display/drawing_context.cpp
   trunk/windstille/src/display/drawing_context.hpp
   trunk/windstille/src/display/framebuffer.cpp
   trunk/windstille/src/display/framebuffer.hpp
   trunk/windstille/src/display/opengl_state.cpp
   trunk/windstille/src/display/opengl_state.hpp
   trunk/windstille/src/display/surface.cpp
   trunk/windstille/src/display/surface.hpp
   trunk/windstille/src/display/surface_manager.cpp
   trunk/windstille/src/display/surface_manager.hpp
   trunk/windstille/src/display/texture.cpp
   trunk/windstille/src/display/texture.hpp
   trunk/windstille/src/display/texture_manager.cpp
   trunk/windstille/src/display/texture_manager.hpp
   trunk/windstille/src/display/texture_packer.cpp
   trunk/windstille/src/display/texture_packer.hpp
   trunk/windstille/src/font/ttf_font.cpp
   trunk/windstille/src/font/ttf_font.hpp
   trunk/windstille/src/gui/automap.cpp
   trunk/windstille/src/objects/laser_pointer.cpp
   trunk/windstille/src/objects/laser_pointer.hpp
   trunk/windstille/src/objects/liquid.cpp
   trunk/windstille/src/objects/liquid.hpp
   trunk/windstille/src/objects/nightvision.cpp
   trunk/windstille/src/objects/nightvision.hpp
   trunk/windstille/src/objects/shockwave.cpp
   trunk/windstille/src/objects/shockwave.hpp
   trunk/windstille/src/particles/deform_drawer.cpp
   trunk/windstille/src/scenegraph/fill_screen_pattern_drawable.hpp
   trunk/windstille/src/scenegraph/shockwave_drawable.hpp
   trunk/windstille/src/scenegraph/vertex_array_drawable.cpp
   trunk/windstille/src/scenegraph/vertex_array_drawable.hpp
   trunk/windstille/src/screen/particle_viewer.cpp
   trunk/windstille/src/sprite3d/data.hpp
   trunk/windstille/src/tile/tile.hpp
   trunk/windstille/src/tile/tile_packer.cpp
   trunk/windstille/src/tile/tile_packer.hpp
Log:
Replaced Texture with TexturePtr


Modified: trunk/windstille/src/armature/mesh.hpp
===================================================================
--- trunk/windstille/src/armature/mesh.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/armature/mesh.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -85,7 +85,7 @@
   typedef std::vector&lt;Vertex&gt; Vertices;
   Vertices vertices_;
 
-  Texture texture;
+  TexturePtr texture;
 
   GLenum blend_sfactor;
   GLenum blend_dfactor;

Modified: trunk/windstille/src/display/drawing_context.cpp
===================================================================
--- trunk/windstille/src/display/drawing_context.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/drawing_context.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -146,7 +146,7 @@
 }
 
 void
-DrawingContext::fill_pattern(const Texture&amp; pattern, const Vector2f&amp; offset)
+DrawingContext::fill_pattern(TexturePtr pattern, const Vector2f&amp; offset)
 {
   draw(new FillScreenPatternDrawable(pattern, offset));
 }

Modified: trunk/windstille/src/display/drawing_context.hpp
===================================================================
--- trunk/windstille/src/display/drawing_context.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/drawing_context.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -22,8 +22,8 @@
 #include &lt;vector&gt;
 
 #include &quot;scenegraph/drawable.hpp&quot;
+#include &quot;display/texture.hpp&quot;
 
-class Texture;
 class Surface;
 class SurfaceDrawingParameters;
 class DrawingParameters;
@@ -63,7 +63,7 @@
       queue */
   void fill_screen(const Color&amp; color);
 
-  void fill_pattern(const Texture&amp; pattern, const Vector2f&amp; offset);
+  void fill_pattern(TexturePtr pattern, const Vector2f&amp; offset);
 
   void draw_line(const Line&amp; line, const Color&amp; color, float z_pos = 0);
   void draw_line(const Vector2f&amp; pos1, const Vector2f&amp; pos2, const Color&amp; color, float z_pos = 0);

Modified: trunk/windstille/src/display/framebuffer.cpp
===================================================================
--- trunk/windstille/src/display/framebuffer.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/framebuffer.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -64,7 +64,7 @@
   glDeleteFramebuffersEXT(1, &amp;m_handle);  
 }
 
-Texture
+TexturePtr
 Framebuffer::get_texture()
 {
   assert(m_texture);
@@ -94,14 +94,14 @@
 Framebuffer::create_with_texture_internal(GLenum target, int width, int height, int multisample)
 {
   m_size = Size(width, height);
-  m_texture = Texture(target, width, height);
+  m_texture = Texture::create(target, width, height);
   m_depth_stencil_buffer = Renderbuffer::create(GL_DEPTH24_STENCIL8_EXT, width, height, multisample);
     
   // FIXME: Should use push/pop_framebuffer instead, but don't have pointer to Framebuffer here
   glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, m_handle);
 
   // bind texture and renderbuffers to the framebuffer
-  glFramebufferTexture2DEXT(GL_FRAMEBUFFER_EXT, GL_COLOR_ATTACHMENT0_EXT, m_texture.get_target(), m_texture.get_handle(), 0);
+  glFramebufferTexture2DEXT(GL_FRAMEBUFFER_EXT, GL_COLOR_ATTACHMENT0_EXT, m_texture-&gt;get_target(), m_texture-&gt;get_handle(), 0);
   glFramebufferRenderbufferEXT(GL_FRAMEBUFFER_EXT, GL_DEPTH_ATTACHMENT_EXT,   GL_RENDERBUFFER_EXT, m_depth_stencil_buffer-&gt;get_handle());
   glFramebufferRenderbufferEXT(GL_FRAMEBUFFER_EXT, GL_STENCIL_ATTACHMENT_EXT, GL_RENDERBUFFER_EXT, m_depth_stencil_buffer-&gt;get_handle());
 

Modified: trunk/windstille/src/display/framebuffer.hpp
===================================================================
--- trunk/windstille/src/display/framebuffer.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/framebuffer.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -38,7 +38,7 @@
 
   int get_width()  const;
   int get_height() const;
-  Texture get_texture();
+  TexturePtr get_texture();
 
   GLuint get_handle() const;
 
@@ -52,7 +52,7 @@
   GLuint m_handle;
   Size   m_size;
   
-  Texture m_texture;
+  TexturePtr m_texture;
   RenderbufferPtr m_color_buffer;
   RenderbufferPtr m_depth_stencil_buffer;
 };

Modified: trunk/windstille/src/display/opengl_state.cpp
===================================================================
--- trunk/windstille/src/display/opengl_state.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/opengl_state.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -33,7 +33,7 @@
       somebody forget the final activate() call */
   bool was_activated;
 
-  Texture     texture[MAX_TEXTURE_UNITS];
+  TexturePtr texture[MAX_TEXTURE_UNITS];
 
   Color color;
 
@@ -46,13 +46,13 @@
   /** glEnableClientState/glDisableClientState */
   std::map&lt;GLenum, bool&gt; client_state;
 
-  OpenGLStateImpl()
-    : was_activated(false),
-      color(),
-      blend_sfactor(GL_SRC_ALPHA),
-      blend_dfactor(GL_ONE_MINUS_SRC_ALPHA),
-      state(),
-      client_state()
+  OpenGLStateImpl() :
+    was_activated(false),
+    color(),
+    blend_sfactor(GL_SRC_ALPHA),
+    blend_dfactor(GL_ONE_MINUS_SRC_ALPHA),
+    state(),
+    client_state()
   {}
 };
 
@@ -115,7 +115,7 @@
 }
 
 void
-OpenGLState::bind_texture(const Texture&amp; texture, int unit)
+OpenGLState::bind_texture(TexturePtr texture, int unit)
 {
   assert(unit &gt;= 0 &amp;&amp; unit &lt; MAX_TEXTURE_UNITS);
   impl-&gt;texture[unit] = texture;
@@ -282,10 +282,10 @@
       {
         global_state-&gt;impl-&gt;texture[i] = impl-&gt;texture[i];
 
-        switch (impl-&gt;texture[i].get_target())
+        switch (impl-&gt;texture[i]-&gt;get_target())
         {                 
           case GL_TEXTURE_2D:
-            glBindTexture(GL_TEXTURE_2D, impl-&gt;texture[i].get_handle());
+            glBindTexture(GL_TEXTURE_2D, impl-&gt;texture[i]-&gt;get_handle());
             glEnable(GL_TEXTURE_2D);
             break;
                   
@@ -350,9 +350,9 @@
     GLint texture_handle;
     glActiveTexture(GL_TEXTURE0);
     glGetIntegerv(GL_TEXTURE_2D_BINDING_EXT, &amp;texture_handle);
-    if (impl-&gt;texture[0] &amp;&amp; static_cast&lt;GLuint&gt;(texture_handle) != impl-&gt;texture[0].get_handle())
+    if (impl-&gt;texture[0] &amp;&amp; static_cast&lt;GLuint&gt;(texture_handle) != impl-&gt;texture[0]-&gt;get_handle())
     {
-      std::cout &lt;&lt; &quot;OpenGLState: texture handle is out of sync: &quot; &lt;&lt; impl-&gt;texture[0].get_handle() &lt;&lt; std::endl;
+      std::cout &lt;&lt; &quot;OpenGLState: texture handle is out of sync: &quot; &lt;&lt; impl-&gt;texture[0]-&gt;get_handle() &lt;&lt; std::endl;
     }
   }
   assert_gl(&quot;OpenGLState::verify&quot;);

Modified: trunk/windstille/src/display/opengl_state.hpp
===================================================================
--- trunk/windstille/src/display/opengl_state.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/opengl_state.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -22,8 +22,9 @@
 #include &lt;GL/glew.h&gt;
 #include &lt;boost/scoped_ptr.hpp&gt;
 
+#include &quot;display/texture.hpp&quot;
+
 class Framebuffer;
-class Texture;
 class Color;
 class OpenGLStateImpl;
 
@@ -71,7 +72,7 @@
    * Binds the given \a texture to the given texture \a unit and
    * enables texturing via glEnable(GL_TEXTURE2D) for the unit.
    */
-  void bind_texture(const Texture&amp; texture, int unit = 0);
+  void bind_texture(TexturePtr texture, int unit = 0);
 
   void set_blend_func(GLenum sfactor, GLenum dfactor);
 

Modified: trunk/windstille/src/display/surface.cpp
===================================================================
--- trunk/windstille/src/display/surface.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/surface.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -29,7 +29,7 @@
   /**
    * Texture on which the surface is located
    */
-  Texture texture;
+  TexturePtr texture;
 
   /** 
    * uv coordinates of the Surface in [0,1] range
@@ -41,10 +41,10 @@
    */
   Sizef size;
 
-  SurfaceImpl()
-    : texture(),
-      uv(),
-      size()
+  SurfaceImpl() :
+    texture(),
+    uv(),
+    size()
   {}
 };
 
@@ -65,13 +65,13 @@
 {
   impl-&gt;size  = Size(width, height);
 
-  impl-&gt;texture = Texture(GL_TEXTURE_2D, width, height);
+  impl-&gt;texture = Texture::create(GL_TEXTURE_2D, width, height);
   impl-&gt;uv      = Rectf(0.0f, 0.0f,
-                        impl-&gt;size.width  / static_cast&lt;float&gt;(impl-&gt;texture.get_width()),
-                        impl-&gt;size.height / static_cast&lt;float&gt;(impl-&gt;texture.get_height()));
+                        impl-&gt;size.width  / static_cast&lt;float&gt;(impl-&gt;texture-&gt;get_width()),
+                        impl-&gt;size.height / static_cast&lt;float&gt;(impl-&gt;texture-&gt;get_height()));
 }
 
-Surface::Surface(Texture texture, const Rectf&amp; uv, const Sizef&amp; size) :
+Surface::Surface(TexturePtr texture, const Rectf&amp; uv, const Sizef&amp; size) :
   impl(new SurfaceImpl())
 {
   impl-&gt;texture = texture;
@@ -95,7 +95,7 @@
   return impl-&gt;size.height; 
 }
 
-Texture
+TexturePtr
 Surface::get_texture() const
 {
   return impl-&gt;texture;

Modified: trunk/windstille/src/display/surface.hpp
===================================================================
--- trunk/windstille/src/display/surface.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/surface.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -44,14 +44,14 @@
    * @param width  Width of the surface on the screen
    * @param height Height of the surface on the screen
    */
-  Surface(Texture texture, const Rectf&amp; uv, const Sizef&amp; size);
+  Surface(TexturePtr texture, const Rectf&amp; uv, const Sizef&amp; size);
   Surface(int width, int height);
   ~Surface();
   
   float get_width()  const;
   float get_height() const;
   
-  Texture get_texture() const;
+  TexturePtr get_texture() const;
 
   /** Returns texture coordinates for the Surface rectangle */
   Rectf get_uv() const;

Modified: trunk/windstille/src/display/surface_manager.cpp
===================================================================
--- trunk/windstille/src/display/surface_manager.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/surface_manager.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -68,7 +68,7 @@
     {
       float maxu = 0.0f;
       float maxv = 0.0f;
-      Texture texture;
+      TexturePtr texture;
 
       try
       {
@@ -98,7 +98,7 @@
   SoftwareSurface image(filename);
   float maxu, maxv;
 
-  Texture texture;
+  TexturePtr texture;
 
   try
   {                                                                       
@@ -128,7 +128,7 @@
   }
 }
 
-Texture
+TexturePtr
 SurfaceManager::create_texture(const SoftwareSurface&amp; image,
                                float* maxu, float* maxv)
 {
@@ -140,7 +140,7 @@
 
   image.blit(convert, 0, 0);
 
-  Texture texture = Texture(convert);
+  TexturePtr texture = Texture::create(convert);
   
   *maxu = static_cast&lt;float&gt;(image.get_width())  / static_cast&lt;float&gt;(texture_w);
   *maxv = static_cast&lt;float&gt;(image.get_height()) / static_cast&lt;float&gt;(texture_h);

Modified: trunk/windstille/src/display/surface_manager.hpp
===================================================================
--- trunk/windstille/src/display/surface_manager.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/surface_manager.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -56,8 +56,8 @@
   void load_grid(const Pathname&amp; filename,
                  std::vector&lt;Surface&gt;&amp; surfaces, int width, int height);
 
-  Texture create_texture(const SoftwareSurface&amp; image,
-                         float* maxu, float* maxv);
+  TexturePtr create_texture(const SoftwareSurface&amp; image,
+                            float* maxu, float* maxv);
 
   /** Removes all cached Sprites that are no longer in use */
   void cleanup();

Modified: trunk/windstille/src/display/texture.cpp
===================================================================
--- trunk/windstille/src/display/texture.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/texture.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -28,51 +28,49 @@
 #include &quot;display/texture_manager.hpp&quot;
 #include &quot;display/assert_gl.hpp&quot;
 
-class TextureImpl
+static inline bool is_power_of_2(int v)
 {
-public:
-  GLenum target;
-  GLuint handle;
-  int    width;
-  int    height;
-
-  TextureImpl()
-    : target(0),
-      handle(0),
-      width(0),
-      height(0)
-  {
-    glGenTextures(1, &amp;handle);
-    assert_gl(&quot;creating texture handle.&quot;); 
-  }
-
-  ~TextureImpl()
-  {
-    glDeleteTextures(1, &amp;handle);
-  }
-};
+  return (v &amp; (v-1)) == 0;
+}
 
-Texture::Texture() :
-  impl()
+TexturePtr
+Texture::create(const Pathname&amp; filename)
 {
+  return TextureManager::current()-&gt;get(filename);
 }
 
-Texture::Texture(const Pathname&amp; filename) :
-  impl()
+TexturePtr
+Texture::create(const SoftwareSurface&amp; image, GLint format)
 {
-  *this = TextureManager::current()-&gt;get(filename);
+  return TexturePtr(new Texture(image, format));
 }
+  
+TexturePtr
+Texture::create(GLenum target, int width, int height, GLint format)
+{
+  return TexturePtr(new Texture(target, width, height, format));
+}
+
+Texture::Texture() :
+  m_target(0),
+  m_handle(0),
+  m_width(0),
+  m_height(0)
+{
+  glGenTextures(1, &amp;m_handle);
+  assert_gl(&quot;Texture::Texture()&quot;); 
+}
 
 Texture::Texture(GLenum target, int width, int height, GLint format) :
-  impl(new TextureImpl())
+  m_target(target),
+  m_handle(0),
+  m_width(width),
+  m_height(height)
 {
-  impl-&gt;target = target;
-  impl-&gt;width  = width;
-  impl-&gt;height = height;
+  glGenTextures(1, &amp;m_handle);
+  assert_gl(&quot;Texture::Texture()&quot;); 
 
-  OpenGLState state;
-  state.bind_texture(*this);
-  state.activate();
+  glBindTexture(GL_TEXTURE_2D, m_handle);
 
   glTexImage2D(target, 0, format, width, height, 0, GL_RGBA,
                GL_UNSIGNED_BYTE, 0);
@@ -84,17 +82,14 @@
   glTexParameteri(target, GL_TEXTURE_WRAP_R, GL_CLAMP_TO_EDGE);
 }
 
-static inline bool is_power_of_2(int v)
-{
-  return (v &amp; (v-1)) == 0;
-}
-
 Texture::Texture(const SoftwareSurface&amp; image, GLint glformat) :
-  impl(new TextureImpl())
+  m_target(GL_TEXTURE_2D),
+  m_handle(0),
+  m_width(image.get_width()),
+  m_height(image.get_height())
 {
-  impl-&gt;target = GL_TEXTURE_2D;
-  impl-&gt;width  = image.get_width();
-  impl-&gt;height = image.get_height();
+  glGenTextures(1, &amp;m_handle);
+  assert_gl(&quot;Texture::Texture()&quot;); 
 
   // Should be ok with OpenGL2.0
   //if(!is_power_of_2(image.get_width()) || !is_power_of_2(image.get_height()))
@@ -131,25 +126,23 @@
       throw std::runtime_error(&quot;Texture: Image format not supported&quot;);
     }
 
-    OpenGLState state;
-    state.bind_texture(*this);
-    state.activate();
+    glBindTexture(GL_TEXTURE_2D, m_handle);
 
     glPixelStorei(GL_UNPACK_ALIGNMENT, 1);
     glPixelStorei(GL_UNPACK_ROW_LENGTH, image.get_pitch() / image.get_bytes_per_pixel());
 
     if (0)
     { // no mipmapping
-      glTexImage2D(impl-&gt;target, 0, glformat,
+      glTexImage2D(m_target, 0, glformat,
                    image.get_width(), image.get_height(), 0, sdl_format,
                    GL_UNSIGNED_BYTE, image.get_pixels());
         
-      glTexParameteri(impl-&gt;target, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
-      glTexParameteri(impl-&gt;target, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
+      glTexParameteri(m_target, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
+      glTexParameteri(m_target, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
     }
     else
     { // use mipmapping
-      gluBuild2DMipmaps(impl-&gt;target, glformat,
+      gluBuild2DMipmaps(m_target, glformat,
                         image.get_width(), image.get_height(), sdl_format,
                         GL_UNSIGNED_BYTE, image.get_pixels());
         
@@ -159,9 +152,9 @@
 
     assert_gl(&quot;creating texture&quot;);
 
-    glTexParameteri(impl-&gt;target, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
-    glTexParameteri(impl-&gt;target, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
-    glTexParameteri(impl-&gt;target, GL_TEXTURE_WRAP_R, GL_CLAMP_TO_EDGE);
+    glTexParameteri(m_target, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
+    glTexParameteri(m_target, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
+    glTexParameteri(m_target, GL_TEXTURE_WRAP_R, GL_CLAMP_TO_EDGE);
 
     assert_gl(&quot;setting texture parameters&quot;);
   } 
@@ -173,24 +166,25 @@
 
 Texture::~Texture()
 {
+  glDeleteTextures(1, &amp;m_handle);
 }
 
 int
 Texture::get_width() const
 {
-  return impl-&gt;width;
+  return m_width;
 }
 
 int
 Texture::get_height() const
 {
-  return impl-&gt;height;
+  return m_height;
 }
 
 GLuint
 Texture::get_handle() const
 {
-  return impl-&gt;handle;
+  return m_handle;
 }
 
 void
@@ -211,16 +205,14 @@
     throw std::runtime_error(&quot;Texture: Image format not supported&quot;);
   }
 
-  OpenGLState state;
-  state.bind_texture(*this);
-  state.activate();
+  glBindTexture(GL_TEXTURE_2D, m_handle);
 
   // FIXME: Add some checks here to make sure image has the right format 
   glPixelStorei(GL_UNPACK_ALIGNMENT, 4); // FIXME: Does SDL always use 4?
   glPixelStorei(GL_UNPACK_ROW_LENGTH,
                 image.get_pitch() / image.get_bytes_per_pixel());
 
-  glTexSubImage2D(impl-&gt;target, 0, x, y,
+  glTexSubImage2D(m_target, 0, x, y,
                   srcrect.get_width(), srcrect.get_height(), sdl_format, GL_UNSIGNED_BYTE,
                   static_cast&lt;uint8_t*&gt;(image.get_pixels())
                   + srcrect.top  * image.get_pitch()
@@ -236,67 +228,38 @@
 void
 Texture::set_wrap(GLenum mode)
 {
-  OpenGLState state;
-  state.bind_texture(*this);
-  state.activate();
+  glBindTexture(GL_TEXTURE_2D, m_handle);
 
-  glTexParameteri(impl-&gt;target, GL_TEXTURE_WRAP_S, mode);
-  glTexParameteri(impl-&gt;target, GL_TEXTURE_WRAP_T, mode);
-  glTexParameteri(impl-&gt;target, GL_TEXTURE_WRAP_R, mode); // FIXME: only good for 3d textures?!
+  glTexParameteri(m_target, GL_TEXTURE_WRAP_S, mode);
+  glTexParameteri(m_target, GL_TEXTURE_WRAP_T, mode);
+  glTexParameteri(m_target, GL_TEXTURE_WRAP_R, mode); // FIXME: only good for 3d textures?!
 }
 
 void
 Texture::set_filter(GLenum mode)
 {
-  OpenGLState state;
-  state.bind_texture(*this);
-  state.activate();
+  glBindTexture(GL_TEXTURE_2D, m_handle);
 
-  glTexParameteri(impl-&gt;target, GL_TEXTURE_MIN_FILTER, mode);
-  glTexParameteri(impl-&gt;target, GL_TEXTURE_MAG_FILTER, mode);
+  glTexParameteri(m_target, GL_TEXTURE_MIN_FILTER, mode);
+  glTexParameteri(m_target, GL_TEXTURE_MAG_FILTER, mode);
 }
 
 SoftwareSurface
 Texture::get_software_surface() const
 {
-  OpenGLState state;
-  state.bind_texture(*this);
-  state.activate();
+  glBindTexture(GL_TEXTURE_2D, m_handle);
 
-  SoftwareSurface surface(impl-&gt;width, impl-&gt;height);
+  SoftwareSurface surface(m_width, m_height);
 
   glGetTexImage(GL_TEXTURE_2D, 0, GL_RGBA, GL_UNSIGNED_BYTE, surface.get_pixels());
 
   return surface;
 }
 
-Texture::operator bool() const
-{
-  return impl.get();
-}
-
-bool
-Texture::operator==(const Texture&amp; other) const
-{
-  return impl.get() == other.impl.get();
-}
-
-bool
-Texture::operator!=(const Texture&amp; other) const
-{
-  return impl.get() != other.impl.get();
-}
-
 GLenum
 Texture::get_target() const
 {
-  return impl-&gt;target;
+  return m_target;
 }
-
-int
-Texture::use_count() const
-{
-  return impl.use_count();
-}
 
 /* EOF */

Modified: trunk/windstille/src/display/texture.hpp
===================================================================
--- trunk/windstille/src/display/texture.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/texture.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -31,32 +31,34 @@
 class TextureImpl;
 class Rect;
 
+class Texture;
+typedef boost::shared_ptr&lt;Texture&gt; TexturePtr;
+
 class Texture
 {
 public:
-  /** Create a empty and invalid Texture object (similar to a
-      NULL-pointer) */
-  explicit Texture();
-
   /** Load a texture from file */
-  explicit Texture(const Pathname&amp; filename);
+  static TexturePtr create(const Pathname&amp; filename);
 
   /**
    * Upload an SoftwareSurface onto an OpenGL texture. The surface must have power
    * of 2 dimensions
    * */
-  explicit Texture(const SoftwareSurface&amp; image, GLint format = GL_RGBA);
-
+  static TexturePtr create(const SoftwareSurface&amp; image, GLint format = GL_RGBA);
+  
   /** 
    * Create an empty Texture with the given dimensions
    */
-  explicit Texture(GLenum target, int width, int height, GLint format = GL_RGBA);
+  static TexturePtr create(GLenum target, int width, int height, GLint format = GL_RGBA);
+  
+private:
+  Texture();
+  Texture(const SoftwareSurface&amp; image, GLint format = GL_RGBA);
+  Texture(GLenum target, int width, int height, GLint format = GL_RGBA);
 
+public:
   ~Texture();
 
-  bool operator==(const Texture&amp;) const;
-  bool operator!=(const Texture&amp;) const;
-
   int get_width() const;
   int get_height() const;
 
@@ -83,13 +85,11 @@
 
   SoftwareSurface get_software_surface() const;
 
-  int use_count() const;
-
-  /** true if the Texture is valid and usable, false if not */
-  operator bool() const;
-
 private:
-  boost::shared_ptr&lt;TextureImpl&gt; impl;
+  GLenum m_target;
+  GLuint m_handle;
+  int    m_width;
+  int    m_height;
 };
 
 #endif

Modified: trunk/windstille/src/display/texture_manager.cpp
===================================================================
--- trunk/windstille/src/display/texture_manager.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/texture_manager.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -38,7 +38,7 @@
 #endif
 }
 
-Texture
+TexturePtr
 TextureManager::get(const Pathname&amp; filename)
 {
   Textures::iterator i = textures.find(filename);
@@ -51,7 +51,7 @@
     try 
     {
       SoftwareSurface image(filename);
-      Texture texture(image);
+      TexturePtr texture = Texture::create(image);
 
       textures.insert(std::make_pair(filename, texture));
 

Modified: trunk/windstille/src/display/texture_manager.hpp
===================================================================
--- trunk/windstille/src/display/texture_manager.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/texture_manager.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -24,11 +24,10 @@
 #include &lt;GL/glew.h&gt;
 #include &lt;GL/gl.h&gt;
 
+#include &quot;display/texture.hpp&quot;
 #include &quot;util/currenton.hpp&quot;
 #include &quot;util/pathname.hpp&quot;
 
-class Texture;
-
 /**
  * This class manages a map of image files to OpenGL textures.
  */
@@ -46,12 +45,12 @@
    * SurfaceManager for images with other dimensions.
    * Note: Texture is a refcounted class, store it with Ref&lt;Texture&gt;
    */
-  Texture get(const Pathname&amp; filename);
+  TexturePtr get(const Pathname&amp; filename);
 
   void cleanup();
 
 private:
-  typedef std::map&lt;Pathname, Texture&gt; Textures;
+  typedef std::map&lt;Pathname, TexturePtr&gt; Textures;
   Textures textures;
 };
 

Modified: trunk/windstille/src/display/texture_packer.cpp
===================================================================
--- trunk/windstille/src/display/texture_packer.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/texture_packer.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -33,11 +33,11 @@
   boost::scoped_ptr&lt;TextureSpace&gt; right;
 
 public:
-  TextureSpace(const Rect&amp; rect_)
-    : rect(rect_),
-      used(false),
-      left(),
-      right()
+  TextureSpace(const Rect&amp; rect_) :
+    rect(rect_),
+    used(false),
+    left(),
+    right()
   {}
 
   ~TextureSpace()
@@ -87,12 +87,12 @@
 class TexturePackerTexture
 {
 private:
-  Texture        texture;
+  TexturePtr     texture;
   TextureSpace   space;
 
 public:
   TexturePackerTexture(const Size&amp; size)
-    : texture(GL_TEXTURE_2D, size.width, size.height),
+    : texture(Texture::create(GL_TEXTURE_2D, size.width, size.height)),
       space(Rect(Point(0, 0), size))
   {
   }
@@ -100,9 +100,9 @@
   ~TexturePackerTexture()
   {}
 
-  Texture get_texture() const { return texture; }
+  TexturePtr get_texture() const { return texture; }
 
-  bool allocate(const Size&amp; size, Rect&amp; out_rect, Texture&amp; out_texture)
+  bool allocate(const Size&amp; size, Rect&amp; out_rect, TexturePtr&amp; out_texture)
   {
     if (space.allocate(size, out_rect))
     {
@@ -134,18 +134,18 @@
 }
   
 bool
-TexturePacker::allocate(const Size&amp; size, Rect&amp; rect, Texture&amp; texture)
+TexturePacker::allocate(const Size&amp; size, Rect&amp; rect, TexturePtr&amp; out_texture)
 {
   for(Textures::iterator i = textures.begin(); i != textures.end(); ++i)
   {
-    if ((*i)-&gt;allocate(size, rect, texture))
+    if ((*i)-&gt;allocate(size, rect, out_texture))
     {
       return true;
     }
   }
 
   textures.push_back(new TexturePackerTexture(texture_size));
-  return textures.back()-&gt;allocate(size, rect, texture);
+  return textures.back()-&gt;allocate(size, rect, out_texture);
 }
 
 Surface
@@ -156,7 +156,7 @@
 
   Size    size(surface.get_width()+2, surface.get_height()+2);
   Rect    rect;
-  Texture texture;
+  TexturePtr texture;
 
   if (!allocate(size, rect, texture))
   {
@@ -167,36 +167,36 @@
     // duplicate border pixel
 
     // top
-    texture.put(surface, Rect(Point(0, 0), Size(surface.get_width(), 1)), 
+    texture-&gt;put(surface, Rect(Point(0, 0), Size(surface.get_width(), 1)), 
                 rect.left+1, rect.top);
     // bottom
-    texture.put(surface, Rect(Point(0, surface.get_height()-1), Size(surface.get_width(), 1)), 
+    texture-&gt;put(surface, Rect(Point(0, surface.get_height()-1), Size(surface.get_width(), 1)), 
                 rect.left+1, rect.bottom-1);
     // left
-    texture.put(surface, Rect(Point(0, 0), Size(1, surface.get_height())), 
+    texture-&gt;put(surface, Rect(Point(0, 0), Size(1, surface.get_height())), 
                 rect.left, rect.top+1);
     // right
-    texture.put(surface, Rect(Point(surface.get_width()-1, 0), Size(1, surface.get_height())),
+    texture-&gt;put(surface, Rect(Point(surface.get_width()-1, 0), Size(1, surface.get_height())),
                 rect.right-1, rect.top+1);
 
     // duplicate corner pixels
-    texture.put(surface, Rect(Point(0, 0), Size(1, 1)), 
+    texture-&gt;put(surface, Rect(Point(0, 0), Size(1, 1)), 
                 rect.left, rect.top);     
-    texture.put(surface, Rect(Point(surface.get_width()-1, 0), Size(1, 1)), 
+    texture-&gt;put(surface, Rect(Point(surface.get_width()-1, 0), Size(1, 1)), 
                 rect.right-1, rect.top);
-    texture.put(surface, Rect(Point(surface.get_width()-1, surface.get_height()-1), Size(1, 1)), 
+    texture-&gt;put(surface, Rect(Point(surface.get_width()-1, surface.get_height()-1), Size(1, 1)), 
                 rect.right-1, rect.bottom-1);
-    texture.put(surface, Rect(Point(0, surface.get_height()-1), Size(1, 1)),
+    texture-&gt;put(surface, Rect(Point(0, surface.get_height()-1), Size(1, 1)),
                 rect.left, rect.bottom-1);
 
     // draw the main surface
-    texture.put(surface, rect.left+1, rect.top+1);
+    texture-&gt;put(surface, rect.left+1, rect.top+1);
 
     return Surface(texture,
-                   Rectf(static_cast&lt;float&gt;(rect.left+1)   / static_cast&lt;float&gt;(texture.get_width()),
-                         static_cast&lt;float&gt;(rect.top+1)    / static_cast&lt;float&gt;(texture.get_height()),
-                         static_cast&lt;float&gt;(rect.right-1)  / static_cast&lt;float&gt;(texture.get_width()), 
-                         static_cast&lt;float&gt;(rect.bottom-1) / static_cast&lt;float&gt;(texture.get_height())),
+                   Rectf(static_cast&lt;float&gt;(rect.left+1)   / static_cast&lt;float&gt;(texture-&gt;get_width()),
+                         static_cast&lt;float&gt;(rect.top+1)    / static_cast&lt;float&gt;(texture-&gt;get_height()),
+                         static_cast&lt;float&gt;(rect.right-1)  / static_cast&lt;float&gt;(texture-&gt;get_width()), 
+                         static_cast&lt;float&gt;(rect.bottom-1) / static_cast&lt;float&gt;(texture-&gt;get_height())),
                    Sizef(static_cast&lt;float&gt;(surface.get_width()), static_cast&lt;float&gt;(surface.get_height())));
   }
 }
@@ -206,8 +206,8 @@
 {
   for(Textures::const_iterator i = textures.begin(); i != textures.end(); ++i)
   {
-    Texture texture = (*i)-&gt;get_texture();
-    SoftwareSurface surface = texture.get_software_surface();
+    TexturePtr texture = (*i)-&gt;get_texture();
+    SoftwareSurface surface = texture-&gt;get_software_surface();
 
     char filename[1024];
     sprintf(filename, &quot;/tmp/texture_packer%04d.png&quot;, int(i - textures.begin()));

Modified: trunk/windstille/src/display/texture_packer.hpp
===================================================================
--- trunk/windstille/src/display/texture_packer.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/display/texture_packer.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -42,7 +42,7 @@
   ~TexturePacker();
   
   Surface upload(const SoftwareSurface&amp; surface);
-  bool    allocate(const Size&amp; size, Rect&amp; rect, Texture&amp; texture);
+  bool    allocate(const Size&amp; size, Rect&amp; rect, TexturePtr&amp; out_texture);
   
   void save_all_as_png() const;
 

Modified: trunk/windstille/src/font/ttf_font.cpp
===================================================================
--- trunk/windstille/src/font/ttf_font.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/font/ttf_font.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -52,12 +52,12 @@
   int size;
 
   /** OpenGL Texture which holds all the characters */
-  Texture texture;
+  TexturePtr texture;
 
-  TTFFontImpl()
-    : characters(),
-      size(0),
-      texture()
+  TTFFontImpl() :
+    characters(),
+    size(0),
+    texture()
   {}
 };
 
@@ -149,7 +149,7 @@
   }
   FT_Done_Face(face);
 
-  impl-&gt;texture = Texture(pixelbuffer);
+  impl-&gt;texture = Texture::create(pixelbuffer);
 }
 
 TTFFont::~TTFFont()
@@ -225,7 +225,7 @@
   return width;
 }
 
-Texture
+TexturePtr
 TTFFont::get_texture() const
 {
   return impl-&gt;texture;

Modified: trunk/windstille/src/font/ttf_font.hpp
===================================================================
--- trunk/windstille/src/font/ttf_font.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/font/ttf_font.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -73,7 +73,7 @@
       FontEffoct */
   int get_size() const;
 
-  Texture get_texture() const;
+  TexturePtr get_texture() const;
 
   const TTFCharacter&amp; get_character(int c) const;
   void draw(const Vector2f&amp; pos, const std::string&amp; str, const Color&amp; color = Color(1.0f, 1.0f, 1.0f));

Modified: trunk/windstille/src/gui/automap.cpp
===================================================================
--- trunk/windstille/src/gui/automap.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/gui/automap.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -67,8 +67,8 @@
     }
 
   surface = Surface(tilemap-&gt;get_width(), tilemap-&gt;get_height());
-  surface.get_texture().set_filter(GL_NEAREST);
-  surface.get_texture().put(image, 0, 0);
+  surface.get_texture()-&gt;set_filter(GL_NEAREST);
+  surface.get_texture()-&gt;put(image, 0, 0);
 }
 
 Automap::~Automap()

Modified: trunk/windstille/src/objects/laser_pointer.cpp
===================================================================
--- trunk/windstille/src/objects/laser_pointer.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/objects/laser_pointer.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -29,12 +29,12 @@
   progress(),
   angle()
 {
-  noise = Texture(Pathname(&quot;images/noise2.png&quot;));
+  noise = Texture::create(Pathname(&quot;images/noise2.png&quot;));
   laserpointer = Sprite(Pathname(&quot;images/laserpointer.sprite&quot;));
   laserpointer_light = Sprite(Pathname(&quot;images/laserpointer_light.sprite&quot;));
   laserpointer_light.set_blend_func(GL_SRC_ALPHA, GL_ONE);
-  noise.set_wrap(GL_REPEAT);
-  noise.set_filter(GL_LINEAR);
+  noise-&gt;set_wrap(GL_REPEAT);
+  noise-&gt;set_filter(GL_LINEAR);
   
   progress = 0.0f;
   angle = 0.0f;

Modified: trunk/windstille/src/objects/laser_pointer.hpp
===================================================================
--- trunk/windstille/src/objects/laser_pointer.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/objects/laser_pointer.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -27,7 +27,7 @@
 class LaserPointer : public GameObject
 {
 private:
-  Texture noise;
+  TexturePtr noise;
   Sprite  laserpointer;
   Sprite  laserpointer_light;
   float   progress;

Modified: trunk/windstille/src/objects/liquid.cpp
===================================================================
--- trunk/windstille/src/objects/liquid.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/objects/liquid.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -56,8 +56,8 @@
   for(int i = 50; i &lt; 70 &amp;&amp; i &lt; int(heightfield1-&gt;size()); ++i)
     (*heightfield1)[i] += 0.0025f;
 
-  texture = Texture(Pathname(&quot;images/textures/water.png&quot;));
-  texture.set_wrap(GL_REPEAT);
+  texture = Texture::create(Pathname(&quot;images/textures/water.png&quot;));
+  texture-&gt;set_wrap(GL_REPEAT);
   
   m_water_top.reset(new VertexArrayDrawable(Vector2f(pos.x, pos.y), 10000,
                                             Matrix::identity())); //sc.light().get_modelview()));

Modified: trunk/windstille/src/objects/liquid.hpp
===================================================================
--- trunk/windstille/src/objects/liquid.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/objects/liquid.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -28,7 +28,7 @@
 class Liquid : public Entity
 {
 private:
-  Texture texture;
+  TexturePtr texture;
   float t;
 
   std::vector&lt;float&gt; heightfield_store1;

Modified: trunk/windstille/src/objects/nightvision.cpp
===================================================================
--- trunk/windstille/src/objects/nightvision.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/objects/nightvision.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -24,11 +24,11 @@
 
 Nightvision::Nightvision(const FileReader&amp; props) :
   nightvision(Pathname(&quot;images/nightvision.sprite&quot;)),
-  noise(Pathname(&quot;images/noise.png&quot;))
+  noise(Texture::create(Pathname(&quot;images/noise.png&quot;)))
 {
   name = &quot;nightvision&quot;;
-  noise.set_wrap(GL_REPEAT);
-  noise.set_filter(GL_LINEAR);
+  noise-&gt;set_wrap(GL_REPEAT);
+  noise-&gt;set_filter(GL_LINEAR);
 }
 
 Nightvision::~Nightvision()

Modified: trunk/windstille/src/objects/nightvision.hpp
===================================================================
--- trunk/windstille/src/objects/nightvision.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/objects/nightvision.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -28,7 +28,7 @@
 {
 private:
   Sprite  nightvision;
-  Texture noise;
+  TexturePtr noise;
 
 public:
   Nightvision(const FileReader&amp; props);

Modified: trunk/windstille/src/objects/shockwave.cpp
===================================================================
--- trunk/windstille/src/objects/shockwave.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/objects/shockwave.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -24,7 +24,7 @@
 
 Shockwave::Shockwave(const FileReader&amp; props) :
   pos(),
-  noise(Pathname(&quot;images/noise3.png&quot;)),
+  noise(Texture::create(Pathname(&quot;images/noise3.png&quot;))),
   shader_program(),
   radius()
 {
@@ -32,8 +32,8 @@
   
   radius = 100.0f;
 
-  noise.set_wrap(GL_REPEAT);
-  noise.set_filter(GL_LINEAR);
+  noise-&gt;set_wrap(GL_REPEAT);
+  noise-&gt;set_filter(GL_LINEAR);
 
   shader_program.attach(ShaderObject(GL_FRAGMENT_SHADER, &quot;data/shader/shockwave2.frag&quot;));
   shader_program.link();

Modified: trunk/windstille/src/objects/shockwave.hpp
===================================================================
--- trunk/windstille/src/objects/shockwave.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/objects/shockwave.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -27,7 +27,7 @@
 {
 private:
   Vector2f        pos;
-  Texture       noise;
+  TexturePtr noise;
   ShaderProgram shader_program;
   float radius;
 

Modified: trunk/windstille/src/particles/deform_drawer.cpp
===================================================================
--- trunk/windstille/src/particles/deform_drawer.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/particles/deform_drawer.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -140,7 +140,7 @@
     glPopMatrix();
   }
 
-  void prepare(const Texture&amp; screen_texture) 
+  void prepare(TexturePtr screen_texture) 
   {
     OpenGLState state;
     state.bind_texture(screen_texture);

Modified: trunk/windstille/src/scenegraph/fill_screen_pattern_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/fill_screen_pattern_drawable.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/scenegraph/fill_screen_pattern_drawable.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -20,19 +20,20 @@
 #define HEADER_WINDSTILLE_SCENEGRAPH_FILL_SCREEN_PATTERN_DRAWABLE_HPP
 
 #include &quot;display/opengl_state.hpp&quot;
+#include &quot;display/texture.hpp&quot;
 #include &quot;scenegraph/drawable.hpp&quot;
 
 class FillScreenPatternDrawable : public Drawable
 {
 private:
-  Texture  m_texture;
+  TexturePtr m_texture;
   Vector2f m_offset;
 
 public:
-  FillScreenPatternDrawable(const Texture&amp; texture, const Vector2f&amp; offset)
-    : Drawable(Vector2f(0, 0), -1000.0f), 
-      m_texture(texture),
-      m_offset(offset)
+  FillScreenPatternDrawable(TexturePtr texture, const Vector2f&amp; offset) :
+    Drawable(Vector2f(0, 0), -1000.0f),
+    m_texture(texture),
+    m_offset(offset)
   {}
 
   virtual ~FillScreenPatternDrawable() {}
@@ -50,14 +51,14 @@
     state.bind_texture(m_texture);
     state.activate();
 
-    float u = static_cast&lt;float&gt;(Display::get_width())  / static_cast&lt;float&gt;(m_texture.get_width());
-    float v = static_cast&lt;float&gt;(Display::get_height()) / static_cast&lt;float&gt;(m_texture.get_height());
+    float u = static_cast&lt;float&gt;(Display::get_width())  / static_cast&lt;float&gt;(m_texture-&gt;get_width());
+    float v = static_cast&lt;float&gt;(Display::get_height()) / static_cast&lt;float&gt;(m_texture-&gt;get_height());
 
-    float u_start = -m_offset.x / static_cast&lt;float&gt;(m_texture.get_width());
-    float v_start = -m_offset.y / static_cast&lt;float&gt;(m_texture.get_height());
+    float u_start = -m_offset.x / static_cast&lt;float&gt;(m_texture-&gt;get_width());
+    float v_start = -m_offset.y / static_cast&lt;float&gt;(m_texture-&gt;get_height());
 
-    u -= m_offset.x / static_cast&lt;float&gt;(m_texture.get_width());
-    v -= m_offset.y / static_cast&lt;float&gt;(m_texture.get_height());
+    u -= m_offset.x / static_cast&lt;float&gt;(m_texture-&gt;get_width());
+    v -= m_offset.y / static_cast&lt;float&gt;(m_texture-&gt;get_height());
 
     glPushMatrix();
     glLoadIdentity();

Modified: trunk/windstille/src/scenegraph/shockwave_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/shockwave_drawable.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/scenegraph/shockwave_drawable.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -24,19 +24,19 @@
 class ShockwaveDrawable : public Drawable
 {
 public:
-  Texture       noise;
+  TexturePtr noise;
   ShaderProgram shader_program;
   float radius;
 
   ShockwaveDrawable(const Vector2f&amp; pos_, 
-                    const Texture&amp;       noise_,
+                    TexturePtr      noise_,
                     const ShaderProgram&amp; shader_program_,
                     float r,
-                    const Matrix&amp; modelview_) 
-    : Drawable(pos_, 500.0f, modelview_),
-      noise(noise_),
-      shader_program(shader_program_),
-      radius(r)
+                    const Matrix&amp; modelview_) :
+    Drawable(pos_, 500.0f, modelview_), 
+    noise(noise_),
+    shader_program(shader_program_),
+    radius(r)
   {
   }
 

Modified: trunk/windstille/src/scenegraph/vertex_array_drawable.cpp
===================================================================
--- trunk/windstille/src/scenegraph/vertex_array_drawable.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/scenegraph/vertex_array_drawable.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -20,15 +20,15 @@
 #include &quot;scenegraph/vertex_array_drawable.hpp&quot;
 
 VertexArrayDrawable::VertexArrayDrawable(const Vector2f&amp; pos_, float z_pos_, 
-                                         const Matrix&amp; modelview_)
-  : Drawable(pos_, z_pos_, modelview_),
-    mode(GL_QUADS),
-    blend_sfactor(GL_SRC_ALPHA),
-    blend_dfactor(GL_ONE_MINUS_SRC_ALPHA),
-    texture(),
-    colors(),
-    texcoords(),
-    vertices()
+                                         const Matrix&amp; modelview_) :
+  Drawable(pos_, z_pos_, modelview_),
+  mode(GL_QUADS),
+  blend_sfactor(GL_SRC_ALPHA),
+  blend_dfactor(GL_ONE_MINUS_SRC_ALPHA),
+  texture(),
+  colors(),
+  texcoords(),
+  vertices()
 {
 }
 
@@ -173,7 +173,7 @@
 }
 
 void
-VertexArrayDrawable::set_texture(Texture texture_)
+VertexArrayDrawable::set_texture(TexturePtr texture_)
 {
   texture = texture_;
 }

Modified: trunk/windstille/src/scenegraph/vertex_array_drawable.hpp
===================================================================
--- trunk/windstille/src/scenegraph/vertex_array_drawable.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/scenegraph/vertex_array_drawable.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -32,7 +32,7 @@
   GLenum blend_sfactor;
   GLenum blend_dfactor;
 
-  Texture texture;
+  TexturePtr texture;
   std::vector&lt;unsigned char&gt; colors;
   std::vector&lt;float&gt; texcoords;
   std::vector&lt;float&gt; vertices;
@@ -61,7 +61,7 @@
   void clear();
 
   void set_mode(GLenum mode_);
-  void set_texture(Texture texture);
+  void set_texture(TexturePtr texture);
   void set_blend_func(GLenum sfactor, GLenum dfactor);
 };
 

Modified: trunk/windstille/src/screen/particle_viewer.cpp
===================================================================
--- trunk/windstille/src/screen/particle_viewer.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/screen/particle_viewer.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -76,8 +76,8 @@
 
   {
     // Build the SceneGraph
-    Texture pattern_texture(Pathname(&quot;images/greychess.png&quot;));
-    pattern_texture.set_wrap(GL_REPEAT);
+    TexturePtr pattern_texture = Texture::create(Pathname(&quot;images/greychess.png&quot;));
+    pattern_texture-&gt;set_wrap(GL_REPEAT);
 
     m_background_drawable.reset(new FillScreenPatternDrawable(pattern_texture, Vector2f()));
     m_color_fill_drawable.reset(new FillScreenDrawable(Color(0.4f, 0.4f, 0.4f)));

Modified: trunk/windstille/src/sprite3d/data.hpp
===================================================================
--- trunk/windstille/src/sprite3d/data.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/sprite3d/data.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -68,7 +68,7 @@
  */
 struct Mesh
 {
-  Texture   texture;
+  TexturePtr   texture;
 
   uint16_t  vertex_count;
   uint16_t  triangle_count;

Modified: trunk/windstille/src/tile/tile.hpp
===================================================================
--- trunk/windstille/src/tile/tile.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/tile/tile.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -52,7 +52,7 @@
    */
   int     packer;
   Rectf   uv;
-  Texture texture;
+  TexturePtr texture;
 
   /** bitmap that holds the collision attributes for this tile */
   unsigned int colmap;

Modified: trunk/windstille/src/tile/tile_packer.cpp
===================================================================
--- trunk/windstille/src/tile/tile_packer.cpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/tile/tile_packer.cpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -32,7 +32,7 @@
   int x_pos;
   int y_pos;
 
-  Texture texture;
+  TexturePtr texture;
 
   int width;
   int height;
@@ -55,7 +55,7 @@
   impl-&gt;width  = width;
   impl-&gt;height = height;
 
-  impl-&gt;texture = Texture(GL_TEXTURE_2D, width, height);
+  impl-&gt;texture = Texture::create(GL_TEXTURE_2D, width, height);
         
   assert_gl(&quot;setting TilePacker texture parameters&quot;); 
 }
@@ -90,7 +90,7 @@
 
   generate_border(convert, 1, 1, TILE_RESOLUTION, TILE_RESOLUTION);
 
-  impl-&gt;texture.put(convert, impl-&gt;x_pos, impl-&gt;y_pos);
+  impl-&gt;texture-&gt;put(convert, impl-&gt;x_pos, impl-&gt;y_pos);
   
   assert_gl(&quot;updating tilepacker texture&quot;);
 
@@ -118,7 +118,7 @@
   return (impl-&gt;y_pos + TILE_RESOLUTION + 2 &gt; impl-&gt;height);
 }
 
-Texture
+TexturePtr
 TilePacker::get_texture() const
 {
   return impl-&gt;texture;

Modified: trunk/windstille/src/tile/tile_packer.hpp
===================================================================
--- trunk/windstille/src/tile/tile_packer.hpp	2010-09-21 20:45:18 UTC (rev 3362)
+++ trunk/windstille/src/tile/tile_packer.hpp	2010-09-21 21:54:02 UTC (rev 3363)
@@ -47,7 +47,7 @@
   /** Return true if the PixelBuffer is full */
   bool is_full() const;
 
-  Texture get_texture() const;
+  TexturePtr get_texture() const;
 
 private:
   boost::scoped_ptr&lt;TilePackerImpl&gt; impl;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002359.html">[Windstille-commit] r3362 - trunk/windstille/src/display
</A></li>
	<LI>Next message: <A HREF="002361.html">[Windstille-commit] r3364 - in trunk/windstille/src: display gui	objects particles scenegraph sprite2d
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2360">[ date ]</a>
              <a href="thread.html#2360">[ thread ]</a>
              <a href="subject.html#2360">[ subject ]</a>
              <a href="author.html#2360">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/windstille-commit">More information about the Windstille-commit
mailing list</a><br>
</body></html>
