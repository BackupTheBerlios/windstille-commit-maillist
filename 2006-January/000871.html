<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Windstille-commit] r1218 - in trunk/src: . display objects scripting sprite3d
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/windstille-commit/2006-January/index.html" >
   <LINK REL="made" HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r1218%20-%20in%20trunk/src%3A%20.%20display%20objects%20scripting%20sprite3d&In-Reply-To=%3C200601120256.k0C2uwcO003548%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000870.html">
   <LINK REL="Next"  HREF="000872.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Windstille-commit] r1218 - in trunk/src: . display objects scripting sprite3d</H1>
    <B>grumbel at BerliOS</B> 
    <A HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r1218%20-%20in%20trunk/src%3A%20.%20display%20objects%20scripting%20sprite3d&In-Reply-To=%3C200601120256.k0C2uwcO003548%40sheep.berlios.de%3E"
       TITLE="[Windstille-commit] r1218 - in trunk/src: . display objects scripting sprite3d">grumbel at berlios.de
       </A><BR>
    <I>Thu Jan 12 03:56:58 CET 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000870.html">[Windstille-commit] r1217 - in trunk: data/shader src src/display
</A></li>
        <LI>Next message: <A HREF="000872.html">[Windstille-commit] r1219 - in trunk/src: . objects
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#871">[ date ]</a>
              <a href="thread.html#871">[ thread ]</a>
              <a href="subject.html#871">[ subject ]</a>
              <a href="author.html#871">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: grumbel
Date: 2006-01-12 03:55:49 +0100 (Thu, 12 Jan 2006)
New Revision: 1218

Added:
   trunk/src/objects/
   trunk/src/objects/background_gradient.cpp
   trunk/src/objects/background_gradient.hpp
   trunk/src/objects/bomb.cpp
   trunk/src/objects/bomb.hpp
   trunk/src/objects/nightvision.cpp
   trunk/src/objects/nightvision.hpp
   trunk/src/objects/shockwave.cpp
   trunk/src/objects/shockwave.hpp
   trunk/src/objects/test_object.cpp
   trunk/src/objects/test_object.hpp
Removed:
   trunk/src/background_gradient.cpp
   trunk/src/background_gradient.hpp
   trunk/src/badguy/
   trunk/src/bomb.cpp
   trunk/src/bomb.hpp
   trunk/src/nightvision.cpp
   trunk/src/nightvision.hpp
   trunk/src/objects/badguy.cpp
   trunk/src/objects/badguy.hpp
   trunk/src/shockwave.cpp
   trunk/src/shockwave.hpp
   trunk/src/test_object.cpp
   trunk/src/test_object.hpp
Modified:
   trunk/src/SConscript
   trunk/src/display/drawing_context.cpp
   trunk/src/display/drawing_request.hpp
   trunk/src/display/scene_context.cpp
   trunk/src/display/scene_context.hpp
   trunk/src/display/vertex_array_drawing_request.cpp
   trunk/src/display/vertex_array_drawing_request.hpp
   trunk/src/game_session.cpp
   trunk/src/objects/hedgehog.cpp
   trunk/src/objects/hedgehog.hpp
   trunk/src/objects/spider_mine.cpp
   trunk/src/objects/spider_mine.hpp
   trunk/src/player.cpp
   trunk/src/scripting/game_objects.hpp
   trunk/src/sector.cpp
   trunk/src/sprite3d/sprite3d.cpp
Log:
- moved badguy/ to objects/
- changed DrawingRequeset a bit (prepare() seems to work at the moment only for a single shockwave, not sure why)

Modified: trunk/src/SConscript
===================================================================
--- trunk/src/SConscript	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/SConscript	2006-01-12 02:55:49 UTC (rev 1218)
@@ -37,9 +37,7 @@
 
 env.Program('../windstille', [
 'baby_xml.cpp',
-'background_gradient.cpp',
 'blitter.cpp',
-'bomb.cpp',
 'box.cpp',
 'camera.cpp',
 'character.cpp',
@@ -62,7 +60,6 @@
 'inventory.cpp',
 'laser_pointer.cpp',
 'liquid.cpp',
-'nightvision.cpp',
 'pda.cpp',
 'physics.cpp',
 'pistol.cpp',
@@ -72,11 +69,9 @@
 'screen_manager.cpp',
 'scriptable_object.cpp',
 'script_manager.cpp',
-'shockwave.cpp',
 'sector.cpp',
 'spawnpoint.cpp',
 'sprite3dview.cpp',
-'test_object.cpp',
 'text_area.cpp',
 'tile.cpp',
 'tile_factory.cpp',
@@ -88,11 +83,15 @@
 'view.cpp',
 'lisp_getters.cpp',
 'windstille_main.cpp',
-'badguy/badguy.cpp',
-'badguy/hedgehog.cpp',
-'badguy/spider_mine.cpp',
-'badguy/swarm.cpp',
-'badguy/vrdummy.cpp',
+'objects/shockwave.cpp',
+'objects/test_object.cpp',
+'objects/bomb.cpp',
+'objects/background_gradient.cpp',
+'objects/hedgehog.cpp',
+'objects/spider_mine.cpp',
+'objects/swarm.cpp',
+'objects/vrdummy.cpp',
+'objects/nightvision.cpp',
 'collision/collision_data.cpp',
 'collision/collision_engine.cpp',
 'collision/collision_object.cpp',

Deleted: trunk/src/background_gradient.cpp
===================================================================
--- trunk/src/background_gradient.cpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/background_gradient.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -1,118 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2005 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &quot;display/vertex_array_drawing_request.hpp&quot;
-#include &quot;background_gradient.hpp&quot;
-
-BackgroundGradient::BackgroundGradient(FileReader&amp; props)
-{
-  z_pos = 0.0;
-
-  props.get(&quot;z-pos&quot;,  z_pos);
-  props.get(&quot;colors&quot;, colors);
-  if (colors.size() % (3 + 4 + 4 + 2) != 0)
-    {
-      std::cout &lt;&lt; &quot;BackgroundGradient: specified color gradient is invalid&quot; &lt;&lt; std::endl;
-      /** Color gradients are in the format:
-          
-      (colors start midpoint end R1 G1 B1 A1 R2 G2 B2 A2 I I
-              start midpoint end R1 G1 B1 A1 R2 G2 B2 A2 I I
-              ...)
-
-              I is ignored
-
-          all specified in float, this is similar to Gimps gradients
-          so you can easily copy&amp;paste
-       */
-      colors.clear();
-    }
-}
-
-BackgroundGradient::~BackgroundGradient()
-{  
-}
-  
-void
-BackgroundGradient::update(float delta)
-{
-}
-
-void
-BackgroundGradient::draw(SceneContext&amp; sc)
-{
-  if (colors.empty())
-    return ;
-
-  // Reset modelview so we can draw in screen space
-  sc.color().push_modelview();
-  sc.color().set_modelview(Matrix::identity());
-  
-  Color topcolor(0.0f, 0.0f, 0.5f);
-  Color bottomcolor(0.5f, 0.5f, 1.0f);
-
-  Rect rect(0, 0, 800, 600);
-  VertexArrayDrawingRequest* array = new VertexArrayDrawingRequest(Vector(0, 0), z_pos, 
-                                                                   sc.color().get_modelview());
-
-  array-&gt;set_mode(GL_QUAD_STRIP);
-  array-&gt;set_blend_func(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
-
-  for(int i = 0; i &lt; int(colors.size()); i += (3 + 4 + 4 + 2))
-    {
-      float&amp; start    = colors[i + 0];
-      float&amp; midpoint = colors[i + 1];
-      float&amp; end      = colors[i + 2];
-      Color color1(colors[i + 3], colors[i + 4], colors[i + 5], colors[i + 6]);
-      Color color2(colors[i + 7], colors[i + 8], colors[i + 9], colors[i + 10]);
-      Color midcolor((color1.r + color2.r)/2,
-                     (color1.g + color2.g)/2,
-                     (color1.b + color2.b)/2,
-                     (color1.a + color2.a)/2);
-
-      array-&gt;color(color1);
-      array-&gt;vertex(rect.left, rect.top + start*rect.get_height());
-
-      array-&gt;color(color1);
-      array-&gt;vertex(rect.right, rect.top + start*rect.get_height());
-
-      array-&gt;color(midcolor);
-      array-&gt;vertex(rect.left, rect.top + midpoint*rect.get_height());
-
-      array-&gt;color(midcolor);
-      array-&gt;vertex(rect.right, rect.top + midpoint*rect.get_height());
-
-      array-&gt;color(color2);
-      array-&gt;vertex(rect.left, rect.top + end*rect.get_height());
-
-      array-&gt;color(color2);
-      array-&gt;vertex(rect.right, rect.top + end*rect.get_height());  
-    }
-
-  sc.color().draw(array);  
-
-  sc.color().pop_modelview();
-}
-
-/* EOF */

Deleted: trunk/src/background_gradient.hpp
===================================================================
--- trunk/src/background_gradient.hpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/background_gradient.hpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -1,52 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2005 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_BACKGROUND_GRADIENT_HPP
-#define HEADER_BACKGROUND_GRADIENT_HPP
-
-#include &quot;lisp/lisp.hpp&quot;
-#include &quot;game_object.hpp&quot;
-
-/** */
-class BackgroundGradient : public GameObject
-{
-private:
-  std::vector&lt;float&gt; colors;
-  float z_pos; 
-public:
-  BackgroundGradient(FileReader&amp; props);
-  ~BackgroundGradient();
-  
-  void update (float delta);
-  void draw (SceneContext&amp; gc);
-    
-private:
-  BackgroundGradient (const BackgroundGradient&amp;);
-  BackgroundGradient&amp; operator= (const BackgroundGradient&amp;);
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/src/bomb.cpp
===================================================================
--- trunk/src/bomb.cpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/bomb.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -1,120 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2005 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-*/
-
-#include &quot;globals.hpp&quot;
-#include &quot;sector.hpp&quot;
-#include &quot;bomb.hpp&quot;
-#include &quot;badguy/badguy.hpp&quot;
-
-Bomb::Bomb(int x, int y)
-  : sprite(&quot;images/bomb.sprite&quot;),
-    explo(&quot;images/explo.sprite&quot;),
-    light(&quot;images/bomblight.sprite&quot;),
-    highlight(&quot;images/bombhighlight.sprite&quot;),
-    explolight(&quot;images/explolight.sprite&quot;),
-    pos(x, int(y/TILE_SIZE+1)*TILE_SIZE),
-    count(2.0f),
-    state(COUNTDOWN),
-    exploded(false)
-{
-}
-
-Bomb::~Bomb()
-{
-}
-
-void
-Bomb::update(float delta)
-{
-  if (explo.is_finished())
-    remove();
-
-  if (state == EXPLODE)
-    explo.update(delta);
-  else
-    sprite.update(delta);
-
-  count -= delta;
-
-  if (count &lt; 0 &amp;&amp; state != EXPLODE)
-    {
-      state = EXPLODE;
-      count = 0;
-      if (!exploded)
-        {
-          exploded = true;
-          explode();
-        }
-
-    }
-}
-
-void
-Bomb::draw(SceneContext&amp; sc)
-{
-  if (state == EXPLODE)
-    {
-      sc.color().draw(explo, pos);
-      sc.light().draw(explolight, pos, 0);
-
-      explolight.set_alpha(0.5);
-      explolight.set_scale(0.5);
-
-      sc.highlight().draw(explolight, pos, 0);
-
-      explolight.set_alpha(1.0);
-      explolight.set_scale(1.0);
-    }
-  else
-    {
-      sc.color().draw(sprite, pos);
-      if (sprite.is_finished()) {
-        sc.light().draw(light, pos, 0);
-        sc.highlight().draw(highlight, pos, 0);
-      }
-    }
-}
-
-void 
-Bomb::explode()
-{
-  if (0)
-    { // FIXME: Should be handled by the collision system
-      std::vector&lt;GameObject*&gt;* objs = Sector::current()-&gt;get_objects();
-      for(std::vector&lt;GameObject*&gt;::iterator i = objs-&gt;begin(); i != objs-&gt;end(); ++i)
-        {
-          Badguy* badguy = dynamic_cast&lt;Badguy*&gt;(*i);
-          if (badguy)
-            {
-              if (badguy-&gt;get_pos().x &gt; pos.x - 30 &amp;&amp;
-                  badguy-&gt;get_pos().x &lt; pos.x + 30 &amp;&amp;
-                  badguy-&gt;get_pos().y &gt; pos.y - 20 &amp;&amp;
-                  badguy-&gt;get_pos().y &lt; pos.y + 20)
-                badguy-&gt;die();
-            }
-        }
-    }
-}
-
-/* EOF */

Deleted: trunk/src/bomb.hpp
===================================================================
--- trunk/src/bomb.hpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/bomb.hpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -1,60 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2005 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-*/
-
-#ifndef HEADER_BOMB_HXX
-#define HEADER_BOMB_HXX
-
-#include &quot;sprite2d/sprite.hpp&quot;
-#include &quot;game_object.hpp&quot;
-
-/** */
-class Bomb : public GameObject
-{
-private:
-  Sprite sprite;
-  Sprite explo;
-  Sprite light;
-  Sprite highlight;
-  Sprite explolight;
-
-  Vector pos;
-  float count;
-  enum { COUNTDOWN, EXPLODE } state;
-  bool exploded;
-
-public:
-  Bomb(int x, int y);
-  virtual ~Bomb();
-
-  void update(float delta);
-  void draw(SceneContext&amp; gc);
-private:
-  void explode();
-  Bomb (const Bomb&amp;);
-  Bomb&amp; operator= (const Bomb&amp;);
-};
-
-#endif
-
-/* EOF */

Modified: trunk/src/display/drawing_context.cpp
===================================================================
--- trunk/src/display/drawing_context.cpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/display/drawing_context.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -54,7 +54,7 @@
   }
   virtual ~FillScreenDrawingRequest() {}
 
-  void draw() {
+  void draw(const Texture&amp; tmp_texture) {
     OpenGLState state;
     // FIXME: move clear color to opengl_state
     state.activate();
@@ -74,7 +74,7 @@
   {}
   virtual ~TextDrawingRequest() {}
 
-  void draw() {
+  void draw(const Texture&amp; tmp_texture) {
     glPushMatrix();
     glMultMatrixf(modelview.matrix);
     Fonts::ttffont-&gt;draw(int(pos.x), int(pos.y), text);
@@ -96,7 +96,7 @@
   virtual ~SurfaceDrawingRequest()
   {}
 
-  void draw() 
+  void draw(const Texture&amp; tmp_texture) 
   {
     glPushMatrix();
     glMultMatrixf(modelview.matrix);
@@ -124,10 +124,7 @@
   
   for(DrawingRequests::iterator i = drawingrequests.begin(); i != drawingrequests.end(); ++i)
     {
-      if ((*i)-&gt;needs_framebuffer())
-        (*i)-&gt;set_framebuffer_texture(sc.request_framebuffer_texture((*i)-&gt;framebuffer_rect()));
-      
-      (*i)-&gt;draw();
+      sc.eval(*i);
     }
 }
 

Modified: trunk/src/display/drawing_request.hpp
===================================================================
--- trunk/src/display/drawing_request.hpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/display/drawing_request.hpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -39,14 +39,35 @@
   Vector  pos;
   float   z_pos;
   Matrix  modelview;
-  Texture framebuffer_texture;
+
 public:
   DrawingRequest(const Vector&amp; pos_, float z_pos = 0,  const Matrix&amp; modelview_ = Matrix::identity())
     : pos(pos_), z_pos(z_pos), modelview(modelview_)
   {}
   virtual ~DrawingRequest() {}
   
-  virtual void draw() = 0;
+  /**
+   * The draw() method does the important work in DrawingRequest,
+   * ie. it is the place where you can access the screen with raw
+   * OpenGL methods. The \a tmp_texture provides a texture of the
+   * current framebuffer, you have to copy the \a screen_texture to it
+   * to contain usefull content
+   */
+  virtual void draw(const Texture&amp; tmp_texture) = 0;
+
+  /**
+   * This method is called before draw() to allow the DrawingRequest
+   * to copy content from \a screen_texture, which is the current
+   * framebuffer to a temporary buffer which can then be used in
+   * draw() for deformation effects
+   */
+  virtual void prepare(const Texture&amp; screen_texture) {}
+
+  /**
+   * Override this and let it return true if you need to prepare()
+   * function call
+   */
+  virtual bool needs_prepare() { return false; }
   
   /** Returns the position at which the request should be drawn */
   float get_z_pos() const { return z_pos; }
@@ -54,9 +75,6 @@
   Matrix get_modelview() const
   { return modelview; }
 
-  virtual bool  needs_framebuffer() { return false; }
-  virtual Rectf framebuffer_rect() { return Rectf(); }
-  void set_framebuffer_texture(const Texture&amp; t) { framebuffer_texture = t; }
 private:
   DrawingRequest (const DrawingRequest&amp;);
   DrawingRequest&amp; operator= (const DrawingRequest&amp;);

Modified: trunk/src/display/scene_context.cpp
===================================================================
--- trunk/src/display/scene_context.cpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/display/scene_context.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -290,6 +290,7 @@
       glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, 0);
     }
 
+  if (1) 
     {
       // Render the screen framebuffer to the actual screen 
       OpenGLState state;
@@ -297,8 +298,12 @@
       Rectf uv(0.375, 0.375, 
                impl-&gt;screen_framebuffer.get_width()  + 0.375,
                impl-&gt;screen_framebuffer.get_height() + 0.375);
-          
-      state.bind_texture(impl-&gt;screen_framebuffer.get_texture(), 0);
+
+      if (impl-&gt;render_mask &amp; BLURMAP)
+        state.bind_texture(impl-&gt;screen_framebuffer.get_texture(), 0);
+      else
+        state.bind_texture(impl-&gt;tmp_framebuffer.get_texture(), 0);
+
       state.activate();
 
       glBegin(GL_QUADS);
@@ -318,19 +323,6 @@
       glEnd();
     }
 
-    /*
-      glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, impl-&gt;blur_framebuffer.get_handle());
-      glClear(GL_DEPTH_BUFFER_BIT);
-
-      glPushMatrix();
-      glTranslatef(0, 600-(600/BLURMAP_DIV), 0);
-      glScalef(1.0f/BLURMAP_DIV, 1.0f/BLURMAP_DIV, 1.0f);
-      impl-&gt;color.render();
-      render_lightmap();
-      impl-&gt;highlight.render();
-      glPopMatrix();
-    */
-
   // Clear all DrawingContexts
   impl-&gt;color.clear();
   impl-&gt;light.clear();
@@ -368,43 +360,20 @@
     }
 }
 
-Texture
-SceneContext::request_framebuffer_texture(const Rectf&amp; rect)
+void
+SceneContext::eval(DrawingRequest* request)
 {
-  // FIXME: There is no reason to limit this to Rectf, *all* OpenGL
-  // primitve or plain drawing operations could be used for this!
-  glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, impl-&gt;tmp_framebuffer.get_handle());
-
-  {
-    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
-    // Render the screen framebuffer to the actual screen 
-    OpenGLState state;
-    state.bind_texture(impl-&gt;screen_framebuffer.get_texture(), 0);
-    state.activate();
-
-    glBegin(GL_QUADS);
-    
-    glTexCoord2f(rect.left, rect.bottom);
-    glVertex2f(rect.left, rect.top);
-
-    glTexCoord2f(rect.right, rect.bottom);
-    glVertex2f(rect.right, rect.top);
-
-    glTexCoord2f(rect.right, rect.top);
-    glVertex2f(rect.right, rect.bottom);
-
-    glTexCoord2f(rect.left, rect.top);
-    glVertex2f(rect.left, rect.bottom);
-    
-    glEnd();
-  } 
-
-  glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, 0);
-
-  // FIXME: Hacky, hacky, need something like push/pop_framebuffer to avoid this
-  glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, impl-&gt;screen_framebuffer.get_handle());
-
-  return impl-&gt;tmp_framebuffer.get_texture();
+  if (request-&gt;needs_prepare())
+    {
+      glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, impl-&gt;tmp_framebuffer.get_handle());
+      request-&gt;prepare(impl-&gt;screen_framebuffer.get_texture());
+      glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, impl-&gt;screen_framebuffer.get_handle());
+      request-&gt;draw(impl-&gt;tmp_framebuffer.get_texture());
+    }
+  else
+    {
+      request-&gt;draw(Texture());
+    }
 }
 
 /* EOF */

Modified: trunk/src/display/scene_context.hpp
===================================================================
--- trunk/src/display/scene_context.hpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/display/scene_context.hpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -90,11 +90,12 @@
   unsigned int get_render_mask();
 
   DrawingContext&amp; get_layer(unsigned int t);
-  Texture request_framebuffer_texture(const Rectf&amp; rect);
 
   void render_lightmap();
   void render_colormap();
   void render_highlightmap();
+
+  void eval(DrawingRequest* request);
 private:
   SceneContextImpl* impl;
 

Modified: trunk/src/display/vertex_array_drawing_request.cpp
===================================================================
--- trunk/src/display/vertex_array_drawing_request.cpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/display/vertex_array_drawing_request.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -46,7 +46,7 @@
 }
 
 void
-VertexArrayDrawingRequest::draw()
+VertexArrayDrawingRequest::draw(const Texture&amp; tmp_texture)
 {
   draw(0, num_vertices());
 }

Modified: trunk/src/display/vertex_array_drawing_request.hpp
===================================================================
--- trunk/src/display/vertex_array_drawing_request.hpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/display/vertex_array_drawing_request.hpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -43,7 +43,7 @@
 public:
   VertexArrayDrawingRequest(const Vector&amp; pos_, float z_pos_, const Matrix&amp; modelview_);
 
-  void draw();
+  void draw(const Texture&amp; tmp_texture);
   void draw(int start, int end);
 
   void vertex(float x, float y, float z = 0.0f);

Modified: trunk/src/game_session.cpp
===================================================================
--- trunk/src/game_session.cpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/game_session.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -54,7 +54,7 @@
 #include &quot;sound/sound_manager.hpp&quot;
 #include &quot;conversation.hpp&quot;
 #include &quot;collision/collision_engine.hpp&quot;
-#include &quot;test_object.hpp&quot;
+#include &quot;objects/test_object.hpp&quot;
 #include &quot;inventory.hpp&quot;
 #include &quot;display/surface_manager.hpp&quot;
 #include &quot;display/surface.hpp&quot;
@@ -356,6 +356,12 @@
               console &lt;&lt; &quot;Toggled LIGHTMAP: &quot; &lt;&lt; ((sc.get_render_mask() &amp; SceneContext::LIGHTMAPSCREEN) &gt; 0) &lt;&lt; std::endl;
               break;
 
+            case SDLK_5:
+              sc.set_render_mask(sc.get_render_mask() ^ SceneContext::BLURMAP);
+              console &lt;&lt; &quot;Toggled blurmap: &quot; &lt;&lt; ((sc.get_render_mask() &amp; SceneContext::BLURMAP) &gt; 0) &lt;&lt; std::endl;
+              break;
+
+
             case SDLK_c:
               if (debug) {
                 collision_debug = !collision_debug;

Deleted: trunk/src/nightvision.cpp
===================================================================
--- trunk/src/nightvision.cpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/nightvision.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -1,130 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2005 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &quot;globals.hpp&quot;
-#include &quot;random.hpp&quot;
-#include &quot;math/matrix.hpp&quot;
-#include &quot;display/vertex_array_drawing_request.hpp&quot;
-#include &quot;display/texture_manager.hpp&quot;
-#include &quot;nightvision.hpp&quot;
-
-Nightvision::Nightvision(FileReader&amp; props)
-  : nightvision(&quot;images/nightvision.sprite&quot;)
-{
-  name = &quot;nightvision&quot;;
-  noise = Texture(&quot;images/noise.png&quot;);
-  noise.set_wrap(GL_REPEAT);
-  noise.set_filter(GL_LINEAR);
-}
-
-Nightvision::~Nightvision()
-{
-}
-
-void
-Nightvision::draw(SceneContext&amp; sc)
-{
-  // reset the modelview, so we can draw in screen coordinates
-  sc.light().push_modelview();
-  sc.light().set_modelview(Matrix::identity());
-
-  // try to stay above everything else with large z value
-  if (1)
-    {
-      nightvision.set_alpha(1.0f);
-      nightvision.set_blend_func(GL_ONE, GL_ZERO);
-      sc.light().draw(nightvision, Vector(0, 0), 10000);
-    }
-
-  if (1)
-    {
-      VertexArrayDrawingRequest* array = new VertexArrayDrawingRequest(Vector(0, 0), 10000,
-                                                                       sc.light().get_modelview());
-      array-&gt;set_mode(GL_QUADS);
-      array-&gt;set_texture(noise);
-      array-&gt;set_blend_func(GL_DST_COLOR, GL_ZERO);
-
-      float u = rnd.drand()/0.5f;
-      float v = rnd.drand()/0.5f;
-      float w = 4.0f/6.0f;
-      float h = 3.0f/6.0f;
-
-      array-&gt;texcoord(u, v);
-      array-&gt;vertex(0, 0);
-
-      array-&gt;texcoord(u + w, v);
-      array-&gt;vertex(800, 0);
-
-      array-&gt;texcoord(u + w, v + h);
-      array-&gt;vertex(800, 600);
-
-      array-&gt;texcoord(u, v + h);
-      array-&gt;vertex(0, 600);
-      
-      if (0) // second noise level
-        {
-          u = rnd.drand();
-          v = rnd.drand();
-          float size = 4.0f;
-
-          array-&gt;texcoord(u, v);
-          array-&gt;vertex(0, 0, 1.0f);
-
-          array-&gt;texcoord(u + size, v);
-          array-&gt;vertex(800, 0, 1.0f);
-
-          array-&gt;texcoord(u + size, v + size);
-          array-&gt;vertex(800, 600, 1.0f);
-
-          array-&gt;texcoord(u, v + size);
-          array-&gt;vertex(0, 600, 1.0f);
-        }
-
-      sc.light().draw(array);
-    }
-  sc.light().pop_modelview();
-
-  if (1)
-    {
-      // FIXME: might be better to copy the highlight over to the
-      // color layer, however that would require some changes to the
-      // DrawingContext structure
-      sc.highlight().clear();
-
-      sc.highlight().push_modelview();
-      sc.highlight().set_modelview(Matrix::identity());
-      nightvision.set_alpha(0.5f);
-      nightvision.set_blend_func(GL_SRC_ALPHA, GL_ONE);
-      sc.highlight().draw(nightvision, Vector(0, 0), 10000);
-      sc.highlight().pop_modelview();
-    }
-}
-
-void
-Nightvision::update(float )
-{
-}
-
-/* EOF */

Deleted: trunk/src/nightvision.hpp
===================================================================
--- trunk/src/nightvision.hpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/nightvision.hpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -1,55 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2005 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_NIGHTVISION_HPP
-#define HEADER_NIGHTVISION_HPP
-
-#include &quot;lisp/lisp.hpp&quot;
-#include &quot;display/texture.hpp&quot;
-#include &quot;sprite2d/sprite.hpp&quot;
-#include &quot;game_object.hpp&quot;
-
-// FIXME: shouldn't really be a game object, but makes testing easier
-class Nightvision : public GameObject
-{
-private:
-  Sprite  nightvision;
-  Texture noise;
-
-public:
-  Nightvision(FileReader&amp; props);
-  ~Nightvision();
-
-  void draw(SceneContext&amp; sc);
-  void update(float delta);
-  
-private:
-  Nightvision (const Nightvision&amp;);
-  Nightvision&amp; operator= (const Nightvision&amp;);
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/objects (from rev 1214, trunk/src/badguy)

Copied: trunk/src/objects/background_gradient.cpp (from rev 1214, trunk/src/background_gradient.cpp)

Copied: trunk/src/objects/background_gradient.hpp (from rev 1214, trunk/src/background_gradient.hpp)

Deleted: trunk/src/objects/badguy.cpp
===================================================================
--- trunk/src/badguy/badguy.cpp	2006-01-11 16:20:12 UTC (rev 1214)
+++ trunk/src/objects/badguy.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -1,33 +0,0 @@
-/*  $Id: bomb.cpp 752 2005-07-25 10:00:44Z grumbel $
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2005 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-*/
-
-#include &quot;badguy.hpp&quot;
-
-Badguy::Badguy()
-{
-}
-
-Badguy::~Badguy()
-{
-}

Deleted: trunk/src/objects/badguy.hpp
===================================================================
--- trunk/src/badguy/badguy.hpp	2006-01-11 16:20:12 UTC (rev 1214)
+++ trunk/src/objects/badguy.hpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -1,41 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2005 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-*/
-
-#ifndef HEADER_BADGUY_HXX
-#define HEADER_BADGUY_HXX
-
-#include &quot;entity.hpp&quot;
-
-class Badguy : public Entity
-{
-public:
-  Badguy();
-  virtual ~Badguy();
-
-  virtual void die() = 0;
-};
-
-#endif
-
-/* EOF */

Copied: trunk/src/objects/bomb.cpp (from rev 1214, trunk/src/bomb.cpp)
===================================================================
--- trunk/src/bomb.cpp	2006-01-11 16:20:12 UTC (rev 1214)
+++ trunk/src/objects/bomb.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -0,0 +1,103 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+*/
+
+#include &quot;globals.hpp&quot;
+#include &quot;sector.hpp&quot;
+#include &quot;bomb.hpp&quot;
+
+Bomb::Bomb(int x, int y)
+  : sprite(&quot;images/bomb.sprite&quot;),
+    explo(&quot;images/explo.sprite&quot;),
+    light(&quot;images/bomblight.sprite&quot;),
+    highlight(&quot;images/bombhighlight.sprite&quot;),
+    explolight(&quot;images/explolight.sprite&quot;),
+    pos(x, int(y/TILE_SIZE+1)*TILE_SIZE),
+    count(2.0f),
+    state(COUNTDOWN),
+    exploded(false)
+{
+}
+
+Bomb::~Bomb()
+{
+}
+
+void
+Bomb::update(float delta)
+{
+  if (explo.is_finished())
+    remove();
+
+  if (state == EXPLODE)
+    explo.update(delta);
+  else
+    sprite.update(delta);
+
+  count -= delta;
+
+  if (count &lt; 0 &amp;&amp; state != EXPLODE)
+    {
+      state = EXPLODE;
+      count = 0;
+      if (!exploded)
+        {
+          exploded = true;
+          explode();
+        }
+
+    }
+}
+
+void
+Bomb::draw(SceneContext&amp; sc)
+{
+  if (state == EXPLODE)
+    {
+      sc.color().draw(explo, pos);
+      sc.light().draw(explolight, pos, 0);
+
+      explolight.set_alpha(0.5);
+      explolight.set_scale(0.5);
+
+      sc.highlight().draw(explolight, pos, 0);
+
+      explolight.set_alpha(1.0);
+      explolight.set_scale(1.0);
+    }
+  else
+    {
+      sc.color().draw(sprite, pos);
+      if (sprite.is_finished()) {
+        sc.light().draw(light, pos, 0);
+        sc.highlight().draw(highlight, pos, 0);
+      }
+    }
+}
+
+void 
+Bomb::explode()
+{
+}
+
+/* EOF */

Copied: trunk/src/objects/bomb.hpp (from rev 1214, trunk/src/bomb.hpp)

Modified: trunk/src/objects/hedgehog.cpp
===================================================================
--- trunk/src/badguy/hedgehog.cpp	2006-01-11 16:20:12 UTC (rev 1214)
+++ trunk/src/objects/hedgehog.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -34,7 +34,7 @@
     highlight(&quot;images/hedgehog_highlight.sprite&quot;)
 {
   props.get(&quot;name&quot;, name);
-  props.get(&quot;pos&quot;, pos);
+  props.get(&quot;pos&quot;,  pos);
   props.print_unused_warnings(&quot;hedgehog&quot;);
   
   direction_left = false;

Modified: trunk/src/objects/hedgehog.hpp
===================================================================
--- trunk/src/badguy/hedgehog.hpp	2006-01-11 16:20:12 UTC (rev 1214)
+++ trunk/src/objects/hedgehog.hpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -25,9 +25,9 @@
 #ifndef HEADER_HEDGEHOG_HXX
 #define HEADER_HEDGEHOG_HXX
 
-#include &quot;badguy.hpp&quot;
+#include &quot;game_object.hpp&quot;
 
-class Hedgehog : public Badguy
+class Hedgehog : public Entity
 {
 private:
   Sprite sprite;

Copied: trunk/src/objects/nightvision.cpp (from rev 1214, trunk/src/nightvision.cpp)

Copied: trunk/src/objects/nightvision.hpp (from rev 1214, trunk/src/nightvision.hpp)

Copied: trunk/src/objects/shockwave.cpp (from rev 1217, trunk/src/shockwave.cpp)
===================================================================
--- trunk/src/shockwave.cpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/objects/shockwave.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -0,0 +1,266 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2005 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include &quot;display/opengl_state.hpp&quot;
+#include &quot;display/drawing_request.hpp&quot;
+#include &quot;display/texture.hpp&quot;
+#include &quot;display/shader_program.hpp&quot;
+#include &quot;display/shader_object.hpp&quot;
+#include &quot;shockwave.hpp&quot;
+
+class ShockwaveDrawingRequest : public DrawingRequest
+{
+public:
+  Texture       noise;
+  ShaderProgram shader_program;
+  float radius;
+
+  ShockwaveDrawingRequest(const Vector&amp; pos, 
+                          const Texture&amp;       noise_,
+                          const ShaderProgram&amp; shader_program_,
+                          float r,
+                          const Matrix&amp; modelview_) 
+    : DrawingRequest(pos, 500.0f, modelview_),
+      noise(noise_),
+      shader_program(shader_program_),
+      radius(r)
+  {
+  }
+
+  ~ShockwaveDrawingRequest()
+  {
+  }
+
+  bool  needs_prepare()
+  {
+    return true; 
+  }
+    
+  void prepare(const Texture&amp; screen_texture)
+  {
+    // FIXME: Clear stuff is only for debugging
+    glClearColor(1.0, 0.0, 1.0, 1.0);
+    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
+
+    glPushMatrix();
+    glMultMatrixf(modelview.matrix);
+    glTranslatef(pos.x, pos.y, 0);
+
+    { // Apply modelview matrix to texture matrix so that we can
+      // give texcoords as screencords
+      GLdouble modelview[16];
+      glMatrixMode(GL_MODELVIEW);
+      glGetDoublev(GL_MODELVIEW_MATRIX, modelview);
+      glMatrixMode(GL_TEXTURE);
+      glLoadIdentity();
+      glTranslatef(0, 599, 0);
+      glScalef(1, -1, 1);
+      glMultMatrixd(modelview);
+
+      //glLoadMatrixd(modelview);
+    }
+
+    int count = int(radius);
+    OpenGLState state;
+    state.bind_texture(screen_texture, 0);
+    state.activate();
+
+    float radius = (count)*2.0f + 20.0f; // enlarge radius by 20.0f to handle texture displacement 
+    float minradius = 2.0f*count - 164.0f;
+    if (minradius &lt; 0)
+      minradius = 0;
+
+    int segments = 64;
+
+    glColor4f(1.0f, 1.0f, 1.0f, 1.0f);
+  
+    glBegin(GL_QUADS);
+    for (int i = 0; i &lt; segments; ++i)
+      {
+        float angel = (2*M_PI / segments);
+
+        float x1 =  sin(angel*i)*radius;
+        float y1 = -cos(angel*i)*radius;
+
+        float x2 =  sin(angel*(i+1))*radius;
+        float y2 = -cos(angel*(i+1))*radius;
+
+        glTexCoord2f(x1+256, (y1+256));
+        glVertex3f(x1+256, y1+256, 0);
+
+        glTexCoord2f(x2+256, (y2+256));
+        glVertex3f(x2+256, y2+256, 0);
+
+
+        float x3 =  sin(angel*i)*minradius;
+        float y3 = -cos(angel*i)*minradius;
+
+        float x4 =  sin(angel*(i+1))*minradius;
+        float y4 = -cos(angel*(i+1))*minradius;
+
+        glTexCoord2f(x4+256, (y4+256));
+        glVertex3f(x4+256, y4+256, 0);
+        glTexCoord2f(x3+256, (y3+256));
+        glVertex3f(x3+256, y3+256, 0);
+      }
+    glEnd();
+
+    glMatrixMode(GL_TEXTURE);
+    glLoadIdentity();
+    glMatrixMode(GL_MODELVIEW);
+
+    glPopMatrix();
+  }
+
+  void draw(const Texture&amp; tmp_texture)
+  {
+    glPushMatrix();
+    glMultMatrixf(modelview.matrix);
+    glTranslatef(pos.x, pos.y, 0);
+    if (0)
+      {
+        Rectf rect(0, 0, 800, 600);
+        // Render the screen framebuffer to the actual screen 
+        OpenGLState state;
+        state.bind_texture(tmp_texture, 0);
+        state.activate();
+
+        glBegin(GL_QUADS);
+    
+        glTexCoord2f(rect.left, rect.bottom);
+        glVertex2f(rect.left/2.0f, rect.bottom/2.0f);
+
+        glTexCoord2f(rect.right, rect.bottom);
+        glVertex2f(rect.right/2.0f, rect.bottom/2.0f);
+
+        glTexCoord2f(rect.right, rect.top);
+        glVertex2f(rect.right/2.0f, rect.top/2.0f);
+
+        glTexCoord2f(rect.left, rect.top);
+        glVertex2f(rect.left/2.0f, rect.top/2.0f);
+    
+        glEnd();
+      }
+    else
+      {
+        OpenGLState state;
+        state.bind_texture(tmp_texture, 0);
+        state.bind_texture(noise, 1);
+        state.enable(GL_BLEND);
+        state.set_blend_func(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
+        state.activate();
+
+        glUseProgramObjectARB(shader_program.get_handle());    
+        shader_program.set_uniform1f(&quot;radius&quot;,   radius/512.0f*2.0f);
+        shader_program.set_uniform1i(&quot;background_tex&quot;, 0);
+        shader_program.set_uniform1i(&quot;noise_tex&quot;,   1);
+        draw_disc(int(radius));
+        glUseProgramObjectARB(0);
+      }
+    glPopMatrix();
+  }
+
+  void draw_disc(int count)
+  {
+    float radius = (count)*2.0f;
+    float minradius = 2.0f*count - 164.0f;
+    if (minradius &lt; 0)
+      minradius = 0;
+
+    int segments = 64;
+  
+    glBegin(GL_QUADS);
+    for (int i = 0; i &lt; segments; ++i)
+      {
+        float angel = (2*M_PI / segments);
+
+        float x1 =  sin(angel*i)*radius;
+        float y1 = -cos(angel*i)*radius;
+
+        float x2 =  sin(angel*(i+1))*radius;
+        float y2 = -cos(angel*(i+1))*radius;
+
+        glColor4f(1.0f, 1.0f, 1.0f, 1.0f);
+        glTexCoord2f(x1/512.0f+0.5f, y1/512.0f+0.5f);
+        glVertex3f(x1+256, y1+256, 0);
+
+        glTexCoord2f(x2/512.0f+0.5f, y2/512.0f+0.5f);
+        glVertex3f(x2+256, y2+256, 0);
+
+
+        float x3 =  sin(angel*i)*minradius;
+        float y3 = -cos(angel*i)*minradius;
+
+        float x4 =  sin(angel*(i+1))*minradius;
+        float y4 = -cos(angel*(i+1))*minradius;
+
+        glColor4f(1.0f, 1.0f, 1.0f, 0.0f);
+        glTexCoord2f(x4/512.0f+0.5f, y4/512.0f+0.5f);
+        glVertex3f(x4+256, y4+256, 0);
+        glTexCoord2f(x3/512.0f+0.5f, y3/512.0f+0.5f);
+        glVertex3f(x3+256, y3+256, 0);
+      }
+    glEnd();
+  }
+};
+
+Shockwave::Shockwave(FileReader&amp; props)
+  : noise(&quot;images/noise3.png&quot;)
+{
+  props.get(&quot;pos&quot;, pos);
+  props.print_unused_warnings(&quot;Shockwave&quot;);
+
+  radius = 100.0f;
+
+  noise.set_wrap(GL_REPEAT);
+  noise.set_filter(GL_LINEAR);
+
+  shader_program.attach(ShaderObject(GL_FRAGMENT_SHADER_ARB, &quot;data/shader/shockwave2.frag&quot;));
+  shader_program.link();
+}
+
+Shockwave::~Shockwave()
+{
+}
+
+void
+Shockwave::draw (SceneContext&amp; sc)
+{
+  sc.highlight().draw(new ShockwaveDrawingRequest(pos,
+                                                   noise,
+                                                   shader_program,
+                                                   radius,
+                                                   sc.color().get_modelview()));
+}
+
+void
+Shockwave::update (float delta)
+{
+  radius += 150.0f * delta;
+  if (radius &gt; 300.0f)
+    radius = 0;
+}
+
+/* EOF */

Copied: trunk/src/objects/shockwave.hpp (from rev 1215, trunk/src/shockwave.hpp)

Modified: trunk/src/objects/spider_mine.cpp
===================================================================
--- trunk/src/badguy/spider_mine.cpp	2006-01-11 16:20:12 UTC (rev 1214)
+++ trunk/src/objects/spider_mine.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -33,7 +33,7 @@
     explode_light(&quot;images/explolight.sprite&quot;)
 {
   props.get(&quot;name&quot;, name);
-  props.get(&quot;pos&quot;, pos);
+  props.get(&quot;pos&quot;,  pos);
   props.print_unused_warnings(&quot;spidermine&quot;);
   
   sprite = Sprite(&quot;images/spider_mine.sprite&quot;);

Modified: trunk/src/objects/spider_mine.hpp
===================================================================
--- trunk/src/badguy/spider_mine.hpp	2006-01-11 16:20:12 UTC (rev 1214)
+++ trunk/src/objects/spider_mine.hpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -25,10 +25,10 @@
 #ifndef HEADER_SPIDER_HPP
 #define HEADER_SPIDER_HPP
 
-#include &quot;badguy.hpp&quot;
+#include &quot;entity.hpp&quot;
 #include &quot;sprite2d/sprite.hpp&quot;
 
-class SpiderMine : public Badguy
+class SpiderMine : public Entity
 {
 private:
   Sprite sprite;

Copied: trunk/src/objects/test_object.cpp (from rev 1214, trunk/src/test_object.cpp)

Copied: trunk/src/objects/test_object.hpp (from rev 1214, trunk/src/test_object.hpp)

Modified: trunk/src/player.cpp
===================================================================
--- trunk/src/player.cpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/player.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -24,7 +24,7 @@
 #include &quot;input/input_manager.hpp&quot;
 #include &quot;controller_def.hpp&quot;
 #include &quot;player.hpp&quot;
-#include &quot;bomb.hpp&quot;
+#include &quot;objects/bomb.hpp&quot;
 #include &quot;globals.hpp&quot;
 #include &quot;pda.hpp&quot;
 #include &quot;tile.hpp&quot;

Modified: trunk/src/scripting/game_objects.hpp
===================================================================
--- trunk/src/scripting/game_objects.hpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/scripting/game_objects.hpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -3,7 +3,7 @@
 
 #ifndef SCRIPTING_API
 #include &quot;game_object.hpp&quot;
-#include &quot;test_object.hpp&quot;
+#include &quot;objects/test_object.hpp&quot;
 #include &quot;player.hpp&quot;
 #include &quot;scriptable_object.hpp&quot;
 #include &quot;ref.hpp&quot;

Modified: trunk/src/sector.cpp
===================================================================
--- trunk/src/sector.cpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/sector.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -26,29 +26,29 @@
 #include &quot;lisp_getters.hpp&quot;
 #include &quot;globals.hpp&quot;
 #include &quot;display/scene_context.hpp&quot;
-#include &quot;background_gradient.hpp&quot;
+#include &quot;objects/background_gradient.hpp&quot;
 #include &quot;tile_map.hpp&quot;
 #include &quot;game_object.hpp&quot;
 #include &quot;player.hpp&quot;
 #include &quot;trigger.hpp&quot;
-#include &quot;test_object.hpp&quot;
+#include &quot;objects/test_object.hpp&quot;
 #include &quot;sector.hpp&quot;
-#include &quot;badguy/vrdummy.hpp&quot;
+#include &quot;objects/vrdummy.hpp&quot;
 #include &quot;spawnpoint.hpp&quot;
 #include &quot;sound/sound_manager.hpp&quot;
 #include &quot;script_manager.hpp&quot;
 #include &quot;collision/collision_engine.hpp&quot;
 #include &quot;particles/particle_system.hpp&quot;
-#include &quot;test_object.hpp&quot;
+#include &quot;objects/test_object.hpp&quot;
 #include &quot;elevator.hpp&quot;
-#include &quot;nightvision.hpp&quot;
+#include &quot;objects/nightvision.hpp&quot;
 #include &quot;character.hpp&quot;
 #include &quot;laser_pointer.hpp&quot;
-#include &quot;badguy/swarm.hpp&quot;
+#include &quot;objects/swarm.hpp&quot;
 #include &quot;liquid.hpp&quot;
-#include &quot;shockwave.hpp&quot;
-#include &quot;badguy/hedgehog.hpp&quot;
-#include &quot;badguy/spider_mine.hpp&quot;
+#include &quot;objects/shockwave.hpp&quot;
+#include &quot;objects/hedgehog.hpp&quot;
+#include &quot;objects/spider_mine.hpp&quot;
 #include &quot;box.hpp&quot;
 #include &quot;scriptable_object.hpp&quot;
 #include &quot;scripting/squirrel_error.hpp&quot;

Deleted: trunk/src/shockwave.cpp
===================================================================
--- trunk/src/shockwave.cpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/shockwave.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -1,196 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2005 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &quot;display/opengl_state.hpp&quot;
-#include &quot;display/drawing_request.hpp&quot;
-#include &quot;display/texture.hpp&quot;
-#include &quot;display/shader_program.hpp&quot;
-#include &quot;display/shader_object.hpp&quot;
-#include &quot;shockwave.hpp&quot;
-
-class ShockwaveDrawingRequest : public DrawingRequest
-{
-public:
-  Texture       noise;
-  ShaderProgram shader_program;
-  float radius;
-
-  ShockwaveDrawingRequest(const Vector&amp; pos, 
-                          const Texture&amp;       noise_,
-                          const ShaderProgram&amp; shader_program_,
-                          float r,
-                          const Matrix&amp; modelview_) 
-    : DrawingRequest(pos, 500.0f, modelview_),
-      noise(noise_),
-      shader_program(shader_program_),
-      radius(r)
-  {
-  }
-
-  ~ShockwaveDrawingRequest()
-  {
-  }
-
-  bool  needs_framebuffer()
-  {
-    return true; 
-  }
-  
-  Rectf framebuffer_rect() 
-  {
-    return Rectf(0, 0, 800, 600); 
-  }
-  
-  void draw()
-  {
-    glPushMatrix();
-    glMultMatrixf(modelview.matrix);
-    glTranslatef(pos.x, pos.y, 0);
-    if (0)
-      {
-        Rectf rect(0, 0, 800, 600);
-        // Render the screen framebuffer to the actual screen 
-        OpenGLState state;
-        state.bind_texture(framebuffer_texture, 0);
-        state.activate();
-
-        glBegin(GL_QUADS);
-    
-        glTexCoord2f(rect.left, rect.bottom);
-        glVertex2f(rect.left/2.0f, rect.bottom/2.0f);
-
-        glTexCoord2f(rect.right, rect.bottom);
-        glVertex2f(rect.right/2.0f, rect.bottom/2.0f);
-
-        glTexCoord2f(rect.right, rect.top);
-        glVertex2f(rect.right/2.0f, rect.top/2.0f);
-
-        glTexCoord2f(rect.left, rect.top);
-        glVertex2f(rect.left/2.0f, rect.top/2.0f);
-    
-        glEnd();
-      }
-    else
-      {
-        OpenGLState state;
-        state.bind_texture(framebuffer_texture, 0);
-        state.bind_texture(noise, 1);
-        state.enable(GL_BLEND);
-        state.set_blend_func(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
-        state.activate();
-
-        glUseProgramObjectARB(shader_program.get_handle());    
-        shader_program.set_uniform1f(&quot;radius&quot;,   radius/512.0f*2.0f);
-        shader_program.set_uniform1i(&quot;background_tex&quot;, 0);
-        shader_program.set_uniform1i(&quot;noise_tex&quot;,   1);
-        draw_disc(int(radius));
-        glUseProgramObjectARB(0);
-      }
-    glPopMatrix();
-  }
-
-  void draw_disc(int count)
-  {
-    float radius = (count)*2.0f;
-    float minradius = 2.0f*count - 164.0f;
-    if (minradius &lt; 0)
-      minradius = 0;
-    glClear(GL_DEPTH_BUFFER_BIT);
-
-    int segments = 64;
-  
-    glBegin(GL_QUADS);
-    for (int i = 0; i &lt; segments; ++i)
-      {
-        float angel = (2*M_PI / segments);
-
-        float x1 =  sin(angel*i)*radius;
-        float y1 = -cos(angel*i)*radius;
-
-        float x2 =  sin(angel*(i+1))*radius;
-        float y2 = -cos(angel*(i+1))*radius;
-
-        glColor4f(1.0f, 1.0f, 1.0f, 1.0f);
-        glTexCoord2f(x1/512.0f+0.5f, y1/512.0f+0.5f);
-        glVertex3f(x1+256, y1+256, 0);
-
-        glTexCoord2f(x2/512.0f+0.5f, y2/512.0f+0.5f);
-        glVertex3f(x2+256, y2+256, 0);
-
-
-        float x3 =  sin(angel*i)*minradius;
-        float y3 = -cos(angel*i)*minradius;
-
-        float x4 =  sin(angel*(i+1))*minradius;
-        float y4 = -cos(angel*(i+1))*minradius;
-
-        glColor4f(1.0f, 1.0f, 1.0f, 0.0f);
-        glTexCoord2f(x4/512.0f+0.5f, y4/512.0f+0.5f);
-        glVertex3f(x4+256, y4+256, 0);
-        glTexCoord2f(x3/512.0f+0.5f, y3/512.0f+0.5f);
-        glVertex3f(x3+256, y3+256, 0);
-      }
-    glEnd();
-  }
-};
-
-Shockwave::Shockwave(FileReader&amp; props)
-  : noise(&quot;images/noise3.png&quot;)
-{
-  props.get(&quot;pos&quot;, pos);
-  props.print_unused_warnings(&quot;Shockwave&quot;);
-
-  radius = 100.0f;
-
-  noise.set_wrap(GL_REPEAT);
-  noise.set_filter(GL_LINEAR);
-
-  shader_program.attach(ShaderObject(GL_FRAGMENT_SHADER_ARB, &quot;data/shader/shockwave2.frag&quot;));
-  shader_program.link();
-}
-
-Shockwave::~Shockwave()
-{
-}
-
-void
-Shockwave::draw (SceneContext&amp; sc)
-{
-  sc.highlight().draw(new ShockwaveDrawingRequest(pos,
-                                                   noise,
-                                                   shader_program,
-                                                   radius,
-                                                   sc.color().get_modelview()));
-}
-
-void
-Shockwave::update (float delta)
-{
-  radius += 150.0f * delta;
-  if (radius &gt; 300.0f)
-    radius = 0;
-}
-
-/* EOF */

Deleted: trunk/src/shockwave.hpp
===================================================================
--- trunk/src/shockwave.hpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/shockwave.hpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -1,55 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2005 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_SHOCKWAVE_HPP
-#define HEADER_SHOCKWAVE_HPP
-
-#include &quot;display/shader_program.hpp&quot;
-#include &quot;display/texture.hpp&quot;
-#include &quot;game_object.hpp&quot;
-
-/** */
-class Shockwave : public GameObject
-{
-private:
-  Vector        pos;
-  Texture       noise;
-  ShaderProgram shader_program;
-  float radius;
-public:
-  Shockwave(FileReader&amp; props);
-  ~Shockwave();
-
-  void draw (SceneContext&amp; context);
-  void update (float delta);
-
-private:
-  Shockwave (const Shockwave&amp;);
-  Shockwave&amp; operator= (const Shockwave&amp;);
-};
-
-#endif
-
-/* EOF */

Modified: trunk/src/sprite3d/sprite3d.cpp
===================================================================
--- trunk/src/sprite3d/sprite3d.cpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/sprite3d/sprite3d.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -248,7 +248,7 @@
     : DrawingRequest(pos, z_pos, modelview), sprite(sprite)
   {}
 
-  void draw()
+  void draw(const Texture&amp; tmp_texture)
   {
     sprite-&gt;draw(pos, modelview);
   }

Deleted: trunk/src/test_object.cpp
===================================================================
--- trunk/src/test_object.cpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/test_object.cpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -1,97 +0,0 @@
-#include &lt;config.h&gt;
-
-#include &quot;test_object.hpp&quot;
-#include &quot;sprite3d/manager.hpp&quot;
-#include &quot;lisp/properties.hpp&quot;
-#include &quot;lisp_getters.hpp&quot;
-
-TestObject::TestObject(FileReader&amp; props)
-{
-  using namespace lisp;
-  pos = Vector(0, 0);
-  std::string spritename;
-
-  props.get(&quot;sprite&quot;, spritename);
-  props.get(&quot;pos&quot;, pos);
-  props.get(&quot;name&quot;, name);
-  props.print_unused_warnings(&quot;testobject&quot;);
-
-  if(spritename == &quot;&quot;)
-    throw std::runtime_error(&quot;No sprite name specified in TestObject&quot;);
-  sprite = Sprite3D(spritename);
-}
-
-TestObject::~TestObject()
-{
-}
-
-void
-TestObject::draw(SceneContext&amp; sc)
-{
-  sprite.draw(sc.color(), pos, 100);
-  for(std::vector&lt;AttachedSprite&gt;::iterator i = attached_sprites.begin();
-      i != attached_sprites.end(); ++i) {
-    sc.push_modelview();
-    sc.translate(pos.x, pos.y);
-    sc.mult_modelview(sprite.get_attachment_point_matrix(i-&gt;attachpoint));
-    
-    i-&gt;sprite.draw(sc.color(), Vector(0, 0), 100);
-    sc.pop_modelview();
-  }                                                                        
-}
-
-void
-TestObject::update(float delta)
-{
-  sprite.update(delta);
-  for(std::vector&lt;AttachedSprite&gt;::iterator i = attached_sprites.begin();
-      i != attached_sprites.end(); ++i) {
-    i-&gt;sprite.update(delta);
-  }
-}
-
-void
-TestObject::set_sprite(const std::string&amp; filename)
-{
-  try {
-    sprite = Sprite3D(filename);
-  } catch(std::exception&amp; e) {
-    std::cerr &lt;&lt; &quot;Couldn't change sprite to '&quot; &lt;&lt; filename &lt;&lt; &quot;': &quot; 
-              &lt;&lt; e.what() &lt;&lt; &quot;\n&quot;;
-  }
-}
-
-void
-TestObject::set_action(const std::string&amp; action)
-{
-  try {
-    sprite.set_action(action);
-  } catch(std::exception&amp; e) {
-    std::cerr &lt;&lt; &quot;Couldn't change action to '&quot; &lt;&lt; action &lt;&lt; &quot;': &quot;
-              &lt;&lt; e.what() &lt;&lt; &quot;\n&quot;;
-  }
-}
-
-void
-TestObject::set_pos(const Vector&amp; pos)
-{
-  this-&gt;pos = pos;
-}
-
-void
-TestObject::set_vflip(bool vflip)
-{
-  sprite.set_rot(vflip);
-}
-
-void
-TestObject::attach(const std::string&amp; spritename,
-                   const std::string&amp; attachement_point)
-{
-  AttachedSprite asprite;
-  asprite.sprite = Sprite3D(spritename);
-  asprite.attachpoint = sprite.get_attachment_point_id(attachement_point);
-  attached_sprites.push_back(asprite);
-}
-
-/* EOF */

Deleted: trunk/src/test_object.hpp
===================================================================
--- trunk/src/test_object.hpp	2006-01-11 23:04:21 UTC (rev 1217)
+++ trunk/src/test_object.hpp	2006-01-12 02:55:49 UTC (rev 1218)
@@ -1,37 +0,0 @@
-#ifndef __TEST_OBJECT_HPP__
-#define __TEST_OBJECT_HPP__
-
-#include &lt;vector&gt;
-#include &quot;game_object.hpp&quot;
-#include &quot;sprite3d/sprite3d.hpp&quot;
-#include &quot;math/vector.hpp&quot;
-#include &quot;lisp/lisp.hpp&quot;
-
-class TestObject : public GameObject
-{
-public:
-  TestObject(FileReader&amp; reader);
-  virtual ~TestObject();
-
-  void draw(SceneContext&amp; context);
-  void update(float delta);
-
-  void set_sprite(const std::string&amp; filename);
-  void set_action(const std::string&amp; action);
-  void set_vflip(bool vflip);
-  void set_pos(const Vector&amp; pos);
-  void attach(const std::string&amp; spritename,
-		      const std::string&amp; attachement_point);
-
-private:
-  Sprite3D sprite;
-  struct AttachedSprite {
-    Sprite3D sprite;
-    Sprite3D::PointID attachpoint;
-  };
-  std::vector&lt;AttachedSprite&gt; attached_sprites;
-  Vector pos;
-};
-
-#endif
-


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000870.html">[Windstille-commit] r1217 - in trunk: data/shader src src/display
</A></li>
	<LI>Next message: <A HREF="000872.html">[Windstille-commit] r1219 - in trunk/src: . objects
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#871">[ date ]</a>
              <a href="thread.html#871">[ thread ]</a>
              <a href="subject.html#871">[ subject ]</a>
              <a href="author.html#871">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/windstille-commit">More information about the Windstille-commit
mailing list</a><br>
</body></html>
