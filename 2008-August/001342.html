<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Windstille-commit] r2345 - in trunk/griv: . src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/windstille-commit/2008-August/index.html" >
   <LINK REL="made" HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r2345%20-%20in%20trunk/griv%3A%20.%20src&In-Reply-To=%3C200808202159.m7KLx06I030724%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001341.html">
   <LINK REL="Next"  HREF="001343.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Windstille-commit] r2345 - in trunk/griv: . src</H1>
    <B>grumbel at BerliOS</B> 
    <A HREF="mailto:windstille-commit%40lists.berlios.de?Subject=Re%3A%20%5BWindstille-commit%5D%20r2345%20-%20in%20trunk/griv%3A%20.%20src&In-Reply-To=%3C200808202159.m7KLx06I030724%40sheep.berlios.de%3E"
       TITLE="[Windstille-commit] r2345 - in trunk/griv: . src">grumbel at mail.berlios.de
       </A><BR>
    <I>Wed Aug 20 23:59:00 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001341.html">[Windstille-commit] r2344 - trunk/griv
</A></li>
        <LI>Next message: <A HREF="001343.html">[Windstille-commit] r2346 - trunk/griv/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1342">[ date ]</a>
              <a href="thread.html#1342">[ thread ]</a>
              <a href="subject.html#1342">[ subject ]</a>
              <a href="author.html#1342">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: grumbel
Date: 2008-08-20 23:58:58 +0200 (Wed, 20 Aug 2008)
New Revision: 2345

Added:
   trunk/griv/src/
   trunk/griv/src/blob.cpp
   trunk/griv/src/blob.hpp
   trunk/griv/src/database_thread.cpp
   trunk/griv/src/database_thread.hpp
   trunk/griv/src/file_database.cpp
   trunk/griv/src/file_database.hpp
   trunk/griv/src/filesystem.cpp
   trunk/griv/src/filesystem.hpp
   trunk/griv/src/framebuffer.cpp
   trunk/griv/src/framebuffer.hpp
   trunk/griv/src/grid.hpp
   trunk/griv/src/griv.cpp
   trunk/griv/src/griv.hpp
   trunk/griv/src/image.cpp
   trunk/griv/src/image.hpp
   trunk/griv/src/job_handle.cpp
   trunk/griv/src/job_handle.hpp
   trunk/griv/src/jpeg.cpp
   trunk/griv/src/jpeg.hpp
   trunk/griv/src/jpeg_decoder_thread.cpp
   trunk/griv/src/jpeg_decoder_thread.hpp
   trunk/griv/src/jpeg_image.cpp
   trunk/griv/src/jpeg_image.hpp
   trunk/griv/src/jpeg_memory_dest.cpp
   trunk/griv/src/jpeg_memory_dest.hpp
   trunk/griv/src/jpeg_memory_src.cpp
   trunk/griv/src/jpeg_memory_src.hpp
   trunk/griv/src/math.cpp
   trunk/griv/src/math.hpp
   trunk/griv/src/math/
   trunk/griv/src/md5.cpp
   trunk/griv/src/md5.hpp
   trunk/griv/src/software_surface.cpp
   trunk/griv/src/software_surface.hpp
   trunk/griv/src/sqlite.cpp
   trunk/griv/src/sqlite.hpp
   trunk/griv/src/surface.cpp
   trunk/griv/src/surface.hpp
   trunk/griv/src/texture.cpp
   trunk/griv/src/texture.hpp
   trunk/griv/src/thread.cpp
   trunk/griv/src/thread.hpp
   trunk/griv/src/thread_message_queue.hpp
   trunk/griv/src/tile_database.cpp
   trunk/griv/src/tile_database.hpp
   trunk/griv/src/tile_generator.cpp
   trunk/griv/src/tile_generator.hpp
   trunk/griv/src/tile_generator_thread.cpp
   trunk/griv/src/tile_generator_thread.hpp
   trunk/griv/src/url.cpp
   trunk/griv/src/url.hpp
   trunk/griv/src/viewer.cpp
   trunk/griv/src/viewer.hpp
   trunk/griv/src/viewer_thread.cpp
   trunk/griv/src/viewer_thread.hpp
   trunk/griv/src/workspace.cpp
   trunk/griv/src/workspace.hpp
Removed:
   trunk/griv/blob.cpp
   trunk/griv/blob.hpp
   trunk/griv/database_thread.cpp
   trunk/griv/database_thread.hpp
   trunk/griv/file_database.cpp
   trunk/griv/file_database.hpp
   trunk/griv/filesystem.cpp
   trunk/griv/filesystem.hpp
   trunk/griv/framebuffer.cpp
   trunk/griv/framebuffer.hpp
   trunk/griv/grid.hpp
   trunk/griv/griv.cpp
   trunk/griv/griv.hpp
   trunk/griv/image.cpp
   trunk/griv/image.hpp
   trunk/griv/job_handle.cpp
   trunk/griv/job_handle.hpp
   trunk/griv/jpeg.cpp
   trunk/griv/jpeg.hpp
   trunk/griv/jpeg_decoder_thread.cpp
   trunk/griv/jpeg_decoder_thread.hpp
   trunk/griv/jpeg_image.cpp
   trunk/griv/jpeg_image.hpp
   trunk/griv/jpeg_memory_dest.cpp
   trunk/griv/jpeg_memory_dest.hpp
   trunk/griv/jpeg_memory_src.cpp
   trunk/griv/jpeg_memory_src.hpp
   trunk/griv/math.cpp
   trunk/griv/math.hpp
   trunk/griv/math/
   trunk/griv/md5.cpp
   trunk/griv/md5.hpp
   trunk/griv/software_surface.cpp
   trunk/griv/software_surface.hpp
   trunk/griv/sqlite.cpp
   trunk/griv/sqlite.hpp
   trunk/griv/surface.cpp
   trunk/griv/surface.hpp
   trunk/griv/texture.cpp
   trunk/griv/texture.hpp
   trunk/griv/thread.cpp
   trunk/griv/thread.hpp
   trunk/griv/thread_message_queue.hpp
   trunk/griv/tile_database.cpp
   trunk/griv/tile_database.hpp
   trunk/griv/tile_generator.cpp
   trunk/griv/tile_generator.hpp
   trunk/griv/tile_generator_thread.cpp
   trunk/griv/tile_generator_thread.hpp
   trunk/griv/url.cpp
   trunk/griv/url.hpp
   trunk/griv/viewer.cpp
   trunk/griv/viewer.hpp
   trunk/griv/viewer_thread.cpp
   trunk/griv/viewer_thread.hpp
   trunk/griv/workspace.cpp
   trunk/griv/workspace.hpp
Modified:
   trunk/griv/README
   trunk/griv/SConstruct
Log:
Moved code into src/ subdirectory

Modified: trunk/griv/README
===================================================================
--- trunk/griv/README	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/README	2008-08-20 21:58:58 UTC (rev 2345)
@@ -4,9 +4,9 @@
 griv is a image viewer that allows you to directly zoom into large
 collection of thumbnails down to the images original size. Its goal is
 to allow its viewer to view 100'000 images at once, fluently without
-any noticable load times. griv requires currently a tile cache to make
-this work, which require around 1.5 times as much diskspace as the
-original image data.
+any noticable load times. griv requires a tile cache to make this
+work, which require around 1.5x times as much diskspace as the original
+image data. 
 
 
 Required Libraries:
@@ -15,13 +15,14 @@
 On Ubuntu you have to do a:
 
 apt-get install \
-libsqlite3-dev \
-libmhash-dev \
-libglew1.5-dev \
-libjpeg62-dev \
-scons
+  libsqlite3-dev \
+  libmhash-dev \
+  libglew1.5-dev \
+  libjpeg62-dev \
+  scons
 
-And make sure you have OpenGL installed. For other distributions library names might be a little different.
+And make sure you have OpenGL installed. For other distributions
+library names might be a little different.
 
 
 Bugs:
@@ -29,8 +30,8 @@
 
 When zooming into an images one will see noticable seams at the areas
 where the tiles meet. A possible fix for this would be to add a 1px
-width border to the tiles, but that would screw up the tile generation
-process from JPEG data.
+width border to the tiles, but that would slow down the tile
+generation process from JPEG data, so it might never get implemented.
 
 
 # EOF #

Modified: trunk/griv/SConstruct
===================================================================
--- trunk/griv/SConstruct	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/SConstruct	2008-08-20 21:58:58 UTC (rev 2345)
@@ -9,38 +9,38 @@
 griv_env.ParseConfig(&quot;sdl-config --libs --cflags&quot;)
 griv_env.ParseConfig(&quot;pkg-config sqlite3 --libs --cflags&quot;)
 griv_env.Program('griv', [
-        'blob.cpp',
-        'math.cpp',
-        'math/size.cpp',
-        'math/rect.cpp',
-        'math/vector2i.cpp',
-        'math/vector2f.cpp',
-        'math/vector3f.cpp',
-        'file_database.cpp',
-        'filesystem.cpp',
-        'framebuffer.cpp',
-        'jpeg.cpp',
-        'jpeg_image.cpp',
-        'jpeg_memory_src.cpp',
-        'jpeg_memory_dest.cpp',
-        'jpeg_decoder_thread.cpp',
-        'job_handle.cpp',
-        'griv.cpp',
-        'image.cpp',
-        'md5.cpp',
-        'software_surface.cpp',
-        'sqlite.cpp',
-        'surface.cpp',
-        'texture.cpp',
-        'thread.cpp',
-        'tile_database.cpp',
-        'tile_generator.cpp',
-        'tile_generator_thread.cpp',
-        'database_thread.cpp',
-        'viewer_thread.cpp',
-        'url.cpp',
-        'viewer.cpp',
-        'workspace.cpp',
+        'src/blob.cpp',
+        'src/math.cpp',
+        'src/math/size.cpp',
+        'src/math/rect.cpp',
+        'src/math/vector2i.cpp',
+        'src/math/vector2f.cpp',
+        'src/math/vector3f.cpp',
+        'src/file_database.cpp',
+        'src/filesystem.cpp',
+        'src/framebuffer.cpp',
+        'src/jpeg.cpp',
+        'src/jpeg_image.cpp',
+        'src/jpeg_memory_src.cpp',
+        'src/jpeg_memory_dest.cpp',
+        'src/jpeg_decoder_thread.cpp',
+        'src/job_handle.cpp',
+        'src/griv.cpp',
+        'src/image.cpp',
+        'src/md5.cpp',
+        'src/software_surface.cpp',
+        'src/sqlite.cpp',
+        'src/surface.cpp',
+        'src/texture.cpp',
+        'src/thread.cpp',
+        'src/tile_database.cpp',
+        'src/tile_generator.cpp',
+        'src/tile_generator_thread.cpp',
+        'src/database_thread.cpp',
+        'src/viewer_thread.cpp',
+        'src/url.cpp',
+        'src/viewer.cpp',
+        'src/workspace.cpp',
         ])
 
 # EOF #

Deleted: trunk/griv/blob.cpp
===================================================================
--- trunk/griv/blob.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/blob.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,93 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;fstream&gt;
-#include &quot;blob.hpp&quot;
-
-class BlobImpl
-{
-public:
-  uint8_t* data;
-  int      len;
-
-  BlobImpl(const void* data_, int len_)
-  {
-    data = new uint8_t[len_];
-    len  = len_;
-
-    memcpy(data, data_, len);
-  }
-
-  BlobImpl(const std::vector&lt;uint8_t&gt;&amp; data_in)
-  {
-    data = new uint8_t[data_in.size()];
-    len  = data_in.size();
-
-    memcpy(data, &amp;*data_in.begin(), len);
-  }
-
-  ~BlobImpl()
-  {
-    delete[] data;
-  }
-};
-
-Blob::Blob(const std::vector&lt;uint8_t&gt;&amp; data)
-  : impl(new BlobImpl(data))
-{}
-
-Blob::Blob(const void* data, int len)
-  : impl(new BlobImpl(data, len))
-{}
-
-Blob::Blob()
-{}
-
-int
-Blob::size() const 
-{
-  if (impl.get())
-    return impl-&gt;len; 
-  else
-    return 0;
-}
-
-uint8_t* 
-Blob::get_data() const 
-{
-  if (impl.get())
-    return impl-&gt;data; 
-  else
-    return 0;
-}
-
-void
-Blob::write_to_file(const std::string&amp; filename)
-{
-  std::ofstream out(filename.c_str(), std::ios::binary);
-  out.write(reinterpret_cast&lt;char*&gt;(impl-&gt;data), impl-&gt;len);
-}
-
-/* EOF */

Deleted: trunk/griv/blob.hpp
===================================================================
--- trunk/griv/blob.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/blob.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,52 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_BLOB_HPP
-#define HEADER_BLOB_HPP
-
-#include &lt;boost/smart_ptr.hpp&gt;
-#include &lt;vector&gt;
-
-class BlobImpl;
-
-class Blob
-{
-public:
-  Blob();
-  Blob(const std::vector&lt;uint8_t&gt;&amp; data);
-  Blob(const void* data, int len);
-
-  int size() const;
-  uint8_t* get_data() const;
-
-  void write_to_file(const std::string&amp; filename);
-
-private: 
-  boost::shared_ptr&lt;BlobImpl&gt; impl;
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/database_thread.cpp
===================================================================
--- trunk/griv/database_thread.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/database_thread.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,273 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;iostream&gt;
-#include &lt;assert.h&gt;
-#include &quot;file_database.hpp&quot;
-#include &quot;tile_database.hpp&quot;
-#include &quot;tile_generator_thread.hpp&quot;
-#include &quot;database_thread.hpp&quot;
-
-enum DatabaseMessageType 
-{
-  DATABASE_ALL_FILES_MESSAGE,
-  DATABASE_FILE_MESSAGE,
-  DATABASE_TILE_MESSAGE,
-  DATABASE_STORE_TILE_MESSAGE
-};
-
-class DatabaseMessage
-{
-public:
-  DatabaseMessageType type;
-
-  DatabaseMessage(DatabaseMessageType type_)
-    : type(type_)
-  {}
-
-  virtual ~DatabaseMessage()
-  {}
-};
-
-class TileDatabaseMessage : public DatabaseMessage
-{
-public:
-  JobHandle job_handle;
-
-  int fileid;
-  int tilescale;
-  int x;
-  int y;
-  boost::function&lt;void (Tile)&gt; callback;
-
-  TileDatabaseMessage(const JobHandle&amp; job_handle,
-                      int fileid, int tilescale, int x, int y,
-                      const boost::function&lt;void (Tile)&gt;&amp; callback)
-    : DatabaseMessage(DATABASE_TILE_MESSAGE),
-      job_handle(job_handle),
-      fileid(fileid),
-      tilescale(tilescale),
-      x(x),
-      y(y),
-      callback(callback)
-  {}
-};
-
-class FileDatabaseMessage : public DatabaseMessage
-{
-public:
-  std::string filename;
-  boost::function&lt;void (FileEntry)&gt; callback;
-
-  FileDatabaseMessage(const std::string&amp; filename,
-                      const boost::function&lt;void (FileEntry)&gt;&amp; callback)
-    : DatabaseMessage(DATABASE_FILE_MESSAGE),
-      filename(filename),
-      callback(callback)
-  {}
-};
-
-class AllFilesDatabaseMessage : public DatabaseMessage
-{
-public:
-  boost::function&lt;void (FileEntry)&gt; callback;
-
-  AllFilesDatabaseMessage(const boost::function&lt;void (FileEntry)&gt;&amp; callback)
-    : DatabaseMessage(DATABASE_ALL_FILES_MESSAGE),
-      callback(callback)
-  {
-  }
-};
-
-class StoreTileDatabaseMessage : public DatabaseMessage
-{
-public:
-  Tile tile;
-
-  StoreTileDatabaseMessage(const Tile&amp; tile)
-    : DatabaseMessage(DATABASE_STORE_TILE_MESSAGE),
-      tile(tile)
-  {}
-};
-
-DatabaseThread* DatabaseThread::current_ = 0;
-
-DatabaseThread::DatabaseThread(const std::string&amp; filename_)
-  : database_filename(filename_),
-    quit(false)
-{
-  assert(current_ == 0);
-  current_ = this;
-}
-
-DatabaseThread::~DatabaseThread()
-{
-}
-
-JobHandle
-DatabaseThread::request_tile(int fileid, int tilescale, int x, int y, const boost::function&lt;void (Tile)&gt;&amp; callback)
-{
-  JobHandle job_handle;
-  queue.push(new TileDatabaseMessage(job_handle, fileid, tilescale, x, y, callback));
-  return job_handle;
-}
-
-void
-DatabaseThread::request_file(const std::string&amp; filename, const boost::function&lt;void (FileEntry)&gt;&amp; callback)
-{
-  queue.push(new FileDatabaseMessage(filename, callback));
-}
-
-void
-DatabaseThread::request_all_files(const boost::function&lt;void (FileEntry)&gt;&amp; callback)
-{
-  queue.push(new AllFilesDatabaseMessage(callback));
-}
-
-void
-DatabaseThread::store_tile(const Tile&amp; tile)
-{
-  queue.push(new StoreTileDatabaseMessage(tile));
-}
-
-void
-DatabaseThread::stop()
-{
-  quit = true;
-}
-
-int
-DatabaseThread::run()
-{
-  quit = false;
-
-  std::cout &lt;&lt; &quot;Connecting to the database...&quot; &lt;&lt; std::endl;
-  SQLiteConnection db(database_filename);
-  FileDatabase file_db(&amp;db);
-  TileDatabase tile_db(&amp;db);
-  std::cout &lt;&lt; &quot;Connecting to the database... done&quot; &lt;&lt; std::endl;
-
-  std::vector&lt;DatabaseMessage*&gt; messages;
-  while(!quit)
-    {
-      //std::cout &lt;&lt; &quot;DatabaseThread: looping&quot; &lt;&lt; std::endl;
-      
-      // do things
-      while(!queue.empty() &amp;&amp; !quit)
-        {
-          messages.push_back(queue.front());
-          queue.pop();
-        }
-
-      if (!messages.empty())
-        {
-          DatabaseMessage* msg = messages.back();
-          messages.pop_back();
-
-          switch(msg-&gt;type)
-            {
-              case DATABASE_STORE_TILE_MESSAGE:
-                {
-                  StoreTileDatabaseMessage* tile_msg = static_cast&lt;StoreTileDatabaseMessage*&gt;(msg);
-                  tile_db.store_tile(tile_msg-&gt;tile);
-                }
-                break;
-
-              case DATABASE_FILE_MESSAGE:
-                {
-                  FileDatabaseMessage* file_msg = static_cast&lt;FileDatabaseMessage*&gt;(msg);
-                  FileEntry entry;
-
-                  //std::cout &lt;&lt; &quot;Lookup for: &quot; &lt;&lt; file_msg-&gt;filename &lt;&lt; std::endl;
-                  if (file_db.get_file_entry(file_msg-&gt;filename, &amp;entry))
-                    {
-                      //std::cout &lt;&lt; entry.filename &lt;&lt; &quot; -&gt; &quot; &lt;&lt; entry.fileid &lt;&lt; std::endl;
-                      file_msg-&gt;callback(entry);
-                    }
-                  else
-                    {
-                      std::cout &lt;&lt; &quot;Error: Couldn't get FileEntry for &quot; &lt;&lt; file_msg-&gt;filename &lt;&lt; std::endl;
-                    }
-                }
-                break;
-
-              case DATABASE_ALL_FILES_MESSAGE:
-                {
-                  AllFilesDatabaseMessage* all_files_msg = static_cast&lt;AllFilesDatabaseMessage*&gt;(msg);
-                  std::vector&lt;FileEntry&gt; entries;
-                  file_db.get_file_entries(entries);
-                  for(std::vector&lt;FileEntry&gt;::iterator i = entries.begin(); i != entries.end(); ++i)
-                    {
-                      all_files_msg-&gt;callback(*i);
-                    }
-                }
-                break;
-
-              case DATABASE_TILE_MESSAGE:
-                {
-                  TileDatabaseMessage* tile_msg = static_cast&lt;TileDatabaseMessage*&gt;(msg);
-
-                  if (!tile_msg-&gt;job_handle.is_aborted())
-                    {
-                      Tile tile;
-                      if (tile_db.get_tile(tile_msg-&gt;fileid, tile_msg-&gt;tilescale, tile_msg-&gt;x, tile_msg-&gt;y, tile))
-                        {
-                          tile_msg-&gt;callback(tile);
-                          tile_msg-&gt;job_handle.finish();
-                        }
-                      else
-                        {
-                          if (0)
-                            std::cout &lt;&lt; &quot;Error: Couldn't get tile: &quot; 
-                                      &lt;&lt; tile_msg-&gt;fileid &lt;&lt; &quot; &quot;
-                                      &lt;&lt; tile_msg-&gt;x &lt;&lt; &quot; &quot;
-                                      &lt;&lt; tile_msg-&gt;y &lt;&lt; &quot; &quot;
-                                      &lt;&lt; tile_msg-&gt;tilescale
-                                      &lt;&lt; std::endl;
-
-                          tile_msg-&gt;job_handle.finish();
-                          // Need to send loading command back
-                          //TileGeneratorThread::request_tile(fileid, x, y, tilescale);
-                        }
-                    }
-                }
-                break;
-
-              default:
-                assert(!&quot;Unknown message type&quot;);
-            }
-
-          delete msg;
-        }
-      else
-        {
-          queue.wait();
-        }
-    }
-
-  return 0;
-}
-
-/* EOF */

Deleted: trunk/griv/database_thread.hpp
===================================================================
--- trunk/griv/database_thread.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/database_thread.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,75 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_DATABASE_THREAD_HPP
-#define HEADER_DATABASE_THREAD_HPP
-
-#include &lt;boost/function.hpp&gt;
-#include &lt;string&gt;
-#include &quot;thread_message_queue.hpp&quot;
-#include &quot;file_database.hpp&quot;
-#include &quot;tile_database.hpp&quot;
-#include &quot;job_handle.hpp&quot;
-#include &quot;thread.hpp&quot;
-
-class DatabaseMessage;
-
-/** */
-class DatabaseThread : public Thread
-{
-private:
-  static DatabaseThread* current_;
-public:
-  static DatabaseThread* current() { return current_; }
-  
-private:
-  std::string database_filename;
-  bool quit;
-  
-  ThreadMessageQueue&lt;DatabaseMessage*&gt; queue;
-
-protected: 
-  int run();
-
-public:
-  DatabaseThread(const std::string&amp;);
-  virtual ~DatabaseThread();
-  
-  void stop();
-  
-  JobHandle request_tile(int fileid, int tilescale, int x, int y, const boost::function&lt;void (Tile)&gt;&amp; callback);
-  void request_file(const std::string&amp; filename, const boost::function&lt;void (FileEntry)&gt;&amp; callback);
-  void request_all_files(const boost::function&lt;void (FileEntry)&gt;&amp; callback);
-
-  void store_tile(const Tile&amp; tile);
-
-private:
-  DatabaseThread (const DatabaseThread&amp;);
-  DatabaseThread&amp; operator= (const DatabaseThread&amp;);
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/file_database.cpp
===================================================================
--- trunk/griv/file_database.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/file_database.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,197 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;iostream&gt;
-#include &lt;sstream&gt;
-#include &lt;stdexcept&gt;
-
-#include &lt;assert.h&gt;
-#include &quot;jpeg.hpp&quot;
-#include &quot;filesystem.hpp&quot;
-#include &quot;software_surface.hpp&quot;
-#include &quot;file_database.hpp&quot;
-
-std::ostream&amp; operator&lt;&lt;(std::ostream&amp; os, const FileEntry&amp; entry)
-{
-  return os &lt;&lt; &quot;filename: &quot; &lt;&lt; entry.filename &lt;&lt; &quot; size: &quot;&lt;&lt; entry.size;
-}
-
-FileDatabase::FileDatabase(SQLiteConnection* db)
-  : db(db),
-    store_stmt(db),
-    get_by_filename_stmt(db),
-    get_all_stmt(db),
-    get_by_file_id_stmt(db)
-{
-  db-&gt;exec(&quot;CREATE TABLE IF NOT EXISTS files (&quot;
-           &quot;fileid    INTEGER PRIMARY KEY AUTOINCREMENT,&quot;
-           &quot;filename  TEXT UNIQUE, &quot;
-           &quot;md5       TEXT, &quot;
-           &quot;filesize  INTEGER, &quot;
-           &quot;width     INTEGER, &quot;
-           &quot;height    INTEGER, &quot;
-           &quot;mtime     INTEGER);&quot;);
-
-  db-&gt;exec(&quot;CREATE UNIQUE INDEX IF NOT EXISTS files_index ON files ( filename );&quot;);
-
-  store_stmt.prepare(&quot;INSERT INTO files (filename, md5, filesize, width, height, mtime) VALUES (?1, ?2, ?3, ?4, ?5, ?6);&quot;);
-  get_by_filename_stmt.prepare(&quot;SELECT * FROM files WHERE filename = ?1;&quot;);
-  get_by_file_id_stmt.prepare(&quot;SELECT * FROM files WHERE rowid = ?1;&quot;);
-  get_all_stmt.prepare(&quot;SELECT * FROM files&quot;);
-}
- 
-FileDatabase::~FileDatabase()
-{
-
-}
- 
-int
-FileDatabase::store_file_entry(FileEntry&amp; entry)
-{
-  assert(entry.fileid == -1);
-
-  store_stmt.bind_text(1, entry.filename);
-  if (entry.md5.empty())
-    store_stmt.bind_null(2);
-  else
-    store_stmt.bind_text(2, entry.md5);
-  store_stmt.bind_int (3, entry.filesize); 
-  store_stmt.bind_int (4, entry.size.width); 
-  store_stmt.bind_int (5, entry.size.height);
-  store_stmt.bind_int (6, entry.mtime); 
-
-  store_stmt.execute();
-  
-  entry.fileid = sqlite3_last_insert_rowid(db-&gt;get_db());
-
-  return entry.fileid;
-}
-
-bool
-FileDatabase::get_file_entry(const std::string&amp; filename, FileEntry* entry)
-{
-  get_by_filename_stmt.bind_text(1, filename);
-  SQLiteReader reader = get_by_filename_stmt.execute_query();
-
-  if (reader.next())
-    {
-      if (0)
-        std::cout &lt;&lt; &quot;Row: &quot; 
-                  &lt;&lt; reader.get_column_name(0) &lt;&lt; &quot; &quot;
-                  &lt;&lt; reader.get_text(0)
-                  &lt;&lt; std::endl;
-
-      entry-&gt;fileid      = reader.get_int (0);
-      entry-&gt;filename    = reader.get_text(1);
-      entry-&gt;md5         = reader.get_text(2);
-      entry-&gt;filesize    = reader.get_int (3);
-      entry-&gt;size.width  = reader.get_int (4);
-      entry-&gt;size.height = reader.get_int (5);
-
-      return true;
-    }
-  else
-    {
-      entry-&gt;fileid   = -1;
-      entry-&gt;filename = filename;
-      entry-&gt;filesize = Filesystem::get_size(filename);
-      entry-&gt;mtime    = Filesystem::get_mtime(filename);
-      
-      entry-&gt;size = Size(-1, -1);
-      
-      JPEG::get_size(entry-&gt;filename, entry-&gt;size);
-
-      store_file_entry(*entry);
-      
-      return true;
-    }
-}
-
-void
-FileDatabase::get_file_entries(std::vector&lt;FileEntry&gt;&amp; entries)
-{
-  SQLiteReader reader = get_all_stmt.execute_query();
-
-  while (reader.next())  
-    {
-      FileEntry entry;
-      entry.fileid      = reader.get_int (0);
-      entry.filename    = reader.get_text(1);
-      entry.md5         = reader.get_text(2);
-      entry.filesize    = reader.get_int (3);
-      entry.size.width  = reader.get_int (4);
-      entry.size.height = reader.get_int (5);
-      entry.mtime       = reader.get_int (6);
-
-      entries.push_back(entry);
-    }
-}
-
-void
-FileDatabase::delete_file_entry(uint32_t fileid)
-{
-  // DELETE FROM files WHERE fileid = ?fileid
-}
-
-void
-FileDatabase::update_file_entry(FileEntry&amp; entry)
-{
-  // UPDATE files SET mtime = ?entry.get_mtime() WHERE fileid = ?entry.fileid
-}
-
-void
-FileDatabase::check()
-{
-  std::vector&lt;FileEntry&gt; entries;
-  get_file_entries(entries);
-
-  std::cout &lt;&lt; &quot;Checking File Existance:&quot; &lt;&lt; std::endl;
-  for(std::vector&lt;FileEntry&gt;::iterator i = entries.begin(); i != entries.end(); ++i)
-    {
-      if (!Filesystem::exist(i-&gt;filename))
-        {
-          std::cout &lt;&lt; i-&gt;filename &lt;&lt; &quot;: does not exist&quot; &lt;&lt; std::endl;
-        }
-      else
-        {
-          std::cout &lt;&lt; i-&gt;filename &lt;&lt; &quot;: ok&quot; &lt;&lt; std::endl;
-        }
-    } 
-
-  /* FIXME: Do magic to detect duplicate file entries and other potential damage to the database (are missing tiles an error?) 
-
-    SQLiteStatement duplicates_stmt(db);
-    duplicates_stmt.prepare(&quot;SELECT * IN files (filename, md5, filesize, width, height, mtime) VALUES (?1, ?2, ?3, ?4, ?5, ?6);&quot;);
-    SELECT filename,
-    COUNT(filename) AS NumOccurrences
-    FROM files
-    GROUP BY filename
-    HAVING ( COUNT(filename) &gt; 1 )
-    
-    SQLiteReader reader = duplicates_stmt.execute_query();
-  */
-}
-
-/* EOF */

Deleted: trunk/griv/file_database.hpp
===================================================================
--- trunk/griv/file_database.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/file_database.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,95 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_FILE_DATABASE_HPP
-#define HEADER_FILE_DATABASE_HPP
-
-#include &lt;stdint.h&gt;
-#include &lt;sqlite3.h&gt;
-#include &lt;string&gt;
-
-#include &quot;sqlite.hpp&quot;
-#include &quot;math/size.hpp&quot;
-
-struct FileEntry 
-{
-  int         fileid;
-  std::string filename; // 
-  std::string md5;      //
-  int         filesize; //
-  uint32_t    mtime;    // mtime of the file
-  Size        size;
-};
-
-std::ostream&amp; operator&lt;&lt;(std::ostream&amp; os, const FileEntry&amp; entry);
-
-/** The FileDatabase keeps a record of all files that have been
-    view. It keeps information on the last modification time and
-    filesize to detect a need to regenerate the tiles and also handles
-    the mapping from filename to fileid, which is used for loookup of
-    tiles in the TileDatabase. The FileDatabase also stores the size
-    of an image, so that the image file itself doesn't need to be
-    touched.
- */
-class FileDatabase
-{
-private:
-  SQLiteConnection* db;
-  SQLiteStatement store_stmt;
-  SQLiteStatement get_by_filename_stmt;
-  SQLiteStatement get_all_stmt;
-  SQLiteStatement get_by_file_id_stmt;
-
-  int  store_file_entry(FileEntry&amp; entry);
-  void delete_file_entry(uint32_t fileid);
-  void update_file_entry(FileEntry&amp; entry);
- 
-public:
-  FileDatabase(SQLiteConnection* db);
-  ~FileDatabase();
-  
-  /** Lookup a FileEntry by its filename. If there is no corresponding
-      filename, then the file will be looked up in the filesystem and
-      then stored in the DB and returned. If the file can't be found
-      in either the DB or the filesystem false will be returned, else
-      true
-      
-      @param[in] filename The absolute path of the file
-      @param[out] entry   Lokation where the file information will be stored 
-      @return true if lookup was successful, false otherwise, in which case entry stays untouched
-  */
-  bool get_file_entry(const std::string&amp; filename, FileEntry* entry);
-  void get_file_entries(std::vector&lt;FileEntry&gt;&amp; entries);
-
-  void check();
-
-private:
-  FileDatabase (const FileDatabase&amp;);
-  FileDatabase&amp; operator= (const FileDatabase&amp;);
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/filesystem.cpp
===================================================================
--- trunk/griv/filesystem.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/filesystem.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,342 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;fstream&gt;
-#include &lt;dirent.h&gt;
-#include &lt;errno.h&gt;
-#include &lt;iostream&gt;
-#include &lt;stdexcept&gt;
-#include &lt;sys/stat.h&gt;
-#include &lt;sys/stat.h&gt;
-#include &lt;sys/types.h&gt;
-#include &lt;unistd.h&gt;
-#include &lt;sys/time.h&gt;
-#include &lt;utime.h&gt;
-#include &lt;boost/format.hpp&gt;
-//#include &lt;attr/xattr.h&gt;
-
-#include &quot;filesystem.hpp&quot;
-
-std::string Filesystem::home_directory;
-
-bool
-Filesystem::exist(const std::string&amp; pathname)
-{
-  return access(pathname.c_str(), F_OK) == 0;
-}
-
-bool
-Filesystem::is_directory(const std::string&amp; pathname)
-{
-  struct stat buf;
-  stat(pathname.c_str(), &amp;buf);
-  return S_ISDIR(buf.st_mode);
-}
-
-void
-Filesystem::open_directory_recursivly(const std::string&amp; pathname, std::vector&lt;std::string&gt;&amp; lst)
-{
-  DIR* dp = ::opendir(pathname.c_str());
-
-  if (dp == 0)
-    {
-      std::cout &lt;&lt; &quot;System: Couldn't open: &quot; &lt;&lt; pathname &lt;&lt; std::endl;
-    }
-  else
-    {
-      dirent* de = 0;
-      while ((de = ::readdir(dp)) != 0)
-        {
-          if (strcmp(de-&gt;d_name, &quot;.&quot;)  != 0 &amp;&amp;
-              strcmp(de-&gt;d_name, &quot;..&quot;) != 0)
-            {
-              if (de-&gt;d_type == DT_DIR)
-                { // Avoid stat'ing on file systems that don't need it
-                  open_directory_recursivly(pathname + &quot;/&quot; + de-&gt;d_name, lst);
-                } // FIXME: Check for DT_UNKNOWN, DT_FILE, etc.
-              else
-                {
-                  std::string new_path = pathname + &quot;/&quot; + de-&gt;d_name;
-                  if (is_directory(new_path))
-                    {
-                      open_directory_recursivly(pathname + &quot;/&quot; + de-&gt;d_name, lst);
-                    }
-                  else
-                    {
-                      lst.push_back(new_path);
-                    }
-                }
-            }
-        }
-
-      closedir(dp);
-    }
-}
-
-std::vector&lt;std::string&gt;
-Filesystem::open_directory(const std::string&amp; pathname)
-{
-  std::vector&lt;std::string&gt; dir_list;
-
-  DIR* dp    = 0;
-  dirent* de = 0;
-
-  dp = ::opendir(pathname.c_str());
-
-  if (dp == 0)
-    {
-      std::cout &lt;&lt; &quot;System: Couldn't open: &quot; &lt;&lt; pathname &lt;&lt; std::endl;
-    }
-  else
-    {
-      while ((de = ::readdir(dp)) != 0)
-        {
-          if (strcmp(de-&gt;d_name, &quot;.&quot;)  != 0 &amp;&amp;
-              strcmp(de-&gt;d_name, &quot;..&quot;) != 0)
-            dir_list.push_back(pathname + &quot;/&quot; + de-&gt;d_name);
-        }
-
-      closedir(dp);
-    }
-
-  return dir_list;
-}
-
-void
-Filesystem::init()
-{
-  char* home;
-  if ((home = getenv(&quot;HOME&quot;)))
-    {
-      home_directory = home;
-    }
-  else
-    {
-      throw std::runtime_error(&quot;Couldn't get HOME environment variable&quot;);
-    }
-
-  mkdir(home_directory + &quot;/.griv&quot;);
-}
-
-void
-Filesystem::mkdir(const std::string&amp; pathname)
-{
-  if (!Filesystem::exist(pathname))
-    {
-      if (::mkdir(pathname.c_str(), S_IRUSR | S_IWUSR | S_IXUSR | S_IRGRP | S_IXGRP) != 0)
-	{
-	  throw std::runtime_error(&quot;Filesystem::mkdir: &quot; + pathname + &quot;: &quot; + strerror(errno));
-	}
-      else
-	{
-	  std::cout &lt;&lt; &quot;Filesystem::mkdir: &quot; &lt;&lt; pathname &lt;&lt; std::endl;
-	}
-    }
-}
-
-void
-Filesystem::deinit()
-{
-}
-
-bool
-Filesystem::has_extension(const std::string&amp; str, const std::string&amp; suffix)
-{
-  if (str.length() &gt;= suffix.length())
-    return str.compare(str.length() - suffix.length(), suffix.length(), suffix) == 0;
-  else
-    return false;
-}
-
-void
-Filesystem::copy_mtime(const std::string&amp; from_filename, const std::string&amp; to_filename)
-{
-  struct stat stat_buf;
-  if (stat(from_filename.c_str(), &amp;stat_buf) != 0)
-    {
-      throw std::runtime_error(from_filename + &quot;: &quot; + strerror(errno));
-    }
-
-  struct utimbuf time_buf; 
-  time_buf.actime  = stat_buf.st_atime;
-  time_buf.modtime = stat_buf.st_mtime;
-
-  if (utime(to_filename.c_str(), &amp;time_buf) != 0)
-    {
-      std::cout &lt;&lt; &quot;Filesystem:copy_mtime: &quot; &lt;&lt; to_filename &lt;&lt; &quot;: &quot; &lt;&lt; strerror(errno) &lt;&lt; std::endl;
-    }
-}
-
-unsigned int
-Filesystem::get_size(const std::string&amp; filename)
-{
-  struct stat stat_buf;
-  if (stat(filename.c_str(), &amp;stat_buf) != 0)
-    {
-      throw std::runtime_error(filename + &quot;: &quot; + strerror(errno));
-    } 
-  return stat_buf.st_size; // Is this reliable? or should be use fopen() and ftell()?
-}
-
-unsigned int
-Filesystem::get_mtime(const std::string&amp; filename)
-{
-  struct stat stat_buf;
-  if (stat(filename.c_str(), &amp;stat_buf) != 0)
-    {
-      throw std::runtime_error(filename + &quot;: &quot; + strerror(errno));
-    } 
-  return stat_buf.st_mtime;
-}
-
-void
-Filesystem::generate_jpeg_file_list(const std::string&amp; pathname, std::vector&lt;std::string&gt;&amp; file_list)
-{
-  std::vector&lt;std::string&gt; lst;
-  if (is_directory(pathname))
-    open_directory_recursivly(pathname, lst);
-  else
-    lst.push_back(pathname);
-  
-  for(std::vector&lt;std::string&gt;::iterator i = lst.begin(); i != lst.end(); ++i)
-    {
-      if (Filesystem::has_extension(*i, &quot;.jpg&quot;)  ||
-          Filesystem::has_extension(*i, &quot;.JPG&quot;)  ||
-          Filesystem::has_extension(*i, &quot;.jpe&quot;)  ||
-          Filesystem::has_extension(*i, &quot;.JPE&quot;)  ||
-          Filesystem::has_extension(*i, &quot;.JPEG&quot;) ||
-          Filesystem::has_extension(*i, &quot;.jpeg&quot;))
-        {
-          file_list.push_back(Filesystem::realpath(*i)); // realpath slow?
-        }
-    }
-}
-
-std::string
-Filesystem::realpath_system(const std::string&amp; pathname)
-{
-  char* result = ::realpath(pathname.c_str(), NULL);
-  std::string res = result;
-  free(result);
-  
-  return res;
-}
-
-std::string
-Filesystem::realpath_fast(const std::string&amp; pathname)
-{
-  std::string fullpath;
-  std::string drive;
-  
-  if (pathname.size() &gt; 0 &amp;&amp; pathname[0] == '/')
-    {
-      fullpath = pathname;
-    }
-#ifdef WIN32
-  else if (pathname.size() &gt; 2 &amp;&amp; pathname[1] == ':' &amp;&amp; pathname[2] == '/')
-    {
-      drive = pathname.substr(0, 2);
-      fullpath = pathname;
-    }
-#endif
-  else
-    {
-      char buf[PATH_MAX];
-      if (getcwd(buf, PATH_MAX) == 0)
-        {
-          std::cout &lt;&lt; &quot;System::realpath: Error: couldn't getcwd()&quot; &lt;&lt; std::endl;
-          return pathname;
-        }
-#ifdef WIN32
-      for (char *p = buf; *p; ++p)
-        {
-          if (*p == '\\')
-            *p = '/';
-        }
-      drive.assign(buf, 2);
-#endif
-      
-      fullpath = fullpath + buf + &quot;/&quot; + pathname;
-    }
-  
-  std::string result;
-  std::string::reverse_iterator last_slash = fullpath.rbegin();
-  int skip = 0;
-  // /foo/bar/../../bar/baz/
-  //std::cout &lt;&lt; &quot;fullpath: '&quot; &lt;&lt; fullpath &lt;&lt; &quot;'&quot; &lt;&lt; std::endl;
-  for(std::string::reverse_iterator i = fullpath.rbegin(); i != fullpath.rend(); ++i)
-    { // FIXME: Little crude and hackish
-      if (*i == '/')
-        {
-          std::string dir(last_slash, i); 
-          //std::cout &lt;&lt; &quot;'&quot; &lt;&lt; dir &lt;&lt; &quot;'&quot; &lt;&lt; std::endl;
-          if (dir == &quot;..&quot; || dir == &quot;/..&quot;)
-            {
-              skip += 1;
-            }
-          else if (dir == &quot;.&quot; || dir == &quot;/.&quot; || dir.empty() || dir == &quot;/&quot;)
-            {
-              // pass
-            }
-          else
-            {
-              if (skip == 0)
-                {
-                  result += dir;
-                }
-              else
-                skip -= 1;
-            }
-
-          last_slash = i;
-        }
-    }
-  
-  return drive + &quot;/&quot; + std::string(result.rbegin(), result.rend());
-}
-
-std::string
-Filesystem::realpath(const std::string&amp; pathname)
-{
-  return realpath_fast(pathname);
-}
-
-void
-Filesystem::readlines_from_file(const std::string&amp; pathname, std::vector&lt;std::string&gt;&amp; lst)
-{
-  std::ifstream in(pathname.c_str());
-
-  if (!in)
-    throw std::runtime_error(&quot;Couldn't open file: &quot; + pathname);
-  
-  std::string line;
-  while(std::getline(in, line))
-   {
-     lst.push_back(line);
-   }
-  in.close();
-}
-
-/* EOF */

Deleted: trunk/griv/filesystem.hpp
===================================================================
--- trunk/griv/filesystem.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/filesystem.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,69 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_FILESYSTEM_HPP
-#define HEADER_FILESYSTEM_HPP
-
-#include &lt;string&gt;
-#include &lt;vector&gt;
-
-class Filesystem
-{
-private:
-  static std::string home_directory;
-
-public:
-  static bool is_directory(const std::string&amp; pathname);
-  static bool exist(const std::string&amp; pathname);
-  static void mkdir(const std::string&amp; pathname);
-  static std::vector&lt;std::string&gt; open_directory(const std::string&amp; pathname);
-
-  static void open_directory_recursivly(const std::string&amp; pathname, std::vector&lt;std::string&gt;&amp; lst);
-
-  static void readlines_from_file(const std::string&amp; pathname, std::vector&lt;std::string&gt;&amp; lst);
-
-  static std::string getxattr(const std::string&amp; pathname);
-  static std::string get_home() { return home_directory; }
-
-  static std::string realpath_system(const std::string&amp; pathname);
-  static std::string realpath_fast(const std::string&amp; pathname);
-  static std::string realpath(const std::string&amp; pathname);
-
-
-  static bool has_extension(const std::string&amp; pathname, const std::string&amp; ext);
-  static void copy_mtime(const std::string&amp; from_filename, const std::string&amp; to_filename);
-  static unsigned int get_mtime(const std::string&amp; filename);
-  static unsigned int get_size(const std::string&amp; filename);
-  
-  /** Generate a recursive list of all JPEGs in pathname */
-  static void generate_jpeg_file_list(const std::string&amp; pathname, std::vector&lt;std::string&gt;&amp; file_list);
-
-  static void init();
-  static void deinit();
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/framebuffer.cpp
===================================================================
--- trunk/griv/framebuffer.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/framebuffer.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,155 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;iostream&gt;
-#include &lt;GL/glew.h&gt;
-#include &lt;GL/gl.h&gt;
-#include &quot;math/rgb.hpp&quot;
-#include &quot;SDL_syswm.h&quot;
-#include &quot;math/rect.hpp&quot;
-#include &quot;framebuffer.hpp&quot;
-
-SDL_SysWMinfo syswm;
-SDL_Surface* Framebuffer::screen = 0;
-Uint32 Framebuffer::flags = 0;
-
-void
-Framebuffer::set_video_mode(const Size&amp; size)
-{
-  assert(screen == 0);
-
-  flags = SDL_RESIZABLE | SDL_OPENGL;
-  screen = SDL_SetVideoMode(800, 600, 0, flags);
-
-  if (screen == NULL) 
-    {
-      std::cout &lt;&lt; &quot;Unable to set video mode: &quot; &lt;&lt; SDL_GetError() &lt;&lt; std::endl;
-      exit(1);
-    }
-
-  GLenum err = glewInit();
-  if (GLEW_OK != err)
-    {
-      std::ostringstream str;
-      str &lt;&lt; &quot;Error: &quot; &lt;&lt; glewGetErrorString(err) &lt;&lt; std::endl;
-      throw std::runtime_error(str.str());
-    }
-  
-  if (!GLEW_ARB_texture_rectangle)
-    {
-      throw std::runtime_error(&quot;OpenGL ARB_texture_rectangle extension not found, but required&quot;);
-    }
-
-  SDL_WM_SetCaption(&quot;Griv 0.0.2&quot;, 0 /* icon */);
-  SDL_EnableUNICODE(1);
-
-  glViewport(0, 0, screen-&gt;w, screen-&gt;h);
-  glMatrixMode(GL_PROJECTION);
-  glLoadIdentity();
-  glOrtho(0.0, screen-&gt;w, screen-&gt;h, 0.0, 1000.0, -1000.0);
-  glMatrixMode(GL_MODELVIEW);
-  glLoadIdentity();
-  //static const float cl_pixelcenter_constant = 0.375;
-  //glTranslated(cl_pixelcenter_constant, cl_pixelcenter_constant, 0.0);
-  
-  SDL_VERSION(&amp;syswm.version); // this is important!
-  if (SDL_GetWMInfo(&amp;syswm) == -1)
-    {
-      std::cout &lt;&lt; &quot;Couldn't get WM info &quot; &lt;&lt; std::endl;
-    }
-}
-
-void
-Framebuffer::toggle_fullscreen()
-{
-  flags |= SDL_OPENGL;
-  if (flags &amp; SDL_FULLSCREEN)
-    flags &amp;= ~SDL_FULLSCREEN;
-  else
-    flags |= SDL_FULLSCREEN;
- 
-  // Should use desktop resolution for this instead, but how?
-  screen = SDL_SetVideoMode(1152, 864, 0, flags); 
-  glViewport(0, 0, screen-&gt;w, screen-&gt;h);
-  glMatrixMode(GL_PROJECTION);
-  glLoadIdentity();
-  glOrtho(0.0, screen-&gt;w, screen-&gt;h, 0.0, 1000.0, -1000.0);
-}
-
-void
-Framebuffer::resize(int w, int h)
-{
-  screen = SDL_SetVideoMode(w, h, 0, SDL_OPENGL | SDL_RESIZABLE);
-  glViewport(0, 0, screen-&gt;w, screen-&gt;h);
-  glMatrixMode(GL_PROJECTION);
-  glLoadIdentity();
-  glOrtho(0.0, screen-&gt;w, screen-&gt;h, 0.0, 1000.0, -1000.0);
-}
-
-void
-Framebuffer::flip()
-{
-  //SDL_Flip(screen);
-  SDL_GL_SwapBuffers();
-}
-
-void
-Framebuffer::clear()
-{
-  glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
-  glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
-  //SDL_FillRect(Framebuffer::get_screen(), NULL, SDL_MapRGB(Framebuffer::get_screen()-&gt;format, 0, 0, 0));
-}
-
-void
-Framebuffer::draw_rect(const Rectf&amp; rect, const RGB&amp; rgb)
-{
-  glDisable(GL_TEXTURE_RECTANGLE_ARB);
-    
-  glColor3ub(rgb.r, rgb.g, rgb.b);
-
-  glBegin(GL_LINE_LOOP);
-  glVertex2f(rect.left,  rect.top);
-  glVertex2f(rect.right, rect.top);
-  glVertex2f(rect.right, rect.bottom);
-  glVertex2f(rect.left,  rect.bottom);
-  glEnd();
-}
-
-void
-Framebuffer::fill_rect(const Rectf&amp; rect, const RGB&amp; rgb)
-{
-  glDisable(GL_TEXTURE_RECTANGLE_ARB);
-
-  glColor3ub(rgb.r, rgb.g, rgb.b);
-  glBegin(GL_QUADS);
-  glVertex2f(rect.left,  rect.top);
-  glVertex2f(rect.right, rect.top);
-  glVertex2f(rect.right, rect.bottom);
-  glVertex2f(rect.left,  rect.bottom);
-  glEnd();
-}
-
-/* EOF */

Deleted: trunk/griv/framebuffer.hpp
===================================================================
--- trunk/griv/framebuffer.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/framebuffer.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,76 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_DISPLAY_HPP
-#define HEADER_DISPLAY_HPP
-
-#include &lt;GL/gl.h&gt;
-#include &lt;GL/glu.h&gt;
-#include &lt;sstream&gt;
-#include &lt;stdexcept&gt;
-#include &lt;math.h&gt;
-#include &quot;SDL.h&quot;
-
-class RGB;
-class Size;
-class Rectf;
-
-static inline void assert_gl(const char* message)
-{
-  GLenum error = glGetError();
-  if(error != GL_NO_ERROR) {
-    std::ostringstream msg;
-    msg &lt;&lt; &quot;OpenGLError while '&quot; &lt;&lt; message &lt;&lt; &quot;': &quot;
-        &lt;&lt; gluErrorString(error);
-    throw std::runtime_error(msg.str());
-  }
-}
-
-class Framebuffer
-{
-private:
-  static SDL_Surface* screen;
-  static Uint32 flags;
-
-public:
-  static void set_video_mode(const Size&amp; size);
-
-  static void toggle_fullscreen();
-
-  static int get_width()  { return screen-&gt;w; }
-  static int get_height() { return screen-&gt;h; }
-
-  static SDL_Surface* get_screen() { return screen; }
-  static void resize(int w, int h);
-  static void flip();
-  static void clear();
-
-  static void draw_rect(const Rectf&amp; rect, const RGB&amp; rgb);
-  static void fill_rect(const Rectf&amp; rect, const RGB&amp; rgb);
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/grid.hpp
===================================================================
--- trunk/griv/grid.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/grid.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,92 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_GRID_HPP
-#define HEADER_GRID_HPP
-
-#include &lt;iostream&gt;
-#include &lt;assert.h&gt;
-#include &lt;vector&gt;
-
-/** */
-template&lt;typename T&gt;
-class Grid
-{
-private:
-  typedef std::vector&lt;T&gt; Columns;
-  typedef std::vector&lt;Columns&gt; Rows;
-
-  int width;
-  int height;
-  Rows rows;
-
-public:
-  Grid(int w, int h) 
-    : width(w),
-      height(h)
-  {
-    for(int y = 0; y &lt; height; ++y)
-      rows.push_back(Columns(width));
-  }
-  
-  int get_width()  const { return width; }
-  int get_height() const { return height; }
-
-  const T&amp; operator()(int x, int y) const {
-    assert(y &gt;= 0 &amp;&amp; y &lt; rows.size());
-    assert(x &gt;= 0 &amp;&amp; x &lt; rows[y].size());
-    return rows[y][x];
-  }
-
-  T&amp; operator()(int x, int y) {
-    assert(y &gt;= 0 &amp;&amp; y &lt; int(rows.size()));
-    assert(x &gt;= 0 &amp;&amp; x &lt; int(rows[y].size()));
-    return rows[y][x];
-  }
-
-  void resize(int w, int h, const T&amp; t = T())
-  {
-    for(typename Rows::iterator i = rows.begin(); i != rows.end(); ++i)
-      i-&gt;resize(w);
-    rows.resize(h, Columns(w, t));
-
-    if (0)
-      {
-        std::cout &lt;&lt; &quot;Resize: &quot; &lt;&lt; w &lt;&lt; &quot;x&quot; &lt;&lt; h &lt;&lt; std::endl;
-        std::cout &lt;&lt; &quot;Rows: &quot; &lt;&lt; rows.size() &lt;&lt; std::endl;
-        for(int y = 0; y &lt; int(rows.size()); ++y)
-          {
-            std::cout &lt;&lt; &quot;Column: &quot; &lt;&lt; y &lt;&lt; &quot; -&gt; &quot; &lt;&lt; rows[y].size() &lt;&lt; std::endl;
-          }
-      }
-
-    width  = w;
-    height = h;
-  }
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/griv.cpp
===================================================================
--- trunk/griv/griv.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/griv.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,334 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;boost/bind.hpp&gt;
-#include &lt;algorithm&gt;
-#include &lt;sstream&gt;
-#include &lt;stdexcept&gt;
-#include &lt;iostream&gt;
-#include &lt;string&gt;
-#include &lt;vector&gt;
-#include &lt;sqlite3.h&gt;
-
-#include &quot;jpeg.hpp&quot;
-#include &quot;surface.hpp&quot;
-#include &quot;framebuffer.hpp&quot;
-#include &quot;math/size.hpp&quot;
-#include &quot;math/rect.hpp&quot;
-#include &quot;math/vector2i.hpp&quot;
-#include &quot;url.hpp&quot;
-#include &quot;sqlite.hpp&quot;
-#include &quot;software_surface.hpp&quot;
-#include &quot;jpeg_decoder_thread.hpp&quot;
-#include &quot;file_database.hpp&quot;
-#include &quot;tile_database.hpp&quot;
-#include &quot;database_thread.hpp&quot;
-#include &quot;filesystem.hpp&quot;
-#include &quot;tile_generator.hpp&quot;
-#include &quot;tile_generator_thread.hpp&quot;
-#include &quot;workspace.hpp&quot;
-#include &quot;viewer_thread.hpp&quot;
-#include &quot;viewer.hpp&quot;
-#include &quot;griv.hpp&quot;
-
-Griv::Griv()
-{
-  Filesystem::init();
-}
-
-Griv::~Griv()
-{
-  Filesystem::deinit();
-}
-
-void
-Griv::info(const std::vector&lt;std::string&gt;&amp; filenames)
-{
-  for(std::vector&lt;std::string&gt;::const_iterator i = filenames.begin(); i != filenames.end(); ++i)
-    {
-      Size size;
-      JPEG::get_size(*i, size);
-      std::cout &lt;&lt; *i &lt;&lt; &quot; &quot; &lt;&lt; size.width &lt;&lt; &quot;x&quot; &lt;&lt; size.height &lt;&lt; std::endl;
-    }
-}
-
-void
-Griv::downscale(const std::vector&lt;std::string&gt;&amp; filenames)
-{
-  int num = 0;
-  for(std::vector&lt;std::string&gt;::const_iterator i = filenames.begin(); i != filenames.end(); ++i, ++num)
-    {
-      std::cout &lt;&lt; *i &lt;&lt; std::endl;
-      SoftwareSurface surface = JPEG::load(*i, 8);
-
-      std::ostringstream out;
-      out &lt;&lt; &quot;/tmp/out-&quot; &lt;&lt; num &lt;&lt; &quot;.jpg&quot;;
-      Blob blob = JPEG::save(surface, 75);
-      blob.write_to_file(out.str());
-
-      std::cout &lt;&lt; &quot;Wrote: &quot; &lt;&lt; out.str() &lt;&lt; std::endl;
-    }  
-}
-
-void
-Griv::cleanup(const std::string&amp; database)
-{
-  SQLiteConnection db(database); 
-  std::cout &lt;&lt; &quot;Running database cleanup routines, this process can take multiple minutes.&quot; &lt;&lt; std::endl;
-   std::cout &lt;&lt; &quot;You can interrupt it via Ctrl-c, which won't do harm, but will throw away all the cleanup work done till that point&quot; &lt;&lt; std::endl;
-  db.vacuum();
-  std::cout &lt;&lt; &quot;Running database cleanup routines done&quot; &lt;&lt; std::endl;
-}
-
-void
-Griv::list(const std::string&amp; database)
-{
-  SQLiteConnection db(database);
-
-  FileDatabase file_db(&amp;db);
-
-  std::vector&lt;FileEntry&gt; entries;
-  file_db.get_file_entries(entries);
-
-  for(std::vector&lt;FileEntry&gt;::iterator i = entries.begin(); i != entries.end(); ++i)
-    {
-      std::cout &lt;&lt; i-&gt;filename &lt;&lt; std::endl;
-    }  
-}
-
-void
-Griv::check(const std::string&amp; database)
-{
-  SQLiteConnection db(database);
-
-  FileDatabase file_db(&amp;db);
-
-  file_db.check();
-}
-
-void
-Griv::generate_tiles(const std::string&amp; database, const std::vector&lt;std::string&gt;&amp; filenames)
-{
-  SQLiteConnection db(database);
-
-  FileDatabase file_db(&amp;db);
-  TileDatabase tile_db(&amp;db);
-
-  TileGenerator tile_generator;
-
-  for(std::vector&lt;std::string&gt;::size_type i = 0; i &lt; filenames.size(); ++i)
-    {
-      FileEntry entry;
-      std::cout &lt;&lt; &quot;Getting file entry...&quot; &lt;&lt; std::endl;
-      if (!file_db.get_file_entry(filenames[i], &amp;entry))
-        {
-          std::cout &lt;&lt; &quot;Couldn't find entry for &quot; &lt;&lt; filenames[i] &lt;&lt; std::endl;
-        }
-      else
-        {
-          // Generate Image Tiles
-          std::cout &lt;&lt; &quot;Generating tiles... &quot; &lt;&lt; filenames[i]  &lt;&lt; std::endl;
-          SoftwareSurface surface = SoftwareSurface::from_file(filenames[i]);
-          
-          tile_generator.generate_all(entry.fileid, surface, 
-                                      boost::bind(&amp;TileDatabase::store_tile, &amp;tile_db, _1));
-        }
-    }
-}
-
-void
-Griv::view(const std::string&amp; database, const std::vector&lt;std::string&gt;&amp; filenames)
-{
-  if (SDL_Init(SDL_INIT_VIDEO) != 0)
-    {
-      std::cout &lt;&lt; &quot;Unable to initialize SDL: &quot; &lt;&lt; SDL_GetError() &lt;&lt; std::endl;
-      exit(1);
-    }
-  atexit(SDL_Quit); 
-
-  JPEGDecoderThread   jpeg_thread;
-  DatabaseThread      database_thread(database);
-  TileGeneratorThread tile_generator_thread;
-  ViewerThread        viewer_thread;
-
-  jpeg_thread.start();
-  database_thread.start();
-  tile_generator_thread.start();
-
-  if (filenames.empty())
-    {
-      // When no files are given, display everything in the database
-      database_thread.request_all_files(boost::bind(&amp;ViewerThread::receive_file, &amp;viewer_thread, _1));
-    }
-  else
-    {
-      for(std::vector&lt;std::string&gt;::size_type i = 0; i &lt; filenames.size(); ++i)
-        {
-          database_thread.request_file(filenames[i], boost::bind(&amp;ViewerThread::receive_file, &amp;viewer_thread, _1));
-        }
-    }
-
-  viewer_thread.run();
-
-  tile_generator_thread.stop();
-  database_thread.stop();
-  jpeg_thread.stop();
-
-  tile_generator_thread.join(); 
-  database_thread.join();
-  jpeg_thread.join();
-}
-
-void
-Griv::print_usage()
-{
-      std::cout &lt;&lt; &quot;Usage: griv view    [OPTIONS]... [FILES]...\n&quot;
-                &lt;&lt; &quot;       griv prepare [OPTIONS]... [FILES]...\n&quot;
-                &lt;&lt; &quot;       griv check   [OPTIONS]...\n&quot;
-                &lt;&lt; &quot;       griv list    [OPTIONS]...\n&quot;
-                &lt;&lt; &quot;       griv cleanup [OPTIONS]...\n&quot;
-                &lt;&lt; &quot;\n&quot;
-                &lt;&lt; &quot;Commands:\n&quot;
-                &lt;&lt; &quot;  view      Display the given files\n&quot;
-                &lt;&lt; &quot;  prepare   Generate thumbnails for all given images, makes view command faster\n&quot;
-                &lt;&lt; &quot;  list      Lists all files in the database\n&quot;
-                &lt;&lt; &quot;  check     Checks the database for consistency\n&quot;
-                &lt;&lt; &quot;  cleanup   Runs garbage collection on the database\n&quot;
-                &lt;&lt; &quot;\n&quot;
-                &lt;&lt; &quot;Options:\n&quot;
-                &lt;&lt; &quot;  -d, --database FILE    Use FILE has database (default: test.sqlite)\n&quot;
-                &lt;&lt; &quot;\n&quot;
-                &lt;&lt; &quot;If you do not supply any files, the whole content of the given database will be displayed.&quot;
-                &lt;&lt; std::endl;
-}
-
-int
-Griv::main(int argc, char** argv)
-{
-  // FIXME: Function doesn't seem to be available in 3.4.2
-  // if (!sqlite3_threadsafe())
-  //  throw std::runtime_error(&quot;Error: SQLite must be compiled with SQLITE_THREADSAFE&quot;);
-
-  std::string database = &quot;test.sqlite&quot;;
-  
-  if (argc &lt; 2)
-    {
-      print_usage();
-    }
-  else
-    {
-      std::vector&lt;std::string&gt; argument_filenames;
-      for(int i = 2; i &lt; argc; ++i)
-        {
-          if (argv[i][0] == '-')
-            {
-              if (strcmp(argv[i], &quot;--help&quot;) == 0 ||
-                  strcmp(argv[i], &quot;-h&quot;) == 0)
-                {
-                  print_usage();
-                  exit(0);
-                }
-              else if (strcmp(argv[i], &quot;--database&quot;) == 0 ||
-                  strcmp(argv[i], &quot;-d&quot;) == 0)
-                {
-                  ++i;
-                  if (i &lt; argc)
-                    {
-                      database = argv[i];
-                    }
-                  else
-                    {
-                      throw std::runtime_error(std::string(argv[i-1]) + &quot; requires an argument&quot;);
-                    }
-                }
-              else
-                {
-                  throw std::runtime_error(&quot;Unknown option &quot; + std::string(argv[i]));
-                }
-            }
-          else
-            {
-              argument_filenames.push_back(Filesystem::realpath(argv[i]));
-            }
-        }
-
-      std::vector&lt;std::string&gt; filenames;
-      for(std::vector&lt;std::string&gt;::iterator i = argument_filenames.begin(); i != argument_filenames.end(); ++i)
-        Filesystem::generate_jpeg_file_list(*i, filenames);
-
-      std::sort(filenames.begin(), filenames.end());
-
-      if (strcmp(argv[1], &quot;view&quot;) == 0)
-        {
-          view(database, filenames);
-        }
-      else if (strcmp(argv[1], &quot;check&quot;) == 0)
-        {
-          check(database);
-        }
-      else if (strcmp(argv[1], &quot;list&quot;) == 0)
-        {
-          list(database);
-        }
-      else if (strcmp(argv[1], &quot;cleanup&quot;) == 0)
-        {
-          cleanup(database);
-        }
-      else if (strcmp(argv[1], &quot;info&quot;) == 0)
-        {
-          info(filenames);
-        }
-      else if (strcmp(argv[1], &quot;downscale&quot;) == 0)
-        {
-          downscale(filenames);
-        }
-      else if (strcmp(argv[1], &quot;prepare&quot;) == 0)
-        {
-          generate_tiles(database, filenames);
-        }
-      else
-        {
-          print_usage();
-        }
-    }
-
-  return 0;
-}
-  
-int main(int argc, char** argv)
-{
-  try 
-    {
-      Griv app;
-      int ret = app.main(argc, argv);
-      return ret;
-    }
-  catch(const std::exception&amp; err) 
-    {
-      std::cout &lt;&lt; &quot;Exception: &quot; &lt;&lt; err.what() &lt;&lt; std::endl;
-    }
-}
-  
-/* EOF */

Deleted: trunk/griv/griv.hpp
===================================================================
--- trunk/griv/griv.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/griv.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,47 +0,0 @@
-/*
-**  Griv - Grumbel's Image Viewer
-**  Copyright (C) 2008 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_GRIV_HPP
-#define HEADER_GRIV_HPP
-
-class Griv
-{
-private:
-public:
-  Griv();
-  ~Griv();
-
-  void print_usage();
-  int main(int argc, char** argv);
-
-  void info(const std::vector&lt;std::string&gt;&amp; filenames);
-  void downscale(const std::vector&lt;std::string&gt;&amp; filenames);
-  void cleanup(const std::string&amp; database);
-  void check(const std::string&amp; database);
-  void list(const std::string&amp; database);
-  void generate_tiles(const std::string&amp; database, 
-                      const std::vector&lt;std::string&gt;&amp; filenames);
-  void view(const std::string&amp; database, 
-            const std::vector&lt;std::string&gt;&amp; filenames);
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/image.cpp
===================================================================
--- trunk/griv/image.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/image.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,329 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &quot;math/rgb.hpp&quot;
-#include &quot;math/rect.hpp&quot;
-#include &quot;framebuffer.hpp&quot;
-#include &quot;surface.hpp&quot;
-#include &quot;math.hpp&quot;
-#include &quot;database_thread.hpp&quot;
-#include &quot;viewer_thread.hpp&quot;
-#include &quot;image.hpp&quot;
-
-uint32_t make_cache_id(int x, int y, int tile_scale)
-{
-  return x | (y &lt;&lt; 8) | (tile_scale &lt;&lt; 16);
-}
-
-class ImageImpl
-{
-public:
-  int fileid;
-  std::string filename;
-  Size size;
-  float scale;
-
-  int max_tiledb_scale;
-  Vector2f pos;
-
-  Image::Cache cache;
-  Image::Jobs jobs;  
-  
-  ImageImpl() 
-  {
-  }
-
-  ~ImageImpl()
-  {
-  }
-};
-
-Image::Image()
-{
-}
-
-Image::Image(int fileid, const std::string&amp; filename, const Size&amp; size)
-  : impl(new ImageImpl())
-{
-  impl-&gt;fileid   = fileid;
-  impl-&gt;filename = filename;
-  impl-&gt;size     = size;
-  impl-&gt;scale    = 1.0f;
-  
-  int  tiledb_scale = 0;
-  Size tmpsize = size;
-  do {
-    tmpsize.width  /= 2;
-    tmpsize.height /= 2;
-    tiledb_scale += 1;
-  } while (tmpsize.width  &gt; 32 ||
-           tmpsize.height &gt; 32);
-
-  impl-&gt;max_tiledb_scale = tiledb_scale;
-}
-
-void
-Image::set_pos(const Vector2f&amp; pos_)
-{
-  impl-&gt;pos = pos_;
-}
-
-Vector2f
-Image::get_pos() const
-{
-  return impl-&gt;pos;
-}
-
-void
-Image::set_scale(float f)
-{
-  impl-&gt;scale = f;
-}
-
-float
-Image::get_scale() const
-{
-  return impl-&gt;scale;
-}
-
-float
-Image::get_scaled_width() const
-{
-  return impl-&gt;size.width * impl-&gt;scale;
-}
-
-float
-Image::get_scaled_height() const
-{
-  return impl-&gt;size.height * impl-&gt;scale;
-}
-
-int
-Image::get_original_width() const
-{
-  return impl-&gt;size.width;
-}
-
-int
-Image::get_original_height() const
-{
-  return impl-&gt;size.height;
-}
-
-Surface
-Image::get_tile(int x, int y, int tile_scale)
-{
-  uint32_t cache_id = make_cache_id(x, y, tile_scale);
-  Cache::iterator i = impl-&gt;cache.find(cache_id);
-
-  if (i == impl-&gt;cache.end())
-    {
-      impl-&gt;jobs.push_back(ViewerThread::current()-&gt;request_tile(impl-&gt;fileid, tile_scale, x, y, *this));
-
-      // Request the next smaller tile too, so we get a lower quality
-      // image fast and a higher quality one soon after FIXME: Its
-      // unclear if this actually improves things, also the order of
-      // request gets mungled in the DatabaseThread, we should request
-      // the whole group of lower res tiles at once, instead of one by
-      // one, since that eats up the possible speed up
-      impl-&gt;jobs.push_back(ViewerThread::current()-&gt;request_tile(impl-&gt;fileid, tile_scale+1, x, y, *this));
-
-      SurfaceStruct s;
-      
-      s.surface = Surface();
-      s.status  = SurfaceStruct::SURFACE_REQUESTED;
-
-      impl-&gt;cache[cache_id] = s;
-
-      return Surface();
-    }
-  else
-    {
-      return i-&gt;second.surface;
-    }
-}
-
-void
-Image::draw_tile(int x, int y, int tiledb_scale, const Vector2f&amp; pos, float scale)
-{
-  Surface surface = get_tile(x, y, tiledb_scale);
-  if (surface)
-    {
-      surface.draw(Rectf(pos, surface.get_size() * scale));
-      //Framebuffer::draw_rect(Rectf(pos, surface.get_size() * scale), RGB(100, 100, 100));
-    }
-  else
-    {
-      // Look for the next smaller tile
-      // FIXME: Rewrite this to work all smaller tiles, not just the next
-      
-      int downscale_factor = 1;
-
-    retry:
-      int downscale = Math::pow2(downscale_factor);
-
-      uint32_t cache_id = make_cache_id(x/downscale, y/downscale, tiledb_scale+downscale_factor);
-      Cache::iterator i = impl-&gt;cache.find(cache_id);
-  
-      if (i != impl-&gt;cache.end() &amp;&amp; i-&gt;second.surface)
-        { // Must only draw relevant section!
-          Size s((x%downscale) ? (i-&gt;second.surface.get_width()  - 256/downscale * (x%downscale)) : 256/downscale,
-                 (y%downscale) ? (i-&gt;second.surface.get_height() - 256/downscale * (y%downscale)) : 256/downscale);
-
-          s.width  = Math::min(i-&gt;second.surface.get_width(),  s.width);
-          s.height = Math::min(i-&gt;second.surface.get_height(), s.height);
-          
-          i-&gt;second.surface.draw(Rectf(Vector2f(x%downscale, y%downscale) * 256/downscale, 
-                                       s),
-                                 Rectf(pos, s * scale * downscale));
-          //Framebuffer::draw_rect(Rectf(pos, s * scale * downscale), RGB(255, 255, 255));
-        }
-      else
-        {
-          if (downscale_factor &lt; 6) // Make this 'max_scale' instead of random number
-            {
-              downscale_factor += 1;
-              goto retry;
-            }
-          else
-            {
-              // give up, no lower resolution found
-            }
-        }
-    }
-}
-
-void
-Image::draw(const Rectf&amp; cliprect, float fscale)
-{
-  // Cancel all old jobs (FIXME: Stupid brute force hack)
-  if (0)
-    {
-      for(Jobs::iterator i = impl-&gt;jobs.begin(); i != impl-&gt;jobs.end(); ++i)
-        i-&gt;abort();
-      impl-&gt;jobs.clear();
-    }
-
-  Rectf image_rect(impl-&gt;pos, Sizef(impl-&gt;size * impl-&gt;scale)); // in world coordinates
-
-  //Framebuffer::draw_rect(image_rect);
-
-  if (cliprect.is_overlapped(image_rect))
-    {
-      // scale factor for requesting the tile from the TileDatabase
-      int tiledb_scale = Math::max(0, static_cast&lt;int&gt;(log(1.0f / (fscale*impl-&gt;scale)) /
-                                                       log(2)));
-      int scale_factor = Math::pow2(tiledb_scale);
-
-      int scaled_width  = impl-&gt;size.width  / scale_factor;
-      int scaled_height = impl-&gt;size.height / scale_factor;
-
-      if (scaled_width  &lt; 256 &amp;&amp; scaled_height &lt; 256)
-        { // So small that only one tile is to be drawn
-          draw_tile(0, 0, tiledb_scale, 
-                    impl-&gt;pos,
-                    scale_factor * impl-&gt;scale);
-        }
-      else
-        {
-          Rectf image_region = image_rect.clip_to(cliprect); // visible part of the image
-
-          image_region.left   = (image_region.left   - impl-&gt;pos.x) / impl-&gt;scale;
-          image_region.right  = (image_region.right  - impl-&gt;pos.x) / impl-&gt;scale;
-          image_region.top    = (image_region.top    - impl-&gt;pos.y) / impl-&gt;scale;
-          image_region.bottom = (image_region.bottom - impl-&gt;pos.y) / impl-&gt;scale;
-
-          int   itilesize = 256 * scale_factor;
-          float tilesize  = 256.0f * scale_factor * impl-&gt;scale;
-
-          int start_x = (image_region.left)  / itilesize;
-          int end_x   = (image_region.right) / itilesize + 1;
-
-          int start_y = (image_region.top   ) / itilesize;
-          int end_y   = (image_region.bottom) / itilesize + 1;
-
-          for(int y = start_y; y &lt; end_y; y += 1)
-            for(int x = start_x; x &lt; end_x; x += 1)
-              {
-                draw_tile(x, y, tiledb_scale, 
-                          impl-&gt;pos + Vector2f(x,y) * tilesize,
-                          scale_factor * impl-&gt;scale);
-              }
-        }
-    }
-  else
-    {
-      // Image is not visible so clear the cache
-      
-      // FIXME: We should keep at least some tiles or wait with the
-      // cache purge a bit longer
-
-      // FIXME: We also need to purge the cache more often, since with
-      // big images we would end up never clearing it
-      
-      // Clear the cache, but keep the smallest tile (Wonky hack)
-      if (0)
-        {
-          impl-&gt;cache.clear();
-        }
-      else
-        {
-          int max_tiledb_scale = 0;
-          SurfaceStruct s;
-          int tileid;
-          for(Cache::iterator i = impl-&gt;cache.begin(); i != impl-&gt;cache.end(); ++i)
-            {
-              int tiledb_scale = (i-&gt;first &gt;&gt; 16);
-              if (tiledb_scale &gt; max_tiledb_scale)
-                {
-                  max_tiledb_scale = tiledb_scale;
-                  tileid = i-&gt;first;
-                  s      = i-&gt;second;
-                }
-            }
-          impl-&gt;cache.clear();
-
-          if (max_tiledb_scale != 0)
-            {
-              impl-&gt;cache[tileid] = s;
-            }
-        }
-    }
-}
-
-void
-Image::receive_tile(int x, int y, int tiledb_scale, const SoftwareSurface&amp; surface)
-{
-  int tile_id = make_cache_id(x, y, tiledb_scale);
-
-  SurfaceStruct s;
-  
-  s.surface = Surface(surface);
-  s.status  = SurfaceStruct::SURFACE_OK;
-
-  impl-&gt;cache[tile_id] = s;
-}
-
-/* EOF */

Deleted: trunk/griv/image.hpp
===================================================================
--- trunk/griv/image.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/image.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,90 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_IMAGE_HPP
-#define HEADER_IMAGE_HPP
-
-#include &lt;boost/shared_ptr.hpp&gt;
-#include &lt;map&gt;
-#include &lt;string&gt;
-#include &quot;job_handle.hpp&quot;
-#include &quot;math/vector2f.hpp&quot;
-#include &quot;math/size.hpp&quot;
-#include &quot;grid.hpp&quot;
-#include &quot;surface.hpp&quot;
-
-class Surface;
-class Size;
-class Rectf;
-class Vector2f;
-class ImageImpl;
-
-class Image
-{
-public:
-  struct SurfaceStruct {
-    enum Status { SURFACE_OK,
-                  SURFACE_REQUESTED,
-                  SURFACE_FAILED };
-
-    Status  status;
-    Surface surface;
-  };
-
-  typedef std::map&lt;uint32_t, SurfaceStruct&gt; Cache; 
-  typedef std::vector&lt;JobHandle&gt; Jobs;
-
-private:
-  Surface get_tile(int x, int y, int tile_scale);
-
-public:
-  Image();
-  Image(int fileid, const std::string&amp; filename, const Size&amp; size);
-
-  void draw_tile(int x, int y, int tiledb_scale, const Vector2f&amp; rect, float scale);
-  void draw(const Rectf&amp; cliprect, float scale);
-
-  void set_pos(const Vector2f&amp; pos);
-  Vector2f get_pos() const;
-
-  void  set_scale(float f);
-  float get_scale() const;
-
-  float get_scaled_width() const;
-  float get_scaled_height() const;
-
-  int get_original_width() const;
-  int get_original_height() const;
-
-  void receive_tile(int x, int y, int tiledb_scale, const SoftwareSurface&amp; surface);
-
-  operator bool() const { return impl.get(); }
-private:
-  boost::shared_ptr&lt;ImageImpl&gt; impl;
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/job_handle.cpp
===================================================================
--- trunk/griv/job_handle.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/job_handle.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,73 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &quot;job_handle.hpp&quot;
-
-class JobHandleImpl
-{
-public:
-  JobHandleImpl()
-    : aborted(false),
-      finished(false)
-  {}
-
-  bool aborted;
-  bool finished;
-};
-
-JobHandle::JobHandle()
-  : impl(new JobHandleImpl())
-{
-}
-
-JobHandle::~JobHandle()
-{
-}
-
-void
-JobHandle::abort()
-{
-  impl-&gt;aborted = true;
-}
-
-bool
-JobHandle::is_aborted() const
-{
-  return impl-&gt;aborted;
-}
-
-void
-JobHandle::finish()
-{
-  impl-&gt;finished = true;
-}
-
-bool
-JobHandle::is_finished() const
-{
-  return impl-&gt;finished;
-}
-
-/* EOF */

Deleted: trunk/griv/job_handle.hpp
===================================================================
--- trunk/griv/job_handle.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/job_handle.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,55 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_JOB_HANDLE_HPP
-#define HEADER_JOB_HANDLE_HPP
-
-#include &lt;boost/shared_ptr.hpp&gt;
-
-class JobHandleImpl;
-
-/** A JobHandle should be returend whenever one thread makes a request
-    to another thread, the JobHandle allows the calling thread to
-    cancel the job and the called thread to inform the calling one
-    that the Job is finished. (FIXME: Do we need that last thing for something?) */
-class JobHandle
-{
-public:
-  JobHandle();
-  ~JobHandle();
-
-  void abort();
-  bool is_aborted() const;
-  
-  void finish();
-  bool is_finished() const;
-
-private:
-  boost::shared_ptr&lt;JobHandleImpl&gt; impl;
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/jpeg.cpp
===================================================================
--- trunk/griv/jpeg.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/jpeg.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,400 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;iostream&gt;
-#include &lt;fstream&gt;
-#include &lt;sstream&gt;
-#include &lt;stdexcept&gt;
-#include &lt;jpeglib.h&gt;
-#include &lt;setjmp.h&gt;
-#include &quot;math/size.hpp&quot;
-#include &quot;jpeg_memory_src.hpp&quot;
-#include &quot;jpeg_memory_dest.hpp&quot;
-#include &quot;jpeg.hpp&quot;
-
-jmp_buf setjmp_buffer;
-
-void fatal_error_handler(j_common_ptr cinfo)
-{
-  std::cout &lt;&lt; &quot;Some jpeg error: &quot; &lt;&lt; std::endl;
-  longjmp(setjmp_buffer, 1);
-}
-
-void
-JPEG::get_size(const std::string&amp; filename, Size&amp; size)
-{
-  FILE* in = fopen(filename.c_str(), &quot;rb&quot;);
-  if (!in)
-    throw std::runtime_error(&quot;JPEG::get_size: Couldn't open &quot; + filename);
-
-  struct jpeg_decompress_struct  cinfo;
-  struct jpeg_error_mgr jerr;
-
-  cinfo.err = jpeg_std_error(&amp;jerr);
-  cinfo.err-&gt;error_exit = &amp;fatal_error_handler;
-  jpeg_create_decompress(&amp;cinfo);
-  jpeg_stdio_src(&amp;cinfo, in);
-
-  if (setjmp(setjmp_buffer))
-    {
-      throw std::runtime_error(&quot;JPEG::get_size: ERROR: Couldn't open &quot; + filename);
-    }
-
-  jpeg_read_header(&amp;cinfo, FALSE);
-
-  size.width  = cinfo.image_width;
-  size.height = cinfo.image_height;
-
-  jpeg_destroy_decompress(&amp;cinfo);
-
-  fclose(in);
-}
-
-SoftwareSurface
-JPEG::load(const std::string&amp; filename, int scale)
-{
-  //std::cout &lt;&lt; &quot;-- JPEG::load(&quot; &lt;&lt; filename &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;
-
-  FILE* in = fopen(filename.c_str(), &quot;rb&quot;);
-  if (!in)
-    throw std::runtime_error(&quot;JPEG::get_size: Couldn't open &quot; + filename);
-
-  struct jpeg_decompress_struct  cinfo;
-  struct jpeg_error_mgr jerr;
-
-  cinfo.err = jpeg_std_error(&amp;jerr);
-  cinfo.err-&gt;error_exit = &amp;fatal_error_handler;
-
-  jpeg_create_decompress(&amp;cinfo);
-  jpeg_stdio_src(&amp;cinfo, in);
-
-  if (setjmp(setjmp_buffer))
-    {
-      throw std::runtime_error(&quot;JPEG::get_size: ERROR: Couldn't open &quot; + filename);
-    }
-
-  jpeg_read_header(&amp;cinfo, FALSE);
-
-  if (scale != 1)
-    { // scale the image down by scale
-
-      // by default all those values below are on 1
-      cinfo.scale_num           = 1;
-      cinfo.scale_denom         = scale;
-   
-      cinfo.do_fancy_upsampling = FALSE; /* TRUE=apply fancy upsampling */
-      cinfo.do_block_smoothing  = FALSE; /* TRUE=apply interblock smoothing */
-    }
-
-  jpeg_start_decompress(&amp;cinfo);
-
-  SoftwareSurface surface(Size(cinfo.image_width  / scale, 
-                               cinfo.image_height / scale));
-  
-  if (cinfo.output_components == 3)
-    { // RGB Image
-      JSAMPLE* scanlines[cinfo.image_height];
-
-      for(JDIMENSION y = 0; y &lt; cinfo.image_height; ++y)
-        scanlines[y] = surface.get_row_data(y);
-
-      while (cinfo.output_scanline &lt; cinfo.output_height) 
-        {
-          jpeg_read_scanlines(&amp;cinfo, &amp;scanlines[cinfo.output_scanline], 
-                              cinfo.image_height - cinfo.output_scanline);
-        }
-    }
-  else if (cinfo.output_components == 1)
-    { // Greyscale Image
-      
-    }
-  else
-    {
-      std::ostringstream str;
-      str &lt;&lt; &quot;JPEG: Unsupported color depth: &quot; &lt;&lt; cinfo.output_components;
-      throw std::runtime_error(str.str());
-    }
-
-  jpeg_destroy_decompress(&amp;cinfo);
-
-  fclose(in); 
-
-  //std::cout &lt;&lt; &quot;-- done&quot; &lt;&lt; std::endl;
-
-  return surface;
-}
-
-SoftwareSurface
-JPEG::load(uint8_t* mem, int len)
-{
-  //std::cout &lt;&lt; &quot;JPEG::load(&quot; &lt;&lt; static_cast&lt;void*&gt;(mem) &lt;&lt; &quot;, &quot; &lt;&lt; len &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;
-  
-  // -- Setup the read source
-  struct jpeg_decompress_struct  cinfo;
-  struct jpeg_error_mgr jerr;
-
-  cinfo.err = jpeg_std_error(&amp;jerr);
-  cinfo.err-&gt;error_exit = &amp;fatal_error_handler;
-
-  jpeg_create_decompress(&amp;cinfo);
-  jpeg_memory_src(&amp;cinfo, mem, len);
-
-  if (setjmp(setjmp_buffer)) // FIXME: Is that error handling correct that way?
-    {
-      throw std::runtime_error(&quot;JPEG::load&quot;);
-    }
-
-  // -- Start Reading
-  jpeg_read_header(&amp;cinfo, FALSE);
-  jpeg_start_decompress(&amp;cinfo);
-
-  // -- Copy the scanlines to a SoftwareSurface
-  SoftwareSurface surface(Size(cinfo.image_width, 
-                               cinfo.image_height));
-  
-  //std::cout &lt;&lt; surface.get_width() &lt;&lt; &quot;x&quot; &lt;&lt; surface.get_height() &lt;&lt; std::endl;
-
-  if (cinfo.output_components == 3) // RGB Image
-    { 
-      JSAMPLE* scanlines[cinfo.image_height];
-
-      for(JDIMENSION y = 0; y &lt; cinfo.image_height; ++y)
-        scanlines[y] = surface.get_row_data(y);
-
-      while (cinfo.output_scanline &lt; cinfo.output_height) 
-        {
-          jpeg_read_scanlines(&amp;cinfo, &amp;scanlines[cinfo.output_scanline], 
-                              cinfo.image_height - cinfo.output_scanline);
-        }
-    }
-  else if (cinfo.output_components == 1) // Greyscale Image
-    { 
-      assert(!&quot;JPEG::load: grayscale handling not implemented&quot;);
-    }
-  else
-    {
-      std::ostringstream str;
-      str &lt;&lt; &quot;JPEG: Unsupported color depth: &quot; &lt;&lt; cinfo.output_components;
-      throw std::runtime_error(str.str());
-    }
-
-  // -- Cleanup
-  jpeg_destroy_decompress(&amp;cinfo);
-
-  return surface; 
-}
-
-void
-JPEG::save(const SoftwareSurface&amp; surface, int quality, const std::string&amp; filename)
-{
-  assert(!&quot;Unfinished: JPEG::save(SoftwareSurface&amp; surface, int quality, const std::string&amp; filename)&quot;);
-
-  struct jpeg_compress_struct cinfo;
-  struct jpeg_error_mgr jerr;
-
-  cinfo.err = jpeg_std_error(&amp;jerr);
-
-  jpeg_create_compress(&amp;cinfo);
-
-  //jpeg_stdio_dest(&amp;cinfo, outfile);
-
-  cinfo.image_width  = surface.get_width();
-  cinfo.image_height = surface.get_height();
-
-  cinfo.input_components = 3;		/* # of color components per pixel */
-  cinfo.in_color_space   = JCS_RGB; 	/* colorspace of input image */
-
-  jpeg_set_defaults(&amp;cinfo);
-  jpeg_set_quality(&amp;cinfo, quality, TRUE /* limit to baseline-JPEG values */);
- 
-  jpeg_start_compress(&amp;cinfo, TRUE);
-
-  JSAMPROW row_pointer[surface.get_height()];
-  
-  for(int y = 0; y &lt; surface.get_height(); ++y)
-    row_pointer[y] = static_cast&lt;JSAMPLE*&gt;(surface.get_row_data(y));
-
-  while(cinfo.next_scanline &lt; cinfo.image_height)
-    {
-      jpeg_write_scanlines(&amp;cinfo, row_pointer, surface.get_height());
-    }
-  
-  jpeg_finish_compress(&amp;cinfo);
-  
-  jpeg_destroy_compress(&amp;cinfo);
-}  
-
-Blob
-JPEG::save(const SoftwareSurface&amp; surface, int quality)
-{
-  // std::cout &lt;&lt; &quot;JPEG::save(const SoftwareSurface&amp; surface, int quality)&quot; &lt;&lt; std::endl;
-
-  struct jpeg_compress_struct cinfo;
-  struct jpeg_error_mgr jerr;
-
-  cinfo.err = jpeg_std_error(&amp;jerr);
-
-  jpeg_create_compress(&amp;cinfo);
-
-  std::vector&lt;uint8_t&gt; data;
-  jpeg_memory_dest(&amp;cinfo, &amp;data);
-
-  cinfo.image_width  = surface.get_width();
-  cinfo.image_height = surface.get_height();
-
-  cinfo.input_components = 3;		/* # of color components per pixel */
-  cinfo.in_color_space   = JCS_RGB; 	/* colorspace of input image */
-
-  jpeg_set_defaults(&amp;cinfo);
-  jpeg_set_quality(&amp;cinfo, quality, TRUE /* limit to baseline-JPEG values */);
- 
-  jpeg_start_compress(&amp;cinfo, TRUE);
-
-  JSAMPROW row_pointer[surface.get_height()];
-  
-  for(int y = 0; y &lt; surface.get_height(); ++y)
-    row_pointer[y] = static_cast&lt;JSAMPLE*&gt;(surface.get_row_data(y));
-
-  while(cinfo.next_scanline &lt; cinfo.image_height)
-    {
-      jpeg_write_scanlines(&amp;cinfo, &amp;row_pointer[cinfo.next_scanline], 
-                           surface.get_height() - cinfo.next_scanline);
-    }
-  
-  jpeg_finish_compress(&amp;cinfo);
-  
-  jpeg_destroy_compress(&amp;cinfo);
-
-  // FIXME: This causes an unnecessary copy, should have a BlobImpl that is based on std::vector&lt;&gt;
-  return Blob(data);
-}
-
-#if 0 
-void 
-JPEG::crop()
-{
-  struct jpeg_decompress_struct srcinfo;
-  struct jpeg_compress_struct dstinfo;
-  struct jpeg_error_mgr jsrcerr, jdsterr;
-
-  jvirt_barray_ptr * src_coef_arrays;
-  jvirt_barray_ptr * dst_coef_arrays;
-
-  /* Initialize the JPEG decompression object with default error handling. */
-  srcinfo.err = jpeg_std_error(&amp;jsrcerr);
-  jpeg_create_decompress(&amp;srcinfo);
-
-  /* Initialize the JPEG compression object with default error handling. */
-  dstinfo.err = jpeg_std_error(&amp;jdsterr);
-  jpeg_create_compress(&amp;dstinfo);
-
-  jsrcerr.trace_level = jdsterr.trace_level;
-  srcinfo.mem-&gt;max_memory_to_use = dstinfo.mem-&gt;max_memory_to_use;
-
-  /* Specify data source for decompression */
-  jpeg_stdio_src(&amp;srcinfo, fp);
-
-  /* Enable saving of extra markers that we want to copy */
-  // jcopy_markers_setup(&amp;srcinfo, copyoption);
-
-  /* Read file header */
-  jpeg_read_header(&amp;srcinfo, TRUE);
-
-  /* Any space needed by a transform option must be requested before
-   * jpeg_read_coefficients so that memory allocation will be done right.
-   */
-  jtransform_request_workspace(&amp;srcinfo, &amp;transformoption);
-
-  /* Read source file as DCT coefficients */
-  src_coef_arrays = jpeg_read_coefficients(&amp;srcinfo);
-
-  /* Initialize destination compression parameters from source values */
-  jpeg_copy_critical_parameters(&amp;srcinfo, &amp;dstinfo);
-
-  /* Adjust destination parameters if required by transform options;
-   * also find out which set of coefficient arrays will hold the output.
-   */
-  dstinfo-&gt;image_width = info-&gt;output_width;
-  dstinfo-&gt;image_height = info-&gt;output_height;
-
-  dst_coef_arrays = src_coef_arrays;
-
-  jpeg_stdio_dest(&amp;dstinfo, fp);
-
-  /* Start compressor (note no image data is actually written here) */
-  jpeg_write_coefficients(&amp;dstinfo, dst_coef_arrays);
-
-  /* Copy to the output file any extra markers that we want to preserve */
-  jcopy_markers_execute(&amp;srcinfo, &amp;dstinfo, copyoption);
-
-  // JDIMENSION x_crop_offset, JDIMENSION y_crop_offset,
-   
-  { // Crop
-    JBLOCKARRAY src_buffer, dst_buffer;
-    jpeg_component_info *compptr;
-
-    /* We simply have to copy the right amount of data (the destination's
-     * image size) starting at the given X and Y offsets in the source.
-     */
-    for (int ci = 0; ci &lt; dstinfo-&gt;num_components; ci++)
-      {
-        compptr = dstinfo-&gt;comp_info + ci;
-        JDIMENSION x_crop_blocks = x_crop_offset * compptr-&gt;h_samp_factor;
-        JDIMENSION y_crop_blocks = y_crop_offset * compptr-&gt;v_samp_factor;
-
-        for (JDIMENSION dst_blk_y = 0; dst_blk_y &lt; compptr-&gt;height_in_blocks; dst_blk_y += compptr-&gt;v_samp_factor) 
-          {
-            dst_buffer = (*srcinfo-&gt;mem-&gt;access_virt_barray)
-              ((j_common_ptr) srcinfo, dst_coef_arrays[ci], dst_blk_y,
-               (JDIMENSION) compptr-&gt;v_samp_factor, TRUE);
-
-            src_buffer = (*srcinfo-&gt;mem-&gt;access_virt_barray)
-              ((j_common_ptr) srcinfo, src_coef_arrays[ci],
-               dst_blk_y + y_crop_blocks,
-               (JDIMENSION) compptr-&gt;v_samp_factor, FALSE);
-
-            for (int offset_y = 0; offset_y &lt; compptr-&gt;v_samp_factor; offset_y++) 
-              {
-                jcopy_block_row(src_buffer[offset_y] + x_crop_blocks,
-                                dst_buffer[offset_y],
-                                compptr-&gt;width_in_blocks);
-              }
-          }
-      }
-  }
-
-  { // Cleanup
-    /* Finish compression and release memory */
-    jpeg_finish_compress(&amp;dstinfo);
-    jpeg_destroy_compress(&amp;dstinfo);
-    jpeg_finish_decompress(&amp;srcinfo);
-    jpeg_destroy_decompress(&amp;srcinfo);
-
-  }
-}
-#endif
-
-
-/* EOF */

Deleted: trunk/griv/jpeg.hpp
===================================================================
--- trunk/griv/jpeg.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/jpeg.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,49 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_JPEG_HPP
-#define HEADER_JPEG_HPP
-
-#include &lt;string&gt;
-#include &quot;software_surface.hpp&quot;
-
-class JPEG
-{
-private:
-
-
-public:
-  static void get_size(const std::string&amp; filename, Size&amp; size);
-
-  static SoftwareSurface load(const std::string&amp; filename, int scale = 1);
-  static SoftwareSurface load(uint8_t* mem, int len);
-
-  static void save(const SoftwareSurface&amp; surface, int quality, const std::string&amp; filename);
-  static Blob save(const SoftwareSurface&amp; surface, int quality);
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/jpeg_decoder_thread.cpp
===================================================================
--- trunk/griv/jpeg_decoder_thread.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/jpeg_decoder_thread.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,71 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &quot;software_surface.hpp&quot;
-#include &quot;jpeg_decoder_thread.hpp&quot;
-
-JPEGDecoderThread* JPEGDecoderThread::current_ = 0;
-
-JPEGDecoderThread::JPEGDecoderThread()
-  : quit(false)
-{
-  current_ = 0;
-}
-
-void
-JPEGDecoderThread::request_decode(const Blob&amp; blob,
-                                  const boost::function&lt;void (const SoftwareSurface&amp;)&gt;&amp; callback)
-{
-  JPEGDecoderThreadMessage msg;
-  msg.blob     = blob;
-  msg.callback = callback;
-  queue.push(msg);
-}
-
-void 
-JPEGDecoderThread::stop()
-{
-  quit = true;
-}
-
-int
-JPEGDecoderThread::run()
-{
-  quit = false;
-  while (!quit)
-    {
-      while(!queue.empty())
-        {
-          JPEGDecoderThreadMessage msg = queue.front();
-          queue.pop();
-          msg.callback(SoftwareSurface::from_data(msg.blob));
-        }
-      queue.wait();
-    }
-
-  return 0;
-}
-
-/* EOF */

Deleted: trunk/griv/jpeg_decoder_thread.hpp
===================================================================
--- trunk/griv/jpeg_decoder_thread.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/jpeg_decoder_thread.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,71 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_JPEG_DECODER_THREAD_HPP
-#define HEADER_JPEG_DECODER_THREAD_HPP
-
-#include &lt;boost/function.hpp&gt;
-#include &quot;thread_message_queue.hpp&quot;
-#include &quot;blob.hpp&quot;
-#include &quot;thread.hpp&quot;
-
-class SoftwareSurface;
-
-/** Simple thread that takes a binary blob and decodes it to a
-    SoftwareSurface */
-class JPEGDecoderThread : public Thread
-{
-private:
-  static JPEGDecoderThread* current_;
-
-public:
-  static JPEGDecoderThread* current() { return current_; } 
-
-private:
-  struct JPEGDecoderThreadMessage 
-  {
-    Blob blob;
-    boost::function&lt;void (const SoftwareSurface&amp;)&gt; callback;
-  };
-
-  ThreadMessageQueue&lt;JPEGDecoderThreadMessage&gt; queue;
-  bool quit;
-
-protected:
-  int run();
-public:
-  JPEGDecoderThread();
-
-  void request_decode(const Blob&amp; blob, const boost::function&lt;void (const SoftwareSurface&amp;)&gt;&amp; callback);
-  void stop();
-
-private:
-  JPEGDecoderThread (const JPEGDecoderThread&amp;);
-  JPEGDecoderThread&amp; operator= (const JPEGDecoderThread&amp;);
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/jpeg_image.cpp
===================================================================
--- trunk/griv/jpeg_image.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/jpeg_image.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,91 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &quot;jpeg_image.hpp&quot;
-
-class JPEGImageImpl
-{
-public:
-  Size size;
-};
-
-JPEGImage::JPEGImage()
-{
-}
-
-JPEGImage::JPEGImage(void* data, int len)
-{
-}
-
-JPEGImage::JPEGImage(const std::string&amp; filename)
-{
-}
-
-JPEGImage
-JPEGImage::crop(const Rect&amp; rect)
-{
-  return JPEGImage();
-}
-
-Blob
-JPEGImage::get_data() const
-{
-  return Blob();
-}
-
-SoftwareSurface
-JPEGImage::create_thumbnail(int scale)
-{
-  return SoftwareSurface();
-}
-
-int
-JPEGImage::get_width() const
-{
-  if (impl.get())
-    return impl-&gt;size.width;
-  else
-    return 0;
-}
-
-int
-JPEGImage::get_height() const
-{
-  if (impl.get())
-    return impl-&gt;size.height;
-  else
-    return 0;
-}
-
-Size
-JPEGImage::get_size() const
-{
-  if (impl.get())
-    return impl-&gt;size;
-  else
-    return Size(0, 0);
-}
-
-/* EOF */

Deleted: trunk/griv/jpeg_image.hpp
===================================================================
--- trunk/griv/jpeg_image.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/jpeg_image.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,62 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_JPEG_IMAGE_HPP
-#define HEADER_JPEG_IMAGE_HPP
-
-#include &lt;string&gt;
-#include &quot;math/size.hpp&quot;
-#include &quot;math/rect.hpp&quot;
-#include &quot;software_surface.hpp&quot;
-#include &quot;blob.hpp&quot;
-
-class JPEGImageImpl;
-
-class JPEGImage
-{
-public:
-  JPEGImage();
-  JPEGImage(void* data, int len);
-  JPEGImage(const std::string&amp; filename);
-
-  /** Crops the JPEG, rect coordinates must be aligned to 8px */
-  JPEGImage crop(const Rect&amp; rect);
-
-  /** Return the compressed JPEG data */
-  Blob get_data() const;
-
-  int  get_width()  const;
-  int  get_height() const;
-  Size get_size()   const;
-
-  SoftwareSurface create_thumbnail(int scale);
-
-private:
-  boost::shared_ptr&lt;JPEGImageImpl&gt; impl;
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/jpeg_memory_dest.cpp
===================================================================
--- trunk/griv/jpeg_memory_dest.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/jpeg_memory_dest.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,96 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;iostream&gt;
-#include &quot;jpeg_memory_dest.hpp&quot;
-
-#define OUTPUT_BUF_SIZE 4096
-
-struct jpeg_memory_destination_mgr 
-{
-  struct jpeg_destination_mgr pub;
-
-  JOCTET buffer[OUTPUT_BUF_SIZE];
-  std::vector&lt;uint8_t&gt;* data;
-};
-
-void jpeg_memory_init_destination(j_compress_ptr cinfo)
-{
-  struct jpeg_memory_destination_mgr* mgr = (struct jpeg_memory_destination_mgr*)cinfo-&gt;dest;
-
-  cinfo-&gt;dest-&gt;next_output_byte = mgr-&gt;buffer;
-  cinfo-&gt;dest-&gt;free_in_buffer   = OUTPUT_BUF_SIZE;
-}
-
-boolean jpeg_memory_empty_output_buffer(j_compress_ptr cinfo)
-{
-  //std::cout &lt;&lt; &quot;jpeg_memory_empty_output_buffer(j_compress_ptr cinfo)&quot; &lt;&lt; std::endl;
-
-  struct jpeg_memory_destination_mgr* mgr = (struct jpeg_memory_destination_mgr*)cinfo-&gt;dest;
-  
-  // This function always gets OUTPUT_BUF_SIZE bytes,
-  // cinfo-&gt;dest-&gt;free_in_buffer *must* be ignored
-  for(size_t i = 0; i &lt; OUTPUT_BUF_SIZE; ++i) 
-    { // Little slow maybe?
-      mgr-&gt;data-&gt;push_back(mgr-&gt;buffer[i]);
-    }
-
-  cinfo-&gt;dest-&gt;next_output_byte = mgr-&gt;buffer;
-  cinfo-&gt;dest-&gt;free_in_buffer   = OUTPUT_BUF_SIZE;
-
-  return TRUE;
-}
-
-void jpeg_memory_term_destination(j_compress_ptr cinfo)
-{
-  //std::cout &lt;&lt; &quot;jpeg_memory_term_destination)&quot; &lt;&lt; std::endl;
-
-  struct jpeg_memory_destination_mgr* mgr = (struct jpeg_memory_destination_mgr*)cinfo-&gt;dest;
-  size_t datacount = OUTPUT_BUF_SIZE - cinfo-&gt;dest-&gt;free_in_buffer;
-
-  for(size_t i = 0; i &lt; datacount; ++i)
-    { // Little slow maybe?
-      mgr-&gt;data-&gt;push_back(mgr-&gt;buffer[i]);
-    } 
-}
-
-void jpeg_memory_dest(j_compress_ptr cinfo, std::vector&lt;uint8_t&gt;* data)
-{
-  if (cinfo-&gt;dest == NULL) 
-    {	/* first time for this JPEG object? */
-      cinfo-&gt;dest = (struct jpeg_destination_mgr*)
-        (*cinfo-&gt;mem-&gt;alloc_small)((j_common_ptr) cinfo, JPOOL_PERMANENT,
-                                   sizeof(struct jpeg_memory_destination_mgr));
-    }
-
-  cinfo-&gt;dest-&gt;init_destination    = jpeg_memory_init_destination;
-  cinfo-&gt;dest-&gt;empty_output_buffer = jpeg_memory_empty_output_buffer;
-  cinfo-&gt;dest-&gt;term_destination    = jpeg_memory_term_destination;
-
-  struct jpeg_memory_destination_mgr* mgr = (struct jpeg_memory_destination_mgr*)cinfo-&gt;dest;
-  mgr-&gt;data = data;
-}
-
-/* EOF */

Deleted: trunk/griv/jpeg_memory_dest.hpp
===================================================================
--- trunk/griv/jpeg_memory_dest.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/jpeg_memory_dest.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,38 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_JPEG_MEMORY_DEST_HPP
-#define HEADER_JPEG_MEMORY_DEST_HPP
-
-#include &lt;vector&gt;
-#include &lt;stdint.h&gt;
-#include &lt;stdio.h&gt;
-#include &lt;jpeglib.h&gt;
-
-void jpeg_memory_dest(j_compress_ptr cinfo, std::vector&lt;uint8_t&gt;* data);
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/jpeg_memory_src.cpp
===================================================================
--- trunk/griv/jpeg_memory_src.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/jpeg_memory_src.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,111 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;assert.h&gt;
-#include &lt;iostream&gt;
-#include &lt;jerror.h&gt;
-#include &quot;jpeg_memory_src.hpp&quot;
-
-struct jpeg_memory_source_mgr {
-  struct jpeg_source_mgr pub;	/* public fields */
-
-  uint8_t* mem;
-  int      len;
-};
-
-void jpeg_memory_init_source(j_decompress_ptr cinfo)
-{
-  cinfo-&gt;src-&gt;next_input_byte = NULL;
-  cinfo-&gt;src-&gt;bytes_in_buffer = 0;
-}
-
-void jpeg_memory_term_source(j_decompress_ptr cinfo)
-{
-  //std::cout &lt;&lt; &quot;jpeg_memory_term&quot; &lt;&lt; std::endl;
-
-  // nothing to do destruct the source
-}
-
-boolean jpeg_memory_fill_input_buffer(j_decompress_ptr cinfo)
-{
-  //std::cout &lt;&lt; &quot;jpeg_memory_fill_input_buffer&quot; &lt;&lt; std::endl;
-
-  if (cinfo-&gt;src-&gt;next_input_byte != NULL)
-    {
-      (cinfo)-&gt;err-&gt;msg_code = JERR_INPUT_EOF;
-      (*(cinfo)-&gt;err-&gt;error_exit)((j_common_ptr) (cinfo));
-      return FALSE;
-    }
-  else
-    {
-      struct jpeg_memory_source_mgr* mgr = (struct jpeg_memory_source_mgr*)(cinfo-&gt;src);
-  
-      cinfo-&gt;src-&gt;next_input_byte = mgr-&gt;mem;
-      cinfo-&gt;src-&gt;bytes_in_buffer = mgr-&gt;len;
-
-      return TRUE;
-    }
-}
-
-void jpeg_memory_skip_input_data(j_decompress_ptr cinfo, long num_bytes)
-{
-  std::cout &lt;&lt; &quot;jpeg_memory_skip_input_data&quot; &lt;&lt; std::endl;
-
-  cinfo-&gt;src-&gt;next_input_byte = cinfo-&gt;src-&gt;next_input_byte + num_bytes;
-  cinfo-&gt;src-&gt;bytes_in_buffer = cinfo-&gt;src-&gt;bytes_in_buffer - num_bytes;
-
-  struct jpeg_memory_source_mgr* mgr = (struct jpeg_memory_source_mgr*)(cinfo-&gt;src);
-
-  if (cinfo-&gt;src-&gt;next_input_byte &gt;= &amp;mgr-&gt;mem[mgr-&gt;len])
-    {
-      (cinfo)-&gt;err-&gt;msg_code = JERR_INPUT_EOF;
-      (*(cinfo)-&gt;err-&gt;error_exit)((j_common_ptr) (cinfo));
-    }
-}
-
-void jpeg_memory_src(j_decompress_ptr cinfo, uint8_t* mem, int len)
-{
-  if (cinfo-&gt;src == NULL) 
-    {
-      cinfo-&gt;src = (struct jpeg_source_mgr*)((*cinfo-&gt;mem-&gt;alloc_small)((j_common_ptr)cinfo, 
-                                                                 JPOOL_PERMANENT,
-                                                                 sizeof(struct jpeg_memory_source_mgr)));
-    }
-  
-  cinfo-&gt;src-&gt;init_source       = jpeg_memory_init_source;
-  cinfo-&gt;src-&gt;fill_input_buffer = jpeg_memory_fill_input_buffer;
-  cinfo-&gt;src-&gt;skip_input_data   = jpeg_memory_skip_input_data;
-  cinfo-&gt;src-&gt;resync_to_restart = jpeg_resync_to_restart; /* use default method */
-  cinfo-&gt;src-&gt;term_source       = jpeg_memory_term_source;
-
-  cinfo-&gt;src-&gt;bytes_in_buffer = 0; /* forces fill_input_buffer on first read */
-  cinfo-&gt;src-&gt;next_input_byte = NULL; /* until buffer loaded */
-
-  struct jpeg_memory_source_mgr* mgr = (struct jpeg_memory_source_mgr*)(cinfo-&gt;src);
-  mgr-&gt;mem = mem;
-  mgr-&gt;len = len;
-}
-
-/* EOF */

Deleted: trunk/griv/jpeg_memory_src.hpp
===================================================================
--- trunk/griv/jpeg_memory_src.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/jpeg_memory_src.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,38 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_JPEG_MEMORY_SRC_HPP
-#define HEADER_JPEG_MEMORY_SRC_HPP
-
-#include &lt;stdint.h&gt;
-#include &lt;stdio.h&gt;
-#include &lt;jpeglib.h&gt;
-
-/** Setup IO handling so that a JPEG can be read from memory */
-void jpeg_memory_src(j_decompress_ptr cinfo, uint8_t* mem, int len);
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/math.cpp
===================================================================
--- trunk/griv/math.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/math.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,98 +0,0 @@
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software: you can redistribute it and/or modify
-//  it under the terms of the GNU General Public License as published by
-//  the Free Software Foundation, either version 3 of the License, or
-//  (at your option) any later version.
-//  
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//  
-//  You should have received a copy of the GNU General Public License
-//  along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
-
-#include &lt;math.h&gt;
-#include &quot;math.hpp&quot;
-
-namespace Math {
-
-float abs(float v)
-{
-  return ::fabs(v);
-}
-
-float sin(float a)
-{
-  return ::sinf(a);
-}
-
-float cos(float a)
-{
-  return ::cosf(a);
-}
-
-float sqrt(float a)
-{
-  return ::sqrt(a);
-}
-
-float mod(float x, float y)
-{
-  return ::fmodf(x, y);
-}
-
-float floor(float x)
-{
-  return ::floorf(x);
-}
-
-float atan2(float x, float y)
-{
-  return ::atan2(x, y);
-}
-
-static char num2hex[] = &quot;0123456789abcdef&quot;;
-
-std::string float2string(float value)
-{
-  std::string str(2*sizeof(float), '0');
-
-  for(size_t i = 0; i &lt; sizeof(float); ++i)
-    {
-      char v = reinterpret_cast&lt;char*&gt;(&amp;value)[i];
-      str[2*i + 0] = num2hex[(v &amp; 0xf0) &gt;&gt; 4];
-      str[2*i + 1] = num2hex[v &amp; 0x0f];
-    }
-  return str;
-}
-
-static char hex2int(char c)
-{
-  if (c &gt;= '0' &amp;&amp; c &lt;= '9')
-    return c - '0';
-  else if (c &gt;= 'a' &amp;&amp; c &lt;= 'f')
-    return c - 'a' + 0xa;
-  else
-    return 0;    
-}
-
-float string2float(const std::string&amp; str)
-{
-  assert(str.size() == 2*sizeof(float));
-
-  float value;
-  for(size_t i = 0; i &lt; sizeof(float); ++i)
-    {
-      char&amp; v = reinterpret_cast&lt;char*&gt;(&amp;value)[i];
-      v = (hex2int(str[2*i+0]) &lt;&lt; 4) | hex2int(str[2*i+1]);
-    }
-
-  return value;
-}
-
-} // namespace Math
-
-/* EOF */

Deleted: trunk/griv/math.hpp
===================================================================
--- trunk/griv/math.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/math.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,131 +0,0 @@
-//  Pingus - A free Lemmings clone
-//  Copyright (C) 2000 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-//
-//  This program is free software: you can redistribute it and/or modify
-//  it under the terms of the GNU General Public License as published by
-//  the Free Software Foundation, either version 3 of the License, or
-//  (at your option) any later version.
-//  
-//  This program is distributed in the hope that it will be useful,
-//  but WITHOUT ANY WARRANTY; without even the implied warranty of
-//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-//  GNU General Public License for more details.
-//  
-//  You should have received a copy of the GNU General Public License
-//  along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
-
-#ifndef HEADER_PINGUS_MATH_HPP
-#define HEADER_PINGUS_MATH_HPP
-
-#include &lt;assert.h&gt;
-#include &lt;stdlib.h&gt;
-#include &lt;string&gt;
-
-/** A collection of small math helper functions, some of them might be
-    equal in functionality to standard STL functions, but provided
-    here for portability and broken STL implementations
-
-    @brief A collection of mathematical helper functions */
-namespace Math {
-
-const float pi   = 3.14159265358979323846f;	/* pi */
-const float pi_2 = 1.57079632679489661923f;	/* pi/2 */
-
-// Win32 defines these are defines already, so we have to undef them
-#ifdef min
-#undef min
-#endif
-#ifdef max
-#undef max
-#endif
-
-template&lt;class T&gt;
-T min (const T&amp; a, const T&amp; b)
-{
-  if (a &lt; b)
-    return a;
-  else
-    return b;
-}
-
-template&lt;class T&gt;
-T max (const T&amp; a, const T&amp; b)
-{
-  if (a &gt; b)
-    return a;
-  else
-    return b;
-}
-
-template&lt;class T&gt;
-T clamp (const T&amp; low, const T&amp; v, const T&amp; high)
-{
-  assert(low &lt;= high);
-  return max((low), min((v), (high)));
-}
-
-inline
-float frand()
-{
-  return rand() / (RAND_MAX + 1.0f);
-}
-
-inline
-bool rand_bool()
-{
-  return rand()%2 == 0;
-}
-
-inline int round (float f)
-{
-  if (f &gt;= 0.0f)
-    return int(f + 0.5f);
-  else
-    return int(f - 0.5f);
-}
-
-float abs(float v);
-float sin(float a);
-float cos(float a);
-float sqrt(float a);
-float mod(float x, float y);
-float floor(float x);
-float atan2(float x, float y);
-
-/** Write out the raw bits of a float as hex */
-std::string float2string(float value);
-
-/** Restore the raw bits of a float from a string */
-float string2float(const std::string&amp; str);
-
-inline int round_to_power_of_two(int n)
-{
-  n = n - 1;
-
-  n = n | (n &gt;&gt; 1);
-  n = n | (n &gt;&gt; 2);
-  n = n | (n &gt;&gt; 4);
-  n = n | (n &gt;&gt; 8);
-  n = n | (n &gt;&gt; 16);
-  
-  n = n + 1;
-  
-  return n;
-}
-
-/** Calculates 2^n */
-inline int pow2(int n)
-{
-  return (1 &lt;&lt; n);
-}
-
-inline bool is_power_of_two(int n)
-{
-  return (n &gt; 0) &amp;&amp; ((n &amp; (n - 1)) == 0);
-}
-
-} // namespace Math
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/md5.cpp
===================================================================
--- trunk/griv/md5.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/md5.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,84 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;mhash.h&gt;
-#include &lt;fstream&gt;
-#include &lt;iomanip&gt;
-#include &lt;sstream&gt;
-#include &lt;stdexcept&gt;
-#include &quot;md5.hpp&quot;
-
-std::string
-MD5::md5_string(const std::string&amp; str)
-{
-  unsigned char hash[16]; /* enough size for MD5 */
-  MHASH td = mhash_init(MHASH_MD5);
-  if (td == MHASH_FAILED)
-    throw std::runtime_error(&quot;Failed to init MHash&quot;);
-  
-  mhash(td, str.c_str(), str.length());
-  
-  mhash_deinit(td, hash);
-
-  // Convert to string representation
-  std::ostringstream out;
-  for (int i = 0; i &lt; 16; i++) 
-    out &lt;&lt; std::setfill('0') &lt;&lt; std::setw(2) &lt;&lt; std::hex &lt;&lt; int(hash[i]);
-
-  return out.str();
-}
-
-std::string
-MD5::md5_file(const std::string&amp; filename)
-{
-  unsigned char hash[16]; /* enough size for MD5 */
-  MHASH td = mhash_init(MHASH_MD5);
-  if (td == MHASH_FAILED) 
-    throw std::runtime_error(&quot;Failed to init MHash&quot;);
-  
-  const unsigned int buf_size = 32768;
-  char buf[buf_size];
-  std::ifstream in(filename.c_str(), std::ios::in | std::ios::binary); 
-  if (!in)
-    throw std::runtime_error(&quot;MD5: Couldn't open file &quot; + filename);
-    
-  while(!in.eof())
-    {
-      in.read(buf, buf_size);
-      mhash(td, buf, in.gcount());
-    }
-
-  in.close();
-    
-  mhash_deinit(td, hash);
-
-  // Convert to string representation
-  std::ostringstream out;
-  for (int i = 0; i &lt; 16; i++)
-    out &lt;&lt; std::setfill('0') &lt;&lt; std::setw(2) &lt;&lt; std::hex &lt;&lt; int(hash[i]);
-  return out.str();  
-}
-
-/* EOF */

Deleted: trunk/griv/md5.hpp
===================================================================
--- trunk/griv/md5.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/md5.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,40 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_MD5_HPP
-#define HEADER_MD5_HPP
-
-#include &lt;string&gt;
-
-class MD5
-{
-public:
-  static std::string md5_string(const std::string&amp; str);
-  static std::string md5_file(const std::string&amp; filename);
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/software_surface.cpp
===================================================================
--- trunk/griv/software_surface.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/software_surface.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,198 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;assert.h&gt;
-#include &lt;iostream&gt;
-#include &lt;stdexcept&gt;
-
-#include &quot;blob.hpp&quot;
-#include &quot;math.hpp&quot;
-#include &quot;jpeg.hpp&quot;
-#include &quot;math/rect.hpp&quot;
-#include &quot;math/size.hpp&quot;
-
-#include &quot;url.hpp&quot;
-#include &quot;software_surface.hpp&quot;
-
-class SoftwareSurfaceImpl
-{
-public:
-  Size     size;
-  int      pitch;
-  uint8_t* pixels;
-  
-  SoftwareSurfaceImpl(const Size&amp; size)
-    : size(size),
-      pitch(size.width * 3),
-      pixels(new uint8_t[pitch * size.height])
-  {
-  }
-
-  ~SoftwareSurfaceImpl() 
-  {
-    delete[] pixels;
-  }
-};
-
-SoftwareSurface::SoftwareSurface()
-{
-}
-
-SoftwareSurface::SoftwareSurface(const Size&amp; size)
- : impl(new SoftwareSurfaceImpl(size))
-{
-}
-
-SoftwareSurface::~SoftwareSurface()
-{
-}
-
-void
-SoftwareSurface::put_pixel(int x, int y, uint8_t r, uint8_t g, uint8_t b)
-{
-  assert(x &gt;= 0 &amp;&amp; x &lt; impl-&gt;size.width &amp;&amp;
-         y &gt;= 0 &amp;&amp; y &lt; impl-&gt;size.height);
-
-  impl-&gt;pixels[y * impl-&gt;pitch + x*3 + 0] = r;
-  impl-&gt;pixels[y * impl-&gt;pitch + x*3 + 1] = g;
-  impl-&gt;pixels[y * impl-&gt;pitch + x*3 + 2] = b;
-}
-
-void
-SoftwareSurface::get_pixel(int x, int y, uint8_t* r, uint8_t* g, uint8_t* b) const
-{
-  assert(x &gt;= 0 &amp;&amp; x &lt; impl-&gt;size.width &amp;&amp;
-         y &gt;= 0 &amp;&amp; y &lt; impl-&gt;size.height);
-
-  *r = impl-&gt;pixels[y * impl-&gt;pitch + x*3 + 0];
-  *g = impl-&gt;pixels[y * impl-&gt;pitch + x*3 + 1];
-  *b = impl-&gt;pixels[y * impl-&gt;pitch + x*3 + 2];
-}
-
-SoftwareSurface
-SoftwareSurface::scale(const Size&amp; size) const
-{
-  SoftwareSurface surface(size);
-  // Very much non-fast, needs replacement with proper
-
-  uint8_t r,g,b;
-  for(int y = 0; y &lt; surface.get_height(); ++y)
-    for(int x = 0; x &lt; surface.get_width(); ++x)
-      {
-        get_pixel(x * impl-&gt;size.width  / surface.impl-&gt;size.width,
-                  y * impl-&gt;size.height / surface.impl-&gt;size.height,
-                  &amp;r, &amp;g, &amp;b);
-
-        surface.put_pixel(x, y, r, g, b);
-      }
-
-  return surface;
-}
-
-SoftwareSurface
-SoftwareSurface::crop(const Rect&amp; rect_in) const
-{
-  assert(rect_in.is_normal());
- 
-  // Clip the rectangle to the image
-  Rect rect(Math::max(0, rect_in.left),
-            Math::max(0, rect_in.top),
-            Math::min(get_width(),  rect_in.right), 
-            Math::min(get_height(), rect_in.bottom));
-
-  SoftwareSurface surface(rect.get_size());
-
-  for(int y = rect.top; y &lt; rect.bottom; ++y)
-    {
-      memcpy(surface.get_row_data(y - rect.top), 
-             get_row_data(y) + rect.left*3,
-             rect.get_width() * 3);
-    }
-
-  return surface;
-}
-
-Size
-SoftwareSurface::get_size()  const
-{
-  return impl-&gt;size;
-}
-
-int
-SoftwareSurface::get_width()  const
-{
-  return impl-&gt;size.width;
-}
-
-int
-SoftwareSurface::get_height() const
-{
-  return impl-&gt;size.height;
-}
-
-int
-SoftwareSurface::get_pitch()  const
-{
-  return impl-&gt;pitch;
-}
-
-void
-SoftwareSurface::save(const std::string&amp; filename) const
-{
-  assert(!&quot;SoftwareSurface::save(const std::string&amp; filename) const&quot;);
-}
-
-Blob
-SoftwareSurface::get_jpeg_data() const
-{
-  return JPEG::save(*this, 75);
-}
-
-SoftwareSurface
-SoftwareSurface::from_file(const std::string&amp; filename)
-{
-  return JPEG::load(filename);
-}
-
-SoftwareSurface
-SoftwareSurface::from_data(const Blob&amp; blob)
-{
-  return JPEG::load(blob.get_data(), blob.size());
-}
-
-uint8_t*
-SoftwareSurface::get_data() const
-{
-  return impl-&gt;pixels;
-}
-
-uint8_t*
-SoftwareSurface::get_row_data(int y) const
-{
-  return impl-&gt;pixels + (y * impl-&gt;pitch);
-  
-}
-  
-/* EOF */

Deleted: trunk/griv/software_surface.hpp
===================================================================
--- trunk/griv/software_surface.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/software_surface.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,74 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_SOFTWARE_SURFACE_HPP
-#define HEADER_SOFTWARE_SURFACE_HPP
-
-#include &lt;boost/shared_ptr.hpp&gt;
-#include &quot;blob.hpp&quot;
-
-class URL;
-class Rect;
-class Size;
-class SoftwareSurfaceImpl;
-
-class SoftwareSurface
-{
-public:
-  SoftwareSurface();
-  SoftwareSurface(const Size&amp; size);
-
-  ~SoftwareSurface();
-
-  Size get_size()  const;
-  int get_width()  const;
-  int get_height() const;
-  int get_pitch()  const;
-
-  SoftwareSurface scale(const Size&amp; size) const;
-  SoftwareSurface crop(const Rect&amp; rect) const;
-
-  void save(const std::string&amp; filename) const;
-  
-  Blob get_jpeg_data() const;
-  
-  static SoftwareSurface from_data(const Blob&amp; blob);
-  static SoftwareSurface from_file(const std::string&amp; filename);
- 
-  void put_pixel(int x, int y, uint8_t r, uint8_t g, uint8_t b);
-  void get_pixel(int x, int y, uint8_t* r, uint8_t* g, uint8_t* b) const;
-
-  uint8_t* get_data() const;
-  uint8_t* get_row_data(int y) const;
-
-  operator bool() const { return impl.get(); }
-
-private:
-  boost::shared_ptr&lt;SoftwareSurfaceImpl&gt; impl;
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/sqlite.cpp
===================================================================
--- trunk/griv/sqlite.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/sqlite.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,290 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &quot;SDL.h&quot;
-
-#include &lt;iostream&gt;
-#include &lt;sstream&gt;
-#include &quot;sqlite.hpp&quot;
-
-int busy_callback(void* , int n)
-{
-  SDL_Delay(10);
-  return 1;
-}
-
-SQLiteError::SQLiteError(const std::string&amp; err_)
-  : err(err_)
-{  
-}
-
-SQLiteConnection::SQLiteConnection(const std::string&amp; filename)
-{
-  if (sqlite3_open(filename.c_str(), &amp;db) != SQLITE_OK)
-    {
-      std::ostringstream str; 
-      str &lt;&lt; &quot;SQLiteConnection: can't open database: &quot; &lt;&lt; sqlite3_errmsg(db);
-      throw SQLiteError(str.str());
-    }
-
-  sqlite3_busy_handler(db, busy_callback, 0);
-}
-
-SQLiteConnection::~SQLiteConnection()
-{
-  sqlite3_close(db);
-}
-
-void
-SQLiteConnection::exec(const std::string&amp; sqlstmt)
-{
-  char* errmsg;
-
-  //std::cout &lt;&lt; &quot;SQLiteConnection::exec: &quot; &lt;&lt; sqlstmt &lt;&lt; std::endl;
-
-  if (sqlite3_exec(db, sqlstmt.c_str(), 0, 0, &amp;errmsg) != SQLITE_OK)
-    {
-      std::ostringstream out;
-
-      out &lt;&lt; &quot;FileDatabase: &quot; &lt;&lt; errmsg &lt;&lt; std::endl;
-
-      sqlite3_free(errmsg);
-      errmsg = 0;
-
-      throw SQLiteError(out.str());
-    }
-}
-
-void
-SQLiteConnection::vacuum()
-{
-  SQLiteStatement stmt(this);
-  stmt.prepare(&quot;VACUUM;&quot;);
-  stmt.execute();
-}
-
-SQLiteStatement::SQLiteStatement(SQLiteConnection* db)
-  : db(db), 
-    stmt(0)
-{
-}
-
-SQLiteStatement::SQLiteStatement(SQLiteConnection* db, const std::string&amp; sqlstmt)
-  : db(db),
-    stmt(0)
-{
-  prepare(sqlstmt);
-}
-
-SQLiteStatement::~SQLiteStatement()
-{
- retry: 
-
-  switch (sqlite3_finalize(stmt))
-    {
-      case SQLITE_OK:
-        break;
-
-      case SQLITE_LOCKED:
-        goto retry;
-
-      case SQLITE_BUSY:
-        goto retry;
-
-      default:
-        {
-          std::ostringstream str;
-          str &lt;&lt; &quot;SQLiteStatement::~SQLiteStatement: &quot; &lt;&lt; sqlite3_errmsg(db-&gt;get_db());
-          throw SQLiteError(str.str());
-        }
-
-    }
-}
-
-void
-SQLiteStatement::prepare(const std::string&amp; sqlstmt)
-{
-  if (sqlite3_prepare_v2(db-&gt;get_db(), sqlstmt.c_str(), -1, &amp;stmt,  0)
-      != SQLITE_OK)
-    {
-      std::ostringstream str;
-      str &lt;&lt; &quot;SQLiteStatement::prepare: &quot; &lt;&lt; sqlite3_errmsg(db-&gt;get_db()) &lt;&lt; &quot;:\n&quot; &lt;&lt; sqlstmt;
-      throw SQLiteError(str.str());
-    }
-}
-
-void
-SQLiteStatement::bind_int(int n, int i)
-{
-  if (sqlite3_bind_int(stmt, n, i) != SQLITE_OK)
-    {
-      std::ostringstream str;
-      str &lt;&lt; &quot;SQLiteStatement::bind_int: &quot; &lt;&lt; sqlite3_errmsg(db-&gt;get_db());
-      throw SQLiteError(str.str());
-    }
-}
-
-void
-SQLiteStatement::bind_text(int n, const std::string&amp; text)
-{
-  if (sqlite3_bind_text(stmt, n, text.c_str(), text.size(), SQLITE_TRANSIENT) != SQLITE_OK)
-    {
-      std::ostringstream str;
-      str &lt;&lt; &quot;SQLiteStatement::bind_text: &quot; &lt;&lt; sqlite3_errmsg(db-&gt;get_db());
-      throw SQLiteError(str.str());      
-    }
-}
-
-void
-SQLiteStatement::bind_null(int n)
-{
-  if (sqlite3_bind_null(stmt, n) != SQLITE_OK)
-    {
-      std::ostringstream str;
-      str &lt;&lt; &quot;SQLiteStatement::bind_text: &quot; &lt;&lt; sqlite3_errmsg(db-&gt;get_db());
-      throw SQLiteError(str.str());      
-    }  
-}
-
-void
-SQLiteStatement::bind_blob(int n, const Blob&amp; blob)
-{
-  if (sqlite3_bind_blob(stmt, n, blob.get_data(), blob.size(), SQLITE_TRANSIENT) != SQLITE_OK)
-    {
-      std::ostringstream str;
-      str &lt;&lt; &quot;SQLiteStatement::bind_blob: &quot; &lt;&lt; sqlite3_errmsg(db-&gt;get_db());
-      throw SQLiteError(str.str());
-    }
-}
-
-void
-SQLiteStatement::reset()
-{
-  sqlite3_clear_bindings(stmt);  
-
-  if (sqlite3_reset(stmt) != SQLITE_OK)
-    {
-      std::ostringstream str;
-      str &lt;&lt; &quot;SQLiteStatement::reset: &quot; &lt;&lt; sqlite3_errmsg(db-&gt;get_db());
-      throw SQLiteError(str.str());
-    }
-}
-
-void 
-SQLiteStatement::execute()
-{
-  if (sqlite3_step(stmt) != SQLITE_DONE)
-    {
-      std::ostringstream str;
-      str &lt;&lt; &quot;SQLiteStatement::execute: &quot; &lt;&lt; sqlite3_errmsg(db-&gt;get_db());
-      throw SQLiteError(str.str());      
-    }
-
-  reset();
-}
-
-SQLiteReader
-SQLiteStatement::execute_query()
-{
-  return SQLiteReader(db, stmt);
-}
-
-SQLiteReader::SQLiteReader(SQLiteConnection* db, sqlite3_stmt* stmt)
-  : db(db),
-    stmt(stmt)
-{
-}
-
-SQLiteReader::~SQLiteReader()
-{  
-  // FIXME: Not good, we likely clean up twice
-  
-  sqlite3_clear_bindings(stmt);  
-
-  if (sqlite3_reset(stmt) != SQLITE_OK)
-    {
-      std::ostringstream str;
-      str &lt;&lt; &quot;SQLiteReader::~SQLiteReader:&quot; &lt;&lt; sqlite3_errmsg(db-&gt;get_db());
-      throw SQLiteError(str.str());
-    }
-}
-
-bool
-SQLiteReader::next()
-{
- retry:
-
-  switch(sqlite3_step(stmt))
-    {
-      case SQLITE_DONE:
-        // cleanup here or in the destructor?!
-        return false;
-
-      case SQLITE_ROW:
-        return true;
-
-      case SQLITE_BUSY:
-        goto retry;        
-        
-      case SQLITE_ERROR:
-      case SQLITE_MISUSE:
-      default:
-        {
-          std::ostringstream str;
-          str &lt;&lt; &quot;SQLiteStatement::execute_query: &quot; &lt;&lt; sqlite3_errmsg(db-&gt;get_db());
-          throw SQLiteError(str.str());     
-          return false;
-        }
-    }
-}
-
-int
-SQLiteReader::get_int(int column)
-{
-  return sqlite3_column_int(stmt, column);
-}
-
-std::string
-SQLiteReader::get_text(int column)
-{
-  const void* data = sqlite3_column_text(stmt, column);
-  int len = sqlite3_column_bytes(stmt, column);
-  return std::string(static_cast&lt;const char*&gt;(data), len);
-}
-
-Blob
-SQLiteReader::get_blob(int column)
-{
-  return Blob(sqlite3_column_blob(stmt, column),
-              sqlite3_column_bytes(stmt, column));
-}
-
-std::string
-SQLiteReader::get_column_name(int column)
-{
-  return sqlite3_column_name(stmt, column);
-}
-
-/* EOF */

Deleted: trunk/griv/sqlite.hpp
===================================================================
--- trunk/griv/sqlite.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/sqlite.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,114 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_SQLITE_HPP
-#define HEADER_SQLITE_HPP
-
-#include &lt;stdexcept&gt;
-#include &lt;sqlite3.h&gt;
-
-#include &quot;blob.hpp&quot;
-
-class SQLiteError : public std::exception
-{
-private:
-  std::string err;
-
-public:
-  SQLiteError(const std::string&amp; err);
-  virtual ~SQLiteError() throw () {}
-
-  const char* what() const throw () { return err.c_str(); }
-};
-
-class SQLiteConnection
-{
-private:
-  sqlite3* db;
-
-public:
-  SQLiteConnection(const std::string&amp; filename);
-  ~SQLiteConnection();
-
-  void exec(const std::string&amp; sqlstmt);
-
-  /** Do a VACCUM on the database to clean up collected garbage, this
-      call can take quite a while (~1min) for larger databases, since
-      the whole database gets copied in the process */
-  void vacuum();
-
-  sqlite3* get_db() const { return db; }
-};
-
-class SQLiteReader
-{
-private:
-  SQLiteConnection* db;
-  sqlite3_stmt*   stmt;
-  
-public:
-  SQLiteReader(SQLiteConnection* db, sqlite3_stmt* stmt);
-  ~SQLiteReader();
-
-  bool next();
-
-  int         get_int(int column);
-  std::string get_text(int column);
-  Blob        get_blob(int column);
-
-  std::string get_column_name(int column);
-};
-
-class SQLiteStatement
-{
-private:
-  SQLiteConnection* db;
-  sqlite3_stmt*   stmt;
-
-  void reset();
-  
-public:
-  SQLiteStatement(SQLiteConnection* db);
-  SQLiteStatement(SQLiteConnection* db, const std::string&amp; sqlstmt);
-  ~SQLiteStatement();
-
-  void prepare(const std::string&amp; sqlstmt);
-
-  void bind_null(int n);
-  void bind_int(int n, int i);
-  void bind_text(int n, const std::string&amp;);
-  void bind_blob(int n, const Blob&amp;);
-
-  void execute();
-  SQLiteReader execute_query();
-
-private:
-  SQLiteStatement(const SQLiteStatement&amp;);
-  SQLiteStatement();
-};
-
-#endif
-
-/* EOF */

Copied: trunk/griv/src/blob.cpp (from rev 2343, trunk/griv/blob.cpp)

Copied: trunk/griv/src/blob.hpp (from rev 2343, trunk/griv/blob.hpp)

Copied: trunk/griv/src/database_thread.cpp (from rev 2343, trunk/griv/database_thread.cpp)

Copied: trunk/griv/src/database_thread.hpp (from rev 2343, trunk/griv/database_thread.hpp)

Copied: trunk/griv/src/file_database.cpp (from rev 2343, trunk/griv/file_database.cpp)

Copied: trunk/griv/src/file_database.hpp (from rev 2343, trunk/griv/file_database.hpp)

Copied: trunk/griv/src/filesystem.cpp (from rev 2343, trunk/griv/filesystem.cpp)

Copied: trunk/griv/src/filesystem.hpp (from rev 2343, trunk/griv/filesystem.hpp)

Copied: trunk/griv/src/framebuffer.cpp (from rev 2343, trunk/griv/framebuffer.cpp)

Copied: trunk/griv/src/framebuffer.hpp (from rev 2343, trunk/griv/framebuffer.hpp)

Copied: trunk/griv/src/grid.hpp (from rev 2343, trunk/griv/grid.hpp)

Copied: trunk/griv/src/griv.cpp (from rev 2344, trunk/griv/griv.cpp)

Copied: trunk/griv/src/griv.hpp (from rev 2343, trunk/griv/griv.hpp)

Copied: trunk/griv/src/image.cpp (from rev 2343, trunk/griv/image.cpp)

Copied: trunk/griv/src/image.hpp (from rev 2343, trunk/griv/image.hpp)

Copied: trunk/griv/src/job_handle.cpp (from rev 2343, trunk/griv/job_handle.cpp)

Copied: trunk/griv/src/job_handle.hpp (from rev 2343, trunk/griv/job_handle.hpp)

Copied: trunk/griv/src/jpeg.cpp (from rev 2343, trunk/griv/jpeg.cpp)

Copied: trunk/griv/src/jpeg.hpp (from rev 2343, trunk/griv/jpeg.hpp)

Copied: trunk/griv/src/jpeg_decoder_thread.cpp (from rev 2343, trunk/griv/jpeg_decoder_thread.cpp)

Copied: trunk/griv/src/jpeg_decoder_thread.hpp (from rev 2343, trunk/griv/jpeg_decoder_thread.hpp)

Copied: trunk/griv/src/jpeg_image.cpp (from rev 2343, trunk/griv/jpeg_image.cpp)

Copied: trunk/griv/src/jpeg_image.hpp (from rev 2343, trunk/griv/jpeg_image.hpp)

Copied: trunk/griv/src/jpeg_memory_dest.cpp (from rev 2343, trunk/griv/jpeg_memory_dest.cpp)

Copied: trunk/griv/src/jpeg_memory_dest.hpp (from rev 2343, trunk/griv/jpeg_memory_dest.hpp)

Copied: trunk/griv/src/jpeg_memory_src.cpp (from rev 2343, trunk/griv/jpeg_memory_src.cpp)

Copied: trunk/griv/src/jpeg_memory_src.hpp (from rev 2343, trunk/griv/jpeg_memory_src.hpp)

Copied: trunk/griv/src/math (from rev 2343, trunk/griv/math)

Copied: trunk/griv/src/math.cpp (from rev 2343, trunk/griv/math.cpp)

Copied: trunk/griv/src/math.hpp (from rev 2343, trunk/griv/math.hpp)

Copied: trunk/griv/src/md5.cpp (from rev 2343, trunk/griv/md5.cpp)

Copied: trunk/griv/src/md5.hpp (from rev 2343, trunk/griv/md5.hpp)

Copied: trunk/griv/src/software_surface.cpp (from rev 2343, trunk/griv/software_surface.cpp)

Copied: trunk/griv/src/software_surface.hpp (from rev 2343, trunk/griv/software_surface.hpp)

Copied: trunk/griv/src/sqlite.cpp (from rev 2343, trunk/griv/sqlite.cpp)

Copied: trunk/griv/src/sqlite.hpp (from rev 2343, trunk/griv/sqlite.hpp)

Copied: trunk/griv/src/surface.cpp (from rev 2343, trunk/griv/surface.cpp)

Copied: trunk/griv/src/surface.hpp (from rev 2343, trunk/griv/surface.hpp)

Copied: trunk/griv/src/texture.cpp (from rev 2343, trunk/griv/texture.cpp)

Copied: trunk/griv/src/texture.hpp (from rev 2343, trunk/griv/texture.hpp)

Copied: trunk/griv/src/thread.cpp (from rev 2343, trunk/griv/thread.cpp)

Copied: trunk/griv/src/thread.hpp (from rev 2343, trunk/griv/thread.hpp)

Copied: trunk/griv/src/thread_message_queue.hpp (from rev 2343, trunk/griv/thread_message_queue.hpp)

Copied: trunk/griv/src/tile_database.cpp (from rev 2343, trunk/griv/tile_database.cpp)

Copied: trunk/griv/src/tile_database.hpp (from rev 2343, trunk/griv/tile_database.hpp)

Copied: trunk/griv/src/tile_generator.cpp (from rev 2343, trunk/griv/tile_generator.cpp)

Copied: trunk/griv/src/tile_generator.hpp (from rev 2343, trunk/griv/tile_generator.hpp)

Copied: trunk/griv/src/tile_generator_thread.cpp (from rev 2343, trunk/griv/tile_generator_thread.cpp)
===================================================================
--- trunk/griv/tile_generator_thread.cpp	2008-08-20 17:21:44 UTC (rev 2343)
+++ trunk/griv/src/tile_generator_thread.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -0,0 +1,97 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#include &lt;iostream&gt;
+#include &lt;boost/bind.hpp&gt;
+#include &quot;tile_generator.hpp&quot;
+#include &quot;database_thread.hpp&quot;
+#include &quot;tile_generator_thread.hpp&quot;
+ 
+TileGeneratorThread* TileGeneratorThread::current_ = 0; 
+
+TileGeneratorThread::TileGeneratorThread()
+  : quit(false)
+{
+  current_ = this;
+}
+
+TileGeneratorThread::~TileGeneratorThread()
+{
+}
+
+void
+TileGeneratorThread::request_tiles(int fileid, const std::string&amp; filename)
+{
+  TileGeneratorMessage msg;
+
+  msg.fileid   = fileid;
+  msg.filename = filename;
+
+  msg_queue.push(msg);
+}
+
+void
+TileGeneratorThread::request_tile(int fileid, const std::string&amp; filename, int x, int y, int scale)
+{
+  // Do some magic to group tile request for the same fileid
+}
+
+void
+TileGeneratorThread::stop()
+{
+  quit = true;
+}
+
+void
+TileGeneratorThread::receive_tile(const Tile&amp; tile)
+{
+  DatabaseThread::current()-&gt;store_tile(tile);
+}
+
+int
+TileGeneratorThread::run()
+{
+  quit = false;
+
+  TileGenerator generator;
+
+  while(!quit)
+    {
+      while(!msg_queue.empty())
+        {
+          TileGeneratorMessage msg = msg_queue.front();
+          msg_queue.pop();
+
+          std::cout &lt;&lt; &quot;Generating tiles for: &quot; &lt;&lt; msg.filename &lt;&lt; std::endl;
+          generator.generate_all(msg.fileid, msg.filename,
+                                 boost::bind(&amp;TileGeneratorThread::receive_tile, this, _1));
+        }
+      msg_queue.wait();
+    }
+
+  return 0;
+}
+
+/* EOF */

Copied: trunk/griv/src/tile_generator_thread.hpp (from rev 2343, trunk/griv/tile_generator_thread.hpp)
===================================================================
--- trunk/griv/tile_generator_thread.hpp	2008-08-20 17:21:44 UTC (rev 2343)
+++ trunk/griv/src/tile_generator_thread.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -0,0 +1,70 @@
+/*  $Id$
+**   __      __ __             ___        __   __ __   __
+**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
+**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
+**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
+**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
+**         \/          \/      \/    \/                         \/
+**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
+**
+**  This program is free software; you can redistribute it and/or
+**  modify it under the terms of the GNU General Public License
+**  as published by the Free Software Foundation; either version 2
+**  of the License, or (at your option) any later version.
+**
+**  This program is distributed in the hope that it will be useful,
+**  but WITHOUT ANY WARRANTY; without even the implied warranty of
+**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+**  GNU General Public License for more details.
+** 
+**  You should have received a copy of the GNU General Public License
+**  along with this program; if not, write to the Free Software
+**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+**  02111-1307, USA.
+*/
+
+#ifndef HEADER_TILE_GENERATOR_THREAD_HPP
+#define HEADER_TILE_GENERATOR_THREAD_HPP
+
+#include &quot;thread.hpp&quot;
+#include &quot;thread_message_queue.hpp&quot;
+
+struct TileGeneratorMessage
+{
+  int fileid;
+  std::string filename;
+};
+
+class TileGeneratorThread : public Thread
+{
+private:
+  static TileGeneratorThread* current_; 
+public:
+  static TileGeneratorThread* current() { return current_; }
+
+private:
+  bool quit;
+  ThreadMessageQueue&lt;TileGeneratorMessage&gt; msg_queue;
+
+protected:
+  int run();
+  
+public:
+  TileGeneratorThread();
+  ~TileGeneratorThread();
+
+  void stop();
+
+  void request_tiles(int fileid, const std::string&amp; filename);
+  void request_tile (int fileid, const std::string&amp; filename, int x, int y, int scale);
+
+  void receive_tile(const Tile&amp; tile);
+  
+private:
+  TileGeneratorThread (const TileGeneratorThread&amp;);
+  TileGeneratorThread&amp; operator= (const TileGeneratorThread&amp;);
+};
+
+#endif
+
+/* EOF */

Copied: trunk/griv/src/url.cpp (from rev 2343, trunk/griv/url.cpp)

Copied: trunk/griv/src/url.hpp (from rev 2343, trunk/griv/url.hpp)

Copied: trunk/griv/src/viewer.cpp (from rev 2343, trunk/griv/viewer.cpp)

Copied: trunk/griv/src/viewer.hpp (from rev 2343, trunk/griv/viewer.hpp)

Copied: trunk/griv/src/viewer_thread.cpp (from rev 2343, trunk/griv/viewer_thread.cpp)

Copied: trunk/griv/src/viewer_thread.hpp (from rev 2343, trunk/griv/viewer_thread.hpp)

Copied: trunk/griv/src/workspace.cpp (from rev 2343, trunk/griv/workspace.cpp)

Copied: trunk/griv/src/workspace.hpp (from rev 2343, trunk/griv/workspace.hpp)

Deleted: trunk/griv/surface.cpp
===================================================================
--- trunk/griv/surface.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/surface.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,199 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;iostream&gt;
-#include &lt;assert.h&gt;
-#include &quot;framebuffer.hpp&quot;
-#include &quot;math.hpp&quot;
-#include &quot;math/vector2i.hpp&quot;
-#include &quot;math/vector2f.hpp&quot;
-#include &quot;math/size.hpp&quot;
-#include &quot;math/rect.hpp&quot;
-#include &quot;software_surface.hpp&quot;
-#include &quot;surface.hpp&quot;
-
-class SurfaceImpl
-{
-public:
-  Texture texture;
-  Rectf   uv;
-  Size    size;
-  
-  SurfaceImpl(const Texture&amp; texture_, const Rectf&amp; uv_, const Size&amp; size_)
-    : texture(texture_),
-      uv(uv_),
-      size(size_)
-  {
-    //std::cout &lt;&lt; uv &lt;&lt; std::endl;
-  }
-
-  SurfaceImpl(const SoftwareSurface&amp; src, const Rect&amp; srcrect)
-  {
-    assert(src);
-
-    texture = Texture(src, srcrect);
-    
-    uv = Rectf(Vector2f(0, 0), srcrect.get_size());
-
-    size = Size(srcrect.get_size());
-  }
-  
-  ~SurfaceImpl()
-  {
-  }
-
-  void draw(const Rectf&amp; srcrect, const Rectf&amp; dstrect)
-  {
-    if (texture)
-      {
-        texture.bind();
-        glEnable(GL_TEXTURE_RECTANGLE_ARB);
-        glColor3f(1.0f, 1.0f, 1.0f);       
-
-        glBegin(GL_QUADS);
-        glTexCoord2f(srcrect.left, srcrect.top);
-        glVertex2f(dstrect.left, dstrect.top);
-
-        glTexCoord2f(srcrect.right, srcrect.top);
-        glVertex2f(dstrect.right, dstrect.top);
-
-        glTexCoord2f(srcrect.right, srcrect.bottom);
-        glVertex2f(dstrect.right, dstrect.bottom);
-
-        glTexCoord2f(srcrect.left, srcrect.bottom);
-        glVertex2f(dstrect.left, dstrect.bottom);
-        glEnd();
-      }    
-  }
-
-  void draw(const Rectf&amp; rect)
-  {
-    if (texture)
-      {
-        texture.bind();
-        glEnable(GL_TEXTURE_RECTANGLE_ARB);
-        glColor3f(1.0f, 1.0f, 1.0f);       
-
-        glBegin(GL_QUADS);
-        glTexCoord2f(uv.left, uv.top);
-        glVertex2f(rect.left, rect.top);
-
-        glTexCoord2f(uv.right, uv.top);
-        glVertex2f(rect.right, rect.top);
-
-        glTexCoord2f(uv.right, uv.bottom);
-        glVertex2f(rect.right, rect.bottom);
-
-        glTexCoord2f(uv.left, uv.bottom);
-        glVertex2f(rect.left, rect.bottom);
-        glEnd();
-      }
-  }
-
-  void draw(const Vector2f&amp; pos)
-  {
-    draw(Rectf(pos, size));
-  }
-};
-
-Surface::Surface()
-{
-}
-
-Surface::Surface(boost::shared_ptr&lt;SurfaceImpl&gt; impl_)
-  : impl(impl_)
-{
-}
-
-Surface::Surface(const SoftwareSurface&amp; src)
-  : impl(new SurfaceImpl(src, Rect(Vector2i(0, 0), src.get_size())))
-{
-}
-
-Surface::Surface(const SoftwareSurface&amp; src, const Rect&amp; srcrect)
-  : impl(new SurfaceImpl(src, srcrect))
-{
-}
-
-Surface::~Surface()
-{
-}
-
-void
-Surface::draw(const Vector2f&amp; pos)
-{
-  if (impl.get())
-    impl-&gt;draw(pos);
-}
-
-void
-Surface::draw(const Rectf&amp; srcrect, const Rectf&amp; dstrect)
-{
-  if (impl.get())
-    impl-&gt;draw(srcrect, dstrect);  
-}
-
-void
-Surface::draw(const Rectf&amp; rect)
-{
-  if (impl.get())
-    impl-&gt;draw(rect);
-}
-
-int
-Surface::get_width() const 
-{
-  if (impl.get())
-    return impl-&gt;size.width; 
-  else
-    return 0;
-}
-
-int
-Surface::get_height() const
-{
-  if (impl.get())
-    return impl-&gt;size.height; 
-  else
-    return 0;
-}
-
-Size
-Surface::get_size() const
-{
-  if (impl.get())
-    return impl-&gt;size;
-  else
-    return Size();
-}
-
-void
-Surface::set_size(const Size&amp; size)
-{
-  if (impl.get())
-    impl-&gt;size = size;
-}
-
-/* EOF */

Deleted: trunk/griv/surface.hpp
===================================================================
--- trunk/griv/surface.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/surface.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,66 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_SURFACE_HPP
-#define HEADER_SURFACE_HPP
-
-#include &lt;boost/smart_ptr.hpp&gt;
-#include &quot;texture.hpp&quot;
-#include &quot;math/size.hpp&quot;
-#include &quot;software_surface.hpp&quot;
-
-class SurfaceImpl;
-class Rect;
-class Rectf;
-class Vector2f;
-
-class Surface
-{
-public:
-  Surface();
-  explicit Surface(boost::shared_ptr&lt;SurfaceImpl&gt; impl);
-  explicit Surface(const SoftwareSurface&amp; src, const Rect&amp; srcrect);
-  explicit Surface(const SoftwareSurface&amp; src);
-  ~Surface();
-
-  void draw(const Vector2f&amp; pos);
-  void draw(const Rectf&amp; dstrect);
-  void draw(const Rectf&amp; srcrect, const Rectf&amp; dstrect);
-
-  int  get_width()  const;
-  int  get_height() const;
-  Size get_size() const;
-
-  void set_size(const Size&amp; size);
-
-  operator bool() const { return impl.get(); }
-
-private:
-  boost::shared_ptr&lt;SurfaceImpl&gt; impl;
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/texture.cpp
===================================================================
--- trunk/griv/texture.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/texture.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,115 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-7*/
-
-#include &lt;assert.h&gt;
-#include &lt;iostream&gt;
-#include &lt;stdexcept&gt;
-#include &lt;boost/format.hpp&gt;
-#include &lt;string.h&gt;
-#include &lt;GL/glew.h&gt;
-#include &lt;GL/gl.h&gt;
-#include &lt;GL/glu.h&gt;
-#include &quot;SDL.h&quot;
-
-#include &quot;math/size.hpp&quot;
-#include &quot;math/rect.hpp&quot;
-#include &quot;framebuffer.hpp&quot;
-#include &quot;software_surface.hpp&quot;
-#include &quot;texture.hpp&quot;
-
-class TextureImpl
-{
-public:
-  GLuint handle;
-  Size   size;
-
-  TextureImpl(const SoftwareSurface&amp; src, const Rect&amp; srcrect)
-    : size(srcrect.get_size())
-  {
-    glGenTextures(1, &amp;handle);
-  
-    assert(src);
-    
-    glBindTexture(GL_TEXTURE_RECTANGLE_ARB, handle);
-    glEnable(GL_TEXTURE_RECTANGLE_ARB);
-
-    glPixelStorei(GL_UNPACK_ALIGNMENT,  1);
-    glPixelStorei(GL_UNPACK_ROW_LENGTH, src.get_width());
-
-    glTexImage2D(GL_TEXTURE_RECTANGLE_ARB, 0, GL_RGB,
-                 size.width, size.height,
-                 0, /* border */
-                 GL_RGB,
-                 GL_UNSIGNED_BYTE,
-                 src.get_data() + (src.get_pitch() * srcrect.top) + (srcrect.left*3));
-
-    assert_gl(&quot;packing image texture&quot;);
-    
-    glTexParameteri(GL_TEXTURE_RECTANGLE_ARB, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
-    glTexParameteri(GL_TEXTURE_RECTANGLE_ARB, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
-    glTexParameteri(GL_TEXTURE_RECTANGLE_ARB, GL_TEXTURE_WRAP_S,     GL_CLAMP);
-    glTexParameteri(GL_TEXTURE_RECTANGLE_ARB, GL_TEXTURE_WRAP_T,     GL_CLAMP);
-
-    assert_gl(&quot;setting texture parameters&quot;);
-  }
-
-  ~TextureImpl()
-  {
-    glDeleteTextures(1, &amp;handle);    
-  }
-};
-
-Texture::Texture()
-{
-}
-
-Texture::Texture(const SoftwareSurface&amp; src, const Rect&amp; srcrect)
-  : impl(new TextureImpl(src, srcrect))
-{
-}
-
-Texture::~Texture()
-{
-}
-
-void
-Texture::bind()
-{
-  glBindTexture(GL_TEXTURE_RECTANGLE_ARB, impl-&gt;handle);
-}
-
-int
-Texture::get_width() const
-{
-  return impl-&gt;size.width;
-}
-
-int
-Texture::get_height() const
-{
-  return impl-&gt;size.height;
-}
-
-/* EOF */

Deleted: trunk/griv/texture.hpp
===================================================================
--- trunk/griv/texture.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/texture.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,56 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_TEXTURE_HPP
-#define HEADER_TEXTURE_HPP
-
-#include &lt;boost/shared_ptr.hpp&gt;
-
-class Rect;
-class Size;
-class SoftwareSurface;
-class TextureImpl;
-
-class Texture
-{
-public:
-  Texture();
-  Texture(const SoftwareSurface&amp; src, const Rect&amp; srcrect);
-  ~Texture();
-
-  int get_width() const;
-  int get_height() const;
-  
-  void bind();
-
-  operator bool() const { return impl.get(); }
-
-private:
-  boost::shared_ptr&lt;TextureImpl&gt; impl;
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/thread.cpp
===================================================================
--- trunk/griv/thread.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/thread.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,99 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;assert.h&gt;
-#include &quot;thread.hpp&quot;
-
-/*
-  SDL_mutex* mutex;
-  SDL_CreateMutex();
-  SDL_DestroyMutex(mutex);
-*/
-
-Mutex::Mutex()
-{
-  mutex = SDL_CreateMutex();
-}
-
-Mutex::~Mutex()
-{
-  SDL_DestroyMutex(mutex);
-}
-
-void
-Mutex::lock()
-{
-  SDL_LockMutex(mutex);
-}
-
-void
-Mutex::unlock()
-{
-  SDL_UnlockMutex(mutex);
-}
-
-int launch_thread(void* thread_ptr)
-{
-  Thread* thread = static_cast&lt;Thread*&gt;(thread_ptr);
-  return thread-&gt;run();
-}
-
-Thread::Thread()
-  : thread(0)
-{
-}
-
-Thread::~Thread()
-{
-}
-
-int
-Thread::join()
-{
-  int ret = 0;
-  SDL_WaitThread(thread, &amp;ret);
-  return ret;
-}
-
-Uint32
-Thread::get_id()
-{
-  return SDL_GetThreadID(thread);
-}
-
-Uint32
-Thread::get_thread_id()
-{
-  return SDL_ThreadID();
-}
-
-void
-Thread::start()
-{
-  assert(thread == 0);
-  thread = SDL_CreateThread(launch_thread, this);
-}
-
-/* EOF */

Deleted: trunk/griv/thread.hpp
===================================================================
--- trunk/griv/thread.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/thread.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,73 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_THREAD_HPP
-#define HEADER_THREAD_HPP
-
-#include &quot;SDL.h&quot;
-
-class Mutex 
-{
-private:
-  SDL_mutex* mutex;
-
-public:
-  Mutex();
-  ~Mutex();
-
-  void lock();
-  void unlock();
-
-private:
-  Mutex (const Mutex&amp;);
-  Mutex&amp; operator= (const Mutex&amp;);
-};
-
-/** */
-class Thread
-{
-private:
-  SDL_Thread* thread;
-
-public:
-  Thread();
-  virtual ~Thread();
-
-  void start();
-  int  join();
-  Uint32 get_id();
-  
-  virtual int run() =0;
-
-  static Uint32 get_thread_id();
-
-private:
-  Thread (const Thread&amp;);
-  Thread&amp; operator= (const Thread&amp;);
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/thread_message_queue.hpp
===================================================================
--- trunk/griv/thread_message_queue.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/thread_message_queue.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,99 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_THREAD_MESSAGE_QUEUE_HPP
-#define HEADER_THREAD_MESSAGE_QUEUE_HPP
-
-#include &lt;queue&gt;
-#include &quot;thread.hpp&quot;
-
-template&lt;class C&gt;
-class ThreadMessageQueue
-{
-private:
-  Mutex mutex;
-  std::queue&lt;C&gt; values;
-
-public:
-  ThreadMessageQueue()
-  {
-  }
-
-  ~ThreadMessageQueue()
-  {
-  }
-
-  void push(const C&amp; value)
-  {
-    mutex.lock();
-    values.push(value);
-    mutex.unlock();
-  }
-
-  void pop()
-  {
-    mutex.lock();
-    values.pop();
-    mutex.unlock();
-  }
-
-  C front()
-  {
-    mutex.lock();
-    C c(values.front());
-    mutex.unlock();
-    return c;
-  }
-
-  int size()
-  {
-    mutex.lock();
-    int s = values.size();
-    mutex.unlock();
-    return s;
-  }
-
-  bool empty() 
-  {
-    mutex.lock();
-    bool e = values.empty();
-    mutex.unlock();
-    return e;
-  }
-
-  void wait()
-  {
-    // FIXME: implement me properly
-    SDL_Delay(100);
-  }
-
-private:
-  ThreadMessageQueue (const ThreadMessageQueue&amp;);
-  ThreadMessageQueue&amp; operator= (const ThreadMessageQueue&amp;);
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/tile_database.cpp
===================================================================
--- trunk/griv/tile_database.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/tile_database.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,101 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;sstream&gt;
-#include &quot;SDL.h&quot;
-#include &quot;tile_database.hpp&quot;
-
-TileDatabase::TileDatabase(SQLiteConnection* db)
-  : db(db),
-    store_stmt(db),
-    get_stmt(db)
-{
-  db-&gt;exec(&quot;CREATE TABLE IF NOT EXISTS tiles (&quot;
-           &quot;fileid  INTEGER, &quot; // link to to files.rowid
-           &quot;scale   INTEGER, &quot; // zoom level
-           &quot;x       INTEGER, &quot; // X position in tiles
-           &quot;y       INTEGER, &quot; // Y position in tiles
-           &quot;data    BLOB     &quot; // the image data, JPEG
-           &quot;);&quot;);
-
-  db-&gt;exec(&quot;CREATE INDEX IF NOT EXISTS tiles_index ON tiles ( fileid, x, y, scale );&quot;);
-
-  store_stmt.prepare(&quot;INSERT into tiles (fileid, scale, x, y, data) VALUES (?1, ?2, ?3, ?4, ?5);&quot;);
-  get_stmt.prepare(&quot;SELECT * FROM tiles WHERE fileid = ?1 AND scale = ?2 AND x = ?3 AND y = ?4;&quot;);
-}
-
-bool
-TileDatabase::get_tile(uint32_t fileid, int scale, int x, int y, Tile&amp; tile)
-{
-  //SDL_Delay(100);
-
-  get_stmt.bind_int(1, fileid);
-  get_stmt.bind_int(2, scale);
-  get_stmt.bind_int(3, x);
-  get_stmt.bind_int(4, y);
-
-  SQLiteReader reader = get_stmt.execute_query();
-
-  if (reader.next())
-    {
-      tile.fileid  = reader.get_int (0);
-      tile.scale   = reader.get_int (1);
-      tile.x       = reader.get_int (2);
-      tile.y       = reader.get_int (3);
-
-      // FIXME: Do this in the JPEGDecoderThread
-      tile.surface = SoftwareSurface::from_data(reader.get_blob(4));
-
-      return true;
-    }
-  else
-    {
-      return false;
-    }
-}
-
-void
-TileDatabase::store_tile(const Tile&amp; tile)
-{
-  Blob blob = tile.surface.get_jpeg_data();
-
-  // FIXME: We need to update a already existing record, instead of
-  // just storing a duplicate
-  store_stmt.bind_int (1, tile.fileid);
-  store_stmt.bind_int (2, tile.scale);
-  store_stmt.bind_int (3, tile.x);
-  store_stmt.bind_int (4, tile.y);
-  store_stmt.bind_blob(5, blob);
-
-  store_stmt.execute();
-}
-
-void
-TileDatabase::check()
-{
-  
-}
-  
-/* EOF */

Deleted: trunk/griv/tile_database.hpp
===================================================================
--- trunk/griv/tile_database.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/tile_database.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,62 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_TILE_DATABASE_HPP
-#define HEADER_TILE_DATABASE_HPP
-
-#include &quot;sqlite.hpp&quot;
-#include &quot;software_surface.hpp&quot;
-
-struct Tile
-{
-  int fileid;
-  int scale;
-  int x;
-  int y;
-  SoftwareSurface surface;
-};
-
-/** */
-class TileDatabase
-{
-private:
-  SQLiteConnection* db;
-  SQLiteStatement store_stmt;
-  SQLiteStatement get_stmt;
-
-public:
-  TileDatabase(SQLiteConnection* db);
-  
-  bool get_tile(uint32_t file_id, int scale, int x, int y, Tile&amp; tile);
-  void store_tile(const Tile&amp; tile);
-  void check();
-private:
-  TileDatabase (const TileDatabase&amp;);
-  TileDatabase&amp; operator= (const TileDatabase&amp;);
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/tile_generator.cpp
===================================================================
--- trunk/griv/tile_generator.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/tile_generator.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,86 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;iostream&gt;
-#include &quot;math/size.hpp&quot;
-#include &quot;math/rect.hpp&quot;
-#include &quot;tile_database.hpp&quot;
-#include &quot;tile_generator.hpp&quot;
-
-TileGenerator::TileGenerator()
-{
-}
-
-TileGenerator::~TileGenerator()
-{
-}
-
-void
-TileGenerator::generate_all(int fileid, const SoftwareSurface&amp; surface_, 
-                            const boost::function&lt;void (Tile)&gt;&amp; callback)
-{
-  int scale = 0;
-
-  SoftwareSurface surface = surface_;
-
-  do
-    {
-      if (scale != 0)
-        {
-          surface = surface.scale(Size(surface.get_width()/2, 
-                                       surface.get_height()/2));
-        }
-
-      for(int y = 0; 256*y &lt; surface.get_height(); ++y)
-        for(int x = 0; 256*x &lt; surface.get_width(); ++x)
-          {
-            SoftwareSurface croped_surface = surface.crop(Rect(Vector2i(x * 256, y * 256),
-                                                               Size(256, 256)));
-
-            Tile tile;
-            tile.fileid = fileid;
-            tile.scale  = scale;
-            tile.x = x;
-            tile.y = y;
-            tile.surface = croped_surface;
-          
-            callback(tile);
-          }
-
-      scale += 1;
-
-      //std::cout &lt;&lt; &quot;Scale: &quot; &lt;&lt; scale &lt;&lt; &quot; - &quot; &lt;&lt; surface.get_size() &lt;&lt; std::endl;
-    } while (surface.get_width() &gt; 32 ||
-             surface.get_height() &gt; 32);
-}
-
-void
-TileGenerator::generate_all(int fileid, const std::string&amp; filename,
-                            const boost::function&lt;void (Tile)&gt;&amp; callback)
-{
-  generate_all(fileid, SoftwareSurface::from_file(filename), callback);
-}
-
-/* EOF */

Deleted: trunk/griv/tile_generator.hpp
===================================================================
--- trunk/griv/tile_generator.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/tile_generator.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,57 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_TILE_GENERATOR_HPP
-#define HEADER_TILE_GENERATOR_HPP
-
-#include &lt;boost/function.hpp&gt;
-#include &lt;string&gt;
-#include &quot;software_surface.hpp&quot;
-#include &quot;tile_database.hpp&quot;
-
-class TileGenerator
-{
-private:
-
-public:
-  TileGenerator();
-  ~TileGenerator();
-
-  /** Slow brute force approach to generate tiles, works with all
-      image formats */
-  void generate_all(int fileid, const SoftwareSurface&amp; surface,
-                    const boost::function&lt;void (Tile)&gt;&amp; callback);
-
-  void generate_all(int fileid, const std::string&amp; filename,
-                    const boost::function&lt;void (Tile)&gt;&amp; callback);
-
-private:
-  TileGenerator (const TileGenerator&amp;);
-  TileGenerator&amp; operator= (const TileGenerator&amp;);
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/tile_generator_thread.cpp
===================================================================
--- trunk/griv/tile_generator_thread.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/tile_generator_thread.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,97 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;iostream&gt;
-#include &lt;boost/bind.hpp&gt;
-#include &quot;tile_generator.hpp&quot;
-#include &quot;database_thread.hpp&quot;
-#include &quot;tile_generator_thread.hpp&quot;
- 
-TileGeneratorThread* TileGeneratorThread::current_ = 0; 
-
-TileGeneratorThread::TileGeneratorThread()
-  : quit(false)
-{
-  current_ = this;
-}
-
-TileGeneratorThread::~TileGeneratorThread()
-{
-}
-
-void
-TileGeneratorThread::request_tiles(int fileid, const std::string&amp; filename)
-{
-  TileGeneratorMessage msg;
-
-  msg.fileid   = fileid;
-  msg.filename = filename;
-
-  msg_queue.push(msg);
-}
-
-void
-TileGeneratorThread::request_tile(int fileid, const std::string&amp; filename, int x, int y)
-{
-  // Do some magic to group tile request for the same fileid
-}
-
-void
-TileGeneratorThread::stop()
-{
-  quit = true;
-}
-
-void
-TileGeneratorThread::receive_tile(const Tile&amp; tile)
-{
-  DatabaseThread::current()-&gt;store_tile(tile);
-}
-
-int
-TileGeneratorThread::run()
-{
-  quit = false;
-
-  TileGenerator generator;
-
-  while(!quit)
-    {
-      while(!msg_queue.empty())
-        {
-          TileGeneratorMessage msg = msg_queue.front();
-          msg_queue.pop();
-
-          std::cout &lt;&lt; &quot;Generating tiles for: &quot; &lt;&lt; msg.filename &lt;&lt; std::endl;
-          generator.generate_all(msg.fileid, msg.filename,
-                                 boost::bind(&amp;TileGeneratorThread::receive_tile, this, _1));
-        }
-      msg_queue.wait();
-    }
-
-  return 0;
-}
-
-/* EOF */

Deleted: trunk/griv/tile_generator_thread.hpp
===================================================================
--- trunk/griv/tile_generator_thread.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/tile_generator_thread.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,70 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_TILE_GENERATOR_THREAD_HPP
-#define HEADER_TILE_GENERATOR_THREAD_HPP
-
-#include &quot;thread.hpp&quot;
-#include &quot;thread_message_queue.hpp&quot;
-
-struct TileGeneratorMessage
-{
-  int fileid;
-  std::string filename;
-};
-
-class TileGeneratorThread : public Thread
-{
-private:
-  static TileGeneratorThread* current_; 
-public:
-  static TileGeneratorThread* current() { return current_; }
-
-private:
-  bool quit;
-  ThreadMessageQueue&lt;TileGeneratorMessage&gt; msg_queue;
-
-protected:
-  int run();
-  
-public:
-  TileGeneratorThread();
-  ~TileGeneratorThread();
-
-  void stop();
-
-  void request_tiles(int fileid, const std::string&amp; filename);
-  void request_tile(int fileid, const std::string&amp; filename, int x, int y);
-
-  void receive_tile(const Tile&amp; tile);
-  
-private:
-  TileGeneratorThread (const TileGeneratorThread&amp;);
-  TileGeneratorThread&amp; operator= (const TileGeneratorThread&amp;);
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/url.cpp
===================================================================
--- trunk/griv/url.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/url.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,39 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &quot;url.hpp&quot;
-
-URL::URL(const std::string&amp; url_)
-  : url(url_)
-{
-}
-
-std::string
-URL::get_filename() const
-{
-  return url;
-}
-
-/* EOF */

Deleted: trunk/griv/url.hpp
===================================================================
--- trunk/griv/url.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/url.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,45 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_URL_HPP
-#define HEADER_URL_HPP
-
-#include &lt;string&gt;
-
-/** */
-class URL
-{
-private:
-  std::string url;
-
-public:
-  URL(const std::string&amp; url);
-
-  std::string get_filename() const;
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/viewer.cpp
===================================================================
--- trunk/griv/viewer.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/viewer.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,225 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;iostream&gt;
-#include &quot;math/rgb.hpp&quot;
-#include &quot;framebuffer.hpp&quot;
-#include &quot;software_surface.hpp&quot;
-#include &quot;math/vector2f.hpp&quot;
-#include &quot;math/rect.hpp&quot;
-#include &quot;workspace.hpp&quot;
-#include &quot;viewer.hpp&quot;
-
-ViewerState::ViewerState()
-  : scale(1.0f),
-    offset(0.0f, 0.0f)
-{
-}
-
-void
-ViewerState::zoom(float factor, const Vector2i&amp; pos)
-{
-  scale *= factor;
-
-  offset = Vector2f(pos) - ((Vector2f(pos) - offset) * factor);
-}
-
-void
-ViewerState::move(const Vector2i&amp; pos)
-{
-  offset.x += pos.x;
-  offset.y += pos.y;
-}
-
-Vector2f
-ViewerState::screen2world(const Vector2i&amp; pos) const
-{
-  return (Vector2f(pos) - offset) / scale;
-}
-
-Rectf
-ViewerState::screen2world(const Rect&amp; rect) const
-{
-  return Rectf((rect.left   - offset.x) / scale,
-               (rect.top    - offset.y) / scale,
-               (rect.right  - offset.x) / scale,
-               (rect.bottom - offset.y) / scale);
-}
-
-Viewer::Viewer()
-  : quit(false),
-    force_redraw(false),
-    drag_n_drop(false),
-    zoom_button(0),
-    gamma(1.0f)
-{
-}
-
-void
-Viewer::process_event(const SDL_Event&amp; event)
-{
-  switch(event.type)
-    {
-      case SDL_QUIT:
-        std::cout &lt;&lt; &quot;Viewer: SDL_QUIT received&quot; &lt;&lt; std::endl;
-        quit = true;
-        break;
-
-      case SDL_VIDEOEXPOSE:
-        force_redraw = true;
-        break;
-
-      case SDL_VIDEORESIZE:
-        Framebuffer::resize(event.resize.w, event.resize.h);
-        force_redraw = true;
-        break;
-
-      case SDL_KEYDOWN:
-        switch(event.key.keysym.sym)
-          {
-            case SDLK_ESCAPE:
-              quit = true;
-              break;
-
-            case SDLK_PAGEUP:
-                gamma *= 1.1f;
-                SDL_SetGamma(gamma, gamma, gamma);
-              break;
-
-            case SDLK_PAGEDOWN:
-                gamma /= 1.1f;
-                SDL_SetGamma(gamma, gamma, gamma);
-                break;
-                
-            case SDLK_END:
-                gamma = 1.0f;
-                SDL_SetGamma(gamma, gamma, gamma);
-                break;
-
-            default:
-              // ignore all other keypresses
-              break;
-          }
-        break;
-
-      case SDL_MOUSEMOTION:
-        mouse_pos = Vector2i(event.motion.x,
-                             event.motion.y);
-        
-        if (drag_n_drop)
-          {
-            state.move(Vector2i(event.motion.xrel * 4,
-                                event.motion.yrel * 4));
-          }
-        break;
-
-
-      case SDL_MOUSEBUTTONDOWN:
-      case SDL_MOUSEBUTTONUP:
-        switch(event.button.button)
-          {
-            case SDL_BUTTON_WHEELUP:
-              if (event.button.state == SDL_PRESSED)
-                {
-                  state.zoom(1.1f, mouse_pos);
-                }
-              break;
-
-            case SDL_BUTTON_WHEELDOWN:
-              if (event.button.state == SDL_PRESSED)
-                {
-                  state.zoom(1.0f/1.1f, mouse_pos);
-                }
-              break;
-                  
-            case SDL_BUTTON_LEFT:
-              if (event.button.state == SDL_PRESSED)
-                  zoom_button = 1;
-              else
-                  zoom_button = 0;
-              break;
-
-            case SDL_BUTTON_RIGHT:
-              if (event.button.state == SDL_PRESSED)
-                  zoom_button = -1;
-              else
-                  zoom_button = 0;
-              break;
-
-            case SDL_BUTTON_MIDDLE:
-              //std::cout &lt;&lt; state.screen2world(mouse_pos) &lt;&lt; std::endl;
-
-              drag_n_drop = event.button.state;
-              break;
-          }
-        break;
-
-      default:
-        break;
-    }
-}
-
-void
-Viewer::draw(Workspace&amp; workspace)
-{
-  bool clip_debug = false;
-
-  glPushMatrix();
-
-  if (clip_debug)
-    {
-      glTranslatef(Framebuffer::get_width()/2, Framebuffer::get_height()/2, 0.0f);
-      glScalef(0.5f, 0.5f, 1.0f);
-      glTranslatef(-Framebuffer::get_width()/2, -Framebuffer::get_height()/2, 0.0f);
-    }
-
-  glTranslatef(state.get_offset().x, state.get_offset().y, 0.0f);
-  glScalef(state.get_scale(), state.get_scale(), 1.0f);
-
-  Rectf cliprect = state.screen2world(Rect(0, 0, Framebuffer::get_width(), Framebuffer::get_height())); 
-
-  if (clip_debug)
-    Framebuffer::draw_rect(cliprect, RGB(255, 0, 255));
-  
-  workspace.draw(cliprect,
-                 state.get_scale());
-
-  glPopMatrix();
-}
-
-void
-Viewer::update(float delta)
-{
-  if (zoom_button == -1)
-    {
-      state.zoom(1.0f / (1.0f + 4.0f * delta), mouse_pos);
-    }
-  else if (zoom_button == 1)
-    {
-      state.zoom(1.0f + 4.0f * delta, mouse_pos);
-    }
-}
-
-/* EOF */

Deleted: trunk/griv/viewer.hpp
===================================================================
--- trunk/griv/viewer.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/viewer.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,82 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_VIEWER_HPP
-#define HEADER_VIEWER_HPP
-
-#include &quot;SDL.h&quot;
-#include &quot;surface.hpp&quot;
-#include &quot;math/vector2i.hpp&quot;
-
-class Workspace;
-
-class ViewerState
-{
-private:
-  float    scale;
-  Vector2f offset;
-  
-public:
-  ViewerState();
-
-  void zoom(float factor, const Vector2i&amp; pos);
-  void move(const Vector2i&amp; pos);
-
-  Vector2f screen2world(const Vector2i&amp;) const;
-  Rectf    screen2world(const Rect&amp;) const;
-
-  Vector2f get_offset() const { return offset; }
-  float    get_scale()  const { return scale; }
-};
-
-class Viewer
-{
-private:
-  bool quit;
-  bool force_redraw;
-  bool drag_n_drop;
-  int  zoom_button;
-  float gamma;
-
-  Vector2i mouse_pos;
-
-  ViewerState state;
-
-public:
-  Viewer();
-
-  void draw(Workspace&amp; workspace);
-  void update(float delta);
-  void process_event(const SDL_Event&amp; event);
-  bool done() const { return quit; }
-
-private:
-  Viewer (const Viewer&amp;);
-  Viewer&amp; operator= (const Viewer&amp;);
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/viewer_thread.cpp
===================================================================
--- trunk/griv/viewer_thread.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/viewer_thread.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,127 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &lt;boost/bind.hpp&gt;
-#include &quot;file_database.hpp&quot;
-#include &quot;workspace.hpp&quot;
-#include &quot;framebuffer.hpp&quot;
-#include &quot;viewer.hpp&quot;
-#include &quot;viewer_thread.hpp&quot;
-#include &quot;tile_generator_thread.hpp&quot;
-#include &quot;database_thread.hpp&quot;
-
-ViewerThread* ViewerThread::current_ = 0;
-
-ViewerThread::ViewerThread()
-{
-  current_ = this;
-}
-
-ViewerThread::~ViewerThread()
-{
-}
-
-void
-ViewerThread::receive_file(const FileEntry&amp; entry)
-{
-  file_queue.push(entry);
-  //TileGeneratorThread::current()-&gt;request_tiles(entry.fileid, entry.filename);
-}
-
-void
-ViewerThread::receive_tile(const Image&amp; image, const Tile&amp; tile)
-{
-  TileMessage msg;
-  
-  msg.image = image;
-  msg.tile  = tile;
-
-  tile_queue.push(msg);
-}
-
-JobHandle 
-ViewerThread::request_tile(int fileid, int tilescale, int x, int y, const Image&amp; image)
-{
-  return DatabaseThread::current()-&gt;request_tile(fileid, tilescale, x, y,
-                                                 boost::bind(&amp;ViewerThread::receive_tile, this, image, _1));
-}
-
-int
-ViewerThread::run()
-{
-  Workspace workspace;
-
-  Framebuffer::set_video_mode(Size(800, 600));
-
-  workspace.layout(4,3);
-
-  Viewer viewer;
-
-  Uint32 ticks = SDL_GetTicks();
-  while(!viewer.done())
-    {     
-      while (!file_queue.empty())
-        {
-          const FileEntry&amp; entry = file_queue.front();
-          workspace.add_image(entry.fileid, entry.filename, entry.size);
-          file_queue.pop();
-        }
-
-      while (!tile_queue.empty()) // FIXME: Crash happens somewhere here!
-        {
-          TileMessage msg = tile_queue.front();
-
-          msg.image.receive_tile(msg.tile.x, msg.tile.y, 
-                                 msg.tile.scale, msg.tile.surface);
-
-          tile_queue.pop();
-        }
-
-      SDL_Event event;
-      while (SDL_PollEvent(&amp;event))
-        viewer.process_event(event);
-
-      Uint32 cticks = SDL_GetTicks();
-      float delta = (cticks - ticks) / 1000.0f;
-      ticks = cticks;
-
-      viewer.update(delta);
-
-      if (1) // if something has changed, redraw
-        {
-          Framebuffer::clear();
-          viewer.draw(workspace);
-          Framebuffer::flip();
-        }
-
-      SDL_Delay(30);
-    }
-
-  std::cout &lt;&lt; &quot;ViewerThread: done&quot; &lt;&lt; std::endl;
-
-  return 0;
-}
-
-/* EOF */

Deleted: trunk/griv/viewer_thread.hpp
===================================================================
--- trunk/griv/viewer_thread.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/viewer_thread.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,74 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_VIEWER_THREAD_HPP
-#define HEADER_VIEWER_THREAD_HPP
-
-#include &quot;thread.hpp&quot;
-#include &quot;thread_message_queue.hpp&quot;
-
-#include &quot;image.hpp&quot;
-#include &quot;job_handle.hpp&quot;
-#include &quot;tile_database.hpp&quot;
-
-class FileEntry;
-class Image;
-class Tile;
-
-struct TileMessage
-{
-  Image image;
-  Tile  tile;
-};
-
-class ViewerThread
-{
-private:
-  static ViewerThread* current_;
-public:
-  static ViewerThread* current() { return current_; }
-  
-private:
-  ThreadMessageQueue&lt;FileEntry&gt;   file_queue;
-  ThreadMessageQueue&lt;TileMessage&gt; tile_queue;
-
-public:
-  ViewerThread();
-  virtual ~ViewerThread();
-
-  int run();
-
-  void receive_file(const FileEntry&amp; entry);
-  void receive_tile(const Image&amp; image, const Tile&amp; tile);
-
-  JobHandle request_tile(int fileid, int tilescale, int x, int y, const Image&amp; image);
-private:
-  ViewerThread (const ViewerThread&amp;);
-  ViewerThread&amp; operator= (const ViewerThread&amp;);
-};
-
-#endif
-
-/* EOF */

Deleted: trunk/griv/workspace.cpp
===================================================================
--- trunk/griv/workspace.cpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/workspace.cpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,87 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#include &quot;math.hpp&quot;
-#include &quot;workspace.hpp&quot;
-
-Workspace::Workspace()
-{
-}
-
-void
-Workspace::add_image(int fileid, const std::string&amp; filename, const Size&amp; size)
-{
-  Image image(fileid, filename, size);
-  images.push_back(image);
-  image.set_scale(Math::min(1000.0f / size.width,
-                            1000.0f / size.height));
-  layout(4.0f, 3.0f);
-}
-
-void
-Workspace::layout(float aspect_w, float aspect_h)
-{
-  if (!images.empty())
-    {
-      //       float x_pos = 0;
-      //       for(Images::iterator i = images.begin(); i != images.end(); ++i)
-      //         {
-      //           i-&gt;set_pos(Vector2f(x_pos, 0.0f));
-      //           x_pos += i-&gt;get_width() + 128/*spacing*/;
-      //         }    
-      
-      int w = int(Math::sqrt(aspect_w * images.size() / aspect_h));
-
-      for(int i = 0; i &lt; int(images.size()); ++i)
-        {
-          if ((i/w) % 2 == 0)
-            {
-              images[i].set_pos(Vector2f((i % w) * 1024.0f,
-                                         (i / w) * 1024.0f));
-            }
-          else
-            {
-              images[i].set_pos(Vector2f((w - (i % w)-1) * 1024.0f,
-                                         (i / w)         * 1024.0f));
-            }
-
-          images[i].set_pos(images[i].get_pos() + Vector2f((1000.0f - images[i].get_scaled_width()) / 2,
-                                                           (1000.0f - images[i].get_scaled_height()) / 2));
-        }
-    }
-}
-
-void
-Workspace::draw(const Rectf&amp; cliprect, float scale)
-{
-  //std::cout &lt;&lt; Math::clamp(1, static_cast&lt;int&gt;(1.0f / scale), 32) &lt;&lt; &quot; -&gt; &quot; &lt;&lt; scale &lt;&lt; std::endl;
-
-  for(Images::iterator i = images.begin(); i != images.end(); ++i)
-    {
-      i-&gt;draw(cliprect, scale);
-    }  
-}
-
-/* EOF */

Deleted: trunk/griv/workspace.hpp
===================================================================
--- trunk/griv/workspace.hpp	2008-08-20 17:32:28 UTC (rev 2344)
+++ trunk/griv/workspace.hpp	2008-08-20 21:58:58 UTC (rev 2345)
@@ -1,54 +0,0 @@
-/*  $Id$
-**   __      __ __             ___        __   __ __   __
-**  /  \    /  \__| ____    __| _/_______/  |_|__|  | |  |   ____
-**  \   \/\/   /  |/    \  / __ |/  ___/\   __\  |  | |  | _/ __ \
-**   \        /|  |   |  \/ /_/ |\___ \  |  | |  |  |_|  |_\  ___/
-**    \__/\  / |__|___|  /\____ /____  &gt; |__| |__|____/____/\___  &gt;
-**         \/          \/      \/    \/                         \/
-**  Copyright (C) 2007 Ingo Ruhnke &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/windstille-commit">grumbel at gmx.de</A>&gt;
-**
-**  This program is free software; you can redistribute it and/or
-**  modify it under the terms of the GNU General Public License
-**  as published by the Free Software Foundation; either version 2
-**  of the License, or (at your option) any later version.
-**
-**  This program is distributed in the hope that it will be useful,
-**  but WITHOUT ANY WARRANTY; without even the implied warranty of
-**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-**  GNU General Public License for more details.
-** 
-**  You should have received a copy of the GNU General Public License
-**  along with this program; if not, write to the Free Software
-**  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-**  02111-1307, USA.
-*/
-
-#ifndef HEADER_WORKSPACE_HPP
-#define HEADER_WORKSPACE_HPP
-
-#include &quot;image.hpp&quot;
-
-class Rectf;
-
-class Workspace
-{
-private:
-  typedef std::vector&lt;Image&gt; Images;
-  Images images;
-  
-public:
-  Workspace();
-
-  void add_image(int fileid, const std::string&amp; filename, const Size&amp; size);
-  void draw(const Rectf&amp; cliprect, float scale);
-
-  void layout(float aspect_w, float aspect_h);
-
-private:
-  Workspace (const Workspace&amp;);
-  Workspace&amp; operator= (const Workspace&amp;);
-};
-
-#endif
-
-/* EOF */


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001341.html">[Windstille-commit] r2344 - trunk/griv
</A></li>
	<LI>Next message: <A HREF="001343.html">[Windstille-commit] r2346 - trunk/griv/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1342">[ date ]</a>
              <a href="thread.html#1342">[ thread ]</a>
              <a href="subject.html#1342">[ subject ]</a>
              <a href="author.html#1342">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/windstille-commit">More information about the Windstille-commit
mailing list</a><br>
</body></html>
